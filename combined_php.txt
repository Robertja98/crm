

--- Start of admin_backups.php ---

<?php
// admin_backups.php - Modular admin backup page (2026 standard)
$config = require __DIR__ . '/admin_module_config.php';

$pageTitle = 'Admin Backup Management';

$dir = __DIR__;
$files = scandir($dir);
$fileTypes = $config['file_types'];
$allFiles = array_filter($files, function($file) use ($fileTypes) {
    $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
    return in_array($ext, $fileTypes) && $file !== 'admin_backups.php';
});

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['files'])) {
    $selected = $_POST['files'];
    file_put_contents($config['backup_dir'] . '/selected_backup_files.json', json_encode($selected));
    echo '<h4>Selected files for backup:</h4>';
    echo '<ul>';
    foreach ($selected as $file) {
        echo '<li>' . htmlspecialchars($file) . '</li>';
    }
    echo '</ul>';
    // Manual backup trigger
    $backupDir = $config['backup_dir'] . '/manual_' . date('Y_m_d_His');
    mkdir($backupDir, 0777, true);
    foreach ($selected as $file) {
        copy($file, $backupDir . '/' . $file);
    }
    $zip = new ZipArchive();
    $zipFile = $backupDir . '.zip';
    if ($zip->open($zipFile, ZipArchive::CREATE) === TRUE) {
        foreach ($selected as $file) {
            $zip->addFile($backupDir . '/' . $file, $file);
        }
        $zip->close();
    }
    foreach ($selected as $file) {
        unlink($backupDir . '/' . $file);
    }
    rmdir($backupDir);
    echo '<p>Manual backup complete. <a href="' . htmlspecialchars($zipFile) . '">Download ZIP</a></p>';
} else {
    $prevSelected = [];
    if (file_exists($config['backup_dir'] . '/selected_backup_files.json')) {
        $prevSelected = json_decode(file_get_contents($config['backup_dir'] . '/selected_backup_files.json'), true);
    }
?>
<!DOCTYPE html>
<html>
<head>
    <title>Admin Backup Page Selector</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #222; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 32px; }
        h1 { font-size: 2rem; margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-size: 1rem; }
        button { background: #0099A8; color: #fff; border: none; border-radius: 6px; padding: 10px 24px; font-size: 1rem; cursor: pointer; margin-top: 16px; }
        button:hover { background: #007880; }
        .file-list { margin-bottom: 24px; }
        .file-list input[type=checkbox] { margin-right: 8px; }
        .backup-info { margin-top: 32px; font-size: 0.95rem; color: #666; }
    </style>
</head>
<body>
<div class="container">
    <h1>Select Files to Back Up</h1>
    <form method="post">
        <div class="file-list">
        <?php foreach ($allFiles as $file): ?>
            <label>
                <input type="checkbox" name="files[]" value="<?= htmlspecialchars($file) ?>" <?= in_array($file, $prevSelected) ? 'checked' : '' ?>>
                <?= htmlspecialchars($file) ?>
            </label>
        <?php endforeach; ?>
        </div>
        <button type="submit">Back Up Selected Files</button>
    </form>
    <div class="backup-info">
        <strong>2026 Standard:</strong> Modular, configurable, modern UI. <br>
        <strong>Retention:</strong> <?= $config['retention_days'] ?> days, max <?= $config['max_backups'] ?> backups.<br>
        <strong>Backup Directory:</strong> <?= htmlspecialchars($config['backup_dir']) ?><br>
        <strong>File Types:</strong> <?= implode(', ', $config['file_types']) ?><br>
    </div>
</div>
</body>
</html>
<?php } ?>


--- End of admin_backups.php ---



--- Start of admin_module_config.php ---

<?php
// admin_module_config.php
// 2026 standard admin module config
return [
    'backup_dir' => 'backup',
    'backup_root' => getenv('USERPROFILE') . '/AdminModule_Backups_Daily',
    'retention_days' => 30,
    'max_backups' => 50,
    'file_types' => ['php', 'csv', 'json', 'txt'], // Extendable
    'ui_theme' => 'modern2026',
];


--- End of admin_module_config.php ---



--- Start of add_contact.php ---

<?php
// Authentication check (without HTML output)
require_once __DIR__ . '/simple_auth/middleware.php';

// Load helper files
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'forecast_calc.php';
require_once 'error_handler.php';
require_once 'csrf_helper.php';
require_once 'sanitize_helper.php';
require_once 'audit_handler.php';

// Start session for CSRF if not already started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Initialize CSRF token
initializeCSRFToken();

// ‚úÖ CSRF Protection: Verify token on POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        logWarning('CSRF token validation failed', ['email' => $_POST['email'] ?? '']);
        die(json_encode(['error' => 'Security validation failed. Please try again.']));
    }
}

$filename = 'contacts.csv';
$logFile = 'error_log.txt';
$schema = require __DIR__ . '/contact_schema.php';

$timestamp = date('Y-m-d H:i:s');
$newContact = [
    'id' => uniqid(),
    'first_name' => $_POST['first_name'] ?? '',
    'last_name' => $_POST['last_name'] ?? '',
    'company' => $_POST['company'] ?? '',
    'address_1' => $_POST['address_1'] ?? '',
    'address_2' => $_POST['address_2'] ?? '', 
    'city' => $_POST['city'] ?? '',
    'postal_code' => $_POST['postal_code'] ?? '',
    'province' => $_POST['province'] ?? '',
    'country' => $_POST['country'] ?? '',
    'phone' => $_POST['phone'] ?? '',
    'email' => $_POST['email'] ?? '',
    'created_at' => $timestamp,
    'source' => 'manual_entry'
];

// ‚úÖ ENHANCED: Sanitize input before validation
$newContact = sanitizeContact($newContact);

// ‚úÖ ENHANCED: Validate contact
$errors = validateContact($newContact);

// ‚úÖ ENHANCED: Check for duplicate email
if (empty($errors) && !empty($newContact['email'])) {
    if (!isEmailUnique($newContact['email'])) {
        $errors['email'] = "Email already exists in the system.";
    }
}

if (!empty($errors)) {
    // Display errors to user
    showValidationErrors($errors);
    
    // Log validation errors
    logWarning('Contact validation failed', [
        'email' => $newContact['email'],
        'errors' => $errors,
    ]);

    echo "<p><a href=\"javascript:history.back()\">‚Üê Go back</a></p>";
    exit;
}

try {
    // ‚úÖ LOCKED READ-MODIFY-WRITE: Prevents race condition data loss
    readModifyWriteCSV($filename, $schema, function($contacts) use ($newContact, $timestamp, $logFile) {
        // Add new contact
        $contacts[] = $newContact;
        
        // Log success
        logInfo('Contact created successfully', [
            'email' => $newContact['email'],
            'name' => $newContact['first_name'] . ' ' . $newContact['last_name'],
        ]);
        
        // ‚úÖ AUDIT: Log contact creation
        auditCreateContact($newContact, 'success');
        
        return $contacts;
    });
    
    // Redirect to confirmation
    header('Location: contact_success.php');
    exit;
} catch (Exception $e) {
    $errorMsg = getErrorMessage($e);
    showError('Unable to Save Contact', $errorMsg, $e->getMessage());
    
    // Log error
    logError('Contact save failed', [
        'email' => $newContact['email'],
        'exception' => $e->getMessage(),
    ]);
    
    // ‚úÖ AUDIT: Log failed creation attempt
    auditCreateContact($newContact, 'failed', $e->getMessage());
    
    echo "<p><a href=\"javascript:history.back()\">‚Üê Try again</a></p>";
    exit;
}
?>


--- End of add_contact.php ---



--- Start of add_customer.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/customer_schema.php';
$itemFields = require __DIR__ . '/customer_item_config.php';
$customerFile = 'customers.csv';
$itemFile = 'customer_items.csv';
$errors = [];
$success = false;
$newCustomer = [];

// Load existing customers
$rows = readCSV($customerFile, $schema);
$lastId = 0;
foreach ($rows as $r) {
    $id = intval($r['customer_id']);
    if ($id > $lastId) $lastId = $id;
}
$nextId = str_pad($lastId + 1, 5, '0', STR_PAD_LEFT);

// Handle POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    foreach ($schema as $field) {
        $newCustomer[$field] = ($field === 'customer_id') ? $nextId : trim($_POST[$field] ?? '');
    }

    // Validate main fields
    if ($newCustomer['contact_name'] === '') $errors[] = 'Contact name is required.';
    if ($newCustomer['address'] === '') $errors[] = 'Address is required.';

    // Parse line items
    $items = [];
    if (isset($_POST['items']) && is_array($_POST['items'])) {
        foreach ($_POST['items'] as $item) {
            $clean = ['customer_id' => $nextId];
            foreach ($itemFields as $f) {
                $clean[$f] = trim($item[$f] ?? '');
            }
            $items[] = $clean;
        }
    }

    if (empty($errors)) {
        $rows[] = $newCustomer;
        writeCSV($customerFile, $rows, $schema);

        $existingItems = readCSV($itemFile, array_merge(['customer_id'], $itemFields));
        $existingItems = is_array($existingItems) ? $existingItems : [];
        $allItems = array_merge($existingItems, $items);
        writeCSV($itemFile, $allItems, array_merge(['customer_id'], $itemFields));

        $success = true;
    }
}
?>

<div class="container">
  <h2>Add New Customer</h2>

  <?php if ($success): ?>
    <p style="color:green;">‚úÖ Customer added successfully. ID: <?= $nextId ?></p>
  <?php endif; ?>

  <?php if (!empty($errors)): ?>
    <ul style="color:red;">
      <?php foreach ($errors as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
    </ul>
  <?php endif; ?>

  <form method="POST">
    <fieldset style="margin-bottom:20px;">
      <legend><strong>Main Customer Info</strong></legend>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
        <div>
          <label><strong>Customer ID:</strong></label><br>
          <input type="text" value="<?= $nextId ?>" readonly>
        </div>
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'customer_id') continue; ?>
          <div>
            <label for="<?= $field ?>"><strong><?= ucfirst(str_replace('_', ' ', $field)) ?>:</strong></label><br>
            <input type="text" name="<?= $field ?>" id="<?= $field ?>" value="<?= htmlspecialchars($_POST[$field] ?? '') ?>">
          </div>
        <?php endforeach; ?>
      </div>
    </fieldset>

    <fieldset>
      <legend><strong>Tank & Delivery Line Items</strong></legend>
      <div id="lineItems"></div>
      <button type="button" onclick="addLineItem()" class="btn-outline">‚ûï Add Line Item</button>
    </fieldset>

    <div style="margin-top:20px;">
      <button type="submit" class="btn-outline">üíæ Save Customer</button>
    </div>
  </form>
</div>

<script>
function addLineItem() {
  const container = document.getElementById('lineItems');
  const index = container.children.length;
  const fields = <?= json_encode($itemFields) ?>;
  const row = document.createElement('div');
  row.style.marginBottom = '12px';
  row.style.border = '1px solid #ccc';
  row.style.padding = '10px';
  row.style.borderRadius = '6px';
  row.style.background = '#f9f9f9';

  let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">';
  fields.forEach(f => {
    html += `
      <div>
        <label><strong>${f.replace(/_/g, ' ')}:</strong></label><br>
        <input type="text" name="items[${index}][${f}]" />
      </div>
    `;
  });
  html += '</div>';
  row.innerHTML = html;
  container.appendChild(row);
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_customer.php ---



--- Start of add_discussion.php ---

<?php
require_once 'contact_validator.php';
require_once 'discussion_logger.php'; // contains logDiscussionEntry()

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $contactId = trim($_POST['contact_id'] ?? '');
    // Validate input
    $errors = validateContact($_POST);
    if (!empty($errors)) {
        foreach ($errors as $field => $msg) {
            echo "<p>Error in $field: $msg</p>";
        }
        $backUrl = $contactId !== '' ? 'contact_view.php?id=' . urlencode($contactId) : 'contacts_list.php';
        echo "<p><a href='$backUrl'>Go back</a></p>";
        exit;
    }

    // Log the discussion entry
    if (logDiscussionEntry($_POST)) {
        $redirectUrl = $contactId !== '' ? 'contact_view.php?id=' . urlencode($contactId) : 'contacts_list.php';
        header('Location: ' . $redirectUrl);
        exit;
    } else {
        echo "<p style='color:red;'>Failed to log discussion entry. Please check the error log.</p>";
        $backUrl = $contactId !== '' ? 'contact_view.php?id=' . urlencode($contactId) : 'contacts_list.php';
        echo "<p><a href='$backUrl'>Go back</a></p>";
    }
}
?>



--- End of add_discussion.php ---



--- Start of add_opportunity.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $opportunities = readCSV('opportunities.csv', $schema);
    
    // Validate inputs
    $errors = [];
    
    if (empty($_POST['contact_id'])) {
        $errors[] = 'Contact is required';
    }
    
    if (!isset($_POST['value']) || $_POST['value'] === '' || !is_numeric($_POST['value']) || $_POST['value'] < 0) {
        $errors[] = 'Valid opportunity value is required';
    }
    
    if (!isset($_POST['probability']) || $_POST['probability'] === '' || !is_numeric($_POST['probability']) || $_POST['probability'] < 0 || $_POST['probability'] > 100) {
        $errors[] = 'Probability must be between 0 and 100';
    }
    
    if (empty($_POST['stage'])) {
        $errors[] = 'Stage is required';
    }
    
    if (empty($_POST['expected_close'])) {
        $errors[] = 'Expected close date is required';
    }
    
    if (empty($errors)) {
        // Generate ID
        $ids = array_column($opportunities, 'id');
        $numericIds = array_map('intval', $ids);
        $newId = empty($numericIds) ? 1 : max($numericIds) + 1;
        
        $newOpportunity = [
            'id' => $newId,
            'contact_id' => $_POST['contact_id'] ?? '',
            'value' => number_format((float)$_POST['value'], 2, '.', ''),
            'stage' => $_POST['stage'] ?? 'Prospecting',
            'probability' => (int)$_POST['probability'],
            'expected_close' => $_POST['expected_close'] ?? '',
        ];
        
        $opportunities[] = $newOpportunity;
        
        if (writeCSV('opportunities.csv', $opportunities, $schema)) {
            header('Location: opportunities_list.php?success=1');
            exit;
        } else {
            $error = 'Failed to save opportunity.';
        }
    } else {
        $error = implode(', ', $errors);
    }
}
?>

<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }
  
  .page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
  }
  
  .page-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 14px;
  }
  
  .back-link:hover {
    color: #5558dd;
  }
  
  .form-container {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: 0auto;
  }
  
  .form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #E5E7EB;
  }
  
  .form-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
  
  .form-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  .form-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-group input,
  .form-group select {
    padding: 14px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    background: white;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .form-group select {
    cursor: pointer;
  }
  
  .form-help {
    font-size: 12px;
    color: #6B7280;
    margin-top: 6px;
  }
  
  .stage-visual {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  
  .stage-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  
  .stage-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .stage-badge.selected {
    border-color: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
  
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }
  
  .btn-primary {
    padding: 14px 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-secondary {
    padding: 14px 32px;
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-secondary:hover {
    background: #E5E7EB;
  }
  
  .error-alert {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border: 2px solid #EF4444;
    color: #991B1B;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-slider {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-value {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    min-width: 50px;
  }
  
  input[type="range"] {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #E5E7EB;
    outline: none;
    padding: 0;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
  }
  
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .page-header {
      padding: 24px;
    }
    
    .form-container {
      padding: 24px;
    }
  }
</style>

<a href="opportunities_list.php" class="back-link">
  ‚Üê Back to Opportunities
</a>

<div class="page-header">
  <h1>‚ûï Create New Opportunity</h1>
  <p>Add a new sales opportunity to your pipeline</p>
</div>

<?php if (isset($error)): ?>
  <div class="error-alert">
    <span>‚ö†Ô∏è</span>
    <span><?= htmlspecialchars($error) ?></span>
  </div>
<?php endif; ?>

<div class="form-container">
  <form method="POST" id="opportunityForm">
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üë§</span>
        <span>Contact Information</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="contact_id">Contact *</label>
          <select name="contact_id" id="contact_id" required>
            <option value="">Select a contact...</option>
            <?php foreach ($contacts as $contact): ?>
              <?php
                $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
                $company = $contact['company'] ?? '';
                $displayName = $fullName ?: 'Unnamed Contact';
                if ($company) {
                  $displayName .= ' (' . $company . ')';
                }
              ?>
              <option value="<?= htmlspecialchars($contact['id']) ?>">
                <?= htmlspecialchars($displayName) ?>
              </option>
            <?php endforeach; ?>
          </select>
          <div class="form-help">Select the contact associated with this opportunity</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üí∞</span>
        <span>Deal Details</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="value">Opportunity Value *</label>
          <input 
            type="number" 
            name="value" 
            id="value" 
            placeholder="0.00" 
            step="0.01" 
            min="0"
            required
          >
          <div class="form-help">Enter the total value in dollars</div>
        </div>
        
        <div class="form-group">
          <label for="expected_close">Expected Close Date *</label>
          <input 
            type="date" 
            name="expected_close" 
            id="expected_close"
            required
          >
          <div class="form-help">When do you expect to close this deal?</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üìä</span>
        <span>Sales Stage & Probability</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="stage">Sales Stage *</label>
          <select name="stage" id="stage" required>
            <option value="">Select stage...</option>
            <option value="Prospecting" data-probability="10">Prospecting (10% win rate)</option>
            <option value="Proposal" data-probability="25">Proposal (25% win rate)</option>
            <option value="Negotiation" data-probability="50">Negotiation (50% win rate)</option>
            <option value="Closed Won" data-probability="100">Closed Won (100%)</option>
            <option value="Closed Lost" data-probability="0">Closed Lost (0%)</option>
          </select>
          
          <div class="stage-visual" style="margin-top: 16px;">
            <div class="stage-badge" style="background: #6366F1;" data-stage="Prospecting">Prospecting</div>
            <div class="stage-badge" style="background: #8B5CF6;" data-stage="Proposal">Proposal</div>
            <div class="stage-badge" style="background: #F59E0B;" data-stage="Negotiation">Negotiation</div>
            <div class="stage-badge" style="background: #10B981;" data-stage="Closed Won">Closed Won</div>
            <div class="stage-badge" style="background: #EF4444;" data-stage="Closed Lost">Closed Lost</div>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="probability">Win Probability *</label>
          <div class="probability-slider">
            <input 
              type="range" 
              name="probability" 
              id="probability" 
              min="0" 
              max="100" 
              value="10"
              step="5"
            >
            <span class="probability-value">10%</span>
          </div>
          <div class="form-help">Estimated likelihood of closing this deal</div>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Create Opportunity</button>
      <a href="opportunities_list.php" class="btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Update probability slider value display
  const probabilitySlider = document.getElementById('probability');
  const probabilityValue = document.querySelector('.probability-value');
  
  probabilitySlider.addEventListener('input', function() {
    probabilityValue.textContent = this.value + '%';
  });
  
  // Auto-update probability based on stage selection
  const stageSelect = document.getElementById('stage');
  stageSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const suggestedProbability = selectedOption.getAttribute('data-probability');
    
    if (suggestedProbability) {
      probabilitySlider.value = suggestedProbability;
      probabilityValue.textContent = suggestedProbability + '%';
    }
    
    // Update visual badges
    document.querySelectorAll('.stage-badge').forEach(badge => {
      badge.classList.remove('selected');
      if (badge.getAttribute('data-stage') === this.value) {
        badge.classList.add('selected');
      }
    });
  });
  
  // Allow clicking stage badges to select stage
  document.querySelectorAll('.stage-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const stageName = this.getAttribute('data-stage');
      stageSelect.value = stageName;
      stageSelect.dispatchEvent(new Event('change'));
    });
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_opportunity.php ---



--- Start of add_task.php ---

<?php
require_once 'csv_handler.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title = trim($_POST['title']);
    $due_date = $_POST['due_date'];
    $status = $_POST['status'];
    $errors = [];

    if ($title === '') $errors[] = 'Task title is required.';
    if ($due_date === '') $errors[] = 'Due date is required.';
    elseif (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $due_date)) $errors[] = 'Invalid date format.';
    if ($status !== 'pending' && $status !== 'completed') $errors[] = 'Invalid status selected.';

    if (!empty($errors)) {
        echo "<div style='color:red;'><strong>Error:</strong><ul>";
        foreach ($errors as $error) echo "<li>" . htmlspecialchars($error) . "</li>";
        echo "</ul></div><a href='index.php'>Go back</a>";
        exit;
    }

    $filename = 'tasks.csv';
    $newTask = [$title, $due_date, $status, date('Y-m-d H:i:s')];
    appendCSV($filename, $newTask);
    header('Location: index.php');
    exit;
}
?>


--- End of add_task.php ---



--- Start of add_tasks.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$title = $_POST['title'] ?? '';
if (trim($title) === '') {
    echo 'error: empty title';
    exit;
}

$filename = 'tasks.csv';
$headers = ['id','title','status','priority','assigned_to','due_date','timestamp'];

if (!file_exists($filename)) {
    $fp = fopen($filename, 'w');
    if ($fp === false) {
        echo 'error: cannot create file';
        exit;
    }
    fputcsv($fp, $headers);
    fclose($fp);
}

$id = uniqid('task_', true);
$status = 'incomplete';
$priority = '';
$assigned_to = '';
$due_date = '';
$timestamp = date('Y-m-d H:i:s');

$fp = fopen($filename, 'a');
if ($fp !== false) {
    fputcsv($fp, [$id, $title, $status, $priority, $assigned_to, $due_date, $timestamp]);
    fclose($fp);
    echo 'success';
} else {
    echo 'error: cannot open file for appending';
}
?>

--- End of add_tasks.php ---



--- Start of archive_task.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$idToArchive = $_POST['id'] ?? '';
if (!$idToArchive) {
    echo 'error';
    exit;
}

$filename = 'tasks.csv';
$rows = [];
$found = false;

if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle); // Read and store header
    $rows[] = $headers;

    while (($data = fgetcsv($handle)) !== false) {
        if ($data[0] === $idToArchive) {
            $data[2] = 'archived'; // Update status
            $found = true;
        }
        $rows[] = $data;
    }
    fclose($handle);
}

// Rewrite the CSV only if the task was found
if ($found && ($handle = fopen($filename, 'w')) !== false) {
    foreach ($rows as $row) {
        fputcsv($handle, $row);
    }
    fclose($handle);
    echo 'success';
} else {
    echo 'error';
}
?>


--- End of archive_task.php ---



--- Start of audit_handler.php ---

<?php
/**
 * Audit Logging System - Tracks all contact modifications for compliance
 * 
 * Features:
 * - Logs create, update, delete actions
 * - Records user, timestamp, and old/new values
 * - Stores in activity_log.csv
 * - Provides audit trail queries
 */

require_once __DIR__ . '/csv_handler.php';
require_once __DIR__ . '/backup_handler.php';

define('AUDIT_LOG_FILE', 'activity_log.csv');
define('AUDIT_BACKUP_DIR', 'backups/audit/');

// Ensure audit backup directory exists
if (!is_dir(AUDIT_BACKUP_DIR)) {
    @mkdir(AUDIT_BACKUP_DIR, 0755, true);
}

/**
 * Audit log entry schema
 */
function getAuditSchema() {
    return [
        'id',           // Unique log entry ID
        'timestamp',    // YYYY-MM-DD HH:MM:SS
        'user_id',      // User who made the change
        'ip_address',   // IP address of requester
        'action',       // create, update, delete, import, export
        'entity_type',  // contact, task, opportunity, etc.
        'entity_id',    // ID of affected entity (contact ID)
        'changes',      // JSON: {field: {old: value, new: value}}
        'summary',      // Human readable summary
        'status',       // success, failed
        'error_msg',    // If status=failed, the error
    ];
}

/**
 * Log a contact creation
 */
function auditCreateContact($contact, $status = 'success', $error_msg = null) {
    $changes = [];
    foreach ($contact as $field => $value) {
        if ($field !== 'id' && !empty($value)) {
            $changes[$field] = [
                'old' => null,
                'new' => $value
            ];
        }
    }
    
    return logAuditAction('create', 'contact', $contact['id'] ?? null, $changes, 
                         'Created new contact', $status, $error_msg);
}

/**
 * Log a contact update
 */
function auditUpdateContact($contact_id, $old_contact, $new_contact, $status = 'success', $error_msg = null) {
    $changes = [];
    $changed_fields = [];
    
    foreach ($new_contact as $field => $new_value) {
        $old_value = $old_contact[$field] ?? null;
        
        if ($old_value !== $new_value) {
            $changes[$field] = [
                'old' => $old_value,
                'new' => $new_value
            ];
            $changed_fields[] = $field;
        }
    }
    
    $summary = !empty($changed_fields) 
        ? 'Updated contact: ' . implode(', ', $changed_fields)
        : 'No changes detected';
    
    return logAuditAction('update', 'contact', $contact_id, $changes, $summary, $status, $error_msg);
}

/**
 * Log a contact deletion
 */
function auditDeleteContact($contact) {
    $changes = [];
    foreach ($contact as $field => $value) {
        if ($field !== 'id' && !empty($value)) {
            $changes[$field] = [
                'old' => $value,
                'new' => null
            ];
        }
    }
    
    $summary = 'Deleted contact: ' . ($contact['company'] ?? 'Unknown') . 
               ' (' . ($contact['email'] ?? '') . ')';
    
    return logAuditAction('delete', 'contact', $contact['id'], $changes, $summary, 'success', null);
}

/**
 * Log bulk import
 */
function auditImport($contact_count, $status = 'success', $error_msg = null) {
    $changes = [
        'import_count' => [
            'old' => 0,
            'new' => $contact_count
        ]
    ];
    
    return logAuditAction('import', 'contact', 'bulk', $changes, 
                         "Bulk imported $contact_count contacts", $status, $error_msg);
}

/**
 * Log export action
 */
function auditExport($contact_count, $filters = []) {
    $changes = [
        'export_count' => [
            'old' => 0,
            'new' => $contact_count
        ],
        'filters' => [
            'old' => null,
            'new' => json_encode($filters)
        ]
    ];
    
    return logAuditAction('export', 'contact', 'bulk', $changes, 
                         "Exported $contact_count contacts", 'success', null);
}

/**
 * Core audit logging function
 */
function logAuditAction($action, $entity_type, $entity_id, $changes, $summary, $status = 'success', $error_msg = null) {
    try {
        $log_entry = [
            'id' => uniqid('audit_'),
            'timestamp' => date('Y-m-d H:i:s'),
            'user_id' => $_SESSION['user_id'] ?? 'system',
            'ip_address' => $_SERVER['REMOTE_ADDR'] ?? 'unknown',
            'action' => $action,
            'entity_type' => $entity_type,
            'entity_id' => $entity_id,
            'changes' => json_encode($changes),
            'summary' => $summary,
            'status' => $status,
            'error_msg' => $error_msg ?? '',
        ];
        
        // Ensure audit log file exists
        if (!file_exists(AUDIT_LOG_FILE)) {
            $handle = fopen(AUDIT_LOG_FILE, 'wb');
            if ($handle) {
                // Write header
                $schema = getAuditSchema();
                fputcsv($handle, $schema);
                fclose($handle);
            }
        }
        
        // Append log entry
        $handle = fopen(AUDIT_LOG_FILE, 'ab');
        if ($handle) {
            flock($handle, LOCK_EX);
            $row = array_values($log_entry);
            fputcsv($handle, $row);
            flock($handle, LOCK_UN);
            fclose($handle);
            
            // Log cleanup (keep recent 10000 entries)
            cleanOldAuditLogs();
            
            return true;
        }
        
        return false;
    } catch (Exception $e) {
        error_log("Audit logging failed: " . $e->getMessage());
        return false;
    }
}

/**
 * Get audit log entries for a contact
 */
function getAuditTrail($contact_id, $limit = 50) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    $trail = [];
    
    foreach ($entries as $entry) {
        if (($entry['entity_id'] ?? '') === $contact_id) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $trail[] = $entry;
        }
    }
    
    // Return most recent entries first
    usort($trail, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return array_slice($trail, 0, $limit);
}

/**
 * Get audit logs for a user
 */
function getAuditByUser($user_id, $limit = 100) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    $user_logs = [];
    
    foreach ($entries as $entry) {
        if (($entry['user_id'] ?? '') === $user_id) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $user_logs[] = $entry;
        }
    }
    
    usort($user_logs, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return array_slice($user_logs, 0, $limit);
}

/**
 * Get audit logs within date range
 */
function getAuditByDateRange($start_date, $end_date) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    $filtered = [];
    
    $start_ts = strtotime($start_date . ' 00:00:00');
    $end_ts = strtotime($end_date . ' 23:59:59');
    
    foreach ($entries as $entry) {
        $entry_ts = strtotime($entry['timestamp'] ?? '');
        if ($entry_ts >= $start_ts && $entry_ts <= $end_ts) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $filtered[] = $entry;
        }
    }
    
    usort($filtered, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return $filtered;
}

/**
 * Search audit logs
 */
function searchAuditLogs($query, $limit = 100) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    $query_lower = strtolower($query);
    $results = [];
    
    foreach ($entries as $entry) {
        $searchable = strtolower(
            $entry['summary'] . ' ' . 
            $entry['entity_id'] . ' ' . 
            $entry['user_id'] . ' ' . 
            $entry['action']
        );
        
        if (strpos($searchable, $query_lower) !== false) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $results[] = $entry;
        }
    }
    
    usort($results, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return array_slice($results, 0, $limit);
}

/**
 * Get audit statistics
 */
function getAuditStats($days = 30) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    $cutoff_ts = strtotime("-$days days");
    
    $stats = [
        'total_entries' => 0,
        'actions' => [],
        'users' => [],
        'entities' => [],
        'status' => [],
    ];
    
    foreach ($entries as $entry) {
        $entry_ts = strtotime($entry['timestamp'] ?? '');
        if ($entry_ts >= $cutoff_ts) {
            $stats['total_entries']++;
            
            $action = $entry['action'] ?? 'unknown';
            $stats['actions'][$action] = ($stats['actions'][$action] ?? 0) + 1;
            
            $user = $entry['user_id'] ?? 'unknown';
            $stats['users'][$user] = ($stats['users'][$user] ?? 0) + 1;
            
            $entity = $entry['entity_type'] ?? 'unknown';
            $stats['entities'][$entity] = ($stats['entities'][$entity] ?? 0) + 1;
            
            $status = $entry['status'] ?? 'unknown';
            $stats['status'][$status] = ($stats['status'][$status] ?? 0) + 1;
        }
    }
    
    return $stats;
}

/**
 * Clean old audit logs (keep last 10000 entries)
 */
function cleanOldAuditLogs($keep_count = 10000) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return true;
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    
    if (count($entries) <= $keep_count) {
        return true;  // No cleanup needed
    }
    
    // Keep most recent entries
    $entries = array_slice($entries, -$keep_count);
    
    // Create backup of old entries
    if (function_exists('createBackup')) {
        createBackup(AUDIT_LOG_FILE);
    }
    
    // Rewrite file with kept entries
    $schema = getAuditSchema();
    return writeCSV(AUDIT_LOG_FILE, $entries, $schema);
}

/**
 * Format audit entry for display
 */
function formatAuditEntry($entry) {
    $changes_list = [];
    if (is_array($entry['changes'])) {
        foreach ($entry['changes'] as $field => $change) {
            $old = $change['old'] ?? '';
            $new = $change['new'] ?? '';
            
            if ($old !== null && $new !== null) {
                $changes_list[] = "$field: \"$old\" ‚Üí \"$new\"";
            } elseif ($new !== null) {
                $changes_list[] = "$field: (Added) \"$new\"";
            } else {
                $changes_list[] = "$field: (Removed) \"$old\"";
            }
        }
    }
    
    return [
        'timestamp' => htmlspecialchars($entry['timestamp'] ?? ''),
        'user' => htmlspecialchars($entry['user_id'] ?? 'unknown'),
        'action' => htmlspecialchars($entry['action'] ?? ''),
        'summary' => htmlspecialchars($entry['summary'] ?? ''),
        'changes' => $changes_list,
        'status' => htmlspecialchars($entry['status'] ?? 'unknown'),
        'error' => !empty($entry['error_msg']) ? htmlspecialchars($entry['error_msg']) : null,
    ];
}

?>


--- End of audit_handler.php ---



--- Start of backorders_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$backorderFile = __DIR__ . '/backorders.csv';

$inventory = readCSV($inventoryFile, $inventorySchema);

function read_backorders($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_backorders($filename, $rows) {
  $headers = ['po_number','item_id','item_name','quantity_backorder','note','created_at'];
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, $headers);
  foreach ($rows as $row) {
    $line = [];
    foreach ($headers as $header) {
      $line[] = $row[$header] ?? '';
    }
    fputcsv($file, $line);
  }
  fclose($file);
}

function find_inventory_index($inventory, $itemId) {
  foreach ($inventory as $idx => $row) {
    if (($row['item_id'] ?? '') === $itemId) {
      return $idx;
    }
  }
  return -1;
}

function init_inventory_row($schema, $itemId, $itemName) {
  $row = [];
  foreach ($schema as $field) {
    $row[$field] = '';
  }
  $row['item_id'] = $itemId;
  $row['item_name'] = $itemName;
  $row['quantity_in_stock'] = '0';
  $row['status'] = 'Stock';
  $row['created_at'] = date('Y-m-d H:i:s');
  $row['updated_at'] = $row['created_at'];
  return $row;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['receive_backorder'])) {
  $itemId = trim($_POST['item_id'] ?? '');
  $poNumber = trim($_POST['po_number'] ?? '');
  $qtyReceive = is_numeric($_POST['receive_qty'] ?? '') ? (float)$_POST['receive_qty'] : 0.0;

  $backorders = read_backorders($backorderFile);
  $updated = [];

  foreach ($backorders as $row) {
    if (($row['item_id'] ?? '') === $itemId && ($row['po_number'] ?? '') === $poNumber) {
      $backorderQty = is_numeric($row['quantity_backorder'] ?? '') ? (float)$row['quantity_backorder'] : 0.0;
      $remaining = max(0.0, $backorderQty - $qtyReceive);

      if ($qtyReceive > 0) {
        $invIndex = find_inventory_index($inventory, $itemId);
        if ($invIndex < 0) {
          $inventory[] = init_inventory_row($inventorySchema, $itemId, $row['item_name'] ?? '');
          $invIndex = count($inventory) - 1;
        }
        $current = is_numeric($inventory[$invIndex]['quantity_in_stock'] ?? '') ? (float)$inventory[$invIndex]['quantity_in_stock'] : 0.0;
        $inventory[$invIndex]['quantity_in_stock'] = (string)($current + $qtyReceive);
        $inventory[$invIndex]['updated_at'] = date('Y-m-d H:i:s');
      }

      if ($remaining > 0) {
        $row['quantity_backorder'] = (string)$remaining;
        $updated[] = $row;
      }
    } else {
      $updated[] = $row;
    }
  }

  if ($itemId !== '') {
    $stillBackordered = false;
    foreach ($updated as $row) {
      if (($row['item_id'] ?? '') === $itemId) {
        $stillBackordered = true;
        break;
      }
    }
    $invIndex = find_inventory_index($inventory, $itemId);
    if ($invIndex >= 0 && !$stillBackordered) {
      $inventory[$invIndex]['status'] = 'Stock';
    }
  }

  writeCSV($inventoryFile, $inventory, $inventorySchema);
  write_backorders($backorderFile, $updated);
  header('Location: backorders_list.php');
  exit;
}

$backorders = read_backorders($backorderFile);
?>
<div class="container">
  <h2>Backorders</h2>
  <?php if (empty($backorders)): ?>
    <div style="text-align:center; color:#888; margin-top:18px;">No backorders found.</div>
  <?php else: ?>
    <table style="width:100%; border-collapse:collapse; background:#fff;">
      <thead>
        <tr style="background:#f5f5f5;">
          <th style="padding:8px; text-align:left;">PO</th>
          <th style="padding:8px; text-align:left;">Item ID</th>
          <th style="padding:8px; text-align:left;">Item Name</th>
          <th style="padding:8px; text-align:left;">Backorder Qty</th>
          <th style="padding:8px; text-align:left;">Note</th>
          <th style="padding:8px; text-align:left;">Action</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($backorders as $row): ?>
          <tr>
            <td style="padding:8px;"><?= htmlspecialchars($row['po_number'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['quantity_backorder'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['note'] ?? '') ?></td>
            <td style="padding:8px;">
              <form method="post" style="display:flex; gap:6px; align-items:center;">
                <input type="hidden" name="receive_backorder" value="1">
                <input type="hidden" name="po_number" value="<?= htmlspecialchars($row['po_number'] ?? '') ?>">
                <input type="hidden" name="item_id" value="<?= htmlspecialchars($row['item_id'] ?? '') ?>">
                <input type="number" name="receive_qty" min="0" step="0.01" value="<?= htmlspecialchars($row['quantity_backorder'] ?? '') ?>" style="width:100px; padding:3px 5px;">
                <button type="submit" class="btn-outline">Receive</button>
              </form>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of backorders_list.php ---



--- Start of backup_handler.php ---

<?php
/**
 * Backup System for CSV Data
 * Creates automatic backups before modifications and allows restore
 */

require_once __DIR__ . '/error_handler.php';

define('BACKUP_DIR', __DIR__ . '/backups');
define('BACKUP_RETENTION_DAYS', 30);
define('BACKUP_RETENTION_COUNT', 50);

/**
 * Initialize backup directory
 */
function initializeBackupSystem() {
    if (!is_dir(BACKUP_DIR)) {
        if (!mkdir(BACKUP_DIR, 0755, true)) {
            logError('Failed to create backup directory', ['path' => BACKUP_DIR]);
            return false;
        }
    }
    return true;
}

/**
 * Create a backup of a CSV file before modification
 * Returns backup filename if successful
 */
function createBackup($filename) {
    initializeBackupSystem();
    
    if (!file_exists($filename)) {
        logWarning('Backup requested for non-existent file', ['filename' => $filename]);
        return null;
    }
    
    try {
        $timestamp = date('YmdHis');
        $basefilename = basename($filename);
        $backupFile = BACKUP_DIR . '/' . pathinfo($basefilename, PATHINFO_FILENAME) 
                    . '_' . $timestamp . '.' . pathinfo($basefilename, PATHINFO_EXTENSION);
        
        if (copy($filename, $backupFile)) {
            logInfo('Backup created successfully', [
                'original' => $filename,
                'backup' => $backupFile,
                'size' => filesize($backupFile),
            ]);
            
            // Clean up old backups
            cleanOldBackups();
            
            return $backupFile;
        } else {
            logError('Failed to create backup file', ['filename' => $filename]);
            return null;
        }
    } catch (Exception $e) {
        logError('Backup creation exception', ['exception' => $e->getMessage()]);
        return null;
    }
}

/**
 * Restore a CSV file from backup
 */
function restoreFromBackup($backupFile, $targetFile) {
    if (!file_exists($backupFile)) {
        throw new Exception("Backup file not found: {$backupFile}");
    }
    
    // Verify backup is in backup directory
    $realBackupPath = realpath($backupFile);
    $realBackupDir = realpath(BACKUP_DIR);
    
    if (strpos($realBackupPath, $realBackupDir) !== 0) {
        throw new Exception("Invalid backup file path (security check failed)");
    }
    
    try {
        // Create backup of current state before restoring
        createBackup($targetFile);
        
        // Restore from backup
        if (copy($backupFile, $targetFile)) {
            logInfo('Data restored from backup', [
                'backup_file' => $backupFile,
                'target_file' => $targetFile,
            ]);
            return true;
        } else {
            throw new Exception("Failed to copy backup to target location");
        }
    } catch (Exception $e) {
        logError('Restore from backup failed', ['exception' => $e->getMessage()]);
        throw $e;
    }
}

/**
 * Get list of available backups for a file
 */
function listBackups($filename = null) {
    initializeBackupSystem();
    
    if (!is_dir(BACKUP_DIR)) {
        return [];
    }
    
    $backups = [];
    $files = scandir(BACKUP_DIR, SCANDIR_SORT_DESCENDING);
    
    foreach ($files as $file) {
        if ($file === '.' || $file === '..') {
            continue;
        }
        
        $fullPath = BACKUP_DIR . '/' . $file;
        
        // Filter by filename if specified
        if ($filename !== null) {
            $filenameBase = pathinfo($filename, PATHINFO_FILENAME);
            if (strpos($file, $filenameBase) !== 0) {
                continue;
            }
        }
        
        if (is_file($fullPath)) {
            // Extract timestamp from filename (format: name_YmdHis.ext)
            if (preg_match('/_(\d{14})\./', $file, $matches)) {
                $timestamp = $matches[1];
                $datetime = DateTime::createFromFormat('YmdHis', $timestamp);
                
                $backups[] = [
                    'filename' => $file,
                    'path' => $fullPath,
                    'timestamp' => $timestamp,
                    'datetime' => $datetime ? $datetime->format('Y-m-d H:i:s') : 'Unknown',
                    'size' => filesize($fullPath),
                    'size_formatted' => formatBytes(filesize($fullPath)),
                ];
            }
        }
    }
    
    return $backups;
}

/**
 * Clean up old backup files
 * Removes backups older than BACKUP_RETENTION_DAYS or beyond BACKUP_RETENTION_COUNT
 */
function cleanOldBackups() {
    if (!is_dir(BACKUP_DIR)) {
        return;
    }
    
    $files = scandir(BACKUP_DIR, SCANDIR_SORT_DESCENDING);
    $fileCount = 0;
    $cutoffDate = time() - (BACKUP_RETENTION_DAYS * 86400);
    
    foreach ($files as $file) {
        if ($file === '.' || $file === '..') {
            continue;
        }
        
        $fullPath = BACKUP_DIR . '/' . $file;
        
        if (!is_file($fullPath)) {
            continue;
        }
        
        $fileCount++;
        
        // Delete if older than retention days
        if (filemtime($fullPath) < $cutoffDate) {
            if (unlink($fullPath)) {
                logInfo('Old backup deleted (retention period)', ['file' => $file]);
            }
            continue;
        }
        
        // Delete if beyond retention count
        if ($fileCount > BACKUP_RETENTION_COUNT) {
            if (unlink($fullPath)) {
                logInfo('Backup deleted (retention count exceeded)', ['file' => $file]);
            }
        }
    }
}

/**
 * Format bytes as human-readable size
 */
function formatBytes($bytes, $precision = 2) {
    $units = ['B', 'KB', 'MB', 'GB'];
    
    for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
        $bytes /= 1024;
    }
    
    return round($bytes, $precision) . ' ' . $units[$i];
}

/**
 * Get backup statistics
 */
function getBackupStats() {
    if (!is_dir(BACKUP_DIR)) {
        return [
            'total_backups' => 0,
            'total_size' => 0,
            'total_size_formatted' => '0 B',
            'oldest_backup' => null,
            'newest_backup' => null,
        ];
    }
    
    $backups = listBackups();
    $totalSize = 0;
    
    foreach ($backups as $backup) {
        $totalSize += $backup['size'];
    }
    
    return [
        'total_backups' => count($backups),
        'total_size' => $totalSize,
        'total_size_formatted' => formatBytes($totalSize),
        'oldest_backup' => !empty($backups) ? end($backups) : null,
        'newest_backup' => !empty($backups) ? reset($backups) : null,
    ];
}

/**
 * Initialize backup system on require
 */
initializeBackupSystem();

?>


--- End of backup_handler.php ---



--- Start of bulk_action.php ---

<?php
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
$schema = file_exists($schemaFile) ? require $schemaFile : [];
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

$selectedIds = $_POST['selected_ids'] ?? [];
$action = $_POST['action'] ?? '';
$tagToAssign = $_POST['assign_tag'] ?? '';
$statusToAssign = $_POST['assign_status'] ?? '';

if (!is_array($selectedIds) || empty($action)) {
    die('Error: No contacts selected or no action specified.');
}

$updatedContacts = [];
$exportRows = [];

foreach ($contacts as $contact) {
    $id = $contact['id'] ?? '';
    $isSelected = in_array($id, $selectedIds);

    if ($action === 'delete' && $isSelected) {
        continue; // Skip this contact (delete)
    }

    if ($action === 'export' && $isSelected) {
        $row = [];
        foreach ($schema as $field) {
            $row[] = $contact[$field] ?? '';
        }
        $exportRows[] = $row;
    }

    if ($action === 'assign_tag' && $isSelected && $tagToAssign !== '') {
        $existingTags = array_map('trim', explode(',', $contact['tags'] ?? ''));
        if (!in_array($tagToAssign, $existingTags)) {
            $existingTags[] = $tagToAssign;
        }
        $contact['tags'] = implode(', ', $existingTags);
    }

    if ($action === 'assign_status' && $isSelected && $statusToAssign !== '') {
        $contact['status'] = $statusToAssign;
    }

    $updatedContacts[] = $contact;
}

if ($action === 'export') {
    $filename = 'contacts_bulk_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($exportRows as $row) {
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
} else {
    writeCSV('contacts.csv', $updatedContacts, $schema);
    header('Location: contacts_list.php');
    exit;
}
?>

--- End of bulk_action.php ---



--- Start of calendar.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

// Load tasks from handler
require_once 'layout_start.php';
require_once 'csv_handler.php'; // or whatever file defines readCSV()

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp']; // adjust based on your actual CSV columns
$tasks = readCSV($filename, $schema);

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        $tasksByDate[$task['due_date']][] = $task;
    }
}

?>


<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }

  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }

  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }

  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>
<h2>Task Calendar</h2>
<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
  <?php
  $year = date('Y');
  $month = date('m');
  $daysInMonth = date('t');
  $firstDayOfMonth = date('w', strtotime("$year-$month-01"));

  $day = 1;
  $week = [];

  for ($i = 0; $i < $firstDayOfMonth; $i++) {
      $week[] = "<td></td>";
  }

  while ($day <= $daysInMonth) {
      $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
      if (isset($tasksByDate[$dateStr])) {
          $taskTitles = '';
          foreach ($tasksByDate[$dateStr] as $task) {
              $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
          }
          $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
      } else {
          $week[] = "<td>$day</td>";
      }

      if (count($week) == 7) {
          echo "<tr>" . implode('', $week) . "</tr>";
          $week = [];
      }

      $day++;
  }

  if (!empty($week)) {
      while (count($week) < 7) {
          $week[] = "<td></td>";
      }
      echo "<tr>" . implode('', $week) . "</tr>";
  }
  ?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}
</script>

<?php include 'layout_end.php'; ?>


--- End of calendar.php ---



--- Start of commit_import.php ---

<?php
session_start();
require_once 'csv_handler.php';
require_once 'error_handler.php';
require_once 'contact_validator.php';

$schema = require __DIR__ . '/contact_schema.php';
$targetFile = 'contacts.csv';

// CSRF token verification
if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
    showError('CSRF token validation failed. Import cancelled.');
    logError('CSRF token validation failed during import', ['ip' => $_SERVER['REMOTE_ADDR']]);
    exit;
}

// Validate session data
$contacts = $_SESSION['import_preview'] ?? [];

if (!is_array($contacts) || empty($contacts)) {
    echo "<div class='container'>";
    showError('No import data received or session expired. <a href="import_contacts.php">Try again</a>');
    logWarning('Import failed: no data in session', ['ip' => $_SERVER['REMOTE_ADDR']]);
    echo "</div>";
    exit;
}

echo "<div class='container'>";
echo "<h2>Commit Import</h2>";

// Re-validate each contact before import (safety check)
$validContacts = [];
$importErrors = [];

foreach ($contacts as $index => $contact) {
    $contact_errors = validateContact($contact);
    if (empty($contact_errors)) {
        $validContacts[] = $contact;
    } else {
        $importErrors[$index] = $contact_errors;
    }
}

if (!empty($importErrors)) {
    showError('Some contacts failed final validation. Import aborted.');
    echo "<p><strong>Failed contacts:</strong></p>";
    echo "<ul>";
    foreach ($importErrors as $idx => $errors) {
        echo "<li>Contact " . ($idx + 1) . ": " . implode(", ", $errors) . "</li>";
    }
    echo "</ul>";
    logError('Import failed during validation', ['count' => count($importErrors), 'total' => count($contacts)]);
    echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
    echo "</div>";
    exit;
}

// Final check: Re-validate schema alignment
if (!empty($validContacts)) {
    $schema_valid = true;
    foreach ($validContacts as $contact) {
        foreach ($schema as $col) {
            if (!array_key_exists($col, $contact)) {
                $schema_valid = false;
                break;
            }
        }
        if (!$schema_valid) break;
    }
    
    if (!$schema_valid) {
        showError('Contact schema mismatch. Import aborted.');
        logError('Schema validation failed during import', ['schemas' => json_encode($schema)]);
        echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
        echo "</div>";
        exit;
    }
}

// Create backup before import
if (file_exists($targetFile) && function_exists('createBackup')) {
    $backup_result = createBackup($targetFile);
    if (!$backup_result) {
        showError('Failed to create backup. Import cancelled for safety.');
        logError('Backup creation failed during import', ['file' => $targetFile]);
        echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
        echo "</div>";
        exit;
    }
}

// Attempt to write/append contacts
try {
    $success = writeCSV($targetFile, $validContacts, $schema);
    
    if ($success) {
        showSuccess('Import complete. ' . count($validContacts) . ' contacts added successfully.');
        logInfo('Import successful', ['count' => count($validContacts), 'user_id' => $_SESSION['user_id'] ?? 'unknown']);
        
        // ‚úÖ AUDIT: Log bulk import
        auditImport(count($validContacts), 'success');
        
        echo "<p><a href='contacts_list.php' class='btn'>‚Üê Back to Contacts</a></p>";
        unset($_SESSION['import_preview']);
    } else {
        showError('Failed to write contacts to file. Import may have failed.');
        logError('Write operation failed during import', ['file' => $targetFile, 'count' => count($validContacts)]);
        
        // ‚úÖ AUDIT: Log failed import
        auditImport(count($validContacts), 'failed', 'Write operation failed');
        
        echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
    }
} catch (Exception $e) {
    showError('Unexpected error during import: ' . htmlspecialchars($e->getMessage()));
    logError('Exception during import', ['error' => $e->getMessage(), 'code' => $e->getCode()]);
    
    // ‚úÖ AUDIT: Log failed import with exception
    auditImport(count($validContacts), 'failed', $e->getMessage());
    
    echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
}

echo "</div>";
?>



--- End of commit_import.php ---



--- Start of contacts_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
require_once 'csv_handler.php';

// Simple escape helper if sanitize_helper not loaded
if (!function_exists('e')) {
    function e($str) {
        return htmlspecialchars($str ?? '', ENT_QUOTES, 'UTF-8');
    }
}

// Simple CSRF helper fallback
if (!function_exists('renderCSRFInput')) {
    function renderCSRFInput() {
        // Empty fallback - CSRF protection can be added later
        return '';
    }
}

// ‚úÖ PAGINATION CONSTANTS
define('DEFAULT_CONTACTS_PER_PAGE', 50);
define('ALLOWED_PER_PAGE_OPTIONS', [10, 25, 50, 100]);

// Load schema safely
$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;

// DEBUG: Show all GET parameters for troubleshooting
$debugMode = false; // Set to true to enable debugging
if ($debugMode && !empty($_GET)) {
    error_log("CONTACTS SEARCH DEBUG - GET Parameters: " . print_r($_GET, true));
}

if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

// Load field visibility preferences from CSV
$csvPath = __DIR__ . '/field_visibility.csv';
$fieldSaveError = '';

function loadDisplayFields($csvPath) {
  $fields = [];
  if (file_exists($csvPath)) {
    $handle = fopen($csvPath, 'r');
    if ($handle !== false) {
      while (($row = fgetcsv($handle)) !== false) {
        if (count($row) === 2 && strtolower($row[1]) === 'true') {
          $fields[] = $row[0];
        }
      }
      fclose($handle);
    }
  }
  return $fields;
}

$displayFields = loadDisplayFields($csvPath);

// Save field visibility preferences to CSV only when Apply is clicked
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['apply'])) {
  $selectedFields = isset($_POST['display']) ? (array)$_POST['display'] : [];
  $selectedFields = array_values(array_intersect($schema, $selectedFields));

  $csvDir = dirname($csvPath);
  if (!is_writable($csvDir) || (file_exists($csvPath) && !is_writable($csvPath))) {
    $fieldSaveError = 'Field visibility file is not writable. Check folder permissions.';
  } else {
    $handle = fopen($csvPath, 'w');
    if ($handle === false) {
      $fieldSaveError = 'Could not open field visibility file for writing.';
    } else {
      foreach ($schema as $field) {
        $visible = in_array($field, $selectedFields, true) ? 'true' : 'false';
        fputcsv($handle, [$field, $visible]);
      }
      fclose($handle);
    }
  }

  clearstatcache(true, $csvPath);
  $displayFields = loadDisplayFields($csvPath);

  if (empty($fieldSaveError)) {
    $saved = array_values(array_intersect($schema, $displayFields));
    if ($saved !== $selectedFields) {
      $fieldSaveError = 'Field visibility did not persist. Please refresh and try again.';
    }
  }
}

// Fallback if displayFields is empty
if (empty($displayFields)) {
    $displayFields = ['first_name', 'last_name', 'company', 'email'];
}

// ‚úÖ PAGINATION: Get current page and per-page setting
$per_page = isset($_GET['per_page']) && in_array((int)$_GET['per_page'], ALLOWED_PER_PAGE_OPTIONS) 
    ? (int)$_GET['per_page'] 
    : DEFAULT_CONTACTS_PER_PAGE;

$current_page = isset($_GET['page']) ? max(1, (int)$_GET['page']) : 1;

// Handle query and sort
$query = strtolower(trim($_GET['query'] ?? ''));
$field = $_GET['field'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$activeSort = array_flip($sortFields);

// Load contacts safely
$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Detect duplicates
$emailCount = [];
foreach ($contacts as $c) {
    $email = strtolower(trim($c['email'] ?? ''));
    if (!empty($email)) {
        $emailCount[$email] = ($emailCount[$email] ?? 0) + 1;
    }
}

// Apply filter - search across multiple fields
if ($query !== '') {
    if ($field && in_array($field, $schema)) {
        // Search in specific field if specified
        $contacts = array_filter($contacts, function($c) use ($field, $query) {
            $fieldValue = $c[$field] ?? '';
            return stripos($fieldValue, $query) !== false;
        });
    } else {
        // Search across all text fields
        $searchableFields = ['first_name', 'last_name', 'company', 'email', 'phone', 'city', 'province', 'country', 'tags', 'notes'];
        $contacts = array_filter($contacts, function($c) use ($query, $searchableFields) {
            foreach ($searchableFields as $searchField) {
                $fieldValue = $c[$searchField] ?? '';
                if (stripos($fieldValue, $query) !== false) {
                    return true;
                }
            }
            return false;
        });
    }
    // Re-index after filter
    $contacts = array_values($contacts);
}


// Apply multi-field sort
$validSortFields = array_filter($sortFields, function($f) use ($displayFields) {
    return in_array($f, $displayFields);
});

if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';
            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// ‚úÖ PAGINATION: Calculate pagination info
$total_contacts = count($contacts);
$total_pages = max(1, ceil($total_contacts / $per_page));
$current_page = min($current_page, $total_pages); // Ensure current page doesn't exceed total pages
$offset = ($current_page - 1) * $per_page;

// ‚úÖ PAGINATION: Get contacts for current page
$page_contacts = array_slice($contacts, $offset, $per_page);

// Export logic (exports filtered results, not just current page)
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }
    fputcsv($output, $displayFields);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($displayFields as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<!-- DEBUG: Show GET parameters -->
<?php if ($debugMode): ?>
  <div style="background: #ff6b6b; color: white; padding: 20px; margin: 20px; border-radius: 8px; font-family: monospace; font-size: 14px;">
    <strong style="font-size: 18px;">üî¥ DEBUG MODE ACTIVE</strong><br><br>
    <strong>All GET Parameters:</strong><br>
    <?php foreach ($_GET as $key => $value): ?>
      <div style="backgroundColor: rgba(255,255,255,0.1); padding: 5px; margin: 3px 0; border-radius: 3px;">
        <strong><?= htmlspecialchars($key) ?>:</strong> "<?= htmlspecialchars($value) ?>"
      </div>
    <?php endforeach; ?>
    <?php if (empty($_GET)): ?>
      <div style="backgroundColor: rgba(255,255,255,0.1); padding: 10px; border-radius: 3px;">NO GET PARAMETERS - Form might not be submitting!</div>
    <?php endif; ?>
    
    <hr style="margin: 20px 0; border-color: rgba(255,255,255,0.3);">
    <strong>EMERGENCY SIMPLE SEARCH (Use this instead!):</strong><br>
    <form method="GET" action="contacts_list.php" style="margin-top: 15px;">
      <input type="text" name="query" placeholder="Type search term..." style="padding: 10px; font-size: 16px; border: 2px solid white; border-radius: 4px; width: 300px; color: #333;">
      <input type="hidden" name="field" value="">
      <button type="submit" style="padding: 10px 20px; font-size: 16px; background: white; color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;">üîç SEARCH</button>
    </form>
  </div>
<?php endif; ?>

<div class="container-fluid px-0">
  <div class="d-flex flex-wrap justify-content-between align-items-start mb-4 gap-3">
    <div>
      <h1 class="h2 mb-1">üë• All Contacts</h1>
      <p class="text-muted mb-0"><?= $total_contacts ?> total contacts</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-outline-secondary js-toggle-panel" data-target="fieldPanel">
        <i class="bi bi-sliders"></i> Customize Columns
      </button>
      <a href="import_contacts.php" class="btn btn-outline-secondary">
        <i class="bi bi-upload"></i> Import
      </a>
      <a href="contact_form.php" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Add Contact
      </a>
    </div>
  </div>
</div>

<?php if (!empty($fieldSaveError)): ?>
  <div class="alert alert-error"><?= e($fieldSaveError) ?></div>
<?php elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['apply'])): ?>
  <div class="alert alert-success">Column visibility updated.</div>
<?php endif; ?>

<!-- Field Visibility Panel -->
<div id="fieldPanel" class="card shadow-sm mb-4" style="display:none; max-width: 600px;">
  <form method="POST" class="p-3">
    <input type="hidden" name="apply" value="1">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Customize Visible Columns</h5>
      <button type="button" class="btn-close js-toggle-panel" data-target="fieldPanel" aria-label="Close"></button>
    </div>
    <div class="row g-2 mb-3">
      <?php foreach ($schema as $f): ?>
        <div class="col-6 col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="display[]" value="<?= $f ?>" id="field-<?= $f ?>" <?= in_array($f, $displayFields) ? 'checked' : '' ?>>
            <label class="form-check-label" for="field-<?= $f ?>">
              <?= ucfirst(str_replace('_', ' ', $f)) ?>
            </label>
          </div>
        </div>
      <?php endforeach; ?>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button type="submit" class="btn btn-primary">Apply Changes</button>
      <button type="button" class="btn btn-outline-secondary js-toggle-panel" data-target="fieldPanel">Cancel</button>
    </div>
  </form>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <!-- Search Bar -->
    <form method="GET" action="contacts_list.php" class="row g-2 align-items-center mb-3">
      <div class="col-12 col-md-5">
        <input type="text" name="query" class="form-control" placeholder="Search contacts..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
      </div>
      <div class="col-6 col-md-3">
        <select name="field" class="form-select">
          <option value="">All Fields</option>
          <?php foreach ($schema as $f): ?>
            <option value="<?= htmlspecialchars($f) ?>" <?= ($field ?? '') === $f ? 'selected' : '' ?>>
              <?= ucfirst(str_replace('_', ' ', $f)) ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>
      <div class="col-6 col-md-2 d-grid">
        <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Search</button>
      </div>
      <?php if (!empty($_GET['query'])): ?>
        <div class="col-12 col-md-2 d-grid">
          <a href="contacts_list.php" class="btn btn-outline-secondary">‚úï Clear</a>
        </div>
      <?php endif; ?>
    </form>

    <!-- Results Info Bar -->
    <div class="d-flex justify-content-between align-items-center bg-light rounded p-3 mb-3 border">
      <div>
        <?php if ($query !== ''): ?>
          <span class="badge bg-primary me-2"><?= $total_contacts ?> results</span>
          <span class="text-muted">filtered from <?= count(readCSV('contacts.csv', $schema)) ?> total</span>
        <?php else: ?>
          Showing <strong><?= $offset + 1 ?>‚Äì<?= min($offset + $per_page, $total_contacts) ?></strong> of <strong><?= $total_contacts ?></strong> contacts
        <?php endif; ?>
      </div>
      <div>
        <?php if ($total_pages > 1): ?>
          Page <strong><?= $current_page ?></strong> of <strong><?= $total_pages ?></strong>
        <?php endif; ?>
      </div>
    </div>

    <!-- Pagination -->
    <?php if ($total_pages > 1): ?>
      <nav aria-label="Contacts pagination">
        <ul class="pagination justify-content-center flex-wrap">
          <li class="page-item<?= $current_page == 1 ? ' disabled' : '' ?>">
            <a class="page-link" href="?page=1&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>" tabindex="-1">&laquo;</a>
          </li>
          <li class="page-item<?= $current_page == 1 ? ' disabled' : '' ?>">
            <a class="page-link" href="?page=<?= $current_page - 1 ?>&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>">&lsaquo;</a>
          </li>
          <?php 
          $page_range = 5;
          $start_page = max(1, $current_page - floor($page_range / 2));
          $end_page = min($total_pages, $start_page + $page_range - 1);
          $start_page = max(1, $end_page - $page_range + 1);
          if ($start_page > 1) echo '<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>';
          for ($p = $start_page; $p <= $end_page; $p++) {
            if ($p === $current_page) {
              echo '<li class="page-item active"><span class="page-link">' . $p . '</span></li>';
            } else {
              echo '<li class="page-item"><a class="page-link" href="?page=' . $p . '&query=' . urlencode($_GET['query'] ?? '') . '&field=' . urlencode($field) . '&sort=' . urlencode($_GET['sort'] ?? '') . '&direction=' . $sortDirection . '&per_page=' . $per_page . '">' . $p . '</a></li>';
            }
          }
          if ($end_page < $total_pages) echo '<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>';
          ?>
          <li class="page-item<?= $current_page == $total_pages ? ' disabled' : '' ?>">
            <a class="page-link" href="?page=<?= $current_page + 1 ?>&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>">&rsaquo;</a>
          </li>
          <li class="page-item<?= $current_page == $total_pages ? ' disabled' : '' ?>">
            <a class="page-link" href="?page=<?= $total_pages ?>&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>">&raquo;</a>
          </li>
        </ul>
      </nav>
    <?php endif; ?>

    <!-- Contacts Table -->
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th style="min-width:120px;">Actions</th>
            <?php foreach ($displayFields as $f): ?>
              <th>
                <a href="?query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= e($f) ?>&direction=<?= (in_array($f, $sortFields) && $sortDirection === 'asc') ? 'desc' : 'asc' ?>&per_page=<?= $per_page ?>" class="text-decoration-none text-dark">
                  <?= ucfirst(str_replace('_', ' ', $f)) ?>
                  <?php if (isset($activeSort[$f])): ?>
                    <i class="bi bi-caret-<?= $sortDirection === 'desc' ? 'down' : 'up' ?>-fill ms-1"></i>
                  <?php else: ?>
                    <i class="bi bi-arrow-down-up ms-1 text-secondary"></i>
                  <?php endif; ?>
                </a>
              </th>
            <?php endforeach; ?>
          </tr>
        </thead>
        <tbody>
          <?php if (empty($page_contacts)): ?>
            <tr>
              <td colspan="<?= count($displayFields) + 1 ?>" class="empty-state">
                <div class="empty-state-content">
                  <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm.256 7a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/>
                    <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Zm-1.993-1.679a.5.5 0 0 0-.686.172l-1.17 1.95-.547-.547a.5.5 0 0 0-.708.708l.774.773a.75.75 0 0 0 1.174-.144l1.335-2.226a.5.5 0 0 0-.172-.686Z"/>
                  </svg>
                  <h3>No contacts found</h3>
                  <p><?= $query ? 'Try adjusting your search or filters' : 'Get started by adding your first contact' ?></p>
                  <?php if (!$query): ?>
                    <a href="contact_form.php" class="btn btn-primary">Add Contact</a>
                  <?php endif; ?>
                </div>
              </td>
            </tr>
          <?php else: ?>
            <?php foreach ($page_contacts as $contact): ?>
              <?php
                $id = isset($contact['id']) ? $contact['id'] : '';
                $email = $contact['email'] ?? '';
                $isDuplicate = !empty($email) && $emailCount[strtolower(trim($email))] > 1;
              ?>
              <tr class="contact-row" data-contact-id="<?= escapeAttr($id) ?>">
                <td>
                  <div class="btn-group" role="group">
                    <a href="contact_view.php?id=<?= escapeAttr($id) ?>" class="btn btn-sm btn-outline-primary" title="View contact"><i class="bi bi-person-lines-fill"></i></a>
                    <a href="contact_view.php?id=<?= escapeAttr($id) ?>#edit" class="btn btn-sm btn-outline-secondary" title="Edit contact"><i class="bi bi-pencil"></i></a>
                    <form method="POST" action="delete_contact.php" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this contact?');">
                      <?php renderCSRFInput(); ?>
                      <input type="hidden" name="id" value="<?= escapeAttr($id) ?>">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete contact"><i class="bi bi-trash"></i></button>
                    </form>
                  </div>
                </td>
                <?php foreach ($displayFields as $f): ?>
                  <td>
                    <?php if ($f === 'email'): ?>
                      <span class="d-flex align-items-center gap-2">
                        <?= e($contact[$f] ?? '') ?>
                        <?php if ($isDuplicate): ?>
                          <span class="badge bg-danger" title="Duplicate email detected">Duplicate</span>
                        <?php endif; ?>
                      </span>
                    <?php elseif ($f === 'company'): ?>
                      <strong><?= e($contact[$f] ?? '') ?></strong>
                    <?php else: ?>
                      <?= e($contact[$f] ?? '') ?>
                    <?php endif; ?>
                  </td>
                <?php endforeach; ?>
              </tr>
            <?php endforeach; ?>
          <?php endif; ?>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
/* ========== PAGE HEADER ========== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 16px;
  position: relative;
  z-index: 5;
}

.page-title-section h1 {
  margin: 0;
  font-size: 32px;
  font-weight: 700;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-subtitle {
  margin: 4px 0 0 0;
  font-size: 14px;
  color: #6b7280;
  font-weight: 400;
}

.page-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  position: relative;
  z-index: 6;
}

.page-actions .btn {
  position: relative;
  z-index: 7;
}

.page-actions .btn svg {
  margin-right: 6px;
}

/* ========== COLLAPSIBLE PANEL ========== */
.collapsible-panel {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  border-bottom: 1px solid #e5e7eb;
}

.panel-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #374151;
}

.btn-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #9ca3af;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.2s;
}

.btn-close:hover {
  background: #e5e7eb;
  color: #374151;
}

.panel-body {
  padding: 20px;
}

.panel-footer {
  padding: 16px 20px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  transition: background 0.2s;
}

.checkbox-label:hover {
  background: #f3f4f6;
}

.checkbox-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #0099A8;
}

.checkbox-text {
  font-size: 14px;
  color: #374151;
  user-select: none;
}

/* ========== SEARCH & FILTER BAR ========== */
.search-filter-section {
  margin-bottom: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.quick-search-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.search-input-wrapper {
  position: relative;
  flex: 1;
  min-width: 280px;
}

.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  pointer-events: none;
}

.search-input {
  width: 100%;
  padding: 10px 40px 10px 44px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 15px;
  transition: all 0.2s;
}

.search-input:focus {
  outline: none;
  border-color: #0099A8;
  box-shadow: 0 0 0 3px rgba(0, 153, 168, 0.1);
}

.clear-search {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.clear-search:hover {
  background: #f3f4f6;
  color: #374151;
}

.filter-select {
  padding: 10px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 160px;
}

.filter-select:focus {
  outline: none;
  border-color: #0099A8;
  box-shadow: 0 0 0 3px rgba(0, 153, 168, 0.1);
}

.advanced-filters {
  padding: 20px;
  background: #f9fafb;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
}

.filter-item label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}

.form-control {
  width: 100%;
  padding: 9px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;
}

.form-control:focus {
  outline: none;
  border-color: #0099A8;
  box-shadow: 0 0 0 3px rgba(0, 153, 168, 0.1);
}

/* ========== RESULTS INFO BAR ========== */
.results-info-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 8px;
  margin-bottom: 16px;
  border: 1px solid #bae6fd;
}

.results-count {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: #374151;
}

.text-muted {
  color: #6b7280;
  font-size: 13px;
}

.pagination-info {
  font-size: 14px;
  color: #6b7280;
}

/* ========== MODERN PAGINATION ========== */
.pagination-nav {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid #e5e7eb;
}

.pagination-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.pagination-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: #374151;
  text-decoration: none;
}

.pagination-btn:hover {
  background: #f3f4f6;
  border-color: #0099A8;
  color: #0099A8;
}

.pagination-btn-disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.pagination-btn-disabled:hover {
  background: white;
  border-color: #d1d5db;
  color: #374151;
}

.pagination-pages {
  display: flex;
  gap: 4px;
  align-items: center;
}

.pagination-page {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 36px;
  padding: 0 10px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: #374151;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
}

.pagination-page:hover {
  background: #f3f4f6;
  border-color: #0099A8;
  color: #0099A8;
}

.pagination-page-active {
  background: linear-gradient(135deg, #0099A8 0%, #00859a 100%);
  color: white;
  border-color: #0099A8;
  font-weight: 600;
}

.pagination-page-active:hover {
  background: linear-gradient(135deg, #00859a 0%, #007489 100%);
  color: white;
}

.pagination-ellipsis {
  color: #9ca3af;
  padding: 0 4px;
}

/* ========== TABLE STYLES ========== */
.table-container {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-top: 16px;
}

.contacts-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.contacts-table thead {
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  border-bottom: 2px solid #e5e7eb;
}

.contacts-table th {
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: #374151;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
}

.th-actions {
  width: 140px;
  min-width: 140px;
}

.th-sortable {
  cursor: pointer;
}

.sort-header {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #374151;
  text-decoration: none;
  transition: color 0.2s;
}

.sort-header:hover {
  color: #0099A8;
}

.sort-icon {
  font-size: 14px;
  color: #0099A8;
  font-weight: bold;
}

.sort-icon-inactive {
  color: #d1d5db;
  font-weight: normal;
}

.contacts-table tbody tr {
  border-bottom: 1px solid #f3f4f6;
  transition: all 0.15s;
}

.contacts-table tbody tr:hover {
  background: #f9fafb;
}

.contacts-table td {
  padding: 14px 16px;
  font-size: 14px;
  color: #374151;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 0;
  vertical-align: middle;
  box-sizing: border-box;
}

.contacts-table td:hover {
  overflow: visible;
  white-space: normal;
}

.actions-cell {
  padding: 10px 16px !important;
}

.action-buttons {
  display: flex;
  gap: 6px;
  align-items: center;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: 1px solid #e5e7eb;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: #6b7280;
  text-decoration: none;
}

.action-btn:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
  transform: translateY(-1px);
}

.action-btn-view:hover {
  background: #dbeafe;
  border-color: #93c5fd;
  color: #1e40af;
}

.action-btn-edit:hover {
  background: #fef3c7;
  border-color: #fcd34d;
  color: #92400e;
}

.action-btn-delete:hover {
  background: #fee2e2;
  border-color: #fca5a5;
  color: #991b1b;
}

.email-cell {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  white-space: normal !important;
  overflow: visible !important;
}

.email-cell-cell {
  white-space: normal;
}

.contacts-table td.company-cell {
  font-weight: 600;
  white-space: normal;
  word-wrap: break-word;
}

/* ========== EMPTY STATE ========== */
.empty-state {
  padding: 60px 20px;
  text-align: center;
}

.empty-state-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  color: #6b7280;
}

.empty-state-content svg {
  color: #d1d5db;
  margin-bottom: 8px;
}

.empty-state-content h3 {
  margin: 0;
  font-size: 20px;
  color: #374151;
  font-weight: 600;
}

.empty-state-content p {
  margin: 0;
  font-size: 14px;
  color: #9ca3af;
  max-width: 400px;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .page-title-section h1 {
    font-size: 24px;
  }
  
  .quick-search-bar {
    flex-direction: column;
  }
  
  .search-input-wrapper {
    min-width: 100%;
  }
  
  .filter-grid {
    grid-template-columns: 1fr;
  }
  
  .checkbox-grid {
    grid-template-columns: 1fr;
  }
  
  .table-container {
    border-radius: 0;
    margin-left: -20px;
    margin-right: -20px;
    border-left: 0;
    border-right: 0;
  }
  
  .pagination-controls {
    gap: 4px;
  }
  
  .pagination-btn,
  .pagination-page {
    width: 32px;
    height: 32px;
    min-width: 32px;
    font-size: 13px;
  }
}
</style>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contacts_list.php ---



--- Start of contact_form.php ---

<?php
$schema = require __DIR__ . '/contact_schema.php';
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>

<div class="page-header">
  <h1>Add New Contact</h1>
  <div class="page-actions">
    <a href="contacts_list.php" class="btn btn-outline">Back to Contacts</a>
  </div>
</div>

<?php if (isset($_GET['status']) && $_GET['status'] === 'success'): ?>
  <div class="alert alert-success">‚úì Contact saved successfully.</div>
<?php endif; ?>

<div class="card">
  <div class="card-header">
    <h3>Contact Information</h3>
  </div>
  <div class="card-body">
    <form id="contact-form" action="add_contact.php" method="POST" class="modern-form">
      <?php renderCSRFInput(); ?>
      
      <div class="form-grid">
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'id') continue; ?>
          <div class="form-group">
            <label for="<?= e($field) ?>"><?= e(ucwords(str_replace('_', ' ', $field))) ?>:</label>
            <input type="<?= $field === 'email' ? 'email' : ($field === 'phone' ? 'tel' : 'text') ?>"
                   name="<?= e($field) ?>" id="<?= e($field) ?>" class="form-control"
                   <?= $field === 'company' ? 'required' : '' ?>>
          </div>
        <?php endforeach; ?>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Contact</button>
        <a href="contacts_list.php" class="btn btn-outline">Cancel</a>
      </div>
    </form>
  </div>
</div>

<style>
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-start;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}
</style>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_form.php ---



--- Start of contact_schema.php ---

<?php
return [
    'id',
    'first_name',
    'last_name',
    'company',
    'email',
    'phone',
    'address',
    'city',
    'province',
    'postal_code',
    'country',
    'notes',
    'created_at',
    'last_modified',
    'is_customer',
    'tank_number',
    'delivery_date',
    'tags'
];
?>

--- End of contact_schema.php ---



--- Start of contact_success.php ---

<?php
require_once __DIR__ . '/simple_auth/middleware.php';
$currentPage = basename(__FILE__); // Dynamically sets active tab
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Saved</title>
  <link rel="stylesheet" href="styles.css"> <!-- Optional external CSS -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .navbar { background: #333; padding: 10px 20px; }
    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; }
    .nav-list li { margin-right: 20px; }
    .nav-list a { color: #fff; text-decoration: none; }
    .nav-list .active a { font-weight: bold; text-decoration: underline; }
    .container { max-width: 600px; margin: 60px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
    .btn { display: inline-block; margin-top: 20px; padding: 10px 20px; background: #0077cc; color: #fff; text-decoration: none; border-radius: 4px; }
    .btn:hover { background: #005fa3; }
  </style>
</head>
<body>

<nav class="navbar">
  <ul class="nav-list">
    <li class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
      <a href="dashboard.php">Dashboard</a>
    </li>
    <li class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
      <a href="contact_form.php">Add Contact</a>
    </li>
    <li class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
      <a href="contacts_list.php">View Contacts</a>
    </li>
    <li class="<?= $currentPage === 'add_opportunity.php' ? 'active' : '' ?>">
      <a href="add_opportunity.php">Add Opportunity</a>
    </li>
    <li class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
      <a href="opportunities_list.php">View Opportunities</a>
    </li>
    <li class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
      <a href="import_contacts.php">Import Contacts</a>
    </li>
    <li class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
      <a href="export_contacts.php">Export Contacts</a>
    </li>
  </ul>
</nav>

<div class="container">
  <h2>‚úÖ Contact Saved Successfully</h2>
  <p>Your new contact has been added to the system and logged for audit.</p>
  <a href="dashboard.php" class="btn">Return to Dashboard</a>
</div>

</body>
</html>


--- End of contact_success.php ---



--- Start of contact_validator.php ---

<?php
require_once 'contact_schema.php';
require_once 'sanitize_helper.php';
require_once 'csv_handler.php';

/**
 * Field length limits for data validation
 */
$FIELD_LIMITS = [
    'first_name' => 50,
    'last_name' => 50,
    'company' => 100,
    'email' => 254,
    'phone' => 20,
    'address_1' => 100,
    'address_2' => 100,
    'city' => 50,
    'province' => 50,
    'postal_code' => 10,
    'country' => 50,
    'notes' => 1000,
    'tank_number' => 50,
];

/**
 * Required fields for a valid contact
 */
$REQUIRED_FIELDS = ['company', 'first_name', 'last_name'];

/**
 * ‚úÖ ENHANCED: Validate contact data with comprehensive checks
 */
function validateContact(array $contact): array {
    global $FIELD_LIMITS, $REQUIRED_FIELDS;
    
    $schema = require __DIR__ . '/contact_schema.php';
    $errors = [];

    foreach ($schema as $field) {
        $value = isset($contact[$field]) ? trim($contact[$field]) : '';

        // 1. Required field check
        if (in_array($field, $REQUIRED_FIELDS)) {
            if (empty($value)) {
                $fieldLabel = ucfirst(str_replace('_', ' ', $field));
                $errors[$field] = "$fieldLabel is required.";
                continue;  // Skip further validation for this field
            }
        }

        // Skip validation on empty optional fields
        if (empty($value)) {
            continue;
        }

        // 2. ‚úÖ Length validation (ENHANCED)
        if (isset($FIELD_LIMITS[$field])) {
            if (strlen($value) > $FIELD_LIMITS[$field]) {
                $fieldLabel = ucfirst(str_replace('_', ' ', $field));
                $errors[$field] = "$fieldLabel cannot exceed {$FIELD_LIMITS[$field]} characters "
                                 . "(you have " . strlen($value) . ").";
            }
        }

        // 3. ‚úÖ Format validation (ENHANCED)
        switch ($field) {
            case 'email':
                // Validate email format AND check for common mistakes
                if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[$field] = "Invalid email address format.";
                }
                // Check for common typos
                else if (preg_match('/@(.+)\.c($|[^o])/', $value)) {
                    $errors[$field] = "Email domain appears invalid. Did you mean .com, .ca, etc?";
                }
                break;

            case 'phone':
                // Allow formats: +1-555-123-4567, 555.123.4567, (555) 123-4567, 5551234567, etc.
                if (!preg_match('/^[\d\s\-\+\(\)\.]{7,20}$/', $value)) {
                    $errors[$field] = "Invalid phone number format. Use digits, spaces, and dashes.";
                }
                break;

            case 'postal_code':
                // Allow Canadian (K1A 0B1) or US (12345) formats
                if (!preg_match('/^[A-Z0-9\s\-]{3,10}$/i', $value)) {
                    $errors[$field] = "Invalid postal code format.";
                }
                break;

            case 'country':
                // Allow alphanumeric countries - no special validation needed for now
                if (preg_match('/[<>"\']/', $value)) {
                    $errors[$field] = "Country name contains invalid characters.";
                }
                break;

            case 'website':
                if ($value && !filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[$field] = "Invalid website URL. Must start with http:// or https://";
                }
                break;
        }
    }

    return $errors;
}

/**
 * ‚úÖ ENHANCED: Sanitize contact data before storage
 * Removes dangerous content and normalizes data
 */
function sanitizeContact(array $contact): array {
    $schema = require __DIR__ . '/contact_schema.php';
    $sanitized = [];

    foreach ($schema as $field) {
        $value = isset($contact[$field]) ? $contact[$field] : '';
        
        // Convert to string if not already
        $value = (string)$value;
        
        // 1. Trim whitespace
        $value = trim($value);
        
        // 2. Remove null bytes (security risk)
        $value = str_replace("\0", '', $value);
        
        // 3. Normalize line endings
        $value = str_replace(["\r\n", "\r"], "\n", $value);
        
        // 4. For most fields, remove HTML tags
        if ($field !== 'notes') {
            $value = strip_tags($value);
        }
        
        // 5. For notes, allow some safe HTML but remove dangerous tags
        if ($field === 'notes') {
            // Remove script tags and event handlers
            $value = preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi', '', $value);
            $value = preg_replace('/on[a-z]+\s*=\s*["\']?[^"\'>\s]+["\']?/gi', '', $value);
        }
        
        // 6. For email, normalize to lowercase
        if ($field === 'email') {
            $value = strtolower($value);
        }
        
        // 7. For phone, normalize spacing/dashes
        if ($field === 'phone') {
            // Keep only digits, spaces, dashes, plus, parens, dots
            $value = preg_replace('/[^0-9\s\-\+\(\)\.]/', '', $value);
        }
        
        $sanitized[$field] = $value;
    }

    return $sanitized;
}

/**
 * ‚úÖ NEW: Validate email uniqueness (for duplicate detection)
 */
function isEmailUnique($email, $excludeId = null): bool {
    if (empty($email)) {
        return true;  // Empty email is not a duplicate
    }
    
    $contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
    $email = strtolower(trim($email));
    
    foreach ($contacts as $contact) {
        $contactEmail = strtolower(trim($contact['email'] ?? ''));
        
        // Skip the contact we're updating (by ID)
        if ($excludeId && isset($contact['id']) && $contact['id'] === $excludeId) {
            continue;
        }
        
        if ($contactEmail === $email && !empty($email)) {
            return false;  // Email already exists
        }
    }
    
    return true;  // Email is unique
}

/**
 * ‚úÖ NEW: Comprehensive validation with error details
 */
function validateAndSanitizeContact(array $contact): array {
    // First, sanitize the input
    $contact = sanitizeContact($contact);
    
    // Then validate
    $errors = validateContact($contact);
    
    return [
        'contact' => $contact,
        'errors' => $errors,
        'isValid' => empty($errors),
    ];
}

?>


--- End of contact_validator.php ---



--- Start of contact_view.php ---

<?php
// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Page metadata
$pageTitle = 'Contact Details';

// Include layout and dependencies
require_once('layout_start.php');
require_once 'csv_handler.php';

// Load schemas and data
$schema = require 'contact_schema.php';
$customerSchema = require 'customer_schema.php';
$contacts = readCSV('contacts.csv', $schema);
$customers = readCSV('customers.csv', $customerSchema);

// Load opportunities
$opportunitySchema = ['id', 'contact_id', 'value', 'stage', 'probability', 'expected_close'];
$opportunities = readCSV('opportunities.csv', $opportunitySchema) ?: [];

// Load discussion logs
$discussionSchema = require 'discussion_schema.php';
$discussions = readCSV('discussion_log.csv', $discussionSchema) ?: [];

// Filter discussions for this contact
$contactDiscussions = array_filter($discussions, function($d) use ($contactId) {
    return ($d['contact_id'] ?? '') === $contactId;
});

// Sort discussions by timestamp (newest first)
usort($contactDiscussions, function($a, $b) {
    return strtotime($b['timestamp'] ?? '0') - strtotime($a['timestamp'] ?? '0');
});

// Safety: verify data was loaded
if (!is_array($contacts) || !is_array($customers)) {
    die('Error: Could not load contact or customer data.');
}

// Index contacts by ID for faster lookup
$contactsById = [];
$saveSuccess = false;

foreach ($contacts as $c) {
    if (empty($c['id'])) {
        $c['id'] = 'CNT_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
    }
    $contactsById[$c['id']] = $c;
}

// Helper: resolve customer by ID
function findCustomerById($customers, $cid) {
    foreach ($customers as $c) {
        if ($c['customer_id'] === $cid) return $c;
    }
    return null;
}

// Helper: Get initials for avatar
function getInitials($firstName, $lastName) {
    $f = strtoupper(substr($firstName ?? '', 0, 1));
    $l = strtoupper(substr($lastName ?? '', 0, 1));
    return $f . $l;
}

// Helper: Parse tags from CSV
function parseTags($tagString) {
    if (empty($tagString)) return [];
    return array_filter(array_map('trim', explode(',', $tagString)));
}

// Helper: Get contact's opportunities
function getContactOpportunities($contact, $opportunities) {
    return array_filter($opportunities, function($opp) use ($contact) {
        return ($opp['contact_id'] ?? '') === ($contact['id'] ?? '');
    });
}

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Safety: ensure we still have contacts loaded
    if (empty($contactsById)) {
        die('Error: Contact data is empty. Cannot save changes.');
    }

    // Update contact details
    if (isset($_POST['id']) && isset($contactsById[$_POST['id']])) {
        $id = $_POST['id'];
        $originalContact = $contactsById[$id];
        
        // Update each field
        foreach ($schema as $f) {
            $postValue = isset($_POST[$f]) ? trim($_POST[$f]) : '';
            $originalValue = $originalContact[$f] ?? '';
            
            // Use POST value if provided, otherwise keep original
            $contactsById[$id][$f] = !empty($postValue) ? $postValue : $originalValue;
        }
        
        if (isset($_POST['is_customer'])) {
            $contactsById[$id]['is_customer'] = $_POST['is_customer'];
        }
        
        // Update modified timestamp
        $contactsById[$id]['last_modified'] = date('Y-m-d H:i:s');
        
        // Verify we still have data before writing
        if (empty($contactsById[$id]['id'])) {
            die('Error: Required fields are missing. Changes not saved.');
        }
        
        writeCSV('contacts.csv', array_values($contactsById), $schema);
        
        // Verify the save was successful by reading back the file
        $verifyContacts = readCSV('contacts.csv', $schema);
        $verifySaved = array_filter($verifyContacts, fn($c) => ($c['id'] ?? '') === $id);
        if (empty($verifySaved)) {
            die('Error: Data was not saved properly.');
        }
        
        // Reload contact data and show success
        $contacts = $verifyContacts;
        $contactsById = [];
        foreach ($contacts as $c) {
            $contactsById[$c['id']] = $c;
        }
        $contact = $contactsById[$id];
        $saveSuccess = true;
    }
}

// Get contact from URL parameter
$contactId = isset($_GET['id']) ? htmlspecialchars($_GET['id']) : (isset($_POST['id']) ? htmlspecialchars($_POST['id']) : null);
if (!$contactId || !isset($contactsById[$contactId])) {
    die('Error: Invalid contact ID.');
}

$contact = $contactsById[$contactId];
$customer = findCustomerById($customers, $contact['customer_id'] ?? '');

// Get contact status
$isCustomer = ($contact['is_customer'] ?? '') === 'yes';
$status = $isCustomer ? 'Client' : 'Contact';
$statusColor = $isCustomer ? '#28a745' : '#ffc107';

// Calculate metrics
$createdAt = $contact['created_at'] ?? 'Unknown';
$lastModified = $contact['last_modified'] ?? $contact['created_at'] ?? 'Unknown';
$contactOpportunities = getContactOpportunities($contact, $opportunities);
$opportunityValue = array_reduce($contactOpportunities, function($sum, $opp) {
    return $sum + ((float)($opp['value'] ?? 0));
}, 0);

// Get initials and color coding
$initials = getInitials($contact['first_name'] ?? '', $contact['last_name'] ?? '');
$colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
$colorIndex = hexdec(substr($contact['id'] ?? '', 0, 2)) % count($colors);
$avatarColor = $colors[$colorIndex];

// Parse tags
$tags = parseTags($contact['tags'] ?? '');
?>

<style>
  * { box-sizing: border-box; }
  
  /* Override content-container padding for this page */
  .content-container { padding: 0 !important; }
  
  .contact-header { max-width: 100% !important; margin: 0 !important; padding: 0 32px !important; width: 100% !important; }
  .contact-banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 8px; display: flex; align-items: start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
  .contact-avatar { width: 70px; height: 70px; border-radius: 50%; background: <?= $avatarColor ?>; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; flex-shrink: 0; border: 3px solid white; }
  .contact-header-info { flex: 1; min-width: 250px; }
  .contact-header-info h1 { margin: 0 0 8px 0; font-size: 26px; font-weight: 600; }
  .contact-header-info p { margin: 4px 0; font-size: 13px; opacity: 0.9; }
  .contact-header-info a { color: white; text-decoration: none; }
  .contact-status { display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 11px; font-weight: 600; margin-top: 8px; }
  .quick-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
  .quick-actions button { background: white; color: #333; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s; }
  .quick-actions button:hover { background: #f0f0f0; }
  .quick-actions button:active { transform: scale(0.98); }
  .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #3B82F6; font-size: 13px; }
  .stat-label { color: #999; text-transform: uppercase; font-weight: 600; font-size: 10px; }
  .stat-value { font-size: 15px; font-weight: 600; color: #1a1a1a; margin-top: 4px; }
  
  /* Accordion Styles */
  .accordion { margin-bottom: 16px; }
  .accordion-header { background: white; padding: 18px 24px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e5e7eb; transition: all 0.3s; user-select: none; }
  .accordion-header:hover { border-color: #3B82F6; background: #f9fafb; }
  .accordion-header.active { border-color: #3B82F6; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); }
  .accordion-title { font-size: 16px; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 12px; }
  .accordion-icon { font-size: 18px; color: #6b7280; transition: transform 0.3s; }
  .accordion-header.active .accordion-icon { transform: rotate(90deg); color: #3B82F6; }
  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
  .accordion-content.active { max-height: 5000px; transition: max-height 0.6s ease-in; }
  .accordion-body { background: white; padding: 24px; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; margin-top: -8px; }
  .section { margin-bottom: 25px; }
  .section:last-child { margin-bottom: 0; }
  .section-title { font-size: 12px; font-weight: 700; color: #1a1a1a; text-transform: uppercase; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0; }
  .field-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
  .field { }
  .field-label { font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; margin-bottom: 3px; }
  .field-value { font-size: 13px; color: #1a1a1a; word-break: break-word; line-height: 1.4; }
  .field-value.empty { color: #ccc; font-style: italic; }
  .opportunity { background: #f8f9fa; padding: 12px; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid #10B981; }
  .opportunity-title { font-weight: 600; color: #1a1a1a; font-size: 13px; }
  .opportunity-details { font-size: 12px; color: #666; margin-top: 4px; }
  .opportunity-value { font-weight: 600; color: #28a745; font-size: 14px; margin-top: 6px; }
  .timeline-item { padding: 12px 0; border-bottom: 1px solid #e0e0e0; display: flex; gap: 12px; }
  .timeline-item:last-child { border-bottom: none; }
  .timeline-icon { font-size: 16px; flex-shrink: 0; width: 20px; text-align: center; }
  .timeline-content { flex: 1; }
  .timeline-title { font-weight: 600; color: #1a1a1a; font-size: 13px; }
  .timeline-time { font-size: 11px; color: #999; margin-top: 2px; }
  .tags-container { display: flex; flex-wrap: wrap; gap: 6px; }
  .tag { background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
  .tag-new { background: #f0f0f0; color: #666; border: 1px dashed #999; padding: 4px 8px; border-radius: 12px; font-size: 11px; cursor: pointer; }
  .tag-remove { cursor: pointer; }
  .form-section { width: 100%; margin-bottom: 28px; background: #f9fafb; padding: 28px; border-radius: 10px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .form-section h3 { font-size: 15px; font-weight: 700; margin: -28px -28px 20px -28px; padding: 16px 28px; background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%); border-bottom: 2px solid #e5e7eb; border-radius: 8px 8px 0 0; color: #1f2937; }
  .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; width: 100%; }
  .form-group { display: flex; flex-direction: column; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 12px; color: #111827; text-transform: uppercase; letter-spacing: 0.6px; }
  .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 18px 16px; border: 1.5px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 15px; transition: all 0.2s; background: white; line-height: 1.6; min-height: 60px; box-sizing: border-box; text-align: left; }
  .form-group input::placeholder, .form-group textarea::placeholder { color: #9ca3af; }
  .form-group textarea { resize: none; min-height: 150px; padding: 20px; overflow-y: auto; }
  .form-group input:hover, .form-group textarea:hover, .form-group select:hover { border-color: #9ca3af; }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3B82F6; background: #eff6ff; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
  .form-group input:disabled, .form-group textarea:disabled, .form-group select:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
  .activity-item { padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 12px; }
  .activity-item:last-child { border-bottom: none; }
  .activity-time { color: #999; font-size: 10px; }
  .activity-text { color: #333; margin-top: 3px; }
  .submit-actions { display: flex; gap: 12px; margin-top: 28px; flex-wrap: wrap; }
  .submit-actions button, .submit-actions a { padding: 14px 32px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; text-decoration: none; display: inline-block; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .btn-primary { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); color: white; }
  .btn-primary:hover { background: linear-gradient(135deg, #2563EB 0%, #1d4ed8 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transform: translateY(-2px); }
  .btn-primary:active { transform: translateY(0); }
  .btn-secondary { background: #f3f4f6; color: #374151; border: 1.5px solid #d1d5db; }
  .btn-secondary:hover { background: #e5e7eb; }
  .btn-secondary:active { background: #d1d5db; }
  .success-alert { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 4px; margin-bottom: 15px; }

  /* Mobile Responsiveness */
  @media (max-width: 900px) {
    .contact-banner { flex-direction: column; }
    .contact-avatar { width: 60px; height: 60px; font-size: 20px; }
    .contact-banner h1 { font-size: 22px; }
    .field-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: repeat(2, 1fr); }
    .stats-bar { grid-template-columns: repeat(2, 1fr); }
    .quick-actions { gap: 6px; }
    .quick-actions button { padding: 5px 10px; font-size: 11px; }
    .accordion-header { padding: 14px 18px; }
    .accordion-title { font-size: 14px; }
  }

  @media (max-width: 600px) {
    .contact-header { padding: 0 16px !important; }
    .contact-banner { padding: 15px; gap: 12px; }
    .contact-avatar { width: 50px; height: 50px; font-size: 18px; }
    .contact-banner h1 { font-size: 18px; }
    .stats-bar { grid-template-columns: 1fr; gap: 8px; }
    .stat-card { padding: 10px; }
    .form-grid { grid-template-columns: 1fr; }
    .accordion-header { padding: 12px 16px; }
    .accordion-title { font-size: 13px; }
    .accordion-body { padding: 16px; }
    .form-section { padding: 20px; }
    .submit-actions { gap: 6px; }
    .submit-actions button, .submit-actions a { padding: 8px 12px; font-size: 12px; }
  }
  /* Auto-expand textareas */
  .auto-expand-textarea {
    overflow: hidden;
    resize: none;
  }
</style>

<div class="contact-header">
  <div style="margin-bottom: 15px; font-size: 13px;">
    <a href="contacts_list.php" style="color: #3B82F6; text-decoration: none; font-weight: 600;">‚Üê Back to Contacts</a>
  </div>

  <!-- Contact Banner -->
  <div class="contact-banner">
    <div class="contact-avatar"><?= $initials ?></div>
    <div class="contact-header-info">
      <h1><?= htmlspecialchars(trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? ''))) ?: 'Unknown Contact' ?></h1>
      <p><?= htmlspecialchars($contact['company'] ?? 'Company not assigned') ?></p>
      <?php if ($contact['phone']): ?>
        <p>‚òé <?= htmlspecialchars($contact['phone']) ?></p>
      <?php endif; ?>
      <?php if ($contact['email']): ?>
        <p><a href="mailto:<?= htmlspecialchars($contact['email']) ?>">‚úâ <?= htmlspecialchars($contact['email']) ?></a></p>
      <?php endif; ?>
      <span class="contact-status" style="background-color: <?= $statusColor ?>;">‚úì <?= $status ?></span>
      <div class="quick-actions">
        <button onclick="alert('Email: <?= htmlspecialchars($contact['email'] ?? 'no email') ?>')">‚úâ Email</button>
        <button onclick="alert('Call: <?= htmlspecialchars($contact['phone'] ?? 'no phone') ?>')">‚òé Call</button>
        <button onclick="alert('Add task for <?= htmlspecialchars($contact['first_name'] ?? 'Contact') ?>')">+ Task</button>
        <button onclick="alert('Create opportunity for <?= htmlspecialchars($contact['company'] ?? 'this contact') ?>')">üíº Opp</button>
      </div>
    </div>
  </div>

  <?php if ($saveSuccess): ?>
    <div class="success-alert">‚úì Changes saved successfully.</div>
  <?php endif; ?>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-label">Status</div>
      <div class="stat-value"><?= $status ?></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Created</div>
      <div class="stat-value"><?= substr($createdAt, 0, 10) ?></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Opportunities</div>
      <div class="stat-value"><?= count($contactOpportunities) ?></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Value</div>
      <div class="stat-value"><?= $opportunityValue > 0 ? formatCurrency($opportunityValue) : '‚Äî' ?></div>
    </div>
  </div>

  <!-- ACCORDION SECTIONS -->
  
  <!-- Overview Section -->
  <div class="accordion">
    <div class="accordion-header active" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>üìã</span>
        <span>Overview</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content active">
      <div class="accordion-body">
        <div class="section">
          <div class="section-title">üìç Location & Contact</div>
          <div class="field-grid">
            <div class="field">
              <div class="field-label">Email</div>
              <div class="field-value <?= empty($contact['email']) ? 'empty' : '' ?>">
                <?= $contact['email'] ? '<a href="mailto:' . htmlspecialchars($contact['email']) . '" style="color:#3B82F6;">' . htmlspecialchars($contact['email']) . '</a>' : '‚Äî' ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Phone</div>
              <div class="field-value <?= empty($contact['phone']) ? 'empty' : '' ?>">
                <?= $contact['phone'] ? '<a href="tel:' . htmlspecialchars($contact['phone']) . '" style="color:#3B82F6;">' . htmlspecialchars($contact['phone']) . '</a>' : '‚Äî' ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">City</div>
              <div class="field-value <?= empty($contact['city']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['city'] ?? '‚Äî') ?></div>
            </div>
            <div class="field">
              <div class="field-label">Province</div>
              <div class="field-value <?= empty($contact['province']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['province'] ?? '‚Äî') ?></div>
            </div>
            <div class="field">
              <div class="field-label">Postal Code</div>
              <div class="field-value <?= empty($contact['postal_code']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['postal_code'] ?? '‚Äî') ?></div>
            </div>
            <div class="field">
              <div class="field-label">Country</div>
              <div class="field-value <?= empty($contact['country']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['country'] ?? '‚Äî') ?></div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">üîñ Tags</div>
          <div class="tags-container">
            <?php foreach ($tags as $tag): ?>
              <span class="tag"><?= htmlspecialchars($tag) ?></span>
            <?php endforeach; ?>
            <?php if (empty($tags)): ?>
              <p style="font-size: 12px; color: #999; margin: 0;">No tags</p>
            <?php endif; ?>
          </div>
        </div>

        <div class="section">
          <div class="section-title">üìä Quick Stats</div>
          <div class="field-grid">
            <div class="field">
              <div class="field-label">Total Value</div>
              <div class="field-value" style="color: #28a745; font-weight: 600; font-size: 16px;">
                <?= formatCurrency($opportunityValue) ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Open Opportunities</div>
              <div class="field-value" style="color: #3B82F6; font-weight: 600; font-size: 16px;">
                <?= count($contactOpportunities) ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Discussions</div>
              <div class="field-value" style="color: #8B5CF6; font-weight: 600; font-size: 16px;">
                <?= count($contactDiscussions) ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Member Since</div>
              <div class="field-value" style="color: #666; font-size: 13px;">
                <?= date('M d, Y', strtotime($createdAt)) ?>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">üìù Notes</div>
          <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 13px; line-height: 1.5;">
            <?= $contact['notes'] ? htmlspecialchars($contact['notes']) : '<span style="color: #ccc;">No notes</span>' ?>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Details Section -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>‚úèÔ∏è</span>
        <span>Edit Contact Details</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content">
      <div class="accordion-body">
        <form method="post">
          <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

          <!-- Quick Status Section -->
          <div class="form-section" style="background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 1px solid #bfdbfe; padding: 14px; margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 12px;">
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üìÖ Created</div>
                <div style="color: #666;"><?= date('M d, Y', strtotime($createdAt)) ?></div>
              </div>
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üîÑ Last Modified</div>
                <div style="color: #666;"><?= $lastModified ? date('M d, Y', strtotime($lastModified)) : '‚Äî' ?></div>
              </div>
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üíº Opportunities</div>
                <div style="color: #666;"><?= count($contactOpportunities) ?> active</div>
              </div>
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üí¨ Discussions</div>
                <div style="color: #666;"><?= count($contactDiscussions) ?> logged</div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üë§ Personal Information</h3>
            <div class="form-grid">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" name="first_name" value="<?= htmlspecialchars($contact['first_name'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" name="last_name" value="<?= htmlspecialchars($contact['last_name'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" value="<?= htmlspecialchars($contact['email'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" name="phone" value="<?= htmlspecialchars($contact['phone'] ?? '') ?>">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üè¢ Company Information</h3>
            <div class="form-grid">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Company</label>
                <input type="text" name="company" value="<?= htmlspecialchars($contact['company'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Tank Number</label>
                <input type="text" name="tank_number" value="<?= htmlspecialchars($contact['tank_number'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Delivery Date</label>
                <input type="text" name="delivery_date" placeholder="YYYY-MM-DD" value="<?= htmlspecialchars($contact['delivery_date'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Status</label>
                <select name="status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                  <option value=""></option>
                  <option value="Active" <?= ($contact['status'] ?? '') === 'Active' ? 'selected' : '' ?>>Active</option>
                  <option value="Inactive" <?= ($contact['status'] ?? '') === 'Inactive' ? 'selected' : '' ?>>Inactive</option>
                  <option value="Prospect" <?= ($contact['status'] ?? '') === 'Prospect' ? 'selected' : '' ?>>Prospect</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üìç Address</h3>
            <div class="form-group" style="margin-bottom: 12px;">
              <label>Address</label>
              <input type="text" name="address" value="<?= htmlspecialchars($contact['address'] ?? '') ?>">
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>City</label>
                <input type="text" name="city" value="<?= htmlspecialchars($contact['city'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Province/State</label>
                <input type="text" name="province" value="<?= htmlspecialchars($contact['province'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Postal Code</label>
                <input type="text" name="postal_code" value="<?= htmlspecialchars($contact['postal_code'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Country</label>
                <input type="text" name="country" value="<?= htmlspecialchars($contact['country'] ?? '') ?>">
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%;">
            <div class="form-section">
              <h3>üîñ Tags</h3>
              <div class="tags-container" style="margin-bottom: 10px;">
                <?php foreach ($tags as $tag): ?>
                  <span class="tag"><?= htmlspecialchars($tag) ?> <span class="tag-remove" onclick="removeTag(this)">‚úï</span></span>
                <?php endforeach; ?>
                <span class="tag-new" onclick="addNewTag(this)">+ Add tag</span>
              </div>
              <input type="hidden" name="tags" id="tags_input" value="<?= htmlspecialchars($contact['tags'] ?? '') ?>">
            </div>

            <div class="form-section">
              <h3>‚≠ê Customer Status</h3>
              <div style="padding: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                  <input type="checkbox" name="is_customer" value="1" <?= ($isCustomer ? 'checked' : '') ?> style="width: 16px; height: 16px; cursor: pointer;">
                  <span>Is an Active Customer</span>
                </label>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üìù Notes</h3>
            <div class="form-group">
              <label>Additional Notes</label>
              <textarea name="notes" rows="5"><?= htmlspecialchars($contact['notes'] ?? '') ?></textarea>
            </div>
          </div>

          <div class="submit-actions">
            <button type="submit" class="btn-primary">üíæ Save Changes</button>
            <a href="contacts_list.php" class="btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Opportunities Section -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>üíº</span>
        <span>Opportunities (<?= count($contactOpportunities) ?>)</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content">
      <div class="accordion-body">
        <div class="section">
          <div class="section-title">üíº Linked Opportunities</div>
          <?php if (!empty($contactOpportunities)): ?>
            <?php foreach ($contactOpportunities as $opp): ?>
              <div class="opportunity">
                <div class="opportunity-title">Opportunity #<?= htmlspecialchars($opp['id']) ?></div>
                <div class="opportunity-details">
                  <strong>Stage:</strong> <?= htmlspecialchars($opp['stage'] ?? '‚Äî') ?> 
                  (<?= htmlspecialchars($opp['probability'] ?? '0') ?>%)
                </div>
                <div class="opportunity-details" style="margin-top: 4px;">
                  <strong>Expected Close:</strong> <?= htmlspecialchars($opp['expected_close'] ?? '‚Äî') ?>
                </div>
                <div class="opportunity-value">
                  <?= formatCurrency($opp['value'] ?? 0) ?>
                </div>
              </div>
            <?php endforeach; ?>
            <div style="padding: 10px; background: #f0f7ff; border-radius: 4px; margin-top: 12px; font-size: 12px; color: #666;">
              <strong style="color: #1976d2;">Total Opportunity Value:</strong> <?= formatCurrency($opportunityValue) ?>
            </div>
          <?php else: ?>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 4px; color: #999; text-align: center; font-size: 13px;">
              No opportunities linked to this contact yet.
            </div>
          <?php endif; ?>
        </div>
      </div>
    </div>
  </div>

  <!-- Discussions Section -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>üí¨</span>
        <span>Discussions (<?= count($contactDiscussions) ?>)</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content">
      <div class="accordion-body">
        <!-- Add Discussion Form -->
        <div class="section">
          <div class="section-title">‚ûï Log Discussion</div>
          <form method="post" action="discussion_logger.php" style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
            <input type="hidden" name="contact_id" value="<?= htmlspecialchars($contact['id']) ?>">
            
            <div class="form-group" style="margin-bottom: 12px;">
              <label>Author</label>
              <input type="text" name="author" placeholder="Your name" value="<?= isset($_SESSION['username']) ? htmlspecialchars($_SESSION['username']) : '' ?>" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
              <label>Discussion Notes</label>
              <textarea name="entry_text" placeholder="What was discussed?" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-family: inherit; font-size: 13px;" rows="4"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
              <label>Visibility</label>
              <select name="visibility" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-family: inherit; font-size: 13px;">
                <option value="public">Public (Visible to all)</option>
                <option value="internal">Internal (Team only)</option>
                <option value="private">Private (Only me)</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>Linked Opportunity (Optional)</label>
              <select name="linked_opportunity_id" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-family: inherit; font-size: 13px;">
                <option value="">‚Äî No opportunity</option>
                <?php foreach ($contactOpportunities as $opp): ?>
                  <option value="<?= htmlspecialchars($opp['id']) ?>">Opportunity #<?= htmlspecialchars($opp['id']) ?> (<?= htmlspecialchars($opp['stage']) ?>)</option>
                <?php endforeach; ?>
              </select>
            </div>

            <button type="submit" style="margin-top: 12px; background: #3B82F6; color: white; border: none; padding: 10px 18px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">üí¨ Log Discussion</button>
          </form>
        </div>

        <!-- Discussion History -->
        <div class="section">
          <div class="section-title">üìù Discussion History</div>
          <?php if (!empty($contactDiscussions)): ?>
            <?php foreach ($contactDiscussions as $disc): ?>
              <div class="timeline-item" style="padding: 15px; margin-bottom: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3B82F6;">
                <div style="width: 100%;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <strong style="color: #1a1a1a; font-size: 14px;"><?= htmlspecialchars($disc['author'] ?? 'Unknown') ?></strong>
                    <span style="background: <?= ($disc['visibility'] ?? 'public') === 'public' ? '#e3f2fd' : (($disc['visibility'] ?? '') === 'internal' ? '#fff3cd' : '#f8d7da') ?>; color: <?= ($disc['visibility'] ?? 'public') === 'public' ? '#1976d2' : (($disc['visibility'] ?? '') === 'internal' ? '#856404' : '#721c24') ?>; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase;">
                      <?= htmlspecialchars($disc['visibility'] ?? 'public') ?>
                    </span>
                  </div>
                  <div style="color: #666; font-size: 11px; margin-bottom: 8px;">
                    üìÖ <?= htmlspecialchars($disc['timestamp'] ?? '‚Äî') ?>
                  </div>
                  <div style="color: #1a1a1a; font-size: 13px; line-height: 1.5; margin-bottom: 6px;">
                    <?= nl2br(htmlspecialchars($disc['entry_text'] ?? '')) ?>
                  </div>
                  <?php if (!empty($disc['linked_opportunity_id'])): ?>
                    <div style="margin-top: 8px; padding: 8px; background: white; border-left: 3px solid #10B981; border-radius: 3px; font-size: 11px; color: #666;">
                      <strong>üìé Linked to Opportunity #<?= htmlspecialchars($disc['linked_opportunity_id']) ?></strong>
                    </div>
                  <?php endif; ?>
                </div>
              </div>
            <?php endforeach; ?>
          <?php else: ?>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 4px; color: #999; text-align: center; font-size: 13px;">
              No discussions logged yet. Start by adding the first discussion above.
            </div>
          <?php endif; ?>
        </div>
      </div>
    </div>
</div>

<script>
  // Accordion toggle function
  function toggleAccordion(header) {
    const content = header.nextElementSibling;
    
    // Toggle current accordion
    header.classList.toggle('active');
    content.classList.toggle('active');
  }

  // Tag management
  function addNewTag(element) {
    const tagName = prompt('Enter tag name:');
    if (tagName && tagName.trim()) {
      const tagsInput = document.getElementById('tags_input');
      const currentTags = tagsInput.value ? tagsInput.value.split(',').map(t => t.trim()) : [];
      currentTags.push(tagName.trim());
      tagsInput.value = currentTags.join(',');
      location.reload();
    }
  }

  function removeTag(element) {
    const tagsInput = document.getElementById('tags_input');
    const tagName = element.previousSibling.textContent.trim();
    const currentTags = tagsInput.value.split(',').map(t => t.trim());
    const filtered = currentTags.filter(t => t !== tagName);
    tagsInput.value = filtered.join(',');
    location.reload();
  }

  // Auto-expand textareas based on content
  const textareas = document.querySelectorAll('.form-group textarea');
  textareas.forEach(textarea => {
    function adjustHeight() {
      textarea.style.height = 'auto';
      textarea.style.height = Math.max(150, textarea.scrollHeight) + 'px';
    }
    
    textarea.addEventListener('input', adjustHeight);
    textarea.addEventListener('change', adjustHeight);
    adjustHeight(); // Initial adjustment
  });

  // Auto-adjust input widths based on content
  const inputs = document.querySelectorAll('.form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"], .form-group input[type="number"]');
  inputs.forEach(input => {
    function adjustWidth() {
      const length = input.value.length;
      const charWidth = 9;
      const minWidth = 280;
      input.style.minWidth = Math.max(minWidth, length * charWidth + 60) + 'px';
    }
    
    input.addEventListener('input', adjustWidth);
    input.addEventListener('change', adjustWidth);
    adjustWidth(); // Initial adjustment
  });
</script>

<?php include_once('layout_end.php'); ?>


--- End of contact_view.php ---



--- Start of contracts_list.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Service Contracts';
$currentPage = basename(__FILE__);

// Load data
$contractSchema = require __DIR__ . '/contract_schema.php';
$contracts = readCSV('contracts.csv', $contractSchema) ?: [];
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$customers = readCSV('customers.csv', require __DIR__ . '/customer_schema.php');

// Calculate contract metrics
$totalActive = 0;
$totalMRR = 0;
$totalARR = 0;
$expiringCount = 0;
$today = strtotime(date('Y-m-d'));
$thirtyDaysOut = strtotime('+30 days');
$ninetyDaysOut = strtotime('+90 days');

foreach ($contracts as &$contract) {
    // Calculate days until expiry
    if (!empty($contract['end_date'])) {
        $endDate = strtotime($contract['end_date']);
        $daysToExpiry = round(($endDate - $today) / 86400);
        $contract['days_to_expiry'] = $daysToExpiry;
        // Set expiry status
        if ($daysToExpiry < 0) {
            $contract['expiry_status'] = 'expired';
        } elseif ($daysToExpiry <= 30) {
            $contract['expiry_status'] = 'critical';
            $expiringCount++;
        } elseif ($daysToExpiry <= 90) {
            $contract['expiry_status'] = 'warning';
            $expiringCount++;
        } else {
            $contract['expiry_status'] = 'normal';
        }
    }
    // Calculate metrics for active contracts
    if ($contract['contract_status'] === 'Active') {
        $totalActive++;
        $totalMRR += (float)($contract['monthly_fee'] ?? 0);
        $totalARR += (float)($contract['annual_value'] ?? 0);
    }
}
?>
            $contract['expiry_status'] = 'warning';
            $expiringCount++;
        } else {
            $contract['expiry_status'] = 'normal';
        }
    }
    // Calculate metrics for active contracts
    if ($contract['contract_status'] === 'Active') {
        $totalActive++;
        $totalMRR += (float)($contract['monthly_fee'] ?? 0);
        $totalARR += (float)($contract['annual_value'] ?? 0);
    }
}
?>
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #10B981;
}

.metric-card.warning {
    border-left-color: #F59E0B;
}

.metric-card.critical {
    border-left-color: #EF4444;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    color: #1F2937;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-group select,
.filter-group input {
    padding: 10px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    border: none;
    font-size: 14px;
}

.btn-primary {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.contracts-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.contracts-table table {
    width: 100%;
    border-collapse: collapse;
}

.contracts-table th {
    background: #F9FAFB;
    padding: 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #E5E7EB;
}

.contracts-table td {
    padding: 16px;
    border-bottom: 1px solid #F3F4F6;
    font-size: 14px;
}

.contracts-table tr:hover {
    background: #F9FAFB;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-active {
    background: #D1FAE5;
    color: #065F46;
}

.status-expiring {
    background: #FEF3C7;
    color: #92400E;
}

.status-expired {
    background: #FEE2E2;
    color: #991B1B;
}

.status-cancelled {
    background: #E5E7EB;
    color: #374151;
}

.expiry-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
}

.expiry-normal {
    background: #D1FAE5;
    color: #065F46;
}

.expiry-warning {
    background: #FEF3C7;
    color: #92400E;
}

.expiry-critical {
    background: #FEE2E2;
    color: #991B1B;
}

.expiry-expired {
    background: #E5E7EB;
    color: #374151;
}

.action-btns {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}

.action-btn-view {
    background: #EFF6FF;
    color: #1E40AF;
}

.action-btn-view:hover {
    background: #DBEAFE;
}

.action-btn-edit {
    background: #FEF3C7;
    color: #92400E;
}

.action-btn-edit:hover {
    background: #FDE68A;
}

.action-btn-renew {
    background: #D1FAE5;
    color: #065F46;
}

.action-btn-renew:hover {
    background: #A7F3D0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .action-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-direction: column;
    }
}
</style>

<div class="contracts-header">
    <h1>üìã Service Contracts</h1>
    <p>Manage SDI service agreements and equipment rentals</p>
</div>

<!-- Metrics Dashboard -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Active Contracts</div>
        <div class="metric-value"><?= $totalActive ?></div>
        <div class="metric-subtext">Current active agreements</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Monthly Recurring Revenue</div>
        <div class="metric-value">$<?= number_format($totalMRR, 0) ?></div>
        <div class="metric-subtext">MRR from active contracts</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Annual Contract Value</div>
        <div class="metric-value">$<?= number_format($totalARR, 0) ?></div>
        <div class="metric-subtext">Total ARR from contracts</div>
    </div>
    
    <div class="metric-card <?= $expiringCount > 0 ? 'warning' : '' ?>">
        <div class="metric-label">Expiring Soon</div>
        <div class="metric-value"><?= $expiringCount ?></div>
        <div class="metric-subtext">Within 90 days</div>
    </div>
</div>

<!-- Action Bar -->
<div class="action-bar">
    <div class="filter-group">
        <select id="statusFilter" onchange="filterContracts()">
            <option value="">All Statuses</option>
            <option value="Active">Active</option>
            <option value="Expiring">Expiring</option>
            <option value="Expired">Expired</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        
        <select id="typeFilter" onchange="filterContracts()">
            <option value="">All Types</option>
            <option value="New">New</option>
            <option value="Renewal">Renewal</option>
            <option value="Upsell">Upsell</option>
        </select>
        
        <input type="text" id="searchInput" placeholder="Search contracts..." onkeyup="filterContracts()">
    </div>
    
    <a href="contract_form.php" class="btn btn-primary">‚ûï Add New Contract</a>
</div>

<!-- Contracts Table -->
<div class="contracts-table">
    <?php if (empty($contracts)): ?>
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>No Service Contracts Yet</h3>
            <p>Start by creating your first service contract</p>
            <a href="contract_form.php" class="btn btn-primary" style="margin-top: 20px;">‚ûï Add First Contract</a>
        </div>
    <?php else: ?>
        <table id="contractsTable">
            <thead>
                <tr>
                    <th>Contract ID</th>
                    <th>Customer/Contact</th>
                    <th>Equipment Type</th>
                    <th>Monthly Fee</th>
                    <th>Status</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Days to Expiry</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($contracts as $contract): ?>
                    <?php
                    // Find contact name
                    $contactName = 'Unknown';
                    foreach ($contacts as $c) {
                        if ($c['id'] === $contract['contact_id']) {
                            $contactName = trim($c['first_name'] . ' ' . $c['last_name']);
                            break;
                        }
                    }
                    
                    // Determine status display
                    $statusClass = 'status-' . strtolower(str_replace(' ', '-', $contract['contract_status']));
                    $expiryClass = 'expiry-' . ($contract['expiry_status'] ?? 'normal');
                    ?>
                    <tr data-status="<?= htmlspecialchars($contract['contract_status']) ?>" 
                        data-type="<?= htmlspecialchars($contract['contract_type']) ?>">
                        <td><strong><?= htmlspecialchars($contract['contract_id']) ?></strong></td>
                        <td><?= htmlspecialchars($contactName) ?></td>
                        <td><?= htmlspecialchars($contract['equipment_type']) ?></td>
                        <td><strong>$<?= number_format((float)$contract['monthly_fee'], 2) ?></strong></td>
                        <td>
                            <span class="status-badge <?= $statusClass ?>">
                                <?= htmlspecialchars($contract['contract_status']) ?>
                            </span>
                        </td>
                        <td><?= htmlspecialchars($contract['start_date']) ?></td>
                        <td><?= htmlspecialchars($contract['end_date']) ?></td>
                        <td>
                            <?php if (isset($contract['days_to_expiry'])): ?>
                                <span class="expiry-badge <?= $expiryClass ?>">
                                    <?php if ($contract['days_to_expiry'] < 0): ?>
                                        Expired
                                    <?php else: ?>
                                        <?= $contract['days_to_expiry'] ?> days
                                    <?php endif; ?>
                                </span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <div class="action-btns">
                                <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" 
                                   class="action-btn action-btn-view">View</a>
                                <a href="contract_edit.php?id=<?= urlencode($contract['contract_id']) ?>" 
                                   class="action-btn action-btn-edit">Edit</a>
                                <?php if ($contract['contract_status'] === 'Active' && isset($contract['days_to_expiry']) && $contract['days_to_expiry'] <= 90): ?>
                                    <a href="contract_renew.php?id=<?= urlencode($contract['contract_id']) ?>" 
                                       class="action-btn action-btn-renew">Renew</a>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>
</div>


// ...existing code...

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contracts_list.php ---



--- Start of contract_form.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Add Service Contract';
$contractSchema = require __DIR__ . '/contract_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$customers = readCSV('customers.csv', require __DIR__ . '/customer_schema.php');
$equipment = readCSV('equipment.csv', require __DIR__ . '/equipment_schema.php') ?: [];

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $contracts = readCSV('contracts.csv', $contractSchema) ?: [];
    
    // Generate contract ID
    $contractId = 'CNT-' . date('Ymd') . '-' . str_pad(count($contracts) + 1, 4, '0', STR_PAD_LEFT);
    
    // Calculate values
    $monthlyFee = (float)$_POST['monthly_fee'];
    $contractTerm = (int)$_POST['contract_term'];
    $annualValue = $monthlyFee * 12;
    
    // Calculate end date
    $startDate = $_POST['start_date'];
    $endDate = date('Y-m-d', strtotime($startDate . ' + ' . $contractTerm . ' months'));
    
    // Calculate renewal date (end date - notice period)
    $noticePeriod = (int)$_POST['notice_period'];
    $renewalDate = date('Y-m-d', strtotime($endDate . ' - ' . $noticePeriod . ' days'));
    
    $newContract = [
        'contract_id' => $contractId,
        'contact_id' => $_POST['contact_id'],
        'customer_id' => $_POST['customer_id'] ?? '',
        'contract_type' => $_POST['contract_type'],
        'contract_status' => 'Active',
        'equipment_type' => $_POST['equipment_type'],
        'monthly_fee' => $monthlyFee,
        'annual_value' => $annualValue,
        'payment_frequency' => $_POST['payment_frequency'],
        'contract_term' => $contractTerm,
        'start_date' => $startDate,
        'end_date' => $endDate,
        'renewal_date' => $renewalDate,
        'auto_renew' => $_POST['auto_renew'] ?? 'No',
        'notice_period' => $noticePeriod,
        'evoqua_account' => $_POST['evoqua_account'] ?? '',
        'evoqua_contract' => $_POST['evoqua_contract'] ?? '',
        'equipment_ids' => $_POST['equipment_ids'] ?? '',
        'service_frequency' => $_POST['service_frequency'],
        'last_service_date' => $_POST['last_service_date'] ?? '',
        'next_service_date' => $_POST['next_service_date'] ?? '',
        'notes' => $_POST['notes'] ?? '',
        'created_date' => date('Y-m-d H:i:s'),
        'created_by' => $_SESSION['user_id'] ?? 'system',
        'modified_date' => date('Y-m-d H:i:s'),
        'modified_by' => $_SESSION['user_id'] ?? 'system'
    ];
    
    $contracts[] = $newContract;
    
    if (writeCSV('contracts.csv', $contracts, $contractSchema)) {
        header('Location: contracts_list.php?success=1');
        exit;
    } else {
        $error = 'Failed to save contract';
    }
}
?>

<style>
.page-header {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.form-container {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: 1200px;
}

.form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #E5E7EB;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #10B981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.calculated-value {
    background: #F0FDF4;
    padding: 16px;
    border-radius: 8px;
    border: 2px solid #10B981;
    font-weight: 700;
    color: #065F46;
    font-size: 20px;
}

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
}

.btn {
    padding: 14px 32px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-secondary {
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
}

.btn-secondary:hover {
    background: #E5E7EB;
}

.form-help {
    font-size: 12px;
    color: #6B7280;
    margin-top: 6px;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<a href="contracts_list.php" style="display: inline-flex; align-items: center; gap: 8px; color: #10B981; text-decoration: none; font-weight: 600; margin-bottom: 16px;">
    ‚Üê Back to Contracts
</a>

<div class="page-header">
    <h1>üìã Add Service Contract</h1>
    <p>Create a new SDI service agreement</p>
</div>

<?php if (isset($error)): ?>
    <div style="background: #FEE2E2; border: 2px solid #EF4444; color: #991B1B; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
        ‚ö†Ô∏è <?= htmlspecialchars($error) ?>
    </div>
<?php endif; ?>

<div class="form-container">
    <form method="POST" id="contractForm">
        <!-- Contact & Customer Information -->
        <div class="form-section">
            <div class="form-section-title">üë§ Contact & Customer Information</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="contact_id">Contact *</label>
                    <select name="contact_id" id="contact_id" required>
                        <option value="">Select Contact</option>
                        <?php foreach ($contacts as $contact): ?>
                            <option value="<?= htmlspecialchars($contact['id']) ?>">
                                <?= htmlspecialchars(trim($contact['first_name'] . ' ' . $contact['last_name'])) ?> 
                                <?php if (!empty($contact['company'])): ?>
                                    - <?= htmlspecialchars($contact['company']) ?>
                                <?php endif; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customer_id">Customer ID (Optional)</label>
                    <input type="text" name="customer_id" id="customer_id">
                    <div class="form-help">Leave blank if contact is the customer</div>
                </div>
            </div>
        </div>
        
        <!-- Contract Details -->
        <div class="form-section">
            <div class="form-section-title">üìÑ Contract Details</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="contract_type">Contract Type *</label>
                    <select name="contract_type" id="contract_type" required>
                        <option value="">Select Type</option>
                        <option value="New">New Contract</option>
                        <option value="Renewal">Renewal</option>
                        <option value="Upsell">Upsell</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="equipment_type">Equipment Type *</label>
                    <select name="equipment_type" id="equipment_type" required>
                        <option value="">Select Equipment</option>
                        <option value="Softener">Water Softener</option>
                        <option value="RO System">RO System</option>
                        <option value="Filtration">Filtration System</option>
                        <option value="DI System">DI System</option>
                        <option value="Mixed Systems">Mixed Systems</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="monthly_fee">Monthly Fee ($) *</label>
                    <input type="number" name="monthly_fee" id="monthly_fee" step="0.01" min="0" required 
                           onchange="calculateAnnualValue()">
                </div>
                
                <div class="form-group">
                    <label for="annual_value">Annual Contract Value ($)</label>
                    <div class="calculated-value" id="annual_value_display">$0.00</div>
                    <div class="form-help">Calculated automatically</div>
                </div>
                
                <div class="form-group">
                    <label for="payment_frequency">Payment Frequency *</label>
                    <select name="payment_frequency" id="payment_frequency" required>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="contract_term">Contract Term (Months) *</label>
                    <select name="contract_term" id="contract_term" required onchange="calculateDates()">
                        <option value="12">12 Months</option>
                        <option value="24">24 Months</option>
                        <option value="36">36 Months</option>
                        <option value="48">48 Months</option>
                        <option value="60">60 Months</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Dates & Terms -->
        <div class="form-section">
            <div class="form-section-title">üìÖ Dates & Terms</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="start_date">Contract Start Date *</label>
                    <input type="date" name="start_date" id="start_date" required onchange="calculateDates()">
                </div>
                
                <div class="form-group">
                    <label for="end_date">Contract End Date</label>
                    <div class="calculated-value" id="end_date_display">Not calculated</div>
                    <div class="form-help">Calculated from start date + term</div>
                </div>
                
                <div class="form-group">
                    <label for="notice_period">Cancellation Notice Period (Days) *</label>
                    <select name="notice_period" id="notice_period" required onchange="calculateDates()">
                        <option value="30">30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="renewal_date">Renewal Notification Date</label>
                    <div class="calculated-value" id="renewal_date_display">Not calculated</div>
                    <div class="form-help">End date minus notice period</div>
                </div>
                
                <div class="form-group">
                    <label for="auto_renew">Auto-Renewal</label>
                    <select name="auto_renew" id="auto_renew">
                        <option value="Yes">Yes - Auto Renew</option>
                        <option value="No">No - Manual Renewal</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Evoqua Details -->
        <div class="form-section">
            <div class="form-section-title">üè¢ Evoqua Details</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="evoqua_account">Evoqua Account Number</label>
                    <input type="text" name="evoqua_account" id="evoqua_account">
                </div>
                
                <div class="form-group">
                    <label for="evoqua_contract">Evoqua Contract Number</label>
                    <input type="text" name="evoqua_contract" id="evoqua_contract">
                </div>
            </div>
        </div>
        
        <!-- Service Schedule -->
        <div class="form-section">
            <div class="form-section-title">üîß Service Schedule</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="service_frequency">Service Frequency *</label>
                    <select name="service_frequency" id="service_frequency" required>
                        <option value="Weekly">Weekly</option>
                        <option value="Bi-weekly">Bi-weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Semi-Annual">Semi-Annual</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="next_service_date">Next Service Date</label>
                    <input type="date" name="next_service_date" id="next_service_date">
                </div>
                
                <div class="form-group full-width">
                    <label for="notes">Contract Notes</label>
                    <textarea name="notes" id="notes" placeholder="Additional contract notes, special terms, etc."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ Create Contract</button>
            <a href="contracts_list.php" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function calculateAnnualValue() {
    const monthlyFee = parseFloat(document.getElementById('monthly_fee').value) || 0;
    const annualValue = monthlyFee * 12;
    document.getElementById('annual_value_display').textContent = '$' + annualValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function calculateDates() {
    const startDate = document.getElementById('start_date').value;
    const termMonths = parseInt(document.getElementById('contract_term').value);
    const noticeDays = parseInt(document.getElementById('notice_period').value);
    
    if (!startDate || !termMonths) return;
    
    // Calculate end date
    const start = new Date(startDate);
    const end = new Date(start);
    end.setMonth(end.getMonth() + termMonths);
    
    const endDateStr = end.toISOString().split('T')[0];
    document.getElementById('end_date_display').textContent = endDateStr;
    
    // Calculate renewal date
    const renewal = new Date(end);
    renewal.setDate(renewal.getDate() - noticeDays);
    const renewalDateStr = renewal.toISOString().split('T')[0];
    document.getElementById('renewal_date_display').textContent = renewalDateStr;
}

// Set default start date to today
document.getElementById('start_date').valueAsDate = new Date();
calculateDates();
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contract_form.php ---



--- Start of contract_schema.php ---

<?php
/**
 * Service Contract Schema - SDI Business Model
 * Tracks recurring service agreements with Evoqua equipment
 */
return [
    'contract_id',          // Unique identifier
    'contact_id',           // Link to contact
    'customer_id',          // Link to customer  
    'contract_type',        // New / Renewal / Upsell
    'contract_status',      // Draft / Active / Expiring / Expired / Cancelled
    'equipment_type',       // Softener / RO System / Filtration / DI System / Other
    'monthly_fee',          // Monthly recurring revenue
    'annual_value',         // Total annual contract value
    'payment_frequency',    // Monthly / Quarterly / Annual
    'contract_term',        // Term length in months (12/24/36/etc)
    'start_date',          // Contract start date
    'end_date',            // Contract end date
    'renewal_date',        // Auto-renewal date
    'auto_renew',          // Yes / No
    'notice_period',       // Cancellation notice period (days)
    'evoqua_account',      // Evoqua account number
    'evoqua_contract',     // Evoqua contract number
    'equipment_ids',       // Comma-separated equipment IDs
    'service_frequency',   // Weekly / Bi-weekly / Monthly / Quarterly
    'last_service_date',   // Most recent service visit
    'next_service_date',   // Scheduled next service
    'notes',               // Additional contract notes
    'created_date',        // Contract creation date
    'created_by',          // User who created contract
    'modified_date',       // Last modification date
    'modified_by'          // User who last modified
];


--- End of contract_schema.php ---



--- Start of csrf_helper.php ---

<?php
/**
 * CSRF Protection Helper Functions
 * Prevents Cross-Site Request Forgery attacks
 */

// Ensure session is started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

/**
 * Initialize CSRF token in session
 */
function initializeCSRFToken() {
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

/**
 * Get the current CSRF token
 */
function getCSRFToken() {
    initializeCSRFToken();
    return $_SESSION['csrf_token'];
}

/**
 * Verify CSRF token from POST/REQUEST
 */
function verifyCSRFToken($token) {
    if (empty($_SESSION['csrf_token'])) {
        return false;
    }
    return hash_equals($_SESSION['csrf_token'], $token ?? '');
}

/**
 * Render hidden CSRF input field for HTML forms
 */
function renderCSRFInput() {
    $token = htmlspecialchars(getCSRFToken(), ENT_QUOTES, 'UTF-8');
    echo '<input type="hidden" name="csrf_token" value="' . $token . '">';
}

/**
 * Get CSRF token as escaped attribute value (for data attributes, etc)
 */
function getCSRFTokenAttribute() {
    return htmlspecialchars(getCSRFToken(), ENT_QUOTES, 'UTF-8');
}
?>


--- End of csrf_helper.php ---



--- Start of csv_export.php ---

function exportCSVFiltered($filename, $rows, $filters = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered));
}


--- End of csv_export.php ---



--- Start of csv_handler.php ---

<?php
/**
 * CSV Handler - Improved for reliability and maintainability
 * Provides file locking, schema validation, and better error handling
 */

/**
 * Read CSV file into array of associative arrays.
 * @param string $filename
 * @param array $schema
 * @return array
 */
function readCSV($filename, $schema) {
    $filename = resolveCsvPath($filename);
    if (!file_exists($filename)) {
        error_log("csv_handler: File not found: $filename");
        return [];
    }
    $rows = [];
    $handle = fopen($filename, 'r');
    if ($handle === false) {
        error_log("csv_handler: Unable to open file: $filename");
        return [];
    }
    if (flock($handle, LOCK_SH)) {
        $headers = fgetcsv($handle);
        if ($headers === false) {
            error_log("csv_handler: Failed to read headers: $filename");
            flock($handle, LOCK_UN);
            fclose($handle);
            return [];
        }
        while (($data = fgetcsv($handle)) !== false) {
            if (count($data) !== count($headers)) {
                error_log("csv_handler: Row length mismatch in $filename: " . implode(',', $data));
                continue;
            }
            $row = array_combine($headers, $data);
            $rows[] = $row;
        }
        flock($handle, LOCK_UN);
    } else {
        error_log("csv_handler: Unable to lock file for reading: $filename");
    }
    fclose($handle);
    // Optionally validate schema
    if (!empty($rows) && !validateCsvSchema($rows[0], $schema)) {
        error_log("csv_handler: Schema mismatch in $filename");
    }
    return $rows;
}

/**
 * Write array of associative arrays to CSV file.
 * @param string $filename
 * @param array $data
 * @param array $schema
 * @return bool
 */
function writeCSV($filename, $data, $schema) {
    $filename = resolveCsvPath($filename);
    $file = fopen($filename, 'w');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    $ok = false;
    if (flock($file, LOCK_EX)) {
        fputcsv($file, $schema);
        foreach ($data as $row) {
            $csvRow = [];
            foreach ($schema as $field) {
                $value = $row[$field] ?? '';
                // Prevent CSV injection
                if (preg_match('/^[=+\-@]/', $value)) {
                    $value = "'" . $value;
                }
                $csvRow[] = $value;
            }
            fputcsv($file, $csvRow);
        }
        flock($file, LOCK_UN);
        $ok = true;
    } else {
        error_log("csv_handler: Unable to lock file for writing: $filename");
    }
    fclose($file);
    return $ok;
}

/**
 * Append a row to a CSV file.
 * @param string $filename
 * @param array $row
 * @return bool
 */
function appendCSV($filename, $row) {
    $filename = resolveCsvPath($filename);
    $file = fopen($filename, 'a');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    $ok = false;
    if (flock($file, LOCK_EX)) {
        fputcsv($file, $row);
        flock($file, LOCK_UN);
        $ok = true;
    } else {
        error_log("csv_handler: Unable to lock file for appending: $filename");
    }
    fclose($file);
    return $ok;
}

/**
 * Helper: Resolve CSV file path.
 * @param string $filename
 * @return string
 */
function resolveCsvPath($filename) {
    if (basename($filename) === $filename) {
        return __DIR__ . '/' . $filename;
    }
    return $filename;
}

/**
 * Helper: Validate that a row matches the schema.
 * @param array $row
 * @param array $schema
 * @return bool
 */
function validateCsvSchema($row, $schema) {
    $rowFields = array_keys($row);
    return $rowFields === $schema;
}

?>

--- End of csv_handler.php ---



--- Start of csv_import.php ---

function importCSVWithSchema($filename, $schema, $keyField, $existingRows) {
    $newRows = [];
    $imported = readCSV($filename);
    foreach ($imported as $row) {
        if (!array_diff($schema, array_keys($row)) && !in_array($row[$keyField], array_column($existingRows, $keyField))) {
            $newRows[] = $row;
        }
    }
    return $newRows;
}


--- End of csv_import.php ---



--- Start of customers_list.php ---

<?php
// customers_list.php

header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

include_once(__DIR__ . '/layout_start.php');
require_once __DIR__ . '/csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter only customers
$customers = array_filter($contacts, function($c) {
    return in_array(strtolower(trim($c['is_customer'] ?? '')), ['yes', 'true', '1']);
});
?>

<div class="container">
  <h2>Customer List</h2>

  <table class="table-grid">
    <thead>
      <tr>
		<th>Company</th>
        <th>First Name</th>
        <th>Email</th>
        <th>Customer Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($customers as $contact): ?>
        <tr>
          <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
		  <td><?= htmlspecialchars($contact['first_name'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['is_customer'] ?? '') ?></td>
          <td>
            <a href="customer_view.php?id=<?= urlencode($contact['id']) ?>" class="btn-primary">üëÅ View</a>
            <?php
              $deliveryFile = "{$contact['id']}_deliveries.csv";
              if (file_exists(__DIR__ . "/$deliveryFile")):
            ?>
              <a href="<?= htmlspecialchars($deliveryFile) ?>" class="btn-secondary" target="_blank">üì¶ Delivery Archive</a>
            <?php endif; ?>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="navigation">
    <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of customers_list.php ---



--- Start of customer_item_config.php ---

<?php
return [
  'tank_number',
  'tank_size',
  'type_of_resin',
  'delivery_date',
  'regeneration_number',
  'purchase_order'
];


--- End of customer_item_config.php ---



--- Start of customer_schema.php ---

<?php
return [
  'customer_id',
  'contact_name',
  'address',
  'tank_count',
  'last_delivery',
  'last_modified'
];


--- End of customer_schema.php ---



--- Start of customer_view.php ---

<?php


// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Includes
include_once(__DIR__ . '/layout_start.php');
require_once __DIR__ . '/csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Helper: find contact by ID
function findContactById($contacts, $id) {
    if ($id === '') return null;
    foreach ($contacts as $c) {
        if ($c['id'] === $id) return $c;
    }
    return null;
}

// Helper: create delivery file
function createDeliveryFileIfNeeded($contactId) {
    $deliveryFile = __DIR__ . "/{$contactId}_deliveries.csv";
    if (!file_exists($deliveryFile)) {
        $fp = fopen($deliveryFile, 'w');
        if ($fp) {
            fputcsv($fp, ['delivery_date', 'tank_number', 'tank_size']);
            fclose($fp);
            return true;
        } else {
            error_log("Failed to create delivery file for contact ID: $contactId");
            return false;
        }
    }
    return true;
}

// Handle contact update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['id'])) {
    $id = $_POST['id'];
    foreach ($contacts as &$c) {
        if ($c['id'] === $id) {
            foreach ($schema as $f) {
                $c[$f] = $_POST[$f] ?? $c[$f];
            }

            // Create delivery file if marked as customer
            if (isset($_POST['is_customer']) && strtolower(trim($_POST['is_customer'])) === 'yes') {
                if (!createDeliveryFileIfNeeded($id)) {
                    echo "<div class='alert-error'>‚ö†Ô∏è Delivery file could not be created for customer ID: $id</div>";
                }
            }

            break;
        }
    }
    writeCSV('contacts.csv', $contacts, $schema);
    header("Location: customer_view.php?id=" . urlencode($id));
    exit;
}

// Load contact
$id = $_GET['id'] ?? '';
$contact = findContactById($contacts, $id);

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once(__DIR__ . '/layout_end.php');
    exit;
}
?>

<div class="container">
    <h2>Customer Details</h2>
  
    <form method="post" class="contact-form" id="edit">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php elseif ($f === 'id'): ?>
            <input type="text" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>" disabled>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">üíæ Save Changes</button>
        </div>
    </form>

    <div class="customer-actions">
        <a href="customers_list.php" class="btn-outline">‚¨Ö Back to Customers</a>
        <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
        <?php
        $deliveryFile = "{$contact['id']}_deliveries.csv";
        if (file_exists(__DIR__ . "/$deliveryFile")) {
                echo '<a href="' . htmlspecialchars($deliveryFile) . '" class="btn-secondary" target="_blank">üì¶ View Deliveries</a>';
        }

        $isCustomer = strtolower(trim($contact['is_customer'] ?? '')) === 'yes';
        $deliveryFilePath = __DIR__ . "/$deliveryFile";
        if ($isCustomer && file_exists($deliveryFilePath)) {
                $deliveryUrl = "deliveries.php?id=" . urlencode($contact['id']);
                echo '<a href="' . $deliveryUrl . '" class="btn-primary">üì¶ View Delivery Archive</a>';
        }
        ?>
    </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>

--- End of customer_view.php ---



--- Start of dashboard.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
$forecastData = calculateForecasts();
$forecasts = $forecastData['individual'];
$forecastByStage = $forecastData['by_stage'];

$totalContacts = count($contacts);
$totalValue = array_sum(array_column($opportunities, 'value'));
$totalForecast = array_sum(array_column($forecasts, 'forecast'));
$accuracy = $totalValue > 0 ? ($totalForecast / $totalValue) * 100 : 0;

// Identify top forecast stage
$topStage = '';
$maxForecast = 0;
foreach ($forecastByStage as $stage => $data) {
    if ($data['total_forecast'] > $maxForecast) {
        $maxForecast = $data['total_forecast'];
        $topStage = $stage;
    }
}

// Pipeline breakdown
$stages = [];
foreach ($opportunities as $opp) {
    $stage = $opp['stage'];
    $value = floatval($opp['value']);
    if (!isset($stages[$stage])) {
        $stages[$stage] = ['count' => 0, 'value' => 0];
    }
    $stages[$stage]['count']++;
    $stages[$stage]['value'] += $value;
}
?>

<div class="page-header">
  <h1>Dashboard</h1>
  <div class="page-actions">
    <a href="contacts_list.php" class="btn btn-outline">View Contacts</a>
    <a href="opportunities_list.php" class="btn btn-primary">View Opportunities</a>
  </div>
</div>

<!-- Key Metrics -->
<div class="stats-grid">
  <div class="stat-card stat-card-primary">
    <div class="stat-icon">üë•</div>
    <div class="stat-content">
      <div class="stat-label">Total Contacts</div>
      <div class="stat-value"><?= number_format($totalContacts) ?></div>
    </div>
  </div>
  
  <div class="stat-card stat-card-success">
    <div class="stat-icon">üí∞</div>
    <div class="stat-content">
      <div class="stat-label">Pipeline Value</div>
      <div class="stat-value">$<?= number_format($totalValue, 0) ?></div>
    </div>
  </div>
  
  <div class="stat-card stat-card-info">
    <div class="stat-icon">üìä</div>
    <div class="stat-content">
      <div class="stat-label">Forecast Value</div>
      <div class="stat-value">$<?= number_format($totalForecast, 0) ?></div>
    </div>
  </div>
  
  <div class="stat-card stat-card-warning">
    <div class="stat-icon">üéØ</div>
    <div class="stat-content">
      <div class="stat-label">Forecast Accuracy</div>
      <div class="stat-value"><?= number_format($accuracy, 1) ?>%</div>
    </div>
  </div>
</div>

<!-- Pipeline and Forecast Tables -->
<div class="dashboard-grid">
  <div class="card">
    <div class="card-header">
      <h3>Pipeline Breakdown</h3>
    </div>
    <div class="card-body">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Stage</th>
            <th>Count</th>
            <th>Total Value</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($stages as $stage => $data): ?>
            <tr>
              <td><?= e($stage) ?></td>
              <td><span class="badge badge-primary"><?= $data['count'] ?></span></td>
              <td><strong>$<?= number_format($data['value'], 2) ?></strong></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Forecast by Stage</h3>
      <?php if ($topStage): ?>
        <div class="badge badge-success">Top: <?= e($topStage) ?></div>
      <?php endif; ?>
    </div>
    <div class="card-body">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Stage</th>
            <th>Count</th>
            <th>Total Forecast</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($forecastByStage as $stage => $data): ?>
            <tr>
              <td><?= e($stage) ?></td>
              <td><span class="badge badge-info"><?= $data['count'] ?></span></td>
              <td><strong>$<?= number_format($data['total_forecast'], 2) ?></strong></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  font-size: 36px;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  background: rgba(0, 153, 168, 0.1);
}

.stat-card-primary .stat-icon { background: rgba(0, 153, 168, 0.1); }
.stat-card-success .stat-icon { background: rgba(16, 185, 129, 0.1); }
.stat-card-info .stat-icon { background: rgba(59, 130, 246, 0.1); }
.stat-card-warning .stat-icon { background: rgba(245, 158, 11, 0.1); }

.stat-content {
  flex: 1;
}

.stat-label {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 4px;
  font-weight: 500;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-value {
    font-size: 24px;
  }
}
</style>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of dashboard.php ---



--- Start of delete_contact.php ---

<?php
require_once 'layout_start.php';
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'error_handler.php';

// ‚úÖ CSRF Protection: Verify token on POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        showError('CSRF validation failed');
        logWarning('CSRF token validation failed on delete_contact', ['ip' => $_SERVER['REMOTE_ADDR']]);
        exit;
    }
}

$idToDelete = $_POST['id'] ?? null;
if (!$idToDelete) {
    showError('No contact ID provided');
    exit;
}

$schema = require __DIR__ . '/contact_schema.php';
$deleted_contact = null;

try {
    // ‚úÖ LOCKED READ-MODIFY-WRITE: Prevents race condition data loss
    readModifyWriteCSV('contacts.csv', $schema, function($contacts) use ($idToDelete) {
        global $deleted_contact;
        
        // Find and capture contact before deletion (for audit log)
        $deleted_contact = null;
        foreach ($contacts as $contact) {
            if ($contact['id'] === $idToDelete) {
                $deleted_contact = $contact;
                break;
            }
        }
        
        // Filter out the contact to delete
        $filtered = array_filter($contacts, function($c) use ($idToDelete) {
            return $c['id'] !== $idToDelete;
        });
        
        // Reindex array to maintain clean structure
        return array_values($filtered);
    });
    
    // ‚úÖ AUDIT: Log contact deletion
    if ($deleted_contact) {
        auditDeleteContact($deleted_contact);
        logInfo('Contact deleted successfully', [
            'email' => $deleted_contact['email'],
            'name' => ($deleted_contact['first_name'] ?? '') . ' ' . ($deleted_contact['last_name'] ?? ''),
        ]);
    }
    
    header('Location: contacts_list.php');
    exit;
} catch (Exception $e) {
    showError('Error deleting contact', htmlspecialchars($e->getMessage()));
    logError('Contact deletion failed', [
        'id' => $idToDelete,
        'exception' => $e->getMessage(),
    ]);
    
    // ‚úÖ AUDIT: Log failed deletion
    if ($deleted_contact) {
        auditDeleteContact($deleted_contact);
    }
    
    echo "<p><a href='contacts_list.php'>Go back</a></p>";
    exit;
}
?>



--- End of delete_contact.php ---



--- Start of delete_opportunity.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: opportunities_list.php?error=' . urlencode('Invalid request method'));
    exit;
}

$idToDelete = $_POST['id'] ?? null;

if (!$idToDelete) {
    header('Location: opportunities_list.php?error=' . urlencode('No opportunity ID provided'));
    exit;
}

// Load opportunities
$opportunities = readCSV('opportunities.csv', $schema);

// Find and remove the opportunity
$found = false;
$filteredOpportunities = array_filter($opportunities, function($opp) use ($idToDelete, &$found) {
    if ($opp['id'] == $idToDelete) {
        $found = true;
        return false; // Remove this opportunity
    }
    return true; // Keep this opportunity
});

if (!$found) {
    header('Location: opportunities_list.php?error=' . urlencode('Opportunity not found'));
    exit;
}

// Save the updated list
if (writeCSV('opportunities.csv', array_values($filteredOpportunities), $schema)) {
    header('Location: opportunities_list.php?success=3');
    exit;
} else {
    header('Location: opportunities_list.php?error=' . urlencode('Failed to delete opportunity'));
    exit;
}


--- End of delete_opportunity.php ---



--- Start of delete_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if (isset($_GET['timestamp'])) {
    deleteTask($filename, $schema, $_GET['timestamp']);
}
header('Location: index.php');
exit;


--- End of delete_task.php ---



--- Start of deliveries.php ---

<?php
include_once 'layout_start.php';

// Get customer ID from GET
$id = isset($_GET['id']) ? preg_replace('/[^a-zA-Z0-9_-]/', '', $_GET['id']) : null;

if (!$id) {
    echo "<p>Error: No customer ID specified.</p>";
    include_once 'layout_end.php';
    exit;
}

$csvFile = "deliveries_$id.csv";

// Create file if it doesn't exist
if (!file_exists($csvFile)) {
    $fp = fopen($csvFile, 'w');
    fputcsv($fp, ['Date', 'Company', 'Tank #', 'Size']); // Header row
    fclose($fp);
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $date = $_POST['delivery_date'];
    $company = $_POST['company'];
    $tank_number = $_POST['tank_number'];
    $tank_size = $_POST['tank_size'];

    $newEntry = [$date, $company, $tank_number, $tank_size];
    $fp = fopen($csvFile, 'a');
    fputcsv($fp, $newEntry);
    fclose($fp);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delivery Archive - Customer #<?php echo htmlspecialchars($id); ?></title>
  <script>
    function sortTable(n) {
      const table = document.getElementById("deliveryTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let shouldSwitch = dir === "asc" ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase();
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
            break;
          }
        }
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  </script>
</head>
<body>
  <h2>üì¶ Delivery Archive for Customer #<?php echo htmlspecialchars($id); ?></h2>

  <form method="post">
    <label><strong>Add New Delivery:</strong></label><br>
    <input type="date" name="delivery_date" required>
    <input type="text" name="company" required>
    <input type="text" name="tank_number" placeholder="Tank #" required>
    <input type="text" name="tank_size" placeholder="Size" required>
	<input type="text" name="number" placeholder="Number of Tanks" required>
    <button type="submit">‚ûï Add Delivery</button>
  </form>

  <br>
  customer_view.php?id=<?php echo urlencode($id); ?>
    <button>üîô Back to Customer Details</button>
  </a>

  <br><br>
  <table id="deliveryTable" border="1">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Date</th>
        <th onclick="sortTable(1)">Company</th>
        <th onclick="sortTable(2)">Tank #</th>
        <th onclick="sortTable(3)">Size</th>
		 <th onclick="sortTable(4)">Number of Tanks</th>
      </tr>
    </thead>
    <tbody>
      <?php
      $rows = array_map('str_getcsv', file($csvFile));
      array_shift($rows); // Remove header
      if (count($rows) > 0) {
          foreach ($rows as $row) {
              echo "<tr>";
              foreach ($row as $cell) {
                  echo "<td>" . htmlspecialchars($cell) . "</td>";
              }
              echo "</tr>";
          }
      } else {
          echo "<tr><td colspan='4'>No delivery records found.</td></tr>";
      }
      ?>
    </tbody>
  </table>
</body>
</html>
<?php include_once 'layout_end.php'; ?>

--- End of deliveries.php ---



--- Start of discussion_logger.php ---

<?php
// discussion_logger.php
require_once 'csv_handler.php';

// Use $_POST directly
$data = $_POST;
$contactId = $data['contact_id'] ?? null;

// Define the logging function
function logDiscussionEntry(array $data): bool {
    $file = 'discussion_log.csv';
    $logFile = 'error_log.txt';
    $schema = require __DIR__ . '/discussion_schema.php';

    // Build row using schema order
    $row = [];
    foreach ($schema as $col) {
        switch ($col) {
            case 'timestamp':
                $row[] = date('Y-m-d H:i');
                break;
            case 'entry_text':
                $row[] = isset($data[$col]) ? str_replace(["\r", "\n"], ' ', $data[$col]) : '';
                break;
            case 'author':
                $row[] = $data[$col] ?? 'System';
                break;
            case 'linked_opportunity_id':
                $row[] = $data[$col] ?? '';
                break;
            case 'visibility':
                $row[] = $data[$col] ?? 'public';
                break;
            default:
                $row[] = $data[$col] ?? '';
        }
    }

    // Try to append to CSV
    if (($fp = fopen($file, 'a')) !== false) {
        fputcsv($fp, $row);
        fclose($fp);
        return true;
    }

    // Log error if write fails
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write to $file for contact_id: {$data['contact_id']}\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    return false;
}

// Log the discussion entry and redirect
if (!empty($data) && !empty($contactId) && logDiscussionEntry($data)) {
    header('Location: contact_view.php?id=' . urlencode($contactId));
    exit;
} else {
    // Fallback error
    header('Location: contacts_list.php');
    exit;
}
?>



--- End of discussion_logger.php ---



--- Start of discussion_module.php ---

<?php
$cid = $contact['id'] ?? '';
if (empty($cid)) return;

$discussionSchema = require __DIR__ . '/discussion_schema.php';
$discussionLog = readCSV('discussion_log.csv', $discussionSchema) ?: [];

$entries = array_filter($discussionLog, fn($e) => trim($e['contact_id']) === trim($cid));
usort($entries, fn($a, $b) => strtotime($b['timestamp']) <=> strtotime($a['timestamp']));
?>

<div style="margin-top:40px;">
  <h3>Discussion</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:40px; align-items:start;">

    <!-- Add Discussion Entry (Left) -->
    <div>
      <h4>Add Discussion Entry</h4>
      <form method="post" style="display:grid; gap:15px;">
        <input type="hidden" name="contact_id" value="<?= htmlspecialchars($cid) ?>">

        <div>
          <label for="author">Author:</label><br>
          <input type="text" name="author" id="author" value="Robert Lee" required>
        </div>

        <div>
          <label for="entry_text">Comment:</label><br>
          <textarea name="entry_text" id="entry_text" rows="4" required></textarea>
        </div>

        <div>
          <label for="linked_opportunity_id">Linked Opportunity ID (optional):</label><br>
          <input type="text" name="linked_opportunity_id" id="linked_opportunity_id">
        </div>

        <div>
          <label for="visibility">Visibility:</label><br>
          <select name="visibility" id="visibility">
            <option value="public">Public</option>
            <option value="internal">Internal</option>
          </select>
        </div>

        <button type="submit" class="btn-primary">üí¨ Log Discussion</button>
      </form>
    </div>

    <!-- Discussion History (Right) -->
    <div>
      <h4>Discussion History</h4>
      <?php if (!empty($entries)): ?>
        <?php foreach ($entries as $entry): ?>
          <div style="border-left:3px solid #0099A8; padding-left:10px; margin-bottom:15px;">
            <div style="font-size:0.9em; color:#555;">
              <strong><?= htmlspecialchars($entry['author'] ?? 'Admin') ?></strong>
              <em><?= htmlspecialchars($entry['timestamp'] ?? '') ?></em>
              <?php if (!empty($entry['linked_opportunity_id'])): ?>
                ‚Ä¢ <span>Opportunity: <?= htmlspecialchars($entry['linked_opportunity_id']) ?></span>
              <?php endif; ?>
              <?php if (!empty($entry['visibility'])): ?>
                ‚Ä¢ <span>Visibility: <?= htmlspecialchars($entry['visibility']) ?></span>
              <?php endif; ?>
            </div>
            <div style="margin-top:5px;">
              <?= nl2br(htmlspecialchars($entry['entry_text'] ?? '')) ?>
            </div>
          </div>
        <?php endforeach; ?>
      <?php else: ?>
        <p style="color:#666;">No discussion history found for this contact.</p>
      <?php endif; ?>
    </div>

  </div>
</div>


--- End of discussion_module.php ---



--- Start of discussion_schema.php ---

<?php
return [
    'contact_id',
    'author',
    'timestamp',
    'entry_text',
    'linked_opportunity_id',
    'visibility'
];


--- End of discussion_schema.php ---



--- Start of discussion_validator.php ---

<?php
function validateDiscussion(array $data): array {
    $errors = [];

    if (empty($data['contact_id'])) {
        $errors['contact_id'] = 'Contact ID is required.';
    }

    if (empty($data['entry_text'])) {
        $errors['entry_text'] = 'Comment text is required.';
    }

    if (empty($data['author'])) {
        $errors['author'] = 'Author is required.';
    }

    return $errors;
}


--- End of discussion_validator.php ---



--- Start of edit_opportunity.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Get opportunity ID
$opportunityId = $_GET['id'] ?? $_POST['id'] ?? null;

if (!$opportunityId) {
    header('Location: opportunities_list.php?error=' . urlencode('No opportunity ID provided'));
    exit;
}

// Load opportunities
$opportunities = readCSV('opportunities.csv', $schema);

// Find the opportunity
$opportunity = null;
$opportunityIndex = null;
foreach ($opportunities as $index => $opp) {
    if ($opp['id'] == $opportunityId) {
        $opportunity = $opp;
        $opportunityIndex = $index;
        break;
    }
}

if (!$opportunity) {
    header('Location: opportunities_list.php?error=' . urlencode('Opportunity not found'));
    exit;
}

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate inputs
    $errors = [];
    
    if (empty($_POST['contact_id'])) {
        $errors[] = 'Contact is required';
    }
    
    if (!isset($_POST['value']) || $_POST['value'] === '' || !is_numeric($_POST['value']) || $_POST['value'] < 0) {
        $errors[] = 'Valid opportunity value is required';
    }
    
    if (!isset($_POST['probability']) || $_POST['probability'] === '' || !is_numeric($_POST['probability']) || $_POST['probability'] < 0 || $_POST['probability'] > 100) {
        $errors[] = 'Probability must be between 0 and 100';
    }
    
    if (empty($_POST['stage'])) {
        $errors[] = 'Stage is required';
    }
    
    if (empty($_POST['expected_close'])) {
        $errors[] = 'Expected close date is required';
    }
    
    if (empty($errors)) {
        // Update opportunity
        $opportunities[$opportunityIndex] = [
            'id' => $opportunityId,
            'contact_id' => $_POST['contact_id'],
            'value' => $_POST['value'],
            'stage' => $_POST['stage'],
            'probability' => $_POST['probability'],
            'expected_close' => $_POST['expected_close'],
        ];
        
        if (writeCSV('opportunities.csv', $opportunities, $schema)) {
            header('Location: opportunities_list.php?success=2');
            exit;
        } else {
            $error = 'Failed to update opportunity.';
        }
    } else {
        $error = implode(', ', $errors);
    }
}
?>

<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }
  
  .page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
  }
  
  .page-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 14px;
  }
  
  .back-link:hover {
    color: #5558dd;
  }
  
  .form-container {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: 0 auto;
  }
  
  .form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #E5E7EB;
  }
  
  .form-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
  
  .form-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  .form-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-group input,
  .form-group select {
    padding: 14px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    background: white;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .form-group select {
    cursor: pointer;
  }
  
  .form-help {
    font-size: 12px;
    color: #6B7280;
    margin-top: 6px;
  }
  
  .stage-visual {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  
  .stage-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  
  .stage-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .stage-badge.selected {
    border-color: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
  
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }
  
  .btn-primary {
    padding: 14px 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-secondary {
    padding: 14px 32px;
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-secondary:hover {
    background: #E5E7EB;
  }
  
  .error-alert {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border: 2px solid #EF4444;
    color: #991B1B;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-slider {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-value {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    min-width: 50px;
  }
  
  input[type="range"] {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #E5E7EB;
    outline: none;
    padding: 0;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
  }
  
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .page-header {
      padding: 24px;
    }
    
    .form-container {
      padding: 24px;
    }
  }
</style>

<a href="opportunities_list.php" class="back-link">
  ‚Üê Back to Opportunities
</a>

<div class="page-header">
  <h1>‚úèÔ∏è Edit Opportunity #<?= htmlspecialchars($opportunityId) ?></h1>
  <p>Update opportunity details and sales progress</p>
</div>

<?php if (isset($error)): ?>
  <div class="error-alert">
    <span>‚ö†Ô∏è</span>
    <span><?= htmlspecialchars($error) ?></span>
  </div>
<?php endif; ?>

<div class="form-container">
  <form method="POST" id="opportunityForm">
    <input type="hidden" name="id" value="<?= htmlspecialchars($opportunityId) ?>">
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üë§</span>
        <span>Contact Information</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="contact_id">Contact *</label>
          <select name="contact_id" id="contact_id" required>
            <option value="">Select a contact...</option>
            <?php foreach ($contacts as $contact): ?>
              <?php
                $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
                $company = $contact['company'] ?? '';
                $displayName = $fullName ?: 'Unnamed Contact';
                if ($company) {
                  $displayName .= ' (' . $company . ')';
                }
                $selected = ($contact['id'] == $opportunity['contact_id']) ? 'selected' : '';
              ?>
              <option value="<?= htmlspecialchars($contact['id']) ?>" <?= $selected ?>>
                <?= htmlspecialchars($displayName) ?>
              </option>
            <?php endforeach; ?>
          </select>
          <div class="form-help">Select the contact associated with this opportunity</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üí∞</span>
        <span>Deal Details</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="value">Opportunity Value *</label>
          <input 
            type="number" 
            name="value" 
            id="value" 
            placeholder="0.00" 
            step="0.01" 
            min="0"
            value="<?= htmlspecialchars($opportunity['value']) ?>"
            required
          >
          <div class="form-help">Enter the total value in dollars</div>
        </div>
        
        <div class="form-group">
          <label for="expected_close">Expected Close Date *</label>
          <input 
            type="date" 
            name="expected_close" 
            id="expected_close"
            value="<?= htmlspecialchars($opportunity['expected_close']) ?>"
            required
          >
          <div class="form-help">When do you expect to close this deal?</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üìä</span>
        <span>Sales Stage & Probability</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="stage">Sales Stage *</label>
          <select name="stage" id="stage" required>
            <option value="">Select stage...</option>
            <option value="Prospecting" data-probability="10" <?= $opportunity['stage'] === 'Prospecting' ? 'selected' : '' ?>>Prospecting (10% win rate)</option>
            <option value="Proposal" data-probability="25" <?= $opportunity['stage'] === 'Proposal' ? 'selected' : '' ?>>Proposal (25% win rate)</option>
            <option value="Negotiation" data-probability="50" <?= $opportunity['stage'] === 'Negotiation' ? 'selected' : '' ?>>Negotiation (50% win rate)</option>
            <option value="Closed Won" data-probability="100" <?= $opportunity['stage'] === 'Closed Won' ? 'selected' : '' ?>>Closed Won (100%)</option>
            <option value="Closed Lost" data-probability="0" <?= $opportunity['stage'] === 'Closed Lost' ? 'selected' : '' ?>>Closed Lost (0%)</option>
          </select>
          
          <div class="stage-visual" style="margin-top: 16px;">
            <div class="stage-badge <?= $opportunity['stage'] === 'Prospecting' ? 'selected' : '' ?>" style="background: #6366F1;" data-stage="Prospecting">Prospecting</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Proposal' ? 'selected' : '' ?>" style="background: #8B5CF6;" data-stage="Proposal">Proposal</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Negotiation' ? 'selected' : '' ?>" style="background: #F59E0B;" data-stage="Negotiation">Negotiation</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Closed Won' ? 'selected' : '' ?>" style="background: #10B981;" data-stage="Closed Won">Closed Won</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Closed Lost' ? 'selected' : '' ?>" style="background: #EF4444;" data-stage="Closed Lost">Closed Lost</div>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="probability">Win Probability *</label>
          <div class="probability-slider">
            <input 
              type="range" 
              name="probability" 
              id="probability" 
              min="0" 
              max="100" 
              value="<?= htmlspecialchars($opportunity['probability']) ?>"
              step="5"
            >
            <span class="probability-value"><?= htmlspecialchars($opportunity['probability']) ?>%</span>
          </div>
          <div class="form-help">Estimated likelihood of closing this deal</div>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Update Opportunity</button>
      <a href="opportunities_list.php" class="btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Update probability slider value display
  const probabilitySlider = document.getElementById('probability');
  const probabilityValue = document.querySelector('.probability-value');
  
  probabilitySlider.addEventListener('input', function() {
    probabilityValue.textContent = this.value + '%';
  });
  
  // Auto-update probability based on stage selection
  const stageSelect = document.getElementById('stage');
  stageSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const suggestedProbability = selectedOption.getAttribute('data-probability');
    
    if (suggestedProbability) {
      probabilitySlider.value = suggestedProbability;
      probabilityValue.textContent = suggestedProbability + '%';
    }
    
    // Update visual badges
    document.querySelectorAll('.stage-badge').forEach(badge => {
      badge.classList.remove('selected');
      if (badge.getAttribute('data-stage') === this.value) {
        badge.classList.add('selected');
      }
    });
  });
  
  // Allow clicking stage badges to select stage
  document.querySelectorAll('.stage-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const stageName = this.getAttribute('data-stage');
      stageSelect.value = stageName;
      stageSelect.dispatchEvent(new Event('change'));
    });
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of edit_opportunity.php ---



--- Start of edit_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $updatedTask = [
        $_POST['title'],
        $_POST['due_date'],
        $_POST['status'],
        $_POST['timestamp']
    ];
    updateTask($filename, $schema, $_POST['timestamp'], $updatedTask);
    header('Location: index.php');
    exit;
}

$timestamp = $_GET['timestamp'] ?? '';
$tasks = readCSV($filename, $schema);
$taskToEdit = null;
foreach ($tasks as $task) {
    if ($task['timestamp'] === $timestamp) {
        $taskToEdit = $task;
        break;
    }
}
if (!$taskToEdit) {
    echo "Task not found.";
    exit;
}
?>

<h3>Edit Task</h3>
<form method="POST">
  <input type="hidden" name="timestamp" value="<?= htmlspecialchars($taskToEdit['timestamp']) ?>">
  <input type="text" name="title" value="<?= htmlspecialchars($taskToEdit['title']) ?>" required>
  <input type="date" name="due_date" value="<?= htmlspecialchars($taskToEdit['due_date']) ?>" required>
  <select name="status" required>
    <option value="pending" <?= $taskToEdit['status'] === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $taskToEdit['status'] === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <button type="submit">Update Task</button>
</form>


--- End of edit_task.php ---



--- Start of enhanced_contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = [];
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
    if (!empty($c['tags'])) {
        foreach (explode(',', $c['tags']) as $tag) {
            $tagOptions[trim($tag)] = true;
        }
    }
}
ksort($statusOptions);
ksort($tagOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $tagFilter) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $matchTag = $tagFilter === '' || in_array($tagFilter, array_map('trim', explode(',', $c['tags'] ?? '')));
    return $matchQuery && $matchStatus && $matchTag;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <select name="tag">
      <option value="">-- Tag --</option>
      <?php foreach (array_keys($tagOptions) as $tag): ?>
        <option value="<?= htmlspecialchars($tag) ?>" <?= $tag === $tagFilter ? 'selected' : '' ?>><?= htmlspecialchars($tag) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table-grid">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th>
            <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
              <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
              <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
            </a>
          </th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of enhanced_contact_list.php ---



--- Start of equipment_list.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Equipment Inventory';
$equipmentSchema = require __DIR__ . '/equipment_schema.php';
$equipment = readCSV('equipment.csv', $equipmentSchema) ?: [];
$customers = readCSV('customers.csv', require __DIR__ . '/customer_schema.php');
$contracts = readCSV('contracts.csv', require __DIR__ . '/contract_schema.php') ?: [];

// Calculate metrics
$totalEquipment = count($equipment);
$customerOwned = 0;
$evoquaLeased = 0;
$serviceDue = 0;
$today = strtotime(date('Y-m-d'));

foreach ($equipment as &$item) {
    // Count by ownership
    if ($item['ownership'] === 'Customer Owned') {
        $customerOwned++;
    } elseif (strpos($item['ownership'], 'Evoqua') !== false) {
        $evoquaLeased++;
    }
    
    // Check service due
    if (!empty($item['next_service_date'])) {
        $nextService = strtotime($item['next_service_date']);
        if ($nextService <= $today) {
            $serviceDue++;
            $item['service_status'] = 'overdue';
        } elseif ($nextService <= strtotime('+7 days')) {
            $serviceDue++;
            $item['service_status'] = 'due-soon';
        } else {
            $item['service_status'] = 'scheduled';
        }
    }
}
?>

<style>
.equipment-header {
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.equipment-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

/* Reuse metrics and table styling from contracts */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #8B5CF6;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    color: #1F2937;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-group select,
.filter-group input {
    padding: 10px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    border: none;
    font-size: 14px;
}

.btn-primary {
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.equipment-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.equipment-table table {
    width: 100%;
    border-collapse: collapse;
}

.equipment-table th {
    background: #F9FAFB;
    padding: 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #E5E7EB;
}

.equipment-table td {
    padding: 16px;
    border-bottom: 1px solid #F3F4F6;
    font-size: 14px;
}

.equipment-table tr:hover {
    background: #F9FAFB;
}

.ownership-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.ownership-customer {
    background: #DBEAFE;
    color: #1E40AF;
}

.ownership-evoqua {
    background: #FEF3C7;
    color: #92400E;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-active {
    background: #D1FAE5;
    color: #065F46;
}

.status-inactive {
    background: #FEE2E2;
    color: #991B1B;
}

.service-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
}

.service-scheduled {
    background: #D1FAE5;
    color: #065F46;
}

.service-due-soon {
    background: #FEF3C7;
    color: #92400E;
}

.service-overdue {
    background: #FEE2E2;
    color: #991B1B;
}

.action-btns {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}

.action-btn-view {
    background: #EFF6FF;
    color: #1E40AF;
}

.action-btn-view:hover {
    background: #DBEAFE;
}

.action-btn-service {
    background: #D1FAE5;
    color: #065F46;
}

.action-btn-service:hover {
    background: #A7F3D0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}
</style>

<div class="equipment-header">
    <h1>üîß Equipment Inventory</h1>
    <p>Track all customer equipment and Evoqua leased systems</p>
</div>

<!-- Metrics Dashboard -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total Equipment</div>
        <div class="metric-value"><?= $totalEquipment ?></div>
        <div class="metric-subtext">All tracked equipment</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Customer Owned</div>
        <div class="metric-value"><?= $customerOwned ?></div>
        <div class="metric-subtext">Equipment sold to customers</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Evoqua Leased</div>
        <div class="metric-value"><?= $evoquaLeased ?></div>
        <div class="metric-subtext">SDI service equipment</div>
    </div>
    
    <div class="metric-card <?= $serviceDue > 0 ? 'warning' : '' ?>">
        <div class="metric-label">Service Due</div>
        <div class="metric-value"><?= $serviceDue ?></div>
        <div class="metric-subtext">Needs service soon/overdue</div>
    </div>
</div>

<!-- Action Bar -->
<div class="action-bar">
    <div class="filter-group">
        <select id="ownershipFilter" onchange="filterEquipment()">
            <option value="">All Ownership</option>
            <option value="Customer Owned">Customer Owned</option>
            <option value="Evoqua Lease">Evoqua Lease</option>
            <option value="Evoqua Rental">Evoqua Rental</option>
        </select>
        
        <select id="typeFilter" onchange="filterEquipment()">
            <option value="">All Types</option>
            <option value="Softener">Softener</option>
            <option value="RO System">RO System</option>
            <option value="Filtration">Filtration</option>
            <option value="DI Tank">DI Tank</option>
        </select>
        
        <select id="statusFilter" onchange="filterEquipment()">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
        </select>
        
        <input type="text" id="searchInput" placeholder="Search equipment..." onkeyup="filterEquipment()">
    </div>
    
    <a href="equipment_form.php" class="btn btn-primary">‚ûï Add Equipment</a>
</div>

<!-- Equipment Table -->
<div class="equipment-table">
    <?php if (empty($equipment)): ?>
        <div class="empty-state">
            <div class="empty-state-icon">üîß</div>
            <h3>No Equipment Tracked Yet</h3>
            <p>Start by adding your first piece of equipment</p>
            <a href="equipment_form.php" class="btn btn-primary" style="margin-top: 20px;">‚ûï Add First Equipment</a>
        </div>
    <?php else: ?>
        <table id="equipmentTable">
            <thead>
                <tr>
                    <th>Equipment ID</th>
                    <th>Type</th>
                    <th>Model/Serial</th>
                    <th>Customer</th>
                    <th>Ownership</th>
                    <th>Install Date</th>
                    <th>Service Status</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($equipment as $item): ?>
                    <?php
                    // Find customer name
                    $customerName = 'Unknown';
                    foreach ($customers as $c) {
                        if ($c['customer_id'] === $item['customer_id']) {
                            $customerName = $c['contact_name'];
                            break;
                        }
                    }
                    
                    $ownershipClass = 'ownership-' . (strpos($item['ownership'], 'Customer') !== false ? 'customer' : 'evoqua');
                    $statusClass = 'status-' . strtolower($item['status'] ?? 'active');
                    $serviceClass = 'service-' . ($item['service_status'] ?? 'scheduled');
                    ?>
                    <tr data-ownership="<?= htmlspecialchars($item['ownership']) ?>" 
                        data-type="<?= htmlspecialchars($item['equipment_type']) ?>"
                        data-status="<?= htmlspecialchars($item['status'] ?? 'Active') ?>">
                        <td><strong><?= htmlspecialchars($item['equipment_id']) ?></strong></td>
                        <td><?= htmlspecialchars($item['equipment_type']) ?></td>
                        <td>
                            <?php if (!empty($item['model_number'])): ?>
                                <?= htmlspecialchars($item['model_number']) ?><br>
                                <small style="color: #6B7280;"><?= htmlspecialchars($item['serial_number']) ?></small>
                            <?php else: ?>
                                <?= htmlspecialchars($item['serial_number']) ?>
                            <?php endif; ?>
                        </td>
                        <td><?= htmlspecialchars($customerName) ?></td>
                        <td>
                            <span class="ownership-badge <?= $ownershipClass ?>">
                                <?= htmlspecialchars($item['ownership']) ?>
                            </span>
                        </td>
                        <td><?= htmlspecialchars($item['install_date']) ?></td>
                        <td>
                            <?php if (!empty($item['next_service_date'])): ?>
                                <span class="service-badge <?= $serviceClass ?>">
                                    <?php if ($item['service_status'] === 'overdue'): ?>
                                        ‚ö†Ô∏è Overdue
                                    <?php elseif ($item['service_status'] === 'due-soon'): ?>
                                        ‚è∞ Due Soon
                                    <?php else: ?>
                                        ‚úì <?= htmlspecialchars($item['next_service_date']) ?>
                                    <?php endif; ?>
                                </span>
                            <?php else: ?>
                                <span style="color: #9CA3AF;">Not scheduled</span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <span class="status-badge <?= $statusClass ?>">
                                <?= htmlspecialchars($item['status'] ?? 'Active') ?>
                            </span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <a href="equipment_view.php?id=<?= urlencode($item['equipment_id']) ?>" 
                                   class="action-btn action-btn-view">View</a>
                                <?php if ($item['service_status'] === 'overdue' || $item['service_status'] === 'due-soon'): ?>
                                    <a href="service_log.php?equipment_id=<?= urlencode($item['equipment_id']) ?>" 
                                       class="action-btn action-btn-service">Service Now</a>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>
</div>

<script>
function filterEquipment() {
    const ownershipFilter = document.getElementById('ownershipFilter').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const table = document.getElementById('equipmentTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const ownership = row.getAttribute('data-ownership').toLowerCase();
        const type = row.getAttribute('data-type').toLowerCase();
        const status = row.getAttribute('data-status').toLowerCase();
        const text = row.textContent.toLowerCase();
        
        let showRow = true;
        
        if (ownershipFilter && ownership !== ownershipFilter) showRow = false;
        if (typeFilter && type !== typeFilter) showRow = false;
        if (statusFilter && status !== statusFilter) showRow = false;
        if (searchInput && !text.includes(searchInput)) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
    }
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of equipment_list.php ---



--- Start of equipment_schema.php ---

<?php
/**
 * Equipment/Inventory Schema - Both Sales & SDI
 * Tracks all equipment (owned by customer or leased from Evoqua)
 */
return [
    'equipment_id',         // Unique identifier
    'equipment_type',       // Softener / RO System / Filtration / DI Tank / Other
    'manufacturer',         // Evoqua / Eclipse / Other
    'model_number',         // Equipment model
    'serial_number',        // Equipment serial number
    'ownership',            // Customer Owned / Evoqua Lease / Evoqua Rental
    'customer_id',          // Which customer has this equipment
    'contact_id',           // Primary contact for equipment
    'contract_id',          // Linked service contract (if SDI)
    'install_date',         // Installation date
    'purchase_date',        // Purchase date (if owned)
    'purchase_value',       // Original purchase price
    'location',             // Installation location/address
    'tank_size',            // For tanks - size in liters/gallons
    'resin_type',           // For tanks - type of resin
    'regeneration_id',      // Regeneration number
    'service_frequency',    // How often serviced
    'last_service_date',    // Most recent service
    'next_service_date',    // Scheduled next service
    'warranty_expiry',      // Warranty expiration date
    'status',               // Active / Inactive / Pending Removal / Removed
    'purchase_order',       // Original PO number
    'notes',                // Equipment notes
    'created_date',         // Record creation date
    'modified_date'         // Last modification date
];


--- End of equipment_schema.php ---



--- Start of error_handler.php ---

<?php
/**
 * Centralized Error Handling
 * Provides structured logging and user-friendly error messages
 */

// Ensure session started for error logging
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

define('ERROR_LOG_DIR', __DIR__ . '/logs');
define('ERROR_LOG_FILE', ERROR_LOG_DIR . '/errors.log');
define('ERROR_LOG_MAX_SIZE', 5242880); // 5MB

/**
 * Initialize error logging directory
 */
function initializeErrorLogging() {
    if (!is_dir(ERROR_LOG_DIR)) {
        if (!mkdir(ERROR_LOG_DIR, 0755, true)) {
            // Fallback to root directory if logs dir can't be created
            return false;
        }
    }
    return true;
}

/**
 * Log an error with structured format
 */
function logError($message, $context = [], $level = 'ERROR') {
    initializeErrorLogging();
    
    $timestamp = date('Y-m-d H:i:s');
    $userid = $_SESSION['user_id'] ?? 'anonymous';
    $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
    
    $logEntry = [
        'timestamp' => $timestamp,
        'level' => $level,
        'user_id' => $userid,
        'ip_address' => $ip,
        'message' => $message,
        'context' => $context,
        'uri' => $_SERVER['REQUEST_URI'] ?? '',
    ];
    
    // Format as JSON for structured logging
    $logLine = json_encode($logEntry) . "\n";
    
    // Write to log file
    if (file_exists(ERROR_LOG_FILE) && filesize(ERROR_LOG_FILE) > ERROR_LOG_MAX_SIZE) {
        // Rotate log if too large
        rename(ERROR_LOG_FILE, ERROR_LOG_FILE . '.' . date('YmdHis'));
    }
    
    @file_put_contents(ERROR_LOG_FILE, $logLine, FILE_APPEND);
}

/**
 * Log info messages
 */
function logInfo($message, $context = []) {
    logError($message, $context, 'INFO');
}

/**
 * Log warning messages
 */
function logWarning($message, $context = []) {
    logError($message, $context, 'WARNING');
}

/**
 * Display user-friendly error
 */
function showError($title, $message, $details = '') {
    ?>
    <div style="background:#fee; border:1px solid #c00; border-radius:4px; padding:20px; margin:20px 0; max-width:600px;">
        <h3 style="color:#c00; margin-top:0;">‚ö†Ô∏è <?= e($title) ?></h3>
        <p><?= e($message) ?></p>
        <?php if (!empty($details)): ?>
            <details style="margin-top:10px; font-size:0.9em; color:#666;">
                <summary>Technical details</summary>
                <pre style="background:#f5f5f5; padding:10px; border-radius:3px; overflow-x:auto;"><?= e($details) ?></pre>
            </details>
        <?php endif; ?>
        <p style="margin-bottom:0;">
            <a href="javascript:history.back()" style="color:#00a; text-decoration:none;">‚Üê Go back</a>
        </p>
    </div>
    <?php
}

/**
 * Display success message
 */
function showSuccess($message) {
    ?>
    <div style="background:#efe; border:1px solid #0a0; border-radius:4px; padding:15px; margin:20px 0;">
        <p style="color:#0a0; margin:0;">‚úì <?= e($message) ?></p>
    </div>
    <?php
}

/**
 * Display validation errors
 */
function showValidationErrors($errors) {
    if (empty($errors)) {
        return;
    }
    ?>
    <div style="background:#fee; border:1px solid #c66; border-radius:4px; padding:15px; margin:20px 0;">
        <p style="color:#c00; margin-top:0;"><strong>Please fix the following:</strong></p>
        <ul style="margin:10px 0; padding-left:20px;">
            <?php foreach ($errors as $field => $message): ?>
                <li>
                    <strong><?= e(ucfirst(str_replace('_', ' ', $field))) ?>:</strong>
                    <?= e($message) ?>
                </li>
            <?php endforeach; ?>
        </ul>
    </div>
    <?php
}

/**
 * Convert exception to user-friendly message
 */
function getErrorMessage($exception) {
    $message = $exception->getMessage();
    
    // Customize based on error type
    if (strpos($message, 'Duplicate email') !== false) {
        return 'This email address is already in use.';
    } elseif (strpos($message, 'File not found') !== false) {
        return 'System data file is missing. Please contact an administrator.';
    } elseif (strpos($message, 'Unable to acquire lock') !== false) {
        return 'System is busy. Please try again in a moment.';
    } else {
        return 'An unexpected error occurred. Please try again.';
    }
}

/**
 * Set custom error handler
 */
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    // Log PHP errors
    logError("PHP Error", [
        'error_code' => $errno,
        'error_string' => $errstr,
        'file' => $errfile,
        'line' => $errline,
    ]);
    
    // Don't execute default PHP error handler
    return true;
});

/**
 * Set exception handler
 */
set_exception_handler(function($e) {
    logError("Uncaught Exception", [
        'exception_class' => get_class($e),
        'message' => $e->getMessage(),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
    ]);
    
    // Display user-friendly message
    showError(
        'Something went wrong',
        getErrorMessage($e),
        $e->getFile() . ':' . $e->getLine() . ' - ' . $e->getMessage()
    );
    
    exit;
});

/**
 * Initialize logging on script start
 */
initializeErrorLogging();

?>


--- End of error_handler.php ---



--- Start of export_contacts.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';
require_once 'csv_export.php';
require_once 'error_handler.php';

$filename = 'contacts.csv';
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV($filename, $schema);

// Build filters from query string using schema
$filters = [];
foreach ($schema as $field) {
    if (!empty($_GET[$field])) {
        $filters[$field] = $_GET[$field];
    }
}

// Schema-safe export function
function exportCSVFiltered($filename, $rows, $filters = [], $schema = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered), $schema);
}

// Export filtered contacts to a new file
try {
    $exported = exportCSVFiltered('contacts_export.csv', $contacts, $filters, $schema);
    
    if ($exported) {
        $export_count = count(array_filter($contacts, function($row) use ($filters) {
            foreach ($filters as $key => $value) {
                if ($row[$key] !== $value) return false;
            }
            return true;
        }));
        
        logInfo('Contacts exported', ['count' => $export_count, 'filters' => json_encode($filters)]);
        
        // ‚úÖ AUDIT: Log export
        auditExport($export_count, $filters);
        
        echo "Export complete. " . $export_count . " contacts exported.";
    } else {
        echo "No matching contacts.";
        logWarning('Export found no matching contacts', ['filters' => json_encode($filters)]);
    }
} catch (Exception $e) {
    showError('Export failed', htmlspecialchars($e->getMessage()));
    logError('Contact export failed', ['exception' => $e->getMessage()]);
}
?>



--- End of export_contacts.php ---



--- Start of export_opportunities.php ---

<?php
require_once 'csv_handler.php';
require_once 'sanitize_helper.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Build contact lookup map
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $company = $contact['company'] ?? '';
    $contactMap[trim($contact['id'])] = [
        'name' => $fullName ?: 'Unnamed Contact',
        'company' => $company
    ];
}

// Get filter parameters
$filterStage = $_GET['stage'] ?? '';
$searchQuery = $_GET['search'] ?? '';

// Apply filters
$filteredOpportunities = $opportunities;

if ($filterStage) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($filterStage) {
        return ($opp['stage'] ?? '') === $filterStage;
    });
}

if ($searchQuery) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($searchQuery, $contactMap) {
        $contactId = trim($opp['contact_id'] ?? '');
        $contactName = $contactMap[$contactId]['name'] ?? '';
        $contactCompany = $contactMap[$contactId]['company'] ?? '';
        
        return stripos($contactName, $searchQuery) !== false ||
               stripos($contactCompany, $searchQuery) !== false ||
               stripos($opp['id'] ?? '', $searchQuery) !== false ||
               stripos($opp['stage'] ?? '', $searchQuery) !== false;
    });
}

// Set CSV headers
header('Content-Type: text/csv; charset=utf-8');
header('Content-Disposition: attachment; filename=opportunities_export_' . date('Y-m-d_His') . '.csv');

// Create output stream
$output = fopen('php://output', 'w');

// Write UTF-8 BOM for Excel compatibility
fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));

// Write headers
fputcsv($output, [
    'ID',
    'Contact Name',
    'Company',
    'Value',
    'Probability (%)',
    'Weighted Value',
    'Stage',
    'Expected Close Date'
]);

// Write data rows
foreach ($filteredOpportunities as $opp) {
    $contactId = trim($opp['contact_id'] ?? '');
    $contactInfo = $contactMap[$contactId] ?? ['name' => 'Unknown Contact', 'company' => ''];
    $value = floatval($opp['value'] ?? 0);
    $probability = floatval($opp['probability'] ?? 0);
    $weightedValue = $value * ($probability / 100);
    
    fputcsv($output, [
        $opp['id'] ?? '',
        $contactInfo['name'],
        $contactInfo['company'] ?: '‚Äî',
        number_format($value, 2),
        $probability,
        number_format($weightedValue, 2),
        $opp['stage'] ?? '',
        $opp['expected_close'] ?? '‚Äî'
    ]);
}

fclose($output);
exit;


--- End of export_opportunities.php ---



--- Start of follow_up_email.php ---

<?php
// follow_up_email.php

$contactName = $contact['name'] ?? 'there';
$companyName = $contact['company'] ?? 'your team';
$contactEmail = $contact['email'] ?? '';
$contactId = $contact['id'] ?? 0;
?>

<div class="module follow-up-email">
  <h3>Send Email</h3>
  <button onclick="generateEmail('followup')">Follow-Up After Call</button>
  <button onclick="generateEmail('intro')">Introductory Email</button>
  <button onclick="generateEmail('touchbase')">Touch Base Email</button>
  <button id="sendEmailBtn" onclick="sendFollowUpEmail()">Send Email</button>

  <textarea id="followUpEmail" rows="12" class="email-textarea"></textarea>
</div>

<script>
const contactName = "<?= htmlspecialchars($contactName, ENT_QUOTES) ?>";
const contactEmail = "<?= htmlspecialchars($contactEmail, ENT_QUOTES) ?>";
let currentEmailType = '';

function generateEmail(type) {
  currentEmailType = type;

  let body = '';
  switch (type) {
    case 'followup':
      body = `Hi ${contactName},

It was great speaking with you earlier. I wanted to follow up on our conversation and thank you for taking the time to connect.

At Eclipse Water Technologies, we‚Äôre committed to providing responsive, local service without the delays or complications of cross-border logistics. Whether it‚Äôs a complex treatment challenge or a routine system check, our team is here to support you.

If you have any questions or would like to explore next steps, feel free to reach out anytime.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'intro':
      body = `Hi ${contactName},

I wanted to introduce you to Eclipse Water Technologies ‚Äî a local provider of industrial water and wastewater solutions.

We specialize in everything from advanced treatment systems to simple filter replacements, and our team is known for responsive service and technical expertise. Being local means no border delays or tariffs ‚Äî just fast, reliable support.

We‚Äôd love to learn more about your needs and explore how we can help.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'touchbase':
      body = `Hi ${contactName},

I hope things are going well on your end. I just wanted to touch base and see if there‚Äôs anything you might need support with regarding your water or wastewater systems.

At Eclipse Water Technologies, we‚Äôre always happy to reconnect and help ‚Äî whether it‚Äôs a quick filter change or a more involved project.

Feel free to reach out anytime if you'd like to chat or explore options.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;
  }

  document.getElementById('followUpEmail').value = body;
}

function sendFollowUpEmail() {
  const emailBody = document.getElementById('followUpEmail').value.trim();
  const subjectLine = "Industrial Water Treatment - Eclipse Water Technologies";

  if (!contactEmail) {
    alert("No email address found for this contact.");
    return;
  }

  if (!emailBody) {
    alert("Email body is empty. Please generate or write your message.");
    return;
  }

  const mailtoLink = `mailto:${contactEmail}?subject=${encodeURIComponent(subjectLine)}&body=${encodeURIComponent(emailBody)}`;
  window.location.href = mailtoLink;
}
</script>

--- End of follow_up_email.php ---



--- Start of forecast_calc.php ---

<?php
require_once 'csv_handler.php';

function calculateForecasts($filename = 'opportunities.csv') {
    $schema = require __DIR__ . '/opportunity_schema.php';
    $opportunities = readCSV($filename, $schema);
    $results = [];
    $stageTotals = [];

    foreach ($opportunities as $opp) {
        $value = floatval($opp['value']);
        $probability = floatval($opp['probability']);
        $forecast = round($value * ($probability / 100), 2);

        $stage = $opp['stage'] ?? 'Unspecified';

        // Add to grouped stage totals
        if (!isset($stageTotals[$stage])) {
            $stageTotals[$stage] = ['count' => 0, 'total_forecast' => 0];
        }
        $stageTotals[$stage]['count']++;
        $stageTotals[$stage]['total_forecast'] += $forecast;

        // Add to individual forecast list
        $results[] = [
            'id' => $opp['id'] ?? '',
            'contact_id' => $opp['contact_id'] ?? '',
            'stage' => $stage,
            'value' => $value,
            'forecast' => $forecast
        ];
    }

    return [
        'individual' => $results,
        'by_stage' => $stageTotals
    ];
}
?>


--- End of forecast_calc.php ---



--- Start of get_oauth_token.php ---

<?php


require_once 'contact_validator.php';/**
 * PHPMailer - PHP email creation and transport class.
 * PHP Version 5.5
 * @package PHPMailer
 * @see https://github.com/PHPMailer/PHPMailer/ The PHPMailer GitHub project
 * @author Marcus Bointon (Synchro/coolbru) <phpmailer@synchromedia.co.uk>
 * @author Jim Jagielski (jimjag) <jimjag@gmail.com>
 * @author Andy Prevost (codeworxtech) <codeworxtech@users.sourceforge.net>
 * @author Brent R. Matzelle (original founder)
 * @copyright 2012 - 2020 Marcus Bointon
 * @copyright 2010 - 2012 Jim Jagielski
 * @copyright 2004 - 2009 Andy Prevost
 * @license https://www.gnu.org/licenses/old-licenses/lgpl-2.1.html GNU Lesser General Public License
 * @note This program is distributed in the hope that it will be useful - WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.
 */

/**
 * Get an OAuth2 token from an OAuth2 provider.
 * * Install this script on your server so that it's accessible
 * as [https/http]://<yourdomain>/<folder>/get_oauth_token.php
 * e.g.: http://localhost/phpmailer/get_oauth_token.php
 * * Ensure dependencies are installed with 'composer install'
 * * Set up an app in your Google/Yahoo/Microsoft account
 * * Set the script address as the app's redirect URL
 * If no refresh token is obtained when running this file,
 * revoke access to your app and run the script again.
 */

namespace PHPMailer\PHPMailer;

/**
 * Aliases for League Provider Classes
 * Make sure you have added these to your composer.json and run `composer install`
 * Plenty to choose from here:
 * @see https://oauth2-client.thephpleague.com/providers/thirdparty/
 */
//@see https://github.com/thephpleague/oauth2-google
use League\OAuth2\Client\Provider\Google;
//@see https://packagist.org/packages/hayageek/oauth2-yahoo
use Hayageek\OAuth2\Client\Provider\Yahoo;
//@see https://github.com/stevenmaguire/oauth2-microsoft
use Stevenmaguire\OAuth2\Client\Provider\Microsoft;
//@see https://github.com/greew/oauth2-azure-provider
use Greew\OAuth2\Client\Provider\Azure;

if (!isset($_GET['code']) && !isset($_POST['provider'])) {
    ?>
<html>
<body>
<form method="post">
    <h1>Select Provider</h1>
    <input type="radio" name="provider" value="Google" id="providerGoogle">
    <label for="providerGoogle">Google</label><br>
    <input type="radio" name="provider" value="Yahoo" id="providerYahoo">
    <label for="providerYahoo">Yahoo</label><br>
    <input type="radio" name="provider" value="Microsoft" id="providerMicrosoft">
    <label for="providerMicrosoft">Microsoft</label><br>
    <input type="radio" name="provider" value="Azure" id="providerAzure">
    <label for="providerAzure">Azure</label><br>
    <h1>Enter id and secret</h1>
    <p>These details are obtained by setting up an app in your provider's developer console.
    </p>
    <p>ClientId: <input type="text" name="clientId"><p>
    <p>ClientSecret: <input type="text" name="clientSecret"></p>
    <p>TenantID (only relevant for Azure): <input type="text" name="tenantId"></p>
    <input type="submit" value="Continue">
</form>
<?php include 'layout_end.php'; ?>
</body>
</html>
    <?php
    exit;
}

require 'vendor/autoload.php';

session_start();

$providerName = '';
$clientId = '';
$clientSecret = '';
$tenantId = '';

if (array_key_exists('provider', $_POST)) {
    $providerName = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST['provider'];
    $clientId = $_POST['clientId'];
    $clientSecret = $_POST['clientSecret'];
    $tenantId = $_POST['tenantId'];
    $_SESSION['provider'] = $providerName;
    $_SESSION['clientId'] = $clientId;
    $_SESSION['clientSecret'] = $clientSecret;
    $_SESSION['tenantId'] = $tenantId;
} elseif (array_key_exists('provider', $_SESSION)) {
    $providerName = $_SESSION['provider'];
    $clientId = $_SESSION['clientId'];
    $clientSecret = $_SESSION['clientSecret'];
    $tenantId = $_SESSION['tenantId'];
}

//If you don't want to use the built-in form, set your client id and secret here
//$clientId = 'RANDOMCHARS-----duv1n2.apps.googleusercontent.com';
//$clientSecret = 'RANDOMCHARS-----lGyjPcRtvP';

//If this automatic URL doesn't work, set it yourself manually to the URL of this script
$redirectUri = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'];
//$redirectUri = 'http://localhost/PHPMailer/redirect';

$params = [
    'clientId' => $clientId,
    'clientSecret' => $clientSecret,
    'redirectUri' => $redirectUri,
    'accessType' => 'offline'
];

$options = [];
$provider = null;

switch ($providerName) {
    case 'Google':
        $provider = new Google($params);
        $options = [
            'scope' => [
                'https://mail.google.com/'
            ]
        ];
        break;
    case 'Yahoo':
        $provider = new Yahoo($params);
        break;
    case 'Microsoft':
        $provider = new Microsoft($params);
        $options = [
            'scope' => [
                'wl.imap',
                'wl.offline_access'
            ]
        ];
        break;
    case 'Azure':
        $params['tenantId'] = $tenantId;

        $provider = new Azure($params);
        $options = [
            'scope' => [
                'https://outlook.office.com/SMTP.Send',
                'offline_access'
            ]
        ];
        break;
}

if (null === $provider) {
    exit('Provider missing');
}

if (!isset($_GET['code'])) {
    //If we don't have an authorization code then get one
    $authUrl = $provider->getAuthorizationUrl($options);
    $_SESSION['oauth2state'] = $provider->getState();
    header('Location: ' . $authUrl);
    exit;
    //Check given state against previously stored one to mitigate CSRF attack
} elseif (empty($_GET['state']) || ($_GET['state'] !== $_SESSION['oauth2state'])) {
    unset($_SESSION['oauth2state']);
    unset($_SESSION['provider']);
    exit('Invalid state');
} else {
    unset($_SESSION['provider']);
    //Try to get an access token (using the authorization code grant)
    $token = $provider->getAccessToken(
        'authorization_code',
        [
            'code' => $_GET['code']
        ]
    );
    //Use this to interact with an API on the users behalf
    //Use this to get a new access token if the old one expires
    echo 'Refresh Token: ', htmlspecialchars($token->getRefreshToken());
}


--- End of get_oauth_token.php ---



--- Start of get_tasks.php ---

<
<?php
$filename = 'tasks.csv';

if (!file_exists($filename)) {
    echo '<li>No tasks found.</li>';
    exit;
}

$tasks = [];

if (($fp = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($fp); // Read header row
    while (($row = fgetcsv($fp)) !== false) {
        if (empty($row) || count($row) < count($headers)) continue;
        $task = array_combine($headers, $row);
        if ($task['status'] !== 'archived') {
            $id = htmlspecialchars($task['id']);
            $title = htmlspecialchars($task['title']);
            $timestamp = htmlspecialchars($task['timestamp']);
            $tasks[] = "<li>$title (Created: $timestamp) <button onclick=\"archiveTask('$id')\">Archive</button></li>";
        }
    }
    fclose($fp);
}

echo '<ul>' . implode('', $tasks) . '</ul>';
?>
!R0b9052597723

--- End of get_tasks.php ---



--- Start of import_contacts.php ---

<?php
$pageTitle = 'Import Contacts';
$currentPage = basename(__FILE__);
include_once 'layout_start.php';
require_once 'csv_handler.php';
require_once 'contact_validator.php';

$schema = require __DIR__ . '/contact_schema.php';

// Constants for import validation
define('MAX_BATCH_SIZE', 1000);
define('MAX_FILE_SIZE', 5242880); // 5MB

?>

<div class="container">
  <h2>Import Contacts</h2>

  <!-- Upload Form with CSRF Token -->
  <form method="POST" enctype="multipart/form-data" class="contact-form">
    <?php echo renderCSRFInput(); ?>
    <label for="csv_file">Upload CSV File:</label>
    <input type="file" name="csv_file" accept=".csv" required>
    <small style="display:block; margin-top:5px; color:#666;">Max size: 5MB, Max rows: <?php echo MAX_BATCH_SIZE; ?></small>

    <!-- Buttons aligned horizontally -->
    <div style="margin-top: 10px;">
      <button type="submit">Preview Import</button>
      <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name']) && isset($_SESSION['import_valid']) && $_SESSION['import_valid'] === true): ?>
        <button type="button" class="btn-confirm" onclick="showConfirmModal()">Commit Import</button>
      <?php endif; ?>
    </div>
  </form>

  <?php
  // Initialize import validation status
  $_SESSION['import_valid'] = false;
  
  if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file'])) {
      // CSRF protection
      if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
          showError('CSRF token validation failed. Please try again.');
      } elseif (!is_uploaded_file($_FILES['csv_file']['tmp_name'])) {
          showError('Invalid file upload.');
      } elseif ($_FILES['csv_file']['size'] > MAX_FILE_SIZE) {
          showError('File size exceeds 5MB limit.');
      } else {
          $tmp = $_FILES['csv_file']['tmp_name'];
          
          // Read CSV and validate structure
          $rows = array_map('str_getcsv', file($tmp));
          if (empty($rows)) {
              showError('CSV file is empty.');
          } else {
              $header = array_map('trim', array_shift($rows));
              
              // Check batch size
              if (count($rows) > MAX_BATCH_SIZE) {
                  showError('Import contains ' . count($rows) . ' rows. Maximum allowed: ' . MAX_BATCH_SIZE . ' rows.');
              } else {
                  // Validate each contact
                  $preview = [];
                  $validation_errors = [];
                  $duplicate_emails = [];
                  $existing_emails = [];
                  $row_number = 2; // CSV rows start at 2 (after header)
                  
                  // Load existing emails for duplicate checking
                  if (file_exists('contacts.csv')) {
                      $existing_contacts = readCSV('contacts.csv');
                      $existing_emails = array_column($existing_contacts, 'email');
                  }
                  
                  foreach ($rows as $row) {
                      $contact = array_combine($header, $row);
                      
                      // Field existence check
                      foreach ($schema as $field) {
                          if (!isset($contact[$field])) {
                              $contact[$field] = '';
                          }
                      }
                      
                      // Sanitize contact data
                      $contact = sanitizeContact($contact);
                      $contact['id'] = uniqid();
                      
                      // Validate contact
                      $contact_errors = validateContact($contact);
                      if (!empty($contact_errors)) {
                          $validation_errors[$row_number] = $contact_errors;
                      }
                      
                      // Check for duplicate email
                      if (!empty($contact['email'])) {
                          $email_lower = strtolower($contact['email']);
                          if (in_array($email_lower, $existing_emails, true)) {
                              $duplicate_emails[$row_number] = $contact['email'];
                          } elseif (isset($duplicate_emails[$row_number])) {
                              // Email is duplicate within import itself
                              if (!in_array($email_lower, array_column($preview, 'email'), true)) {
                                  // First occurrence, add to preview
                                  $preview[] = $contact;
                              } else {
                                  // Duplicate within this import
                                  $duplicate_emails[$row_number] = $contact['email'];
                              }
                          } else {
                              $preview[] = $contact;
                          }
                      } else {
                          $preview[] = $contact;
                      }
                      
                      $row_number++;
                  }
                  
                  // Display validation summary
                  $total_rows = count($rows);
                  $valid_rows = count($preview) - count($validation_errors);
                  $error_count = count($validation_errors) + count($duplicate_emails);
                  
                  echo "<div style='margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 4px;'>";
                  echo "<h3>Import Summary</h3>";
                  echo "<p><strong>Total rows:</strong> " . $total_rows . "</p>";
                  echo "<p><strong>Valid rows:</strong> <span style='color: green;'>" . $valid_rows . "</span></p>";
                  echo "<p><strong>Issues found:</strong> <span style='color: " . ($error_count > 0 ? 'red' : 'green') . ";'>" . $error_count . "</span></p>";
                  
                  if (empty($validation_errors) && empty($duplicate_emails)) {
                      echo "<p style='color: green; font-weight: bold;'>‚úì All contacts are valid and ready to import</p>";
                      $_SESSION['import_valid'] = true;
                  } else {
                      echo "<p style='color: orange; font-weight: bold;'>‚ö† Please review issues below before importing</p>";
                  }
                  echo "</div>";
                  
                  // Display validation errors
                  if (!empty($validation_errors) || !empty($duplicate_emails)) {
                      echo "<div style='margin-top: 15px; padding: 15px; background-color: #ffe6e6; border-radius: 4px; border-left: 4px solid #cc0000;'>";
                      echo "<h3>Issues Found</h3>";
                      
                      if (!empty($validation_errors)) {
                          echo "<p><strong>Validation Errors:</strong></p>";
                          echo "<ul>";
                          foreach ($validation_errors as $row_num => $errors) {
                              echo "<li><strong>Row " . $row_num . ":</strong> " . implode(", ", $errors) . "</li>";
                          }
                          echo "</ul>";
                      }
                      
                      if (!empty($duplicate_emails)) {
                          echo "<p><strong>Duplicate Emails (already exist or repeated in import):</strong></p>";
                          echo "<ul>";
                          foreach ($duplicate_emails as $row_num => $email) {
                              echo "<li><strong>Row " . $row_num . ":</strong> " . htmlspecialchars($email) . "</li>";
                          }
                          echo "</ul>";
                      }
                      echo "</div>";
                  }
                  
                  // Display preview table only for valid contacts
                  if (!empty($preview)) {
                      echo "<h3 style='margin-top: 20px;'>Preview - Valid Contacts (" . count($preview) . ")</h3>";
                      echo "<form method='POST' action='commit_import.php' id='commitForm'>";
                      echo renderCSRFInput();
                      echo "<table class='spec-table' style='font-size: 12px;'><thead><tr>";
                      foreach ($schema as $col) {
                          echo "<th>" . htmlspecialchars(ucfirst(str_replace('_', ' ', $col))) . "</th>";
                      }
                      echo "</tr></thead><tbody>";
                      foreach ($preview as $contact) {
                          echo "<tr>";
                          foreach ($schema as $col) {
                              $value = $contact[$col] ?? '';
                              echo "<td>" . htmlspecialchars(substr($value, 0, 50)) . (strlen($value) > 50 ? '...' : '') . "</td>";
                          }
                          echo "</tr>";
                      }
                      echo "</tbody></table>";
                      echo "</form>";
                      
                      $_SESSION['import_preview'] = $preview;
                  }
              }
          }
      }
  }
  ?>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Confirm Import</h3>
    <p>This will permanently add these contacts to the system. Proceed?</p>
    <button onclick="document.getElementById('commitForm').submit()">Yes, Commit</button>
    <button onclick="hideConfirmModal()">Cancel</button>
  </div>
</div>

<!-- Modal Styles & Script -->
<style>
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
}
.modal-box {
  background: #fff; padding: 20px 30px; border-radius: 8px; text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.modal-box button {
  margin: 10px; padding: 8px 16px; border: none; border-radius: 4px;
  background: #0077cc; color: #fff; cursor: pointer;
}
.modal-box button:hover {
  background: #005fa3;
}
</style>

<script>
function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
}
</script>

<?php include_once 'layout_end.php'; ?>


--- End of import_contacts.php ---



--- Start of index.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

require_once 'layout_start.php';
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];
$tasks = readCSV($filename, $schema);

$statusFilter = isset($_GET['status']) ? $_GET['status'] : '';
$year = isset($_GET['year']) ? $_GET['year'] : date('Y');
$month = isset($_GET['month']) ? $_GET['month'] : date('m');

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        if ($statusFilter === '' || $task['status'] === $statusFilter) {
            $tasksByDate[$task['due_date']][] = $task;
        }
    }
}

$prevMonth = $month - 1;
$prevYear = $year;
if ($prevMonth < 1) {
    $prevMonth = 12;
    $prevYear--;
}

$nextMonth = $month + 1;
$nextYear = $year;
if ($nextMonth > 12) {
    $nextMonth = 1;
    $nextYear++;
}
?>

<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }
  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }
  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }
  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>

<h2>Task Calendar</h2>

<div style="text-align:center; margin-bottom:20px;">
  <a href="?year=<?= $prevYear ?>&month=<?= str_pad($prevMonth, 2, '0', STR_PAD_LEFT) ?>">‚Üê Previous</a>
  <strong><?= date('F Y', strtotime("$year-$month-01")) ?></strong>
  <a href="?year=<?= $nextYear ?>&month=<?= str_pad($nextMonth, 2, '0', STR_PAD_LEFT) ?>">Next ‚Üí</a>
</div>

<form method="GET" style="margin-bottom: 20px;">
  <label for="status">Filter by status:</label>
  <select name="status" id="status" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="pending" <?= $statusFilter === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $statusFilter === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <input type="hidden" name="year" value="<?= $year ?>">
  <input type="hidden" name="month" value="<?= $month ?>">
</form>

<h3>Add New Task</h3>
<form method="POST" action="add_task.php" onsubmit="return validateForm()">
  <input type="text" name="title" id="title" placeholder="Task Title" required>
  <input type="date" name="due_date" id="due_date" required>
  <select name="status" id="status" required>
    <option value="">Select Status</option>
    <option value="pending">Pending</option>
    <option value="completed">Completed</option>
  </select>
  <button type="submit">Add Task</button>
</form>

<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
<?php
$daysInMonth = date('t', strtotime("$year-$month-01"));
$firstDayOfMonth = date('w', strtotime("$year-$month-01"));

$day = 1;
$week = [];

for ($i = 0; $i < $firstDayOfMonth; $i++) {
    $week[] = "<td></td>";
}

while ($day <= $daysInMonth) {
    $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
    if (isset($tasksByDate[$dateStr])) {
        $taskTitles = '';
        foreach ($tasksByDate[$dateStr] as $task) {
            $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
            $taskTitles .= "edit_task.php?timestamp=Edit</a> | ";
            $taskTitles .= "delete_task.php?timestamp=Delete</a><br><br>";
        }
        $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
    } else {
        $week[] = "<td>$day</td>";
    }

    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;
}


    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;

if (!empty($week)) {
    while (count($week) < 7) {
        $week[] = "<td></td>";
    }
    echo "<tr>" . implode('', $week) . "</tr>";
}
?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}

function validateForm() {
  const title = document.getElementById('title').value.trim();
  const dueDate = document.getElementById('due_date').value;
  const status = document.getElementById('status').value;

  if (title === '') {
    alert('Please enter a task title.');
    return false;
  }

  if (dueDate === '') {
    alert('Please select a due date.');
    return false;
  }

  if (status === '') {
    alert('Please select a status.');
    return false;
  }

  return true;
}
</script>

<?php include 'layout_end.php'; ?>


--- End of index.php ---



--- Start of inject_ids.php ---

<?php
function injectIdsIntoCsv($inputFile, $outputFile, $idPrefix = 'CNT') {
    $rows = array_map('str_getcsv', file($inputFile));
    $header = $rows[0];

    // Add ID column if missing
    if (!in_array('id', $header)) {
        array_unshift($header, 'id');
    }

    $newRows = [$header];
    for ($i = 1; $i < count($rows); $i++) {
        $row = $rows[$i];
        $id = $idPrefix . '_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
        array_unshift($row, $id);
        $newRows[] = $row;
    }

    // Write to output file
    $fp = fopen($outputFile, 'w');
    foreach ($newRows as $fields) {
        fputcsv($fp, $fields);
    }
    fclose($fp);
}


--- End of inject_ids.php ---



--- Start of inventory_add.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$errors = [];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $newItem = [];
  foreach ($schema as $f) {
    $newItem[$f] = trim($_POST[$f] ?? '');
  }
  // Always auto-generate item_id
  $newItem['item_id'] = uniqid('ITM_');
  $newItem['created_at'] = date('Y-m-d H:i:s');
  $newItem['updated_at'] = date('Y-m-d H:i:s');
  // Load and append
  $items = readCSV($inventoryFile, $schema);
  $items[] = $newItem;
  writeCSV($inventoryFile, $items, $schema);
  header('Location: inventory_list.php');
  exit;
}
?>
<div class="container">
  <h2>Add Inventory Item</h2>
  <form method="post" style="max-width:900px; margin:auto;">
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:18px;">
      <?php foreach ($schema as $f):
        if (in_array($f, ['created_at','updated_at'])) continue;
        $readonly = $f === 'item_id' ? 'readonly' : '';
        $value = '';
        if ($f === 'item_id') {
          $value = uniqid('ITM_');
        } else {
          $value = htmlspecialchars($_POST[$f] ?? '');
        }
      ?>
        <div style="display:flex; flex-direction:column;">
          <label for="<?= $f ?>" style="font-weight:600; margin-bottom:2px;"> <?= htmlspecialchars(ucwords(str_replace('_',' ',$f))) ?> </label>
          <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= $value ?>" style="padding:5px; border-radius:4px; border:1px solid #bbb;" <?= $readonly ?> >
        </div>
      <?php endforeach; ?>
    </div>
    <div style="margin-top:24px; text-align:center;">
      <button type="submit" class="btn-primary">üíæ Save Item</button>
      <a href="inventory_list.php" class="btn-outline">Cancel</a>
    </div>
  </form>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of inventory_add.php ---



--- Start of inventory_ledger.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$ledger = readCSV('inventory_ledger.csv', $schema);

// Display inventory ledger
?>
<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$inventory = readCSV($inventoryFile, $inventorySchema);

$customerSchema = require __DIR__ . '/customer_schema.php';
$customersFile = __DIR__ . '/customers.csv';
$customers = readCSV($customersFile, $customerSchema);

$statusFile = __DIR__ . '/inventory_status_options.csv';
$ledgerFile = __DIR__ . '/inventory_ledger.csv';
$serialsFile = __DIR__ . '/inventory_serials.csv';

function read_status_options($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $options = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    while (($row = fgetcsv($handle)) !== false) {
      $value = trim($row[0] ?? '');
      if ($value !== '') {
        $options[] = $value;
      }
    }
    fclose($handle);
  }
  return array_values(array_unique($options));
}

function read_ledger($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_ledger_row($filename, $row) {
  $headers = ['item_id','item_name','quantity','status','action','client_id','client_name','serial_number','note','created_at'];
  $fileExists = file_exists($filename);
  $file = fopen($filename, 'a');
  if ($file === false) {
    return;
  }
  if (!$fileExists) {
    fputcsv($file, $headers);
  }
  $line = [];
  foreach ($headers as $header) {
    $line[] = $row[$header] ?? '';
  }
  fputcsv($file, $line);
  fclose($file);
}

function read_serials($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_serials($filename, $rows) {
  $headers = ['serial_number','item_id','item_name','status','client_id','client_name','assigned_at','note'];
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, $headers);
  foreach ($rows as $row) {
    $line = [];
    foreach ($headers as $header) {
      $line[] = $row[$header] ?? '';
    }
    fputcsv($file, $line);
  }
  fclose($file);
}

function write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $status, $clientId, $clientName, $note, $action) {
  $row = [
    'item_id' => $itemId,
    'item_name' => $itemName,
    'quantity' => '1',
    'status' => $status,
    'action' => $action,
    'client_id' => $clientId,
    'client_name' => $clientName,
    'serial_number' => $serialNumber,
    'note' => $note,
    'created_at' => date('Y-m-d H:i:s')
  ];
  write_ledger_row($ledgerFile, $row);
}

function find_item_name($inventory, $itemId) {
  foreach ($inventory as $row) {
    if (($row['item_id'] ?? '') === $itemId) {
      return $row['item_name'] ?? '';
    }
  }
  return '';
}

function build_customer_pairs($customers) {
  $pairs = [];
  foreach ($customers as $row) {
    $id = trim($row['customer_id'] ?? '');
    $name = trim($row['contact_name'] ?? '');
    if ($id === '' && $name === '') {
      continue;
    }
    $pairs[] = [
      'id' => $id,
      'name' => $name !== '' ? $name : $id
    ];
  }
  return $pairs;
}

$customerPairs = build_customer_pairs($customers);

$errors = [];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_ledger'])) {
  $itemId = trim($_POST['item_id'] ?? '');
  $itemName = trim($_POST['item_name'] ?? '');
  $quantity = trim($_POST['quantity'] ?? '');
  $status = trim($_POST['status'] ?? '');
  $action = trim($_POST['action'] ?? '');
  $clientId = trim($_POST['client_id'] ?? '');
  $clientName = trim($_POST['client_name'] ?? '');
  $serialNumber = trim($_POST['serial_number'] ?? '');
  $note = trim($_POST['note'] ?? '');

  if ($itemId === '' && $itemName === '') {
    $errors[] = 'Item ID or Item Name is required.';
  }
  if ($itemName === '' && $itemId !== '') {
    $itemName = find_item_name($inventory, $itemId);
  }
  if (!is_numeric($quantity)) {
    $errors[] = 'Quantity must be a number.';
  }
  if ($status === '') {
    $errors[] = 'Status is required.';
  }

  if (empty($errors)) {
    $row = [
      'item_id' => $itemId,
      'item_name' => $itemName,
      'quantity' => $quantity,
      'status' => $status,
      'action' => $action,
      'client_id' => $clientId,
      'client_name' => $clientName,
      'serial_number' => $serialNumber,
      'note' => $note,
      'created_at' => date('Y-m-d H:i:s')
    ];
    write_ledger_row($ledgerFile, $row);
    header('Location: inventory_ledger.php');
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_serial'])) {
  $serialNumber = trim($_POST['serial_number'] ?? '');
  $itemId = trim($_POST['serial_item_id'] ?? '');
  $itemName = trim($_POST['serial_item_name'] ?? '');
  $status = trim($_POST['serial_status'] ?? '');
  $clientId = trim($_POST['serial_client_id'] ?? '');
  $clientName = trim($_POST['serial_client_name'] ?? '');
  $note = trim($_POST['serial_note'] ?? '');

  if ($serialNumber === '') {
    $errors[] = 'Serial number is required.';
  }
  if ($itemName === '' && $itemId !== '') {
    $itemName = find_item_name($inventory, $itemId);
  }

  if (empty($errors)) {
    if (($clientId !== '' || $clientName !== '') && $status === '') {
      $status = 'Assigned';
    }
    if ($status === '') {
      $status = 'Stock';
    }
    $serials = read_serials($serialsFile);
    $updated = false;
    $assignedAt = ($clientId !== '' || $clientName !== '') ? date('Y-m-d H:i:s') : '';

    foreach ($serials as &$row) {
      if (($row['serial_number'] ?? '') === $serialNumber) {
        $row['item_id'] = $itemId;
        $row['item_name'] = $itemName;
        $row['status'] = $status;
        $row['client_id'] = $clientId;
        $row['client_name'] = $clientName;
        $row['assigned_at'] = $assignedAt;
        $row['note'] = $note;
        $updated = true;
        break;
      }
    }
    unset($row);

    if (!$updated) {
      $serials[] = [
        'serial_number' => $serialNumber,
        'item_id' => $itemId,
        'item_name' => $itemName,
        'status' => $status,
        'client_id' => $clientId,
        'client_name' => $clientName,
        'assigned_at' => $assignedAt,
        'note' => $note
      ];
    }

    write_serials($serialsFile, $serials);
    $action = ($clientId !== '' || $clientName !== '') ? 'Assign' : 'Move';
    write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $status, $clientId, $clientName, $note, $action);
    header('Location: inventory_ledger.php');
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_serial'])) {
  $serialNumber = trim($_POST['serial_number'] ?? '');
  $status = trim($_POST['update_status'] ?? '');
  $clientId = trim($_POST['update_client_id'] ?? '');
  $clientName = trim($_POST['update_client_name'] ?? '');
  $note = trim($_POST['update_note'] ?? '');

  if ($serialNumber === '') {
    $errors[] = 'Serial number is required for update.';
  }

  if (empty($errors)) {
    if (($clientId !== '' || $clientName !== '') && $status === '') {
      $status = 'Assigned';
    }
    $serials = read_serials($serialsFile);
    $updated = false;
    $itemId = '';
    $itemName = '';
    $finalStatus = $status;

    foreach ($serials as &$row) {
      if (($row['serial_number'] ?? '') === $serialNumber) {
        $itemId = $row['item_id'] ?? '';
        $itemName = $row['item_name'] ?? '';
        $finalStatus = $status !== '' ? $status : ($row['status'] ?? '');
        $row['status'] = $finalStatus;
        $row['client_id'] = $clientId;
        $row['client_name'] = $clientName;
        $row['assigned_at'] = ($clientId !== '' || $clientName !== '') ? date('Y-m-d H:i:s') : '';
        $row['note'] = $note;
        $updated = true;
        break;
      }
    }
    unset($row);

    if ($updated) {
      write_serials($serialsFile, $serials);
      $action = ($clientId !== '' || $clientName !== '') ? 'Assign' : 'Move';
      write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $finalStatus, $clientId, $clientName, $note, $action);
    }
    header('Location: inventory_ledger.php');
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['rfid_scan'])) {
  $serialNumber = trim($_POST['rfid_serial_number'] ?? '');
  $status = trim($_POST['rfid_status'] ?? '');
  $clientId = trim($_POST['rfid_client_id'] ?? '');
  $clientName = trim($_POST['rfid_client_name'] ?? '');
  $note = trim($_POST['rfid_note'] ?? '');
  $itemId = trim($_POST['rfid_item_id'] ?? '');
  $itemName = trim($_POST['rfid_item_name'] ?? '');

  if ($serialNumber === '') {
    $errors[] = 'RFID scan requires a serial number.';
  }

  if ($itemName === '' && $itemId !== '') {
    $itemName = find_item_name($inventory, $itemId);
  }

  if (empty($errors)) {
    if (($clientId !== '' || $clientName !== '') && $status === '') {
      $status = 'Assigned';
    }
    $serials = read_serials($serialsFile);
    $updated = false;
    $assignedAt = ($clientId !== '' || $clientName !== '') ? date('Y-m-d H:i:s') : '';

    foreach ($serials as &$row) {
      if (($row['serial_number'] ?? '') === $serialNumber) {
        if ($status !== '') {
          $row['status'] = $status;
        }
        if ($clientId !== '' || $clientName !== '') {
          $row['client_id'] = $clientId;
          $row['client_name'] = $clientName;
          $row['assigned_at'] = $assignedAt;
        }
        if ($note !== '') {
          $row['note'] = $note;
        }
        $itemId = $row['item_id'] ?? $itemId;
        $itemName = $row['item_name'] ?? $itemName;
        $status = $row['status'] ?? $status;
        $updated = true;
        break;
      }
    }
    unset($row);

    if (!$updated) {
      if ($itemId === '' && $itemName === '') {
        $errors[] = 'New serial requires item ID or item name.';
      } else {
        $serials[] = [
          'serial_number' => $serialNumber,
          'item_id' => $itemId,
          'item_name' => $itemName,
          'status' => $status !== '' ? $status : 'Stock',
          'client_id' => $clientId,
          'client_name' => $clientName,
          'assigned_at' => $assignedAt,
          'note' => $note
        ];
      }
    }

    if (empty($errors)) {
      write_serials($serialsFile, $serials);
      $action = ($clientId !== '' || $clientName !== '') ? 'Assign' : 'Move';
      $finalStatus = $status !== '' ? $status : 'Stock';
      write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $finalStatus, $clientId, $clientName, $note, $action);
      header('Location: inventory_ledger.php');
      exit;
    }
  }
}

$ledgerRows = read_ledger($ledgerFile);
$serialRows = read_serials($serialsFile);

$ledgerItemFilter = trim($_GET['ledger_item'] ?? '');
$ledgerStatusFilter = trim($_GET['ledger_status'] ?? '');
$ledgerClientFilter = trim($_GET['ledger_client'] ?? '');
$ledgerSerialFilter = trim($_GET['ledger_serial'] ?? '');

$ledgerFiltered = array_filter($ledgerRows, function($row) use ($ledgerItemFilter, $ledgerStatusFilter, $ledgerClientFilter, $ledgerSerialFilter) {
  $itemOk = $ledgerItemFilter === '' || stripos($row['item_id'] ?? '', $ledgerItemFilter) !== false || stripos($row['item_name'] ?? '', $ledgerItemFilter) !== false;
  $statusOk = $ledgerStatusFilter === '' || stripos($row['status'] ?? '', $ledgerStatusFilter) !== false;
  $clientValue = trim(($row['client_name'] ?? '') . ' ' . ($row['client_id'] ?? ''));
  $clientOk = $ledgerClientFilter === '' || stripos($clientValue, $ledgerClientFilter) !== false;
  $serialOk = $ledgerSerialFilter === '' || stripos($row['serial_number'] ?? '', $ledgerSerialFilter) !== false;
  return $itemOk && $statusOk && $clientOk && $serialOk;
});

$statusOptions = ['Stock', 'Production', 'On The Way', 'Backorder', 'Assigned'];
$statusOptions = array_values(array_unique(array_merge($statusOptions, read_status_options($statusFile))));
foreach ($serialRows as $row) {
  $value = trim($row['status'] ?? '');
  if ($value !== '' && !in_array($value, $statusOptions, true)) {
    $statusOptions[] = $value;
  }
}
sort($statusOptions);
?>
<div class="container">
  <h2>Inventory Ledger</h2>
  <?php if (!empty($errors)): ?>
    <div style="background:#ffecec; border:1px solid #f5baba; color:#8b1b1b; padding:10px 12px; border-radius:6px; margin-bottom:12px;">
      <?php foreach ($errors as $error): ?>
        <div><?= htmlspecialchars($error) ?></div>
      <?php endforeach; ?>
    </div>
  <?php endif; ?>

  <datalist id="customerNameList">
    <?php foreach ($customerPairs as $customer): ?>
      <option value="<?= htmlspecialchars($customer['name']) ?>"></option>
    <?php endforeach; ?>
  </datalist>
  <datalist id="customerIdList">
    <?php foreach ($customerPairs as $customer): ?>
      <?php if ($customer['id'] !== ''): ?>
        <option value="<?= htmlspecialchars($customer['id']) ?>"></option>
      <?php endif; ?>
    <?php endforeach; ?>
  </datalist>

  <div style="display:grid; grid-template-columns:1fr; gap:18px;">
    <div style="background:#fafbfc; border:1px solid #e6e6e6; border-radius:8px; padding:16px;">
      <div style="font-weight:700; margin-bottom:10px;">RFID Scan</div>
      <form method="post" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px 16px;">
        <input type="hidden" name="rfid_scan" value="1">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Serial Number</label>
          <input type="text" name="rfid_serial_number" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Status</label>
          <select name="rfid_status" class="status-select" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($statusOptions as $status): ?>
              <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item ID (if new)</label>
          <input type="text" name="rfid_item_id" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item Name (if new)</label>
          <input type="text" name="rfid_item_name" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client ID</label>
          <input type="text" name="rfid_client_id" class="client-id" list="customerIdList" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client Name</label>
          <input type="text" name="rfid_client_name" class="client-name" list="customerNameList" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1;">
          <label style="display:block; font-weight:600; margin-bottom:4px;">Note</label>
          <input type="text" name="rfid_note" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1; text-align:right;">
          <button type="submit" class="btn-primary">Log Scan</button>
        </div>
      </form>
    </div>
    <div style="background:#fafbfc; border:1px solid #e6e6e6; border-radius:8px; padding:16px;">
      <div style="font-weight:700; margin-bottom:10px;">Add Ledger Entry</div>
      <form method="post" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px 16px;">
        <input type="hidden" name="add_ledger" value="1">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item ID</label>
          <select name="item_id" id="ledgerItemId" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($inventory as $item): ?>
              <option value="<?= htmlspecialchars($item['item_id']) ?>" data-name="<?= htmlspecialchars($item['item_name'] ?? '') ?>">
                <?= htmlspecialchars($item['item_id']) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item Name</label>
          <input type="text" name="item_name" id="ledgerItemName" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Quantity</label>
          <input type="number" name="quantity" step="0.01" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Status</label>
          <select name="status" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($statusOptions as $status): ?>
              <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Action</label>
          <select name="action" style="width:100%; padding:6px 8px;">
            <option value="Receive">Receive</option>
            <option value="Move">Move</option>
            <option value="Adjust">Adjust</option>
            <option value="Assign">Assign</option>
            <option value="Return">Return</option>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Serial (optional)</label>
          <input type="text" name="serial_number" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client ID (optional)</label>
          <input type="text" name="client_id" class="client-id" list="customerIdList" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client Name (optional)</label>
          <input type="text" name="client_name" class="client-name" list="customerNameList" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1;">
          <label style="display:block; font-weight:600; margin-bottom:4px;">Note</label>
          <input type="text" name="note" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1; text-align:right;">
          <button type="submit" class="btn-primary">Add Entry</button>
        </div>
      </form>
    </div>

    <div style="background:#fafbfc; border:1px solid #e6e6e6; border-radius:8px; padding:16px;">
      <div style="font-weight:700; margin-bottom:10px;">Serials and Client Assignment</div>
      <form method="post" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px 16px;">
        <input type="hidden" name="save_serial" value="1">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Serial Number</label>
          <input type="text" name="serial_number" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item ID</label>
          <select name="serial_item_id" id="serialItemId" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($inventory as $item): ?>
              <option value="<?= htmlspecialchars($item['item_id']) ?>" data-name="<?= htmlspecialchars($item['item_name'] ?? '') ?>">
                <?= htmlspecialchars($item['item_id']) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item Name</label>
          <input type="text" name="serial_item_name" id="serialItemName" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Status</label>
          <select name="serial_status" class="status-select" style="width:100%; padding:6px 8px;">
            <?php foreach ($statusOptions as $status): ?>
              <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client ID</label>
          <input type="text" name="serial_client_id" class="client-id" list="customerIdList" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client Name</label>
          <input type="text" name="serial_client_name" class="client-name" list="customerNameList" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1;">
          <label style="display:block; font-weight:600; margin-bottom:4px;">Note</label>
          <input type="text" name="serial_note" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1; text-align:right;">
          <button type="submit" class="btn-primary">Save Serial</button>
        </div>
      </form>
    </div>
  </div>

  <div style="margin-top:22px;">
    <div style="font-weight:700; margin-bottom:10px;">Ledger Entries</div>
    <?php if (empty($ledgerRows)): ?>
      <div style="color:#777;">No ledger entries yet.</div>
    <?php else: ?>
      <div style="overflow:auto; border:1px solid #e6e6e6; border-radius:6px; background:#fff;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f5f5f5;">
              <th style="padding:8px; text-align:left;">Item ID</th>
              <th style="padding:8px; text-align:left;">Item Name</th>
              <th style="padding:8px; text-align:left;">Qty</th>
              <th style="padding:8px; text-align:left;">Status</th>
              <th style="padding:8px; text-align:left;">Action</th>
              <th style="padding:8px; text-align:left;">Client</th>
              <th style="padding:8px; text-align:left;">Serial</th>
              <th style="padding:8px; text-align:left;">Note</th>
              <th style="padding:8px; text-align:left;">Date</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach (array_reverse($ledgerRows) as $row): ?>
              <tr>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['quantity'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['status'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['action'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars(trim(($row['client_name'] ?? '') . ' ' . ($row['client_id'] ?? ''))) ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['serial_number'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['note'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['created_at'] ?? '') ?></td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    <?php endif; ?>
  </div>

  <div style="margin-top:22px;">
    <div style="font-weight:700; margin-bottom:10px;">Serials</div>
    <?php if (empty($serialRows)): ?>
      <div style="color:#777;">No serialized items yet.</div>
    <?php else: ?>
      <div style="overflow:auto; border:1px solid #e6e6e6; border-radius:6px; background:#fff;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f5f5f5;">
              <th style="padding:8px; text-align:left;">Serial</th>
              <th style="padding:8px; text-align:left;">Item ID</th>
              <th style="padding:8px; text-align:left;">Item Name</th>
              <th style="padding:8px; text-align:left;">Status</th>
              <th style="padding:8px; text-align:left;">Client</th>
              <th style="padding:8px; text-align:left;">Assigned</th>
              <th style="padding:8px; text-align:left;">Note</th>
              <th style="padding:8px; text-align:left;">Update</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($serialRows as $row): ?>
              <tr>
                <td style="padding:8px;"><?= htmlspecialchars($row['serial_number'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['status'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars(trim(($row['client_name'] ?? '') . ' ' . ($row['client_id'] ?? ''))) ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['assigned_at'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['note'] ?? '') ?></td>
                <td style="padding:8px;">
                  <form method="post" style="display:grid; grid-template-columns:1fr 1fr; gap:6px; align-items:center;">
                    <input type="hidden" name="update_serial" value="1">
                    <input type="hidden" name="serial_number" value="<?= htmlspecialchars($row['serial_number'] ?? '') ?>">
                    <select name="update_status" class="status-select" style="padding:4px 6px;">
                      <option value="">-- Status --</option>
                      <?php foreach ($statusOptions as $status): ?>
                        <?php $selected = ($row['status'] ?? '') === $status ? 'selected' : ''; ?>
                        <option value="<?= htmlspecialchars($status) ?>" <?= $selected ?>><?= htmlspecialchars($status) ?></option>
                      <?php endforeach; ?>
                    </select>
                    <input type="text" name="update_client_id" class="client-id" list="customerIdList" placeholder="Client ID" value="<?= htmlspecialchars($row['client_id'] ?? '') ?>" style="padding:4px 6px;">
                    <input type="text" name="update_client_name" class="client-name" list="customerNameList" placeholder="Client Name" value="<?= htmlspecialchars($row['client_name'] ?? '') ?>" style="padding:4px 6px;">
                    <input type="text" name="update_note" placeholder="Note" value="<?= htmlspecialchars($row['note'] ?? '') ?>" style="padding:4px 6px;">
                    <button type="submit" class="btn-outline" style="grid-column:1 / -1;">Update</button>
                  </form>
                </td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    <?php endif; ?>
  </div>
</div>
<script>
  const ledgerItemId = document.getElementById('ledgerItemId');
  const ledgerItemName = document.getElementById('ledgerItemName');
  const serialItemId = document.getElementById('serialItemId');
  const serialItemName = document.getElementById('serialItemName');

  function syncName(selectEl, targetEl) {
    if (!selectEl || !targetEl) {
      return;
    }
    const selected = selectEl.options[selectEl.selectedIndex];
    if (selected && selected.dataset && selected.dataset.name !== undefined) {
      targetEl.value = selected.dataset.name;
    }
  }

  if (ledgerItemId && ledgerItemName) {
    ledgerItemId.addEventListener('change', () => syncName(ledgerItemId, ledgerItemName));
  }
  if (serialItemId && serialItemName) {
    serialItemId.addEventListener('change', () => syncName(serialItemId, serialItemName));
  }

  const customerPairs = <?= json_encode($customerPairs) ?>;

  function normalize(value) {
    return (value || '').toLowerCase().trim();
  }

  function findCustomerByName(value) {
    const needle = normalize(value);
    return customerPairs.find(customer => normalize(customer.name) === needle) || null;
  }

  function findCustomerById(value) {
    const needle = normalize(value);
    return customerPairs.find(customer => normalize(customer.id) === needle) || null;
  }

  function autoAssignStatus(form) {
    if (!form) {
      return;
    }
    const statusSelect = form.querySelector('select.status-select');
    const clientId = form.querySelector('input.client-id');
    const clientName = form.querySelector('input.client-name');
    const hasClient = (clientId && clientId.value.trim() !== '') || (clientName && clientName.value.trim() !== '');
    if (statusSelect && statusSelect.value === '' && hasClient) {
      statusSelect.value = 'Assigned';
    }
  }

  document.querySelectorAll('input.client-name').forEach(input => {
    input.addEventListener('input', () => {
      const match = findCustomerByName(input.value);
      const form = input.closest('form');
      if (match && form) {
        const idInput = form.querySelector('input.client-id');
        if (idInput && idInput.value.trim() === '') {
          idInput.value = match.id;
        }
      }
      autoAssignStatus(form);
    });
  });

  document.querySelectorAll('input.client-id').forEach(input => {
    input.addEventListener('input', () => {
      const match = findCustomerById(input.value);
      const form = input.closest('form');
      if (match && form) {
        const nameInput = form.querySelector('input.client-name');
        if (nameInput && nameInput.value.trim() === '') {
          nameInput.value = match.name;
        }
      }
      autoAssignStatus(form);
    });
  });
</script>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of inventory_ledger.php ---



--- Start of inventory_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/inventory_schema.php';
$items = readCSV('inventory.csv', $schema);

// Display inventory list
?>

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$items = readCSV($inventoryFile, $schema);
$statusFile = __DIR__ . '/inventory_status_options.csv';
$ledgerFile = __DIR__ . '/inventory_ledger.csv';
$serialsFile = __DIR__ . '/inventory_serials.csv';

function read_ledger($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function read_serials($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function add_status_total(&$totals, $itemId, $status, $qty) {
  if ($itemId === '' || $status === '') {
    return;
  }
  if (!isset($totals[$itemId])) {
    $totals[$itemId] = [];
  }
  if (!isset($totals[$itemId][$status])) {
    $totals[$itemId][$status] = 0.0;
  }
  $totals[$itemId][$status] += $qty;
}

$ledgerRows = read_ledger($ledgerFile);
$serialRows = read_serials($serialsFile);
$ledgerStatuses = [];
$serialStatuses = [];
$statusTotalsByItem = [];

foreach ($ledgerRows as $entry) {
  $itemId = trim($entry['item_id'] ?? '');
  $status = trim($entry['status'] ?? '');
  $qty = is_numeric($entry['quantity'] ?? '') ? (float)$entry['quantity'] : 0.0;
  add_status_total($statusTotalsByItem, $itemId, $status, $qty);
  if ($status !== '') {
    $ledgerStatuses[] = $status;
  }
}

foreach ($serialRows as $entry) {
  $itemId = trim($entry['item_id'] ?? '');
  $status = trim($entry['status'] ?? '');
  add_status_total($statusTotalsByItem, $itemId, $status, 1.0);
  if ($status !== '') {
    $serialStatuses[] = $status;
  }
}

function read_status_options($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $options = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    while (($row = fgetcsv($handle)) !== false) {
      $value = trim($row[0] ?? '');
      if ($value !== '') {
        $options[] = $value;
      }
    }
    fclose($handle);
  }
  return array_values(array_unique($options));
}

function write_status_options($filename, $options) {
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, ['status']);
  foreach ($options as $option) {
    fputcsv($file, [$option]);
  }
  fclose($file);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['status_action'])) {
  $action = trim($_POST['status_action'] ?? '');
  $value = trim($_POST['status_value'] ?? '');
  $options = read_status_options($statusFile);
  if ($action === 'add' && $value !== '') {
    if (!in_array($value, $options, true)) {
      $options[] = $value;
    }
  } elseif ($action === 'remove' && $value !== '') {
    $options = array_values(array_filter($options, function($opt) use ($value) {
      return $opt !== $value;
    }));
  }
  sort($options);
  write_status_options($statusFile, $options);
  header('Content-Type: application/json');
  echo json_encode(['statusOptions' => $options]);
  exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_inventory'])) {
  $itemId = trim($_POST['item_id'] ?? '');
  $activeIndex = trim($_POST['active_index'] ?? '');
  if ($itemId !== '') {
    $items = readCSV($inventoryFile, $schema);
    foreach ($items as &$row) {
      if (($row['item_id'] ?? '') === $itemId) {
        foreach ($schema as $field) {
          if (array_key_exists($field, $_POST)) {
            $row[$field] = trim($_POST[$field] ?? '');
          }
        }
        $cost = $row['cost_price'] ?? '';
        $margin = $row['margin'] ?? '';
        $costVal = is_numeric($cost) ? max(0, (float)$cost) : null;
        $marginVal = is_numeric($margin) ? max(0, (float)$margin) : null;
        if ($costVal !== null) {
          $row['cost_price'] = number_format($costVal, 2, '.', '');
        }
        if ($marginVal !== null) {
          $row['margin'] = number_format($marginVal, 2, '.', '');
        }
        if ($costVal !== null && $marginVal !== null) {
          $selling = $costVal * (1 + ($marginVal / 100));
          $row['selling_price'] = number_format($selling, 2, '.', '');
        }
        $row['updated_at'] = date('Y-m-d H:i:s');
        break;
      }
    }
    unset($row);
    writeCSV($inventoryFile, $items, $schema);
  }
  $redirect = 'inventory_list.php';
  if ($activeIndex !== '' && ctype_digit($activeIndex)) {
    $redirect .= '?active_index=' . urlencode($activeIndex);
  } elseif ($itemId !== '') {
    $redirect .= '?active_item=' . urlencode($itemId);
  }
  header('Location: ' . $redirect);
  exit;
}

// Build filter array from GET
$filters = [];
foreach ($schema as $f) {
    $filters[$f] = isset($_GET[$f]) ? trim($_GET[$f]) : '';
}

// Filter items by all non-empty fields
$filtered = $items;
foreach ($filters as $field => $val) {
    if ($val !== '') {
        $filtered = array_filter($filtered, function($item) use ($field, $val) {
            return stripos($item[$field] ?? '', $val) !== false;
        });
    }
}

$statusOptions = ['Stock', 'Production'];
$statusOptions = array_values(array_unique(array_merge(
  $statusOptions,
  read_status_options($statusFile),
  $ledgerStatuses,
  $serialStatuses
)));
foreach ($items as $row) {
  $status = trim($row['status'] ?? '');
  if ($status !== '' && !in_array($status, $statusOptions, true)) {
    $statusOptions[] = $status;
  }
}
sort($statusOptions);
?>
<div class="container">
  <h2>Inventory List</h2>
  <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
    <a href="inventory_add.php" class="btn-outline">‚ûï Add Item</a>
  </div>
  <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:14px;">
    <input type="text" id="invSearch" placeholder="Search by item name or ID" style="padding:6px 8px; border-radius:4px; border:1px solid #bbb; min-width:240px;">
    <select id="invStatus" style="padding:6px 8px; border-radius:4px; border:1px solid #bbb;">
      <option value="">All Status</option>
      <?php foreach ($statusOptions as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="button" id="invExpandAll">Expand All</button>
    <button type="button" id="invCollapseAll">Collapse All</button>
    <div id="invCount" style="margin-left:auto; color:#555;"></div>
  </div>
  <style>
    .inv-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    .inv-list {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      max-height: 70vh;
      overflow: auto;
    }
    .inv-list-item {
      width: 100%;
      text-align: left;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      background: #f9fafb;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .inv-list-item.active {
      background: #e9eef6;
      border-color: #8aa4c8;
    }
    .inv-list-title { font-weight: 600; margin-bottom: 4px; }
    .inv-list-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.9em;
      color: #555;
    }
    .inv-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f3f6;
      border: 1px solid #d9dee7;
    }
    .inv-pill.status { background: #eef4ff; border-color: #cddcff; color: #274690; }
    .inv-pill.qty { background: #e9f6ec; border-color: #b8e0c2; color: #1f6a35; }
    .inv-pill.stock-level { background: #fff6e5; border-color: #f5d19a; color: #8a5a00; }
    .inv-pill.low { background: #ffe8e8; border-color: #f2b6b6; color: #9b1c1c; }
    .inv-pill.ok { background: #e9f6ec; border-color: #b8e0c2; color: #1f6a35; }
    .inv-detail {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 14px;
      background: #fff;
      min-height: 200px;
    }
    .inv-detail-panel { display: none; }
    .inv-detail-panel.active { display: block; }
    .inv-detail-title { font-weight: 700; margin-bottom: 10px; }
    .inv-section {
      margin-bottom: 14px;
      border: 1px solid #e6e6e6;
      border-radius: 6px;
      padding: 10px 12px;
      background: #fafafa;
    }
    .inv-section-title {
      font-weight: 800;
      font-size: 1.05em;
      margin-bottom: 8px;
    }
    .inv-section-grid {
      display: grid;
      grid-template-columns: 160px 1fr 160px 1fr;
      gap: 8px 16px;
      align-items: center;
    }
    .inv-label { font-weight: 600; color: #222; }
    .inv-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #e6e6e6;
      background: #fff;
      box-sizing: border-box;
      font-size: 0.95em;
    }
    .inv-input[readonly] { background: #f5f5f5; }
    .inv-textarea { height: 70px; resize: vertical; }
    @media (max-width: 900px) {
      .inv-layout { grid-template-columns: 1fr; }
      .inv-list { max-height: none; }
      .inv-section-grid { grid-template-columns: 160px 1fr; }
    }
  </style>
  <?php if (empty($filtered)): ?>
    <div style="text-align:center; color:#888;">No items found.</div>
  <?php else: ?>
    <?php
      $sections = [
        'General' => ['item_id','item_name','description','category','brand','model','serial_number','barcode','rfid_tag','status','notes'],
        'Supplier' => ['supplier_id','supplier_name','purchase_date'],
        'Pricing' => ['cost_price','margin','selling_price','currency'],
        'Stock' => ['quantity_in_stock','reorder_level','reorder_quantity','unit'],
        'Location' => ['warehouse','location'],
        'Audit' => ['created_at','updated_at','created_by','updated_by']
      ];
    ?>
    <div class="inv-layout">
      <div class="inv-list" id="invList">
        <?php foreach ($filtered as $index => $row): ?>
          <?php
            $title = trim(($row['item_name'] ?? '') ?: ($row['item_id'] ?? 'Inventory Item'));
            $qty = $row['quantity_in_stock'] ?? '';
            $reorder = $row['reorder_quantity'] ?? '';
            $qtyNum = is_numeric($qty) ? (float)$qty : null;
            $reorderNum = is_numeric($reorder) ? (float)$reorder : null;
            $isLowStock = $qtyNum !== null && $reorderNum !== null && $qtyNum < $reorderNum;
          ?>
          <button
            type="button"
            class="inv-list-item"
            data-target="inv-detail-<?= $index ?>"
            data-item-name="<?= htmlspecialchars(strtolower($row['item_name'] ?? '')) ?>"
            data-item-id="<?= htmlspecialchars(strtolower($row['item_id'] ?? '')) ?>"
            data-status="<?= htmlspecialchars(strtolower($row['status'] ?? '')) ?>"
          >
            <div class="inv-list-title"><?= htmlspecialchars($title) ?></div>
            <div class="inv-list-meta">
              <?php if (!empty($row['item_id'])): ?><span class="inv-pill" data-role="id">ID: <?= htmlspecialchars($row['item_id']) ?></span><?php endif; ?>
              <?php if (!empty($row['status'])): ?><span class="inv-pill status" data-role="status">Status: <?= htmlspecialchars($row['status']) ?></span><?php endif; ?>
              <?php if ($qty !== ''): ?>
                <span class="inv-pill qty <?= $isLowStock ? 'low' : 'ok' ?>" data-role="qty">Qty: <?= htmlspecialchars($qty) ?></span>
              <?php endif; ?>
              <?php if ($reorder !== ''): ?>
                <span class="inv-pill stock-level" data-role="stock-level">Stock Level: <?= htmlspecialchars($reorder) ?></span>
              <?php endif; ?>
            </div>
          </button>
        <?php endforeach; ?>
      </div>
      <div class="inv-detail" id="invDetail">
        <?php foreach ($filtered as $index => $row): ?>
          <?php
            $title = trim(($row['item_name'] ?? '') ?: ($row['item_id'] ?? 'Inventory Item'));
            $itemId = $row['item_id'] ?? '';
            $statusTotals = $statusTotalsByItem[$itemId] ?? [];
            ksort($statusTotals);
          ?>
          <div class="inv-detail-panel" id="inv-detail-<?= $index ?>">
            <div class="inv-detail-title"><?= htmlspecialchars($title) ?></div>
            <div class="inv-section">
              <div class="inv-section-title">Status Quantities</div>
              <?php if (empty($statusTotals)): ?>
                <div style="color:#666;">No ledger or serialized quantities yet.</div>
              <?php else: ?>
                <table style="width:100%; border-collapse:collapse; background:#fff;">
                  <thead>
                    <tr style="background:#f5f5f5;">
                      <th style="padding:6px; text-align:left;">Status</th>
                      <th style="padding:6px; text-align:left;">Qty</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php foreach ($statusTotals as $status => $qty): ?>
                      <tr>
                        <td style="padding:6px;"><?= htmlspecialchars($status) ?></td>
                        <td style="padding:6px;"><?= htmlspecialchars((string)$qty) ?></td>
                      </tr>
                    <?php endforeach; ?>
                  </tbody>
                </table>
              <?php endif; ?>
            </div>
            <form method="post" class="inv-edit-form">
              <input type="hidden" name="save_inventory" value="1">
              <input type="hidden" name="active_index" value="<?= $index ?>">
            <?php foreach ($sections as $sectionName => $fields): ?>
              <?php
                $hasValue = false;
                foreach ($fields as $field) {
                  if (!empty($row[$field])) { $hasValue = true; break; }
                }
              ?>
              <div class="inv-section">
                <div class="inv-section-title"><?= htmlspecialchars($sectionName) ?></div>
                <div class="inv-section-grid">
                  <?php foreach ($fields as $field): ?>
                    <?php
                      $label = ucwords(str_replace('_', ' ', $field));
                      if ($field === 'margin') {
                        $label = 'Margin (%)';
                      }
                    ?>
                    <div class="inv-label"><?= htmlspecialchars($label) ?></div>
                    <?php
                      $value = trim($row[$field] ?? '');
                      if ($field === 'margin' && $value === '') {
                        $value = '30';
                      }
                    ?>
                    <?php
                      $readonly = in_array($field, ['item_id', 'created_at', 'updated_at']);
                      $isTextarea = in_array($field, ['description', 'notes']);
                      $dataRole = '';
                      if ($field === 'cost_price') { $dataRole = 'cost'; }
                      if ($field === 'margin') { $dataRole = 'margin'; }
                      if ($field === 'selling_price') { $dataRole = 'selling'; }
                      $dataAttr = $dataRole !== '' ? ' data-role="' . $dataRole . '"' : '';
                    ?>
                    <?php if ($field === 'status'): ?>
                      <div>
                        <select class="inv-input status-select" name="status" data-current="<?= htmlspecialchars($value) ?>"></select>
                        <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
                          <input type="text" class="inv-input status-input" placeholder="Add status" style="max-width:160px;">
                          <button type="button" class="status-add">Add</button>
                          <button type="button" class="status-remove">Remove</button>
                        </div>
                      </div>
                    <?php elseif ($isTextarea): ?>
                      <textarea class="inv-input inv-textarea" name="<?= $field ?>" <?= $readonly ? 'readonly' : '' ?><?= $dataAttr ?>><?= htmlspecialchars($value) ?></textarea>
                    <?php else: ?>
                      <input class="inv-input" type="text" name="<?= $field ?>" value="<?= htmlspecialchars($value) ?>" <?= $readonly ? 'readonly' : '' ?><?= $dataAttr ?>>
                    <?php endif; ?>
                  <?php endforeach; ?>
                </div>
              </div>
            <?php endforeach; ?>
              <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit">Save Changes</button>
              </div>
            </form>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
    <div id="invNoMatch" style="display:none; text-align:center; color:#888; margin-top:12px;">No matching items.</div>
    <script>
      const listItems = Array.from(document.querySelectorAll('.inv-list-item'));
      const detailPanels = Array.from(document.querySelectorAll('.inv-detail-panel'));
      const searchInput = document.getElementById('invSearch');
      const statusSelect = document.getElementById('invStatus');
      const countEl = document.getElementById('invCount');
      const noMatchEl = document.getElementById('invNoMatch');
      const activeItemId = (new URLSearchParams(window.location.search).get('active_item') || '').toLowerCase();
      const activeIndexParam = new URLSearchParams(window.location.search).get('active_index');
      const activeIndex = Number.isInteger(parseInt(activeIndexParam, 10)) ? parseInt(activeIndexParam, 10) : -1;

      const defaultStatusOptions = <?= json_encode($statusOptions) ?>;
      let statusOptions = Array.from(new Set(defaultStatusOptions)).sort();

      function renderStatusSelects() {
        document.querySelectorAll('.status-select').forEach(select => {
          const current = select.getAttribute('data-current') || '';
          select.innerHTML = '';
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'Select status';
          select.appendChild(emptyOption);
          statusOptions.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            select.appendChild(option);
          });
          if (current && !statusOptions.includes(current)) {
            const customOption = document.createElement('option');
            customOption.value = current;
            customOption.textContent = current;
            select.appendChild(customOption);
          }
          select.value = current;
        });
      }

      function renderFilterStatusOptions() {
        if (!statusSelect) {
          return;
        }
        const current = statusSelect.value || '';
        statusSelect.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'All Status';
        statusSelect.appendChild(allOption);
        statusOptions.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          statusSelect.appendChild(option);
        });
        if (current && !statusOptions.includes(current)) {
          const customOption = document.createElement('option');
          customOption.value = current;
          customOption.textContent = current;
          statusSelect.appendChild(customOption);
        }
        statusSelect.value = current;
      }

      function syncStatusOptions(action, value) {
        const formData = new FormData();
        formData.append('status_action', action);
        formData.append('status_value', value);
        return fetch('inventory_list.php', {
          method: 'POST',
          body: formData
        })
          .then(response => response.ok ? response.json() : null)
          .then(data => {
            if (data && Array.isArray(data.statusOptions)) {
              statusOptions = Array.from(new Set(data.statusOptions)).sort();
              renderStatusSelects();
              renderFilterStatusOptions();
            }
          })
          .catch(() => {});
      }

      function activateItem(item) {
        listItems.forEach(btn => btn.classList.remove('active'));
        detailPanels.forEach(panel => panel.classList.remove('active'));
        if (!item) {
          return;
        }
        item.classList.add('active');
        const targetId = item.getAttribute('data-target');
        const panel = document.getElementById(targetId);
        if (panel) {
          panel.classList.add('active');
        }
        item.scrollIntoView({ block: 'nearest' });
      }

      listItems.forEach(btn => {
        btn.addEventListener('click', () => activateItem(btn));
      });

      document.querySelectorAll('.inv-edit-form').forEach(form => {
        form.addEventListener('submit', event => {
          if (!confirm('Save changes to this inventory item?')) {
            event.preventDefault();
          }
        });

        form.querySelectorAll('.status-add').forEach(btn => {
          btn.addEventListener('click', () => {
            const input = form.querySelector('.status-input');
            const newStatus = (input.value || '').trim();
            if (newStatus && !statusOptions.includes(newStatus)) {
              statusOptions.push(newStatus);
              statusOptions.sort();
              renderStatusSelects();
              renderFilterStatusOptions();
              syncStatusOptions('add', newStatus);
            }
            input.value = '';
          });
        });

        form.querySelectorAll('.status-remove').forEach(btn => {
          btn.addEventListener('click', () => {
            const select = form.querySelector('.status-select');
            const value = select.value;
            if (value === '') {
              return;
            }
            statusOptions = statusOptions.filter(s => s !== value);
            renderStatusSelects();
            renderFilterStatusOptions();
            syncStatusOptions('remove', value);
          });
        });

        const statusSelectEl = form.querySelector('.status-select');
        if (statusSelectEl) {
          statusSelectEl.addEventListener('change', () => {
            const panel = statusSelectEl.closest('.inv-detail-panel');
            if (!panel) {
              return;
            }
            const targetId = panel.getAttribute('id');
            const listItem = document.querySelector(`.inv-list-item[data-target="${targetId}"]`);
            if (listItem) {
              const newStatus = statusSelectEl.value;
              listItem.setAttribute('data-status', (newStatus || '').toLowerCase());
              const meta = listItem.querySelector('.inv-list-meta');
              if (meta) {
                let statusPill = meta.querySelector('[data-role="status"]');
                if (newStatus) {
                  if (!statusPill) {
                    statusPill = document.createElement('span');
                    statusPill.className = 'inv-pill status';
                    statusPill.setAttribute('data-role', 'status');
                    meta.appendChild(statusPill);
                  }
                  statusPill.textContent = `Status: ${newStatus}`;
                  statusPill.style.display = '';
                } else if (statusPill) {
                  statusPill.style.display = 'none';
                }
              }
            }
            filterList();
          });
        }

        const costInput = form.querySelector('input[name="cost_price"]');
        const marginInput = form.querySelector('input[name="margin"]');
        const sellingInput = form.querySelector('input[name="selling_price"]');

        function updateSellingPrice() {
          if (!costInput || !marginInput || !sellingInput) {
            return;
          }
          const cost = parseFloat(costInput.value);
          const margin = parseFloat(marginInput.value);
          if (!Number.isFinite(cost) || !Number.isFinite(margin) || margin === 0) {
            return;
          }
          const selling = cost * (1 + (margin / 100));
          if (Number.isFinite(selling)) {
            sellingInput.value = selling.toFixed(2);
          }
        }

        if (costInput) {
          costInput.addEventListener('input', updateSellingPrice);
        }
        if (marginInput) {
          marginInput.addEventListener('input', updateSellingPrice);
        }

        updateSellingPrice();
      });

      function filterList() {
        const query = (searchInput.value || '').trim().toLowerCase();
        const status = (statusSelect.value || '').trim().toLowerCase();
        let visibleCount = 0;
        let firstVisible = null;

        listItems.forEach(btn => {
          const name = btn.getAttribute('data-item-name') || '';
          const id = btn.getAttribute('data-item-id') || '';
          const itemStatus = btn.getAttribute('data-status') || '';
          const matchesQuery = query === '' || name.includes(query) || id.includes(query);
          const matchesStatus = status === '' || itemStatus === status;
          const show = matchesQuery && matchesStatus;
          btn.style.display = show ? '' : 'none';
          if (show) {
            visibleCount += 1;
            if (!firstVisible) {
              firstVisible = btn;
            }
          }
        });

        if (countEl) {
          countEl.textContent = `${visibleCount} item(s)`;
        }
        if (noMatchEl) {
          noMatchEl.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        const active = document.querySelector('.inv-list-item.active');
        if (!active || active.style.display === 'none') {
          activateItem(firstVisible);
        }
      }

      searchInput.addEventListener('input', filterList);
      statusSelect.addEventListener('change', filterList);

      renderStatusSelects();
      renderFilterStatusOptions();
      let initialItem = null;
      if (activeIndex >= 0 && activeIndex < listItems.length) {
        initialItem = listItems[activeIndex];
      } else if (activeItemId) {
        initialItem = listItems.find(item => (item.getAttribute('data-item-id') || '') === activeItemId);
      }
      if (!initialItem) {
        initialItem = listItems[0];
      }
      activateItem(initialItem);
      filterList();
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of inventory_list.php ---



--- Start of inventory_schema.php ---

<?php
$schema = [
    'item_id' => 'integer',
    'item_name' => 'string',
    'quantity' => 'integer',
    'status' => 'string',
];
return $schema;
?>
<?php
return [
    'item_id',
    'item_name',
    'description',
    'category',
    'brand',
    'model',
    'serial_number',
    'barcode',
    'rfid_tag',
    'supplier_id',
    'supplier_name',
    'purchase_date',
    'cost_price',
    'margin',
    'selling_price',
    'currency',
    'quantity_in_stock',
    'reorder_level',
    'reorder_quantity',
    'unit',
    'warehouse',
    'location',
    'status',
    'created_at',
    'updated_at',
    'created_by',
    'updated_by',
    'notes'
];


--- End of inventory_schema.php ---



--- Start of layout_end.php ---

  <?php
  // Layout end code here
  ?>
  </div> <!-- end content-container -->
</div> <!-- end main-content -->

<script src="js/modern-ui.js?v=20260213"></script>
</body>
</html>


--- End of layout_end.php ---



--- Start of layout_start.php ---

<?php
// Layout start code here
?>
<?php
require_once __DIR__ . '/simple_auth/middleware.php';
require_once __DIR__ . '/backup_handler.php';
require_once __DIR__ . '/error_handler.php';
require_once __DIR__ . '/csrf_helper.php';
require_once __DIR__ . '/sanitize_helper.php';
require_once __DIR__ . '/audit_handler.php';

// Initialize CSRF token for this session
initializeCSRFToken();

// Security headers
header('Content-Type: text/html; charset=UTF-8');
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY');
header('X-XSS-Protection: 1; mode=block');
header('Referrer-Policy: strict-origin-when-cross-origin');
header("Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:;");

// Disable caching for pages with sensitive data
if (strpos($_SERVER['REQUEST_URI'], 'contact') !== false) {
    header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
    header('Pragma: no-cache');
}

$pageTitle = $pageTitle ?? 'CRM';
$currentPage = basename($_SERVER['SCRIPT_NAME']);
?>
<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="CRM system for managing contacts and customer interactions.">
  <meta name="author" content="Eclipse Water Technologies">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="<?= htmlspecialchars($pageTitle) ?>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/<?= htmlspecialchars($currentPage) ?>">
  <meta property="og:image" content="https://yourdomain.com/images/preview.png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="crm_bootstrap.css?v=20260215">
    <link rel="stylesheet" href="styles.css?v=20251002">
    <link rel="stylesheet" href="css/modern-sidebar.css?v=20260213-2">
    <link rel="stylesheet" href="css/modern-components.css?v=20260213">
  <script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
  <title><?= htmlspecialchars($pageTitle) ?></title>
</head>
<body>
<?php include_once 'navbar-sidebar.php'; ?>

<?php
// Display error messages if present
if (isset($_GET['error'])) {
    $errorMessages = [
        // 'access_denied' admin message removed
        'not_found' => 'The requested page was not found.',
        'invalid_request' => 'Invalid request received.',
    ];
    $errorType = $_GET['error'];
    if (isset($errorMessages[$errorType])) {
        echo '<div style="background:#fee;border:1px solid #fcc;padding:15px;margin:20px;border-radius:4px;color:#c33;">';
        echo htmlspecialchars($errorMessages[$errorType]);
        echo '</div>';
    }
}

// Display success messages if present
if (isset($_GET['success'])) {
    $successMessages = [
        'updated' => '‚úì Successfully updated.',
        'created' => '‚úì Successfully created.',
        'deleted' => '‚úì Successfully deleted.',
    ];
    $successType = $_GET['success'];
    if (isset($successMessages[$successType])) {
        echo '<div style="background:#efe;border:1px solid #cfc;padding:15px;margin:20px;border-radius:4px;color:#363;">';
        echo htmlspecialchars($successMessages[$successType]);
        echo '</div>';
    }
}
?>


--- End of layout_start.php ---



--- Start of navbar-sidebar.php ---

<?php
// Sidebar navbar code here
?>
<?php
// Get current user info from session
$current_user = auth_current_user();
$user_name = $current_user['username'] ?? 'Guest';
$user_role = $_SESSION['role'] ?? 'user';
// $is_admin removed

// Get initials for avatar
$initials = strtoupper(substr($user_name, 0, 2));
?>

<!-- Sidebar Overlay (mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <!-- Logo -->
  <div class="sidebar-header">
    <div class="sidebar-logo">Eclipse CRM</div>
  </div>
  
  <!-- User Info -->
  <div class="sidebar-user">
    <div class="user-avatar"><?= $initials ?></div>
    <div class="user-info">
      <div class="user-name"><?= htmlspecialchars($user_name) ?></div>
      <div class="user-role"><?= ucfirst($user_role) ?></div>
    </div>
  </div>
  
  <!-- Navigation -->
  <nav class="sidebar-nav">
    
    <!-- MAIN SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Main</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.php" class="nav-link <?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- CONTACTS SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Contacts</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="contacts_list.php" class="nav-link <?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üë•</span>
            <span>All Contacts</span>
            <?php 
            require_once 'csv_handler.php';
            $contact_count = count(readCSV('contacts.csv', require 'contact_schema.php'));
            ?>
            <span class="nav-badge"><?= $contact_count ?></span>
          </a>
        </li>
        <li class="nav-item">
          <a href="contact_form.php" class="nav-link <?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Contact</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="import_contacts.php" class="nav-link <?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
            <span class="nav-icon">üì•</span>
            <span>Import</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="export_contacts.php" class="nav-link <?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
            <span class="nav-icon">üì§</span>
            <span>Export</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- CUSTOMERS SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Customers</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="customers_list.php" class="nav-link <?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìã</span>
            <span>All Customers</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="add_customer.php" class="nav-link <?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Customer</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- SALES SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Sales</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="pipeline_board.php" class="nav-link <?= $currentPage === 'pipeline_board.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìä</span>
            <span>Pipeline Board</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="opportunities_list.php" class="nav-link <?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìã</span>
            <span>Opportunities List</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="contracts_list.php" class="nav-link <?= $currentPage === 'contracts_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìÑ</span>
            <span>All Contracts</span>
            <?php 
            $contracts_count = count(readCSV('contracts.csv', require __DIR__ . '/contract_schema.php') ?: []);
            if ($contracts_count > 0):
            ?>
            <span class="nav-badge"><?= $contracts_count ?></span>
            <?php endif; ?>
          </a>
        </li>
        <li class="nav-item">
          <a href="renewals.php" class="nav-link <?= $currentPage === 'renewals.php' ? 'active' : '' ?>">
            <span class="nav-icon">üîÑ</span>
            <span>Renewals</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="revenue_dashboard.php" class="nav-link <?= $currentPage === 'revenue_dashboard.php' ? 'active' : '' ?>">
            <span class="nav-icon">üí∞</span>
            <span>Revenue Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="add_opportunity.php" class="nav-link <?= $currentPage === 'add_opportunity.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Opportunity</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="contract_form.php" class="nav-link <?= $currentPage === 'contract_form.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Contract</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="calendar.php" class="nav-link <?= $currentPage === 'calendar.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìÖ</span>
            <span>Calendar</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- EQUIPMENT SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Equipment</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="equipment_list.php" class="nav-link <?= $currentPage === 'equipment_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üîß</span>
            <span>All Equipment</span>
            <?php 
            $equipment_count = count(readCSV('equipment.csv', require __DIR__ . '/equipment_schema.php') ?: []);
            if ($equipment_count > 0):
            ?>
            <span class="nav-badge"><?= $equipment_count ?></span>
            <?php endif; ?>
          </a>
        </li>
        <li class="nav-item">
          <a href="equipment_form.php" class="nav-link <?= $currentPage === 'equipment_form.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Equipment</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- INVENTORY SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Inventory</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="inventory_list.php" class="nav-link <?= $currentPage === 'inventory_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üì¶</span>
            <span>Products</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="inventory_ledger.php" class="nav-link <?= $currentPage === 'inventory_ledger.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìä</span>
            <span>Ledger</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="backorders_list.php" class="nav-link <?= $currentPage === 'backorders_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ö†Ô∏è</span>
            <span>Backorders</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="purchase_orders_list.php" class="nav-link <?= $currentPage === 'purchase_orders_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üßæ</span>
            <span>Purchase Orders</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- ADMIN SECTION FULLY REMOVED -->
    
    <!-- ACCOUNT SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Account</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="simple_auth/logout.php" class="nav-link">
            <span class="nav-icon">üö™</span>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </div>
    
  </nav>
</aside>

<!-- Main Content Wrapper -->
<div class="main-content" id="mainContent">
  
  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-left">
      <button class="menu-toggle" id="menuToggle">
        ‚ò∞
      </button>
      <h1 class="page-title">
        <?php
        // Auto-generate page title from filename
        $title = str_replace(['_', '.php'], [' ', ''], $currentPage);
        echo ucwords($title);
        ?>
      </h1>
    </div>
    
    <div class="topbar-right">
      <!-- Global Search -->
      <form method="GET" action="contacts_list.php" class="search-bar" style="display: flex; align-items: center; gap: 8px; margin: 0;">
        <span class="search-icon">üîç</span>
        <input type="text" 
               class="search-input" 
               name="query"
               placeholder="Search contacts, companies..."
               id="globalSearch"
               value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
        <input type="hidden" name="field" value="">
        <button type="submit" style="display: none;"></button>
      </form>
    </div>
  </div>
  
  <!-- Page Content -->
  <div class="content-container">
    <!-- Page content goes here (from included PHP files) -->
```

--- End of navbar-sidebar.php ---



--- Start of navbar.php ---

<?php
// Navbar code here
?>
<nav class="navbar">
  <ul>
    <li><a href="dashboard.php" class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">Dashboard</a></li>
    <li><a href="contacts_list.php" class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">Contact List</a></li>
    <li><a href="add_customer.php" class="<?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">‚ûï Add Customer</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üìã Customer List</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üëÅ View Customers</a></li>
    <li><a href="calendar.php" class="<?= $currentPage === 'calendar.php' ? 'active' : '' ?>">üìÖ Calendar</a></li>
    <li><a href="contact_form.php" class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">Add Contact</a></li>
    <li><a href="opportunities_list.php" class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">Opportunities</a></li>
    <li><a href="add_opportunity.php" class="<?= $currentPage === 'add_opportunity.php' ? 'active' : '' ?>">Add Opportunity</a></li>
    <li><a href="import_contacts.php" class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">Import</a></li>
    <li><a href="export_contacts.php" class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">Export</a></li>
    <li><a href="inventory_list.php" class="<?= $currentPage === 'inventory_list.php' ? 'active' : '' ?>">üì¶ Inventory</a></li>
    <li><a href="inventory_ledger.php" class="<?= $currentPage === 'inventory_ledger.php' ? 'active' : '' ?>">üì¶ Inventory Ledger</a></li>
    <li><a href="backorders_list.php" class="<?= $currentPage === 'backorders_list.php' ? 'active' : '' ?>">üì¶ Backorders</a></li>
    <li><a href="purchase_orders_list.php" class="<?= $currentPage === 'purchase_orders_list.php' ? 'active' : '' ?>">üßæ Purchase Orders</a></li>
    <?php if (auth_check()): ?>
      <li style="margin-left: auto;">
        <span style="margin-right: 15px;">üë§ <?= htmlspecialchars(auth_current_user()['username']) ?></span>
        <a href="simple_auth/logout.php" style="color: #e74c3c;">Logout</a>
      </li>
    <?php else: ?>
      <li style="margin-left: auto;">
        <a href="simple_auth/login.php">Login</a> | 
        <a href="simple_auth/register.php">Register</a>
      </li>
    <?php endif; ?>
  </ul>
</nav>


--- End of navbar.php ---



--- Start of opportunities_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$opportunitySchema = require 'opportunity_schema.php';
$contactSchema = require 'contact_schema.php';
$opportunities = readCSV('opportunities.csv', $opportunitySchema) ?: [];
$contacts = readCSV('contacts.csv', $contactSchema) ?: [];

// Index contacts by ID
$contactsById = [];
foreach ($contacts as $c) {
  $contactsById[$c['id'] ?? ''] = $c;
}

// Define pipeline stages (matches opportunities system)
$stages = [
  'Prospecting' => ['color' => '#6366F1', 'icon' => 'üîç'],
  'Qualification' => ['color' => '#8B5CF6', 'icon' => '‚úì'],
];
?>

<?php
require_once 'csv_handler.php';
require_once 'sanitize_helper.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Build contact lookup map
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $company = $contact['company'] ?? '';
    $contactMap[trim($contact['id'])] = [
        'name' => $fullName ?: 'Unnamed Contact',
        'company' => $company
    ];
}

// Calculate statistics
$totalValue = 0;
$wonValue = 0;
$stageGroups = [];

foreach ($opportunities as $opp) {
    $value = floatval($opp['value'] ?? 0);
    $stage = $opp['stage'] ?? 'Unknown';
    
    $totalValue += $value;
    
    if ($stage === 'Closed Won') {
        $wonValue += $value;
    }
    
    if (!isset($stageGroups[$stage])) {
        $stageGroups[$stage] = ['count' => 0, 'value' => 0];
    }
    $stageGroups[$stage]['count']++;
    $stageGroups[$stage]['value'] += $value;
}

// Get filter parameters
$filterStage = $_GET['stage'] ?? '';
$searchQuery = $_GET['search'] ?? '';
$sortBy = $_GET['sort'] ?? 'id';
$sortOrder = $_GET['order'] ?? 'desc';

// Apply filters
$filteredOpportunities = $opportunities;

if ($filterStage) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($filterStage) {
        return ($opp['stage'] ?? '') === $filterStage;
    });
}

if ($searchQuery) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($searchQuery, $contactMap) {
        $contactId = trim($opp['contact_id'] ?? '');
        $contactName = $contactMap[$contactId]['name'] ?? '';
        $contactCompany = $contactMap[$contactId]['company'] ?? '';
        
        return stripos($contactName, $searchQuery) !== false ||
               stripos($contactCompany, $searchQuery) !== false ||
               stripos($opp['id'] ?? '', $searchQuery) !== false ||
               stripos($opp['stage'] ?? '', $searchQuery) !== false;
    });
}

// Apply sorting
usort($filteredOpportunities, function($a, $b) use ($sortBy, $sortOrder, $contactMap) {
    $aVal = $a[$sortBy] ?? '';
    $bVal = $b[$sortBy] ?? '';
    
    // Special handling for contact name sorting
    if ($sortBy === 'contact_name') {
        $aVal = $contactMap[trim($a['contact_id'] ?? '')]['name'] ?? '';
        $bVal = $contactMap[trim($b['contact_id'] ?? '')]['name'] ?? '';
    }
    
    // Numeric sorting for value and probability
    if (in_array($sortBy, ['value', 'probability', 'id'])) {
        $aVal = floatval($aVal);
        $bVal = floatval($bVal);
    }
    
    $comparison = $aVal <=> $bVal;
    return $sortOrder === 'asc' ? $comparison : -$comparison;
});

// Get stage color
function getStageColor($stage) {
    $colors = [
        'Prospecting' => '#6366F1',
        'Proposal' => '#8B5CF6',
        'Negotiation' => '#F59E0B',
        'Closed Won' => '#10B981',
        'Closed Lost' => '#EF4444'
    ];
    return $colors[$stage] ?? '#6B7280';
}
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>

<style>
  .opportunities-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }
  
  .opportunities-header h1 {
    margin: 0 0 16px 0;
    font-size: 32px;
    font-weight: 700;
  }
  
  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .btn-add {
    background: white;
    color: #667eea;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-add:hover {
    background: #f3f4f6;
    transform: translateY(-2px);
  }
  
  .btn-export {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 2px solid white;
  }
  
  .btn-export:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #667eea;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .stat-label {
    font-size: 12px;
    color: #6B7280;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1F2937;
  }
  
  .stat-subtitle {
    font-size: 13px;
    color: #9CA3AF;
    margin-top: 4px;
  }
  
  .filters-bar {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .filters-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .filter-group {
    flex: 1;
    min-width: 200px;
  }
  
  .filter-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    text-transform: uppercase;
  }
  
  .filter-group input,
  .filter-group select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
  }
  
  .filter-group input:focus,
  .filter-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .btn-filter {
    padding: 10px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    align-self: flex-end;
  }
  
  .btn-filter:hover {
    background: #5558dd;
  }
  
  .btn-reset {
    padding: 10px 20px;
    background: #F3F4F6;
    color: #374151;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    align-self: flex-end;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-reset:hover {
    background: #E5E7EB;
  }
  
  .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 24px;
  }
  
  .opportunities-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  
  .opportunities-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .opportunities-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  
  .opportunities-table th:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .opportunities-table th.sortable::after {
    content: ' ‚áÖ';
    opacity: 0.3;
    font-size: 10px;
  }
  
  .opportunities-table th.sorted-asc::after {
    content: ' ‚ñ≤';
    opacity: 1;
  }
  
  .opportunities-table th.sorted-desc::after {
    content: ' ‚ñº';
    opacity: 1;
  }
  
  .opportunities-table tbody tr {
    border-bottom: 1px solid #E5E7EB;
    transition: all 0.2s;
  }
  
  .opportunities-table tbody tr:hover {
    background: #F9FAFB;
  }
  
  .opportunities-table tbody tr:last-child {
    border-bottom: none;
  }
  
  .opportunities-table td {
    padding: 16px 12px;
    vertical-align: middle;
  }
  
  .cell-id {
    font-weight: 600;
    color: #667eea;
    font-size: 13px;
  }
  
  .cell-contact {
    font-weight: 600;
    color: #1F2937;
  }
  
  .cell-company {
    color: #6B7280;
    font-size: 13px;
  }
  
  .cell-value {
    font-weight: 700;
    color: #10B981;
    font-size: 16px;
  }
  
  .cell-probability {
    font-weight: 600;
  }
  
  .cell-stage {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: white;
  }
  
  .cell-date {
    color: #374151;
    font-weight: 500;
  }
  
  .cell-weighted {
    color: #667eea;
    font-weight: 600;
  }
  
  .cell-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .btn-action {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .btn-edit {
    background: #667eea;
    color: white;
  }
  
  .btn-edit:hover {
    background: #5558dd;
    transform: translateY(-1px);
  }
  
  .btn-delete {
    background: #EF4444;
    color: white;
  }
  
  .btn-delete:hover {
    background: #DC2626;
    transform: translateY(-1px);
  }
  
  .alert {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .alert-success {
    background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
    border: 2px solid #10B981;
    color: #065F46;
  }
  
  .alert-error {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border: 2px solid #EF4444;
    color: #991B1B;
  }
  
  .alert-info {
    background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
    border: 2px solid #3B82F6;
    color: #1E40AF;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
  }
  
  .empty-state h3 {
    font-size: 20px;
    color: #1F2937;
    margin-bottom: 8px;
  }
  
  .empty-state p {
    color: #6B7280;
    margin-bottom: 24px;
  }
  
  @media (max-width: 768px) {
    .opportunities-header {
      padding: 24px 16px;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .filters-row {
      flex-direction: column;
    }
    
    .filter-group {
      width: 100%;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .opportunities-table {
      min-width: 800px;
    }
  }
</style>

<!-- View Toggle -->
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="pipeline_board.php" style="padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; text-decoration: none; color: #374151; transition: all 0.2s;">
        üìä Board View
    </a>
    <a href="opportunities_list.php" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.2s;">
        üìã List View
    </a>
    <a href="add_opportunity.php" style="padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; text-decoration: none; color: #374151; transition: all 0.2s;">
        ‚ûï Add Opportunity
    </a>
</div>

<div class="opportunities-header">
  <h1>üíº Opportunities Pipeline</h1>
  <div class="header-actions">
    <a href="export_opportunities.php?<?= http_build_query(['stage' => $filterStage, 'search' => $searchQuery]) ?>" class="btn-export">
      <span>üìä</span>
      <span>Export to CSV</span>
    </a>
    <a href="add_opportunity.php" class="btn-add">
      <span>‚ûï</span>
      <span>New Opportunity</span>
    </a>
  </div>
</div>

<!-- Success/Error Messages -->
<?php if (isset($_GET['success'])): ?>
  <div class="alert alert-success">
    <span>‚úì</span>
    <span>
      <?php
        if ($_GET['success'] == '1') echo 'Opportunity created successfully!';
        elseif ($_GET['success'] == '2') echo 'Opportunity updated successfully!';
        elseif ($_GET['success'] == '3') echo 'Opportunity deleted successfully!';
        else echo 'Action completed successfully!';
      ?>
    </span>
  </div>
<?php endif; ?>

<?php if (isset($_GET['error'])): ?>
  <div class="alert alert-error">
    <span>‚ö†Ô∏è</span>
    <span><?= htmlspecialchars($_GET['error']) ?></span>
  </div>
<?php endif; ?>

<!-- Statistics Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Total Pipeline Value</div>
    <div class="stat-value"><?= formatCurrency($totalValue) ?></div>
    <div class="stat-subtitle"><?= count($opportunities) ?> opportunities</div>
  </div>
  
  <div class="stat-card" style="border-left-color: #10B981;">
    <div class="stat-label">Closed Won</div>
    <div class="stat-value" style="color: #10B981;"><?= formatCurrency($wonValue) ?></div>
    <div class="stat-subtitle"><?= $stageGroups['Closed Won']['count'] ?? 0 ?> deals</div>
  </div>
  
  <div class="stat-card" style="border-left-color: #F59E0B;">
    <div class="stat-label">In Negotiation</div>
    <div class="stat-value" style="color: #F59E0B;"><?= formatCurrency($stageGroups['Negotiation']['value'] ?? 0) ?></div>
    <div class="stat-subtitle"><?= $stageGroups['Negotiation']['count'] ?? 0 ?> deals</div>
  </div>
  
  <div class="stat-card" style="border-left-color: #6366F1;">
    <div class="stat-label">Active Opportunities</div>
    <div class="stat-value" style="color: #6366F1;">
      <?= count(array_filter($opportunities, fn($o) => !in_array($o['stage'] ?? '', ['Closed Won', 'Closed Lost']))) ?>
    </div>
    <div class="stat-subtitle">Open deals</div>
  </div>
</div>

<!-- Filters -->
<div class="filters-bar">
  <form method="GET" action="">
    <div class="filters-row">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" name="search" placeholder="Search by contact, company, or ID..." value="<?= htmlspecialchars($searchQuery) ?>">
      </div>
      
      <div class="filter-group">
        <label>Stage</label>
        <select name="stage">
          <option value="">All Stages</option>
          <option value="Prospecting" <?= $filterStage === 'Prospecting' ? 'selected' : '' ?>>Prospecting</option>
          <option value="Proposal" <?= $filterStage === 'Proposal' ? 'selected' : '' ?>>Proposal</option>
          <option value="Negotiation" <?= $filterStage === 'Negotiation' ? 'selected' : '' ?>>Negotiation</option>
          <option value="Closed Won" <?= $filterStage === 'Closed Won' ? 'selected' : '' ?>>Closed Won</option>
          <option value="Closed Lost" <?= $filterStage === 'Closed Lost' ? 'selected' : '' ?>>Closed Lost</option>
        </select>
      </div>
      
      <button type="submit" class="btn-filter">üîç Filter</button>
      <?php if ($filterStage || $searchQuery): ?>
        <a href="opportunities_list.php" class="btn-reset">‚úï Reset</a>
      <?php endif; ?>
    </div>
  </form>
</div>

<!-- Opportunities Table -->
<?php if (empty($filteredOpportunities)): ?>
  <div class="empty-state">
    <div class="empty-state-icon">üíº</div>
    <h3>No opportunities found</h3>
    <p>
      <?php if ($filterStage || $searchQuery): ?>
        No opportunities match your filters. Try adjusting your search criteria.
      <?php else: ?>
        Get started by creating your first opportunity!
      <?php endif; ?>
    </p>
    <?php if (!$filterStage && !$searchQuery): ?>
      <a href="add_opportunity.php" class="btn-add">‚ûï Create Opportunity</a>
    <?php endif; ?>
  </div>
<?php else: ?>
  <div class="table-container">
    <table class="opportunities-table">
      <thead>
        <tr>
          <th class="sortable <?= $sortBy === 'id' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('id')">ID</th>
          <th class="sortable <?= $sortBy === 'contact_name' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('contact_name')">Contact</th>
          <th>Company</th>
          <th class="sortable <?= $sortBy === 'value' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('value')">Value</th>
          <th class="sortable <?= $sortBy === 'probability' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('probability')">Probability</th>
          <th>Weighted Value</th>
          <th class="sortable <?= $sortBy === 'stage' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('stage')">Stage</th>
          <th class="sortable <?= $sortBy === 'expected_close' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('expected_close')">Expected Close</th>
          <th style="text-align: right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($filteredOpportunities as $opp): ?>
          <?php
            $contactId = trim($opp['contact_id'] ?? '');
            $contactInfo = $contactMap[$contactId] ?? ['name' => 'Unknown Contact', 'company' => ''];
            $stage = $opp['stage'] ?? 'Unknown';
            $stageColor = getStageColor($stage);
            $value = $opp['value'] ?? 0;
            $probability = $opp['probability'] ?? 0;
            $weightedValue = $value * ($probability / 100);
          ?>
          <tr>
            <td class="cell-id">#<?= htmlspecialchars($opp['id']) ?></td>
            <td class="cell-contact"><?= htmlspecialchars($contactInfo['name']) ?></td>
            <td class="cell-company"><?= htmlspecialchars($contactInfo['company'] ?: '‚Äî') ?></td>
            <td class="cell-value"><?= formatCurrency($value) ?></td>
            <td class="cell-probability"><?= htmlspecialchars($probability) ?>%</td>
            <td class="cell-weighted"><?= formatCurrency($weightedValue) ?></td>
            <td>
              <span class="cell-stage" style="background-color: <?= $stageColor ?>;">
                <?= htmlspecialchars($stage) ?>
              </span>
            </td>
            <td class="cell-date"><?= htmlspecialchars($opp['expected_close'] ?? '‚Äî') ?></td>
            <td class="cell-actions">
              <a href="edit_opportunity.php?id=<?= urlencode($opp['id']) ?>" class="btn-action btn-edit" title="Edit">‚úèÔ∏è Edit</a>
              <form method="POST" action="delete_opportunity.php" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this opportunity?');">
                <input type="hidden" name="id" value="<?= htmlspecialchars($opp['id']) ?>">
                <button type="submit" class="btn-action btn-delete" title="Delete">üóëÔ∏è Delete</button>
              </form>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
<?php endif; ?>

<script>
  function sortTable(column) {
    const currentSort = '<?= $sortBy ?>';
    const currentOrder = '<?= $sortOrder ?>';
    
    let newOrder = 'asc';
    if (currentSort === column && currentOrder === 'asc') {
      newOrder = 'desc';
    }
    
    // Build URL with current filters and new sort
    const url = new URL(window.location.href);
    url.searchParams.set('sort', column);
    url.searchParams.set('order', newOrder);
    
    window.location.href = url.toString();
  }
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunities_list.php ---



--- Start of opportunity_form.php ---

<?php
require_once 'csv_handler.php';
require_once 'sanitize_helper.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Build contact lookup map
$contactMap = [];
foreach ($contacts as $contact) {
  $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
  $company = $contact['company'] ?? '';
  $contactMap[trim($contact['id'])] = [
    'name' => $fullName ?: 'Unnamed Contact',
    'company' => $company
  ];
}

// Calculate statistics
$totalValue = 0;
?>
<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); ?>

<div class="container">
  <h2>Add New Opportunity</h2>

  <?php if (!empty($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Opportunity saved successfully.</p>
  <?php elseif (!empty($_GET['status']) && $_GET['status'] === 'error'): ?>
    <p class="error-msg">Invalid opportunity data or contact ID.</p>
  <?php endif; ?>

  <form id="opportunity-form" action="add_opportunity.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>

      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>

        <?php if ($field === 'contact_id'): ?>
          <select name="contact_id" id="contact_id" class="form-control" required>
            <option value="">Select Contact</option>
            <?php foreach ($contacts as $contact): ?>
              <option value="<?= $contact['id'] ?>">
                <?= trim($contact['first_name'] . ' ' . $contact['last_name']) ?: 'Unnamed Contact' ?>
              </option>
            <?php endforeach; ?>
          </select>

        <?php elseif ($field === 'stage'): ?>
          <select name="stage" id="stage" class="form-control" required>
            <option value="">Select Stage</option>
            <option value="Prospecting">Prospecting</option>
            <option value="Proposal">Proposal</option>
            <option value="Negotiation">Negotiation</option>
            <option value="Closed Won">Closed Won</option>
            <option value="Closed Lost">Closed Lost</option>
          </select>

        <?php elseif ($field === 'expected_close'): ?>
          <input type="date" name="expected_close" id="expected_close" class="form-control" required>

        <?php elseif ($field === 'value' || $field === 'probability'): ?>
          <input type="number" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>

        <?php else: ?>
          <input type="text" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
        <?php endif; ?>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Opportunity</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunity_form.php ---



--- Start of opportunity_schema.php ---

<?php
$schema = [
  'id' => 'integer',
  'name' => 'string',
  'value' => 'float',
  'stage' => 'string',
];
return $schema;
?>

<?php
return [
  'id',
  'contact_id',
  'value',
  'stage',
  'probability',
  'expected_close'
];


--- End of opportunity_schema.php ---



--- Start of opportunity_schema_enhanced.php ---

<?php
$schema = [
    'id' => 'integer',
    'name' => 'string',
    'value' => 'float',
    'stage' => 'string',
    'contact_id' => 'integer',
];
return $schema;
?>
<?php
/**
 * Enhanced Opportunity Schema - Hybrid Business Model
 * Handles both equipment sales and service contract opportunities
 */
return [
    'id',                   // Unique opportunity ID
    'contact_id',           // Link to contact
    'customer_id',          // Link to customer (optional)
    'opportunity_type',     // Equipment Sale / Service Contract / Renewal / Upsell / Replacement
    'revenue_model',        // One-time / Monthly Recurring / Annual Recurring
    'name',                 // Opportunity name/description
    'value',                // Total opportunity value
    'monthly_value',        // Monthly recurring value (if applicable)
    'annual_value',         // Annual recurring value (if applicable)
    'contract_term',        // Contract term in months (for SDI)
    'stage',                // Prospecting / Qualification / Proposal / Negotiation / Closed Won / Closed Lost
    'probability',          // Win probability (0-100)
    'expected_close',       // Expected close date
    'actual_close',         // Actual close date
    'equipment_type',       // What equipment/service involved
    'product_details',      // Detailed product/service description
    'competitor',           // Competing against (if replacement)
    'payment_terms',        // Net 30 / Net 60 / Monthly / Quarterly
    'source',               // Lead source (Referral / Website / Cold Call / etc)
    'lost_reason',          // Why opportunity was lost (if applicable)
    'contract_id',          // Linked contract ID (after won)
    'equipment_ids',        // Linked equipment IDs (after won)
    'notes',                // Opportunity notes
    'created_date',         // Opportunity creation date
    'created_by',           // User who created
    'modified_date',        // Last modification date
    'modified_by'           // User who last modified
];


--- End of opportunity_schema_enhanced.php ---



--- Start of php_info.php ---

<?php
phpinfo();
?>
<?php
phpinfo();
?>


--- End of php_info.php ---



--- Start of pipeline_board.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$opportunitySchema = require 'opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $opportunitySchema) ?: [];

// Group opportunities by stage
$opportunitiesByStage = [];
foreach ($opportunities as $opp) {
    $stage = $opp['stage'] ?? 'Prospecting';
    if (!isset($opportunitiesByStage[$stage])) {
        $opportunitiesByStage[$stage] = [];
    }
    $opportunitiesByStage[$stage][] = $opp;
}

// Display pipeline board
?>
<?php
$pageTitle = 'Sales Pipeline Board';
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

// Load opportunities and contacts
$opportunitySchema = require 'opportunity_schema.php';
$contactSchema = require 'contact_schema.php';
$opportunities = readCSV('opportunities.csv', $opportunitySchema) ?: [];
$contacts = readCSV('contacts.csv', $contactSchema) ?: [];

// Index contacts by ID
$contactsById = [];
foreach ($contacts as $c) {
    $contactsById[$c['id'] ?? ''] = $c;
}

// Define pipeline stages (matches opportunities system)
$stages = [
    'Prospecting' => ['color' => '#6366F1', 'icon' => 'üîç'],
    'Qualification' => ['color' => '#8B5CF6', 'icon' => '‚úì'],
    'Proposal' => ['color' => '#EC4899', 'icon' => 'üìÑ'],
    'Negotiation' => ['color' => '#F59E0B', 'icon' => 'üí¨'],
    'Closed Won' => ['color' => '#10B981', 'icon' => 'üéâ'],
    'Closed Lost' => ['color' => '#EF4444', 'icon' => '‚ùå']
];

// Group opportunities by stage
$opportunitiesByStage = [];
foreach ($stages as $stageName => $stageInfo) {
    $opportunitiesByStage[$stageName] = [];
}

foreach ($opportunities as $opp) {
    $stage = $opp['stage'] ?? 'Prospecting';
    if (isset($opportunitiesByStage[$stage])) {
        $opportunitiesByStage[$stage][] = $opp;
    }
}

// Calculate statistics for each stage
$stageStats = [];
foreach ($stages as $stageName => $stageInfo) {
    $stageOpps = $opportunitiesByStage[$stageName];
    $count = count($stageOpps);
    $totalValue = array_reduce($stageOpps, function($sum, $opp) {
        return $sum + ((float)($opp['value'] ?? 0));
    }, 0);
    $weightedValue = array_reduce($stageOpps, function($sum, $opp) {
        $value = (float)($opp['value'] ?? 0);
        $prob = (float)($opp['probability'] ?? 0) / 100;
        return $sum + ($value * $prob);
    }, 0);
    
    $stageStats[$stageName] = [
        'count' => $count,
        'total_value' => $totalValue,
        'weighted_value' => $weightedValue
    ];
}

// Handle AJAX stage update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_stage'])) {
    $oppId = $_POST['opportunity_id'] ?? '';
    $newStage = $_POST['new_stage'] ?? '';
    
    // Find and update the opportunity
    foreach ($opportunities as &$opp) {
        if ($opp['id'] === $oppId) {
            $opp['stage'] = $newStage;
            
            // Auto-adjust probability based on stage
            $probabilities = [
                'Prospecting' => 10,
                'Qualification' => 25,
                'Proposal' => 50,
                'Negotiation' => 75,
                'Closed Won' => 100,
                'Closed Lost' => 0
            ];
            $opp['probability'] = $probabilities[$newStage] ?? $opp['probability'];
            break;
        }
    }
    
    writeCSV('opportunities.csv', $opportunities, $opportunitySchema);
    
    header('Content-Type: application/json');
    echo json_encode(['success' => true]);
    exit;
}

if (!function_exists('formatCurrency')) {
    function formatCurrency($amount) {
        return '$' . number_format($amount, 0);
    }
}
?>

<style>
/* Pipeline Board Styles */
.pipeline-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
}

.pipeline-header h1 {
    margin: 0 0 15px 0;
    font-size: 32px;
    font-weight: 700;
}

.pipeline-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255,255,255,0.15);
    padding: 15px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.stat-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    margin-top: 5px;
}

/* Pipeline Board */
.pipeline-board {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 10px 0 30px 0;
    min-height: 600px;
}

.pipeline-column {
    flex: 0 0 300px;
    background: #f9fafb;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    max-height: 80vh;
}

.column-header {
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.column-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 15px;
}

.column-count {
    background: rgba(255,255,255,0.3);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.column-stats {
    font-size: 11px;
    margin-top: 8px;
    opacity: 0.95;
    font-weight: 600;
}

.cards-container {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-right: 5px;
}

.deal-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    cursor: move;
    transition: all 0.2s;
    border-left: 4px solid;
}

.deal-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.deal-card.dragging {
    opacity: 0.5;
}

.deal-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 10px;
}

.deal-id {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 600;
}

.deal-value {
    font-size: 18px;
    font-weight: 700;
    color: #10B981;
}

.deal-contact {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
    margin-bottom: 4px;
}

.deal-company {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
}

.deal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #e5e7eb;
}

.deal-probability {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
}

.probability-bar {
    width: 60px;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
}

.probability-fill {
    height: 100%;
    background: linear-gradient(90deg, #3B82F6, #10B981);
    border-radius: 2px;
}

.deal-date {
    font-size: 11px;
    color: #9ca3af;
}

.deal-actions {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}

.deal-action-btn {
    flex: 1;
    padding: 6px;
    background: #f3f4f6;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.deal-action-btn:hover {
    background: #e5e7eb;
}

.drop-zone {
    min-height: 100px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 13px;
    padding: 20px;
    text-align: center;
}

.drop-zone.drag-over {
    border-color: #3B82F6;
    background: #eff6ff;
    color: #3B82F6;
}

/* Scrollbar styling */
.cards-container::-webkit-scrollbar {
    width: 6px;
}

.cards-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.cards-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

.cards-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.view-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.view-btn {
    padding: 10px 20px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    color: #374151;
}

.view-btn:hover {
    border-color: #667eea;
    color: #667eea;
}

.view-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
}

@media (max-width: 768px) {
    .pipeline-board {
        flex-direction: column;
    }
    
    .pipeline-column {
        flex: 1 1 auto;
        max-height: none;
    }
}
</style>

<div class="pipeline-header">
    <h1>üìä Sales Pipeline Board</h1>
    <p style="margin: 0; opacity: 0.9;">Drag and drop opportunities between stages to update</p>
    
    <div class="pipeline-stats">
        <div class="stat-card">
            <div class="stat-label">Total Pipeline</div>
            <div class="stat-value">
                <?php 
                $totalPipeline = array_reduce($opportunities, function($sum, $opp) {
                    return $sum + ((float)($opp['value'] ?? 0));
                }, 0);
                echo formatCurrency($totalPipeline);
                ?>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Weighted Value</div>
            <div class="stat-value">
                <?php 
                $weightedTotal = array_reduce($opportunities, function($sum, $opp) {
                    $value = (float)($opp['value'] ?? 0);
                    $prob = (float)($opp['probability'] ?? 0) / 100;
                    return $sum + ($value * $prob);
                }, 0);
                echo formatCurrency($weightedTotal);
                ?>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Deals</div>
            <div class="stat-value"><?= count($opportunities) ?></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Close Rate</div>
            <div class="stat-value">
                <?php
                $closedWonCount = count($opportunitiesByStage['Closed Won'] ?? []);
                $closedLostCount = count($opportunitiesByStage['Closed Lost'] ?? []);
                $totalClosed = $closedWonCount + $closedLostCount;
                $closeRate = $totalClosed > 0 ? round(($closedWonCount / $totalClosed) * 100) : 0;
                echo $closeRate . '%';
                ?>
            </div>
        </div>
    </div>
</div>

<div class="view-toggle">
    <a href="pipeline_board.php" class="view-btn active">üìä Board View</a>
    <a href="opportunities_list.php" class="view-btn">üìã List View</a>
    <a href="add_opportunity.php" class="view-btn">‚ûï Add Opportunity</a>
</div>

<div class="pipeline-board">
    <?php foreach ($stages as $stageName => $stageInfo): ?>
        <div class="pipeline-column" data-stage="<?= htmlspecialchars($stageName) ?>">
            <div class="column-header" style="background: <?= $stageInfo['color'] ?>;">
                <div>
                    <div class="column-title">
                        <span><?= $stageInfo['icon'] ?></span>
                        <span><?= htmlspecialchars($stageName) ?></span>
                        <span class="column-count"><?= $stageStats[$stageName]['count'] ?></span>
                    </div>
                    <div class="column-stats">
                        <?= formatCurrency($stageStats[$stageName]['total_value']) ?>
                        (<?= formatCurrency($stageStats[$stageName]['weighted_value']) ?> weighted)
                    </div>
                </div>
            </div>
            
            <div class="cards-container">
                <?php if (empty($opportunitiesByStage[$stageName])): ?>
                    <div class="drop-zone">
                        Drop opportunities here
                    </div>
                <?php else: ?>
                    <?php foreach ($opportunitiesByStage[$stageName] as $opp): ?>
                        <?php
                        $contact = $contactsById[$opp['contact_id'] ?? ''] ?? null;
                        $contactName = $contact ? trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? '')) : 'Unknown';
                        $company = $contact['company'] ?? 'No Company';
                        ?>
                        <div class="deal-card" 
                             draggable="true" 
                             data-id="<?= htmlspecialchars($opp['id']) ?>"
                             style="border-left-color: <?= $stageInfo['color'] ?>;">
                            <div class="deal-header">
                                <span class="deal-id">#<?= htmlspecialchars($opp['id']) ?></span>
                                <span class="deal-value"><?= formatCurrency($opp['value'] ?? 0) ?></span>
                            </div>
                            
                            <div class="deal-contact"><?= htmlspecialchars($contactName) ?></div>
                            <div class="deal-company"><?= htmlspecialchars($company) ?></div>
                            
                            <div class="deal-footer">
                                <div class="deal-probability">
                                    <div class="probability-bar">
                                        <div class="probability-fill" style="width: <?= $opp['probability'] ?? 0 ?>%;"></div>
                                    </div>
                                    <span><?= $opp['probability'] ?? 0 ?>%</span>
                                </div>
                                <div class="deal-date">
                                    <?= $opp['expected_close'] ? date('M d', strtotime($opp['expected_close'])) : '‚Äî' ?>
                                </div>
                            </div>
                            
                            <div class="deal-actions">
                                <a href="edit_opportunity.php?id=<?= htmlspecialchars($opp['id']) ?>" class="deal-action-btn">‚úèÔ∏è Edit</a>
                                <a href="contact_view.php?id=<?= htmlspecialchars($opp['contact_id']) ?>" class="deal-action-btn">üë§ Contact</a>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </div>
    <?php endforeach; ?>
</div>

<script>
// Drag and Drop functionality
let draggedElement = null;

document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.deal-card');
    const columns = document.querySelectorAll('.pipeline-column');
    
    // Make cards draggable
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Make columns accept drops
    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
    });
});

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const cardsContainer = this.querySelector('.cards-container');
    cardsContainer.classList.add('drag-over');
    
    return false;
}

function handleDragLeave(e) {
    const cardsContainer = this.querySelector('.cards-container');
    if (e.target === cardsContainer) {
        cardsContainer.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const cardsContainer = this.querySelector('.cards-container');
    cardsContainer.classList.remove('drag-over');
    
    if (draggedElement) {
        const newStage = this.dataset.stage;
        const oppId = draggedElement.dataset.id;
        const oldStage = draggedElement.closest('.pipeline-column').dataset.stage;
        
        if (newStage !== oldStage) {
            // Update via AJAX
            const formData = new FormData();
            formData.append('update_stage', '1');
            formData.append('opportunity_id', oppId);
            formData.append('new_stage', newStage);
            
            fetch('pipeline_board.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show updated stats
                    window.location.reload();
                } else {
                    alert('Failed to update opportunity stage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update opportunity stage');
            });
        }
    }
    
    return false;
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of pipeline_board.php ---



--- Start of purchase_orders_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$purchaseOrders = readCSV('purchase_orders.csv', $schema);

// Process purchase orders
foreach ($purchaseOrders as $order) {
  // Logic to process each order
}

// Display purchase orders
?>
<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$orders = readCSV($poFile, $schema);

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_po'])) {
  $poToDelete = trim($_POST['po_number'] ?? '');
  if ($poToDelete !== '') {
    $orders = array_values(array_filter($orders, function($row) use ($poToDelete) {
      return ($row['po_number'] ?? '') !== $poToDelete;
    }));
    writeCSV($poFile, $orders, $schema);
  }
  header('Location: purchase_orders_list.php');
  exit;
}

function to_float($value) {
  return is_numeric($value) ? (float)$value : 0.0;
}

// Build filter array from GET
$filters = [];
foreach ($schema as $f) {
  $filters[$f] = isset($_GET[$f]) ? trim($_GET[$f]) : '';
}

// Filter orders by all non-empty fields
$filtered = $orders;
foreach ($filters as $field => $val) {
  if ($val !== '') {
    $filtered = array_filter($filtered, function($order) use ($field, $val) {
      return stripos($order[$field] ?? '', $val) !== false;
    });
  }
}

$poGroups = [];
foreach ($filtered as $row) {
  $poNumber = trim($row['po_number'] ?? '');
  if ($poNumber === '') {
    continue;
  }
  if (!isset($poGroups[$poNumber])) {
    $poGroups[$poNumber] = [
      'header' => $row,
      'items' => [],
      'total_qty' => 0.0,
      'item_count' => 0
    ];
  }
  $poGroups[$poNumber]['items'][] = $row;
  $poGroups[$poNumber]['total_qty'] += to_float($row['quantity'] ?? '');
  $poGroups[$poNumber]['item_count'] += 1;
}

$poGroups = array_values($poGroups);
?>
<div class="container">
  <h2>Purchase Orders</h2>
  <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
    <a href="purchase_order_add.php" class="btn-outline">‚ûï Add Purchase Order</a>
  </div>
  <style>
    .po-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    .po-list {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      max-height: 70vh;
      overflow: auto;
    }
    .po-list-item {
      width: 100%;
      text-align: left;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      background: #f9fafb;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .po-list-item.active {
      background: #e9eef6;
      border-color: #8aa4c8;
    }
    .po-list-title { font-weight: 600; margin-bottom: 4px; }
    .po-list-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.9em;
      color: #555;
    }
    .po-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f3f6;
      border: 1px solid #d9dee7;
    }
    .po-detail {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 14px;
      background: #fff;
      min-height: 200px;
    }
    .po-detail-panel { display: none; }
    .po-detail-panel.active { display: block; }
    .po-detail-title { font-weight: 700; margin-bottom: 10px; }
    .po-section { margin-bottom: 14px; }
    .po-section-title { font-weight: 700; margin-bottom: 8px; }
    .po-section-grid {
      display: grid;
      grid-template-columns: 160px 1fr 160px 1fr;
      gap: 8px 16px;
      align-items: center;
    }
    .po-label { font-weight: 600; color: #222; }
    .po-value { color: #333; }
    .po-actions { display: flex; gap: 8px; margin-bottom: 12px; }
    .po-actions button[disabled] { opacity: 0.6; cursor: not-allowed; }
    @media (max-width: 900px) {
      .po-layout { grid-template-columns: 1fr; }
      .po-list { max-height: none; }
      .po-section-grid { grid-template-columns: 160px 1fr; }
    }
  </style>
  <?php if (empty($poGroups)): ?>
    <div style="text-align:center; color:#888;">No purchase orders found.</div>
  <?php else: ?>
    <div class="po-layout">
      <div class="po-list" id="poList">
        <?php foreach ($poGroups as $index => $group): ?>
          <?php
            $header = $group['header'];
            $poNumber = $header['po_number'] ?? '';
            $supplier = $header['supplier_name'] ?? '';
            $date = $header['date'] ?? '';
          ?>
          <button
            type="button"
            class="po-list-item"
            data-target="po-detail-<?= $index ?>"
          >
            <div class="po-list-title"><?= htmlspecialchars($supplier !== '' ? $supplier : $poNumber) ?></div>
            <div class="po-list-meta">
              <?php if ($poNumber !== ''): ?><span class="po-pill">PO: <?= htmlspecialchars($poNumber) ?></span><?php endif; ?>
              <?php if ($date !== ''): ?><span class="po-pill">Date: <?= htmlspecialchars($date) ?></span><?php endif; ?>
              <span class="po-pill">Items: <?= htmlspecialchars((string)$group['item_count']) ?></span>
              <span class="po-pill">Qty: <?= htmlspecialchars((string)$group['total_qty']) ?></span>
            </div>
          </button>
        <?php endforeach; ?>
      </div>
      <div class="po-detail" id="poDetail">
        <?php foreach ($poGroups as $index => $group): ?>
          <?php
            $header = $group['header'];
            $poNumber = $header['po_number'] ?? '';
            $supplier = $header['supplier_name'] ?? '';
            $poLink = urlencode($poNumber);
          ?>
          <div class="po-detail-panel" id="po-detail-<?= $index ?>">
            <div class="po-detail-title"><?= htmlspecialchars($poNumber) ?><?= $supplier !== '' ? ' - ' . htmlspecialchars($supplier) : '' ?></div>
            <div class="po-actions">
              <a href="purchase_order_summary.php?po=<?= $poLink ?>" class="btn-outline">View Supplier Form</a>
              <a href="purchase_order_receive.php?po=<?= $poLink ?>" class="btn-outline">Receive</a>
              <a href="purchase_order_edit.php?po=<?= $poLink ?>" class="btn-outline">Edit</a>
              <form method="post" onsubmit="return confirm('Delete purchase order <?= htmlspecialchars($poNumber) ?>?');">
                <input type="hidden" name="delete_po" value="1">
                <input type="hidden" name="po_number" value="<?= htmlspecialchars($poNumber) ?>">
                <button type="submit" class="btn-outline">Delete</button>
              </form>
            </div>
            <div class="po-section">
              <div class="po-section-title">Summary</div>
              <div class="po-section-grid">
                <div class="po-label">PO Number</div>
                <div class="po-value"><?= htmlspecialchars($poNumber) ?></div>
                <div class="po-label">Date</div>
                <div class="po-value"><?= htmlspecialchars($header['date'] ?? '') ?></div>
                <div class="po-label">Status</div>
                <div class="po-value"><?= htmlspecialchars($header['status'] ?? '') ?></div>
                <div class="po-label">Supplier</div>
                <div class="po-value"><?= htmlspecialchars($supplier) ?></div>
                <div class="po-label">Expected Delivery</div>
                <div class="po-value"><?= htmlspecialchars($header['expected_delivery'] ?? '') ?></div>
                <div class="po-label">Payment Terms</div>
                <div class="po-value"><?= htmlspecialchars($header['payment_terms'] ?? '') ?></div>
              </div>
            </div>
            <div class="po-section">
              <div class="po-section-title">Addresses</div>
              <div class="po-section-grid">
                <div class="po-label">Supplier Address</div>
                <div class="po-value"><?= htmlspecialchars($header['supplier_address'] ?? '') ?></div>
                <div class="po-label">Billing Address</div>
                <div class="po-value"><?= htmlspecialchars($header['billing_address'] ?? '') ?></div>
                <div class="po-label">Shipping Address</div>
                <div class="po-value"><?= htmlspecialchars($header['shipping_address'] ?? '') ?></div>
                <div class="po-label">Notes</div>
                <div class="po-value"><?= htmlspecialchars($header['notes'] ?? '') ?></div>
              </div>
            </div>
            <div class="po-section">
              <div class="po-section-title">Items</div>
              <div style="overflow-x:auto;">
                <table border="1" cellpadding="6" style="width:100%; font-size:0.95em; border-collapse:collapse;">
                  <thead style="background:#f5f5f5;">
                    <tr>
                      <th style="padding:8px 6px;">Item ID</th>
                      <th style="padding:8px 6px;">Item Name</th>
                      <th style="padding:8px 6px;">Qty</th>
                      <th style="padding:8px 6px;">Unit</th>
                      <th style="padding:8px 6px;">Unit Price</th>
                      <th style="padding:8px 6px;">Discount</th>
                      <th style="padding:8px 6px;">Tax</th>
                      <th style="padding:8px 6px;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php foreach ($group['items'] as $item): ?>
                      <tr>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['item_id'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['item_name'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['quantity'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['unit'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['unit_price'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['discount'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['tax_amount'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['total'] ?? '') ?> </td>
                      </tr>
                    <?php endforeach; ?>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
    <script>
      const poListItems = Array.from(document.querySelectorAll('.po-list-item'));
      const poDetailPanels = Array.from(document.querySelectorAll('.po-detail-panel'));

      function activatePO(item) {
        poListItems.forEach(btn => btn.classList.remove('active'));
        poDetailPanels.forEach(panel => panel.classList.remove('active'));
        if (!item) {
          return;
        }
        item.classList.add('active');
        const targetId = item.getAttribute('data-target');
        const panel = document.getElementById(targetId);
        if (panel) {
          panel.classList.add('active');
        }
      }

      poListItems.forEach(btn => {
        btn.addEventListener('click', () => activatePO(btn));
      });

      activatePO(poListItems[0]);
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_orders_list.php ---



--- Start of purchase_order_add.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';


$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$errors = [];
$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$inventory = readCSV($inventoryFile, $inventorySchema);

function generate_po_number() {
  $prefix = 'EWTPO' . date('Ymd');
  $poFile = __DIR__ . '/purchase_orders.csv';
  $count = 1;
  if (file_exists($poFile)) {
    $lines = file($poFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $today = date('Ymd');
    $matches = array_filter($lines, function($line) use ($today) {
      return strpos($line, 'EWTPO' . $today) === 0;
    });
    $count = count($matches) + 1;
  }
  return $prefix . str_pad($count, 3, '0', STR_PAD_LEFT);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $orders = readCSV($poFile, $schema);
  $po_number = generate_po_number();
  $date = date('Y-m-d');
  $created_at = date('Y-m-d H:i:s');
  $updated_at = $created_at;
  $item_count = isset($_POST['item_id']) ? count($_POST['item_id']) : 0;
  for ($i = 0; $i < $item_count; $i++) {
    $newPO = [];
    foreach ($schema as $f) {
      if (in_array($f, ['item_id','item_name','quantity','unit','unit_price','discount','tax_rate','tax_amount','total'])) {
        $newPO[$f] = trim($_POST[$f][$i] ?? '');
      } else {
        $newPO[$f] = trim($_POST[$f] ?? '');
      }
    }
    $newPO['po_number'] = $po_number;
    $newPO['date'] = $date;
    $newPO['created_at'] = $created_at;
    $newPO['updated_at'] = $updated_at;
    $orders[] = $newPO;
  }
  writeCSV($poFile, $orders, $schema);
  header('Location: purchase_orders_list.php');
  exit;
}
?>
<div class="container">
  <h2>Add Purchase Order</h2>
  <form method="post" style="max-width:900px; margin:auto; background:#fafbfc; border-radius:8px; padding:24px 28px 18px 28px; box-shadow:0 2px 8px #0001;">
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px 24px; margin-bottom:18px; align-items:end;">
      <?php foreach ($schema as $f):
        if (in_array($f, ['created_at','updated_at','po_number','date','item_id','item_name','quantity','unit','unit_price','discount','tax_rate','tax_amount','total'])) continue;
        $readonly = '';
        $value = htmlspecialchars($_POST[$f] ?? '');
      ?>
        <div style="display:flex; flex-direction:column; min-width:160px;">
          <label for="<?= $f ?>" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;"> <?= htmlspecialchars(ucwords(str_replace('_',' ',$f))) ?> </label>
          <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= $value ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;" <?= $readonly ?> >
        </div>
      <?php endforeach; ?>
      <div style="display:flex; flex-direction:column; min-width:120px;">
        <label for="po_number" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">PO Number</label>
        <input type="text" name="po_number" id="po_number" value="<?= generate_po_number() ?>" readonly style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:0.97em;">
      </div>
      <div style="display:flex; flex-direction:column; min-width:120px;">
        <label for="date" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">Date</label>
        <input type="text" name="date" id="date" value="<?= date('Y-m-d') ?>" readonly style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:0.97em;">
      </div>
    </div>
    <h3 style="margin:18px 0 8px 0; font-size:1.13em; color:#222;">Order Items</h3>
    <table id="po-items-table" style="width:100%; border-collapse:collapse; margin-bottom:12px; background:#fff;">
      <thead>
        <tr style="background:#f5f5f5; font-size:0.97em;">
          <th style="padding:6px 4px;">Item</th>
          <th style="padding:6px 4px;">Item Name</th>
          <th style="padding:6px 4px;">Qty</th>
          <th style="padding:6px 4px;">Unit</th>
          <th style="padding:6px 4px;">Unit Price</th>
          <th style="padding:6px 4px;">Discount</th>
          <th style="padding:6px 4px;">Tax %</th>
          <th style="padding:6px 4px;">Tax Amt</th>
          <th style="padding:6px 4px;">Total</th>
          <th style="padding:6px 4px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select name="item_id[]" style="width:120px; padding:3px 5px; font-size:0.97em;">
              <option value="">-- Select --</option>
              <?php foreach ($inventory as $item): ?>
                <option value="<?= htmlspecialchars($item['item_id']) ?>">
                  <?= htmlspecialchars($item['item_id']) ?>
                </option>
              <?php endforeach; ?>
            </select>
          </td>
          <td><input type="text" name="item_name[]" style="width:110px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="quantity[]" min="1" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="text" name="unit[]" style="width:50px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="unit_price[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="discount[]" step="0.01" style="width:60px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="tax_rate[]" step="0.01" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="tax_amount[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="total[]" step="0.01" style="width:85px; padding:3px 5px; font-size:0.97em;"></td>
          <td><button type="button" onclick="removeRow(this)" style="padding:2px 7px; font-size:1.1em;">üóë</button></td>
        </tr>
      </tbody>
    </table>
    <button type="button" onclick="addRow()" style="margin-bottom:18px;">‚ûï Add Item</button>
    <div style="margin-top:18px; text-align:center;">
      <button type="submit" class="btn-primary" style="padding:7px 22px; font-size:1.08em;">üíæ Save Purchase Order</button>
      <a href="purchase_orders_list.php" class="btn-outline" style="margin-left:18px;">Cancel</a>
    </div>
  </form>
  <script>
    function addRow() {
      const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
      const row = table.rows[0].cloneNode(true);
      // Clear all input values in the new row
      Array.from(row.querySelectorAll('input,select')).forEach(el => el.value = '');
      table.appendChild(row);
    }
    function removeRow(btn) {
      const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
      if (table.rows.length > 1) {
        btn.closest('tr').remove();
      }
    }
  </script>
  </form>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_add.php ---



--- Start of purchase_order_edit.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$inventory = readCSV($inventoryFile, $inventorySchema);
$orders = readCSV($poFile, $schema);

$itemFields = ['item_id','item_name','quantity','unit','unit_price','discount','tax_rate','tax_amount','total'];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_po'])) {
  $poNumber = trim($_POST['po_number'] ?? '');
  if ($poNumber !== '') {
    $orders = array_values(array_filter($orders, function($row) use ($poNumber) {
      return ($row['po_number'] ?? '') !== $poNumber;
    }));

    $createdAt = trim($_POST['created_at'] ?? '');
    if ($createdAt === '') {
      $createdAt = date('Y-m-d H:i:s');
    }
    $updatedAt = date('Y-m-d H:i:s');
    $itemCount = isset($_POST['item_id']) ? count($_POST['item_id']) : 0;

    for ($i = 0; $i < $itemCount; $i++) {
      $newPO = [];
      foreach ($schema as $f) {
        if (in_array($f, $itemFields, true)) {
          $newPO[$f] = trim($_POST[$f][$i] ?? '');
        } else {
          $newPO[$f] = trim($_POST[$f] ?? '');
        }
      }
      $newPO['po_number'] = $poNumber;
      $newPO['created_at'] = $createdAt;
      $newPO['updated_at'] = $updatedAt;
      $orders[] = $newPO;
    }

    writeCSV($poFile, $orders, $schema);
  }
  header('Location: purchase_orders_list.php');
  exit;
}

$poNumber = trim($_GET['po'] ?? '');
$poRows = array_values(array_filter($orders, function($row) use ($poNumber) {
  return ($row['po_number'] ?? '') === $poNumber;
}));
$header = $poRows[0] ?? [];
?>
<div class="container">
  <h2>Edit Purchase Order</h2>
  <?php if ($poNumber === '' || empty($poRows)): ?>
    <div style="text-align:center; color:#888; margin:18px 0;">Purchase order not found.</div>
    <div style="text-align:center;">
      <a href="purchase_orders_list.php" class="btn-outline">Back to Purchase Orders</a>
    </div>
  <?php else: ?>
    <form method="post" style="max-width:900px; margin:auto; background:#fafbfc; border-radius:8px; padding:24px 28px 18px 28px; box-shadow:0 2px 8px #0001;">
      <input type="hidden" name="update_po" value="1">
      <input type="hidden" name="created_at" value="<?= htmlspecialchars($header['created_at'] ?? '') ?>">
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px 24px; margin-bottom:18px; align-items:end;">
        <?php foreach ($schema as $f):
          if (in_array($f, array_merge($itemFields, ['created_at','updated_at','po_number','date']), true)) continue;
          $value = htmlspecialchars($header[$f] ?? '');
        ?>
          <div style="display:flex; flex-direction:column; min-width:160px;">
            <label for="<?= $f ?>" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;"> <?= htmlspecialchars(ucwords(str_replace('_',' ',$f))) ?> </label>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= $value ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">
          </div>
        <?php endforeach; ?>
        <div style="display:flex; flex-direction:column; min-width:120px;">
          <label for="po_number" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">PO Number</label>
          <input type="text" name="po_number" id="po_number" value="<?= htmlspecialchars($poNumber) ?>" readonly style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:0.97em;">
        </div>
        <div style="display:flex; flex-direction:column; min-width:120px;">
          <label for="date" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">Date</label>
          <input type="text" name="date" id="date" value="<?= htmlspecialchars($header['date'] ?? '') ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">
        </div>
      </div>
      <h3 style="margin:18px 0 8px 0; font-size:1.13em; color:#222;">Order Items</h3>
      <table id="po-items-table" style="width:100%; border-collapse:collapse; margin-bottom:12px; background:#fff;">
        <thead>
          <tr style="background:#f5f5f5; font-size:0.97em;">
            <th style="padding:6px 4px;">Item</th>
            <th style="padding:6px 4px;">Item Name</th>
            <th style="padding:6px 4px;">Qty</th>
            <th style="padding:6px 4px;">Unit</th>
            <th style="padding:6px 4px;">Unit Price</th>
            <th style="padding:6px 4px;">Discount</th>
            <th style="padding:6px 4px;">Tax %</th>
            <th style="padding:6px 4px;">Tax Amt</th>
            <th style="padding:6px 4px;">Total</th>
            <th style="padding:6px 4px;"></th>
          </tr>
        </thead>
        <tbody>
          <?php if (empty($poRows)): ?>
            <tr>
              <td>
                <select name="item_id[]" style="width:120px; padding:3px 5px; font-size:0.97em;">
                  <option value="">-- Select --</option>
                  <?php foreach ($inventory as $item): ?>
                    <option value="<?= htmlspecialchars($item['item_id']) ?>">
                      <?= htmlspecialchars($item['item_id']) ?>
                    </option>
                  <?php endforeach; ?>
                </select>
              </td>
              <td><input type="text" name="item_name[]" style="width:110px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="quantity[]" min="1" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="text" name="unit[]" style="width:50px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="unit_price[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="discount[]" step="0.01" style="width:60px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="tax_rate[]" step="0.01" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="tax_amount[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="total[]" step="0.01" style="width:85px; padding:3px 5px; font-size:0.97em;"></td>
              <td><button type="button" onclick="removeRow(this)" style="padding:2px 7px; font-size:1.1em;">üóë</button></td>
            </tr>
          <?php else: ?>
            <?php foreach ($poRows as $row): ?>
              <tr>
                <td>
                  <select name="item_id[]" style="width:120px; padding:3px 5px; font-size:0.97em;">
                    <option value="">-- Select --</option>
                    <?php foreach ($inventory as $item): ?>
                      <?php $selected = ($item['item_id'] ?? '') === ($row['item_id'] ?? '') ? 'selected' : ''; ?>
                      <option value="<?= htmlspecialchars($item['item_id']) ?>" <?= $selected ?>>
                        <?= htmlspecialchars($item['item_id']) ?>
                      </option>
                    <?php endforeach; ?>
                  </select>
                </td>
                <td><input type="text" name="item_name[]" value="<?= htmlspecialchars($row['item_name'] ?? '') ?>" style="width:110px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="quantity[]" min="1" value="<?= htmlspecialchars($row['quantity'] ?? '') ?>" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="text" name="unit[]" value="<?= htmlspecialchars($row['unit'] ?? '') ?>" style="width:50px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="unit_price[]" step="0.01" value="<?= htmlspecialchars($row['unit_price'] ?? '') ?>" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="discount[]" step="0.01" value="<?= htmlspecialchars($row['discount'] ?? '') ?>" style="width:60px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="tax_rate[]" step="0.01" value="<?= htmlspecialchars($row['tax_rate'] ?? '') ?>" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="tax_amount[]" step="0.01" value="<?= htmlspecialchars($row['tax_amount'] ?? '') ?>" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="total[]" step="0.01" value="<?= htmlspecialchars($row['total'] ?? '') ?>" style="width:85px; padding:3px 5px; font-size:0.97em;"></td>
                <td><button type="button" onclick="removeRow(this)" style="padding:2px 7px; font-size:1.1em;">üóë</button></td>
              </tr>
            <?php endforeach; ?>
          <?php endif; ?>
        </tbody>
      </table>
      <button type="button" onclick="addRow()" style="margin-bottom:18px;">‚ûï Add Item</button>
      <div style="margin-top:18px; text-align:center;">
        <button type="submit" class="btn-primary" style="padding:7px 22px; font-size:1.08em;">üíæ Update Purchase Order</button>
        <a href="purchase_orders_list.php" class="btn-outline" style="margin-left:18px;">Cancel</a>
      </div>
    </form>
    <script>
      function addRow() {
        const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
        const row = table.rows[0].cloneNode(true);
        Array.from(row.querySelectorAll('input,select')).forEach(el => el.value = '');
        table.appendChild(row);
      }
      function removeRow(btn) {
        const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
        if (table.rows.length > 1) {
          btn.closest('tr').remove();
        }
      }
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_edit.php ---



--- Start of purchase_order_receive.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$backorderFile = __DIR__ . '/backorders.csv';

$orders = readCSV($poFile, $schema);
$inventory = readCSV($inventoryFile, $inventorySchema);

function read_backorders($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_backorders($filename, $rows) {
  $headers = ['po_number','item_id','item_name','quantity_backorder','note','created_at'];
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, $headers);
  foreach ($rows as $row) {
    $line = [];
    foreach ($headers as $header) {
      $line[] = $row[$header] ?? '';
    }
    fputcsv($file, $line);
  }
  fclose($file);
}

function find_inventory_index($inventory, $itemId) {
  foreach ($inventory as $idx => $row) {
    if (($row['item_id'] ?? '') === $itemId) {
      return $idx;
    }
  }
  return -1;
}

function init_inventory_row($schema, $itemId, $itemName) {
  $row = [];
  foreach ($schema as $field) {
    $row[$field] = '';
  }
  $row['item_id'] = $itemId;
  $row['item_name'] = $itemName;
  $row['quantity_in_stock'] = '0';
  $row['status'] = 'Stock';
  $row['created_at'] = date('Y-m-d H:i:s');
  $row['updated_at'] = $row['created_at'];
  return $row;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['receive_po'])) {
  $poNumber = trim($_POST['po_number'] ?? '');
  $receiveAll = ($_POST['receive_all'] ?? '') === 'yes';
  $note = trim($_POST['backorder_note'] ?? '');

  $itemIds = $_POST['item_id'] ?? [];
  $itemNames = $_POST['item_name'] ?? [];
  $orderedQtys = $_POST['ordered_qty'] ?? [];
  $backorderQtys = $_POST['backorder_qty'] ?? [];

  $backorders = read_backorders($backorderFile);

  foreach ($itemIds as $i => $itemId) {
    $itemId = trim($itemId);
    $itemName = trim($itemNames[$i] ?? '');
    $ordered = is_numeric($orderedQtys[$i] ?? '') ? (float)$orderedQtys[$i] : 0.0;
    $backorder = 0.0;
    if (!$receiveAll) {
      $backorder = is_numeric($backorderQtys[$i] ?? '') ? (float)$backorderQtys[$i] : 0.0;
    }
    $backorder = max(0.0, min($ordered, $backorder));
    $received = max(0.0, $ordered - $backorder);

    if ($itemId === '' && $itemName === '') {
      continue;
    }

    if ($itemId !== '') {
      $invIndex = find_inventory_index($inventory, $itemId);
      if ($invIndex < 0) {
        $inventory[] = init_inventory_row($inventorySchema, $itemId, $itemName);
        $invIndex = count($inventory) - 1;
      }
      if ($received > 0) {
        $current = is_numeric($inventory[$invIndex]['quantity_in_stock'] ?? '') ? (float)$inventory[$invIndex]['quantity_in_stock'] : 0.0;
        $inventory[$invIndex]['quantity_in_stock'] = (string)($current + $received);
      }
      if ($backorder > 0) {
        $inventory[$invIndex]['status'] = 'Backorder';
      } elseif (($inventory[$invIndex]['status'] ?? '') === 'Backorder') {
        $inventory[$invIndex]['status'] = 'Stock';
      }
      $inventory[$invIndex]['updated_at'] = date('Y-m-d H:i:s');
    }

    if ($backorder > 0) {
      $backorders[] = [
        'po_number' => $poNumber,
        'item_id' => $itemId,
        'item_name' => $itemName,
        'quantity_backorder' => (string)$backorder,
        'note' => $note,
        'created_at' => date('Y-m-d H:i:s')
      ];
    }
  }

  writeCSV($inventoryFile, $inventory, $inventorySchema);
  write_backorders($backorderFile, $backorders);

  header('Location: purchase_orders_list.php');
  exit;
}

$poNumber = trim($_GET['po'] ?? '');
$poRows = array_values(array_filter($orders, function($row) use ($poNumber) {
  return ($row['po_number'] ?? '') === $poNumber;
}));
?>
<div class="container">
  <h2>Receive Purchase Order</h2>
  <?php if ($poNumber === '' || empty($poRows)): ?>
    <div style="text-align:center; color:#888; margin:18px 0;">Purchase order not found.</div>
    <div style="text-align:center;">
      <a href="purchase_orders_list.php" class="btn-outline">Back to Purchase Orders</a>
    </div>
  <?php else: ?>
    <form method="post" style="max-width:900px; margin:auto; background:#fafbfc; border-radius:8px; padding:24px 28px 18px 28px; box-shadow:0 2px 8px #0001;">
      <input type="hidden" name="receive_po" value="1">
      <input type="hidden" name="po_number" value="<?= htmlspecialchars($poNumber) ?>">
      <div style="display:flex; flex-wrap:wrap; gap:12px 24px; margin-bottom:16px; align-items:center;">
        <div style="font-weight:600;">PO Number:</div>
        <div><?= htmlspecialchars($poNumber) ?></div>
      </div>
      <div style="display:flex; gap:14px; align-items:center; margin-bottom:12px;">
        <div style="font-weight:600;">All items received?</div>
        <label><input type="radio" name="receive_all" value="yes" checked> Yes</label>
        <label><input type="radio" name="receive_all" value="no"> No</label>
      </div>
      <div id="backorderSection" style="display:none;">
        <div style="margin-bottom:10px; font-weight:600;">Backorder Details</div>
        <div style="margin-bottom:10px;">
          <label for="backorder_note" style="display:block; font-weight:600; margin-bottom:4px;">Backorder Note</label>
          <textarea name="backorder_note" id="backorder_note" class="inv-input" style="width:100%; min-height:70px; resize:vertical;"></textarea>
        </div>
      </div>
      <table style="width:100%; border-collapse:collapse; margin-bottom:12px; background:#fff;">
        <thead>
          <tr style="background:#f5f5f5; font-size:0.97em;">
            <th style="padding:6px 4px;">Item ID</th>
            <th style="padding:6px 4px;">Item Name</th>
            <th style="padding:6px 4px;">Ordered Qty</th>
            <th style="padding:6px 4px;">Backorder Qty</th>
            <th style="padding:6px 4px;">Received Qty</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($poRows as $idx => $row): ?>
            <tr>
              <td style="padding:6px 4px;">
                <?= htmlspecialchars($row['item_id'] ?? '') ?>
                <input type="hidden" name="item_id[]" value="<?= htmlspecialchars($row['item_id'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <?= htmlspecialchars($row['item_name'] ?? '') ?>
                <input type="hidden" name="item_name[]" value="<?= htmlspecialchars($row['item_name'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <?= htmlspecialchars($row['quantity'] ?? '') ?>
                <input type="hidden" name="ordered_qty[]" value="<?= htmlspecialchars($row['quantity'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <input type="number" name="backorder_qty[]" min="0" step="0.01" style="width:110px; padding:3px 5px; font-size:0.97em;" value="0" data-ordered="<?= htmlspecialchars($row['quantity'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <span class="received-qty" data-ordered="<?= htmlspecialchars($row['quantity'] ?? '') ?>"><?= htmlspecialchars($row['quantity'] ?? '') ?></span>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
      <div style="margin-top:18px; text-align:center;">
        <button type="submit" class="btn-primary" style="padding:7px 22px; font-size:1.08em;">Receive Items</button>
        <a href="purchase_orders_list.php" class="btn-outline" style="margin-left:18px;">Cancel</a>
      </div>
    </form>
    <script>
      const receiveRadios = Array.from(document.querySelectorAll('input[name="receive_all"]'));
      const backorderSection = document.getElementById('backorderSection');
      const backorderInputs = Array.from(document.querySelectorAll('input[name="backorder_qty[]"]'));
      const receivedLabels = Array.from(document.querySelectorAll('.received-qty'));

      function updateReceived() {
        backorderInputs.forEach((input, index) => {
          const ordered = parseFloat(input.getAttribute('data-ordered'));
          const backorder = parseFloat(input.value);
          const orderedVal = Number.isFinite(ordered) ? ordered : 0;
          const backorderVal = Number.isFinite(backorder) ? backorder : 0;
          const received = Math.max(0, orderedVal - Math.min(orderedVal, backorderVal));
          if (receivedLabels[index]) {
            receivedLabels[index].textContent = received.toFixed(2).replace(/\.00$/, '');
          }
        });
      }

      function toggleBackorderSection() {
        const receiveAll = document.querySelector('input[name="receive_all"]:checked').value === 'yes';
        backorderSection.style.display = receiveAll ? 'none' : 'block';
        backorderInputs.forEach(input => {
          input.disabled = receiveAll;
          if (receiveAll) {
            input.value = '0';
          }
        });
        updateReceived();
      }

      receiveRadios.forEach(radio => {
        radio.addEventListener('change', toggleBackorderSection);
      });

      backorderInputs.forEach(input => {
        input.addEventListener('input', updateReceived);
      });

      toggleBackorderSection();
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_receive.php ---



--- Start of purchase_order_schema.php ---

<?php
return [
    'po_number',
    'date',
    'status',
    'supplier_id',
    'supplier_name',
    'supplier_contact',
    'supplier_address',
    'billing_address',
    'shipping_address',
    'item_id',
    'item_name',
    'quantity',
    'unit',
    'unit_price',
    'discount',
    'tax_rate',
    'tax_amount',
    'total',
    'subtotal',
    'total_discount',
    'total_tax',
    'shipping_cost',
    'other_fees',
    'grand_total',
    'currency',
    'expected_delivery',
    'payment_terms',
    'notes',
    'created_by',
    'created_at',
    'updated_at'
];


--- End of purchase_order_schema.php ---



--- Start of purchase_order_summary.php ---



--- End of purchase_order_summary.php ---



--- Start of renewals.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Contract Renewals';
$contractSchema = require __DIR__ . '/contract_schema.php';
$contracts = readCSV('contracts.csv', $contractSchema) ?: [];
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

$today = strtotime(date('Y-m-d'));
$upcoming = [];
$critical = [];
$actionNeeded = [];

foreach ($contracts as $contract) {
    if ($contract['contract_status'] !== 'Active') continue;
    
    if (empty($contract['end_date'])) continue;
    
    $endDate = strtotime($contract['end_date']);
    $daysToExpiry = round(($endDate - $today) / 86400);
    
    // Find contact info
    $contactInfo = null;
    foreach ($contacts as $c) {
        if ($c['id'] === $contract['contact_id']) {
            $contactInfo = $c;
            break;
        }
    }
    
    $item = array_merge($contract, [
        'days_to_expiry' => $daysToExpiry,
        'contact_info' => $contactInfo
    ]);
    
    // Categorize
    if ($daysToExpiry <= 30) {
        $critical[] = $item;
        $actionNeeded[] = $item;
    } elseif ($daysToExpiry <= 90) {
        $actionNeeded[] = $item;
    } elseif ($daysToExpiry <= 180) {
        $upcoming[] = $item;
    }
}

// Sort by days to expiry
usort($critical, fn($a, $b) => $a['days_to_expiry'] - $b['days_to_expiry']);
usort($actionNeeded, fn($a, $b) => $a['days_to_expiry'] - $b['days_to_expiry']);
usort($upcoming, fn($a, $b) => $a['days_to_expiry'] - $b['days_to_expiry']);

// Calculate renewal metrics
$totalRenewalValue = 0;
foreach ($actionNeeded as $item) {
    $totalRenewalValue += (float)($item['annual_value'] ?? 0);
}
?>

<style>
.renewal-header {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.renewal-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.metric-card.critical {
    border-left: 4px solid #EF4444;
}

.metric-card.warning {
    border-left: 4px solid #F59E0B;
}

.metric-card.upcoming {
    border-left: 4px solid #3B82F6;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 36px;
    font-weight: 700;
    color: #1F2937;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.renewal-section {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title {
    font-size: 20px;
    font-weight: 700;
    color: #1F2937;
    display: flex;
    align-items: center;
    gap: 12px;
}

.priority-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
}

.priority-critical {
    background: #FEE2E2;
    color: #991B1B;
}

.priority-warning {
    background: #FEF3C7;
    color: #92400E;
}

.priority-upcoming {
    background: #DBEAFE;
    color: #1E40AF;
}

.renewal-card {
    background: #F9FAFB;
    padding: 24px;
    border-radius: 12px;
    border: 2px solid #E5E7EB;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.renewal-card:hover {
    border-color: #F59E0B;
    transform: translateX(4px);
}

.renewal-card.critical {
    border-left: 4px solid #EF4444;
}

.renewal-card.warning {
    border-left: 4px solid #F59E0B;
}

.renewal-header-row {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
}

.contract-info h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
}

.contract-meta {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: #6B7280;
}

.expiry-info {
    text-align: right;
}

.days-remaining {
    font-size: 32px;
    font-weight: 700;
}

.days-remaining.critical {
    color: #EF4444;
}

.days-remaining.warning {
    color: #F59E0B;
}

.days-label {
    font-size: 12px;
    color: #6B7280;
    text-transform: uppercase;
}

.renewal-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    padding: 16px 0;
    border-top: 1px solid #E5E7EB;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.detail-label {
    font-size: 12px;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 16px;
    font-weight: 700;
    color: #1F2937;
}

.renewal-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-renew {
    background: #10B981;
    color: white;
}

.btn-renew:hover {
    background: #059669;
}

.btn-contact {
    background: #3B82F6;
    color: white;
}

.btn-contact:hover {
    background: #2563EB;
}

.btn-view {
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
}

.btn-view:hover {
    background: #E5E7EB;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}
</style>

<div class="renewal-header">
    <h1>üîÑ Contract Renewals</h1>
    <p>Track and manage upcoming contract expirations</p>
</div>

<!-- Metrics -->
<div class="metrics-grid">
    <div class="metric-card critical">
        <div class="metric-label">Critical (‚â§30 Days)</div>
        <div class="metric-value"><?= count($critical) ?></div>
        <div class="metric-subtext">Immediate action required</div>
    </div>
    
    <div class="metric-card warning">
        <div class="metric-label">Action Needed (‚â§90 Days)</div>
        <div class="metric-value"><?= count($actionNeeded) ?></div>
        <div class="metric-subtext">Start renewal conversations</div>
    </div>
    
    <div class="metric-card upcoming">
        <div class="metric-label">Upcoming (‚â§180 Days)</div>
        <div class="metric-value"><?= count($upcoming) ?></div>
        <div class="metric-subtext">Plan ahead</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Renewal Revenue at Risk</div>
        <div class="metric-value">$<?= number_format($totalRenewalValue, 0) ?></div>
        <div class="metric-subtext">Annual value of expiring contracts</div>
    </div>
</div>

<!-- Critical Renewals (‚â§30 days) -->
<?php if (!empty($critical)): ?>
<div class="renewal-section">
    <div class="section-header">
        <div class="section-title">
            üö® Critical - Immediate Action Required
            <span class="priority-badge priority-critical"><?= count($critical) ?> contracts</span>
        </div>
    </div>
    
    <?php foreach ($critical as $contract): ?>
        <?php
        $contactName = 'Unknown';
        $contactEmail = '';
        $contactPhone = '';
        if ($contract['contact_info']) {
            $contactName = trim($contract['contact_info']['first_name'] . ' ' . $contract['contact_info']['last_name']);
            $contactEmail = $contract['contact_info']['email'] ?? '';
            $contactPhone = $contract['contact_info']['phone'] ?? '';
        }
        ?>
        <div class="renewal-card critical">
            <div class="renewal-header-row">
                <div class="contract-info">
                    <h3><?= htmlspecialchars($contract['contract_id']) ?></h3>
                    <div class="contract-meta">
                        <span>üë§ <?= htmlspecialchars($contactName) ?></span>
                        <span>üîß <?= htmlspecialchars($contract['equipment_type']) ?></span>
                    </div>
                </div>
                <div class="expiry-info">
                    <div class="days-remaining critical"><?= $contract['days_to_expiry'] ?></div>
                    <div class="days-label">Days Remaining</div>
                </div>
            </div>
            
            <div class="renewal-details">
                <div class="detail-item">
                    <span class="detail-label">Monthly Fee</span>
                    <span class="detail-value">$<?= number_format((float)$contract['monthly_fee'], 2) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Annual Value</span>
                    <span class="detail-value">$<?= number_format((float)$contract['annual_value'], 2) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">End Date</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['end_date']) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Auto-Renew</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['auto_renew']) ?></span>
                </div>
            </div>
            
            <div class="renewal-actions">
                <a href="contract_renew.php?id=<?= urlencode($contract['contract_id']) ?>" class="btn btn-renew">
                    ‚úì Start Renewal Process
                </a>
                <?php if ($contactEmail): ?>
                    <a href="mailto:<?= htmlspecialchars($contactEmail) ?>?subject=Contract Renewal - <?= htmlspecialchars($contract['contract_id']) ?>" 
                       class="btn btn-contact">
                        ‚úâÔ∏è Email Customer
                    </a>
                <?php endif; ?>
                <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" class="btn btn-view">
                    View Details
                </a>
            </div>
        </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<!-- Action Needed (31-90 days) -->
<?php if (!empty($actionNeeded)): ?>
<div class="renewal-section">
    <div class="section-header">
        <div class="section-title">
            ‚ö†Ô∏è Action Needed - Start Renewal Conversations
            <span class="priority-badge priority-warning"><?= count($actionNeeded) ?> contracts</span>
        </div>
    </div>
        
    <?php foreach ($actionNeeded as $contract): ?>
        <?php if ($contract['days_to_expiry'] <= 30) continue; // Skip critical ones ?>
        <?php
        $contactName = 'Unknown';
        if ($contract['contact_info']) {
            $contactName = trim($contract['contact_info']['first_name'] . ' ' . $contract['contact_info']['last_name']);
        }
        ?>
        <div class="renewal-card warning">
            <div class="renewal-header-row">
                <div class="contract-info">
                    <h3><?= htmlspecialchars($contract['contract_id']) ?></h3>
                    <div class="contract-meta">
                        <span>üë§ <?= htmlspecialchars($contactName) ?></span>
                        <span>üîß <?= htmlspecialchars($contract['equipment_type']) ?></span>
                    </div>
                </div>
                <div class="expiry-info">
                    <div class="days-remaining warning"><?= $contract['days_to_expiry'] ?></div>
                    <div class="days-label">Days Remaining</div>
                </div>
            </div>
            
            <div class="renewal-details">
                <div class="detail-item">
                    <span class="detail-label">Monthly Fee</span>
                    <span class="detail-value">$<?= number_format((float)$contract['monthly_fee'], 2) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">End Date</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['end_date']) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Auto-Renew</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['auto_renew']) ?></span>
                </div>
            </div>
            
            <div class="renewal-actions">
                <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" class="btn btn-view">
                    View Details
                </a>
            </div>
        </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<!-- Upcoming (91-180 days) -->
<?php if (!empty($upcoming)): ?>
<div class="renewal-section">
    <div class="section-header">
        <div class="section-title">
            üìÖ Upcoming Renewals
            <span class="priority-badge priority-upcoming"><?= count($upcoming) ?> contracts</span>
        </div>
    </div>
    
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: #F9FAFB; border-bottom: 2px solid #E5E7EB;">
            <tr>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Contract ID</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Equipment</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Monthly Fee</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">End Date</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Days Remaining</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($upcoming as $contract): ?>
                <tr style="border-bottom: 1px solid #F3F4F6;">
                    <td style="padding: 12px;">
                        <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" style="color: #3B82F6; font-weight: 600; text-decoration: none;">
                            <?= htmlspecialchars($contract['contract_id']) ?>
                        </a>
                    </td>
                    <td style="padding: 12px;"><?= htmlspecialchars($contract['equipment_type']) ?></td>
                    <td style="padding: 12px; font-weight: 700;">$<?= number_format((float)$contract['monthly_fee'], 2) ?></td>
                    <td style="padding: 12px;"><?= htmlspecialchars($contract['end_date']) ?></td>
                    <td style="padding: 12px; color: #3B82F6; font-weight: 600;"><?= $contract['days_to_expiry'] ?> days</td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>
<?php endif; ?>

<!-- No Renewals Due -->
<?php if (empty($critical) && empty($actionNeeded) && empty($upcoming)): ?>
<div class="renewal-section">
    <div class="empty-state">
        <div class="empty-state-icon">‚úÖ</div>
        <h3>All Clear!</h3>
        <p>No contracts expiring in the next 180 days</p>
    </div>
</div>
<?php endif; ?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of renewals.php ---



--- Start of revenue_dashboard.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Revenue Dashboard';

// Load data
$contracts = readCSV('contracts.csv', require __DIR__ . '/contract_schema.php') ?: [];
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');

// Calculate MRR & ARR from active contracts
$mrr = 0;
$arr = 0;
$activeContracts = 0;
$contractsByType = [];
$monthlyRevenue = [];

foreach ($contracts as $contract) {
    if ($contract['contract_status'] === 'Active') {
        $activeContracts++;
        $monthlyFee = (float)($contract['monthly_fee'] ?? 0);
        $mrr += $monthlyFee;
        $arr += $monthlyFee * 12;
        
        // Group by equipment type
        $type = $contract['equipment_type'];
        if (!isset($contractsByType[$type])) {
            $contractsByType[$type] = ['count' => 0, 'mrr' => 0];
        }
        $contractsByType[$type]['count']++;
        $contractsByType[$type]['mrr'] += $monthlyFee;
    }
}

// Calculate Equipment Sales (Closed Won opportunities)
$equipmentSales = 0;
$salesCount = 0;
$salesPipeline = 0;
$pipelineWeighted = 0;

foreach ($opportunities as $opp) {
    $value = (float)($opp['value'] ?? 0);
    $prob = (float)($opp['probability'] ?? 0);
    
    if ($opp['stage'] === 'Closed Won') {
        $equipmentSales += $value;
        $salesCount++;
    } elseif (!in_array($opp['stage'], ['Closed Won', 'Closed Lost'])) {
        $salesPipeline += $value;
        $pipelineWeighted += ($value * $prob / 100);
    }
}

// Calculate growth metrics (simplified - compare to previous period)
$mrrGrowth = 12.5; // Placeholder - would calculate from historical data
$salesGrowth = 18.3; // Placeholder

// Calculate revenue mix
$totalRevenue = $arr + $equipmentSales;
$recurringPercent = $totalRevenue > 0 ? ($arr / $totalRevenue * 100) : 0;
$equipmentPercent = $totalRevenue > 0 ? ($equipmentSales / $totalRevenue * 100) : 0;
?>

<style>
.dashboard-header {
    background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.dashboard-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #6366F1;
}

.metric-card.recurring {
    border-left-color: #10B981;
}

.metric-card.equipment {
    border-left-color: #F59E0B;
}

.metric-card.total {
    border-left-color: #8B5CF6;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 36px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 8px;
}

.metric-growth {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 600;
}

.growth-positive {
    color: #10B981;
}

.growth-negative {
    color: #EF4444;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.chart-section {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.chart-title {
    font-size: 20px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
}

.revenue-mix {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.mix-bar {
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 14px;
}

.mix-recurring {
    background: #10B981;
}

.mix-equipment {
    background: #F59E0B;
}

.breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.breakdown-card {
    background: #F9FAFB;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #E5E7EB;
}

.breakdown-header {
    font-size: 14px;
    font-weight: 700;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #E5E7EB;
}

.breakdown-item:last-child {
    border-bottom: none;
}

.breakdown-label {
    font-size: 14px;
    color: #374151;
}

.breakdown-value {
    font-size: 16px;
    font-weight: 700;
    color: #1F2937;
}

.breakdown-count {
    font-size: 12px;
    color: #9CA3AF;
    margin-left: 8px;
}

.pipeline-visual {
    background: linear-gradient(to right, #EFF6FF, #DBEAFE);
    padding: 24px;
    border-radius: 12px;
    margin-top: 16px;
}

.pipeline-stat {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
}

.pipeline-label {
    font-size: 14px;
    color: #1E40AF;
    font-weight: 600;
}

.pipeline-value {
    font-size: 18px;
    color: #1E40AF;
    font-weight: 700;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.action-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #E5E7EB;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.action-card:hover {
    border-color: #6366F1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.action-icon {
    font-size: 32px;
    margin-bottom: 12px;
}

.action-title {
    font-size: 16px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 4px;
}

.action-subtitle {
    font-size: 12px;
    color: #6B7280;
}
</style>

<div class="dashboard-header">
    <h1>üí∞ Revenue Dashboard</h1>
    <p>Comprehensive revenue tracking across all business streams</p>
</div>

<!-- Key Metrics -->
<div class="metrics-grid">
    <!-- MRR -->
    <div class="metric-card recurring">
        <div class="metric-label">Monthly Recurring Revenue</div>
        <div class="metric-value">$<?= number_format($mrr, 0) ?></div>
        <div class="metric-growth growth-positive">
            ‚Üó <?= number_format($mrrGrowth, 1) ?>% vs last month
        </div>
        <div class="metric-subtext"><?= $activeContracts ?> active SDI contracts</div>
    </div>
    
    <!-- ARR -->
    <div class="metric-card recurring">
        <div class="metric-label">Annual Recurring Revenue</div>
        <div class="metric-value">$<?= number_format($arr, 0) ?></div>
        <div class="metric-subtext">Projected from active contracts</div>
    </div>
    
    <!-- Equipment Sales -->
    <div class="metric-card equipment">
        <div class="metric-label">Equipment Sales (YTD)</div>
        <div class="metric-value">$<?= number_format($equipmentSales, 0) ?></div>
        <div class="metric-growth growth-positive">
            ‚Üó <?= number_format($salesGrowth, 1) ?>% vs last year
        </div>
        <div class="metric-subtext"><?= $salesCount ?> deals closed</div>
    </div>
    
    <!-- Total Revenue -->
    <div class="metric-card total">
        <div class="metric-label">Total Annual Revenue</div>
        <div class="metric-value">$<?= number_format($totalRevenue, 0) ?></div>
        <div class="metric-subtext">Combined ARR + Equipment Sales</div>
    </div>
    
    <!-- Sales Pipeline -->
    <div class="metric-card">
        <div class="metric-label">Active Pipeline</div>
        <div class="metric-value">$<?= number_format($salesPipeline, 0) ?></div>
        <div class="metric-subtext">
            Weighted: $<?= number_format($pipelineWeighted, 0) ?>
        </div>
    </div>
    
    <!-- Average Contract Value -->
    <div class="metric-card">
        <div class="metric-label">Avg Contract Value</div>
        <div class="metric-value">
            $<?= $activeContracts > 0 ? number_format($mrr / $activeContracts, 0) : 0 ?>
        </div>
        <div class="metric-subtext">Per month per contract</div>
    </div>
</div>

<!-- Revenue Mix Chart -->
<div class="chart-section">
    <div class="chart-title">Revenue Mix: Recurring vs. One-Time</div>
    <div class="revenue-mix">
        <div class="mix-bar mix-recurring" style="flex: <?= $recurringPercent ?>">
            <?= number_format($recurringPercent, 1) ?>% Recurring
        </div>
        <div class="mix-bar mix-equipment" style="flex: <?= $equipmentPercent ?>">
            <?= number_format($equipmentPercent, 1) ?>% Equipment
        </div>
    </div>
    <p style="margin-top: 16px; color: #6B7280; font-size: 14px;">
        <strong>Recurring Revenue:</strong> $<?= number_format($arr, 0) ?> | 
        <strong>Equipment Sales:</strong> $<?= number_format($equipmentSales, 0) ?>
    </p>
</div>

<!-- Revenue Breakdown -->
<div class="breakdown-grid">
    <!-- SDI Contracts by Type -->
    <div class="breakdown-card">
        <div class="breakdown-header">SDI Contracts by Equipment Type</div>
        <?php if (empty($contractsByType)): ?>
            <p style="color: #9CA3AF; font-style: italic">No active contracts</p>
        <?php else: ?>
            <?php arsort($contractsByType); ?>
            <?php foreach ($contractsByType as $type => $data): ?>
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <?= htmlspecialchars($type) ?>
                        <span class="breakdown-count">(<?= $data['count'] ?>)</span>
                    </div>
                    <div class="breakdown-value">
                        $<?= number_format($data['mrr'], 0) ?>/mo
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    
    <!-- Sales Pipeline -->
    <div class="breakdown-card">
        <div class="breakdown-header">Equipment Sales Pipeline</div>
        <div class="pipeline-visual">
            <div class="pipeline-stat">
                <span class="pipeline-label">Total Pipeline Value</span>
                <span class="pipeline-value">$<?= number_format($salesPipeline, 0) ?></span>
            </div>
            <div class="pipeline-stat">
                <span class="pipeline-label">Weighted Value (Forecast)</span>
                <span class="pipeline-value">$<?= number_format($pipelineWeighted, 0) ?></span>
            </div>
            <div class="pipeline-stat">
                <span class="pipeline-label">Average Deal Size</span>
                <span class="pipeline-value">
                    $<?= count($opportunities) > 0 ? number_format($salesPipeline / count(array_filter($opportunities, fn($o) => !in_array($o['stage'], ['Closed Won', 'Closed Lost']))), 0) : 0 ?>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="chart-section">
    <div class="chart-title">Quick Actions</div>
    <div class="quick-actions">
        <a href="contracts_list.php" class="action-card">
            <div class="action-icon">üìã</div>
            <div class="action-title">View Contracts</div>
            <div class="action-subtitle">Manage SDI agreements</div>
        </a>
        
        <a href="opportunities_list.php" class="action-card">
            <div class="action-icon">üíº</div>
            <div class="action-title">Sales Pipeline</div>
            <div class="action-subtitle">Track equipment sales</div>
        </a>
        
        <a href="pipeline_board.php" class="action-card">
            <div class="action-icon">üìä</div>
            <div class="action-title">Pipeline Board</div>
            <div class="action-subtitle">Visual sales tracking</div>
        </a>
        
        <a href="equipment_list.php" class="action-card">
            <div class="action-icon">üîß</div>
            <div class="action-title">Equipment Inventory</div>
            <div class="action-subtitle">Track all equipment</div>
        </a>
        
        <a href="contract_form.php" class="action-card">
            <div class="action-icon">‚ûï</div>
            <div class="action-title">New Contract</div>
            <div class="action-subtitle">Add SDI service agreement</div>
        </a>
        
        <a href="opportunity_form.php" class="action-card">
            <div class="action-icon">üí∞</div>
            <div class="action-title">New Opportunity</div>
            <div class="action-subtitle">Add equipment sale</div>
        </a>
    </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of revenue_dashboard.php ---



--- Start of sanitize_helper.php ---

<?php
/**
 * Output Sanitization & Escaping Helpers
 * Prevents XSS attacks by properly escaping output
 */

/**
 * Safely escape HTML special characters
 */
function escapeHtml($str) {
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}

/**
 * Short alias for escapeHtml()
 */
function e($str) {
    return escapeHtml($str);
}

/**
 * Escape for use in HTML attributes
 */
function escapeAttr($str) {
    return htmlspecialchars($str, ENT_QUOTES | ENT_HTML5, 'UTF-8');
}

/**
 * Escape for use in JavaScript context (use with caution)
 */
function escapeJs($str) {
    // JSON encoding provides safe JavaScript escaping
    return json_encode($str, JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_TAG);
}

/**
 * Escape for JSON output
 */
function escapeJson($data) {
    return json_encode($data, JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_TAG);
}

/**
 * Sanitize user input (remove HTML tags but keep data intact)
 */
function sanitizeInput($str) {
    return trim(strip_tags((string)$str));
}

/**
 * Format currency safely
 */
if (!function_exists('formatCurrency')) {
    function formatCurrency($value) {
        return '$' . number_format((float)$value, 0);
    }
}

/**
 * Format date safely
 */
function formatDate($date) {
    if (empty($date)) {
        return '';
    }
    try {
        $dt = new DateTime($date);
        return $dt->format('M d, Y');
    } catch (Exception $e) {
        return escapeHtml($date);
    }
}
?>


--- End of sanitize_helper.php ---



--- Start of sdi_cancel.php ---


<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evoqua SDI Contract Cancellation Tool</title>
  <link rel="stylesheet" href="styles.css?v=20251002">
</head>
<body>
<div class="container">
  
  
	<table>
		<caption>Suggestions on how to Cancel your contract - What you can do</caption>
		
		<tr>
			<td> Review your specific order or contract for any additional terms or amendments.<br>
				<br>
				Send a written notice (email or letter) to Evoqua‚Äôs official contact stating your intent and the reason for cancellation.<br>
				<br>
				Keep records of all correspondence and responses.</td>
		</tr>
			
			<th> How to cancel contract</th>
			<th> Contact Information</th>
		</tr>
		<tr>
			<td> Simply enter your informaiton in the fields below <br><br> Click "Generate Letter"</td>

			<td> Either email to<br><br> <a href="mailto:CentralAP@evoqua.com">CentralAP</a> 
				or<br><br>Fax to <br>(905) 890-6357 </td>

	</table>
	
	
   <!-- Termination Reason Table -->
   <section id="cancellation-form">
    <table>
	        <caption>Termination Reason Options</caption>
        <tr>
           <th>Reason</th>
            <th>Description</th>
        </tr>
        <tr>
          
            <td>End of Term</td>
            <td>For leased or rented equipment, the initial term automatically renews unless cancelled in writing by you or Evoqua.<br>
				<br>
				Notice Period: <br><br>You must provide written notice of cancellation not sooner than <b><u>three months</b></u> and <b><u>not later than one month before the end of the initial or any renewal term.</b></u><br>
				<br>	
				Obligations: <br><br>Cancelling service in writing before the end of the term does not relieve you of your obligation to pay the monthly rental/service charge for the full term.<br>
				<br>
				Return of Equipment: <br><br>Upon expiration or termination, you must make the leased equipment available for Evoqua to remove. </td>
        </tr>
        <tr>
            
            <td>Material Breach</td>
            <td>Either party (you or Evoqua) can terminate the agreement if the other party materially breaches the contract (e.g., fails to fulfill major obligations, files for bankruptcy).
	<br><br>Process: You must issue a written notice of breach and allow a 30-day period for the other party to cure (fix) the breach. <br><br>If the breach isn‚Äôt cured within 30 days, you can terminate the contract.
<br><br>Obligations: If you suspend an order for 90+ days without a change order, Evoqua may terminate with 15 days‚Äô written notice and is entitled to payment for work performed up to the termination date.</td>
        </tr>
    </table>
	
	
	
  <h1>Evoqua SDI Contract Cancellation Tool</h1>

  <section id="cancellation-form">
    <h2>Generate Your Cancellation Letter</h2>
    <form id="generate-letter-form">
      <div class="form-grid">
        <!-- Form fields -->
        <div class="form-group">
          <label for="account-number">Account Number</label>
          <input type="text" id="account-number" required>
        </div>
        <div class="form-group">
          <label for="contract-number">Quote/Contract Number</label>
          <input type="text" id="contract-number" required>
        </div>
        <div class="form-group">
          <label for="contract-end-date">Contract End Date</label>
          <input type="date" id="contract-end-date" required>
        </div>
        <div class="form-group">
          <label for="termination-reason">Reason for Termination</label>
          <select id="termination-reason" required>
            <option value="">Select reason</option>
            <option value="end-of-term">End of Term</option>
            <option value="material-breach">Material Breach</option>
          </select>
        </div>
        <div class="form-group">
          <label for="your-name">Your Name</label>
          <input type="text" id="your-name" required>
        </div>
        <div class="form-group">
          <label for="your-position">Your Position/Company</label>
          <input type="text" id="your-position" required>
        </div>
        <div class="form-group">
          <label for="your-contact">Your Contact Information</label>
          <input type="text" id="your-contact" required>
        </div>
      </div>
      <button type="submit">Generate Letter</button>
    </form>
  </section>
  
<style>
    .table-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        flex-wrap: wrap; /* responsive for smaller screens */
    }

    table {
        width: 45%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        background-color: #e6f0ff; /* secondary background */
        color: #004080; /* primary text color */
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    caption {
        font-weight: bold;
        font-size: 1.2em;
        padding: 10px;
        background-color: #004080; /* primary color */
        color: #ffffff; /* white text */
    }

    th, td {
        border: 1px solid #cccccc; /* accent border */
        padding: 8px 12px;
        text-align: left;
    }

    th {
        background-color: #004080; /* primary color */
        color: #ffffff;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9; /* subtle alternate row */
    }

    @media (max-width: 768px) {
        table {
            width: 100%; /* stack tables on small screens */
        }
    }
</style>

<div class="table-container">
   
 


  <section id="letter-output" class="hidden">
    <h2>Your Cancellation Letter</h2>
    <div id="generated-letter"></div>
    <br>
    <button class="btn-outline" id="download-word">Download as Word</button>
    <button class="btn-outline" id="download-pdf">Download as PDF</button>
  </section>
</div>


<script>

window.addEventListener('load', function () {
  const form = document.getElementById('generate-letter-form');
  const outputSection = document.getElementById('letter-output');
  const letterDiv = document.getElementById('generated-letter');
  const downloadWordBtn = document.getElementById('download-word');
  const downloadPdfBtn = document.getElementById('download-pdf');

  // Generate Letter
  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const accountNumber = document.getElementById('account-number').value.trim();
    const contractNumber = document.getElementById('contract-number').value.trim();
    const contractEndDate = document.getElementById('contract-end-date').value;
    const terminationReason = document.getElementById('termination-reason').value;
    const yourName = document.getElementById('your-name').value.trim();
    const yourPosition = document.getElementById('your-position').value.trim();
    const yourContact = document.getElementById('your-contact').value.trim();

    let noticeText = terminationReason === 'end-of-term'
      ? `We are providing this notice for end of term termination, in accordance with Section 10. The effective termination date will be ${contractEndDate}.`
      : `We are providing this notice due to material breach of contract, in accordance with Section 10. The effective termination date will be ${contractEndDate}.`;

    const letter = `
      <strong>Subject:</strong> Notice of Termination ‚Äì SDI Service Agreement ${accountNumber} / ${contractNumber}<br><br>
      To: Evoqua Water Technologies Ltd.<br><br>
      Dear Evoqua Team,<br><br>
      ${noticeText}<br><br>
      We acknowledge our obligation to:<br>
      - Continue payment of the monthly rental service charge for the remainder of the term, if applicable.<br>
      - Promptly make all Evoqua-owned equipment available for removal upon expiration or termination.<br>
      - Settle all outstanding invoices and charges.<br><br>
      Please confirm receipt of this notice and provide instructions for equipment return and final settlement.<br><br>
      Thank you for your cooperation.<br><br>
      Sincerely,<br>
      ${yourName}<br>
      ${yourPosition}<br>
      ${yourContact}
    `;

    letterDiv.innerHTML = letter;
    outputSection.classList.remove('hidden');
    outputSection.scrollIntoView({ behavior: 'smooth' });
  });

  // ‚úÖ Download as Word (with proper HTML structure and UTF-8 encoding)
  downloadWordBtn.addEventListener('click', function () {
    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Cancellation Letter</title>
      </head>
      <body>
        ${letterDiv.innerHTML}
      </body>
      </html>
    `;
    const blob = new Blob([htmlContent], { type: 'application/msword;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Cancellation_Letter.doc';
    link.click();
  });

  // ‚úÖ Download as PDF using jsPDF
  downloadPdfBtn.addEventListener('click', function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.html(letterDiv, {
      callback: function (doc) {
        doc.save('Cancellation_Letter.pdf');
      },
      x: 10,
      y: 10
    });
  });
});

</script>
</body>
</html>


--- End of sdi_cancel.php ---



--- Start of search.php ---

<?php
/**
 * Global Search API
 * Returns JSON results for contacts, customers, opportunities, etc.
 */

require_once __DIR__ . '/simple_auth/middleware.php';
require_once __DIR__ . '/csv_handler.php';
require_once __DIR__ . '/sanitize_helper.php';

// Only allow authenticated users
if (empty($_SESSION['user_id'])) {
    header('HTTP/1.1 401 Unauthorized');
    echo json_encode(['error' => 'Authentication required']);
    exit;
}

header('Content-Type: application/json');

$query = strtolower(trim($_GET['q'] ?? ''));

if (strlen($query) < 2) {
    echo json_encode([]);
    exit;
}

$results = [];
$maxResultsPerType = 5;

// Search Contacts
try {
    $contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
    $contactsForSearch = is_array($contacts) ? $contacts : [];
    if (!empty($contactsForSearch)) {
        foreach ($contacts as $contact) {
            if (count(array_filter($results, fn($r) => $r['type'] === 'Contacts')) >= $maxResultsPerType) {
                break;
            }
            
            $haystack = strtolower(implode(' ', [
                $contact['first_name'] ?? '',
                $contact['last_name'] ?? '',
                $contact['company'] ?? '',
                $contact['email'] ?? '',
                $contact['phone'] ?? ''
            ]));
            
            if (strpos($haystack, $query) !== false) {
                $name = trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? ''));
                $results[] = [
                    'type' => 'Contacts',
                    'title' => $name ?: 'Unnamed Contact',
                    'subtitle' => ($contact['company'] ?? '') . ' ‚Ä¢ ' . ($contact['email'] ?? ''),
                    'url' => 'contact_view.php?id=' . urlencode($contact['id'] ?? '')
                ];
            }
        }
    }
} catch (Exception $e) {
    // Silently skip if contacts.csv can't be read
    $contactsForSearch = [];
}

// Search Customers (from contacts marked as customers)
if (!empty($contactsForSearch)) {
    foreach ($contactsForSearch as $contact) {
        if (count(array_filter($results, fn($r) => $r['type'] === 'Customers')) >= $maxResultsPerType) {
            break;
        }
        
        $isCustomer = strtolower(trim($contact['is_customer'] ?? ''));
        if (!in_array($isCustomer, ['yes', 'true', '1'], true)) {
            continue;
        }
        
        $haystack = strtolower(implode(' ', [
            $contact['company'] ?? '',
            $contact['first_name'] ?? '',
            $contact['last_name'] ?? '',
            $contact['email'] ?? ''
        ]));
        
        if (strpos($haystack, $query) !== false) {
            $name = trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? ''));
            $results[] = [
                'type' => 'Customers',
                'title' => ($contact['company'] ?? '') ?: ($name ?: 'Unnamed Customer'),
                'subtitle' => $name,
                'url' => 'customer_view.php?id=' . urlencode($contact['id'] ?? '')
            ];
        }
    }
}

// Search Opportunities
try {
    $opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
    if (is_array($opportunities)) {
        foreach ($opportunities as $opp) {
            if (count(array_filter($results, fn($r) => $r['type'] === 'Opportunities')) >= $maxResultsPerType) {
                break;
            }
            
            $haystack = strtolower(implode(' ', [
                $opp['company'] ?? '',
                $opp['stage'] ?? '',
                $opp['description'] ?? ''
            ]));
            
            if (strpos($haystack, $query) !== false) {
                $value = isset($opp['value']) ? '$' . number_format($opp['value'], 0) : '';
                $results[] = [
                    'type' => 'Opportunities',
                    'title' => ($opp['company'] ?? 'Unnamed Opportunity') . ' - ' . ($opp['stage'] ?? ''),
                    'subtitle' => $value . ' ‚Ä¢ ' . ($opp['description'] ?? ''),
                    'url' => 'opportunities_list.php?id=' . urlencode($opp['id'] ?? '')
                ];
            }
        }
    }
} catch (Exception $e) {
    // Silently skip if opportunities.csv can't be read
}

// Search Purchase Orders (if admin)
if (isAdmin()) {
    try {
        $purchase_orders = readCSV('purchase_orders.csv', require __DIR__ . '/purchase_order_schema.php');
        if (is_array($purchase_orders)) {
            foreach ($purchase_orders as $po) {
                if (count(array_filter($results, fn($r) => $r['type'] === 'Purchase Orders')) >= $maxResultsPerType) {
                    break;
                }
                
                $haystack = strtolower(implode(' ', [
                    $po['po_number'] ?? '',
                    $po['supplier'] ?? '',
                    $po['status'] ?? ''
                ]));
                
                if (strpos($haystack, $query) !== false) {
                    $results[] = [
                        'type' => 'Purchase Orders',
                        'title' => 'PO #' . ($po['po_number'] ?? ''),
                        'subtitle' => ($po['supplier'] ?? '') . ' ‚Ä¢ ' . ($po['status'] ?? ''),
                        'url' => 'purchase_order_summary.php?po=' . urlencode($po['po_number'] ?? '')
                    ];
                }
            }
        }
    } catch (Exception $e) {
        // Silently skip
    }
}

// Return results
echo json_encode(array_values($results));


--- End of search.php ---



--- Start of submit-contact.php ---

<?php

require_once 'contact_validator.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'PHPMailer.php';
require 'SMTP.php';
require 'Exception.php';

$schema = require __DIR__ . '/contact_schema.php';
$mail = new PHPMailer(true);

try {
    // Collect and sanitize form data
    $data = [];
    foreach ($schema as $field) {
        if ($field === 'id') continue;
        $value = htmlspecialchars(trim($_POST[$field] ?? ''));
        $data[$field] = $value;
    }

    // Validate required fields
    if (empty($data['first_name']) || empty($data['email']) || empty($data['message'])) {
        throw new Exception("Please fill in all required fields.");
    }

    // Save to CSV
    $csvRow = array_values($data);
    $csvRow[] = date('Y-m-d H:i:s');
    $file = fopen('contacts.csv', 'a');
    if ($file) {
        fputcsv($file, $csvRow);
        fclose($file);
    } else {
        throw new Exception("Unable to write to contacts.csv");
    }

    // GoDaddy relay SMTP settings
    $mail->SMTPDebug = 0;
    $mail->isSMTP();
    $mail->Host = 'relay-hosting.secureserver.net';
    $mail->SMTPAuth = false;
    $mail->SMTPSecure = '';
    $mail->Port = 25;

    // Email headers
    $mail->setFrom('rlee@eclipsewatertechnologies.com', 'Eclipse Contact Form');
    $mail->addAddress('rlee@eclipsewatertechnologies.com');
    $mail->addReplyTo($data['email'], $data['first_name']);

    // Email content
    $mail->Subject = 'New Contact Form Submission';
    $mail->Body = "Name: {$data['first_name']}\nEmail: {$data['email']}\nCompany: {$data['company']}\nMessage:\n{$data['message']}";

    $mail->send();

    // Redirect with success status
    header('Location: contact_form.php?status=success');
    exit;

} catch (Exception $e) {
    error_log("Contact form error: " . $e->getMessage());
    header('Location: contact_form.php?status=error');
    exit;
}


--- End of submit-contact.php ---



--- Start of tag_schema.php ---

<?phpreturn [
    'VIP' => 'VIP Client',
    'Lead' => 'Sales Lead',
    'Newsletter' => 'Newsletter Subscriber',
    'Inactive' => 'Inactive Contact',
    'Partner' => 'Business Partner',
    'Support' => 'Support Request',
    'Demo' => 'Requested Demo',
];
>

--- End of tag_schema.php ---



--- Start of test.php ---

<?php echo "PHP is working!"; ?>

--- End of test.php ---



--- Start of test_forecast.php ---

<?php
require 'forecast_calc.php';

$forecast = calculateForecasts();
echo "<pre>";
print_r($forecast);
echo "</pre>";
?>


--- End of test_forecast.php ---



--- Start of test_get.php ---

<?php
// ULTRA SIMPLE GET TEST - NO DEPENDENCIES
?>
<!DOCTYPE html>
<html>
<head>
    <title>GET Parameter Test</title>
</head>
<body style="font-family: Arial; padding: 40px; background: #f0f0f0;">
    <h1 style="color: #ff6b6b;">üî¨ GET Parameter Test</h1>
    
    <div style="background: white; padding: 30px; border-radius: 8px; margin: 20px 0;">
        <h2>Test Form</h2>
        <form method="GET" action="test_get.php">
            <input type="text" name="testquery" placeholder="Type anything..." style="padding: 10px; font-size: 16px; width: 300px;">
            <button type="submit" style="padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; cursor: pointer;">Submit Test</button>
        </form>
    </div>
    
    <div style="background: #333; color: #0f0; padding: 30px; border-radius: 8px; font-family: monospace; margin: 20px 0;">
        <h2 style="color: #0f0;">RAW $_GET Array:</h2>
        <pre style="color: #0f0;"><?php print_r($_GET); ?></pre>
        
        <h2 style="color: #0f0; margin-top: 30px;">Individual Values:</h2>
        <?php if (!empty($_GET)): ?>
            <?php foreach ($_GET as $key => $value): ?>
                <div style="background: rgba(0,255,0,0.1); padding: 10px; margin: 5px 0; border-left: 3px solid #0f0;">
                    <strong>[<?= htmlspecialchars($key) ?>]</strong> = "<?= htmlspecialchars($value) ?>"
                </div>
            <?php endforeach; ?>
        <?php else: ?>
            <div style="background: rgba(255,0,0,0.3); padding: 15px; border-left: 3px solid red; color: #ff6b6b;">
                ‚ùå NO GET PARAMETERS RECEIVED
            </div>
        <?php endif; ?>
        
        <h2 style="color: #0f0; margin-top: 30px;">Current URL:</h2>
        <div style="background: rgba(0,255,0,0.1); padding: 10px; word-break: break-all;">
            <?= htmlspecialchars($_SERVER['REQUEST_URI'] ?? 'N/A') ?>
        </div>
        
        <h2 style="color: #0f0; margin-top: 30px;">Query String:</h2>
        <div style="background: rgba(0,255,0,0.1); padding: 10px; word-break: break-all;">
            <?= htmlspecialchars($_SERVER['QUERY_STRING'] ?? 'EMPTY') ?>
        </div>
    </div>
    
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 5px solid #ffc107;">
        <h3>Instructions:</h3>
        <ol>
            <li>Type something in the input box above</li>
            <li>Click "Submit Test"</li>
            <li>Check if the green box shows your input</li>
            <li>If it DOES work here but NOT on contacts_list.php, we have a specific file issue</li>
            <li>If it DOESN'T work here either, we have a server/PHP configuration issue</li>
        </ol>
    </div>
</body>
</html>


--- End of test_get.php ---



--- Start of update_contact.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); ?>
<?php

require_once 'contact_validator.php';require_once 'csv_handler.php';

$schema = getContactSchema();
$contacts = readCSV('contacts.csv');
$updatedId = $_POST['id'] ?? null;

if (!$updatedId) {
    echo "Missing contact ID.";
    exit;
}

// Build updated contact
$updatedContact = [];
foreach ($schema as $col) {
    $updatedContact[$col] = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST[$col] ?? '';
}

// Replace contact in list
$updatedList = array_map(function($c) use ($updatedId, $updatedContact) {
    return $c['id'] === $updatedId ? $updatedContact : $c;
}, $contacts);

// Write back to CSV
writeCSV('contacts.csv', $updatedList);

// Redirect to viewer
header("Location: contact_view.php?id=$updatedId");
exit;
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of update_contact.php ---



--- Start of validation.php ---

<?php
function isValidEmail($email) {
    return empty($email) || filter_var($email, FILTER_VALIDATE_EMAIL);
}

function isValidPhone($phone) {
    return empty($phone) || preg_match('/^\+?[0-9\s\-]{7,15}$/', $phone);
}

function validateContact($row) {
    $errors = [];

    // Company is required
    if (empty(trim($row['company']))) {
        $errors['company'] = 'Company name is required.';
    }

    // Email format check (only if provided)
    if (!isValidEmail($row['email'])) {
        $errors['email'] = 'Invalid email format.';
    }

    // Phone format check (only if provided)
    if (!isValidPhone($row['phone'])) {
        $errors['phone'] = 'Invalid phone number.';
    }

    return $errors;
}

--- End of validation.php ---



--- Start of contacts.php ---

<?php
// api/contacts.php
header('Content-Type: application/json');
$sanitize_for_json = function($data) {
    if (is_array($data)) {
        $clean = [];
        foreach ($data as $k => $v) {
            $clean[$k] = $sanitize_for_json($v);
        }
        return $clean;
    } elseif (is_string($data)) {
        // Remove invalid UTF-8, normalize line endings, remove stray backslashes
        $data = mb_convert_encoding($data, 'UTF-8', 'UTF-8');
        $data = str_replace(["\r\n", "\r"], "\n", $data);
        $data = preg_replace('/\\(?!["\\\/bfnrtu])/', '', $data); // Remove stray backslashes not part of valid escapes
        return $data;
    } else {
        return $data;
    }
};
require_once __DIR__ . '/../csv_handler.php';
$schema = ['id','first_name','last_name','company','email','phone','address_1','address_2','city','province','postal_code','country','notes','tank_number','created_at','last_modified','tags','is_customer','customer_id'];

// Simple authentication check (placeholder, replace with real auth)
// if (!isset($_SERVER['HTTP_AUTHORIZATION'])) { http_response_code(401); echo json_encode(['error'=>'Unauthorized']); exit; }

switch ($_SERVER['REQUEST_METHOD']) {
    case 'GET':
        $contacts = readCSV(__DIR__ . '/../contacts.csv', $schema);
        // Sanitize all data before encoding
        $contacts = $sanitize_for_json($contacts);
        echo json_encode($contacts);
        break;
    case 'POST':
        $input = json_decode(file_get_contents('php://input'), true);
        if (!$input || !isset($input['email'])) {
            http_response_code(400);
            echo json_encode(['error'=>'Invalid input']);
            exit;
        }
        $contacts = readCSV(__DIR__ . '/../contacts.csv', $schema);
        $input['id'] = uniqid('cnt_', true);
        $input['created_at'] = date('Y-m-d H:i:s');
        $input['last_modified'] = $input['created_at'];
        $contacts[] = $input;
        writeCSV(__DIR__ . '/../contacts.csv', $contacts, $schema);
        http_response_code(201);
        echo json_encode(['success'=>true,'id'=>$input['id']]);
        break;
    default:
        http_response_code(405);
        echo json_encode(['error'=>'Method not allowed']);
}


--- End of contacts.php ---



--- Start of add_contact.php ---

<?php
// Authentication check (without HTML output)
require_once __DIR__ . '/simple_auth/middleware.php';

// Load helper files
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'forecast_calc.php';
require_once 'error_handler.php';
require_once 'csrf_helper.php';
require_once 'sanitize_helper.php';
require_once 'audit_handler.php';

// Start session for CSRF if not already started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Initialize CSRF token
initializeCSRFToken();

// ‚úÖ CSRF Protection: Verify token on POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        logWarning('CSRF token validation failed', ['email' => $_POST['email'] ?? '']);
        die(json_encode(['error' => 'Security validation failed. Please try again.']));
    }
}

$filename = 'contacts.csv';
$logFile = 'error_log.txt';
$schema = require __DIR__ . '/contact_schema.php';

$timestamp = date('Y-m-d H:i:s');
$newContact = [
    'id' => uniqid(),
    'first_name' => $_POST['first_name'] ?? '',
    'last_name' => $_POST['last_name'] ?? '',
    'company' => $_POST['company'] ?? '',
    'address_1' => $_POST['address_1'] ?? '',
    'address_2' => $_POST['address_2'] ?? '', 
    'city' => $_POST['city'] ?? '',
    'postal_code' => $_POST['postal_code'] ?? '',
    'province' => $_POST['province'] ?? '',
    'country' => $_POST['country'] ?? '',
    'phone' => $_POST['phone'] ?? '',
    'email' => $_POST['email'] ?? '',
    'created_at' => $timestamp,
    'source' => 'manual_entry'
];

// ‚úÖ ENHANCED: Sanitize input before validation
$newContact = sanitizeContact($newContact);

// ‚úÖ ENHANCED: Validate contact
$errors = validateContact($newContact);

// ‚úÖ ENHANCED: Check for duplicate email
if (empty($errors) && !empty($newContact['email'])) {
    if (!isEmailUnique($newContact['email'])) {
        $errors['email'] = "Email already exists in the system.";
    }
}

if (!empty($errors)) {
    // Display errors to user
    showValidationErrors($errors);
    
    // Log validation errors
    logWarning('Contact validation failed', [
        'email' => $newContact['email'],
        'errors' => $errors,
    ]);

    echo "<p><a href=\"javascript:history.back()\">‚Üê Go back</a></p>";
    exit;
}

try {
    // ‚úÖ LOCKED READ-MODIFY-WRITE: Prevents race condition data loss
    readModifyWriteCSV($filename, $schema, function($contacts) use ($newContact, $timestamp, $logFile) {
        // Add new contact
        $contacts[] = $newContact;
        
        // Log success
        logInfo('Contact created successfully', [
            'email' => $newContact['email'],
            'name' => $newContact['first_name'] . ' ' . $newContact['last_name'],
        ]);
        
        // ‚úÖ AUDIT: Log contact creation
        auditCreateContact($newContact, 'success');
        
        return $contacts;
    });
    
    // Redirect to confirmation
    header('Location: contact_success.php');
    exit;
} catch (Exception $e) {
    $errorMsg = getErrorMessage($e);
    showError('Unable to Save Contact', $errorMsg, $e->getMessage());
    
    // Log error
    logError('Contact save failed', [
        'email' => $newContact['email'],
        'exception' => $e->getMessage(),
    ]);
    
    // ‚úÖ AUDIT: Log failed creation attempt
    auditCreateContact($newContact, 'failed', $e->getMessage());
    
    echo "<p><a href=\"javascript:history.back()\">‚Üê Try again</a></p>";
    exit;
}
?>


--- End of add_contact.php ---



--- Start of add_customer.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/customer_schema.php';
$itemFields = require __DIR__ . '/customer_item_config.php';
$customerFile = 'customers.csv';
$itemFile = 'customer_items.csv';
$errors = [];
$success = false;
$newCustomer = [];

// Load existing customers
$rows = readCSV($customerFile, $schema);
$lastId = 0;
foreach ($rows as $r) {
    $id = intval($r['customer_id']);
    if ($id > $lastId) $lastId = $id;
}
$nextId = str_pad($lastId + 1, 5, '0', STR_PAD_LEFT);

// Handle POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    foreach ($schema as $field) {
        $newCustomer[$field] = ($field === 'customer_id') ? $nextId : trim($_POST[$field] ?? '');
    }

    // Validate main fields
    if ($newCustomer['contact_name'] === '') $errors[] = 'Contact name is required.';
    if ($newCustomer['address'] === '') $errors[] = 'Address is required.';

    // Parse line items
    $items = [];
    if (isset($_POST['items']) && is_array($_POST['items'])) {
        foreach ($_POST['items'] as $item) {
            $clean = ['customer_id' => $nextId];
            foreach ($itemFields as $f) {
                $clean[$f] = trim($item[$f] ?? '');
            }
            $items[] = $clean;
        }
    }

    if (empty($errors)) {
        $rows[] = $newCustomer;
        writeCSV($customerFile, $rows, $schema);

        $existingItems = readCSV($itemFile, array_merge(['customer_id'], $itemFields));
        $existingItems = is_array($existingItems) ? $existingItems : [];
        $allItems = array_merge($existingItems, $items);
        writeCSV($itemFile, $allItems, array_merge(['customer_id'], $itemFields));

        $success = true;
    }
}
?>

<div class="container">
  <h2>Add New Customer</h2>

  <?php if ($success): ?>
    <p style="color:green;">‚úÖ Customer added successfully. ID: <?= $nextId ?></p>
  <?php endif; ?>

  <?php if (!empty($errors)): ?>
    <ul style="color:red;">
      <?php foreach ($errors as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
    </ul>
  <?php endif; ?>

  <form method="POST">
    <fieldset style="margin-bottom:20px;">
      <legend><strong>Main Customer Info</strong></legend>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
        <div>
          <label><strong>Customer ID:</strong></label><br>
          <input type="text" value="<?= $nextId ?>" readonly>
        </div>
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'customer_id') continue; ?>
          <div>
            <label for="<?= $field ?>"><strong><?= ucfirst(str_replace('_', ' ', $field)) ?>:</strong></label><br>
            <input type="text" name="<?= $field ?>" id="<?= $field ?>" value="<?= htmlspecialchars($_POST[$field] ?? '') ?>">
          </div>
        <?php endforeach; ?>
      </div>
    </fieldset>

    <fieldset>
      <legend><strong>Tank & Delivery Line Items</strong></legend>
      <div id="lineItems"></div>
      <button type="button" onclick="addLineItem()" class="btn-outline">‚ûï Add Line Item</button>
    </fieldset>

    <div style="margin-top:20px;">
      <button type="submit" class="btn-outline">üíæ Save Customer</button>
    </div>
  </form>
</div>

<script>
function addLineItem() {
  const container = document.getElementById('lineItems');
  const index = container.children.length;
  const fields = <?= json_encode($itemFields) ?>;
  const row = document.createElement('div');
  row.style.marginBottom = '12px';
  row.style.border = '1px solid #ccc';
  row.style.padding = '10px';
  row.style.borderRadius = '6px';
  row.style.background = '#f9f9f9';

  let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">';
  fields.forEach(f => {
    html += `
      <div>
        <label><strong>${f.replace(/_/g, ' ')}:</strong></label><br>
        <input type="text" name="items[${index}][${f}]" />
      </div>
    `;
  });
  html += '</div>';
  row.innerHTML = html;
  container.appendChild(row);
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_customer.php ---



--- Start of add_discussion.php ---

<?php
require_once 'contact_validator.php';
require_once 'discussion_logger.php'; // contains logDiscussionEntry()

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $contactId = trim($_POST['contact_id'] ?? '');
    // Validate input
    $errors = validateContact($_POST);
    if (!empty($errors)) {
        foreach ($errors as $field => $msg) {
            echo "<p>Error in $field: $msg</p>";
        }
        $backUrl = $contactId !== '' ? 'contact_view.php?id=' . urlencode($contactId) : 'contacts_list.php';
        echo "<p><a href='$backUrl'>Go back</a></p>";
        exit;
    }

    // Log the discussion entry
    if (logDiscussionEntry($_POST)) {
        $redirectUrl = $contactId !== '' ? 'contact_view.php?id=' . urlencode($contactId) : 'contacts_list.php';
        header('Location: ' . $redirectUrl);
        exit;
    } else {
        echo "<p style='color:red;'>Failed to log discussion entry. Please check the error log.</p>";
        $backUrl = $contactId !== '' ? 'contact_view.php?id=' . urlencode($contactId) : 'contacts_list.php';
        echo "<p><a href='$backUrl'>Go back</a></p>";
    }
}
?>



--- End of add_discussion.php ---



--- Start of add_opportunity.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $opportunities = readCSV('opportunities.csv', $schema);
    
    // Validate inputs
    $errors = [];
    
    if (empty($_POST['contact_id'])) {
        $errors[] = 'Contact is required';
    }
    
    if (!isset($_POST['value']) || $_POST['value'] === '' || !is_numeric($_POST['value']) || $_POST['value'] < 0) {
        $errors[] = 'Valid opportunity value is required';
    }
    
    if (!isset($_POST['probability']) || $_POST['probability'] === '' || !is_numeric($_POST['probability']) || $_POST['probability'] < 0 || $_POST['probability'] > 100) {
        $errors[] = 'Probability must be between 0 and 100';
    }
    
    if (empty($_POST['stage'])) {
        $errors[] = 'Stage is required';
    }
    
    if (empty($_POST['expected_close'])) {
        $errors[] = 'Expected close date is required';
    }
    
    if (empty($errors)) {
        // Generate ID
        $ids = array_column($opportunities, 'id');
        $numericIds = array_map('intval', $ids);
        $newId = empty($numericIds) ? 1 : max($numericIds) + 1;
        
        $newOpportunity = [
            'id' => $newId,
            'contact_id' => $_POST['contact_id'] ?? '',
            'value' => number_format((float)$_POST['value'], 2, '.', ''),
            'stage' => $_POST['stage'] ?? 'Prospecting',
            'probability' => (int)$_POST['probability'],
            'expected_close' => $_POST['expected_close'] ?? '',
        ];
        
        $opportunities[] = $newOpportunity;
        
        if (writeCSV('opportunities.csv', $opportunities, $schema)) {
            header('Location: opportunities_list.php?success=1');
            exit;
        } else {
            $error = 'Failed to save opportunity.';
        }
    } else {
        $error = implode(', ', $errors);
    }
}
?>

<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }
  
  .page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
  }
  
  .page-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 14px;
  }
  
  .back-link:hover {
    color: #5558dd;
  }
  
  .form-container {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: 0auto;
  }
  
  .form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #E5E7EB;
  }
  
  .form-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
  
  .form-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  .form-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-group input,
  .form-group select {
    padding: 14px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    background: white;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .form-group select {
    cursor: pointer;
  }
  
  .form-help {
    font-size: 12px;
    color: #6B7280;
    margin-top: 6px;
  }
  
  .stage-visual {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  
  .stage-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  
  .stage-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .stage-badge.selected {
    border-color: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
  
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }
  
  .btn-primary {
    padding: 14px 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-secondary {
    padding: 14px 32px;
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-secondary:hover {
    background: #E5E7EB;
  }
  
  .error-alert {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border: 2px solid #EF4444;
    color: #991B1B;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-slider {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-value {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    min-width: 50px;
  }
  
  input[type="range"] {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #E5E7EB;
    outline: none;
    padding: 0;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
  }
  
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .page-header {
      padding: 24px;
    }
    
    .form-container {
      padding: 24px;
    }
  }
</style>

<a href="opportunities_list.php" class="back-link">
  ‚Üê Back to Opportunities
</a>

<div class="page-header">
  <h1>‚ûï Create New Opportunity</h1>
  <p>Add a new sales opportunity to your pipeline</p>
</div>

<?php if (isset($error)): ?>
  <div class="error-alert">
    <span>‚ö†Ô∏è</span>
    <span><?= htmlspecialchars($error) ?></span>
  </div>
<?php endif; ?>

<div class="form-container">
  <form method="POST" id="opportunityForm">
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üë§</span>
        <span>Contact Information</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="contact_id">Contact *</label>
          <select name="contact_id" id="contact_id" required>
            <option value="">Select a contact...</option>
            <?php foreach ($contacts as $contact): ?>
              <?php
                $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
                $company = $contact['company'] ?? '';
                $displayName = $fullName ?: 'Unnamed Contact';
                if ($company) {
                  $displayName .= ' (' . $company . ')';
                }
              ?>
              <option value="<?= htmlspecialchars($contact['id']) ?>">
                <?= htmlspecialchars($displayName) ?>
              </option>
            <?php endforeach; ?>
          </select>
          <div class="form-help">Select the contact associated with this opportunity</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üí∞</span>
        <span>Deal Details</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="value">Opportunity Value *</label>
          <input 
            type="number" 
            name="value" 
            id="value" 
            placeholder="0.00" 
            step="0.01" 
            min="0"
            required
          >
          <div class="form-help">Enter the total value in dollars</div>
        </div>
        
        <div class="form-group">
          <label for="expected_close">Expected Close Date *</label>
          <input 
            type="date" 
            name="expected_close" 
            id="expected_close"
            required
          >
          <div class="form-help">When do you expect to close this deal?</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üìä</span>
        <span>Sales Stage & Probability</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="stage">Sales Stage *</label>
          <select name="stage" id="stage" required>
            <option value="">Select stage...</option>
            <option value="Prospecting" data-probability="10">Prospecting (10% win rate)</option>
            <option value="Proposal" data-probability="25">Proposal (25% win rate)</option>
            <option value="Negotiation" data-probability="50">Negotiation (50% win rate)</option>
            <option value="Closed Won" data-probability="100">Closed Won (100%)</option>
            <option value="Closed Lost" data-probability="0">Closed Lost (0%)</option>
          </select>
          
          <div class="stage-visual" style="margin-top: 16px;">
            <div class="stage-badge" style="background: #6366F1;" data-stage="Prospecting">Prospecting</div>
            <div class="stage-badge" style="background: #8B5CF6;" data-stage="Proposal">Proposal</div>
            <div class="stage-badge" style="background: #F59E0B;" data-stage="Negotiation">Negotiation</div>
            <div class="stage-badge" style="background: #10B981;" data-stage="Closed Won">Closed Won</div>
            <div class="stage-badge" style="background: #EF4444;" data-stage="Closed Lost">Closed Lost</div>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="probability">Win Probability *</label>
          <div class="probability-slider">
            <input 
              type="range" 
              name="probability" 
              id="probability" 
              min="0" 
              max="100" 
              value="10"
              step="5"
            >
            <span class="probability-value">10%</span>
          </div>
          <div class="form-help">Estimated likelihood of closing this deal</div>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Create Opportunity</button>
      <a href="opportunities_list.php" class="btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Update probability slider value display
  const probabilitySlider = document.getElementById('probability');
  const probabilityValue = document.querySelector('.probability-value');
  
  probabilitySlider.addEventListener('input', function() {
    probabilityValue.textContent = this.value + '%';
  });
  
  // Auto-update probability based on stage selection
  const stageSelect = document.getElementById('stage');
  stageSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const suggestedProbability = selectedOption.getAttribute('data-probability');
    
    if (suggestedProbability) {
      probabilitySlider.value = suggestedProbability;
      probabilityValue.textContent = suggestedProbability + '%';
    }
    
    // Update visual badges
    document.querySelectorAll('.stage-badge').forEach(badge => {
      badge.classList.remove('selected');
      if (badge.getAttribute('data-stage') === this.value) {
        badge.classList.add('selected');
      }
    });
  });
  
  // Allow clicking stage badges to select stage
  document.querySelectorAll('.stage-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const stageName = this.getAttribute('data-stage');
      stageSelect.value = stageName;
      stageSelect.dispatchEvent(new Event('change'));
    });
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_opportunity.php ---



--- Start of add_task.php ---

<?php
require_once 'csv_handler.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title = trim($_POST['title']);
    $due_date = $_POST['due_date'];
    $status = $_POST['status'];
    $errors = [];

    if ($title === '') $errors[] = 'Task title is required.';
    if ($due_date === '') $errors[] = 'Due date is required.';
    elseif (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $due_date)) $errors[] = 'Invalid date format.';
    if ($status !== 'pending' && $status !== 'completed') $errors[] = 'Invalid status selected.';

    if (!empty($errors)) {
        echo "<div style='color:red;'><strong>Error:</strong><ul>";
        foreach ($errors as $error) echo "<li>" . htmlspecialchars($error) . "</li>";
        echo "</ul></div><a href='index.php'>Go back</a>";
        exit;
    }

    $filename = 'tasks.csv';
    $newTask = [$title, $due_date, $status, date('Y-m-d H:i:s')];
    appendCSV($filename, $newTask);
    header('Location: index.php');
    exit;
}
?>


--- End of add_task.php ---



--- Start of add_tasks.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$title = $_POST['title'] ?? '';
if (trim($title) === '') {
    echo 'error: empty title';
    exit;
}

$filename = 'tasks.csv';
$headers = ['id','title','status','priority','assigned_to','due_date','timestamp'];

if (!file_exists($filename)) {
    $fp = fopen($filename, 'w');
    if ($fp === false) {
        echo 'error: cannot create file';
        exit;
    }
    fputcsv($fp, $headers);
    fclose($fp);
}

$id = uniqid('task_', true);
$status = 'incomplete';
$priority = '';
$assigned_to = '';
$due_date = '';
$timestamp = date('Y-m-d H:i:s');

$fp = fopen($filename, 'a');
if ($fp !== false) {
    fputcsv($fp, [$id, $title, $status, $priority, $assigned_to, $due_date, $timestamp]);
    fclose($fp);
    echo 'success';
} else {
    echo 'error: cannot open file for appending';
}
?>

--- End of add_tasks.php ---



--- Start of admin_audit.php ---

<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Audit Log Viewer';

$filter_user = $_GET['user'] ?? '';
$filter_action = $_GET['action'] ?? '';
$filter_date = $_GET['date'] ?? '';
$page = max(1, $_GET['page'] ?? 1);
$per_page = 50;

// Get all audit entries
$all_entries = file_exists('activity_log.csv') ? readCSV('activity_log.csv') : [];

// Apply filters
$filtered = $all_entries;

if ($filter_user) {
    $filtered = array_filter($filtered, fn($e) => $e['user_id'] === $filter_user);
}

if ($filter_action) {
    $filtered = array_filter($filtered, fn($e) => $e['action'] === $filter_action);
}

if ($filter_date) {
    $date_prefix = date('Y-m-d', strtotime($filter_date));
    $filtered = array_filter($filtered, fn($e) => strpos($e['timestamp'], $date_prefix) === 0);
}

// Sort by timestamp descending
usort($filtered, fn($a, $b) => strtotime($b['timestamp']) - strtotime($a['timestamp']));

// Pagination
$total = count($filtered);
$total_pages = max(1, ceil($total / $per_page));
$page = min($page, $total_pages);
$offset = ($page - 1) * $per_page;
$entries = array_slice($filtered, $offset, $per_page);

// Get unique values for filters
$all_users = array_unique(array_column($all_entries, 'user_id'));
$all_actions = array_unique(array_column($all_entries, 'action'));

?>

<style>
.audit-filters { background: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
.audit-filters form { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
.audit-filters select, .audit-filters input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
.audit-filters button { padding: 8px 16px; background: #0099A8; color: white; border: none; border-radius: 4px; cursor: pointer; }
.audit-table { width: 100%; margin-top: 20px; font-size: 12px; border-collapse: collapse; }
.audit-table th { background: #f5f5f5; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
.audit-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
.audit-table tr:hover { background: #f9f9f9; }
.status-success { color: #28a745; font-weight: bold; }
.status-failed { color: #dc3545; font-weight: bold; }
</style>

<div class="container" style="max-width: 1200px;">
  <h2>Audit Log Viewer</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <!-- Filters -->
  <div class="audit-filters">
    <form method="GET">
      <div>
        <label for="user">User:</label>
        <select name="user" id="user">
          <option value="">All Users</option>
          <?php foreach ($all_users as $user): ?>
            <option value="<?= htmlspecialchars($user) ?>" <?= $filter_user === $user ? 'selected' : '' ?>>
              <?= htmlspecialchars($user) ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div>
        <label for="action">Action:</label>
        <select name="action" id="action">
          <option value="">All Actions</option>
          <?php foreach ($all_actions as $act): ?>
            <option value="<?= htmlspecialchars($act) ?>" <?= $filter_action === $act ? 'selected' : '' ?>>
              <?= htmlspecialchars($act) ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div>
        <label for="date">Date:</label>
        <input type="date" name="date" id="date" value="<?= htmlspecialchars($filter_date) ?>">
      </div>

      <button type="submit">Filter</button>
      <a href="admin_audit.php" style="padding: 8px 16px; background: #6c757d; color: white; border-radius: 4px; text-decoration: none;">Reset</a>
    </form>
  </div>

  <div style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 6px;">
    <strong>Total Entries:</strong> <?= number_format($total) ?>
    <?php if ($filter_user || $filter_action || $filter_date): ?>
      | <strong>Filtered:</strong> <?= number_format(count($filtered)) ?> 
      | <strong>Showing:</strong> <?= $offset + 1 ?>‚Äì<?= min($offset + $per_page, $total) ?>
    <?php endif; ?>
  </div>

  <!-- Audit Table -->
  <?php if (!empty($entries)): ?>
    <table class="audit-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>User</th>
          <th>IP Address</th>
          <th>Action</th>
          <th>Entity</th>
          <th>Status</th>
          <th>Summary</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($entries as $entry): ?>
          <tr>
            <td><?= htmlspecialchars($entry['timestamp'] ?? '') ?></td>
            <td><?= htmlspecialchars($entry['user_id'] ?? 'unknown') ?></td>
            <td><?= htmlspecialchars($entry['ip_address'] ?? 'unknown') ?></td>
            <td><?= htmlspecialchars($entry['action'] ?? 'unknown') ?></td>
            <td><?= htmlspecialchars($entry['entity_type'] ?? 'contact') ?></td>
            <td>
              <span class="status-<?= $entry['status'] ?? 'unknown' ?>">
                <?= htmlspecialchars($entry['status'] ?? 'unknown') ?>
              </span>
            </td>
            <td><?= htmlspecialchars(substr($entry['summary'] ?? '', 0, 50)) ?></td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>

    <!-- Pagination -->
    <?php if ($total_pages > 1): ?>
      <div style="margin-top: 20px; text-align: center;">
        <?php if ($page > 1): ?>
          <a href="?page=1<?= $filter_user ? '&user=' . urlencode($filter_user) : '' ?><?= $filter_action ? '&action=' . urlencode($filter_action) : '' ?><?= $filter_date ? '&date=' . urlencode($filter_date) : '' ?>" class="btn-outline">¬´ First</a>
          <a href="?page=<?= $page - 1 ?><?= $filter_user ? '&user=' . urlencode($filter_user) : '' ?><?= $filter_action ? '&action=' . urlencode($filter_action) : '' ?><?= $filter_date ? '&date=' . urlencode($filter_date) : '' ?>" class="btn-outline">‚Äπ Previous</a>
        <?php endif; ?>

        <span style="margin: 0 10px;">Page <?= $page ?> of <?= $total_pages ?></span>

        <?php if ($page < $total_pages): ?>
          <a href="?page=<?= $page + 1 ?><?= $filter_user ? '&user=' . urlencode($filter_user) : '' ?><?= $filter_action ? '&action=' . urlencode($filter_action) : '' ?><?= $filter_date ? '&date=' . urlencode($filter_date) : '' ?>" class="btn-outline">Next ‚Ä∫</a>
          <a href="?page=<?= $total_pages ?><?= $filter_user ? '&user=' . urlencode($filter_user) : '' ?><?= $filter_action ? '&action=' . urlencode($filter_action) : '' ?><?= $filter_date ? '&date=' . urlencode($filter_date) : '' ?>" class="btn-outline">Last ¬ª</a>
        <?php endif; ?>
      </div>
    <?php endif; ?>
  <?php else: ?>
    <p style="background: white; padding: 20px; border-radius: 6px;">No audit entries found.</p>
  <?php endif; ?>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_audit.php ---



--- Start of admin_backups.php ---


<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Backup Management';
$action = $_GET['action'] ?? '';
$backup_id = $_GET['backup'] ?? '';

// Modern admin navbar and dark mode
?>
<nav class="admin-navbar" aria-label="Admin Navigation">
  <div class="admin-navbar-left">
    <a href="admin_dashboard.php" class="admin-navbar-brand">‚öôÔ∏è Admin</a>
    <a href="dashboard.php">User Dashboard</a>
    <a href="admin_users.php">Users</a>
    <a href="admin_backups.php" class="active">Backups</a>
    <a href="admin_reports.php">Reports</a>
    <a href="admin_maintenance.php">Maintenance</a>
  </div>
  <div class="admin-navbar-right">
    <button id="darkModeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
    <a href="logout.php" aria-label="Logout">Logout</a>
  </div>
</nav>
<style>
.admin-navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #0099A8;
  padding: 12px 32px;
  color: white;
  margin-bottom: 30px;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.admin-navbar a {
  color: white;
  text-decoration: none;
  font-weight: 600;
  margin-right: 18px;
  font-size: 15px;
  transition: color 0.2s;
}
.admin-navbar a:last-child { margin-right: 0; }
.admin-navbar a:hover, .admin-navbar a.active { color: #ffe082; }
.admin-navbar-brand {
  font-size: 20px;
  font-weight: bold;
  margin-right: 30px;
}
.admin-navbar-right {
  display: flex;
  align-items: center;
  gap: 18px;
}
#darkModeToggle {
  background: none;
  border: none;
  color: #ffe082;
  font-size: 20px;
  cursor: pointer;
  margin-right: 10px;
  transition: color 0.2s;
}
#darkModeToggle:hover { color: #fff; }
body.dark-mode {
  background: #181c1f !important;
  color: #e0e0e0 !important;
}
body.dark-mode .container, body.dark-mode .section, body.dark-mode .stat-card {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .admin-navbar {
  background: #23272a !important;
  color: #ffe082 !important;
}
body.dark-mode .admin-navbar a { color: #ffe082 !important; }
body.dark-mode .admin-navbar a:hover { color: #fff !important; }
body.dark-mode .stat-card .value { color: #ffe082 !important; }
body.dark-mode .admin-table th, body.dark-mode .admin-table td {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .alert-success { background: #223322 !important; color: #b6fcb6 !important; }
body.dark-mode .alert-danger { background: #331a1a !important; color: #ffb6b6 !important; }
body.dark-mode .alert-warning { background: #332a1a !important; color: #ffe082 !important; }
</style>
<script>
// Dark mode toggle
const darkModeBtn = document.getElementById('darkModeToggle');
if (darkModeBtn) {
  darkModeBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('crmAdminDarkMode', document.body.classList.contains('dark-mode'));
  });
  // On load, check preference
  if (localStorage.getItem('crmAdminDarkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
}
</script>

// ...existing code...

<style>
.backup-table { width: 100%; margin-top: 20px; }
.backup-table th { background: #f5f5f5; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
.backup-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
.backup-table tr:hover { background: #f9f9f9; }
.btn-restore, .btn-download, .btn-delete { padding: 6px 12px; margin: 2px; font-size: 12px; }
.btn-restore { background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; }
.btn-restore:hover { background: #218838; }
.btn-download { background: #0099A8; color: white; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; }
.btn-download:hover { background: #007880; }
.btn-delete { background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; }
.btn-delete:hover { background: #c82333; }
</style>

<div class="container" style="max-width: 1000px;">
  <h2>Backup Management</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <?php if (isset($success)): ?>
    <div class="alert-success">‚úì <?= htmlspecialchars($success) ?></div>
  <?php endif; ?>
  <?php if (isset($error)): ?>
    <div class="alert-danger">‚úó <?= htmlspecialchars($error) ?></div>
  <?php endif; ?>

  <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
    <h3>Available Backups</h3>
    <?php if (!empty($backups)): ?>
      <table class="backup-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>File Size</th>
            <th>Contact Count*</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($backups as $backup): ?>
            <tr>
              <td><?= htmlspecialchars($backup['timestamp']) ?></td>
              <td><?= formatBytes($backup['size']) ?></td>
              <td><?= $backup['contact_count'] ?? 'N/A' ?></td>
              <td style="white-space: nowrap;">
                <form method="POST" style="display:inline;">
                  <?php echo renderCSRFInput(); ?>
                  <input type="hidden" name="restore_backup" value="<?= htmlspecialchars(basename($backup['file'])) ?>">
                  <button type="submit" class="btn-restore" onclick="return confirm('Restore this backup? This will replace current contacts.csv.')">
                    ‚Üª Restore
                  </button>
                </form>
                <a href="<?= htmlspecialchars($backup['file']) ?>" class="btn-download">‚¨á Download</a>
                <form method="POST" style="display:inline;">
                  <?php echo renderCSRFInput(); ?>
                  <input type="hidden" name="delete_backup" value="<?= htmlspecialchars(basename($backup['file'])) ?>">
                  <button type="submit" class="btn-delete" onclick="return confirm('Delete this backup permanently?')">
                    üóë Delete
                  </button>
                </form>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
      <p style="font-size: 12px; color: #666; margin-top: 10px;">
        * Contact count is estimated from file size. Backups are automatically created before any data modification.
      </p>
    <?php else: ?>
      <p>No backups found. Backups are created automatically when contacts are added, updated, or imported.</p>
    <?php endif; ?>
    <hr>
    <h3>Select Pages to Back Up</h3>
    <?php
    $dir = __DIR__;
    $files = scandir($dir);
    $phpPages = array_filter($files, function($file) {
        return (substr($file, -4) === '.php' && $file !== 'admin_backups.php');
    });
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['pages'])) {
      $selected = $_POST['pages'];
      // Save selection for daily backup
      file_put_contents('backups/selected_backup_files.json', json_encode($selected));
      echo '<h4>Selected pages for backup:</h4>';
      echo '<ul>';
      foreach ($selected as $page) {
        echo '<li>' . htmlspecialchars($page) . '</li>';
      }
      echo '</ul>';
      // Manual backup trigger
      $backupDir = 'backups/manual_' . date('Y_m_d_His');
      mkdir($backupDir, 0777, true);
      foreach ($selected as $page) {
        copy($page, $backupDir . '/' . $page);
      }
      // Zip the backup
    }

    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['files'])) {
      $selected = $_POST['files'];
      file_put_contents($config['backup_dir'] . '/selected_backup_files.json', json_encode($selected));
      echo '<h4>Selected files for backup:</h4>';
      echo '<ul>';
      foreach ($selected as $file) {
        echo '<li>' . htmlspecialchars($file) . '</li>';
      }
      echo '</ul>';
      // Manual backup trigger
      $backupDir = $config['backup_dir'] . '/manual_' . date('Y_m_d_His');
      mkdir($backupDir, 0777, true);
      foreach ($selected as $file) {
        copy($file, $backupDir . '/' . $file);
      }
      $zip = new ZipArchive();
      $zipFile = $backupDir . '.zip';
      if ($zip->open($zipFile, ZipArchive::CREATE) === TRUE) {
        foreach ($selected as $file) {
          $zip->addFile($backupDir . '/' . $file, $file);
        }
        $zip->close();
      }
      foreach ($selected as $file) {
        unlink($backupDir . '/' . $file);
      }
      rmdir($backupDir);
      echo '<p>Manual backup complete. <a href="' . htmlspecialchars($zipFile) . '">Download ZIP</a></p>';
    } else {
      $prevSelected = [];
      if (file_exists($config['backup_dir'] . '/selected_backup_files.json')) {
        $prevSelected = json_decode(file_get_contents($config['backup_dir'] . '/selected_backup_files.json'), true);
      }
    ?>
    <!DOCTYPE html>
    <html>
    <head>
      <title>Admin Backup Page Selector</title>
      <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #222; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 32px; }
        h1 { font-size: 2rem; margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-size: 1rem; }
        button { background: #0099A8; color: #fff; border: none; border-radius: 6px; padding: 10px 24px; font-size: 1rem; cursor: pointer; margin-top: 16px; }
        button:hover { background: #007880; }
        .file-list { margin-bottom: 24px; }
        .file-list input[type=checkbox] { margin-right: 8px; }
        .backup-info { margin-top: 32px; font-size: 0.95rem; color: #666; }
      </style>
    </head>
    <body>
    <div class="container">
      <h1>Select Files to Back Up</h1>
      <form method="post">
        <div class="file-list">
        <?php foreach ($allFiles as $file): ?>
          <label>
            <input type="checkbox" name="files[]" value="<?= htmlspecialchars($file) ?>" <?= in_array($file, $prevSelected) ? 'checked' : '' ?>>
            <?= htmlspecialchars($file) ?>
          </label>
        <?php endforeach; ?>
        </div>
        <button type="submit">Back Up Selected Files</button>
      </form>
      <div class="backup-info">
        <strong>2026 Standard:</strong> Modular, configurable, modern UI. <br>
        <strong>Retention:</strong> <?= $config['retention_days'] ?> days, max <?= $config['max_backups'] ?> backups.<br>
        <strong>Backup Directory:</strong> <?= htmlspecialchars($config['backup_dir']) ?><br>
        <strong>File Types:</strong> <?= implode(', ', $config['file_types']) ?><br>
      </div>
    </div>
    </body>
    </html>
    <?php }


--- End of admin_backups.php ---



--- Start of admin_bulk_ops.php ---

<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Bulk Operations';

$action_result = '';
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv');

// Handle bulk delete
if ($_POST && isset($_POST['bulk_delete'])) {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        $action_result = 'CSRF validation failed';
    } else {
        $ids_to_delete = $_POST['delete_ids'] ?? [];
        if (!is_array($ids_to_delete) || empty($ids_to_delete)) {
            $action_result = 'No contacts selected';
        } else {
            $filtered = array_filter($contacts, fn($c) => !in_array($c['id'], $ids_to_delete));
            if (writeCSV('contacts.csv', array_values($filtered), $schema)) {
                $count_deleted = count($ids_to_delete);
                $action_result = "Successfully deleted $count_deleted contact(s)";
                logInfo("Bulk deleted $count_deleted contacts", ['ids' => $ids_to_delete]);
                $contacts = readCSV('contacts.csv');
            } else {
                $action_result = 'Failed to delete contacts';
            }
        }
    }
}

// Handle bulk tag
if ($_POST && isset($_POST['bulk_tag'])) {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        $action_result = 'CSRF validation failed';
    } else {
        $ids_to_tag = $_POST['tag_ids'] ?? [];
        $tag_field = $_POST['tag_field'] ?? '';
        $tag_value = $_POST['tag_value'] ?? '';
        
        if (empty($ids_to_tag) || empty($tag_field)) {
            $action_result = 'Invalid parameters';
        } else {
            $updated_count = 0;
            foreach ($contacts as &$c) {
                if (in_array($c['id'], $ids_to_tag)) {
                    $c[$tag_field] = $tag_value;
                    $updated_count++;
                }
            }
            if (writeCSV('contacts.csv', $contacts, $schema)) {
                $action_result = "Updated $updated_count contact(s)";
                logInfo("Bulk tagged $updated_count contacts", ['field' => $tag_field, 'value' => $tag_value]);
                $contacts = readCSV('contacts.csv');
            } else {
                $action_result = 'Failed to update contacts';
            }
        }
    }
}

?>

<style>
.bulk-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.bulk-section h3 { margin-top: 0; color: #333; border-bottom: 2px solid #0099A8; padding-bottom: 10px; }
.contact-select-table { width: 100%; margin-top: 15px; font-size: 13px; border-collapse: collapse; }
.contact-select-table th { background: #f5f5f5; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
.contact-select-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
.contact-select-table tr:hover { background: #f9f9f9; }
.select-all { margin: 10px 0; }
.bulk-actions { margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 6px; }
.btn-action { padding: 8px 16px; margin: 5px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }
.btn-delete-bulk { background: #dc3545; color: white; }
.btn-delete-bulk:hover { background: #c82333; }
.btn-tag { background: #17a2b8; color: white; }
.btn-tag:hover { background: #138496; }
</style>

<div class="container" style="max-width: 1200px;">
  <h2>Bulk Operations</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <?php if ($action_result): ?>
    <div class="alert-<?= strpos($action_result, 'Failed') !== false ? 'danger' : 'success' ?>">
      <?= htmlspecialchars($action_result) ?>
    </div>
  <?php endif; ?>

  <div class="bulk-section">
    <h3>üìã Bulk Delete Contacts</h3>
    <p>Select contacts to delete. <strong>This action cannot be undone!</strong></p>
    
    <form method="POST">
      <?php echo renderCSRFInput(); ?>
      
      <div class="select-all">
        <label>
          <input type="checkbox" id="select-all-delete" onchange="document.querySelectorAll('input[name=\"delete_ids[]\"]').forEach(el => el.checked = this.checked)">
          <strong>Select All Visible</strong>
        </label>
      </div>

      <table class="contact-select-table">
        <thead>
          <tr>
            <th style="width: 30px;"><input type="checkbox" id="select-all-header"></th>
            <th>Name</th>
            <th>Company</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach (array_slice($contacts, 0, 50) as $contact): ?>
            <tr>
              <td><input type="checkbox" name="delete_ids[]" value="<?= htmlspecialchars($contact['id']) ?>"></td>
              <td><?= htmlspecialchars($contact['first_name'] . ' ' . $contact['last_name']) ?></td>
              <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
              <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
      <?php if (count($contacts) > 50): ?>
        <p style="color: #666; font-size: 12px;">Showing first 50 of <?= count($contacts) ?> contacts</p>
      <?php endif; ?>

      <div class="bulk-actions">
        <button type="submit" name="bulk_delete" class="btn-action btn-delete-bulk" onclick="return confirm('Delete selected contacts? This cannot be undone!')">
          üóë Delete Selected
        </button>
      </div>
    </form>
  </div>

  <div class="bulk-section">
    <h3>üè∑Ô∏è Bulk Update Field</h3>
    <p>Update a specific field for selected contacts.</p>
    
    <form method="POST">
      <?php echo renderCSRFInput(); ?>
      
      <div style="margin-bottom: 15px;">
        <label>Field to Update:</label>
        <select name="tag_field" required>
          <option value="">-- Select Field --</option>
          <?php foreach ($schema as $field): ?>
            <?php if (!in_array($field, ['id', 'created_at'])): ?>
              <option value="<?= htmlspecialchars($field) ?>">
                <?= ucfirst(str_replace('_', ' ', $field)) ?>
              </option>
            <?php endif; ?>
          <?php endforeach; ?>
        </select>
      </div>

      <div style="margin-bottom: 15px;">
        <label>New Value:</label>
        <input type="text" name="tag_value" placeholder="Enter new value" required>
      </div>

      <div class="select-all">
        <label>
          <input type="checkbox" id="select-all-tag" onchange="document.querySelectorAll('input[name=\"tag_ids[]\"]').forEach(el => el.checked = this.checked)">
          <strong>Select All Visible</strong>
        </label>
      </div>

      <table class="contact-select-table">
        <thead>
          <tr>
            <th style="width: 30px;"><input type="checkbox"></th>
            <th>Name</th>
            <th>Company</th>
            <th>Current Value</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach (array_slice($contacts, 0, 50) as $contact): ?>
            <tr>
              <td><input type="checkbox" name="tag_ids[]" value="<?= htmlspecialchars($contact['id']) ?>"></td>
              <td><?= htmlspecialchars($contact['first_name'] . ' ' . $contact['last_name']) ?></td>
              <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
              <td>‚Äî</td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>

      <div class="bulk-actions">
        <button type="submit" name="bulk_tag" class="btn-action btn-tag" onclick="return confirm('Update selected contacts?')">
          ‚úì Update Selected
        </button>
      </div>
    </form>
  </div>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_bulk_ops.php ---



--- Start of admin_dashboard.php ---

<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Admin Dashboard';
$currentPage = 'admin_dashboard.php';

// Get statistics
$stats = getSystemStats();
$recent_activity = getRecentActivity(10);
$active_users = getActiveUsers();
$integrity = checkDataIntegrity();
?>

/* ...existing code... */
  margin-bottom: 5px;
}
.stat-card .subtext {
  font-size: 12px;
  color: #666;
}
.admin-tools {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}
.tool-btn {
  padding: 15px;
  text-align: center;
  background: #0099A8;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-weight: bold;
  transition: background 0.2s;
}
.tool-btn:hover {
  background: #007880;
  text-decoration: none;
  color: white;
}
.alert-warning {
  background: #fff3cd;
  border: 1px solid #ffc107;
  color: #856404;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 20px;
}
.alert-danger {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 20px;
}
.alert-success {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 20px;
}
.section {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.section h3 {
  margin-top: 0;
  color: #333;
  border-bottom: 2px solid #0099A8;
  padding-bottom: 10px;
}
table.admin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
table.admin-table th {
  background: #f5f5f5;
  padding: 10px;
  text-align: left;
  font-weight: bold;
  border-bottom: 2px solid #ddd;
}
table.admin-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #eee;
}
table.admin-table tr:hover {
  background: #f9f9f9;
}
body.dark-mode .admin-grid, body.dark-mode .section, body.dark-mode .stat-card {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .stat-card .value { color: #ffe082 !important; }
body.dark-mode .admin-table th, body.dark-mode .admin-table td {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .alert-success { background: #223322 !important; color: #b6fcb6 !important; }
body.dark-mode .alert-danger { background: #331a1a !important; color: #ffb6b6 !important; }
body.dark-mode .alert-warning { background: #332a1a !important; color: #ffe082 !important; }
</style>

<div class="container" style="max-width: 1200px;" aria-label="Admin Dashboard Main Content">
  <h2>Admin Dashboard</h2>

  <!-- Data Integrity Alert -->

  <div class="main-content" id="mainContent">
    <div class="content-container" aria-label="Admin Dashboard Main Content">
      <?php if (!$integrity['is_valid']): ?>
        <div class="alert-danger">
          <strong>‚ö†Ô∏è Data Integrity Issues Detected:</strong>
          <ul style="margin: 10px 0 0 0; padding-left: 20px;">
            <?php foreach ($integrity['issues'] as $issue): ?>
              <li><?= htmlspecialchars($issue) ?></li>
            <?php endforeach; ?>
          </ul>
          <p style="margin: 10px 0 0 0;"><a href="admin_maintenance.php">Use Maintenance Tool to Fix</a></p>
        </div>
      <?php else: ?>
        <div class="alert-success">
          ‚úì All data integrity checks passed (<?= $stats['total_contacts'] ?> contacts verified)
        </div>
      <?php endif; ?>

  <!-- Key Statistics -->
  <h3>System Overview</h3>
  <div class="admin-grid">
    <div class="stat-card">
      <h4>Total Contacts</h4>
      <div class="value"><?= number_format($stats['total_contacts']) ?></div>
      <div class="subtext">database records</div>
    </div>

    <div class="stat-card">
      <h4>Email Coverage</h4>
      <div class="value"><?= $stats['total_contacts'] > 0 ? round($stats['contacts_with_email'] / $stats['total_contacts'] * 100) : 0 ?>%</div>
      <div class="subtext"><?= number_format($stats['contacts_with_email']) ?> of <?= number_format($stats['total_contacts']) ?></div>
    </div>

    <div class="stat-card">
      <h4>Duplicate Emails</h4>
      <div class="value" style="color: <?= $stats['duplicate_emails'] > 0 ? '#dc3545' : '#28a745' ?>;">
        <?= $stats['duplicate_emails'] ?>
      </div>
      <div class="subtext">needs deduplication</div>
    </div>

    <div class="stat-card">
      <h4>Unique Companies</h4>
      <div class="value"><?= number_format($stats['unique_companies']) ?></div>
      <div class="subtext"><?php 
        $company_coverage = $stats['total_contacts'] > 0 ? round($stats['contacts_with_company'] / $stats['total_contacts'] * 100) : 0;
        echo $company_coverage . '% coverage';
      ?></div>
    </div>

    <div class="stat-card">
      <h4>CSV Database</h4>
      <div class="value"><?= formatBytes($stats['csv_size']) ?></div>
      <div class="subtext">contacts.csv file size</div>
    </div>

    <div class="stat-card">
      <h4>Total Backups</h4>
      <div class="value"><?= $stats['backup_count'] ?></div>
      <div class="subtext"><?= formatBytes($stats['total_backup_size']) ?> total</div>
    </div>

    <div class="stat-card">
      <h4>Audit Log</h4>
      <div class="value"><?= formatBytes($stats['audit_log_size']) ?></div>
      <div class="subtext">activity_log.csv</div>
    </div>

    <div class="stat-card">
      <h4>Error Log</h4>
      <div class="value"><?= formatBytes($stats['error_log_size']) ?></div>
      <div class="subtext">logs/errors.log</div>
    </div>
  </div>

  <!-- Admin Tools -->
  <h3>Admin Tools</h3>
  <div class="admin-tools">
    <a href="admin_users.php" class="tool-btn">üë• User Management</a>
    <a href="admin_backups.php" class="tool-btn">üîÑ Manage Backups</a>
    <a href="admin_audit.php" class="tool-btn">üìä View Audit Log</a>
    <a href="admin_timeline.php" class="tool-btn">üìÖ Contact Timeline</a>
    <a href="admin_deduplicate.php" class="tool-btn">üîó Deduplicate</a>
    <a href="admin_bulk_ops.php" class="tool-btn">üìã Bulk Operations</a>
    <a href="admin_search.php" class="tool-btn">üîç Advanced Search</a>
    <a href="admin_maintenance.php" class="tool-btn">üõ†Ô∏è Maintenance</a>
    <a href="admin_reports.php" class="tool-btn">üìà Reports</a>
  </div>

  <!-- Recent Activity -->
  <div class="section">
    <h3>Recent Activity (Last 10 Actions)</h3>
    <?php if (!empty($recent_activity)): ?>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>User</th>
            <th>Action</th>
            <th>Entity</th>
            <th>Status</th>
            <th>Summary</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($recent_activity as $activity): ?>
            <tr>
              <td><?= htmlspecialchars(substr($activity['timestamp'], 0, 16)) ?></td>
              <td><?= htmlspecialchars($activity['user_id'] ?? 'unknown') ?></td>
              <td><strong><?= htmlspecialchars($activity['action'] ?? 'unknown') ?></strong></td>
              <td><?= htmlspecialchars($activity['entity_type'] ?? 'unknown') ?></td>
              <td>
                <span style="color: <?= $activity['status'] === 'success' ? '#28a745' : '#dc3545' ?>;">
                  <?= htmlspecialchars($activity['status'] ?? 'unknown') ?>
                </span>
              </td>
              <td><?= htmlspecialchars(substr($activity['summary'] ?? '', 0, 40)) ?></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    <?php else: ?>
      <p>No activity recorded yet.</p>
    <?php endif; ?>
  </div>

  <!-- Active Users -->
  <div class="section">
    <h3>Active Users</h3>
    <?php if (!empty($active_users)): ?>
      <table class="admin-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Actions</th>
    </div>
  </div>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($active_users as $user => $count): ?>
            <tr>
              <td><?= htmlspecialchars($user) ?></td>
              <td><?= $count ?></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    <?php else: ?>
      <p>No user activity yet.</p>
    <?php endif; ?>
  </div>

</div>

<script>
// Dark mode toggle
const darkModeBtn = document.getElementById('darkModeToggle');
if (darkModeBtn) {
  darkModeBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('crmAdminDarkMode', document.body.classList.contains('dark-mode'));
  });
  // On load, check preference
  if (localStorage.getItem('crmAdminDarkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
}
</script>
<?php include_once 'layout_end.php'; ?>


--- End of admin_dashboard.php ---



--- Start of admin_deduplicate.php ---

<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Contact Deduplication';

$duplicates_by_email = findDuplicateEmails();
$similar_names = findSimilarNames();

// Handle merge action
$merge_result = '';
if ($_POST && isset($_POST['merge_contacts'])) {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        $merge_result = 'CSRF validation failed';
    } else {
        $contact1_id = $_POST['contact1_id'] ?? '';
        $contact2_id = $_POST['contact2_id'] ?? '';
        
        if (mergeContacts($contact1_id, $contact2_id)) {
            $merge_result = 'Contacts merged successfully';
            logInfo('Contacts merged', ['contact1' => $contact1_id, 'contact2' => $contact2_id]);
            // Reload to refresh lists
            header('Location: admin_deduplicate.php');
            exit;
        } else {
            $merge_result = 'Failed to merge contacts';
        }
    }
}

?>

<style>
.duplicate-group { background: white; padding: 15px; margin-bottom: 15px; border-radius: 6px; border-left: 4px solid #dc3545; }
.duplicate-group h4 { margin: 0 0 10px 0; color: #dc3545; }
.contact-compare { display: grid; grid-template-columns: 1fr 40px 1fr; gap: 10px; align-items: center; margin-bottom: 15px; }
.contact-field { background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 13px; }
.contact-field strong { display: block; color: #0099A8; font-size: 11px; text-transform: uppercase; margin-bottom: 3px; }
.merge-separator { text-align: center; font-weight: bold; color: #dc3545; }
.btn-merge { background: #ffc107; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
.btn-merge:hover { background: #e0a800; }
.similar-group { background: #fff3cd; padding: 15px; margin-bottom: 15px; border-radius: 6px; border-left: 4px solid #ffc107; }
</style>

<div class="container" style="max-width: 1000px;">
  <h2>Contact Deduplication</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <?php if ($merge_result): ?>
    <div class="alert-<?= strpos($merge_result, 'success') !== false ? 'success' : 'danger' ?>">
      <?= htmlspecialchars($merge_result) ?>
    </div>
  <?php endif; ?>

  <!-- Duplicate Emails Section -->
  <div style="margin-bottom: 30px;">
    <h3>üîó Exact Duplicate Emails (<?= count($duplicates_by_email) ?> found)</h3>
    
    <?php if (!empty($duplicates_by_email)): ?>
      <?php foreach ($duplicates_by_email as $email => $contacts): ?>
        <div class="duplicate-group">
          <h4><?= htmlspecialchars($email) ?> ‚Äî <?= count($contacts) ?> contacts</h4>
          
          <?php for ($i = 0; $i < count($contacts); $i++): ?>
            <?php if ($i > 0): ?>
              <div style="margin: 15px 0; padding: 10px 0; border-top: 1px solid #eee;">
            <?php endif; ?>
            
            <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
              <strong>Option <?= $i + 1 ?></strong><br>
              ID: <?= htmlspecialchars($contacts[$i]['id']) ?><br>
              Name: <?= htmlspecialchars($contacts[$i]['first_name'] . ' ' . $contacts[$i]['last_name']) ?><br>
              Company: <?= htmlspecialchars($contacts[$i]['company'] ?? '(none)') ?><br>
              Phone: <?= htmlspecialchars($contacts[$i]['phone'] ?? '(none)') ?><br>
              
              <?php if ($i < count($contacts) - 1): ?>
                <form method="POST" style="margin-top: 10px;">
                  <?php echo renderCSRFInput(); ?>
                  <input type="hidden" name="contact1_id" value="<?= htmlspecialchars($contacts[$i]['id']) ?>">
                  <input type="hidden" name="contact2_id" value="<?= htmlspecialchars($contacts[$i + 1]['id']) ?>">
                  <button type="submit" name="merge_contacts" class="btn-merge" onclick="return confirm('Merge these contacts? Contact 1 will be kept, Contact 2 will be deleted.')">
                    ‚úì Merge with Option <?= $i + 2 ?>
                  </button>
                </form>
              <?php endif; ?>
            </div>
            
            <?php if ($i > 0): ?>
              </div>
            <?php endif; ?>
          <?php endfor; ?>
        </div>
      <?php endforeach; ?>
    <?php else: ?>
      <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
        ‚úì No exact duplicate emails found!
      </div>
    <?php endif; ?>
  </div>

  <!-- Similar Names Section -->
  <div>
    <h3>‚ö†Ô∏è Similar Names (<?= count($similar_names) ?> found)</h3>
    <p style="color: #666; font-size: 14px;">These contacts may be duplicates with slight name variations or typos. Review and merge if needed.</p>
    
    <?php if (!empty($similar_names)): ?>
      <?php foreach ($similar_names as $pair): ?>
        <div class="similar-group">
          <div style="margin-bottom: 15px;">
            <strong>Similarity: <?= $pair['similarity'] ?>%</strong>
            <br>
            
            <div class="contact-compare">
              <div class="contact-field">
                <strong>Contact 1</strong>
                <?= htmlspecialchars($pair['contact1']['first_name'] . ' ' . $pair['contact1']['last_name']) ?><br>
                <?= htmlspecialchars($pair['contact1']['company'] ?? 'N/A') ?>
              </div>
              <div class="merge-separator">VS</div>
              <div class="contact-field">
                <strong>Contact 2</strong>
                <?= htmlspecialchars($pair['contact2']['first_name'] . ' ' . $pair['contact2']['last_name']) ?><br>
                <?= htmlspecialchars($pair['contact2']['company'] ?? 'N/A') ?>
              </div>
            </div>

            <form method="POST" style="display: flex; gap: 10px;">
              <?php echo renderCSRFInput(); ?>
              <input type="hidden" name="contact1_id" value="<?= htmlspecialchars($pair['contact1']['id']) ?>">
              <input type="hidden" name="contact2_id" value="<?= htmlspecialchars($pair['contact2']['id']) ?>">
              <button type="submit" name="merge_contacts" class="btn-merge" onclick="return confirm('Merge these contacts?')">
                ‚úì Merge Contacts
              </button>
            </form>
          </div>
        </div>
      <?php endforeach; ?>
    <?php else: ?>
      <div style="background: #d4edda; padding: 15px; border-radius: 6px;">
        ‚úì No similar names found!
      </div>
    <?php endif; ?>
  </div>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_deduplicate.php ---



--- Start of admin_helper.php ---

<?php
/**
 * Admin Helper Functions - Utilities for admin tools
 */

require_once __DIR__ . '/csv_handler.php';
require_once __DIR__ . '/audit_handler.php';
require_once __DIR__ . '/backup_handler.php';

/**
 * Check if user is admin
 */
function isAdmin() {
    return !empty($_SESSION['user_id']) && ($_SESSION['role'] ?? '') === 'admin';
}

/**
 * Validate admin access, redirect if not authorized
 */
function requireAdmin() {
    if (!isAdmin()) {
        header('Location: index.php?error=access_denied');
        exit;
    }
}

/**
 * Get system statistics
 */
function getSystemStats() {
    $schema = require __DIR__ . '/contact_schema.php';
    $contacts = readCSV('contacts.csv', $schema);
    $stats = [];
    
    $stats['total_contacts'] = count($contacts);
    
    // Email coverage
    $emails = array_filter(array_column($contacts, 'email'));
    $stats['contacts_with_email'] = count($emails);
    
    // Company coverage
    $companies = array_filter(array_column($contacts, 'company'));
    $stats['contacts_with_company'] = count($companies);
    
    // Unique companies
    $stats['unique_companies'] = count(array_unique($companies));
    
    // Provinces
    $provinces = array_filter(array_column($contacts, 'province'));
    $stats['provinces_covered'] = count(array_unique($provinces));
    
    // Duplicates
    $email_counts = array_count_values(array_filter(array_map('strtolower', $emails)));
    $stats['duplicate_emails'] = count(array_filter($email_counts, fn($c) => $c > 1));
    
    // File sizes
    $stats['csv_size'] = filesize('contacts.csv');
    $stats['audit_log_size'] = file_exists('activity_log.csv') ? filesize('activity_log.csv') : 0;
    
    // Backup count
    $backups = listBackups();
    $stats['backup_count'] = count($backups);
    $stats['total_backup_size'] = array_sum(array_map(fn($b) => $b['size'] ?? 0, $backups));
    
    // Error log
    $stats['error_log_size'] = file_exists('logs/errors.log') ? filesize('logs/errors.log') : 0;
    
    return $stats;
}

/**
 * Find duplicate emails
 */
function findDuplicateEmails() {
    $schema = require __DIR__ . '/contact_schema.php';
    $contacts = readCSV('contacts.csv', $schema);
    $duplicates = [];
    $email_map = [];
    
    foreach ($contacts as $contact) {
        $email = strtolower(trim($contact['email'] ?? ''));
        if (!empty($email)) {
            if (!isset($email_map[$email])) {
                $email_map[$email] = [];
            }
            $email_map[$email][] = $contact;
        }
    }
    
    foreach ($email_map as $email => $contacts_list) {
        if (count($contacts_list) > 1) {
            $duplicates[$email] = $contacts_list;
        }
    }
    
    return $duplicates;
}

/**
 * Find similar names (fuzzy matching)
 */
function findSimilarNames() {
    $schema = require __DIR__ . '/contact_schema.php';
    $contacts = readCSV('contacts.csv', $schema);
    $similar = [];
    
    for ($i = 0; $i < count($contacts); $i++) {
        for ($j = $i + 1; $j < count($contacts); $j++) {
            $name1 = strtolower(
                ($contacts[$i]['first_name'] ?? '') . ' ' . 
                ($contacts[$i]['last_name'] ?? '') . ' ' .
                ($contacts[$i]['company'] ?? '')
            );
            $name2 = strtolower(
                ($contacts[$j]['first_name'] ?? '') . ' ' . 
                ($contacts[$j]['last_name'] ?? '') . ' ' .
                ($contacts[$j]['company'] ?? '')
            );
            
            // Simple similarity: if 70%+ of characters match in order
            $distance = levenshtein($name1, $name2);
            $max_len = max(strlen($name1), strlen($name2));
            
            if ($max_len > 0 && ($max_len - $distance) / $max_len >= 0.7) {
                $similar[] = [
                    'contact1' => $contacts[$i],
                    'contact2' => $contacts[$j],
                    'similarity' => round((($max_len - $distance) / $max_len) * 100, 1)
                ];
            }
        }
    }
    
    return $similar;
}

/**
 * Merge contacts (keep first, delete second)
 */
function mergeContacts($contact1_id, $contact2_id, $field_preferences = []) {
    $schema = require __DIR__ . '/contact_schema.php';
    $contacts = readCSV('contacts.csv', $schema);
    
    $contact1 = null;
    $contact2 = null;
    
    foreach ($contacts as $c) {
        if ($c['id'] === $contact1_id) $contact1 = $c;
        if ($c['id'] === $contact2_id) $contact2 = $c;
    }
    
    if (!$contact1 || !$contact2) return false;
    
    // Merge fields (prefer non-empty values)
    foreach ($schema as $field) {
        if (isset($field_preferences[$field])) {
            // Use preference if set
            $contact1[$field] = $field_preferences[$field];
        } elseif (empty($contact1[$field]) && !empty($contact2[$field])) {
            // Fill empty fields from contact2
            $contact1[$field] = $contact2[$field];
        }
    }
    
    // Update contact1 and remove contact2
    $filtered = array_filter($contacts, fn($c) => $c['id'] !== $contact2_id);
    
    // Find and update contact1
    $merged = [];
    foreach ($filtered as $c) {
        if ($c['id'] === $contact1_id) {
            $merged[] = $contact1;
        } else {
            $merged[] = $c;
        }
    }
    
    auditDeleteContact($contact2);
    return writeCSV('contacts.csv', array_values($merged), $schema);
}

/**
 * Get recent activity (from audit log)
 */
function getRecentActivity($limit = 20) {
    if (!file_exists('activity_log.csv')) {
        return [];
    }
    
    $activitySchema = ['id','timestamp','user_id','ip_address','action','entity_type','entity_id','changes','summary','status','error_msg'];
    $entries = readCSV('activity_log.csv', $activitySchema);
    usort($entries, fn($a, $b) => strtotime($b['timestamp']) - strtotime($a['timestamp']));
    return array_slice($entries, 0, $limit);
}

/**
 * Get activity by date
 */
function getActivityByDate($date) {
    if (!file_exists('activity_log.csv')) {
        return [];
    }
    
    $activitySchema = ['id','timestamp','user_id','ip_address','action','entity_type','entity_id','changes','summary','status','error_msg'];
    $entries = readCSV('activity_log.csv', $activitySchema);
    $date_str = date('Y-m-d', strtotime($date));
    
    return array_filter($entries, function($e) use ($date_str) {
        return strpos($e['timestamp'], $date_str) === 0;
    });
}

/**
 * Get activity by user
 */
function getActivityByUser($user_id, $limit = 50) {
    if (!file_exists('activity_log.csv')) {
        return [];
    }
    
    $activitySchema = ['id','timestamp','user_id','ip_address','action','entity_type','entity_id','changes','summary','status','error_msg'];
    $entries = readCSV('activity_log.csv', $activitySchema);
    $filtered = array_filter($entries, fn($e) => $e['user_id'] === $user_id);
    
    usort($filtered, fn($a, $b) => strtotime($b['timestamp']) - strtotime($a['timestamp']));
    return array_slice($filtered, 0, $limit);
}

/**
 * Get unique users from audit log
 */
function getActiveUsers() {
    if (!file_exists('activity_log.csv')) {
        return [];
    }
    
    $activitySchema = ['id','timestamp','user_id','ip_address','action','entity_type','entity_id','changes','summary','status','error_msg'];
    $entries = readCSV('activity_log.csv', $activitySchema);
    $users = array_unique(array_column($entries, 'user_id'));
    
    // Count actions per user
    $user_stats = [];
    foreach ($users as $user) {
        $count = count(array_filter($entries, fn($e) => $e['user_id'] === $user));
        $user_stats[$user] = $count;
    }
    
    arsort($user_stats);
    return $user_stats;
}

/**
 * Generate activity report
 */
function generateActivityReport($start_date, $end_date) {
    $entries = getAuditByDateRange($start_date, $end_date);
    
    $report = [
        'period' => "$start_date to $end_date",
        'total_actions' => count($entries),
        'by_action' => [],
        'by_user' => [],
        'by_entity' => [],
        'successes' => 0,
        'failures' => 0,
    ];
    
    foreach ($entries as $entry) {
        $action = $entry['action'] ?? 'unknown';
        $user = $entry['user_id'] ?? 'unknown';
        $entity = $entry['entity_type'] ?? 'unknown';
        $status = $entry['status'] ?? 'unknown';
        
        $report['by_action'][$action] = ($report['by_action'][$action] ?? 0) + 1;
        $report['by_user'][$user] = ($report['by_user'][$user] ?? 0) + 1;
        $report['by_entity'][$entity] = ($report['by_entity'][$entity] ?? 0) + 1;
        
        if ($status === 'success') $report['successes']++;
        elseif ($status === 'failed') $report['failures']++;
    }
    
    return $report;
}

/**
 * Get contact statistics by category
 */
function getContactStatsByCategory($field) {
    $schema = require __DIR__ . '/contact_schema.php';
    $contacts = readCSV('contacts.csv', $schema);
    $stats = [];
    
    foreach ($contacts as $contact) {
        $value = $contact[$field] ?? '(empty)';
        if (empty($value)) $value = '(empty)';
        $stats[$value] = ($stats[$value] ?? 0) + 1;
    }
    
    arsort($stats);
    return $stats;
}

/**
 * Validate data integrity
 */
function checkDataIntegrity() {
    $issues = [];
    $schema = require __DIR__ . '/contact_schema.php';
    $contacts = readCSV('contacts.csv', $schema);
    
    // Check for missing IDs
    $ids = array_column($contacts, 'id');
    $dup_ids = array_diff_assoc($ids, array_unique($ids));
    if (!empty($dup_ids)) {
        $issues[] = "Duplicate contact IDs found: " . count($dup_ids);
    }
    
    // Check for missing required fields
    foreach ($contacts as $idx => $contact) {
        if (empty($contact['first_name']) && empty($contact['last_name'])) {
            $issues[] = "Contact $idx missing both first and last name";
        }
        if (empty($contact['company'])) {
            $issues[] = "Contact $idx missing company";
        }
    }
    
    // Check CSV structure
    if (!empty($contacts)) {
        $first = array_keys($contacts[0]);
        foreach ($contacts as $idx => $contact) {
            if (array_keys($contact) !== $first) {
                $issues[] = "Contact $idx has inconsistent fields";
            }
        }
    }
    
    return [
        'is_valid' => empty($issues),
        'issues' => $issues,
        'total_contacts' => count($contacts),
    ];
}

?>


--- End of admin_helper.php ---



--- Start of admin_maintenance.php ---


<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'System Maintenance';

$maintenance_result = '';

// Modern admin navbar and dark mode
?>
<nav class="admin-navbar" aria-label="Admin Navigation">
  <div class="admin-navbar-left">
    <a href="admin_dashboard.php" class="admin-navbar-brand">‚öôÔ∏è Admin</a>
    <a href="dashboard.php">User Dashboard</a>
    <a href="admin_users.php">Users</a>
    <a href="admin_backups.php">Backups</a>
    <a href="admin_reports.php">Reports</a>
    <a href="admin_maintenance.php" class="active">Maintenance</a>
  </div>
  <div class="admin-navbar-right">
    <button id="darkModeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
    <a href="logout.php" aria-label="Logout">Logout</a>
  </div>
</nav>
<style>
.admin-navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #0099A8;
  padding: 12px 32px;
  color: white;
  margin-bottom: 30px;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.admin-navbar a {
  color: white;
  text-decoration: none;
  font-weight: 600;
  margin-right: 18px;
  font-size: 15px;
  transition: color 0.2s;
}
.admin-navbar a:last-child { margin-right: 0; }
.admin-navbar a:hover, .admin-navbar a.active { color: #ffe082; }
.admin-navbar-brand {
  font-size: 20px;
  font-weight: bold;
  margin-right: 30px;
}
.admin-navbar-right {
  display: flex;
  align-items: center;
  gap: 18px;
}
#darkModeToggle {
  background: none;
  border: none;
  color: #ffe082;
  font-size: 20px;
  cursor: pointer;
  margin-right: 10px;
  transition: color 0.2s;
}
#darkModeToggle:hover { color: #fff; }
body.dark-mode {
  background: #181c1f !important;
  color: #e0e0e0 !important;
}
body.dark-mode .container, body.dark-mode .section, body.dark-mode .stat-card {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .admin-navbar {
  background: #23272a !important;
  color: #ffe082 !important;
}
body.dark-mode .admin-navbar a { color: #ffe082 !important; }
body.dark-mode .admin-navbar a:hover { color: #fff !important; }
body.dark-mode .stat-card .value { color: #ffe082 !important; }
body.dark-mode .admin-table th, body.dark-mode .admin-table td {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .alert-success { background: #223322 !important; color: #b6fcb6 !important; }
body.dark-mode .alert-danger { background: #331a1a !important; color: #ffb6b6 !important; }
body.dark-mode .alert-warning { background: #332a1a !important; color: #ffe082 !important; }
</style>
<script>
// Dark mode toggle
const darkModeBtn = document.getElementById('darkModeToggle');
if (darkModeBtn) {
  darkModeBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('crmAdminDarkMode', document.body.classList.contains('dark-mode'));
  });
  // On load, check preference
  if (localStorage.getItem('crmAdminDarkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
}
</script>

// ...existing code...

<style>
.maint-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0099A8; }
.maint-section h3 { margin-top: 0; color: #0099A8; }
.maint-form { background: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
.maint-form input, .maint-form select { padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
.maint-btn { background: #0099A8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
.maint-btn:hover { background: #007880; }
.warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
</style>

<div class="container" style="max-width: 900px;">
  <h2>System Maintenance</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <?php if ($maintenance_result): ?>
    <div class="alert-<?= strpos($maintenance_result, 'Failed') !== false ? 'danger' : 'success' ?>">
      <?= htmlspecialchars($maintenance_result) ?>
    </div>
  <?php endif; ?>

  <!-- Data Integrity Check -->
  <div class="maint-section">
    <h3>‚úì Data Integrity Check</h3>
    
    <form method="POST">
      <?php echo renderCSRFInput(); ?>
      <button type="submit" name="check_integrity" class="maint-btn">üîç Run Integrity Check</button>
    </form>

    <div style="background: <?= $integrity['is_valid'] ? '#d4edda' : '#f8d7da' ?>; padding: 15px; border-radius: 6px; border-left: 4px solid <?= $integrity['is_valid'] ? '#28a745' : '#dc3545' ?>;">
      <strong><?= $integrity['is_valid'] ? '‚úì PASS' : '‚úó FAIL' ?></strong>
      <p style="margin: 10px 0 0 0;">Total Contacts: <?= number_format($integrity['total_contacts']) ?></p>
      
      <?php if (!empty($integrity['issues'])): ?>
        <ul style="margin: 10px 0 0 0; padding-left: 20px;">
          <?php foreach ($integrity['issues'] as $issue): ?>
            <li><?= htmlspecialchars($issue) ?></li>
          <?php endforeach; ?>
        </ul>
      <?php endif; ?>
    </div>
  </div>

  <!-- Cleanup Audit Logs -->
  <div class="maint-section">
    <h3>üßπ Cleanup Audit Logs</h3>
    <p>Remove old audit log entries to save space. Only keeps recent entries.</p>
    
    <div class="warning-box">
      Current audit log size: <strong><?= formatBytes($stats['audit_log_size']) ?></strong>
    </div>

    <form method="POST" class="maint-form">
      <?php echo renderCSRFInput(); ?>
      <label>Keep last (entries):</label>
      <input type="number" name="keep_count" value="10000" min="100" max="50000">
      <button type="submit" name="cleanup_audit" class="maint-btn" onclick="return confirm('This will delete old audit entries. Continue?')">
        üßπ Cleanup Audit Logs
      </button>
    </form>
  </div>

  <!-- Cleanup Error Logs -->
  <div class="maint-section">
    <h3>üìã Clear Error Log</h3>
    <p>Clear all error log entries to free up disk space.</p>
    
    <div class="warning-box">
      Current error log size: <strong><?= formatBytes($stats['error_log_size']) ?></strong>
    </div>

    <form method="POST">
      <?php echo renderCSRFInput(); ?>
      <button type="submit" name="cleanup_errors" class="maint-btn" onclick="return confirm('Clear all error log entries? This cannot be undone.')">
        üóë Clear Error Log
      </button>
    </form>
  </div>

  <!-- Backup Management -->
  <div class="maint-section">
    <h3>üíæ Backup Management</h3>
    <p>View and manage system backups.</p>
    
    <div style="background: #f5f5f5; padding: 15px; border-radius: 6px;">
      <strong>Total Backups:</strong> <?= $stats['backup_count'] ?><br>
      <strong>Total Backup Size:</strong> <?= formatBytes($stats['total_backup_size']) ?><br>
      <a href="admin_backups.php" class="maint-btn" style="text-decoration: none; display: inline-block; margin-top: 10px;">
        üîÑ Manage Backups
      </a>
    </div>
  </div>

  <!-- System Statistics -->
  <div class="maint-section">
    <h3>üìä System Statistics</h3>
    
    <table style="width: 100%; font-size: 14px;">
      <tr>
        <td><strong>Total Contacts:</strong></td>
        <td><?= number_format($stats['total_contacts']) ?></td>
      </tr>
      <tr>
        <td><strong>CSV Database Size:</strong></td>
        <td><?= formatBytes($stats['csv_size']) ?></td>
      </tr>
      <tr>
        <td><strong>Email Coverage:</strong></td>
        <td><?= $stats['total_contacts'] > 0 ? round($stats['contacts_with_email'] / $stats['total_contacts'] * 100) : 0 ?>% (<?= number_format($stats['contacts_with_email']) ?>)</td>
      </tr>
      <tr>
        <td><strong>Duplicate Emails:</strong></td>
        <td><?= $stats['duplicate_emails'] ?></td>
      </tr>
      <tr>
        <td><strong>Unique Companies:</strong></td>
        <td><?= number_format($stats['unique_companies']) ?></td>
      </tr>
      <tr>
        <td><strong>Provinces Covered:</strong></td>
        <td><?= $stats['provinces_covered'] ?></td>
      </tr>
      <tr>
        <td><strong>Active Backups:</strong></td>
        <td><?= $stats['backup_count'] ?></td>
      </tr>
    </table>
  </div>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_maintenance.php ---



--- Start of admin_module_config.php ---

<?php
// admin_module_config.php
// 2026 standard admin module config
return [
    'backup_dir' => 'backup',
    'backup_root' => getenv('USERPROFILE') . '/CRM_Backups_Daily',
    'retention_days' => 30,
    'max_backups' => 50,
    'file_types' => ['php', 'csv', 'json', 'txt'], // Extendable
    'ui_theme' => 'modern2026',
];


--- End of admin_module_config.php ---



--- Start of admin_reports.php ---


<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Reports & Analytics';

$report_type = $_GET['type'] ?? '';
$start_date = $_GET['start_date'] ?? date('Y-m-d', strtotime('-30 days'));
$end_date = $_GET['end_date'] ?? date('Y-m-d');

// Modern admin navbar and dark mode
?>
<nav class="admin-navbar" aria-label="Admin Navigation">
  <div class="admin-navbar-left">
    <a href="admin_dashboard.php" class="admin-navbar-brand">‚öôÔ∏è Admin</a>
    <a href="dashboard.php">User Dashboard</a>
    <a href="admin_users.php">Users</a>
    <a href="admin_backups.php">Backups</a>
    <a href="admin_reports.php" class="active">Reports</a>
    <a href="admin_maintenance.php">Maintenance</a>
  </div>
  <div class="admin-navbar-right">
    <button id="darkModeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
    <a href="logout.php" aria-label="Logout">Logout</a>
  </div>
</nav>
<style>
.admin-navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #0099A8;
  padding: 12px 32px;
  color: white;
  margin-bottom: 30px;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.admin-navbar a {
  color: white;
  text-decoration: none;
  font-weight: 600;
  margin-right: 18px;
  font-size: 15px;
  transition: color 0.2s;
}
.admin-navbar a:last-child { margin-right: 0; }
.admin-navbar a:hover, .admin-navbar a.active { color: #ffe082; }
.admin-navbar-brand {
  font-size: 20px;
  font-weight: bold;
  margin-right: 30px;
}
.admin-navbar-right {
  display: flex;
  align-items: center;
  gap: 18px;
}
#darkModeToggle {
  background: none;
  border: none;
  color: #ffe082;
  font-size: 20px;
  cursor: pointer;
  margin-right: 10px;
  transition: color 0.2s;
}
#darkModeToggle:hover { color: #fff; }
body.dark-mode {
  background: #181c1f !important;
  color: #e0e0e0 !important;
}
body.dark-mode .container, body.dark-mode .section, body.dark-mode .stat-card {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .admin-navbar {
  background: #23272a !important;
  color: #ffe082 !important;
}
body.dark-mode .admin-navbar a { color: #ffe082 !important; }
body.dark-mode .admin-navbar a:hover { color: #fff !important; }
body.dark-mode .stat-card .value { color: #ffe082 !important; }
body.dark-mode .admin-table th, body.dark-mode .admin-table td {
  background: #23272a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}
body.dark-mode .alert-success { background: #223322 !important; color: #b6fcb6 !important; }
body.dark-mode .alert-danger { background: #331a1a !important; color: #ffb6b6 !important; }
body.dark-mode .alert-warning { background: #332a1a !important; color: #ffe082 !important; }
</style>
<script>
// Dark mode toggle
const darkModeBtn = document.getElementById('darkModeToggle');
if (darkModeBtn) {
  darkModeBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('crmAdminDarkMode', document.body.classList.contains('dark-mode'));
  });
  // On load, check preference
  if (localStorage.getItem('crmAdminDarkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
}
</script>

// ...existing code...

<style>
.report-selector { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
.report-btn { padding: 12px; text-align: center; background: #0099A8; color: white; text-decoration: none; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
.report-btn:hover { background: #007880; }
.report-btn.active { background: #005f6a; }
.chart-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.chart-container h3 { margin-top: 0; }
.bar-chart { margin: 15px 0; }
.bar-item { display: flex; align-items: center; margin-bottom: 10px; }
.bar-label { min-width: 150px; font-weight: bold; font-size: 13px; }
.bar-bar { flex: 1; height: 25px; background: #0099A8; border-radius: 3px; display: flex; align-items: center; }
.bar-value { margin-left: 10px; font-weight: bold; min-width: 40px; font-size: 13px; }
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
.stat-box { background: #f5f5f5; padding: 15px; border-radius: 6px; border-left: 4px solid #0099A8; }
.stat-box .label { font-size: 12px; color: #666; text-transform: uppercase; }
.stat-box .value { font-size: 28px; font-weight: bold; color: #0099A8; margin: 5px 0; }
</style>

<div class="container" style="max-width: 1200px;">
  <h2>Reports & Analytics</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <!-- Report Type Selector -->
  <div class="report-selector">
    <h3>Select Report Type</h3>
    <div class="report-grid">
      <a href="?type=activity" class="report-btn <?= $report_type === 'activity' ? 'active' : '' ?>">üìä Activity</a>
      <a href="?type=contacts" class="report-btn <?= $report_type === 'contacts' ? 'active' : '' ?>">üë• Contacts</a>
      <a href="?type=users" class="report-btn <?= $report_type === 'users' ? 'active' : '' ?>">üë§ Users</a>
      <a href="?type=errors" class="report-btn <?= $report_type === 'errors' ? 'active' : '' ?>">‚ö†Ô∏è Errors</a>
    </div>

    <!-- Date Range Filter -->
    <form method="GET" style="margin-top: 15px; display: flex; gap: 10px; align-items: flex-end;">
      <input type="hidden" name="type" value="<?= htmlspecialchars($report_type) ?>">
      <div>
        <label>From:</label>
        <input type="date" name="start_date" value="<?= htmlspecialchars($start_date) ?>">
      </div>
      <div>
        <label>To:</label>
        <input type="date" name="end_date" value="<?= htmlspecialchars($end_date) ?>">
      </div>
      <button type="submit" class="report-btn">üìÖ Update</button>
    </form>
  </div>

  <!-- Activity Report -->
  <?php if ($report_type === 'activity'): ?>
    <?php $activity_report = generateActivityReport($start_date, $end_date); ?>
    
    <div class="chart-container">
      <h3>Activity Report (<?= $activity_report['period'] ?>)</h3>
      
      <div class="stat-grid">
        <div class="stat-box">
          <div class="label">Total Actions</div>
          <div class="value"><?= number_format($activity_report['total_actions']) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Successful</div>
          <div class="value" style="color: #28a745;"><?= number_format($activity_report['successes']) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Failed</div>
          <div class="value" style="color: #dc3545;"><?= number_format($activity_report['failures']) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Success Rate</div>
          <div class="value" style="color: #0099A8;">
            <?= $activity_report['total_actions'] > 0 ? round($activity_report['successes'] / $activity_report['total_actions'] * 100, 1) : 0 ?>%
          </div>
        </div>
      </div>

      <h4 style="margin-top: 30px;">Actions Breakdown</h4>
      <div class="bar-chart">
        <?php 
        $max_action = max($activity_report['by_action'] ?? [1]);
        foreach ($activity_report['by_action'] as $action => $count):
        ?>
          <div class="bar-item">
            <div class="bar-label"><?= htmlspecialchars(ucfirst($action)) ?></div>
            <div class="bar-bar" style="width: <?= ($count / $max_action * 100) ?>%;">
              <div class="bar-value"><?= $count ?></div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>

      <h4>Top Users</h4>
      <div class="bar-chart">
        <?php 
        $max_user = max($activity_report['by_user'] ?? [1]);
        $top_users = array_slice($activity_report['by_user'], 0, 5, true);
        foreach ($top_users as $user => $count):
        ?>
          <div class="bar-item">
            <div class="bar-label"><?= htmlspecialchars($user) ?></div>
            <div class="bar-bar" style="width: <?= ($count / $max_user * 100) ?>%;">
              <div class="bar-value"><?= $count ?></div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
  <?php endif; ?>

  <!-- Contacts Report -->
  <?php if ($report_type === 'contacts'): ?>
    <?php $contacts = readCSV('contacts.csv'); ?>
    <?php $company_stats = getContactStatsByCategory('company'); ?>
    <?php $province_stats = getContactStatsByCategory('province'); ?>
    
    <div class="chart-container">
      <h3>Contacts Report</h3>
      
      <div class="stat-grid">
        <div class="stat-box">
          <div class="label">Total Contacts</div>
          <div class="value"><?= number_format(count($contacts)) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">With Email</div>
          <div class="value"><?= count(array_filter(array_column($contacts, 'email'))) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Unique Companies</div>
          <div class="value"><?= count(array_unique(array_filter(array_column($contacts, 'company')))) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Duplicate Emails</div>
          <div class="value" style="color: #dc3545;"><?= count(findDuplicateEmails()) ?></div>
        </div>
      </div>

      <h4 style="margin-top: 30px;">Top Companies</h4>
      <div class="bar-chart">
        <?php 
        $top_companies = array_slice($company_stats, 0, 10, true);
        $max_comp = max($top_companies ?? [1]);
        foreach ($top_companies as $company => $count):
        ?>
          <div class="bar-item">
            <div class="bar-label"><?= htmlspecialchars(substr($company, 0, 30)) ?></div>
            <div class="bar-bar" style="width: <?= ($count / $max_comp * 100) ?>%;">
              <div class="bar-value"><?= $count ?></div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>

      <h4>Top Provinces</h4>
      <div class="bar-chart">
        <?php 
        $top_provinces = array_slice($province_stats, 0, 10, true);
        $max_prov = max($top_provinces ?? [1]);
        foreach ($top_provinces as $province => $count):
        ?>
          <div class="bar-item">
            <div class="bar-label"><?= htmlspecialchars(substr($province, 0, 30)) ?? '(empty)' ?></div>
            <div class="bar-bar" style="width: <?= ($count / $max_prov * 100) ?>%;">
              <div class="bar-value"><?= $count ?></div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
  <?php endif; ?>

  <!-- Users Report -->
  <?php if ($report_type === 'users'): ?>
    <?php $active_users = getActiveUsers(); ?>
    
    <div class="chart-container">
      <h3>Active Users Report</h3>
      
      <div class="stat-grid">
        <div class="stat-box">
          <div class="label">Total Users</div>
          <div class="value"><?= number_format(count($active_users)) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Total Actions</div>
          <div class="value"><?= number_format(array_sum($active_users)) ?></div>
        </div>
      </div>

      <h4 style="margin-top: 30px;">User Activity</h4>
      <div class="bar-chart">
        <?php 
        $max_actions = max($active_users ?? [1]);
        foreach ($active_users as $user => $count):
        ?>
          <div class="bar-item">
            <div class="bar-label"><?= htmlspecialchars(substr($user, 0, 30)) ?></div>
            <div class="bar-bar" style="width: <?= ($count / $max_actions * 100) ?>%;">
              <div class="bar-value"><?= $count ?></div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
  <?php endif; ?>

  <!-- Errors Report -->
  <?php if ($report_type === 'errors'): ?>
    <?php 
    $error_log_file = 'logs/errors.log';
    $errors = [];
    if (file_exists($error_log_file)) {
      $lines = file($error_log_file, FILE_SKIP_EMPTY_LINES);
      $errors = array_slice($lines, -50);  // Last 50 errors
    }
    ?>
    
    <div class="chart-container">
      <h3>Recent Errors</h3>
      
      <div class="stat-grid">
        <div class="stat-box">
          <div class="label">Error Log Size</div>
          <div class="value"><?= formatBytes(filesize($error_log_file) ?? 0) ?></div>
        </div>
        <div class="stat-box">
          <div class="label">Recent Entries</div>
          <div class="value"><?= count($errors) ?></div>
        </div>
      </div>

      <h4 style="margin-top: 30px;">Last 20 Errors</h4>
      <?php if (!empty($errors)): ?>
        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
          <tbody>
            <?php foreach (array_slice($errors, -20) as $error): ?>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px;"><?= htmlspecialchars(substr($error, 0, 100)) ?></td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      <?php else: ?>
        <p>No errors logged.</p>
      <?php endif; ?>
    </div>
  <?php endif; ?>

  <!-- No Report Selected -->
  <?php if (empty($report_type)): ?>
    <div style="background: white; padding: 30px; border-radius: 8px; text-align: center;">
      <p style="font-size: 16px; color: #666;">Select a report type above to view analytics and insights.</p>
    </div>
  <?php endif; ?>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_reports.php ---



--- Start of admin_search.php ---

<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Advanced Search';

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv');
$results = [];

// Handle search
if ($_POST && isset($_POST['search'])) {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        $error = 'CSRF validation failed';
    } else {
        $search_mode = $_POST['search_mode'] ?? 'any';
        $results = $contacts;

        // Field-specific searches
        foreach ($schema as $field) {
            $value = $_POST[$field] ?? '';
            if (!empty($value)) {
                $results = array_filter($results, function($c) use ($field, $value, $search_mode) {
                    if ($search_mode === 'exact') {
                        return strtolower($c[$field] ?? '') === strtolower($value);
                    } else {
                        return stripos($c[$field] ?? '', $value) !== false;
                    }
                });
            }
        }

        $results = array_values($results);
    }
}

?>

<style>
.search-form { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.search-form h3 { margin-top: 0; }
.search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
.search-grid input, .search-grid select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
.search-options { margin-bottom: 15px; }
.search-options label { margin-right: 20px; }
.results-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 15px; }
.results-table th { background: #f5f5f5; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; font-weight: bold; }
.results-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
.results-table tr:hover { background: #f9f9f9; }
</style>

<div class="container" style="max-width: 1000px;">
  <h2>Advanced Search</h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a></p>

  <div class="search-form">
    <h3>Search Criteria</h3>
    <form method="POST">
      <?php echo renderCSRFInput(); ?>

      <div class="search-options">
        <label>
          <input type="radio" name="search_mode" value="any" checked> Partial Match
        </label>
        <label>
          <input type="radio" name="search_mode" value="exact"> Exact Match
        </label>
      </div>

      <div class="search-grid">
        <?php foreach ($schema as $field): ?>
          <?php if (!in_array($field, ['id', 'created_at'])): ?>
            <div>
              <label><?= ucfirst(str_replace('_', ' ', $field)) ?>:</label>
              <input type="text" name="<?= $field ?>" placeholder="Search...">
            </div>
          <?php endif; ?>
        <?php endforeach; ?>
      </div>

      <button type="submit" name="search">üîç Search</button>
      <button type="reset" onclick="location.href='admin_search.php'" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Reset</button>
    </form>
  </div>

  <?php if (isset($_POST['search'])): ?>
    <div style="background: white; padding: 20px; border-radius: 8px;">
      <h3>Results (<?= count($results) ?> found)</h3>

      <?php if (!empty($results)): ?>
        <table class="results-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Company</th>
              <th>Email</th>
              <th>Phone</th>
              <th>City</th>
              <th>Province</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($results as $contact): ?>
              <tr>
                <td>
                  <a href="contact_view.php?id=<?= urlencode($contact['id']) ?>" title="View contact">
                    <?= htmlspecialchars($contact['first_name'] . ' ' . $contact['last_name']) ?>
                  </a>
                </td>
                <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
                <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
                <td><?= htmlspecialchars($contact['phone'] ?? '') ?></td>
                <td><?= htmlspecialchars($contact['city'] ?? '') ?></td>
                <td><?= htmlspecialchars($contact['province'] ?? '') ?></td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      <?php else: ?>
        <p>No contacts found matching your search criteria.</p>
      <?php endif; ?>
    </div>
  <?php endif; ?>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_search.php ---



--- Start of admin_timeline.php ---

<?php
require_once 'layout_start.php';
require_once 'admin_helper.php';
requireAdmin();

$pageTitle = 'Contact Timeline';

$contact_id = $_GET['id'] ?? '';
$contacts = readCSV('contacts.csv');
$contact = null;

foreach ($contacts as $c) {
    if ($c['id'] === $contact_id) {
        $contact = $c;
        break;
    }
}

if (!$contact) {
    echo '<div class="container"><p style="color: red;">Contact not found.</p></div>';
    include_once 'layout_end.php';
    exit;
}

$trail = getAuditTrail($contact_id);

?>

<style>
.timeline { margin: 30px 0; }
.timeline-item { margin-left: 50px; margin-bottom: 30px; position: relative; }
.timeline-dot { width: 20px; height: 20px; background: #0099A8; border-radius: 50%; position: absolute; left: -40px; top: 5px; }
.timeline-content { background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #0099A8; }
.timeline-content h4 { margin: 0 0 8px 0; color: #0099A8; }
.timeline-content .action { font-weight: bold; font-size: 14px; }
.timeline-content .meta { font-size: 12px; color: #666; margin: 5px 0; }
.timeline-content .changes { font-size: 12px; background: #f5f5f5; padding: 8px; margin-top: 8px; border-radius: 3px; }
.timeline-content .change-item { margin: 4px 0; }
.change-added { color: #28a745; }
.change-removed { color: #dc3545; }
.change-modified { color: #0099A8; }
</style>

<div class="container" style="max-width: 900px;">
  <h2>Contact Timeline: <?= htmlspecialchars($contact['first_name'] . ' ' . $contact['last_name']) ?></h2>
  <p><a href="admin_dashboard.php">‚Üê Back to Dashboard</a> | <a href="contact_view.php?id=<?= urlencode($contact_id) ?>">View Contact ‚Üí</a></p>

  <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
    <h3>Contact Details</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 13px;">
      <div><strong>ID:</strong> <?= htmlspecialchars($contact['id']) ?></div>
      <div><strong>Name:</strong> <?= htmlspecialchars($contact['first_name'] . ' ' . $contact['last_name']) ?></div>
      <div><strong>Company:</strong> <?= htmlspecialchars($contact['company'] ?? 'N/A') ?></div>
      <div><strong>Email:</strong> <?= htmlspecialchars($contact['email'] ?? 'N/A') ?></div>
      <div><strong>Created:</strong> <?= htmlspecialchars($contact['created_at'] ?? 'Unknown') ?></div>
    </div>
  </div>

  <h3>Modification History</h3>
  <?php if (!empty($trail)): ?>
    <div class="timeline">
      <?php foreach ($trail as $event): ?>
        <?php 
        $changes = is_array($event['changes']) ? $event['changes'] : json_decode($event['changes'] ?? '{}', true);
        $status_color = ($event['status'] ?? 'unknown') === 'success' ? '#28a745' : '#dc3545';
        ?>
        <div class="timeline-item">
          <div class="timeline-dot" style="background-color: <?= $status_color ?>;"></div>
          <div class="timeline-content">
            <h4>
              <span class="action"><?= htmlspecialchars(strtoupper($event['action'] ?? 'unknown')) ?></span>
              <span style="color: <?= $status_color ?>; margin-left: 10px;">
                <?= htmlspecialchars($event['status'] ?? 'unknown') ?>
              </span>
            </h4>
            
            <div class="meta">
              <strong>When:</strong> <?= htmlspecialchars($event['timestamp'] ?? 'unknown') ?><br>
              <strong>Who:</strong> <?= htmlspecialchars($event['user_id'] ?? 'system') ?><br>
              <strong>From:</strong> <?= htmlspecialchars($event['ip_address'] ?? 'unknown') ?>
            </div>

            <div style="color: #666; margin: 8px 0;">
              <?= htmlspecialchars($event['summary'] ?? '') ?>
            </div>

            <?php if (!empty($changes)): ?>
              <div class="changes">
                <strong>Changes:</strong>
                <?php foreach ($changes as $field => $change): ?>
                  <div class="change-item">
                    <?php if ($change['old'] === null && $change['new'] !== null): ?>
                      <span class="change-added">‚úì Added:</span> 
                      <strong><?= htmlspecialchars($field) ?></strong> = "<?= htmlspecialchars(substr($change['new'], 0, 50)) ?>"
                    <?php elseif ($change['old'] !== null && $change['new'] === null): ?>
                      <span class="change-removed">‚úó Removed:</span> 
                      <strong><?= htmlspecialchars($field) ?></strong>
                    <?php else: ?>
                      <span class="change-modified">~ Changed:</span> 
                      <strong><?= htmlspecialchars($field) ?></strong><br>
                      From: "<?= htmlspecialchars(substr($change['old'], 0, 40)) ?>"<br>
                      To: "<?= htmlspecialchars(substr($change['new'], 0, 40)) ?>"
                    <?php endif; ?>
                  </div>
                <?php endforeach; ?>
              </div>
            <?php endif; ?>
          </div>
        </div>
      <?php endforeach; ?>
    </div>
  <?php else: ?>
    <p style="background: white; padding: 20px; border-radius: 6px;">No modification history found for this contact.</p>
  <?php endif; ?>

</div>

<?php include_once 'layout_end.php'; ?>


--- End of admin_timeline.php ---



--- Start of admin_users.php ---

<?php
/**
 * Admin User Management
 * 
 * Manage user accounts, roles, and permissions
 */

require_once 'admin_helper.php';
require_once 'simple_auth/CsvDataStore.php';
require_once 'simple_auth/config.php';
require_once 'audit_handler.php';
requireAdmin();

$config = require 'simple_auth/config.php';
$store = new CsvDataStore($config);

$success = '';
$error = '';
$action = $_GET['action'] ?? '';

// Modern admin navbar and dark mode
?>
<nav class="admin-navbar" aria-label="Admin Navigation">
    <div class="admin-navbar-left">
        <a href="admin_dashboard.php" class="admin-navbar-brand">‚öôÔ∏è Admin</a>
        <a href="dashboard.php">User Dashboard</a>
        <a href="admin_users.php" class="active">Users</a>
        <a href="admin_backups.php">Backups</a>
        <a href="admin_reports.php">Reports</a>
        <a href="admin_maintenance.php">Maintenance</a>
    </div>
    <div class="admin-navbar-right">
        <button id="darkModeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
        <a href="logout.php" aria-label="Logout">Logout</a>
    </div>
</nav>
<style>
.admin-navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0099A8;
    padding: 12px 32px;
    color: white;
    margin-bottom: 30px;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.admin-navbar a {
    color: white;
    text-decoration: none;
    font-weight: 600;
    margin-right: 18px;
    font-size: 15px;
    transition: color 0.2s;
}
.admin-navbar a:last-child { margin-right: 0; }
.admin-navbar a:hover, .admin-navbar a.active { color: #ffe082; }
.admin-navbar-brand {
    font-size: 20px;
    font-weight: bold;
    margin-right: 30px;
}
.admin-navbar-right {
    display: flex;
    align-items: center;
    gap: 18px;
}
#darkModeToggle {
    background: none;
    border: none;
    color: #ffe082;
    font-size: 20px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#darkModeToggle:hover { color: #fff; }
body.dark-mode {
    background: #181c1f !important;
    color: #e0e0e0 !important;
}
body.dark-mode .container, body.dark-mode .section, body.dark-mode .stat-card {
    background: #23272a !important;
    color: #e0e0e0 !important;
    border-color: #333 !important;
}
body.dark-mode .admin-navbar {
    background: #23272a !important;
    color: #ffe082 !important;
}
body.dark-mode .admin-navbar a { color: #ffe082 !important; }
body.dark-mode .admin-navbar a:hover { color: #fff !important; }
body.dark-mode .stat-card .value { color: #ffe082 !important; }
body.dark-mode .admin-table th, body.dark-mode .admin-table td {
    background: #23272a !important;
    color: #e0e0e0 !important;
    border-color: #333 !important;
}
body.dark-mode .alert-success { background: #223322 !important; color: #b6fcb6 !important; }
body.dark-mode .alert-danger { background: #331a1a !important; color: #ffb6b6 !important; }
body.dark-mode .alert-warning { background: #332a1a !important; color: #ffe082 !important; }
</style>
<script>
// Dark mode toggle
const darkModeBtn = document.getElementById('darkModeToggle');
if (darkModeBtn) {
    darkModeBtn.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('crmAdminDarkMode', document.body.classList.contains('dark-mode'));
    });
    // On load, check preference
    if (localStorage.getItem('crmAdminDarkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
}
</script>

// ...existing code...
                    if ($userId === $_SESSION['user_id']) {
                        $error = 'Cannot deactivate your own account';
                    } else {
                        $newStatus = $user['is_active'] === '1' ? '0' : '1';
                        $store->update('users', ['id' => $userId], ['is_active' => $newStatus]);
                        logAudit($_SESSION['user_id'], 'user_status_changed', [
                            'target_user_id' => $userId,
                            'target_username' => $user['username'],
                            'new_status' => $newStatus === '1' ? 'active' : 'inactive'
                        ]);
                        $success = $newStatus === '1' 
                            ? "{$user['username']} activated" 
                            : "{$user['username']} deactivated";
                    }
                } else {
                    $error = 'User not found';
                }
                break;
                
            case 'reset_password':
                $user = $store->fetchOne('users', ['id' => $userId]);
                if ($user) {
                    $resetToken = bin2hex(random_bytes(32));
                    $expires = date('Y-m-d H:i:s', strtotime('+1 hour'));
                    $store->update('users', ['id' => $userId], [
                        'reset_token' => $resetToken,
                        'reset_token_expires' => $expires
                    ]);
                    logAudit($_SESSION['user_id'], 'password_reset_initiated', [
                        'target_user_id' => $userId,
                        'target_username' => $user['username']
                    ]);
                    $success = "Password reset token generated for {$user['username']}. Token: $resetToken (expires in 1 hour)";
                } else {
                    $error = 'User not found';
                }
                break;
                
            case 'unlock_account':
                $user = $store->fetchOne('users', ['id' => $userId]);
                if ($user) {
                    $store->update('users', ['id' => $userId], [
                        'failed_login_attempts' => '0',
                        'locked_until' => ''
                    ]);
                    logAudit($_SESSION['user_id'], 'account_unlocked', [
                        'target_user_id' => $userId,
                        'target_username' => $user['username']
                    ]);
                    $success = "Account unlocked for {$user['username']}";
                } else {
                    $error = 'User not found';
                }
                break;
        }
    }
}

// Load all users
$users = $store->fetchAll('users', []);

// Sort by created_at descending
usort($users, function($a, $b) {
    return strtotime($b['created_at'] ?? '0') - strtotime($a['created_at'] ?? '0');
});

// Calculate statistics
$totalUsers = count($users);
$adminCount = count(array_filter($users, fn($u) => ($u['role'] ?? 'user') === 'admin'));
$activeCount = count(array_filter($users, fn($u) => ($u['is_active'] ?? '1') === '1'));
$lockedCount = count(array_filter($users, fn($u) => !empty($u['locked_until']) && strtotime($u['locked_until']) > time()));

require_once 'layout_start.php';
?>

<style>
.users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.users-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #4CAF50;
}

.stat-card h3 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #666;
    font-weight: normal;
}

.stat-card .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
}

.users-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.users-table table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th {
    background: #f8f9fa;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.users-table td {
    padding: 15px;
    border-bottom: 1px solid #eee;
}

.user-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.badge-admin {
    background: #4CAF50;
    color: white;
}

.badge-user {
    background: #2196F3;
    color: white;
}

.badge-active {
    background: #4CAF50;
    color: white;
}

.badge-inactive {
    background: #999;
    color: white;
}

.badge-locked {
    background: #f44336;
    color: white;
}

.user-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: #4CAF50;
    color: white;
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-info {
    background: #2196F3;
    color: white;
}

.btn-small:hover {
    opacity: 0.8;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    border-left: 4px solid #4CAF50;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    border-left: 4px solid #f44336;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
}

.modal-content {
    background: white;
    margin: 100px auto;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}
</style>

<div class="users-header">
    <h1>User Management</h1>
</div>

<?php if ($success): ?>
    <div class="alert-success"><?= htmlspecialchars($success) ?></div>
<?php endif; ?>

<?php if ($error): ?>
    <div class="alert-error"><?= htmlspecialchars($error) ?></div>
<?php endif; ?>

<div class="users-stats">
    <div class="stat-card">
        <h3>Total Users</h3>
        <div class="stat-value"><?= $totalUsers ?></div>
    </div>
    <div class="stat-card">
        <h3>Administrators</h3>
        <div class="stat-value"><?= $adminCount ?></div>
    </div>
    <div class="stat-card">
        <h3>Active Users</h3>
        <div class="stat-value"><?= $activeCount ?></div>
    </div>
    <div class="stat-card">
        <h3>Locked Accounts</h3>
        <div class="stat-value"><?= $lockedCount ?></div>
    </div>
</div>

<div class="users-table">
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Registered</th>
                <th>Last Login</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($users as $user): 
                $role = $user['role'] ?? 'user';
                $isActive = ($user['is_active'] ?? '1') === '1';
                $isLocked = !empty($user['locked_until']) && strtotime($user['locked_until']) > time();
                $isSelf = $user['id'] === $_SESSION['user_id'];
            ?>
                <tr>
                    <td>
                        <strong><?= htmlspecialchars($user['username']) ?></strong>
                        <?php if ($isSelf): ?><em>(You)</em><?php endif; ?>
                    </td>
                    <td><?= htmlspecialchars($user['email']) ?></td>
                    <td>
                        <span class="user-badge badge-<?= $role ?>">
                            <?= ucfirst($role) ?>
                        </span>
                    </td>
                    <td>
                        <?php if ($isLocked): ?>
                            <span class="user-badge badge-locked">Locked</span>
                        <?php elseif ($isActive): ?>
                            <span class="user-badge badge-active">Active</span>
                        <?php else: ?>
                            <span class="user-badge badge-inactive">Inactive</span>
                        <?php endif; ?>
                    </td>
                    <td><?= !empty($user['created_at']) ? date('M j, Y', strtotime($user['created_at'])) : 'N/A' ?></td>
                    <td><?= !empty($user['last_login']) ? date('M j, Y', strtotime($user['last_login'])) : 'Never' ?></td>
                    <td>
                        <div class="user-actions">
                            <?php if (!$isSelf): ?>
                                <button class="btn-small btn-primary" onclick="changeRole('<?= $user['id'] ?>', '<?= $user['username'] ?>', '<?= $role ?>')">
                                    Change Role
                                </button>
                                <button class="btn-small btn-warning" onclick="toggleActive('<?= $user['id'] ?>', '<?= $user['username'] ?>', <?= $isActive ? 'true' : 'false' ?>)">
                                    <?= $isActive ? 'Deactivate' : 'Activate' ?>
                                </button>
                            <?php endif; ?>
                            
                            <?php if ($isLocked && !$isSelf): ?>
                                <button class="btn-small btn-info" onclick="unlockAccount('<?= $user['id'] ?>', '<?= $user['username'] ?>')">
                                    Unlock
                                </button>
                            <?php endif; ?>
                            
                            <button class="btn-small btn-danger" onclick="resetPassword('<?= $user['id'] ?>', '<?= $user['username'] ?>')">
                                Reset Password
                            </button>
                        </div>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>

<!-- Change Role Modal -->
<div id="roleModal" class="modal">
    <div class="modal-content">
        <h2>Change User Role</h2>
        <p>Change role for <strong id="roleUsername"></strong>:</p>
        <form method="POST" id="roleForm">
            <input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">
            <input type="hidden" name="action" value="change_role">
            <input type="hidden" name="user_id" id="roleUserId">
            
            <select name="role" class="form-control" style="width: 100%; padding: 10px; margin: 15px 0;">
                <option value="user">User</option>
                <option value="admin">Administrator</option>
            </select>
            
            <div class="modal-buttons">
                <button type="button" class="btn-small btn-warning" onclick="closeModal('roleModal')">Cancel</button>
                <button type="submit" class="btn-small btn-primary">Update Role</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Action Form (hidden) -->
<form method="POST" id="actionForm" style="display: none;">
    <input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">
    <input type="hidden" name="action" id="actionType">
    <input type="hidden" name="user_id" id="actionUserId">
</form>

<script>
function changeRole(userId, username, currentRole) {
    document.getElementById('roleUserId').value = userId;
    document.getElementById('roleUsername').textContent = username;
    document.querySelector('[name="role"]').value = currentRole;
    document.getElementById('roleModal').style.display = 'block';
}

function toggleActive(userId, username, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    if (confirm(`Are you sure you want to ${action} ${username}?`)) {
        document.getElementById('actionType').value = 'toggle_active';
        document.getElementById('actionUserId').value = userId;
        document.getElementById('actionForm').submit();
    }
}

function unlockAccount(userId, username) {
    if (confirm(`Unlock account for ${username}?`)) {
        document.getElementById('actionType').value = 'unlock_account';
        document.getElementById('actionUserId').value = userId;
        document.getElementById('actionForm').submit();
    }
}

function resetPassword(userId, username) {
    if (confirm(`Generate password reset token for ${username}?\n\nThis will allow them to reset their password.`)) {
        document.getElementById('actionType').value = 'reset_password';
        document.getElementById('actionUserId').value = userId;
        document.getElementById('actionForm').submit();
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>

<?php require_once 'layout_end.php'; ?>


--- End of admin_users.php ---



--- Start of archive_task.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$idToArchive = $_POST['id'] ?? '';
if (!$idToArchive) {
    echo 'error';
    exit;
}

$filename = 'tasks.csv';
$rows = [];
$found = false;

if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle); // Read and store header
    $rows[] = $headers;

    while (($data = fgetcsv($handle)) !== false) {
        if ($data[0] === $idToArchive) {
            $data[2] = 'archived'; // Update status
            $found = true;
        }
        $rows[] = $data;
    }
    fclose($handle);
}

// Rewrite the CSV only if the task was found
if ($found && ($handle = fopen($filename, 'w')) !== false) {
    foreach ($rows as $row) {
        fputcsv($handle, $row);
    }
    fclose($handle);
    echo 'success';
} else {
    echo 'error';
}
?>


--- End of archive_task.php ---



--- Start of audit_handler.php ---

<?php
/**
 * Audit Logging System - Tracks all contact modifications for compliance
 * 
 * Features:
 * - Logs create, update, delete actions
 * - Records user, timestamp, and old/new values
 * - Stores in activity_log.csv
 * - Provides audit trail queries
 */

require_once __DIR__ . '/csv_handler.php';
require_once __DIR__ . '/backup_handler.php';

define('AUDIT_LOG_FILE', 'activity_log.csv');
define('AUDIT_BACKUP_DIR', 'backups/audit/');

// Ensure audit backup directory exists
if (!is_dir(AUDIT_BACKUP_DIR)) {
    @mkdir(AUDIT_BACKUP_DIR, 0755, true);
}

/**
 * Audit log entry schema
 */
function getAuditSchema() {
    return [
        'id',           // Unique log entry ID
        'timestamp',    // YYYY-MM-DD HH:MM:SS
        'user_id',      // User who made the change
        'ip_address',   // IP address of requester
        'action',       // create, update, delete, import, export
        'entity_type',  // contact, task, opportunity, etc.
        'entity_id',    // ID of affected entity (contact ID)
        'changes',      // JSON: {field: {old: value, new: value}}
        'summary',      // Human readable summary
        'status',       // success, failed
        'error_msg',    // If status=failed, the error
    ];
}

/**
 * Log a contact creation
 */
function auditCreateContact($contact, $status = 'success', $error_msg = null) {
    $changes = [];
    foreach ($contact as $field => $value) {
        if ($field !== 'id' && !empty($value)) {
            $changes[$field] = [
                'old' => null,
                'new' => $value
            ];
        }
    }
    
    return logAuditAction('create', 'contact', $contact['id'] ?? null, $changes, 
                         'Created new contact', $status, $error_msg);
}

/**
 * Log a contact update
 */
function auditUpdateContact($contact_id, $old_contact, $new_contact, $status = 'success', $error_msg = null) {
    $changes = [];
    $changed_fields = [];
    
    foreach ($new_contact as $field => $new_value) {
        $old_value = $old_contact[$field] ?? null;
        
        if ($old_value !== $new_value) {
            $changes[$field] = [
                'old' => $old_value,
                'new' => $new_value
            ];
            $changed_fields[] = $field;
        }
    }
    
    $summary = !empty($changed_fields) 
        ? 'Updated contact: ' . implode(', ', $changed_fields)
        : 'No changes detected';
    
    return logAuditAction('update', 'contact', $contact_id, $changes, $summary, $status, $error_msg);
}

/**
 * Log a contact deletion
 */
function auditDeleteContact($contact) {
    $changes = [];
    foreach ($contact as $field => $value) {
        if ($field !== 'id' && !empty($value)) {
            $changes[$field] = [
                'old' => $value,
                'new' => null
            ];
        }
    }
    
    $summary = 'Deleted contact: ' . ($contact['company'] ?? 'Unknown') . 
               ' (' . ($contact['email'] ?? '') . ')';
    
    return logAuditAction('delete', 'contact', $contact['id'], $changes, $summary, 'success', null);
}

/**
 * Log bulk import
 */
function auditImport($contact_count, $status = 'success', $error_msg = null) {
    $changes = [
        'import_count' => [
            'old' => 0,
            'new' => $contact_count
        ]
    ];
    
    return logAuditAction('import', 'contact', 'bulk', $changes, 
                         "Bulk imported $contact_count contacts", $status, $error_msg);
}

/**
 * Log export action
 */
function auditExport($contact_count, $filters = []) {
    $changes = [
        'export_count' => [
            'old' => 0,
            'new' => $contact_count
        ],
        'filters' => [
            'old' => null,
            'new' => json_encode($filters)
        ]
    ];
    
    return logAuditAction('export', 'contact', 'bulk', $changes, 
                         "Exported $contact_count contacts", 'success', null);
}

/**
 * Core audit logging function
 */
function logAuditAction($action, $entity_type, $entity_id, $changes, $summary, $status = 'success', $error_msg = null) {
    try {
        $log_entry = [
            'id' => uniqid('audit_'),
            'timestamp' => date('Y-m-d H:i:s'),
            'user_id' => $_SESSION['user_id'] ?? 'system',
            'ip_address' => $_SERVER['REMOTE_ADDR'] ?? 'unknown',
            'action' => $action,
            'entity_type' => $entity_type,
            'entity_id' => $entity_id,
            'changes' => json_encode($changes),
            'summary' => $summary,
            'status' => $status,
            'error_msg' => $error_msg ?? '',
        ];
        
        // Ensure audit log file exists
        if (!file_exists(AUDIT_LOG_FILE)) {
            $handle = fopen(AUDIT_LOG_FILE, 'wb');
            if ($handle) {
                // Write header
                $schema = getAuditSchema();
                fputcsv($handle, $schema);
                fclose($handle);
            }
        }
        
        // Append log entry
        $handle = fopen(AUDIT_LOG_FILE, 'ab');
        if ($handle) {
            flock($handle, LOCK_EX);
            $row = array_values($log_entry);
            fputcsv($handle, $row);
            flock($handle, LOCK_UN);
            fclose($handle);
            
            // Log cleanup (keep recent 10000 entries)
            cleanOldAuditLogs();
            
            return true;
        }
        
        return false;
    } catch (Exception $e) {
        error_log("Audit logging failed: " . $e->getMessage());
        return false;
    }
}

/**
 * Get audit log entries for a contact
 */
function getAuditTrail($contact_id, $limit = 50) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE);
    $trail = [];
    
    foreach ($entries as $entry) {
        if (($entry['entity_id'] ?? '') === $contact_id) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $trail[] = $entry;
        }
    }
    
    // Return most recent entries first
    usort($trail, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return array_slice($trail, 0, $limit);
}

/**
 * Get audit logs for a user
 */
function getAuditByUser($user_id, $limit = 100) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE, getAuditSchema());
    $user_logs = [];
    
    foreach ($entries as $entry) {
        if (($entry['user_id'] ?? '') === $user_id) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $user_logs[] = $entry;
        }
    }
    
    usort($user_logs, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return array_slice($user_logs, 0, $limit);
}

/**
 * Get audit logs within date range
 */
function getAuditByDateRange($start_date, $end_date) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE, getAuditSchema());
    $filtered = [];
    
    $start_ts = strtotime($start_date . ' 00:00:00');
    $end_ts = strtotime($end_date . ' 23:59:59');
    
    foreach ($entries as $entry) {
        $entry_ts = strtotime($entry['timestamp'] ?? '');
        if ($entry_ts >= $start_ts && $entry_ts <= $end_ts) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $filtered[] = $entry;
        }
    }
    
    usort($filtered, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return $filtered;
}

/**
 * Search audit logs
 */
function searchAuditLogs($query, $limit = 100) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE, getAuditSchema());
    $query_lower = strtolower($query);
    $results = [];
    
    foreach ($entries as $entry) {
        $searchable = strtolower(
            $entry['summary'] . ' ' . 
            $entry['entity_id'] . ' ' . 
            $entry['user_id'] . ' ' . 
            $entry['action']
        );
        
        if (strpos($searchable, $query_lower) !== false) {
            $entry['changes'] = json_decode($entry['changes'] ?? '{}', true);
            $results[] = $entry;
        }
    }
    
    usort($results, function($a, $b) {
        return strtotime($b['timestamp']) - strtotime($a['timestamp']);
    });
    
    return array_slice($results, 0, $limit);
}

/**
 * Get audit statistics
 */
function getAuditStats($days = 30) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return [];
    }
    
    $entries = readCSV(AUDIT_LOG_FILE, getAuditSchema());
    $cutoff_ts = strtotime("-$days days");
    
    $stats = [
        'total_entries' => 0,
        'actions' => [],
        'users' => [],
        'entities' => [],
        'status' => [],
    ];
    
    foreach ($entries as $entry) {
        $entry_ts = strtotime($entry['timestamp'] ?? '');
        if ($entry_ts >= $cutoff_ts) {
            $stats['total_entries']++;
            
            $action = $entry['action'] ?? 'unknown';
            $stats['actions'][$action] = ($stats['actions'][$action] ?? 0) + 1;
            
            $user = $entry['user_id'] ?? 'unknown';
            $stats['users'][$user] = ($stats['users'][$user] ?? 0) + 1;
            
            $entity = $entry['entity_type'] ?? 'unknown';
            $stats['entities'][$entity] = ($stats['entities'][$entity] ?? 0) + 1;
            
            $status = $entry['status'] ?? 'unknown';
            $stats['status'][$status] = ($stats['status'][$status] ?? 0) + 1;
        }
    }
    
    return $stats;
}

/**
 * Clean old audit logs (keep last 10000 entries)
 */
function cleanOldAuditLogs($keep_count = 10000) {
    if (!file_exists(AUDIT_LOG_FILE)) {
        return true;
    }
    
    $entries = readCSV(AUDIT_LOG_FILE, getAuditSchema());
    
    // Keep most recent entries
    $entries = array_slice($entries, -$keep_count);
    
    // Create backup of old entries
    if (function_exists('createBackup')) {
        createBackup(AUDIT_LOG_FILE);
    }
    
    // Rewrite file with kept entries
    $schema = getAuditSchema();
    return writeCSV(AUDIT_LOG_FILE, $entries, $schema);
}

/**
 * Format audit entry for display
 */
function formatAuditEntry($entry) {
    $changes_list = [];
    if (is_array($entry['changes'])) {
        foreach ($entry['changes'] as $field => $change) {
            $old = $change['old'] ?? '';
            $new = $change['new'] ?? '';
            
            if ($old !== null && $new !== null) {
                $changes_list[] = "$field: \"$old\" ‚Üí \"$new\"";
            } elseif ($new !== null) {
                $changes_list[] = "$field: (Added) \"$new\"";
            } else {
                $changes_list[] = "$field: (Removed) \"$old\"";
            }
        }
    }
    
    return [
        'timestamp' => htmlspecialchars($entry['timestamp'] ?? ''),
        'user' => htmlspecialchars($entry['user_id'] ?? 'unknown'),
        'action' => htmlspecialchars($entry['action'] ?? ''),
        'summary' => htmlspecialchars($entry['summary'] ?? ''),
        'changes' => $changes_list,
        'status' => htmlspecialchars($entry['status'] ?? 'unknown'),
        'error' => !empty($entry['error_msg']) ? htmlspecialchars($entry['error_msg']) : null,
    ];
}

?>


--- End of audit_handler.php ---



--- Start of backorders_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$backorderFile = __DIR__ . '/backorders.csv';

$inventory = readCSV($inventoryFile, $inventorySchema);

function read_backorders($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_backorders($filename, $rows) {
  $headers = ['po_number','item_id','item_name','quantity_backorder','note','created_at'];
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, $headers);
  foreach ($rows as $row) {
    $line = [];
    foreach ($headers as $header) {
      $line[] = $row[$header] ?? '';
    }
    fputcsv($file, $line);
  }
  fclose($file);
}

function find_inventory_index($inventory, $itemId) {
  foreach ($inventory as $idx => $row) {
    if (($row['item_id'] ?? '') === $itemId) {
      return $idx;
    }
  }
  return -1;
}

function init_inventory_row($schema, $itemId, $itemName) {
  $row = [];
  foreach ($schema as $field) {
    $row[$field] = '';
  }
  $row['item_id'] = $itemId;
  $row['item_name'] = $itemName;
  $row['quantity_in_stock'] = '0';
  $row['status'] = 'Stock';
  $row['created_at'] = date('Y-m-d H:i:s');
  $row['updated_at'] = $row['created_at'];
  return $row;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['receive_backorder'])) {
  $itemId = trim($_POST['item_id'] ?? '');
  $poNumber = trim($_POST['po_number'] ?? '');
  $qtyReceive = is_numeric($_POST['receive_qty'] ?? '') ? (float)$_POST['receive_qty'] : 0.0;

  $backorders = read_backorders($backorderFile);
  $updated = [];

  foreach ($backorders as $row) {
    if (($row['item_id'] ?? '') === $itemId && ($row['po_number'] ?? '') === $poNumber) {
      $backorderQty = is_numeric($row['quantity_backorder'] ?? '') ? (float)$row['quantity_backorder'] : 0.0;
      $remaining = max(0.0, $backorderQty - $qtyReceive);

      if ($qtyReceive > 0) {
        $invIndex = find_inventory_index($inventory, $itemId);
        if ($invIndex < 0) {
          $inventory[] = init_inventory_row($inventorySchema, $itemId, $row['item_name'] ?? '');
          $invIndex = count($inventory) - 1;
        }
        $current = is_numeric($inventory[$invIndex]['quantity_in_stock'] ?? '') ? (float)$inventory[$invIndex]['quantity_in_stock'] : 0.0;
        $inventory[$invIndex]['quantity_in_stock'] = (string)($current + $qtyReceive);
        $inventory[$invIndex]['updated_at'] = date('Y-m-d H:i:s');
      }

      if ($remaining > 0) {
        $row['quantity_backorder'] = (string)$remaining;
        $updated[] = $row;
      }
    } else {
      $updated[] = $row;
    }
  }

  if ($itemId !== '') {
    $stillBackordered = false;
    foreach ($updated as $row) {
      if (($row['item_id'] ?? '') === $itemId) {
        $stillBackordered = true;
        break;
      }
    }
    $invIndex = find_inventory_index($inventory, $itemId);
    if ($invIndex >= 0 && !$stillBackordered) {
      $inventory[$invIndex]['status'] = 'Stock';
    }
  }

  writeCSV($inventoryFile, $inventory, $inventorySchema);
  write_backorders($backorderFile, $updated);
  header('Location: backorders_list.php');
  exit;
}

$backorders = read_backorders($backorderFile);
?>
<div class="container">
  <h2>Backorders</h2>
  <?php if (empty($backorders)): ?>
    <div style="text-align:center; color:#888; margin-top:18px;">No backorders found.</div>
  <?php else: ?>
    <table style="width:100%; border-collapse:collapse; background:#fff;">
      <thead>
        <tr style="background:#f5f5f5;">
          <th style="padding:8px; text-align:left;">PO</th>
          <th style="padding:8px; text-align:left;">Item ID</th>
          <th style="padding:8px; text-align:left;">Item Name</th>
          <th style="padding:8px; text-align:left;">Backorder Qty</th>
          <th style="padding:8px; text-align:left;">Note</th>
          <th style="padding:8px; text-align:left;">Action</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($backorders as $row): ?>
          <tr>
            <td style="padding:8px;"><?= htmlspecialchars($row['po_number'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['quantity_backorder'] ?? '') ?></td>
            <td style="padding:8px;"><?= htmlspecialchars($row['note'] ?? '') ?></td>
            <td style="padding:8px;">
              <form method="post" style="display:flex; gap:6px; align-items:center;">
                <input type="hidden" name="receive_backorder" value="1">
                <input type="hidden" name="po_number" value="<?= htmlspecialchars($row['po_number'] ?? '') ?>">
                <input type="hidden" name="item_id" value="<?= htmlspecialchars($row['item_id'] ?? '') ?>">
                <input type="number" name="receive_qty" min="0" step="0.01" value="<?= htmlspecialchars($row['quantity_backorder'] ?? '') ?>" style="width:100px; padding:3px 5px;">
                <button type="submit" class="btn-outline">Receive</button>
              </form>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of backorders_list.php ---



--- Start of backup.php ---

<?php
// backup.php - List pages for backup selection
$dir = __DIR__;
$files = scandir($dir);
$phpPages = array_filter($files, function($file) {
    return (substr($file, -4) === '.php' && $file !== 'backup.php');
});

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['pages'])) {
    $selected = $_POST['pages'];
    echo '<h2>Selected pages for backup:</h2>';
    echo '<ul>';
    foreach ($selected as $page) {
        echo '<li>' . htmlspecialchars($page) . '</li>';
    }
    echo '</ul>';
    // Here you can trigger backup logic for selected pages
    exit;
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Backup Page Selector</title>
</head>
<body>
    <h1>Select Pages to Back Up</h1>
    <form method="post">
        <?php foreach ($phpPages as $page): ?>
            <label>
                <input type="checkbox" name="pages[]" value="<?= htmlspecialchars($page) ?>">
                <?= htmlspecialchars($page) ?>
            </label><br>
        <?php endforeach; ?>
        <button type="submit">Back Up Selected Pages</button>
    </form>
</body>
</html>


--- End of backup.php ---



--- Start of backup_handler.php ---

<?php
/**
 * Backup System for CSV Data
 * Creates automatic backups before modifications and allows restore
 */

require_once __DIR__ . '/error_handler.php';

define('BACKUP_DIR', __DIR__ . '/backups');
define('BACKUP_RETENTION_DAYS', 30);
define('BACKUP_RETENTION_COUNT', 50);

/**
 * Initialize backup directory
 */
function initializeBackupSystem() {
    if (!is_dir(BACKUP_DIR)) {
        if (!mkdir(BACKUP_DIR, 0755, true)) {
            logError('Failed to create backup directory', ['path' => BACKUP_DIR]);
            return false;
        }
    }
    return true;
}

/**
 * Create a backup of a CSV file before modification
 * Returns backup filename if successful
 */
function createBackup($filename) {
    initializeBackupSystem();
    
    if (!file_exists($filename)) {
        logWarning('Backup requested for non-existent file', ['filename' => $filename]);
        return null;
    }
    
    try {
        $timestamp = date('YmdHis');
        $basefilename = basename($filename);
        $backupFile = BACKUP_DIR . '/' . pathinfo($basefilename, PATHINFO_FILENAME) 
                    . '_' . $timestamp . '.' . pathinfo($basefilename, PATHINFO_EXTENSION);
        
        if (copy($filename, $backupFile)) {
            logInfo('Backup created successfully', [
                'original' => $filename,
                'backup' => $backupFile,
                'size' => filesize($backupFile),
            ]);
            
            // Clean up old backups
            cleanOldBackups();
            
            return $backupFile;
        } else {
            logError('Failed to create backup file', ['filename' => $filename]);
            return null;
        }
    } catch (Exception $e) {
        logError('Backup creation exception', ['exception' => $e->getMessage()]);
        return null;
    }
}

/**
 * Restore a CSV file from backup
 */
function restoreFromBackup($backupFile, $targetFile) {
    if (!file_exists($backupFile)) {
        throw new Exception("Backup file not found: {$backupFile}");
    }
    
    // Verify backup is in backup directory
    $realBackupPath = realpath($backupFile);
    $realBackupDir = realpath(BACKUP_DIR);
    
    if (strpos($realBackupPath, $realBackupDir) !== 0) {
        throw new Exception("Invalid backup file path (security check failed)");
    }
    
    try {
        // Create backup of current state before restoring
        createBackup($targetFile);
        
        // Restore from backup
        if (copy($backupFile, $targetFile)) {
            logInfo('Data restored from backup', [
                'backup_file' => $backupFile,
                'target_file' => $targetFile,
            ]);
            return true;
        } else {
            throw new Exception("Failed to copy backup to target location");
        }
    } catch (Exception $e) {
        logError('Restore from backup failed', ['exception' => $e->getMessage()]);
        throw $e;
    }
}

/**
 * Get list of available backups for a file
 */
function listBackups($filename = null) {
    initializeBackupSystem();
    
    if (!is_dir(BACKUP_DIR)) {
        return [];
    }
    
    $backups = [];
    $files = scandir(BACKUP_DIR, SCANDIR_SORT_DESCENDING);
    
    foreach ($files as $file) {
        if ($file === '.' || $file === '..') {
            continue;
        }
        
        $fullPath = BACKUP_DIR . '/' . $file;
        
        // Filter by filename if specified
        if ($filename !== null) {
            $filenameBase = pathinfo($filename, PATHINFO_FILENAME);
            if (strpos($file, $filenameBase) !== 0) {
                continue;
            }
        }
        
        if (is_file($fullPath)) {
            // Extract timestamp from filename (format: name_YmdHis.ext)
            if (preg_match('/_(\d{14})\./', $file, $matches)) {
                $timestamp = $matches[1];
                $datetime = DateTime::createFromFormat('YmdHis', $timestamp);
                
                $backups[] = [
                    'filename' => $file,
                    'path' => $fullPath,
                    'timestamp' => $timestamp,
                    'datetime' => $datetime ? $datetime->format('Y-m-d H:i:s') : 'Unknown',
                    'size' => filesize($fullPath),
                    'size_formatted' => formatBytes(filesize($fullPath)),
                ];
            }
        }
    }
    
    return $backups;
}

/**
 * Clean up old backup files
 * Removes backups older than BACKUP_RETENTION_DAYS or beyond BACKUP_RETENTION_COUNT
 */
function cleanOldBackups() {
    if (!is_dir(BACKUP_DIR)) {
        return;
    }
    
    $files = scandir(BACKUP_DIR, SCANDIR_SORT_DESCENDING);
    $fileCount = 0;
    $cutoffDate = time() - (BACKUP_RETENTION_DAYS * 86400);
    
    foreach ($files as $file) {
        if ($file === '.' || $file === '..') {
            continue;
        }
        
        $fullPath = BACKUP_DIR . '/' . $file;
        
        if (!is_file($fullPath)) {
            continue;
        }
        
        $fileCount++;
        
        // Delete if older than retention days
        if (filemtime($fullPath) < $cutoffDate) {
            if (unlink($fullPath)) {
                logInfo('Old backup deleted (retention period)', ['file' => $file]);
            }
            continue;
        }
        
        // Delete if beyond retention count
        if ($fileCount > BACKUP_RETENTION_COUNT) {
            if (unlink($fullPath)) {
                logInfo('Backup deleted (retention count exceeded)', ['file' => $file]);
            }
        }
    }
}

/**
 * Format bytes as human-readable size
 */
function formatBytes($bytes, $precision = 2) {
    $units = ['B', 'KB', 'MB', 'GB'];
    
    for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
        $bytes /= 1024;
    }
    
    return round($bytes, $precision) . ' ' . $units[$i];
}

/**
 * Get backup statistics
 */
function getBackupStats() {
    if (!is_dir(BACKUP_DIR)) {
        return [
            'total_backups' => 0,
            'total_size' => 0,
            'total_size_formatted' => '0 B',
            'oldest_backup' => null,
            'newest_backup' => null,
        ];
    }
    
    $backups = listBackups();
    $totalSize = 0;
    
    foreach ($backups as $backup) {
        $totalSize += $backup['size'];
    }
    
    return [
        'total_backups' => count($backups),
        'total_size' => $totalSize,
        'total_size_formatted' => formatBytes($totalSize),
        'oldest_backup' => !empty($backups) ? end($backups) : null,
        'newest_backup' => !empty($backups) ? reset($backups) : null,
    ];
}

/**
 * Initialize backup system on require
 */
initializeBackupSystem();

?>


--- End of backup_handler.php ---



--- Start of backup_trigger.php ---

<?php
// backup_trigger.php
// Runs the daily backup script for CRM .csv files

$script = 'c:\xampp\htdocs\CRM\backup_crm_daily.bat';

// Run the backup script
$output = shell_exec('"' . $script . '"');

// Return result
header('Content-Type: application/json');
echo json_encode(['status' => 'Backup triggered', 'output' => $output]);


--- End of backup_trigger.php ---



--- Start of bulk_action.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

// ‚úÖ CSRF Protection: Verify token on POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        die(json_encode(['error' => 'Security validation failed. Please try again.']));
    }
}

$schemaFile = __DIR__ . '/contact_schema.php';
$schema = file_exists($schemaFile) ? require $schemaFile : [];
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$selectedIds = $_POST['selected_ids'] ?? [];
$action = $_POST['action'] ?? '';
$tagToAssign = $_POST['assign_tag'] ?? '';
$statusToAssign = $_POST['assign_status'] ?? '';

if (!is_array($selectedIds) || empty($action)) {
    die('Error: No contacts selected or no action specified.');
}

// Handle export (read-only, no locking needed)
if ($action === 'export') {
    $contacts = readCSV('contacts.csv', $schema);
    if (!is_array($contacts)) {
        $contacts = [];
    }
    
    $exportRows = [];
    foreach ($contacts as $contact) {
        $id = $contact['id'] ?? '';
        $isSelected = in_array($id, $selectedIds);
        
        if ($isSelected) {
            $row = [];
            foreach ($schema as $field) {
                $row[] = $contact[$field] ?? '';
            }
            $exportRows[] = $row;
        }
    }
    
    $filename = 'contacts_bulk_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($exportRows as $row) {
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}

// Handle modify operations (delete, assign_tag, assign_status) with file locking
try {
    readModifyWriteCSV('contacts.csv', $schema, function($contacts) use ($selectedIds, $action, $tagToAssign, $statusToAssign) {
        $updatedContacts = [];
        
        foreach ($contacts as $contact) {
            $id = $contact['id'] ?? '';
            $isSelected = in_array($id, $selectedIds);
            
            // Delete action - skip selected contacts
            if ($action === 'delete' && $isSelected) {
                // ‚úÖ LOCKED: Prevents concurrent delete conflicts
                continue;
            }
            
            // Assign tag action
            if ($action === 'assign_tag' && $isSelected && $tagToAssign !== '') {
                // ‚úÖ LOCKED: Tag assignment won't be overwritten by concurrent operations
                $existingTags = array_map('trim', explode(',', $contact['tags'] ?? ''));
                if (!in_array($tagToAssign, $existingTags)) {
                    $existingTags[] = $tagToAssign;
                }
                $contact['tags'] = implode(', ', $existingTags);
            }
            
            // Assign status action
            if ($action === 'assign_status' && $isSelected && $statusToAssign !== '') {
                // ‚úÖ LOCKED: Status change won't be overwritten by concurrent operations
                $contact['status'] = $statusToAssign;
            }
            
            $updatedContacts[] = $contact;
        }
        
        return $updatedContacts;
    });
    
    header('Location: contacts_list.php');
    exit;
} catch (Exception $e) {
    echo "<p style='color:red;'>Error performing bulk action: " . htmlspecialchars($e->getMessage()) . "</p>";
    echo "<p><a href='contacts_list.php'>Go back</a></p>";
    exit;
}
?>

--- End of bulk_action.php ---



--- Start of calendar.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

// Load tasks from handler
require_once 'layout_start.php';
require_once 'csv_handler.php'; // or whatever file defines readCSV()

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp']; // adjust based on your actual CSV columns
$tasks = readCSV($filename, $schema);

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        $tasksByDate[$task['due_date']][] = $task;
    }
}

?>


<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }

  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }

  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }

  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>
<h2>Task Calendar</h2>
<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
  <?php
  $year = date('Y');
  $month = date('m');
  $daysInMonth = date('t');
  $firstDayOfMonth = date('w', strtotime("$year-$month-01"));

  $day = 1;
  $week = [];

  for ($i = 0; $i < $firstDayOfMonth; $i++) {
      $week[] = "<td></td>";
  }

  while ($day <= $daysInMonth) {
      $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
      if (isset($tasksByDate[$dateStr])) {
          $taskTitles = '';
          foreach ($tasksByDate[$dateStr] as $task) {
              $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
          }
          $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
      } else {
          $week[] = "<td>$day</td>";
      }

      if (count($week) == 7) {
          echo "<tr>" . implode('', $week) . "</tr>";
          $week = [];
      }

      $day++;
  }

  if (!empty($week)) {
      while (count($week) < 7) {
          $week[] = "<td></td>";
      }
      echo "<tr>" . implode('', $week) . "</tr>";
  }
  ?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}
</script>

<?php include 'layout_end.php'; ?>


--- End of calendar.php ---



--- Start of commit_import.php ---

<?php
session_start();
require_once 'csv_handler.php';
require_once 'error_handler.php';
require_once 'contact_validator.php';

$schema = require __DIR__ . '/contact_schema.php';
$targetFile = 'contacts.csv';

// CSRF token verification
if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
    showError('CSRF token validation failed. Import cancelled.');
    logError('CSRF token validation failed during import', ['ip' => $_SERVER['REMOTE_ADDR']]);
    exit;
}

// Validate session data
$contacts = $_SESSION['import_preview'] ?? [];

if (!is_array($contacts) || empty($contacts)) {
    echo "<div class='container'>";
    showError('No import data received or session expired. <a href="import_contacts.php">Try again</a>');
    logWarning('Import failed: no data in session', ['ip' => $_SERVER['REMOTE_ADDR']]);
    echo "</div>";
    exit;
}

echo "<div class='container'>";
echo "<h2>Commit Import</h2>";

// Re-validate each contact before import (safety check)
$validContacts = [];
$importErrors = [];

foreach ($contacts as $index => $contact) {
    $contact_errors = validateContact($contact);
    if (empty($contact_errors)) {
        $validContacts[] = $contact;
    } else {
        $importErrors[$index] = $contact_errors;
    }
}

if (!empty($importErrors)) {
    showError('Some contacts failed final validation. Import aborted.');
    echo "<p><strong>Failed contacts:</strong></p>";
    echo "<ul>";
    foreach ($importErrors as $idx => $errors) {
        echo "<li>Contact " . ($idx + 1) . ": " . implode(", ", $errors) . "</li>";
    }
    echo "</ul>";
    logError('Import failed during validation', ['count' => count($importErrors), 'total' => count($contacts)]);
    echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
    echo "</div>";
    exit;
}

// Final check: Re-validate schema alignment
if (!empty($validContacts)) {
    $schema_valid = true;
    foreach ($validContacts as $contact) {
        foreach ($schema as $col) {
            if (!array_key_exists($col, $contact)) {
                $schema_valid = false;
                break;
            }
        }
        if (!$schema_valid) break;
    }
    
    if (!$schema_valid) {
        showError('Contact schema mismatch. Import aborted.');
        logError('Schema validation failed during import', ['schemas' => json_encode($schema)]);
        echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
        echo "</div>";
        exit;
    }
}

// Create backup before import
if (file_exists($targetFile) && function_exists('createBackup')) {
    $backup_result = createBackup($targetFile);
    if (!$backup_result) {
        showError('Failed to create backup. Import cancelled for safety.');
        logError('Backup creation failed during import', ['file' => $targetFile]);
        echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
        echo "</div>";
        exit;
    }
}

// Attempt to write/append contacts
try {
    $success = writeCSV($targetFile, $validContacts, $schema);
    
    if ($success) {
        showSuccess('Import complete. ' . count($validContacts) . ' contacts added successfully.');
        logInfo('Import successful', ['count' => count($validContacts), 'user_id' => $_SESSION['user_id'] ?? 'unknown']);
        
        // ‚úÖ AUDIT: Log bulk import
        auditImport(count($validContacts), 'success');
        
        echo "<p><a href='contacts_list.php' class='btn'>‚Üê Back to Contacts</a></p>";
        unset($_SESSION['import_preview']);
    } else {
        showError('Failed to write contacts to file. Import may have failed.');
        logError('Write operation failed during import', ['file' => $targetFile, 'count' => count($validContacts)]);
        
        // ‚úÖ AUDIT: Log failed import
        auditImport(count($validContacts), 'failed', 'Write operation failed');
        
        echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
    }
} catch (Exception $e) {
    showError('Unexpected error during import: ' . htmlspecialchars($e->getMessage()));
    logError('Exception during import', ['error' => $e->getMessage(), 'code' => $e->getCode()]);
    
    // ‚úÖ AUDIT: Log failed import with exception
    auditImport(count($validContacts), 'failed', $e->getMessage());
    
    echo "<p><a href='import_contacts.php'>‚Üê Back to Import</a></p>";
}

echo "</div>";
?>



--- End of commit_import.php ---



--- Start of contacts_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
require_once 'csv_handler.php';

// Simple escape helper if sanitize_helper not loaded
if (!function_exists('e')) {
    function e($str) {
        return htmlspecialchars($str ?? '', ENT_QUOTES, 'UTF-8');
    }
}

// Simple CSRF helper fallback
if (!function_exists('renderCSRFInput')) {
    function renderCSRFInput() {
        // Empty fallback - CSRF protection can be added later
        return '';
    }
}

// ‚úÖ PAGINATION CONSTANTS
define('DEFAULT_CONTACTS_PER_PAGE', 50);
define('ALLOWED_PER_PAGE_OPTIONS', [10, 25, 50, 100]);

// Load schema safely
$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;

// DEBUG: Show all GET parameters for troubleshooting
$debugMode = false; // Set to true to enable debugging
if ($debugMode && !empty($_GET)) {
    error_log("CONTACTS SEARCH DEBUG - GET Parameters: " . print_r($_GET, true));
}

if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

// Load field visibility preferences from CSV
$csvPath = __DIR__ . '/field_visibility.csv';
$fieldSaveError = '';

function loadDisplayFields($csvPath) {
  $fields = [];
  if (file_exists($csvPath)) {
    $handle = fopen($csvPath, 'r');
    if ($handle !== false) {
      while (($row = fgetcsv($handle)) !== false) {
        if (count($row) === 2 && strtolower($row[1]) === 'true') {
          $fields[] = $row[0];
        }
      }
      fclose($handle);
    }
  }
  return $fields;
}

$displayFields = loadDisplayFields($csvPath);

// Save field visibility preferences to CSV only when Apply is clicked
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['apply'])) {
  $selectedFields = isset($_POST['display']) ? (array)$_POST['display'] : [];
  $selectedFields = array_values(array_intersect($schema, $selectedFields));

  $csvDir = dirname($csvPath);
  if (!is_writable($csvDir) || (file_exists($csvPath) && !is_writable($csvPath))) {
    $fieldSaveError = 'Field visibility file is not writable. Check folder permissions.';
  } else {
    $handle = fopen($csvPath, 'w');
    if ($handle === false) {
      $fieldSaveError = 'Could not open field visibility file for writing.';
    } else {
      foreach ($schema as $field) {
        $visible = in_array($field, $selectedFields, true) ? 'true' : 'false';
        fputcsv($handle, [$field, $visible]);
      }
      fclose($handle);
    }
  }

  clearstatcache(true, $csvPath);
  $displayFields = loadDisplayFields($csvPath);

  if (empty($fieldSaveError)) {
    $saved = array_values(array_intersect($schema, $displayFields));
    if ($saved !== $selectedFields) {
      $fieldSaveError = 'Field visibility did not persist. Please refresh and try again.';
    }
  }
}

// Fallback if displayFields is empty
if (empty($displayFields)) {
    $displayFields = ['first_name', 'last_name', 'company', 'email'];
}

// ‚úÖ PAGINATION: Get current page and per-page setting
$per_page = isset($_GET['per_page']) && in_array((int)$_GET['per_page'], ALLOWED_PER_PAGE_OPTIONS) 
    ? (int)$_GET['per_page'] 
    : DEFAULT_CONTACTS_PER_PAGE;

$current_page = isset($_GET['page']) ? max(1, (int)$_GET['page']) : 1;

// Handle query and sort
$query = strtolower(trim($_GET['query'] ?? ''));
$field = $_GET['field'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$activeSort = array_flip($sortFields);

// Load contacts safely
$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Detect duplicates
$emailCount = [];
foreach ($contacts as $c) {
    $email = strtolower(trim($c['email'] ?? ''));
    if (!empty($email)) {
        $emailCount[$email] = ($emailCount[$email] ?? 0) + 1;
    }
}

// Apply filter - search across multiple fields
if ($query !== '') {
    if ($field && in_array($field, $schema)) {
        // Search in specific field if specified
        $contacts = array_filter($contacts, function($c) use ($field, $query) {
            $fieldValue = $c[$field] ?? '';
            return stripos($fieldValue, $query) !== false;
        });
    } else {
        // Search across all text fields
        $searchableFields = ['first_name', 'last_name', 'company', 'email', 'phone', 'city', 'province', 'country', 'tags', 'notes'];
        $contacts = array_filter($contacts, function($c) use ($query, $searchableFields) {
            foreach ($searchableFields as $searchField) {
                $fieldValue = $c[$searchField] ?? '';
                if (stripos($fieldValue, $query) !== false) {
                    return true;
                }
            }
            return false;
        });
    }
    // Re-index after filter
    $contacts = array_values($contacts);
}


// Apply multi-field sort
$validSortFields = array_filter($sortFields, function($f) use ($displayFields) {
    return in_array($f, $displayFields);
});

if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';
            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// ‚úÖ PAGINATION: Calculate pagination info
$total_contacts = count($contacts);
$total_pages = max(1, ceil($total_contacts / $per_page));
$current_page = min($current_page, $total_pages); // Ensure current page doesn't exceed total pages
$offset = ($current_page - 1) * $per_page;

// ‚úÖ PAGINATION: Get contacts for current page
$page_contacts = array_slice($contacts, $offset, $per_page);

// Export logic (exports filtered results, not just current page)
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }
    fputcsv($output, $displayFields);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($displayFields as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<!-- DEBUG: Show GET parameters -->
<?php if ($debugMode): ?>
  <div style="background: #ff6b6b; color: white; padding: 20px; margin: 20px; border-radius: 8px; font-family: monospace; font-size: 14px;">
    <strong style="font-size: 18px;">üî¥ DEBUG MODE ACTIVE</strong><br><br>
    <strong>All GET Parameters:</strong><br>
    <?php foreach ($_GET as $key => $value): ?>
      <div style="backgroundColor: rgba(255,255,255,0.1); padding: 5px; margin: 3px 0; border-radius: 3px;">
        <strong><?= htmlspecialchars($key) ?>:</strong> "<?= htmlspecialchars($value) ?>"
      </div>
    <?php endforeach; ?>
    <?php if (empty($_GET)): ?>
      <div style="backgroundColor: rgba(255,255,255,0.1); padding: 10px; border-radius: 3px;">NO GET PARAMETERS - Form might not be submitting!</div>
    <?php endif; ?>
    
    <hr style="margin: 20px 0; border-color: rgba(255,255,255,0.3);">
    <strong>EMERGENCY SIMPLE SEARCH (Use this instead!):</strong><br>
    <form method="GET" action="contacts_list.php" style="margin-top: 15px;">
      <input type="text" name="query" placeholder="Type search term..." style="padding: 10px; font-size: 16px; border: 2px solid white; border-radius: 4px; width: 300px; color: #333;">
      <input type="hidden" name="field" value="">
      <button type="submit" style="padding: 10px 20px; font-size: 16px; background: white; color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;">üîç SEARCH</button>
    </form>
  </div>
<?php endif; ?>

<div class="page-header">
  <div class="page-title-section">
    <h1>üë• All Contacts</h1>
    <p class="page-subtitle"><?= $total_contacts ?> total contacts</p>
  </div>
  <div class="page-actions">
    <button type="button" class="btn btn-outline js-toggle-panel" data-target="fieldPanel">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
      </svg>
      Customize Columns
    </button>
    <a href="import_contacts.php" class="btn btn-outline">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
      </svg>
      Import
    </a>
    <a href="contact_form.php" class="btn btn-primary">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
      </svg>
      Add Contact
    </a>
  </div>
</div>

<?php if (!empty($fieldSaveError)): ?>
  <div class="alert alert-error"><?= e($fieldSaveError) ?></div>
<?php elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['apply'])): ?>
  <div class="alert alert-success">Column visibility updated.</div>
<?php endif; ?>

<!-- Field Visibility Panel -->
<div id="fieldPanel" class="collapsible-panel" style="display:none;">
  <form method="POST" class="modern-form">
    <input type="hidden" name="apply" value="1">
    <div class="panel-header">
      <h3>Customize Visible Columns</h3>
      <button type="button" class="btn-close js-toggle-panel" data-target="fieldPanel">√ó</button>
    </div>
    <div class="panel-body">
      <div class="checkbox-grid">
        <?php foreach ($schema as $f): ?>
          <label class="checkbox-label">
            <input type="checkbox" name="display[]" value="<?= $f ?>" <?= in_array($f, $displayFields) ? 'checked' : '' ?>>
            <span class="checkbox-text"><?= ucfirst(str_replace('_', ' ', $f)) ?></span>
          </label>
        <?php endforeach; ?>
      </div>
    </div>
    <div class="panel-footer">
      <button type="submit" class="btn btn-primary">Apply Changes</button>
      <button type="button" class="btn btn-outline js-toggle-panel" data-target="fieldPanel">Cancel</button>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-body">
<!-- BULLETPROOF SIMPLE SEARCH -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
      <form method="GET" action="contacts_list.php" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" 
               name="query" 
               placeholder="Search contacts..." 
               value="<?= htmlspecialchars($_GET['query'] ?? '') ?>"
               style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 15px;">
        
        <select name="field" style="padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 15px;">
          <option value="">All Fields</option>
          <?php foreach ($schema as $f): ?>
            <option value="<?= htmlspecialchars($f) ?>" <?= ($field ?? '') === $f ? 'selected' : '' ?>>
              <?= ucfirst(str_replace('_', ' ', $f)) ?>
            </option>
          <?php endforeach; ?>
        </select>
        
        <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #0099A8 0%, #00859a 100%); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer;">
          üîç Search
        </button>
        
        <?php if (!empty($_GET['query'])): ?>
          <a href="contacts_list.php" style="padding: 12px 24px; background: #f3f4f6; color: #374151; text-decoration: none; border-radius: 6px; font-size: 15px; font-weight: 600;">
            ‚úï Clear
          </a>
        <?php endif; ?>
      </form>
    </div>
    </div>

    <!-- Results Info Bar -->
    <div class="results-info-bar">
      <div class="results-count">
        <?php if ($query !== ''): ?>
          <span class="badge badge-primary"><?= $total_contacts ?> results</span>
          <span class="text-muted">filtered from <?= count(readCSV('contacts.csv', $schema)) ?> total</span>
        <?php else: ?>
          Showing <strong><?= $offset + 1 ?>‚Äì<?= min($offset + $per_page, $total_contacts) ?></strong> of <strong><?= $total_contacts ?></strong> contacts
        <?php endif; ?>
      </div>
      <div class="pagination-info">
        <?php if ($total_pages > 1): ?>
          Page <strong><?= $current_page ?></strong> of <strong><?= $total_pages ?></strong>
        <?php endif; ?>
      </div>
    </div>

    <!-- Modern Pagination -->
    <?php if ($total_pages > 1): ?>
      <nav class="pagination-nav" aria-label="Contacts pagination">
        <div class="pagination-controls">
          <?php if ($current_page > 1): ?>
            <a href="?page=1&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>" 
               class="pagination-btn" title="First page">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.854 3.646a.5.5 0 0 1 0 .708L8.207 8l3.647 3.646a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708 0zM4.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 1 0v-13a.5.5 0 0 0-.5-.5z"/>
              </svg>
            </a>
            <a href="?page=<?= $current_page - 1 ?>&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>" 
               class="pagination-btn" title="Previous page">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
              </svg>
            </a>
          <?php else: ?>
            <span class="pagination-btn pagination-btn-disabled">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.854 3.646a.5.5 0 0 1 0 .708L8.207 8l3.647 3.646a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708 0zM4.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 1 0v-13a.5.5 0 0 0-.5-.5z"/></svg>
            </span>
            <span class="pagination-btn pagination-btn-disabled">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
            </span>
          <?php endif; ?>

          <div class="pagination-pages">
            <?php 
            $page_range = 5;
            $start_page = max(1, $current_page - floor($page_range / 2));
            $end_page = min($total_pages, $start_page + $page_range - 1);
            $start_page = max(1, $end_page - $page_range + 1);
            
            if ($start_page > 1) {
              echo '<span class="pagination-ellipsis">...</span>';
            }
            
            for ($p = $start_page; $p <= $end_page; $p++) {
              if ($p === $current_page) {
                echo '<span class="pagination-page pagination-page-active">' . $p . '</span>';
              } else {
                echo '<a href="?page=' . $p . '&query=' . urlencode($_GET['query'] ?? '') . '&field=' . urlencode($field) . '&sort=' . urlencode($_GET['sort'] ?? '') . '&direction=' . $sortDirection . '&per_page=' . $per_page . '" class="pagination-page">' . $p . '</a>';
              }
            }
            
            if ($end_page < $total_pages) {
              echo '<span class="pagination-ellipsis">...</span>';
            }
            ?>
          </div>

          <?php if ($current_page < $total_pages): ?>
            <a href="?page=<?= $current_page + 1 ?>&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>" 
               class="pagination-btn" title="Next page">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
              </svg>
            </a>
            <a href="?page=<?= $total_pages ?>&query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= urlencode($_GET['sort'] ?? '') ?>&direction=<?= $sortDirection ?>&per_page=<?= $per_page ?>" 
               class="pagination-btn" title="Last page">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M4.146 3.646a.5.5 0 0 0 0 .708L7.793 8l-3.647 3.646a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708 0zM11.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/>
              </svg>
            </a>
          <?php else: ?>
            <span class="pagination-btn pagination-btn-disabled">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
            </span>
            <span class="pagination-btn pagination-btn-disabled">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.146 3.646a.5.5 0 0 0 0 .708L7.793 8l-3.647 3.646a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708 0zM11.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>
            </span>
          <?php endif; ?>
        </div>
      </nav>
    <?php endif; ?>

    <!-- Contacts Table -->
    <div class="table-container">
      <table class="modern-table contacts-table">
        <thead>
          <tr>
            <th class="th-actions">Actions</th>
            <?php foreach ($displayFields as $f): ?>
              <th class="th-sortable">
                <a href="?query=<?= urlencode($_GET['query'] ?? '') ?>&field=<?= urlencode($field) ?>&sort=<?= e($f) ?>&direction=<?= (in_array($f, $sortFields) && $sortDirection === 'asc') ? 'desc' : 'asc' ?>&per_page=<?= $per_page ?>" 
                   class="sort-header">
                  <?= ucfirst(str_replace('_', ' ', $f)) ?>
                  <?php if (isset($activeSort[$f])): ?>
                    <span class="sort-icon"><?= $sortDirection === 'desc' ? '‚Üì' : '‚Üë' ?></span>
                  <?php else: ?>
                    <span class="sort-icon sort-icon-inactive">‚áÖ</span>
                  <?php endif; ?>
                </a>
              </th>
            <?php endforeach; ?>
          </tr>
        </thead>
        <tbody>
          <?php if (empty($page_contacts)): ?>
            <tr>
              <td colspan="<?= count($displayFields) + 1 ?>" class="empty-state">
                <div class="empty-state-content">
                  <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm.256 7a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/>
                    <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Zm-1.993-1.679a.5.5 0 0 0-.686.172l-1.17 1.95-.547-.547a.5.5 0 0 0-.708.708l.774.773a.75.75 0 0 0 1.174-.144l1.335-2.226a.5.5 0 0 0-.172-.686Z"/>
                  </svg>
                  <h3>No contacts found</h3>
                  <p><?= $query ? 'Try adjusting your search or filters' : 'Get started by adding your first contact' ?></p>
                  <?php if (!$query): ?>
                    <a href="contact_form.php" class="btn btn-primary">Add Contact</a>
                  <?php endif; ?>
                </div>
              </td>
            </tr>
          <?php else: ?>
            <?php foreach ($page_contacts as $contact): ?>
              <?php
                $id = isset($contact['id']) ? $contact['id'] : '';
                $email = $contact['email'] ?? '';
                $isDuplicate = !empty($email) && $emailCount[strtolower(trim($email))] > 1;
              ?>
              <tr class="contact-row" data-contact-id="<?= escapeAttr($id) ?>">
                <td class="actions-cell">
                  <div class="action-buttons">
                    <a href="contact_view.php?id=<?= escapeAttr($id) ?>" class="action-btn action-btn-view" title="View contact">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                      </svg>
                    </a>
                    <a href="contact_view.php?id=<?= escapeAttr($id) ?>#edit" class="action-btn action-btn-edit" title="Edit contact">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                      </svg>
                    </a>
                    <form method="POST" action="delete_contact.php" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this contact?');">
                      <?php renderCSRFInput(); ?>
                      <input type="hidden" name="id" value="<?= escapeAttr($id) ?>">
                      <button type="submit" class="action-btn action-btn-delete" title="Delete contact">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
                <?php foreach ($displayFields as $f): ?>
                  <td class="<?= $f === 'company' ? 'company-cell' : ($f === 'email' ? 'email-cell-cell' : '') ?>">
                    <?php if ($f === 'email'): ?>
                      <div class="email-cell">
                        <?= e($contact[$f] ?? '') ?>
                        <?php if ($isDuplicate): ?>
                          <span class="badge badge-danger" title="Duplicate email detected">Duplicate</span>
                        <?php endif; ?>
                      </div>
                    <?php elseif ($f === 'company'): ?>
                      <strong><?= e($contact[$f] ?? '') ?></strong>
                    <?php else: ?>
                      <?= e($contact[$f] ?? '') ?>
                    <?php endif; ?>
                  </td>
                <?php endforeach; ?>
              </tr>
            <?php endforeach; ?>
          <?php endif; ?>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
/* ========== PAGE HEADER ========== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 16px;
  position: relative;
  z-index: 5;
}

.page-title-section h1 {
  margin: 0;
  font-size: 32px;
  font-weight: 700;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-subtitle {
  margin: 4px 0 0 0;
  font-size: 14px;
  color: #6b7280;
  font-weight: 400;
}

.page-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  position: relative;
  z-index: 6;
}

.page-actions .btn {
  position: relative;
  z-index: 7;
}

.page-actions .btn svg {
  margin-right: 6px;
}

/* ========== COLLAPSIBLE PANEL ========== */
.collapsible-panel {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  border-bottom: 1px solid #e5e7eb;
}

.panel-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #374151;
}

.btn-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #9ca3af;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.2s;
}

.btn-close:hover {
  background: #e5e7eb;
  color: #374151;
}

.panel-body {
  padding: 20px;
}

.panel-footer {
  padding: 16px 20px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  transition: background 0.2s;
}

.checkbox-label:hover {
  background: #f3f4f6;
}

.checkbox-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #0099A8;
}

.checkbox-text {
  font-size: 14px;
  color: #374151;
  user-select: none;
}

/* ========== SEARCH & FILTER BAR ========== */
.search-filter-section {
  margin-bottom: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.quick-search-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.search-input-wrapper {
  position: relative;
  flex: 1;
  min-width: 280px;
}

.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  pointer-events: none;
}

.search-input {
  width: 100%;
  padding: 10px 40px 10px 44px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 15px;
  transition: all 0.2s;
}

.search-input:focus {
  outline: none;
  border-color: #0099A8;
  box-shadow: 0 0 0 3px rgba(0, 153, 168, 0.1);
}

.clear-search {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.clear-search:hover {
  background: #f3f4f6;
  color: #374151;
}

.filter-select {
  padding: 10px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 160px;
}

.filter-select:focus {
  outline: none;
  border-color: #0099A8;
  box-shadow: 0 0 0 3px rgba(0, 153, 168, 0.1);
}

.advanced-filters {
  padding: 20px;
  background: #f9fafb;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
}

.filter-item label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}

.form-control {
  width: 100%;
  padding: 9px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;
}

.form-control:focus {
  outline: none;
  border-color: #0099A8;
  box-shadow: 0 0 0 3px rgba(0, 153, 168, 0.1);
}

/* ========== RESULTS INFO BAR ========== */
.results-info-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 8px;
  margin-bottom: 16px;
  border: 1px solid #bae6fd;
}

.results-count {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: #374151;
}

.text-muted {
  color: #6b7280;
  font-size: 13px;
}

.pagination-info {
  font-size: 14px;
  color: #6b7280;
}

/* ========== MODERN PAGINATION ========== */
.pagination-nav {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid #e5e7eb;
}

.pagination-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.pagination-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: #374151;
  text-decoration: none;
}

.pagination-btn:hover {
  background: #f3f4f6;
  border-color: #0099A8;
  color: #0099A8;
}

.pagination-btn-disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.pagination-btn-disabled:hover {
  background: white;
  border-color: #d1d5db;
  color: #374151;
}

.pagination-pages {
  display: flex;
  gap: 4px;
  align-items: center;
}

.pagination-page {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 36px;
  padding: 0 10px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: #374151;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
}

.pagination-page:hover {
  background: #f3f4f6;
  border-color: #0099A8;
  color: #0099A8;
}

.pagination-page-active {
  background: linear-gradient(135deg, #0099A8 0%, #00859a 100%);
  color: white;
  border-color: #0099A8;
  font-weight: 600;
}

.pagination-page-active:hover {
  background: linear-gradient(135deg, #00859a 0%, #007489 100%);
  color: white;
}

.pagination-ellipsis {
  color: #9ca3af;
  padding: 0 4px;
}

/* ========== TABLE STYLES ========== */
.table-container {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-top: 16px;
}

.contacts-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.contacts-table thead {
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  border-bottom: 2px solid #e5e7eb;
}

.contacts-table th {
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: #374151;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
}

.th-actions {
  width: 140px;
  min-width: 140px;
}

.th-sortable {
  cursor: pointer;
}

.sort-header {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #374151;
  text-decoration: none;
  transition: color 0.2s;
}

.sort-header:hover {
  color: #0099A8;
}

.sort-icon {
  font-size: 14px;
  color: #0099A8;
  font-weight: bold;
}

.sort-icon-inactive {
  color: #d1d5db;
  font-weight: normal;
}

.contacts-table tbody tr {
  border-bottom: 1px solid #f3f4f6;
  transition: all 0.15s;
}

.contacts-table tbody tr:hover {
  background: #f9fafb;
}

.contacts-table td {
  padding: 14px 16px;
  font-size: 14px;
  color: #374151;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 0;
  vertical-align: middle;
  box-sizing: border-box;
}

.contacts-table td:hover {
  overflow: visible;
  white-space: normal;
}

.actions-cell {
  padding: 10px 16px !important;
}

.action-buttons {
  display: flex;
  gap: 6px;
  align-items: center;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: 1px solid #e5e7eb;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: #6b7280;
  text-decoration: none;
}

.action-btn:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
  transform: translateY(-1px);
}

.action-btn-view:hover {
  background: #dbeafe;
  border-color: #93c5fd;
  color: #1e40af;
}

.action-btn-edit:hover {
  background: #fef3c7;
  border-color: #fcd34d;
  color: #92400e;
}

.action-btn-delete:hover {
  background: #fee2e2;
  border-color: #fca5a5;
  color: #991b1b;
}

.email-cell {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  white-space: normal !important;
  overflow: visible !important;
}

.email-cell-cell {
  white-space: normal;
}

.contacts-table td.company-cell {
  font-weight: 600;
  white-space: normal;
  word-wrap: break-word;
}

/* ========== EMPTY STATE ========== */
.empty-state {
  padding: 60px 20px;
  text-align: center;
}

.empty-state-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  color: #6b7280;
}

.empty-state-content svg {
  color: #d1d5db;
  margin-bottom: 8px;
}

.empty-state-content h3 {
  margin: 0;
  font-size: 20px;
  color: #374151;
  font-weight: 600;
}

.empty-state-content p {
  margin: 0;
  font-size: 14px;
  color: #9ca3af;
  max-width: 400px;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .page-title-section h1 {
    font-size: 24px;
  }
  
  .quick-search-bar {
    flex-direction: column;
  }
  
  .search-input-wrapper {
    min-width: 100%;
  }
  
  .filter-grid {
    grid-template-columns: 1fr;
  }
  
  .checkbox-grid {
    grid-template-columns: 1fr;
  }
  
  .table-container {
    border-radius: 0;
    margin-left: -20px;
    margin-right: -20px;
    border-left: 0;
    border-right: 0;
  }
  
  .pagination-controls {
    gap: 4px;
  }
  
  .pagination-btn,
  .pagination-page {
    width: 32px;
    height: 32px;
    min-width: 32px;
    font-size: 13px;
  }
}
</style>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contacts_list.php ---



--- Start of contact_form.php ---

<?php
$schema = require __DIR__ . '/contact_schema.php';
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>

<div class="page-header">
  <h1>Add New Contact</h1>
  <div class="page-actions">
    <a href="contacts_list.php" class="btn btn-outline">Back to Contacts</a>
  </div>
</div>

<?php if (isset($_GET['status']) && $_GET['status'] === 'success'): ?>
  <div class="alert alert-success">‚úì Contact saved successfully.</div>
<?php endif; ?>

<div class="card">
  <div class="card-header">
    <h3>Contact Information</h3>
  </div>
  <div class="card-body">
    <form id="contact-form" action="add_contact.php" method="POST" class="modern-form">
      <?php renderCSRFInput(); ?>
      
      <div class="form-grid">
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'id') continue; ?>
          <div class="form-group">
            <label for="<?= e($field) ?>"><?= e(ucwords(str_replace('_', ' ', $field))) ?>:</label>
            <input type="<?= $field === 'email' ? 'email' : ($field === 'phone' ? 'tel' : 'text') ?>"
                   name="<?= e($field) ?>" id="<?= e($field) ?>" class="form-control"
                   <?= $field === 'company' ? 'required' : '' ?>>
          </div>
        <?php endforeach; ?>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Contact</button>
        <a href="contacts_list.php" class="btn btn-outline">Cancel</a>
      </div>
    </form>
  </div>
</div>

<style>
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-start;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}
</style>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_form.php ---



--- Start of contact_schema.php ---

<?php
return [
    'id',
    'first_name',
    'last_name',
    'company',
    'email',
    'phone',
    'address',
    'city',
    'province',
    'postal_code',
    'country',
    'notes',
    'created_at',
    'last_modified',
    'is_customer',
    'tank_number',
    'delivery_date',
    'tags'
];
?>

--- End of contact_schema.php ---



--- Start of contact_success.php ---

<?php
require_once __DIR__ . '/simple_auth/middleware.php';
$currentPage = basename(__FILE__); // Dynamically sets active tab
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Saved</title>
  <link rel="stylesheet" href="styles.css"> <!-- Optional external CSS -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .navbar { background: #333; padding: 10px 20px; }
    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; }
    .nav-list li { margin-right: 20px; }
    .nav-list a { color: #fff; text-decoration: none; }
    .nav-list .active a { font-weight: bold; text-decoration: underline; }
    .container { max-width: 600px; margin: 60px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
    .btn { display: inline-block; margin-top: 20px; padding: 10px 20px; background: #0077cc; color: #fff; text-decoration: none; border-radius: 4px; }
    .btn:hover { background: #005fa3; }
  </style>
</head>
<body>

<nav class="navbar">
  <ul class="nav-list">
    <li class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
      <a href="dashboard.php">Dashboard</a>
    </li>
    <li class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
      <a href="contact_form.php">Add Contact</a>
    </li>
    <li class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
      <a href="contacts_list.php">View Contacts</a>
    </li>
    <li class="<?= $currentPage === 'add_opportunity.php' ? 'active' : '' ?>">
      <a href="add_opportunity.php">Add Opportunity</a>
    </li>
    <li class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
      <a href="opportunities_list.php">View Opportunities</a>
    </li>
    <li class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
      <a href="import_contacts.php">Import Contacts</a>
    </li>
    <li class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
      <a href="export_contacts.php">Export Contacts</a>
    </li>
  </ul>
</nav>

<div class="container">
  <h2>‚úÖ Contact Saved Successfully</h2>
  <p>Your new contact has been added to the system and logged for audit.</p>
  <a href="dashboard.php" class="btn">Return to Dashboard</a>
</div>

</body>
</html>


--- End of contact_success.php ---



--- Start of contact_validator.php ---

<?php
require_once 'contact_schema.php';
require_once 'sanitize_helper.php';
require_once 'csv_handler.php';

/**
 * Field length limits for data validation
 */
$FIELD_LIMITS = [
    'first_name' => 50,
    'last_name' => 50,
    'company' => 100,
    'email' => 254,
    'phone' => 20,
    'address_1' => 100,
    'address_2' => 100,
    'city' => 50,
    'province' => 50,
    'postal_code' => 10,
    'country' => 50,
    'notes' => 1000,
    'tank_number' => 50,
];

/**
 * Required fields for a valid contact
 */
$REQUIRED_FIELDS = ['company', 'first_name', 'last_name'];

/**
 * ‚úÖ ENHANCED: Validate contact data with comprehensive checks
 */
function validateContact(array $contact): array {
    global $FIELD_LIMITS, $REQUIRED_FIELDS;
    
    $schema = require __DIR__ . '/contact_schema.php';
    $errors = [];

    foreach ($schema as $field) {
        $value = isset($contact[$field]) ? trim($contact[$field]) : '';

        // 1. Required field check
        if (in_array($field, $REQUIRED_FIELDS)) {
            if (empty($value)) {
                $fieldLabel = ucfirst(str_replace('_', ' ', $field));
                $errors[$field] = "$fieldLabel is required.";
                continue;  // Skip further validation for this field
            }
        }

        // Skip validation on empty optional fields
        if (empty($value)) {
            continue;
        }

        // 2. ‚úÖ Length validation (ENHANCED)
        if (isset($FIELD_LIMITS[$field])) {
            if (strlen($value) > $FIELD_LIMITS[$field]) {
                $fieldLabel = ucfirst(str_replace('_', ' ', $field));
                $errors[$field] = "$fieldLabel cannot exceed {$FIELD_LIMITS[$field]} characters "
                                 . "(you have " . strlen($value) . ").";
            }
        }

        // 3. ‚úÖ Format validation (ENHANCED)
        switch ($field) {
            case 'email':
                // Validate email format AND check for common mistakes
                if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[$field] = "Invalid email address format.";
                }
                // Check for common typos
                else if (preg_match('/@(.+)\.c($|[^o])/', $value)) {
                    $errors[$field] = "Email domain appears invalid. Did you mean .com, .ca, etc?";
                }
                break;

            case 'phone':
                // Allow formats: +1-555-123-4567, 555.123.4567, (555) 123-4567, 5551234567, etc.
                if (!preg_match('/^[\d\s\-\+\(\)\.]{7,20}$/', $value)) {
                    $errors[$field] = "Invalid phone number format. Use digits, spaces, and dashes.";
                }
                break;

            case 'postal_code':
                // Allow Canadian (K1A 0B1) or US (12345) formats
                if (!preg_match('/^[A-Z0-9\s\-]{3,10}$/i', $value)) {
                    $errors[$field] = "Invalid postal code format.";
                }
                break;

            case 'country':
                // Allow alphanumeric countries - no special validation needed for now
                if (preg_match('/[<>"\']/', $value)) {
                    $errors[$field] = "Country name contains invalid characters.";
                }
                break;

            case 'website':
                if ($value && !filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[$field] = "Invalid website URL. Must start with http:// or https://";
                }
                break;
        }
    }

    return $errors;
}

/**
 * ‚úÖ ENHANCED: Sanitize contact data before storage
 * Removes dangerous content and normalizes data
 */
function sanitizeContact(array $contact): array {
    $schema = require __DIR__ . '/contact_schema.php';
    $sanitized = [];

    foreach ($schema as $field) {
        $value = isset($contact[$field]) ? $contact[$field] : '';
        
        // Convert to string if not already
        $value = (string)$value;
        
        // 1. Trim whitespace
        $value = trim($value);
        
        // 2. Remove null bytes (security risk)
        $value = str_replace("\0", '', $value);
        
        // 3. Normalize line endings
        $value = str_replace(["\r\n", "\r"], "\n", $value);
        
        // 4. For most fields, remove HTML tags
        if ($field !== 'notes') {
            $value = strip_tags($value);
        }
        
        // 5. For notes, allow some safe HTML but remove dangerous tags
        if ($field === 'notes') {
            // Remove script tags and event handlers
            $value = preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi', '', $value);
            $value = preg_replace('/on[a-z]+\s*=\s*["\']?[^"\'>\s]+["\']?/gi', '', $value);
        }
        
        // 6. For email, normalize to lowercase
        if ($field === 'email') {
            $value = strtolower($value);
        }
        
        // 7. For phone, normalize spacing/dashes
        if ($field === 'phone') {
            // Keep only digits, spaces, dashes, plus, parens, dots
            $value = preg_replace('/[^0-9\s\-\+\(\)\.]/', '', $value);
        }
        
        $sanitized[$field] = $value;
    }

    return $sanitized;
}

/**
 * ‚úÖ NEW: Validate email uniqueness (for duplicate detection)
 */
function isEmailUnique($email, $excludeId = null): bool {
    if (empty($email)) {
        return true;  // Empty email is not a duplicate
    }
    
    $contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
    $email = strtolower(trim($email));
    
    foreach ($contacts as $contact) {
        $contactEmail = strtolower(trim($contact['email'] ?? ''));
        
        // Skip the contact we're updating (by ID)
        if ($excludeId && isset($contact['id']) && $contact['id'] === $excludeId) {
            continue;
        }
        
        if ($contactEmail === $email && !empty($email)) {
            return false;  // Email already exists
        }
    }
    
    return true;  // Email is unique
}

/**
 * ‚úÖ NEW: Comprehensive validation with error details
 */
function validateAndSanitizeContact(array $contact): array {
    // First, sanitize the input
    $contact = sanitizeContact($contact);
    
    // Then validate
    $errors = validateContact($contact);
    
    return [
        'contact' => $contact,
        'errors' => $errors,
        'isValid' => empty($errors),
    ];
}

?>


--- End of contact_validator.php ---



--- Start of contact_view.php ---

<?php
// Security headers
header('Content-Type: text/html; charset=utf-8');
<!-- ...existing code... -->
            die('Error: Data was not saved properly.');
        }
        
        // Reload contact data and show success
        $contacts = $verifyContacts;
        $contactsById = [];
        foreach ($contacts as $c) {
            $contactsById[$c['id']] = $c;
        }
        $contact = $contactsById[$id];
        $saveSuccess = true;
    }
}

// Get contact from URL parameter
$contactId = isset($_GET['id']) ? htmlspecialchars($_GET['id']) : (isset($_POST['id']) ? htmlspecialchars($_POST['id']) : null);
if (!$contactId || !isset($contactsById[$contactId])) {
    die('Error: Invalid contact ID.');
}

$contact = $contactsById[$contactId];
$customer = findCustomerById($customers, $contact['customer_id'] ?? '');

// Get contact status
$isCustomer = ($contact['is_customer'] ?? '') === 'yes';
$status = $isCustomer ? 'Client' : 'Contact';
$statusColor = $isCustomer ? '#28a745' : '#ffc107';

// Calculate metrics
$createdAt = $contact['created_at'] ?? 'Unknown';
$lastModified = $contact['last_modified'] ?? $contact['created_at'] ?? 'Unknown';
$contactOpportunities = getContactOpportunities($contact, $opportunities);
$opportunityValue = array_reduce($contactOpportunities, function($sum, $opp) {
    return $sum + ((float)($opp['value'] ?? 0));
}, 0);

// Get initials and color coding
$initials = getInitials($contact['first_name'] ?? '', $contact['last_name'] ?? '');
$colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
$colorIndex = hexdec(substr($contact['id'] ?? '', 0, 2)) % count($colors);
$avatarColor = $colors[$colorIndex];

// Parse tags
$tags = parseTags($contact['tags'] ?? '');
?>





<div class="container my-4">
  <div class="mb-3">
    <a href="contacts_list.php" class="text-primary fw-semibold">‚Üê Back to Contacts</a>
  </div>
  <div class="card shadow-sm mb-4 p-4 d-flex flex-row align-items-start gap-4 flex-wrap">
    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:64px;height:64px;font-size:2rem;">
      <?= $initials ?>
    </div>
    <div class="flex-grow-1">
      <h1 class="h4 mb-1"><?= htmlspecialchars(trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? ''))) ?: 'Unknown Contact' ?></h1>
      <div class="mb-1 text-muted"><?= htmlspecialchars($contact['company'] ?? 'Company not assigned') ?></div>
      <?php if ($contact['phone']): ?>
        <div class="mb-1"><span class="me-1">‚òé</span><?= htmlspecialchars($contact['phone']) ?></div>
      <?php endif; ?>
      <?php if ($contact['email']): ?>
        <div class="mb-1"><a href="mailto:<?= htmlspecialchars($contact['email']) ?>" class="text-decoration-none text-primary">‚úâ <?= htmlspecialchars($contact['email']) ?></a></div>
      <?php endif; ?>
      <span class="badge" style="background-color: <?= $statusColor ?>;">‚úì <?= $status ?></span>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <button class="btn btn-outline-primary btn-sm" onclick="alert('Email: <?= htmlspecialchars($contact['email'] ?? 'no email') ?>')">‚úâ Email</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="alert('Call: <?= htmlspecialchars($contact['phone'] ?? 'no phone') ?>')">‚òé Call</button>
        <button class="btn btn-outline-success btn-sm" onclick="alert('Add task for <?= htmlspecialchars($contact['first_name'] ?? 'Contact') ?>')">+ Task</button>
        <button class="btn btn-outline-info btn-sm" onclick="alert('Create opportunity for <?= htmlspecialchars($contact['company'] ?? 'this contact') ?>')">üíº Opp</button>
      </div>
    </div>
  </div>

  <?php if ($saveSuccess): ?>
    <div class="success-alert">‚úì Changes saved successfully.</div>
  <?php endif; ?>

  <!-- Stats Bar -->

  <div class="row row-cols-1 row-cols-md-4 g-3 mb-4">
    <div class="col">
      <div class="card text-center p-3">
        <div class="text-muted small">Status</div>
        <div class="fw-bold fs-5"><?= $status ?></div>
      </div>
    </div>
    <div class="col">
      <div class="card text-center p-3">
        <div class="text-muted small">Created</div>
        <div class="fw-bold fs-5"><?= substr($createdAt, 0, 10) ?></div>
      </div>
    </div>
    <div class="col">
      <div class="card text-center p-3">
        <div class="text-muted small">Opportunities</div>
        <div class="fw-bold fs-5"><?= count($contactOpportunities) ?></div>
      </div>
    </div>
    <div class="col">
      <div class="card text-center p-3">
        <div class="text-muted small">Total Value</div>
        <div class="fw-bold fs-5"><?= $opportunityValue > 0 ? formatCurrency($opportunityValue) : '‚Äî' ?></div>
      </div>
    </div>
  </div>

  <!-- ACCORDION SECTIONS -->
  
  <!-- Overview Section -->
  <div class="accordion" style="margin-bottom: 32px;">
    <div class="accordion-header active" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>üìã</span>
        <span>Overview</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content active">
      <div class="accordion-body">
        <div class="section" style="margin-bottom: 32px;">
          <div class="section-title">üìç Location & Contact</div>
          <div class="field-grid">
            <div class="field">
              <div class="field-label">Email</div>
              <div class="field-value <?= empty($contact['email']) ? 'empty' : '' ?>">
                <?= $contact['email'] ? '<a href="mailto:' . htmlspecialchars($contact['email']) . '" style="color:#3B82F6;">' . htmlspecialchars($contact['email']) . '</a>' : '‚Äî' ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Phone</div>
              <div class="field-value <?= empty($contact['phone']) ? 'empty' : '' ?>">
                <?= $contact['phone'] ? '<a href="tel:' . htmlspecialchars($contact['phone']) . '" style="color:#3B82F6;">' . htmlspecialchars($contact['phone']) . '</a>' : '‚Äî' ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">City</div>
              <div class="field-value <?= empty($contact['city']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['city'] ?? '‚Äî') ?></div>
            </div>
            <div class="field">
              <div class="field-label">Province</div>
              <div class="field-value <?= empty($contact['province']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['province'] ?? '‚Äî') ?></div>
            </div>
            <div class="field">
              <div class="field-label">Postal Code</div>
              <div class="field-value <?= empty($contact['postal_code']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['postal_code'] ?? '‚Äî') ?></div>
            </div>
            <div class="field">
              <div class="field-label">Country</div>
              <div class="field-value <?= empty($contact['country']) ? 'empty' : '' ?>"><?= htmlspecialchars($contact['country'] ?? '‚Äî') ?></div>
            </div>
          </div>
        </div>

        <div class="section" style="margin-bottom: 32px;">
          <div class="section-title">üîñ Tags</div>
          <div class="tags-container">
            <?php foreach ($tags as $tag): ?>
              <span class="tag"><?= htmlspecialchars($tag) ?></span>
            <?php endforeach; ?>
            <?php if (empty($tags)): ?>
              <p style="font-size: 12px; color: #999; margin: 0;">No tags</p>
            <?php endif; ?>
          </div>
        </div>

        <div class="section" style="margin-bottom: 32px;">
          <div class="section-title">üìä Quick Stats</div>
          <div class="field-grid">
            <div class="field">
              <div class="field-label">Total Value</div>
              <div class="field-value" style="color: #28a745; font-weight: 600; font-size: 16px;">
                <?= formatCurrency($opportunityValue) ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Open Opportunities</div>
              <div class="field-value" style="color: #3B82F6; font-weight: 600; font-size: 16px;">
                <?= count($contactOpportunities) ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Discussions</div>
              <div class="field-value" style="color: #8B5CF6; font-weight: 600; font-size: 16px;">
                <?= count($contactDiscussions) ?>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Member Since</div>
              <div class="field-value" style="color: #666; font-size: 13px;">
                <?= date('M d, Y', strtotime($createdAt)) ?>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">üìù Notes</div>
          <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 13px; line-height: 1.5;">
            <?= $contact['notes'] ? htmlspecialchars($contact['notes']) : '<span style="color: #ccc;">No notes</span>' ?>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Details Section -->
  <div class="accordion" style="margin-bottom: 32px;">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>‚úèÔ∏è</span>
        <span>Edit Contact Details</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content">
      <div class="accordion-body">
        <form method="post">
          <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

          <!-- Quick Status Section -->
          <div class="form-section" style="background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border: 1px solid #bfdbfe; padding: 18px; margin-bottom: 28px; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 12px;">
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üìÖ Created</div>
                <div style="color: #666;"><?= date('M d, Y', strtotime($createdAt)) ?></div>
              </div>
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üîÑ Last Modified</div>
                <div style="color: #666;"><?= $lastModified ? date('M d, Y', strtotime($lastModified)) : '‚Äî' ?></div>
              </div>
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üíº Opportunities</div>
                <div style="color: #666;"><?= count($contactOpportunities) ?> active</div>
              </div>
              <div>
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üí¨ Discussions</div>
                <div style="color: #666;"><?= count($contactDiscussions) ?> logged</div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üë§ Personal Information</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" value="<?= htmlspecialchars($contact['first_name'] ?? '') ?>" aria-label="First Name" aria-required="false">
                <span class="keyboard-hint">Tab to next field</span>
              </div>
              <div class="form-group">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" value="<?= htmlspecialchars($contact['last_name'] ?? '') ?>" aria-label="Last Name" aria-required="true">
                <span class="keyboard-hint">Tab to next field</span>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="<?= htmlspecialchars($contact['email'] ?? '') ?>" aria-label="Email" aria-required="true">
                <span class="keyboard-hint">Tab to next field</span>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" value="<?= htmlspecialchars($contact['phone'] ?? '') ?>" aria-label="Phone" aria-required="true">
                <span class="keyboard-hint">Tab to next field</span>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üè¢ Company Information</h3>
            <div class="form-grid">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="company">Company</label>
                <input type="text" id="company" name="company" value="<?= htmlspecialchars($contact['company'] ?? '') ?>" aria-label="Company" aria-required="true">
                <span class="keyboard-hint">Tab to next field</span>
              </div>
              <div class="form-group">
                <label for="tank_number">Tank Number</label>
                <input type="text" id="tank_number" name="tank_number" value="<?= htmlspecialchars($contact['tank_number'] ?? '') ?>" aria-label="Tank Number" aria-required="false">
                <span class="keyboard-hint">Tab to next field</span>
              </div>
              <div class="form-group">
                <label>Delivery Date</label>
                <input type="text" name="delivery_date" placeholder="YYYY-MM-DD" value="<?= htmlspecialchars($contact['delivery_date'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Status</label>
                <select name="status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                  <option value=""></option>
                  <option value="Active" <?= ($contact['status'] ?? '') === 'Active' ? 'selected' : '' ?>>Active</option>
                  <option value="Inactive" <?= ($contact['status'] ?? '') === 'Inactive' ? 'selected' : '' ?>>Inactive</option>
                  <option value="Prospect" <?= ($contact['status'] ?? '') === 'Prospect' ? 'selected' : '' ?>>Prospect</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üìç Address</h3>
            <div class="form-group" style="margin-bottom: 12px;">
              <label>Address</label>
              <input type="text" name="address" value="<?= htmlspecialchars($contact['address'] ?? '') ?>">
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>City</label>
                <input type="text" name="city" value="<?= htmlspecialchars($contact['city'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Province/State</label>
                <input type="text" name="province" value="<?= htmlspecialchars($contact['province'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Postal Code</label>
                <input type="text" name="postal_code" value="<?= htmlspecialchars($contact['postal_code'] ?? '') ?>">
              </div>
              <div class="form-group">
                <label>Country</label>
                <input type="text" name="country" value="<?= htmlspecialchars($contact['country'] ?? '') ?>">
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%;">
            <div class="form-section">
              <h3>üîñ Tags</h3>
              <div class="tags-container" style="margin-bottom: 10px;">
                <?php foreach ($tags as $tag): ?>
                  <span class="tag"><?= htmlspecialchars($tag) ?> <span class="tag-remove" onclick="removeTag(this)">‚úï</span></span>
                <?php endforeach; ?>
                <span class="tag-new" onclick="addNewTag(this)">+ Add tag</span>
              </div>
              <input type="hidden" name="tags" id="tags_input" value="<?= htmlspecialchars($contact['tags'] ?? '') ?>">
            </div>

            <div class="form-section">
              <h3>‚≠ê Customer Status</h3>
              <div style="padding: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                  <input type="checkbox" name="is_customer" value="1" <?= ($isCustomer ? 'checked' : '') ?> style="width: 16px; height: 16px; cursor: pointer;">
                  <span>Is an Active Customer</span>
                </label>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>üìù Notes</h3>
            <div class="form-group">
              <label>Additional Notes</label>
              <textarea name="notes" rows="5"><?= htmlspecialchars($contact['notes'] ?? '') ?></textarea>
            </div>
          </div>

          <div class="submit-actions">
            <button type="submit" class="btn-primary">üíæ Save Changes</button>
            <a href="contacts_list.php" class="btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Opportunities Section -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>üíº</span>
        <span>Opportunities (<?= count($contactOpportunities) ?>)</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content">
      <div class="accordion-body">
        <div class="section">
          <div class="section-title">üíº Linked Opportunities</div>
          <?php if (!empty($contactOpportunities)): ?>
            <?php foreach ($contactOpportunities as $opp): ?>
              <div class="opportunity">
                <div class="opportunity-title">Opportunity #<?= htmlspecialchars($opp['id']) ?></div>
                <div class="opportunity-details">
                  <strong>Stage:</strong> <?= htmlspecialchars($opp['stage'] ?? '‚Äî') ?> 
                  (<?= htmlspecialchars($opp['probability'] ?? '0') ?>%)
                </div>
                <div class="opportunity-details" style="margin-top: 4px;">
                  <strong>Expected Close:</strong> <?= htmlspecialchars($opp['expected_close'] ?? '‚Äî') ?>
                </div>
                <div class="opportunity-value">
                  <?= formatCurrency($opp['value'] ?? 0) ?>
                </div>
              </div>
            <?php endforeach; ?>
            <div style="padding: 10px; background: #f0f7ff; border-radius: 4px; margin-top: 12px; font-size: 12px; color: #666;">
              <strong style="color: #1976d2;">Total Opportunity Value:</strong> <?= formatCurrency($opportunityValue) ?>
            </div>
          <?php else: ?>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 4px; color: #999; text-align: center; font-size: 13px;">
              No opportunities linked to this contact yet.
            </div>
          <?php endif; ?>
        </div>
      </div>
    </div>
  </div>

  <!-- Discussions Section -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <div class="accordion-title">
        <span>üí¨</span>
        <span>Discussions (<?= count($contactDiscussions) ?>)</span>
      </div>
      <div class="accordion-icon">‚ñ∂</div>
    </div>
    <div class="accordion-content">
      <div class="accordion-body">
        <!-- Add Discussion Form -->
        <div class="section">
          <div class="section-title">‚ûï Log Discussion</div>
          <form method="post" action="discussion_logger.php" style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
            <input type="hidden" name="contact_id" value="<?= htmlspecialchars($contact['id']) ?>">
            
            <div class="form-group" style="margin-bottom: 12px;">
              <label>Author</label>
              <input type="text" name="author" placeholder="Your name" value="<?= isset($_SESSION['username']) ? htmlspecialchars($_SESSION['username']) : '' ?>" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
              <label>Discussion Notes</label>
              <textarea name="entry_text" placeholder="What was discussed?" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-family: inherit; font-size: 13px;" rows="4"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
              <label>Visibility</label>
              <select name="visibility" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-family: inherit; font-size: 13px;">
                <option value="public">Public (Visible to all)</option>
                <option value="internal">Internal (Team only)</option>
                <option value="private">Private (Only me)</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>Linked Opportunity (Optional)</label>
              <select name="linked_opportunity_id" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-family: inherit; font-size: 13px;">
                <option value="">‚Äî No opportunity</option>
                <?php foreach ($contactOpportunities as $opp): ?>
                  <option value="<?= htmlspecialchars($opp['id']) ?>">Opportunity #<?= htmlspecialchars($opp['id']) ?> (<?= htmlspecialchars($opp['stage']) ?>)</option>
                <?php endforeach; ?>
              </select>
            </div>

            <button type="submit" style="margin-top: 12px; background: #3B82F6; color: white; border: none; padding: 10px 18px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">üí¨ Log Discussion</button>
          </form>
        </div>

        <!-- Discussion History -->
        <div class="section">
          <div class="section-title">üìù Discussion History</div>
          <?php if (!empty($contactDiscussions)): ?>
            <?php foreach ($contactDiscussions as $disc): ?>
              <div class="timeline-item" style="padding: 15px; margin-bottom: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3B82F6;">
                <div style="width: 100%;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <strong style="color: #1a1a1a; font-size: 14px;"><?= htmlspecialchars($disc['author'] ?? 'Unknown') ?></strong>
                    <span style="background: <?= ($disc['visibility'] ?? 'public') === 'public' ? '#e3f2fd' : (($disc['visibility'] ?? '') === 'internal' ? '#fff3cd' : '#f8d7da') ?>; color: <?= ($disc['visibility'] ?? 'public') === 'public' ? '#1976d2' : (($disc['visibility'] ?? '') === 'internal' ? '#856404' : '#721c24') ?>; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase;">
                      <?= htmlspecialchars($disc['visibility'] ?? 'public') ?>
                    </span>
                  </div>
                  <div style="color: #666; font-size: 11px; margin-bottom: 8px;">
                    üìÖ <?= htmlspecialchars($disc['timestamp'] ?? '‚Äî') ?>
                  </div>
                  <div style="color: #1a1a1a; font-size: 13px; line-height: 1.5; margin-bottom: 6px;">
                    <?= nl2br(htmlspecialchars($disc['entry_text'] ?? '')) ?>
                  </div>
                  <?php if (!empty($disc['linked_opportunity_id'])): ?>
                    <div style="margin-top: 8px; padding: 8px; background: white; border-left: 3px solid #10B981; border-radius: 3px; font-size: 11px; color: #666;">
                      <strong>üìé Linked to Opportunity #<?= htmlspecialchars($disc['linked_opportunity_id']) ?></strong>
                    </div>
                  <?php endif; ?>
                </div>
              </div>
            <?php endforeach; ?>
          <?php else: ?>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 4px; color: #999; text-align: center; font-size: 13px;">
              No discussions logged yet. Start by adding the first discussion above.
            </div>
          <?php endif; ?>
        </div>
      </div>
    </div>
</div>

<script>
  // Accordion toggle function
  function toggleAccordion(header) {
    const content = header.nextElementSibling;
    
    // Toggle current accordion
    header.classList.toggle('active');
    content.classList.toggle('active');
  }

  // Tag management
  function addNewTag(element) {
    const tagName = prompt('Enter tag name:');
    if (tagName && tagName.trim()) {
      const tagsInput = document.getElementById('tags_input');
      const currentTags = tagsInput.value ? tagsInput.value.split(',').map(t => t.trim()) : [];
      currentTags.push(tagName.trim());
      tagsInput.value = currentTags.join(',');
      location.reload();
    }
  }

  function removeTag(element) {
    const tagsInput = document.getElementById('tags_input');
    const tagName = element.previousSibling.textContent.trim();
    const currentTags = tagsInput.value.split(',').map(t => t.trim());
    const filtered = currentTags.filter(t => t !== tagName);
    tagsInput.value = filtered.join(',');
    location.reload();
  }

  // Auto-expand textareas based on content
  const textareas = document.querySelectorAll('.form-group textarea');
  textareas.forEach(textarea => {
    function adjustHeight() {
      textarea.style.height = 'auto';
      textarea.style.height = Math.max(150, textarea.scrollHeight) + 'px';
    }
    
    textarea.addEventListener('input', adjustHeight);
    textarea.addEventListener('change', adjustHeight);
    adjustHeight(); // Initial adjustment
  });

  // Auto-adjust input widths based on content
  const inputs = document.querySelectorAll('.form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"], .form-group input[type="number"]');
  inputs.forEach(input => {
    function adjustWidth() {
      const length = input.value.length;
      const charWidth = 9;
      const minWidth = 280;
      input.style.minWidth = Math.max(minWidth, length * charWidth + 60) + 'px';
    }
    
    input.addEventListener('input', adjustWidth);
    input.addEventListener('change', adjustWidth);
    adjustWidth(); // Initial adjustment
  });
</script>

<?php include_once('layout_end.php'); ?>


--- End of contact_view.php ---



--- Start of contracts_list.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Service Contracts';
$currentPage = basename(__FILE__);

// Load data
$contractSchema = require __DIR__ . '/contract_schema.php';
$contracts = readCSV('contracts.csv', $contractSchema) ?: [];
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$customers = readCSV('customers.csv', require __DIR__ . '/customer_schema.php');

// Calculate contract metrics
$totalActive = 0;
$totalMRR = 0;
$totalARR = 0;
$expiringCount = 0;
$today = strtotime(date('Y-m-d'));
$thirtyDaysOut = strtotime('+30 days');
$ninetyDaysOut = strtotime('+90 days');

foreach ($contracts as &$contract) {
    // Calculate days until expiry
    if (!empty($contract['end_date'])) {
        $endDate = strtotime($contract['end_date']);
        $daysToExpiry = round(($endDate - $today) / 86400);
        $contract['days_to_expiry'] = $daysToExpiry;
        
        // Set expiry status
        if ($daysToExpiry < 0) {
            $contract['expiry_status'] = 'expired';
        } elseif ($daysToExpiry <= 30) {
            $contract['expiry_status'] = 'critical';
            $expiringCount++;
        } elseif ($daysToExpiry <= 90) {
            $contract['expiry_status'] = 'warning';
            $expiringCount++;
        } else {
            $contract['expiry_status'] = 'normal';
        }
    }
    
    // Calculate metrics for active contracts
    if ($contract['contract_status'] === 'Active') {
        $totalActive++;
        $totalMRR += (float)($contract['monthly_fee'] ?? 0);
        $totalARR += (float)($contract['annual_value'] ?? 0);
    }
}
?>

<style>
.contracts-header {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.contracts-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #10B981;
}

.metric-card.warning {
    border-left-color: #F59E0B;
}

.metric-card.critical {
    border-left-color: #EF4444;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    color: #1F2937;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-group select,
.filter-group input {
    padding: 10px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    border: none;
    font-size: 14px;
}

.btn-primary {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.contracts-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.contracts-table table {
    width: 100%;
    border-collapse: collapse;
}

.contracts-table th {
    background: #F9FAFB;
    padding: 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #E5E7EB;
}

.contracts-table td {
    padding: 16px;
    border-bottom: 1px solid #F3F4F6;
    font-size: 14px;
}

.contracts-table tr:hover {
    background: #F9FAFB;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-active {
    background: #D1FAE5;
    color: #065F46;
}

.status-expiring {
    background: #FEF3C7;
    color: #92400E;
}

.status-expired {
    background: #FEE2E2;
    color: #991B1B;
}

.status-cancelled {
    background: #E5E7EB;
    color: #374151;
}

.expiry-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
}

.expiry-normal {
    background: #D1FAE5;
    color: #065F46;
}

.expiry-warning {
    background: #FEF3C7;
    color: #92400E;
}

.expiry-critical {
    background: #FEE2E2;
    color: #991B1B;
}

.expiry-expired {
    background: #E5E7EB;
    color: #374151;
}

.action-btns {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}

.action-btn-view {
    background: #EFF6FF;
    color: #1E40AF;
}

.action-btn-view:hover {
    background: #DBEAFE;
}

.action-btn-edit {
    background: #FEF3C7;
    color: #92400E;
}

.action-btn-edit:hover {
    background: #FDE68A;
}

.action-btn-renew {
    background: #D1FAE5;
    color: #065F46;
}

.action-btn-renew:hover {
    background: #A7F3D0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .action-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-direction: column;
    }
}
</style>

<div class="contracts-header">
    <h1>üìã Service Contracts</h1>
    <p>Manage SDI service agreements and equipment rentals</p>
</div>

<!-- Metrics Dashboard -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Active Contracts</div>
        <div class="metric-value"><?= $totalActive ?></div>
        <div class="metric-subtext">Current active agreements</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Monthly Recurring Revenue</div>
        <div class="metric-value">$<?= number_format($totalMRR, 0) ?></div>
        <div class="metric-subtext">MRR from active contracts</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Annual Contract Value</div>
        <div class="metric-value">$<?= number_format($totalARR, 0) ?></div>
        <div class="metric-subtext">Total ARR from contracts</div>
    </div>
    
    <div class="metric-card <?= $expiringCount > 0 ? 'warning' : '' ?>">
        <div class="metric-label">Expiring Soon</div>
        <div class="metric-value"><?= $expiringCount ?></div>
        <div class="metric-subtext">Within 90 days</div>
    </div>
</div>

<!-- Action Bar -->
<div class="action-bar">
    <div class="filter-group">
        <select id="statusFilter" onchange="filterContracts()">
            <option value="">All Statuses</option>
            <option value="Active">Active</option>
            <option value="Expiring">Expiring</option>
            <option value="Expired">Expired</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        
        <select id="typeFilter" onchange="filterContracts()">
            <option value="">All Types</option>
            <option value="New">New</option>
            <option value="Renewal">Renewal</option>
            <option value="Upsell">Upsell</option>
        </select>
        
        <input type="text" id="searchInput" placeholder="Search contracts..." onkeyup="filterContracts()">
    </div>
    
    <a href="contract_form.php" class="btn btn-primary">‚ûï Add New Contract</a>
</div>

<!-- Contracts Table -->
<div class="contracts-table">
    <?php if (empty($contracts)): ?>
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>No Service Contracts Yet</h3>
            <p>Start by creating your first service contract</p>
            <a href="contract_form.php" class="btn btn-primary" style="margin-top: 20px;">‚ûï Add First Contract</a>
        </div>
    <?php else: ?>
        <table id="contractsTable">
            <thead>
                <tr>
                    <th>Contract ID</th>
                    <th>Customer/Contact</th>
                    <th>Equipment Type</th>
                    <th>Monthly Fee</th>
                    <th>Status</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Days to Expiry</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($contracts as $contract): ?>
                    <?php
                    // Find contact name
                    $contactName = 'Unknown';
                    foreach ($contacts as $c) {
                        if ($c['id'] === $contract['contact_id']) {
                            $contactName = trim($c['first_name'] . ' ' . $c['last_name']);
                            break;
                        }
                    }
                    
                    // Determine status display
                    $statusClass = 'status-' . strtolower(str_replace(' ', '-', $contract['contract_status']));
                    $expiryClass = 'expiry-' . ($contract['expiry_status'] ?? 'normal');
                    ?>
                    <tr data-status="<?= htmlspecialchars($contract['contract_status']) ?>" 
                        data-type="<?= htmlspecialchars($contract['contract_type']) ?>">
                        <td><strong><?= htmlspecialchars($contract['contract_id']) ?></strong></td>
                        <td><?= htmlspecialchars($contactName) ?></td>
                        <td><?= htmlspecialchars($contract['equipment_type']) ?></td>
                        <td><strong>$<?= number_format((float)$contract['monthly_fee'], 2) ?></strong></td>
                        <td>
                            <span class="status-badge <?= $statusClass ?>">
                                <?= htmlspecialchars($contract['contract_status']) ?>
                            </span>
                        </td>
                        <td><?= htmlspecialchars($contract['start_date']) ?></td>
                        <td><?= htmlspecialchars($contract['end_date']) ?></td>
                        <td>
                            <?php if (isset($contract['days_to_expiry'])): ?>
                                <span class="expiry-badge <?= $expiryClass ?>">
                                    <?php if ($contract['days_to_expiry'] < 0): ?>
                                        Expired
                                    <?php else: ?>
                                        <?= $contract['days_to_expiry'] ?> days
                                    <?php endif; ?>
                                </span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <div class="action-btns">
                                <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" 
                                   class="action-btn action-btn-view">View</a>
                                <a href="contract_edit.php?id=<?= urlencode($contract['contract_id']) ?>" 
                                   class="action-btn action-btn-edit">Edit</a>
                                <?php if ($contract['contract_status'] === 'Active' && isset($contract['days_to_expiry']) && $contract['days_to_expiry'] <= 90): ?>
                                    <a href="contract_renew.php?id=<?= urlencode($contract['contract_id']) ?>" 
                                       class="action-btn action-btn-renew">Renew</a>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>
</div>

<script>
function filterContracts() {
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const table = document.getElementById('contractsTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const status = row.getAttribute('data-status').toLowerCase();
        const type = row.getAttribute('data-type').toLowerCase();
        const text = row.textContent.toLowerCase();
        
        let showRow = true;
        
        if (statusFilter && status !== statusFilter) showRow = false;
        if (typeFilter && type !== typeFilter) showRow = false;
        if (searchInput && !text.includes(searchInput)) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
    }
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contracts_list.php ---



--- Start of contract_form.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Add Service Contract';
$contractSchema = require __DIR__ . '/contract_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$customers = readCSV('customers.csv', require __DIR__ . '/customer_schema.php');
$equipment = readCSV('equipment.csv', require __DIR__ . '/equipment_schema.php') ?: [];

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $contracts = readCSV('contracts.csv', $contractSchema) ?: [];
    
    // Generate contract ID
    $contractId = 'CNT-' . date('Ymd') . '-' . str_pad(count($contracts) + 1, 4, '0', STR_PAD_LEFT);
    
    // Calculate values
    $monthlyFee = (float)$_POST['monthly_fee'];
    $contractTerm = (int)$_POST['contract_term'];
    $annualValue = $monthlyFee * 12;
    
    // Calculate end date
    $startDate = $_POST['start_date'];
    $endDate = date('Y-m-d', strtotime($startDate . ' + ' . $contractTerm . ' months'));
    
    // Calculate renewal date (end date - notice period)
    $noticePeriod = (int)$_POST['notice_period'];
    $renewalDate = date('Y-m-d', strtotime($endDate . ' - ' . $noticePeriod . ' days'));
    
    $newContract = [
        'contract_id' => $contractId,
        'contact_id' => $_POST['contact_id'],
        'customer_id' => $_POST['customer_id'] ?? '',
        'contract_type' => $_POST['contract_type'],
        'contract_status' => 'Active',
        'equipment_type' => $_POST['equipment_type'],
        'monthly_fee' => $monthlyFee,
        'annual_value' => $annualValue,
        'payment_frequency' => $_POST['payment_frequency'],
        'contract_term' => $contractTerm,
        'start_date' => $startDate,
        'end_date' => $endDate,
        'renewal_date' => $renewalDate,
        'auto_renew' => $_POST['auto_renew'] ?? 'No',
        'notice_period' => $noticePeriod,
        'evoqua_account' => $_POST['evoqua_account'] ?? '',
        'evoqua_contract' => $_POST['evoqua_contract'] ?? '',
        'equipment_ids' => $_POST['equipment_ids'] ?? '',
        'service_frequency' => $_POST['service_frequency'],
        'last_service_date' => $_POST['last_service_date'] ?? '',
        'next_service_date' => $_POST['next_service_date'] ?? '',
        'notes' => $_POST['notes'] ?? '',
        'created_date' => date('Y-m-d H:i:s'),
        'created_by' => $_SESSION['user_id'] ?? 'system',
        'modified_date' => date('Y-m-d H:i:s'),
        'modified_by' => $_SESSION['user_id'] ?? 'system'
    ];
    
    $contracts[] = $newContract;
    
    if (writeCSV('contracts.csv', $contracts, $contractSchema)) {
        header('Location: contracts_list.php?success=1');
        exit;
    } else {
        $error = 'Failed to save contract';
    }
}
?>

<style>
.page-header {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.form-container {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: 1200px;
}

.form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #E5E7EB;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #10B981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.calculated-value {
    background: #F0FDF4;
    padding: 16px;
    border-radius: 8px;
    border: 2px solid #10B981;
    font-weight: 700;
    color: #065F46;
    font-size: 20px;
}

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
}

.btn {
    padding: 14px 32px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-secondary {
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
}

.btn-secondary:hover {
    background: #E5E7EB;
}

.form-help {
    font-size: 12px;
    color: #6B7280;
    margin-top: 6px;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<a href="contracts_list.php" style="display: inline-flex; align-items: center; gap: 8px; color: #10B981; text-decoration: none; font-weight: 600; margin-bottom: 16px;">
    ‚Üê Back to Contracts
</a>

<div class="page-header">
    <h1>üìã Add Service Contract</h1>
    <p>Create a new SDI service agreement</p>
</div>

<?php if (isset($error)): ?>
    <div style="background: #FEE2E2; border: 2px solid #EF4444; color: #991B1B; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
        ‚ö†Ô∏è <?= htmlspecialchars($error) ?>
    </div>
<?php endif; ?>

<div class="form-container">
    <form method="POST" id="contractForm">
        <!-- Contact & Customer Information -->
        <div class="form-section">
            <div class="form-section-title">üë§ Contact & Customer Information</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="contact_id">Contact *</label>
                    <select name="contact_id" id="contact_id" required>
                        <option value="">Select Contact</option>
                        <?php foreach ($contacts as $contact): ?>
                            <option value="<?= htmlspecialchars($contact['id']) ?>">
                                <?= htmlspecialchars(trim($contact['first_name'] . ' ' . $contact['last_name'])) ?> 
                                <?php if (!empty($contact['company'])): ?>
                                    - <?= htmlspecialchars($contact['company']) ?>
                                <?php endif; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customer_id">Customer ID (Optional)</label>
                    <input type="text" name="customer_id" id="customer_id">
                    <div class="form-help">Leave blank if contact is the customer</div>
                </div>
            </div>
        </div>
        
        <!-- Contract Details -->
        <div class="form-section">
            <div class="form-section-title">üìÑ Contract Details</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="contract_type">Contract Type *</label>
                    <select name="contract_type" id="contract_type" required>
                        <option value="">Select Type</option>
                        <option value="New">New Contract</option>
                        <option value="Renewal">Renewal</option>
                        <option value="Upsell">Upsell</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="equipment_type">Equipment Type *</label>
                    <select name="equipment_type" id="equipment_type" required>
                        <option value="">Select Equipment</option>
                        <option value="Softener">Water Softener</option>
                        <option value="RO System">RO System</option>
                        <option value="Filtration">Filtration System</option>
                        <option value="DI System">DI System</option>
                        <option value="Mixed Systems">Mixed Systems</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="monthly_fee">Monthly Fee ($) *</label>
                    <input type="number" name="monthly_fee" id="monthly_fee" step="0.01" min="0" required 
                           onchange="calculateAnnualValue()">
                </div>
                
                <div class="form-group">
                    <label for="annual_value">Annual Contract Value ($)</label>
                    <div class="calculated-value" id="annual_value_display">$0.00</div>
                    <div class="form-help">Calculated automatically</div>
                </div>
                
                <div class="form-group">
                    <label for="payment_frequency">Payment Frequency *</label>
                    <select name="payment_frequency" id="payment_frequency" required>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="contract_term">Contract Term (Months) *</label>
                    <select name="contract_term" id="contract_term" required onchange="calculateDates()">
                        <option value="12">12 Months</option>
                        <option value="24">24 Months</option>
                        <option value="36">36 Months</option>
                        <option value="48">48 Months</option>
                        <option value="60">60 Months</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Dates & Terms -->
        <div class="form-section">
            <div class="form-section-title">üìÖ Dates & Terms</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="start_date">Contract Start Date *</label>
                    <input type="date" name="start_date" id="start_date" required onchange="calculateDates()">
                </div>
                
                <div class="form-group">
                    <label for="end_date">Contract End Date</label>
                    <div class="calculated-value" id="end_date_display">Not calculated</div>
                    <div class="form-help">Calculated from start date + term</div>
                </div>
                
                <div class="form-group">
                    <label for="notice_period">Cancellation Notice Period (Days) *</label>
                    <select name="notice_period" id="notice_period" required onchange="calculateDates()">
                        <option value="30">30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="renewal_date">Renewal Notification Date</label>
                    <div class="calculated-value" id="renewal_date_display">Not calculated</div>
                    <div class="form-help">End date minus notice period</div>
                </div>
                
                <div class="form-group">
                    <label for="auto_renew">Auto-Renewal</label>
                    <select name="auto_renew" id="auto_renew">
                        <option value="Yes">Yes - Auto Renew</option>
                        <option value="No">No - Manual Renewal</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Evoqua Details -->
        <div class="form-section">
            <div class="form-section-title">üè¢ Evoqua Details</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="evoqua_account">Evoqua Account Number</label>
                    <input type="text" name="evoqua_account" id="evoqua_account">
                </div>
                
                <div class="form-group">
                    <label for="evoqua_contract">Evoqua Contract Number</label>
                    <input type="text" name="evoqua_contract" id="evoqua_contract">
                </div>
            </div>
        </div>
        
        <!-- Service Schedule -->
        <div class="form-section">
            <div class="form-section-title">üîß Service Schedule</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="service_frequency">Service Frequency *</label>
                    <select name="service_frequency" id="service_frequency" required>
                        <option value="Weekly">Weekly</option>
                        <option value="Bi-weekly">Bi-weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Semi-Annual">Semi-Annual</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="next_service_date">Next Service Date</label>
                    <input type="date" name="next_service_date" id="next_service_date">
                </div>
                
                <div class="form-group full-width">
                    <label for="notes">Contract Notes</label>
                    <textarea name="notes" id="notes" placeholder="Additional contract notes, special terms, etc."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ Create Contract</button>
            <a href="contracts_list.php" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function calculateAnnualValue() {
    const monthlyFee = parseFloat(document.getElementById('monthly_fee').value) || 0;
    const annualValue = monthlyFee * 12;
    document.getElementById('annual_value_display').textContent = '$' + annualValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function calculateDates() {
    const startDate = document.getElementById('start_date').value;
    const termMonths = parseInt(document.getElementById('contract_term').value);
    const noticeDays = parseInt(document.getElementById('notice_period').value);
    
    if (!startDate || !termMonths) return;
    
    // Calculate end date
    const start = new Date(startDate);
    const end = new Date(start);
    end.setMonth(end.getMonth() + termMonths);
    
    const endDateStr = end.toISOString().split('T')[0];
    document.getElementById('end_date_display').textContent = endDateStr;
    
    // Calculate renewal date
    const renewal = new Date(end);
    renewal.setDate(renewal.getDate() - noticeDays);
    const renewalDateStr = renewal.toISOString().split('T')[0];
    document.getElementById('renewal_date_display').textContent = renewalDateStr;
}

// Set default start date to today
document.getElementById('start_date').valueAsDate = new Date();
calculateDates();
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contract_form.php ---



--- Start of contract_schema.php ---

<?php
/**
 * Service Contract Schema - SDI Business Model
 * Tracks recurring service agreements with Evoqua equipment
 */
return [
    'contract_id',          // Unique identifier
    'contact_id',           // Link to contact
    'customer_id',          // Link to customer  
    'contract_type',        // New / Renewal / Upsell
    'contract_status',      // Draft / Active / Expiring / Expired / Cancelled
    'equipment_type',       // Softener / RO System / Filtration / DI System / Other
    'monthly_fee',          // Monthly recurring revenue
    'annual_value',         // Total annual contract value
    'payment_frequency',    // Monthly / Quarterly / Annual
    'contract_term',        // Term length in months (12/24/36/etc)
    'start_date',          // Contract start date
    'end_date',            // Contract end date
    'renewal_date',        // Auto-renewal date
    'auto_renew',          // Yes / No
    'notice_period',       // Cancellation notice period (days)
    'evoqua_account',      // Evoqua account number
    'evoqua_contract',     // Evoqua contract number
    'equipment_ids',       // Comma-separated equipment IDs
    'service_frequency',   // Weekly / Bi-weekly / Monthly / Quarterly
    'last_service_date',   // Most recent service visit
    'next_service_date',   // Scheduled next service
    'notes',               // Additional contract notes
    'created_date',        // Contract creation date
    'created_by',          // User who created contract
    'modified_date',       // Last modification date
    'modified_by'          // User who last modified
];


--- End of contract_schema.php ---



--- Start of csrf_helper.php ---

<?php
/**
 * CSRF Protection Helper Functions
 * Prevents Cross-Site Request Forgery attacks
 */

// Ensure session is started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

/**
 * Initialize CSRF token in session
 */
function initializeCSRFToken() {
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

/**
 * Get the current CSRF token
 */
function getCSRFToken() {
    initializeCSRFToken();
    return $_SESSION['csrf_token'];
}

/**
 * Verify CSRF token from POST/REQUEST
 */
function verifyCSRFToken($token) {
    if (empty($_SESSION['csrf_token'])) {
        return false;
    }
    return hash_equals($_SESSION['csrf_token'], $token ?? '');
}

/**
 * Render hidden CSRF input field for HTML forms
 */
function renderCSRFInput() {
    $token = htmlspecialchars(getCSRFToken(), ENT_QUOTES, 'UTF-8');
    echo '<input type="hidden" name="csrf_token" value="' . $token . '">';
}

/**
 * Get CSRF token as escaped attribute value (for data attributes, etc)
 */
function getCSRFTokenAttribute() {
    return htmlspecialchars(getCSRFToken(), ENT_QUOTES, 'UTF-8');
}
?>


--- End of csrf_helper.php ---



--- Start of csv_export.php ---

function exportCSVFiltered($filename, $rows, $filters = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered));
}


--- End of csv_export.php ---



--- Start of csv_handler.php ---

<?php

// Include backup system if available
if (file_exists(__DIR__ . '/backup_handler.php')) {
    require_once __DIR__ . '/backup_handler.php';
}

function readCSV($filename, $schema) {
    if (!file_exists($filename)) {
        echo "File not found: $filename";
        return [];
    }

    $rows = [];
    if (($handle = fopen($filename, 'r')) !== false) {
        $headers = fgetcsv($handle);
        if ($headers === false) {
            echo "Failed to read headers.";
            return [];
        }

        while (($data = fgetcsv($handle)) !== false) {
            // Pad or trim data to match header count
            if (count($data) < count($headers)) {
                $data = array_pad($data, count($headers), '');
            } else if (count($data) > count($headers)) {
                $data = array_slice($data, 0, count($headers));
            }
            
            $row = array_combine($headers, $data);
            $rows[] = $row;
        }
        fclose($handle);
    }
    return $rows;
}

function writeCSV($filename, $data, $schema) {
    // ‚úÖ BACKUP: Create backup before modifying
    if (file_exists($filename) && function_exists('createBackup')) {
        createBackup($filename);
    }
    
    $file = fopen($filename, 'w');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");

    // ‚úÖ Write header row first
    fputcsv($file, $schema);

    foreach ($data as $row) {
        $csvRow = [];
        foreach ($schema as $field) {
            $value = $row[$field] ?? '';
            // Prevent CSV injection
            if (preg_match('/^[=+\-@]/', $value)) {
                $value = "'" . $value;
            }
            $csvRow[] = $value;
        }
        fputcsv($file, $csvRow);
    }

    fclose($file);
}


function appendCSV($filename, $row) {
    $file = fopen($filename, 'a');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    fputcsv($file, $row);
    fclose($file);
}

/**
 * ‚úÖ SAFE VERSION: Read CSV from file handle with file locking
 * For use with locked file operations to prevent race conditions
 */
function readCsvFromHandle($handle) {
    $data = [];
    rewind($handle);
    $header = fgetcsv($handle);
    
    if ($header === false) {
        return [];
    }
    
    while (($row = fgetcsv($handle)) !== false) {
        if (count($row) === count($header)) {
            $data[] = array_combine($header, $row);
        }
    }
    
    return $data;
}

/**
 * ‚úÖ SAFE VERSION: Write CSV to file handle with file locking
 * For use with locked file operations to prevent race conditions
 */
function writeCsvToHandle($handle, $data, $schema = null) {
    if ($schema === null) {
        // Fallback: derive schema from first row if available
        if (!empty($data) && is_array($data[0])) {
            $schema = array_keys($data[0]);
        } else {
            throw new Exception("Schema required for writeCsvToHandle");
        }
    }
    
    // Truncate and rewind
    ftruncate($handle, 0);
    rewind($handle);
    
    // Write header
    fputcsv($handle, $schema);
    
    // Write data rows with CSV injection prevention
    foreach ($data as $row) {
        $sanitized = [];
        foreach ($row as $key => $value) {
            // Prevent CSV injection
            if (is_string($value) && preg_match('/^[\r\n]*[=+\-@]/', $value)) {
                $value = "'" . $value;
            }
            $sanitized[] = $value;
        }
        fputcsv($handle, $sanitized);
    }
}

/**
 * ‚úÖ LOCKED READ-MODIFY-WRITE: Atomic CSV operation with file locking
 * Prevents race condition where changes are lost due to concurrent access
 */
function readModifyWriteCSV($filename, $schema, $callback) {
    // ‚úÖ BACKUP: Create backup before any modification
    if (file_exists($filename) && function_exists('createBackup')) {
        createBackup($filename);
    }
    
    $handle = fopen($filename, 'c+b');
    
    if (!$handle) {
        throw new Exception("Unable to open file: $filename");
    }
    
    // Acquire exclusive lock (blocks until lock is available)
    if (!flock($handle, LOCK_EX)) {
        fclose($handle);
        throw new Exception("Unable to acquire lock on file: $filename");
    }
    
    try {
        // Read current data
        $data = readCsvFromHandle($handle);
        
        // Apply callback to modify data
        $data = $callback($data);
        
        // Write back atomically
        writeCsvToHandle($handle, $data, $schema);
        
        // Release lock
        flock($handle, LOCK_UN);
    } catch (Exception $e) {
        // Ensure lock is released even on error
        flock($handle, LOCK_UN);
        fclose($handle);
        throw $e;
    }
    
    fclose($handle);
    return $data;
}
?>

--- End of csv_handler.php ---



--- Start of csv_import.php ---

function importCSVWithSchema($filename, $schema, $keyField, $existingRows) {
    $newRows = [];
    $imported = readCSV($filename);
    foreach ($imported as $row) {
        if (!array_diff($schema, array_keys($row)) && !in_array($row[$keyField], array_column($existingRows, $keyField))) {
            $newRows[] = $row;
        }
    }
    return $newRows;
}


--- End of csv_import.php ---



--- Start of customers_list.php ---

<?php
// customers_list.php

header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

include_once(__DIR__ . '/layout_start.php');
require_once __DIR__ . '/csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter only customers
$customers = array_filter($contacts, function($c) {
    return in_array(strtolower(trim($c['is_customer'] ?? '')), ['yes', 'true', '1']);
});
?>

<div class="container">
  <h2>Customer List</h2>

  <table class="table-grid">
    <thead>
      <tr>
		<th>Company</th>
        <th>First Name</th>
        <th>Email</th>
        <th>Customer Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($customers as $contact): ?>
        <tr>
          <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
		  <td><?= htmlspecialchars($contact['first_name'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['is_customer'] ?? '') ?></td>
          <td>
            <a href="customer_view.php?id=<?= urlencode($contact['id']) ?>" class="btn-primary">üëÅ View</a>
            <?php
              $deliveryFile = "{$contact['id']}_deliveries.csv";
              if (file_exists(__DIR__ . "/$deliveryFile")):
            ?>
              <a href="<?= htmlspecialchars($deliveryFile) ?>" class="btn-secondary" target="_blank">üì¶ Delivery Archive</a>
            <?php endif; ?>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="navigation">
    <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of customers_list.php ---



--- Start of customer_item_config.php ---

<?php
return [
  'tank_number',
  'tank_size',
  'type_of_resin',
  'delivery_date',
  'regeneration_number',
  'purchase_order'
];


--- End of customer_item_config.php ---



--- Start of customer_schema.php ---

<?php
return [
  'customer_id',
  'contact_name',
  'address',
  'tank_count',
  'last_delivery'
];


--- End of customer_schema.php ---



--- Start of customer_view.php ---

<?php


// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Includes
include_once(__DIR__ . '/layout_start.php');
require_once __DIR__ . '/csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Helper: find contact by ID
function findContactById($contacts, $id) {
    if ($id === '') return null;
    foreach ($contacts as $c) {
        if ($c['id'] === $id) return $c;
    }
    return null;
}

// Helper: create delivery file
function createDeliveryFileIfNeeded($contactId) {
    $deliveryFile = __DIR__ . "/{$contactId}_deliveries.csv";
    if (!file_exists($deliveryFile)) {
        $fp = fopen($deliveryFile, 'w');
        if ($fp) {
            fputcsv($fp, ['delivery_date', 'tank_number', 'tank_size']);
            fclose($fp);
            return true;
        } else {
            error_log("Failed to create delivery file for contact ID: $contactId");
            return false;
        }
    }
    return true;
}

// Handle contact update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['id'])) {
    $id = $_POST['id'];
    foreach ($contacts as &$c) {
        if ($c['id'] === $id) {
            foreach ($schema as $f) {
                $c[$f] = $_POST[$f] ?? $c[$f];
            }

            // Create delivery file if marked as customer
            if (isset($_POST['is_customer']) && strtolower(trim($_POST['is_customer'])) === 'yes') {
                if (!createDeliveryFileIfNeeded($id)) {
                    echo "<div class='alert-error'>‚ö†Ô∏è Delivery file could not be created for customer ID: $id</div>";
                }
            }

            break;
        }
    }
    writeCSV('contacts.csv', $contacts, $schema);
    header("Location: customer_view.php?id=" . urlencode($id));
    exit;
}

// Load contact
$id = $_GET['id'] ?? '';
$contact = findContactById($contacts, $id);

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once(__DIR__ . '/layout_end.php');
    exit;
}
?>

<div class="container">
    <h2>Customer Details</h2>
  
    <form method="post" class="contact-form" id="edit">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php elseif ($f === 'id'): ?>
            <input type="text" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>" disabled>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">üíæ Save Changes</button>
        </div>
    </form>

    <div class="customer-actions">
        <a href="customers_list.php" class="btn-outline">‚¨Ö Back to Customers</a>
        <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
        <?php
        $deliveryFile = "{$contact['id']}_deliveries.csv";
        if (file_exists(__DIR__ . "/$deliveryFile")) {
                echo '<a href="' . htmlspecialchars($deliveryFile) . '" class="btn-secondary" target="_blank">üì¶ View Deliveries</a>';
        }

        $isCustomer = strtolower(trim($contact['is_customer'] ?? '')) === 'yes';
        $deliveryFilePath = __DIR__ . "/$deliveryFile";
        if ($isCustomer && file_exists($deliveryFilePath)) {
                $deliveryUrl = "deliveries.php?id=" . urlencode($contact['id']);
                echo '<a href="' . $deliveryUrl . '" class="btn-primary">üì¶ View Delivery Archive</a>';
        }
        ?>
    </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>

--- End of customer_view.php ---



--- Start of dashboard.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
$forecastData = calculateForecasts();
$forecasts = $forecastData['individual'];
$forecastByStage = $forecastData['by_stage'];

$totalContacts = count($contacts);
$totalValue = array_sum(array_column($opportunities, 'value'));
$totalForecast = array_sum(array_column($forecasts, 'forecast'));
$accuracy = $totalValue > 0 ? ($totalForecast / $totalValue) * 100 : 0;

// Identify top forecast stage
$topStage = '';
$maxForecast = 0;
foreach ($forecastByStage as $stage => $data) {
    if ($data['total_forecast'] > $maxForecast) {
        $maxForecast = $data['total_forecast'];
        $topStage = $stage;
    }
}

// Pipeline breakdown
$stages = [];
foreach ($opportunities as $opp) {
    $stage = $opp['stage'];
    $value = floatval($opp['value']);
    if (!isset($stages[$stage])) {
        $stages[$stage] = ['count' => 0, 'value' => 0];
    }
    $stages[$stage]['count']++;
    $stages[$stage]['value'] += $value;
}
?>

<div class="page-header">
  <h1>Dashboard</h1>
  <div class="page-actions">
    <a href="contacts_list.php" class="btn btn-outline">View Contacts</a>
    <a href="opportunities_list.php" class="btn btn-primary">View Opportunities</a>
  </div>
</div>

<!-- Key Metrics -->
<div class="stats-grid">
  <div class="stat-card stat-card-primary">
    <div class="stat-icon">üë•</div>
    <div class="stat-content">
      <div class="stat-label">Total Contacts</div>
      <div class="stat-value"><?= number_format($totalContacts) ?></div>
    </div>
  </div>
  
  <div class="stat-card stat-card-success">
    <div class="stat-icon">üí∞</div>
    <div class="stat-content">
      <div class="stat-label">Pipeline Value</div>
      <div class="stat-value">$<?= number_format($totalValue, 0) ?></div>
    </div>
  </div>
  
  <div class="stat-card stat-card-info">
    <div class="stat-icon">üìä</div>
    <div class="stat-content">
      <div class="stat-label">Forecast Value</div>
      <div class="stat-value">$<?= number_format($totalForecast, 0) ?></div>
    </div>
  </div>
  
  <div class="stat-card stat-card-warning">
    <div class="stat-icon">üéØ</div>
    <div class="stat-content">
      <div class="stat-label">Forecast Accuracy</div>
      <div class="stat-value"><?= number_format($accuracy, 1) ?>%</div>
    </div>
  </div>
</div>

<!-- Pipeline and Forecast Tables -->
<div class="dashboard-grid">
  <div class="card">
    <div class="card-header">
      <h3>Pipeline Breakdown</h3>
    </div>
    <div class="card-body">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Stage</th>
            <th>Count</th>
            <th>Total Value</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($stages as $stage => $data): ?>
            <tr>
              <td><?= e($stage) ?></td>
              <td><span class="badge badge-primary"><?= $data['count'] ?></span></td>
              <td><strong>$<?= number_format($data['value'], 2) ?></strong></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Forecast by Stage</h3>
      <?php if ($topStage): ?>
        <div class="badge badge-success">Top: <?= e($topStage) ?></div>
      <?php endif; ?>
    </div>
    <div class="card-body">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Stage</th>
            <th>Count</th>
            <th>Total Forecast</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($forecastByStage as $stage => $data): ?>
            <tr>
              <td><?= e($stage) ?></td>
              <td><span class="badge badge-info"><?= $data['count'] ?></span></td>
              <td><strong>$<?= number_format($data['total_forecast'], 2) ?></strong></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  font-size: 36px;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  background: rgba(0, 153, 168, 0.1);
}

.stat-card-primary .stat-icon { background: rgba(0, 153, 168, 0.1); }
.stat-card-success .stat-icon { background: rgba(16, 185, 129, 0.1); }
.stat-card-info .stat-icon { background: rgba(59, 130, 246, 0.1); }
.stat-card-warning .stat-icon { background: rgba(245, 158, 11, 0.1); }

.stat-content {
  flex: 1;
}

.stat-label {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 4px;
  font-weight: 500;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-value {
    font-size: 24px;
  }
}
</style>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of dashboard.php ---



--- Start of delete_contact.php ---

<?php
require_once 'layout_start.php';
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'error_handler.php';

// ‚úÖ CSRF Protection: Verify token on POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
        showError('CSRF validation failed');
        logWarning('CSRF token validation failed on delete_contact', ['ip' => $_SERVER['REMOTE_ADDR']]);
        exit;
    }
}

$idToDelete = $_POST['id'] ?? null;
if (!$idToDelete) {
    showError('No contact ID provided');
    exit;
}

$schema = require __DIR__ . '/contact_schema.php';
$deleted_contact = null;

try {
    // ‚úÖ LOCKED READ-MODIFY-WRITE: Prevents race condition data loss
    readModifyWriteCSV('contacts.csv', $schema, function($contacts) use ($idToDelete) {
        global $deleted_contact;
        
        // Find and capture contact before deletion (for audit log)
        $deleted_contact = null;
        foreach ($contacts as $contact) {
            if ($contact['id'] === $idToDelete) {
                $deleted_contact = $contact;
                break;
            }
        }
        
        // Filter out the contact to delete
        $filtered = array_filter($contacts, function($c) use ($idToDelete) {
            return $c['id'] !== $idToDelete;
        });
        
        // Reindex array to maintain clean structure
        return array_values($filtered);
    });
    
    // ‚úÖ AUDIT: Log contact deletion
    if ($deleted_contact) {
        auditDeleteContact($deleted_contact);
        logInfo('Contact deleted successfully', [
            'email' => $deleted_contact['email'],
            'name' => ($deleted_contact['first_name'] ?? '') . ' ' . ($deleted_contact['last_name'] ?? ''),
        ]);
    }
    
    header('Location: contacts_list.php');
    exit;
} catch (Exception $e) {
    showError('Error deleting contact', htmlspecialchars($e->getMessage()));
    logError('Contact deletion failed', [
        'id' => $idToDelete,
        'exception' => $e->getMessage(),
    ]);
    
    // ‚úÖ AUDIT: Log failed deletion
    if ($deleted_contact) {
        auditDeleteContact($deleted_contact);
    }
    
    echo "<p><a href='contacts_list.php'>Go back</a></p>";
    exit;
}
?>



--- End of delete_contact.php ---



--- Start of delete_opportunity.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: opportunities_list.php?error=' . urlencode('Invalid request method'));
    exit;
}

$idToDelete = $_POST['id'] ?? null;

if (!$idToDelete) {
    header('Location: opportunities_list.php?error=' . urlencode('No opportunity ID provided'));
    exit;
}

// Load opportunities
$opportunities = readCSV('opportunities.csv', $schema);

// Find and remove the opportunity
$found = false;
$filteredOpportunities = array_filter($opportunities, function($opp) use ($idToDelete, &$found) {
    if ($opp['id'] == $idToDelete) {
        $found = true;
        return false; // Remove this opportunity
    }
    return true; // Keep this opportunity
});

if (!$found) {
    header('Location: opportunities_list.php?error=' . urlencode('Opportunity not found'));
    exit;
}

// Save the updated list
if (writeCSV('opportunities.csv', array_values($filteredOpportunities), $schema)) {
    header('Location: opportunities_list.php?success=3');
    exit;
} else {
    header('Location: opportunities_list.php?error=' . urlencode('Failed to delete opportunity'));
    exit;
}


--- End of delete_opportunity.php ---



--- Start of delete_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if (isset($_GET['timestamp'])) {
    deleteTask($filename, $schema, $_GET['timestamp']);
}
header('Location: index.php');
exit;


--- End of delete_task.php ---



--- Start of deliveries.php ---

<?php
include_once 'layout_start.php';

// Get customer ID from GET
$id = isset($_GET['id']) ? preg_replace('/[^a-zA-Z0-9_-]/', '', $_GET['id']) : null;

if (!$id) {
    echo "<p>Error: No customer ID specified.</p>";
    include_once 'layout_end.php';
    exit;
}

$csvFile = "deliveries_$id.csv";

// Create file if it doesn't exist
if (!file_exists($csvFile)) {
    $fp = fopen($csvFile, 'w');
    fputcsv($fp, ['Date', 'Company', 'Tank #', 'Size']); // Header row
    fclose($fp);
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $date = $_POST['delivery_date'];
    $company = $_POST['company'];
    $tank_number = $_POST['tank_number'];
    $tank_size = $_POST['tank_size'];

    $newEntry = [$date, $company, $tank_number, $tank_size];
    $fp = fopen($csvFile, 'a');
    fputcsv($fp, $newEntry);
    fclose($fp);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delivery Archive - Customer #<?php echo htmlspecialchars($id); ?></title>
  <script>
    function sortTable(n) {
      const table = document.getElementById("deliveryTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let shouldSwitch = dir === "asc" ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase();
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
            break;
          }
        }
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  </script>
</head>
<body>
  <h2>üì¶ Delivery Archive for Customer #<?php echo htmlspecialchars($id); ?></h2>

  <form method="post">
    <label><strong>Add New Delivery:</strong></label><br>
    <input type="date" name="delivery_date" required>
    <input type="text" name="company" required>
    <input type="text" name="tank_number" placeholder="Tank #" required>
    <input type="text" name="tank_size" placeholder="Size" required>
	<input type="text" name="number" placeholder="Number of Tanks" required>
    <button type="submit">‚ûï Add Delivery</button>
  </form>

  <br>
  customer_view.php?id=<?php echo urlencode($id); ?>
    <button>üîô Back to Customer Details</button>
  </a>

  <br><br>
  <table id="deliveryTable" border="1">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Date</th>
        <th onclick="sortTable(1)">Company</th>
        <th onclick="sortTable(2)">Tank #</th>
        <th onclick="sortTable(3)">Size</th>
		 <th onclick="sortTable(4)">Number of Tanks</th>
      </tr>
    </thead>
    <tbody>
      <?php
      $rows = array_map('str_getcsv', file($csvFile));
      array_shift($rows); // Remove header
      if (count($rows) > 0) {
          foreach ($rows as $row) {
              echo "<tr>";
              foreach ($row as $cell) {
                  echo "<td>" . htmlspecialchars($cell) . "</td>";
              }
              echo "</tr>";
          }
      } else {
          echo "<tr><td colspan='4'>No delivery records found.</td></tr>";
      }
      ?>
    </tbody>
  </table>
</body>
</html>
<?php include_once 'layout_end.php'; ?>

--- End of deliveries.php ---



--- Start of discussion_logger.php ---

<?php
// discussion_logger.php
require_once 'csv_handler.php';

// Use $_POST directly
$data = $_POST;
$contactId = $data['contact_id'] ?? null;

// Define the logging function
function logDiscussionEntry(array $data): bool {
    $file = 'discussion_log.csv';
    $logFile = 'error_log.txt';
    $schema = require __DIR__ . '/discussion_schema.php';

    // Build row using schema order
    $row = [];
    foreach ($schema as $col) {
        switch ($col) {
            case 'timestamp':
                $row[] = date('Y-m-d H:i');
                break;
            case 'entry_text':
                $row[] = isset($data[$col]) ? str_replace(["\r", "\n"], ' ', $data[$col]) : '';
                break;
            case 'author':
                $row[] = $data[$col] ?? 'System';
                break;
            case 'linked_opportunity_id':
                $row[] = $data[$col] ?? '';
                break;
            case 'visibility':
                $row[] = $data[$col] ?? 'public';
                break;
            default:
                $row[] = $data[$col] ?? '';
        }
    }

    // Try to append to CSV
    if (($fp = fopen($file, 'a')) !== false) {
        fputcsv($fp, $row);
        fclose($fp);
        return true;
    }

    // Log error if write fails
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write to $file for contact_id: {$data['contact_id']}\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    return false;
}

// Log the discussion entry and redirect
if (!empty($data) && !empty($contactId) && logDiscussionEntry($data)) {
    header('Location: contact_view.php?id=' . urlencode($contactId));
    exit;
} else {
    // Fallback error
    header('Location: contacts_list.php');
    exit;
}
?>



--- End of discussion_logger.php ---



--- Start of discussion_module.php ---

<?php
$cid = $contact['id'] ?? '';
if (empty($cid)) return;

$discussionSchema = require __DIR__ . '/discussion_schema.php';
$discussionLog = readCSV('discussion_log.csv', $discussionSchema) ?: [];

$entries = array_filter($discussionLog, fn($e) => trim($e['contact_id']) === trim($cid));
usort($entries, fn($a, $b) => strtotime($b['timestamp']) <=> strtotime($a['timestamp']));
?>

<div style="margin-top:40px;">
  <h3>Discussion</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:40px; align-items:start;">

    <!-- Add Discussion Entry (Left) -->
    <div>
      <h4>Add Discussion Entry</h4>
      <form method="post" style="display:grid; gap:15px;">
        <input type="hidden" name="contact_id" value="<?= htmlspecialchars($cid) ?>">

        <div>
          <label for="author">Author:</label><br>
          <input type="text" name="author" id="author" value="Robert Lee" required>
        </div>

        <div>
          <label for="entry_text">Comment:</label><br>
          <textarea name="entry_text" id="entry_text" rows="4" required></textarea>
        </div>

        <div>
          <label for="linked_opportunity_id">Linked Opportunity ID (optional):</label><br>
          <input type="text" name="linked_opportunity_id" id="linked_opportunity_id">
        </div>

        <div>
          <label for="visibility">Visibility:</label><br>
          <select name="visibility" id="visibility">
            <option value="public">Public</option>
            <option value="internal">Internal</option>
          </select>
        </div>

        <button type="submit" class="btn-primary">üí¨ Log Discussion</button>
      </form>
    </div>

    <!-- Discussion History (Right) -->
    <div>
      <h4>Discussion History</h4>
      <?php if (!empty($entries)): ?>
        <?php foreach ($entries as $entry): ?>
          <div style="border-left:3px solid #0099A8; padding-left:10px; margin-bottom:15px;">
            <div style="font-size:0.9em; color:#555;">
              <strong><?= htmlspecialchars($entry['author'] ?? 'Admin') ?></strong>
              <em><?= htmlspecialchars($entry['timestamp'] ?? '') ?></em>
              <?php if (!empty($entry['linked_opportunity_id'])): ?>
                ‚Ä¢ <span>Opportunity: <?= htmlspecialchars($entry['linked_opportunity_id']) ?></span>
              <?php endif; ?>
              <?php if (!empty($entry['visibility'])): ?>
                ‚Ä¢ <span>Visibility: <?= htmlspecialchars($entry['visibility']) ?></span>
              <?php endif; ?>
            </div>
            <div style="margin-top:5px;">
              <?= nl2br(htmlspecialchars($entry['entry_text'] ?? '')) ?>
            </div>
          </div>
        <?php endforeach; ?>
      <?php else: ?>
        <p style="color:#666;">No discussion history found for this contact.</p>
      <?php endif; ?>
    </div>

  </div>
</div>


--- End of discussion_module.php ---



--- Start of discussion_schema.php ---

<?php
return [
    'contact_id',
    'author',
    'timestamp',
    'entry_text',
    'linked_opportunity_id',
    'visibility'
];


--- End of discussion_schema.php ---



--- Start of discussion_validator.php ---

<?php
function validateDiscussion(array $data): array {
    $errors = [];

    if (empty($data['contact_id'])) {
        $errors['contact_id'] = 'Contact ID is required.';
    }

    if (empty($data['entry_text'])) {
        $errors['entry_text'] = 'Comment text is required.';
    }

    if (empty($data['author'])) {
        $errors['author'] = 'Author is required.';
    }

    return $errors;
}


--- End of discussion_validator.php ---



--- Start of edit_opportunity.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Get opportunity ID
$opportunityId = $_GET['id'] ?? $_POST['id'] ?? null;

if (!$opportunityId) {
    header('Location: opportunities_list.php?error=' . urlencode('No opportunity ID provided'));
    exit;
}

// Load opportunities
$opportunities = readCSV('opportunities.csv', $schema);

// Find the opportunity
$opportunity = null;
$opportunityIndex = null;
foreach ($opportunities as $index => $opp) {
    if ($opp['id'] == $opportunityId) {
        $opportunity = $opp;
        $opportunityIndex = $index;
        break;
    }
}

if (!$opportunity) {
    header('Location: opportunities_list.php?error=' . urlencode('Opportunity not found'));
    exit;
}

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate inputs
    $errors = [];
    
    if (empty($_POST['contact_id'])) {
        $errors[] = 'Contact is required';
    }
    
    if (!isset($_POST['value']) || $_POST['value'] === '' || !is_numeric($_POST['value']) || $_POST['value'] < 0) {
        $errors[] = 'Valid opportunity value is required';
    }
    
    if (!isset($_POST['probability']) || $_POST['probability'] === '' || !is_numeric($_POST['probability']) || $_POST['probability'] < 0 || $_POST['probability'] > 100) {
        $errors[] = 'Probability must be between 0 and 100';
    }
    
    if (empty($_POST['stage'])) {
        $errors[] = 'Stage is required';
    }
    
    if (empty($_POST['expected_close'])) {
        $errors[] = 'Expected close date is required';
    }
    
    if (empty($errors)) {
        // Update opportunity
        $opportunities[$opportunityIndex] = [
            'id' => $opportunityId,
            'contact_id' => $_POST['contact_id'],
            'value' => $_POST['value'],
            'stage' => $_POST['stage'],
            'probability' => $_POST['probability'],
            'expected_close' => $_POST['expected_close'],
        ];
        
        if (writeCSV('opportunities.csv', $opportunities, $schema)) {
            header('Location: opportunities_list.php?success=2');
            exit;
        } else {
            $error = 'Failed to update opportunity.';
        }
    } else {
        $error = implode(', ', $errors);
    }
}
?>

<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }
  
  .page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
  }
  
  .page-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 14px;
  }
  
  .back-link:hover {
    color: #5558dd;
  }
  
  /* Use global .form-container from styles.css */
  
  .form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #E5E7EB;
  }
  
  .form-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
  
  .form-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  /* Use global .form-grid from styles.css */
  
  /* Use global .form-group from styles.css */
  
  /* Use global .form-group.full-width from styles.css */
  
  .form-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-group input,
  .form-group select {
    padding: 14px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    background: white;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .form-group select {
    cursor: pointer;
  }
  
  .form-help {
    font-size: 12px;
    color: #6B7280;
    margin-top: 6px;
  }
  
  .stage-visual {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  
  .stage-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  
  .stage-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .stage-badge.selected {
    border-color: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
  
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }
  
  .btn-primary {
    padding: 14px 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-secondary {
    padding: 14px 32px;
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-secondary:hover {
    background: #E5E7EB;
  }
  
  .error-alert {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border: 2px solid #EF4444;
    color: #991B1B;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-slider {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .probability-value {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    min-width: 50px;
  }
  
  input[type="range"] {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #E5E7EB;
    outline: none;
    padding: 0;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
  }
  
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .page-header {
      padding: 24px;
    }
    
    .form-container {
      padding: 24px;
    }
  }
</style>

<a href="opportunities_list.php" class="back-link">
  ‚Üê Back to Opportunities
</a>

<div class="page-header">
  <h1>‚úèÔ∏è Edit Opportunity #<?= htmlspecialchars($opportunityId) ?></h1>
  <p>Update opportunity details and sales progress</p>
</div>

<?php if (isset($error)): ?>
  <div class="error-alert">
    <span>‚ö†Ô∏è</span>
    <span><?= htmlspecialchars($error) ?></span>
  </div>
<?php endif; ?>

<div class="form-container">
  <form method="POST" id="opportunityForm">
    <input type="hidden" name="id" value="<?= htmlspecialchars($opportunityId) ?>">
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üë§</span>
        <span>Contact Information</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="contact_id">Contact *</label>
          <select name="contact_id" id="contact_id" required>
            <option value="">Select a contact...</option>
            <?php foreach ($contacts as $contact): ?>
              <?php
                $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
                $company = $contact['company'] ?? '';
                $displayName = $fullName ?: 'Unnamed Contact';
                if ($company) {
                  $displayName .= ' (' . $company . ')';
                }
                $selected = ($contact['id'] == $opportunity['contact_id']) ? 'selected' : '';
              ?>
              <option value="<?= htmlspecialchars($contact['id']) ?>" <?= $selected ?>>
                <?= htmlspecialchars($displayName) ?>
              </option>
            <?php endforeach; ?>
          </select>
          <div class="form-help">Select the contact associated with this opportunity</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üí∞</span>
        <span>Deal Details</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="value">Opportunity Value *</label>
          <input 
            type="number" 
            name="value" 
            id="value" 
            placeholder="0.00" 
            step="0.01" 
            min="0"
            value="<?= htmlspecialchars($opportunity['value']) ?>"
            required
          >
          <div class="form-help">Enter the total value in dollars</div>
        </div>
        
        <div class="form-group">
          <label for="expected_close">Expected Close Date *</label>
          <input 
            type="date" 
            name="expected_close" 
            id="expected_close"
            value="<?= htmlspecialchars($opportunity['expected_close']) ?>"
            required
          >
          <div class="form-help">When do you expect to close this deal?</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">
        <span>üìä</span>
        <span>Sales Stage & Probability</span>
      </div>
      
      <div class="form-grid">
        <div class="form-group full-width">
          <label for="stage">Sales Stage *</label>
          <select name="stage" id="stage" required>
            <option value="">Select stage...</option>
            <option value="Prospecting" data-probability="10" <?= $opportunity['stage'] === 'Prospecting' ? 'selected' : '' ?>>Prospecting (10% win rate)</option>
            <option value="Proposal" data-probability="25" <?= $opportunity['stage'] === 'Proposal' ? 'selected' : '' ?>>Proposal (25% win rate)</option>
            <option value="Negotiation" data-probability="50" <?= $opportunity['stage'] === 'Negotiation' ? 'selected' : '' ?>>Negotiation (50% win rate)</option>
            <option value="Closed Won" data-probability="100" <?= $opportunity['stage'] === 'Closed Won' ? 'selected' : '' ?>>Closed Won (100%)</option>
            <option value="Closed Lost" data-probability="0" <?= $opportunity['stage'] === 'Closed Lost' ? 'selected' : '' ?>>Closed Lost (0%)</option>
          </select>
          
          <div class="stage-visual" style="margin-top: 16px;">
            <div class="stage-badge <?= $opportunity['stage'] === 'Prospecting' ? 'selected' : '' ?>" style="background: #6366F1;" data-stage="Prospecting">Prospecting</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Proposal' ? 'selected' : '' ?>" style="background: #8B5CF6;" data-stage="Proposal">Proposal</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Negotiation' ? 'selected' : '' ?>" style="background: #F59E0B;" data-stage="Negotiation">Negotiation</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Closed Won' ? 'selected' : '' ?>" style="background: #10B981;" data-stage="Closed Won">Closed Won</div>
            <div class="stage-badge <?= $opportunity['stage'] === 'Closed Lost' ? 'selected' : '' ?>" style="background: #EF4444;" data-stage="Closed Lost">Closed Lost</div>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="probability">Win Probability *</label>
          <div class="probability-slider">
            <input 
              type="range" 
              name="probability" 
              id="probability" 
              min="0" 
              max="100" 
              value="<?= htmlspecialchars($opportunity['probability']) ?>"
              step="5"
            >
            <span class="probability-value"><?= htmlspecialchars($opportunity['probability']) ?>%</span>
          </div>
          <div class="form-help">Estimated likelihood of closing this deal</div>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Update Opportunity</button>
      <a href="opportunities_list.php" class="btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Update probability slider value display
  const probabilitySlider = document.getElementById('probability');
  const probabilityValue = document.querySelector('.probability-value');
  
  probabilitySlider.addEventListener('input', function() {
    probabilityValue.textContent = this.value + '%';
  });
  
  // Auto-update probability based on stage selection
  const stageSelect = document.getElementById('stage');
  stageSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const suggestedProbability = selectedOption.getAttribute('data-probability');
    
    if (suggestedProbability) {
      probabilitySlider.value = suggestedProbability;
      probabilityValue.textContent = suggestedProbability + '%';
    }
    
    // Update visual badges
    document.querySelectorAll('.stage-badge').forEach(badge => {
      badge.classList.remove('selected');
      if (badge.getAttribute('data-stage') === this.value) {
        badge.classList.add('selected');
      }
    });
  });
  
  // Allow clicking stage badges to select stage
  document.querySelectorAll('.stage-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const stageName = this.getAttribute('data-stage');
      stageSelect.value = stageName;
      stageSelect.dispatchEvent(new Event('change'));
    });
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of edit_opportunity.php ---



--- Start of edit_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $updatedTask = [
        $_POST['title'],
        $_POST['due_date'],
        $_POST['status'],
        $_POST['timestamp']
    ];
    updateTask($filename, $schema, $_POST['timestamp'], $updatedTask);
    header('Location: index.php');
    exit;
}

$timestamp = $_GET['timestamp'] ?? '';
$tasks = readCSV($filename, $schema);
$taskToEdit = null;
foreach ($tasks as $task) {
    if ($task['timestamp'] === $timestamp) {
        $taskToEdit = $task;
        break;
    }
}
if (!$taskToEdit) {
    echo "Task not found.";
    exit;
}
?>

<h3>Edit Task</h3>
<form method="POST">
  <input type="hidden" name="timestamp" value="<?= htmlspecialchars($taskToEdit['timestamp']) ?>">
  <input type="text" name="title" value="<?= htmlspecialchars($taskToEdit['title']) ?>" required>
  <input type="date" name="due_date" value="<?= htmlspecialchars($taskToEdit['due_date']) ?>" required>
  <select name="status" required>
    <option value="pending" <?= $taskToEdit['status'] === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $taskToEdit['status'] === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <button type="submit">Update Task</button>
</form>


--- End of edit_task.php ---



--- Start of enhanced_contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = [];
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
    if (!empty($c['tags'])) {
        foreach (explode(',', $c['tags']) as $tag) {
            $tagOptions[trim($tag)] = true;
        }
    }
}
ksort($statusOptions);
ksort($tagOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $tagFilter) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $matchTag = $tagFilter === '' || in_array($tagFilter, array_map('trim', explode(',', $c['tags'] ?? '')));
    return $matchQuery && $matchStatus && $matchTag;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <select name="tag">
      <option value="">-- Tag --</option>
      <?php foreach (array_keys($tagOptions) as $tag): ?>
        <option value="<?= htmlspecialchars($tag) ?>" <?= $tag === $tagFilter ? 'selected' : '' ?>><?= htmlspecialchars($tag) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table-grid">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th>
            <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
              <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
              <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
            </a>
          </th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of enhanced_contact_list.php ---



--- Start of equipment_list.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Equipment Inventory';
$equipmentSchema = require __DIR__ . '/equipment_schema.php';
$equipment = readCSV('equipment.csv', $equipmentSchema) ?: [];
$customers = readCSV('customers.csv', require __DIR__ . '/customer_schema.php');
$contracts = readCSV('contracts.csv', require __DIR__ . '/contract_schema.php') ?: [];

// Calculate metrics
$totalEquipment = count($equipment);
$customerOwned = 0;
$evoquaLeased = 0;
$serviceDue = 0;
$today = strtotime(date('Y-m-d'));

foreach ($equipment as &$item) {
    // Count by ownership
    if ($item['ownership'] === 'Customer Owned') {
        $customerOwned++;
    } elseif (strpos($item['ownership'], 'Evoqua') !== false) {
        $evoquaLeased++;
    }
    
    // Check service due
    if (!empty($item['next_service_date'])) {
        $nextService = strtotime($item['next_service_date']);
        if ($nextService <= $today) {
            $serviceDue++;
            $item['service_status'] = 'overdue';
        } elseif ($nextService <= strtotime('+7 days')) {
            $serviceDue++;
            $item['service_status'] = 'due-soon';
        } else {
            $item['service_status'] = 'scheduled';
        }
    }
}
?>

<style>
.equipment-header {
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.equipment-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

/* Reuse metrics and table styling from contracts */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #8B5CF6;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    color: #1F2937;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-group select,
.filter-group input {
    padding: 10px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    border: none;
    font-size: 14px;
}

.btn-primary {
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.equipment-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.equipment-table table {
    width: 100%;
    border-collapse: collapse;
}

.equipment-table th {
    background: #F9FAFB;
    padding: 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #E5E7EB;
}

.equipment-table td {
    padding: 16px;
    border-bottom: 1px solid #F3F4F6;
    font-size: 14px;
}

.equipment-table tr:hover {
    background: #F9FAFB;
}

.ownership-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.ownership-customer {
    background: #DBEAFE;
    color: #1E40AF;
}

.ownership-evoqua {
    background: #FEF3C7;
    color: #92400E;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-active {
    background: #D1FAE5;
    color: #065F46;
}

.status-inactive {
    background: #FEE2E2;
    color: #991B1B;
}

.service-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
}

.service-scheduled {
    background: #D1FAE5;
    color: #065F46;
}

.service-due-soon {
    background: #FEF3C7;
    color: #92400E;
}

.service-overdue {
    background: #FEE2E2;
    color: #991B1B;
}

.action-btns {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}

.action-btn-view {
    background: #EFF6FF;
    color: #1E40AF;
}

.action-btn-view:hover {
    background: #DBEAFE;
}

.action-btn-service {
    background: #D1FAE5;
    color: #065F46;
}

.action-btn-service:hover {
    background: #A7F3D0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}
</style>

<div class="equipment-header">
    <h1>üîß Equipment Inventory</h1>
    <p>Track all customer equipment and Evoqua leased systems</p>
</div>

<!-- Metrics Dashboard -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total Equipment</div>
        <div class="metric-value"><?= $totalEquipment ?></div>
        <div class="metric-subtext">All tracked equipment</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Customer Owned</div>
        <div class="metric-value"><?= $customerOwned ?></div>
        <div class="metric-subtext">Equipment sold to customers</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Evoqua Leased</div>
        <div class="metric-value"><?= $evoquaLeased ?></div>
        <div class="metric-subtext">SDI service equipment</div>
    </div>
    
    <div class="metric-card <?= $serviceDue > 0 ? 'warning' : '' ?>">
        <div class="metric-label">Service Due</div>
        <div class="metric-value"><?= $serviceDue ?></div>
        <div class="metric-subtext">Needs service soon/overdue</div>
    </div>
</div>

<!-- Action Bar -->
<div class="action-bar">
    <div class="filter-group">
        <select id="ownershipFilter" onchange="filterEquipment()">
            <option value="">All Ownership</option>
            <option value="Customer Owned">Customer Owned</option>
            <option value="Evoqua Lease">Evoqua Lease</option>
            <option value="Evoqua Rental">Evoqua Rental</option>
        </select>
        
        <select id="typeFilter" onchange="filterEquipment()">
            <option value="">All Types</option>
            <option value="Softener">Softener</option>
            <option value="RO System">RO System</option>
            <option value="Filtration">Filtration</option>
            <option value="DI Tank">DI Tank</option>
        </select>
        
        <select id="statusFilter" onchange="filterEquipment()">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
        </select>
        
        <input type="text" id="searchInput" placeholder="Search equipment..." onkeyup="filterEquipment()">
    </div>
    
    <a href="equipment_form.php" class="btn btn-primary">‚ûï Add Equipment</a>
</div>

<!-- Equipment Table -->
<div class="equipment-table">
    <?php if (empty($equipment)): ?>
        <div class="empty-state">
            <div class="empty-state-icon">üîß</div>
            <h3>No Equipment Tracked Yet</h3>
            <p>Start by adding your first piece of equipment</p>
            <a href="equipment_form.php" class="btn btn-primary" style="margin-top: 20px;">‚ûï Add First Equipment</a>
        </div>
    <?php else: ?>
        <table id="equipmentTable">
            <thead>
                <tr>
                    <th>Equipment ID</th>
                    <th>Type</th>
                    <th>Model/Serial</th>
                    <th>Customer</th>
                    <th>Ownership</th>
                    <th>Install Date</th>
                    <th>Service Status</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($equipment as $item): ?>
                    <?php
                    // Find customer name
                    $customerName = 'Unknown';
                    foreach ($customers as $c) {
                        if ($c['customer_id'] === $item['customer_id']) {
                            $customerName = $c['contact_name'];
                            break;
                        }
                    }
                    
                    $ownershipClass = 'ownership-' . (strpos($item['ownership'], 'Customer') !== false ? 'customer' : 'evoqua');
                    $statusClass = 'status-' . strtolower($item['status'] ?? 'active');
                    $serviceClass = 'service-' . ($item['service_status'] ?? 'scheduled');
                    ?>
                    <tr data-ownership="<?= htmlspecialchars($item['ownership']) ?>" 
                        data-type="<?= htmlspecialchars($item['equipment_type']) ?>"
                        data-status="<?= htmlspecialchars($item['status'] ?? 'Active') ?>">
                        <td><strong><?= htmlspecialchars($item['equipment_id']) ?></strong></td>
                        <td><?= htmlspecialchars($item['equipment_type']) ?></td>
                        <td>
                            <?php if (!empty($item['model_number'])): ?>
                                <?= htmlspecialchars($item['model_number']) ?><br>
                                <small style="color: #6B7280;"><?= htmlspecialchars($item['serial_number']) ?></small>
                            <?php else: ?>
                                <?= htmlspecialchars($item['serial_number']) ?>
                            <?php endif; ?>
                        </td>
                        <td><?= htmlspecialchars($customerName) ?></td>
                        <td>
                            <span class="ownership-badge <?= $ownershipClass ?>">
                                <?= htmlspecialchars($item['ownership']) ?>
                            </span>
                        </td>
                        <td><?= htmlspecialchars($item['install_date']) ?></td>
                        <td>
                            <?php if (!empty($item['next_service_date'])): ?>
                                <span class="service-badge <?= $serviceClass ?>">
                                    <?php if ($item['service_status'] === 'overdue'): ?>
                                        ‚ö†Ô∏è Overdue
                                    <?php elseif ($item['service_status'] === 'due-soon'): ?>
                                        ‚è∞ Due Soon
                                    <?php else: ?>
                                        ‚úì <?= htmlspecialchars($item['next_service_date']) ?>
                                    <?php endif; ?>
                                </span>
                            <?php else: ?>
                                <span style="color: #9CA3AF;">Not scheduled</span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <span class="status-badge <?= $statusClass ?>">
                                <?= htmlspecialchars($item['status'] ?? 'Active') ?>
                            </span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <a href="equipment_view.php?id=<?= urlencode($item['equipment_id']) ?>" 
                                   class="action-btn action-btn-view">View</a>
                                <?php if ($item['service_status'] === 'overdue' || $item['service_status'] === 'due-soon'): ?>
                                    <a href="service_log.php?equipment_id=<?= urlencode($item['equipment_id']) ?>" 
                                       class="action-btn action-btn-service">Service Now</a>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>
</div>

<script>
function filterEquipment() {
    const ownershipFilter = document.getElementById('ownershipFilter').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const table = document.getElementById('equipmentTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const ownership = row.getAttribute('data-ownership').toLowerCase();
        const type = row.getAttribute('data-type').toLowerCase();
        const status = row.getAttribute('data-status').toLowerCase();
        const text = row.textContent.toLowerCase();
        
        let showRow = true;
        
        if (ownershipFilter && ownership !== ownershipFilter) showRow = false;
        if (typeFilter && type !== typeFilter) showRow = false;
        if (statusFilter && status !== statusFilter) showRow = false;
        if (searchInput && !text.includes(searchInput)) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
    }
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of equipment_list.php ---



--- Start of equipment_schema.php ---

<?php
/**
 * Equipment/Inventory Schema - Both Sales & SDI
 * Tracks all equipment (owned by customer or leased from Evoqua)
 */
return [
    'equipment_id',         // Unique identifier
    'equipment_type',       // Softener / RO System / Filtration / DI Tank / Other
    'manufacturer',         // Evoqua / Eclipse / Other
    'model_number',         // Equipment model
    'serial_number',        // Equipment serial number
    'ownership',            // Customer Owned / Evoqua Lease / Evoqua Rental
    'customer_id',          // Which customer has this equipment
    'contact_id',           // Primary contact for equipment
    'contract_id',          // Linked service contract (if SDI)
    'install_date',         // Installation date
    'purchase_date',        // Purchase date (if owned)
    'purchase_value',       // Original purchase price
    'location',             // Installation location/address
    'tank_size',            // For tanks - size in liters/gallons
    'resin_type',           // For tanks - type of resin
    'regeneration_id',      // Regeneration number
    'service_frequency',    // How often serviced
    'last_service_date',    // Most recent service
    'next_service_date',    // Scheduled next service
    'warranty_expiry',      // Warranty expiration date
    'status',               // Active / Inactive / Pending Removal / Removed
    'purchase_order',       // Original PO number
    'notes',                // Equipment notes
    'created_date',         // Record creation date
    'modified_date'         // Last modification date
];


--- End of equipment_schema.php ---



--- Start of error_handler.php ---

<?php
/**
 * Centralized Error Handling
 * Provides structured logging and user-friendly error messages
 */

// Ensure session started for error logging
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

define('ERROR_LOG_DIR', __DIR__ . '/logs');
define('ERROR_LOG_FILE', ERROR_LOG_DIR . '/errors.log');
define('ERROR_LOG_MAX_SIZE', 5242880); // 5MB

/**
 * Initialize error logging directory
 */
function initializeErrorLogging() {
    if (!is_dir(ERROR_LOG_DIR)) {
        if (!mkdir(ERROR_LOG_DIR, 0755, true)) {
            // Fallback to root directory if logs dir can't be created
            return false;
        }
    }
    return true;
}

/**
 * Log an error with structured format
 */
function logError($message, $context = [], $level = 'ERROR') {
    initializeErrorLogging();
    
    $timestamp = date('Y-m-d H:i:s');
    $userid = $_SESSION['user_id'] ?? 'anonymous';
    $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
    
    $logEntry = [
        'timestamp' => $timestamp,
        'level' => $level,
        'user_id' => $userid,
        'ip_address' => $ip,
        'message' => $message,
        'context' => $context,
        'uri' => $_SERVER['REQUEST_URI'] ?? '',
    ];
    
    // Format as JSON for structured logging
    $logLine = json_encode($logEntry) . "\n";
    
    // Write to log file
    if (file_exists(ERROR_LOG_FILE) && filesize(ERROR_LOG_FILE) > ERROR_LOG_MAX_SIZE) {
        // Rotate log if too large
        rename(ERROR_LOG_FILE, ERROR_LOG_FILE . '.' . date('YmdHis'));
    }
    
    @file_put_contents(ERROR_LOG_FILE, $logLine, FILE_APPEND);
}

/**
 * Log info messages
 */
function logInfo($message, $context = []) {
    logError($message, $context, 'INFO');
}

/**
 * Log warning messages
 */
function logWarning($message, $context = []) {
    logError($message, $context, 'WARNING');
}

/**
 * Display user-friendly error
 */
function showError($title, $message, $details = '') {
    ?>
    <div style="background:#fee; border:1px solid #c00; border-radius:4px; padding:20px; margin:20px 0; max-width:600px;">
        <h3 style="color:#c00; margin-top:0;">‚ö†Ô∏è <?= e($title) ?></h3>
        <p><?= e($message) ?></p>
        <?php if (!empty($details)): ?>
            <details style="margin-top:10px; font-size:0.9em; color:#666;">
                <summary>Technical details</summary>
                <pre style="background:#f5f5f5; padding:10px; border-radius:3px; overflow-x:auto;"><?= e($details) ?></pre>
            </details>
        <?php endif; ?>
        <p style="margin-bottom:0;">
            <a href="javascript:history.back()" style="color:#00a; text-decoration:none;">‚Üê Go back</a>
        </p>
    </div>
    <?php
}

/**
 * Display success message
 */
function showSuccess($message) {
    ?>
    <div style="background:#efe; border:1px solid #0a0; border-radius:4px; padding:15px; margin:20px 0;">
        <p style="color:#0a0; margin:0;">‚úì <?= e($message) ?></p>
    </div>
    <?php
}

/**
 * Display validation errors
 */
function showValidationErrors($errors) {
    if (empty($errors)) {
        return;
    }
    ?>
    <div style="background:#fee; border:1px solid #c66; border-radius:4px; padding:15px; margin:20px 0;">
        <p style="color:#c00; margin-top:0;"><strong>Please fix the following:</strong></p>
        <ul style="margin:10px 0; padding-left:20px;">
            <?php foreach ($errors as $field => $message): ?>
                <li>
                    <strong><?= e(ucfirst(str_replace('_', ' ', $field))) ?>:</strong>
                    <?= e($message) ?>
                </li>
            <?php endforeach; ?>
        </ul>
    </div>
    <?php
}

/**
 * Convert exception to user-friendly message
 */
function getErrorMessage($exception) {
    $message = $exception->getMessage();
    
    // Customize based on error type
    if (strpos($message, 'Duplicate email') !== false) {
        return 'This email address is already in use.';
    } elseif (strpos($message, 'File not found') !== false) {
        return 'System data file is missing. Please contact an administrator.';
    } elseif (strpos($message, 'Unable to acquire lock') !== false) {
        return 'System is busy. Please try again in a moment.';
    } else {
        return 'An unexpected error occurred. Please try again.';
    }
}

/**
 * Set custom error handler
 */
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    // Log PHP errors
    logError("PHP Error", [
        'error_code' => $errno,
        'error_string' => $errstr,
        'file' => $errfile,
        'line' => $errline,
    ]);
    
    // Don't execute default PHP error handler
    return true;
});

/**
 * Set exception handler
 */
set_exception_handler(function($e) {
    logError("Uncaught Exception", [
        'exception_class' => get_class($e),
        'message' => $e->getMessage(),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
    ]);
    
    // Display user-friendly message
    showError(
        'Something went wrong',
        getErrorMessage($e),
        $e->getFile() . ':' . $e->getLine() . ' - ' . $e->getMessage()
    );
    
    exit;
});

/**
 * Initialize logging on script start
 */
initializeErrorLogging();

?>


--- End of error_handler.php ---



--- Start of export_contacts.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';
require_once 'csv_export.php';
require_once 'error_handler.php';

$filename = 'contacts.csv';
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV($filename, $schema);

// Build filters from query string using schema
$filters = [];
foreach ($schema as $field) {
    if (!empty($_GET[$field])) {
        $filters[$field] = $_GET[$field];
    }
}

// Schema-safe export function
function exportCSVFiltered($filename, $rows, $filters = [], $schema = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered), $schema);
}

// Export filtered contacts to a new file
try {
    $exported = exportCSVFiltered('contacts_export.csv', $contacts, $filters, $schema);
    
    if ($exported) {
        $export_count = count(array_filter($contacts, function($row) use ($filters) {
            foreach ($filters as $key => $value) {
                if ($row[$key] !== $value) return false;
            }
            return true;
        }));
        
        logInfo('Contacts exported', ['count' => $export_count, 'filters' => json_encode($filters)]);
        
        // ‚úÖ AUDIT: Log export
        auditExport($export_count, $filters);
        
        echo "Export complete. " . $export_count . " contacts exported.";
    } else {
        echo "No matching contacts.";
        logWarning('Export found no matching contacts', ['filters' => json_encode($filters)]);
    }
} catch (Exception $e) {
    showError('Export failed', htmlspecialchars($e->getMessage()));
    logError('Contact export failed', ['exception' => $e->getMessage()]);
}
?>



--- End of export_contacts.php ---



--- Start of export_opportunities.php ---

<?php
require_once 'csv_handler.php';
require_once 'sanitize_helper.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Build contact lookup map
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $company = $contact['company'] ?? '';
    $contactMap[trim($contact['id'])] = [
        'name' => $fullName ?: 'Unnamed Contact',
        'company' => $company
    ];
}

// Get filter parameters
$filterStage = $_GET['stage'] ?? '';
$searchQuery = $_GET['search'] ?? '';

// Apply filters
$filteredOpportunities = $opportunities;

if ($filterStage) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($filterStage) {
        return ($opp['stage'] ?? '') === $filterStage;
    });
}

if ($searchQuery) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($searchQuery, $contactMap) {
        $contactId = trim($opp['contact_id'] ?? '');
        $contactName = $contactMap[$contactId]['name'] ?? '';
        $contactCompany = $contactMap[$contactId]['company'] ?? '';
        
        return stripos($contactName, $searchQuery) !== false ||
               stripos($contactCompany, $searchQuery) !== false ||
               stripos($opp['id'] ?? '', $searchQuery) !== false ||
               stripos($opp['stage'] ?? '', $searchQuery) !== false;
    });
}

// Set CSV headers
header('Content-Type: text/csv; charset=utf-8');
header('Content-Disposition: attachment; filename=opportunities_export_' . date('Y-m-d_His') . '.csv');

// Create output stream
$output = fopen('php://output', 'w');

// Write UTF-8 BOM for Excel compatibility
fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));

// Write headers
fputcsv($output, [
    'ID',
    'Contact Name',
    'Company',
    'Value',
    'Probability (%)',
    'Weighted Value',
    'Stage',
    'Expected Close Date'
]);

// Write data rows
foreach ($filteredOpportunities as $opp) {
    $contactId = trim($opp['contact_id'] ?? '');
    $contactInfo = $contactMap[$contactId] ?? ['name' => 'Unknown Contact', 'company' => ''];
    $value = floatval($opp['value'] ?? 0);
    $probability = floatval($opp['probability'] ?? 0);
    $weightedValue = $value * ($probability / 100);
    
    fputcsv($output, [
        $opp['id'] ?? '',
        $contactInfo['name'],
        $contactInfo['company'] ?: '‚Äî',
        number_format($value, 2),
        $probability,
        number_format($weightedValue, 2),
        $opp['stage'] ?? '',
        $opp['expected_close'] ?? '‚Äî'
    ]);
}

fclose($output);
exit;


--- End of export_opportunities.php ---



--- Start of follow_up_email.php ---

<?php
// follow_up_email.php

$contactName = $contact['name'] ?? 'there';
$companyName = $contact['company'] ?? 'your team';
$contactEmail = $contact['email'] ?? '';
$contactId = $contact['id'] ?? 0;
?>

<div class="module follow-up-email">
  <h3>Send Email</h3>
  <button onclick="generateEmail('followup')">Follow-Up After Call</button>
  <button onclick="generateEmail('intro')">Introductory Email</button>
  <button onclick="generateEmail('touchbase')">Touch Base Email</button>
  <button id="sendEmailBtn" onclick="sendFollowUpEmail()">Send Email</button>

  <textarea id="followUpEmail" rows="12" class="email-textarea"></textarea>
</div>

<script>
const contactName = "<?= htmlspecialchars($contactName, ENT_QUOTES) ?>";
const contactEmail = "<?= htmlspecialchars($contactEmail, ENT_QUOTES) ?>";
let currentEmailType = '';

function generateEmail(type) {
  currentEmailType = type;

  let body = '';
  switch (type) {
    case 'followup':
      body = `Hi ${contactName},

It was great speaking with you earlier. I wanted to follow up on our conversation and thank you for taking the time to connect.

At Eclipse Water Technologies, we‚Äôre committed to providing responsive, local service without the delays or complications of cross-border logistics. Whether it‚Äôs a complex treatment challenge or a routine system check, our team is here to support you.

If you have any questions or would like to explore next steps, feel free to reach out anytime.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'intro':
      body = `Hi ${contactName},

I wanted to introduce you to Eclipse Water Technologies ‚Äî a local provider of industrial water and wastewater solutions.

We specialize in everything from advanced treatment systems to simple filter replacements, and our team is known for responsive service and technical expertise. Being local means no border delays or tariffs ‚Äî just fast, reliable support.

We‚Äôd love to learn more about your needs and explore how we can help.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'touchbase':
      body = `Hi ${contactName},

I hope things are going well on your end. I just wanted to touch base and see if there‚Äôs anything you might need support with regarding your water or wastewater systems.

At Eclipse Water Technologies, we‚Äôre always happy to reconnect and help ‚Äî whether it‚Äôs a quick filter change or a more involved project.

Feel free to reach out anytime if you'd like to chat or explore options.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;
  }

  document.getElementById('followUpEmail').value = body;
}

function sendFollowUpEmail() {
  const emailBody = document.getElementById('followUpEmail').value.trim();
  const subjectLine = "Industrial Water Treatment - Eclipse Water Technologies";

  if (!contactEmail) {
    alert("No email address found for this contact.");
    return;
  }

  if (!emailBody) {
    alert("Email body is empty. Please generate or write your message.");
    return;
  }

  const mailtoLink = `mailto:${contactEmail}?subject=${encodeURIComponent(subjectLine)}&body=${encodeURIComponent(emailBody)}`;
  window.location.href = mailtoLink;
}
</script>

--- End of follow_up_email.php ---



--- Start of forecast_calc.php ---

<?php
require_once 'csv_handler.php';

function calculateForecasts($filename = 'opportunities.csv') {
    $schema = require __DIR__ . '/opportunity_schema.php';
    $opportunities = readCSV($filename, $schema);
    $results = [];
    $stageTotals = [];

    foreach ($opportunities as $opp) {
        $value = floatval($opp['value']);
        $probability = floatval($opp['probability']);
        $forecast = round($value * ($probability / 100), 2);

        $stage = $opp['stage'] ?? 'Unspecified';

        // Add to grouped stage totals
        if (!isset($stageTotals[$stage])) {
            $stageTotals[$stage] = ['count' => 0, 'total_forecast' => 0];
        }
        $stageTotals[$stage]['count']++;
        $stageTotals[$stage]['total_forecast'] += $forecast;

        // Add to individual forecast list
        $results[] = [
            'id' => $opp['id'] ?? '',
            'contact_id' => $opp['contact_id'] ?? '',
            'stage' => $stage,
            'value' => $value,
            'forecast' => $forecast
        ];
    }

    return [
        'individual' => $results,
        'by_stage' => $stageTotals
    ];
}
?>


--- End of forecast_calc.php ---



--- Start of get_oauth_token.php ---

<?php


require_once 'contact_validator.php';/**
 * PHPMailer - PHP email creation and transport class.
 * PHP Version 5.5
 * @package PHPMailer
 * @see https://github.com/PHPMailer/PHPMailer/ The PHPMailer GitHub project
 * @author Marcus Bointon (Synchro/coolbru) <phpmailer@synchromedia.co.uk>
 * @author Jim Jagielski (jimjag) <jimjag@gmail.com>
 * @author Andy Prevost (codeworxtech) <codeworxtech@users.sourceforge.net>
 * @author Brent R. Matzelle (original founder)
 * @copyright 2012 - 2020 Marcus Bointon
 * @copyright 2010 - 2012 Jim Jagielski
 * @copyright 2004 - 2009 Andy Prevost
 * @license https://www.gnu.org/licenses/old-licenses/lgpl-2.1.html GNU Lesser General Public License
 * @note This program is distributed in the hope that it will be useful - WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.
 */

/**
 * Get an OAuth2 token from an OAuth2 provider.
 * * Install this script on your server so that it's accessible
 * as [https/http]://<yourdomain>/<folder>/get_oauth_token.php
 * e.g.: http://localhost/phpmailer/get_oauth_token.php
 * * Ensure dependencies are installed with 'composer install'
 * * Set up an app in your Google/Yahoo/Microsoft account
 * * Set the script address as the app's redirect URL
 * If no refresh token is obtained when running this file,
 * revoke access to your app and run the script again.
 */

namespace PHPMailer\PHPMailer;

/**
 * Aliases for League Provider Classes
 * Make sure you have added these to your composer.json and run `composer install`
 * Plenty to choose from here:
 * @see https://oauth2-client.thephpleague.com/providers/thirdparty/
 */
//@see https://github.com/thephpleague/oauth2-google
use League\OAuth2\Client\Provider\Google;
//@see https://packagist.org/packages/hayageek/oauth2-yahoo
use Hayageek\OAuth2\Client\Provider\Yahoo;
//@see https://github.com/stevenmaguire/oauth2-microsoft
use Stevenmaguire\OAuth2\Client\Provider\Microsoft;
//@see https://github.com/greew/oauth2-azure-provider
use Greew\OAuth2\Client\Provider\Azure;

if (!isset($_GET['code']) && !isset($_POST['provider'])) {
    ?>
<html>
<body>
<form method="post">
    <h1>Select Provider</h1>
    <input type="radio" name="provider" value="Google" id="providerGoogle">
    <label for="providerGoogle">Google</label><br>
    <input type="radio" name="provider" value="Yahoo" id="providerYahoo">
    <label for="providerYahoo">Yahoo</label><br>
    <input type="radio" name="provider" value="Microsoft" id="providerMicrosoft">
    <label for="providerMicrosoft">Microsoft</label><br>
    <input type="radio" name="provider" value="Azure" id="providerAzure">
    <label for="providerAzure">Azure</label><br>
    <h1>Enter id and secret</h1>
    <p>These details are obtained by setting up an app in your provider's developer console.
    </p>
    <p>ClientId: <input type="text" name="clientId"><p>
    <p>ClientSecret: <input type="text" name="clientSecret"></p>
    <p>TenantID (only relevant for Azure): <input type="text" name="tenantId"></p>
    <input type="submit" value="Continue">
</form>
<?php include 'layout_end.php'; ?>
</body>
</html>
    <?php
    exit;
}

require 'vendor/autoload.php';

session_start();

$providerName = '';
$clientId = '';
$clientSecret = '';
$tenantId = '';

if (array_key_exists('provider', $_POST)) {
    $providerName = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST['provider'];
    $clientId = $_POST['clientId'];
    $clientSecret = $_POST['clientSecret'];
    $tenantId = $_POST['tenantId'];
    $_SESSION['provider'] = $providerName;
    $_SESSION['clientId'] = $clientId;
    $_SESSION['clientSecret'] = $clientSecret;
    $_SESSION['tenantId'] = $tenantId;
} elseif (array_key_exists('provider', $_SESSION)) {
    $providerName = $_SESSION['provider'];
    $clientId = $_SESSION['clientId'];
    $clientSecret = $_SESSION['clientSecret'];
    $tenantId = $_SESSION['tenantId'];
}

//If you don't want to use the built-in form, set your client id and secret here
//$clientId = 'RANDOMCHARS-----duv1n2.apps.googleusercontent.com';
//$clientSecret = 'RANDOMCHARS-----lGyjPcRtvP';

//If this automatic URL doesn't work, set it yourself manually to the URL of this script
$redirectUri = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'];
//$redirectUri = 'http://localhost/PHPMailer/redirect';

$params = [
    'clientId' => $clientId,
    'clientSecret' => $clientSecret,
    'redirectUri' => $redirectUri,
    'accessType' => 'offline'
];

$options = [];
$provider = null;

switch ($providerName) {
    case 'Google':
        $provider = new Google($params);
        $options = [
            'scope' => [
                'https://mail.google.com/'
            ]
        ];
        break;
    case 'Yahoo':
        $provider = new Yahoo($params);
        break;
    case 'Microsoft':
        $provider = new Microsoft($params);
        $options = [
            'scope' => [
                'wl.imap',
                'wl.offline_access'
            ]
        ];
        break;
    case 'Azure':
        $params['tenantId'] = $tenantId;

        $provider = new Azure($params);
        $options = [
            'scope' => [
                'https://outlook.office.com/SMTP.Send',
                'offline_access'
            ]
        ];
        break;
}

if (null === $provider) {
    exit('Provider missing');
}

if (!isset($_GET['code'])) {
    //If we don't have an authorization code then get one
    $authUrl = $provider->getAuthorizationUrl($options);
    $_SESSION['oauth2state'] = $provider->getState();
    header('Location: ' . $authUrl);
    exit;
    //Check given state against previously stored one to mitigate CSRF attack
} elseif (empty($_GET['state']) || ($_GET['state'] !== $_SESSION['oauth2state'])) {
    unset($_SESSION['oauth2state']);
    unset($_SESSION['provider']);
    exit('Invalid state');
} else {
    unset($_SESSION['provider']);
    //Try to get an access token (using the authorization code grant)
    $token = $provider->getAccessToken(
        'authorization_code',
        [
            'code' => $_GET['code']
        ]
    );
    //Use this to interact with an API on the users behalf
    //Use this to get a new access token if the old one expires
    echo 'Refresh Token: ', htmlspecialchars($token->getRefreshToken());
}


--- End of get_oauth_token.php ---



--- Start of get_tasks.php ---

<
<?php
$filename = 'tasks.csv';

if (!file_exists($filename)) {
    echo '<li>No tasks found.</li>';
    exit;
}

$tasks = [];

if (($fp = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($fp); // Read header row
    while (($row = fgetcsv($fp)) !== false) {
        if (empty($row) || count($row) < count($headers)) continue;
        $task = array_combine($headers, $row);
        if ($task['status'] !== 'archived') {
            $id = htmlspecialchars($task['id']);
            $title = htmlspecialchars($task['title']);
            $timestamp = htmlspecialchars($task['timestamp']);
            $tasks[] = "<li>$title (Created: $timestamp) <button onclick=\"archiveTask('$id')\">Archive</button></li>";
        }
    }
    fclose($fp);
}

echo '<ul>' . implode('', $tasks) . '</ul>';
?>
!R0b9052597723

--- End of get_tasks.php ---



--- Start of import_contacts.php ---

<?php
$pageTitle = 'Import Contacts';
$currentPage = basename(__FILE__);
include_once 'layout_start.php';
require_once 'csv_handler.php';
require_once 'contact_validator.php';

$schema = require __DIR__ . '/contact_schema.php';

// Constants for import validation
define('MAX_BATCH_SIZE', 1000);
define('MAX_FILE_SIZE', 5242880); // 5MB

?>

<div class="container">
  <h2>Import Contacts</h2>

  <!-- Upload Form with CSRF Token -->
  <form method="POST" enctype="multipart/form-data" class="contact-form">
    <?php echo renderCSRFInput(); ?>
    <label for="csv_file">Upload CSV File:</label>
    <input type="file" name="csv_file" accept=".csv" required>
    <small style="display:block; margin-top:5px; color:#666;">Max size: 5MB, Max rows: <?php echo MAX_BATCH_SIZE; ?></small>

    <!-- Buttons aligned horizontally -->
    <div style="margin-top: 10px;">
      <button type="submit">Preview Import</button>
      <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name']) && isset($_SESSION['import_valid']) && $_SESSION['import_valid'] === true): ?>
        <button type="button" class="btn-confirm" onclick="showConfirmModal()">Commit Import</button>
      <?php endif; ?>
    </div>
  </form>

  <?php
  // Initialize import validation status
  $_SESSION['import_valid'] = false;
  
  if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file'])) {
      // CSRF protection
      if (!verifyCSRFToken($_POST['csrf_token'] ?? '')) {
          showError('CSRF token validation failed. Please try again.');
      } elseif (!is_uploaded_file($_FILES['csv_file']['tmp_name'])) {
          showError('Invalid file upload.');
      } elseif ($_FILES['csv_file']['size'] > MAX_FILE_SIZE) {
          showError('File size exceeds 5MB limit.');
      } else {
          $tmp = $_FILES['csv_file']['tmp_name'];
          
          // Read CSV and validate structure
          $rows = array_map('str_getcsv', file($tmp));
          if (empty($rows)) {
              showError('CSV file is empty.');
          } else {
              $header = array_map('trim', array_shift($rows));
              
              // Check batch size
              if (count($rows) > MAX_BATCH_SIZE) {
                  showError('Import contains ' . count($rows) . ' rows. Maximum allowed: ' . MAX_BATCH_SIZE . ' rows.');
              } else {
                  // Validate each contact
                  $preview = [];
                  $validation_errors = [];
                  $duplicate_emails = [];
                  $existing_emails = [];
                  $row_number = 2; // CSV rows start at 2 (after header)
                  
                  // Load existing emails for duplicate checking
                  if (file_exists('contacts.csv')) {
                      $existing_contacts = readCSV('contacts.csv');
                      $existing_emails = array_column($existing_contacts, 'email');
                  }
                  
                  foreach ($rows as $row) {
                      $contact = array_combine($header, $row);
                      
                      // Field existence check
                      foreach ($schema as $field) {
                          if (!isset($contact[$field])) {
                              $contact[$field] = '';
                          }
                      }
                      
                      // Sanitize contact data
                      $contact = sanitizeContact($contact);
                      $contact['id'] = uniqid();
                      
                      // Validate contact
                      $contact_errors = validateContact($contact);
                      if (!empty($contact_errors)) {
                          $validation_errors[$row_number] = $contact_errors;
                      }
                      
                      // Check for duplicate email
                      if (!empty($contact['email'])) {
                          $email_lower = strtolower($contact['email']);
                          if (in_array($email_lower, $existing_emails, true)) {
                              $duplicate_emails[$row_number] = $contact['email'];
                          } elseif (isset($duplicate_emails[$row_number])) {
                              // Email is duplicate within import itself
                              if (!in_array($email_lower, array_column($preview, 'email'), true)) {
                                  // First occurrence, add to preview
                                  $preview[] = $contact;
                              } else {
                                  // Duplicate within this import
                                  $duplicate_emails[$row_number] = $contact['email'];
                              }
                          } else {
                              $preview[] = $contact;
                          }
                      } else {
                          $preview[] = $contact;
                      }
                      
                      $row_number++;
                  }
                  
                  // Display validation summary
                  $total_rows = count($rows);
                  $valid_rows = count($preview) - count($validation_errors);
                  $error_count = count($validation_errors) + count($duplicate_emails);
                  
                  echo "<div style='margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 4px;'>";
                  echo "<h3>Import Summary</h3>";
                  echo "<p><strong>Total rows:</strong> " . $total_rows . "</p>";
                  echo "<p><strong>Valid rows:</strong> <span style='color: green;'>" . $valid_rows . "</span></p>";
                  echo "<p><strong>Issues found:</strong> <span style='color: " . ($error_count > 0 ? 'red' : 'green') . ";'>" . $error_count . "</span></p>";
                  
                  if (empty($validation_errors) && empty($duplicate_emails)) {
                      echo "<p style='color: green; font-weight: bold;'>‚úì All contacts are valid and ready to import</p>";
                      $_SESSION['import_valid'] = true;
                  } else {
                      echo "<p style='color: orange; font-weight: bold;'>‚ö† Please review issues below before importing</p>";
                  }
                  echo "</div>";
                  
                  // Display validation errors
                  if (!empty($validation_errors) || !empty($duplicate_emails)) {
                      echo "<div style='margin-top: 15px; padding: 15px; background-color: #ffe6e6; border-radius: 4px; border-left: 4px solid #cc0000;'>";
                      echo "<h3>Issues Found</h3>";
                      
                      if (!empty($validation_errors)) {
                          echo "<p><strong>Validation Errors:</strong></p>";
                          echo "<ul>";
                          foreach ($validation_errors as $row_num => $errors) {
                              echo "<li><strong>Row " . $row_num . ":</strong> " . implode(", ", $errors) . "</li>";
                          }
                          echo "</ul>";
                      }
                      
                      if (!empty($duplicate_emails)) {
                          echo "<p><strong>Duplicate Emails (already exist or repeated in import):</strong></p>";
                          echo "<ul>";
                          foreach ($duplicate_emails as $row_num => $email) {
                              echo "<li><strong>Row " . $row_num . ":</strong> " . htmlspecialchars($email) . "</li>";
                          }
                          echo "</ul>";
                      }
                      echo "</div>";
                  }
                  
                  // Display preview table only for valid contacts
                  if (!empty($preview)) {
                      echo "<h3 style='margin-top: 20px;'>Preview - Valid Contacts (" . count($preview) . ")</h3>";
                      echo "<form method='POST' action='commit_import.php' id='commitForm'>";
                      echo renderCSRFInput();
                      echo "<table class='spec-table' style='font-size: 12px;'><thead><tr>";
                      foreach ($schema as $col) {
                          echo "<th>" . htmlspecialchars(ucfirst(str_replace('_', ' ', $col))) . "</th>";
                      }
                      echo "</tr></thead><tbody>";
                      foreach ($preview as $contact) {
                          echo "<tr>";
                          foreach ($schema as $col) {
                              $value = $contact[$col] ?? '';
                              echo "<td>" . htmlspecialchars(substr($value, 0, 50)) . (strlen($value) > 50 ? '...' : '') . "</td>";
                          }
                          echo "</tr>";
                      }
                      echo "</tbody></table>";
                      echo "</form>";
                      
                      $_SESSION['import_preview'] = $preview;
                  }
              }
          }
      }
  }
  ?>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Confirm Import</h3>
    <p>This will permanently add these contacts to the system. Proceed?</p>
    <button onclick="document.getElementById('commitForm').submit()">Yes, Commit</button>
    <button onclick="hideConfirmModal()">Cancel</button>
  </div>
</div>

<!-- Modal Styles & Script -->
<style>
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
}
.modal-box {
  background: #fff; padding: 20px 30px; border-radius: 8px; text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.modal-box button {
  margin: 10px; padding: 8px 16px; border: none; border-radius: 4px;
  background: #0077cc; color: #fff; cursor: pointer;
}
.modal-box button:hover {
  background: #005fa3;
}
</style>

<script>
function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
}
</script>

<?php include_once 'layout_end.php'; ?>


--- End of import_contacts.php ---



--- Start of index.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

require_once 'layout_start.php';
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];
$tasks = readCSV($filename, $schema);

$statusFilter = isset($_GET['status']) ? $_GET['status'] : '';
$year = isset($_GET['year']) ? $_GET['year'] : date('Y');
$month = isset($_GET['month']) ? $_GET['month'] : date('m');

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        if ($statusFilter === '' || $task['status'] === $statusFilter) {
            $tasksByDate[$task['due_date']][] = $task;
        }
    }
}

$prevMonth = $month - 1;
$prevYear = $year;
if ($prevMonth < 1) {
    $prevMonth = 12;
    $prevYear--;
}

$nextMonth = $month + 1;
$nextYear = $year;
if ($nextMonth > 12) {
    $nextMonth = 1;
    $nextYear++;
}
?>

<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }
  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }
  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }
  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>

<h2>Task Calendar</h2>

<div style="text-align:center; margin-bottom:20px;">
  <a href="?year=<?= $prevYear ?>&month=<?= str_pad($prevMonth, 2, '0', STR_PAD_LEFT) ?>">‚Üê Previous</a>
  <strong><?= date('F Y', strtotime("$year-$month-01")) ?></strong>
  <a href="?year=<?= $nextYear ?>&month=<?= str_pad($nextMonth, 2, '0', STR_PAD_LEFT) ?>">Next ‚Üí</a>
</div>

<form method="GET" style="margin-bottom: 20px;">
  <label for="status">Filter by status:</label>
  <select name="status" id="status" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="pending" <?= $statusFilter === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $statusFilter === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <input type="hidden" name="year" value="<?= $year ?>">
  <input type="hidden" name="month" value="<?= $month ?>">
</form>

<h3>Add New Task</h3>
<form method="POST" action="add_task.php" onsubmit="return validateForm()">
  <input type="text" name="title" id="title" placeholder="Task Title" required>
  <input type="date" name="due_date" id="due_date" required>
  <select name="status" id="status" required>
    <option value="">Select Status</option>
    <option value="pending">Pending</option>
    <option value="completed">Completed</option>
  </select>
  <button type="submit">Add Task</button>
</form>

<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
<?php
$daysInMonth = date('t', strtotime("$year-$month-01"));
$firstDayOfMonth = date('w', strtotime("$year-$month-01"));

$day = 1;
$week = [];

for ($i = 0; $i < $firstDayOfMonth; $i++) {
    $week[] = "<td></td>";
}

while ($day <= $daysInMonth) {
    $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
    if (isset($tasksByDate[$dateStr])) {
        $taskTitles = '';
        foreach ($tasksByDate[$dateStr] as $task) {
            $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
            $taskTitles .= "edit_task.php?timestamp=Edit</a> | ";
            $taskTitles .= "delete_task.php?timestamp=Delete</a><br><br>";
        }
        $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
    } else {
        $week[] = "<td>$day</td>";
    }

    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;
}


    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;

if (!empty($week)) {
    while (count($week) < 7) {
        $week[] = "<td></td>";
    }
    echo "<tr>" . implode('', $week) . "</tr>";
}
?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}

function validateForm() {
  const title = document.getElementById('title').value.trim();
  const dueDate = document.getElementById('due_date').value;
  const status = document.getElementById('status').value;

  if (title === '') {
    alert('Please enter a task title.');
    return false;
  }

  if (dueDate === '') {
    alert('Please select a due date.');
    return false;
  }

  if (status === '') {
    alert('Please select a status.');
    return false;
  }

  return true;
}
</script>

<?php include 'layout_end.php'; ?>


--- End of index.php ---



--- Start of inject_ids.php ---

<?php
function injectIdsIntoCsv($inputFile, $outputFile, $idPrefix = 'CNT') {
    $rows = array_map('str_getcsv', file($inputFile));
    $header = $rows[0];

    // Add ID column if missing
    if (!in_array('id', $header)) {
        array_unshift($header, 'id');
    }

    $newRows = [$header];
    for ($i = 1; $i < count($rows); $i++) {
        $row = $rows[$i];
        $id = $idPrefix . '_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
        array_unshift($row, $id);
        $newRows[] = $row;
    }

    // Write to output file
    $fp = fopen($outputFile, 'w');
    foreach ($newRows as $fields) {
        fputcsv($fp, $fields);
    }
    fclose($fp);
}


--- End of inject_ids.php ---



--- Start of inventory_add.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$errors = [];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $newItem = [];
  foreach ($schema as $f) {
    $newItem[$f] = trim($_POST[$f] ?? '');
  }
  // Always auto-generate item_id
  $newItem['item_id'] = uniqid('ITM_');
  $newItem['created_at'] = date('Y-m-d H:i:s');
  $newItem['updated_at'] = date('Y-m-d H:i:s');
  // Load and append
  $items = readCSV($inventoryFile, $schema);
  $items[] = $newItem;
  writeCSV($inventoryFile, $items, $schema);
  header('Location: inventory_list.php');
  exit;
}
?>
<div class="container">
  <h2>Add Inventory Item</h2>
  <form method="post" style="max-width:900px; margin:auto;">
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:18px;">
      <?php foreach ($schema as $f):
        if (in_array($f, ['created_at','updated_at'])) continue;
        $readonly = $f === 'item_id' ? 'readonly' : '';
        $value = '';
        if ($f === 'item_id') {
          $value = uniqid('ITM_');
        } else {
          $value = htmlspecialchars($_POST[$f] ?? '');
        }
      ?>
        <div style="display:flex; flex-direction:column;">
          <label for="<?= $f ?>" style="font-weight:600; margin-bottom:2px;"> <?= htmlspecialchars(ucwords(str_replace('_',' ',$f))) ?> </label>
          <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= $value ?>" style="padding:5px; border-radius:4px; border:1px solid #bbb;" <?= $readonly ?> >
        </div>
      <?php endforeach; ?>
    </div>
    <div style="margin-top:24px; text-align:center;">
      <button type="submit" class="btn-primary">üíæ Save Item</button>
      <a href="inventory_list.php" class="btn-outline">Cancel</a>
    </div>
  </form>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of inventory_add.php ---



--- Start of inventory_ledger.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$inventory = readCSV($inventoryFile, $inventorySchema);

$customerSchema = require __DIR__ . '/customer_schema.php';
$customersFile = __DIR__ . '/customers.csv';
$customers = readCSV($customersFile, $customerSchema);

$statusFile = __DIR__ . '/inventory_status_options.csv';
$ledgerFile = __DIR__ . '/inventory_ledger.csv';
$serialsFile = __DIR__ . '/inventory_serials.csv';

function read_status_options($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $options = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    while (($row = fgetcsv($handle)) !== false) {
      $value = trim($row[0] ?? '');
      if ($value !== '') {
        $options[] = $value;
      }
    }
    fclose($handle);
  }
  return array_values(array_unique($options));
}

function read_ledger($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_ledger_row($filename, $row) {
  $headers = ['item_id','item_name','quantity','status','action','client_id','client_name','serial_number','note','created_at'];
  $fileExists = file_exists($filename);
  $file = fopen($filename, 'a');
  if ($file === false) {
    return;
  }
  if (!$fileExists) {
    fputcsv($file, $headers);
  }
  $line = [];
  foreach ($headers as $header) {
    $line[] = $row[$header] ?? '';
  }
  fputcsv($file, $line);
  fclose($file);
}

function read_serials($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_serials($filename, $rows) {
  $headers = ['serial_number','item_id','item_name','status','client_id','client_name','assigned_at','note'];
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, $headers);
  foreach ($rows as $row) {
    $line = [];
    foreach ($headers as $header) {
      $line[] = $row[$header] ?? '';
    }
    fputcsv($file, $line);
  }
  fclose($file);
}

function write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $status, $clientId, $clientName, $note, $action) {
  $row = [
    'item_id' => $itemId,
    'item_name' => $itemName,
    'quantity' => '1',
    'status' => $status,
    'action' => $action,
    'client_id' => $clientId,
    'client_name' => $clientName,
    'serial_number' => $serialNumber,
    'note' => $note,
    'created_at' => date('Y-m-d H:i:s')
  ];
  write_ledger_row($ledgerFile, $row);
}

function find_item_name($inventory, $itemId) {
  foreach ($inventory as $row) {
    if (($row['item_id'] ?? '') === $itemId) {
      return $row['item_name'] ?? '';
    }
  }
  return '';
}

function build_customer_pairs($customers) {
  $pairs = [];
  foreach ($customers as $row) {
    $id = trim($row['customer_id'] ?? '');
    $name = trim($row['contact_name'] ?? '');
    if ($id === '' && $name === '') {
      continue;
    }
    $pairs[] = [
      'id' => $id,
      'name' => $name !== '' ? $name : $id
    ];
  }
  return $pairs;
}

$customerPairs = build_customer_pairs($customers);

$errors = [];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_ledger'])) {
  $itemId = trim($_POST['item_id'] ?? '');
  $itemName = trim($_POST['item_name'] ?? '');
  $quantity = trim($_POST['quantity'] ?? '');
  $status = trim($_POST['status'] ?? '');
  $action = trim($_POST['action'] ?? '');
  $clientId = trim($_POST['client_id'] ?? '');
  $clientName = trim($_POST['client_name'] ?? '');
  $serialNumber = trim($_POST['serial_number'] ?? '');
  $note = trim($_POST['note'] ?? '');

  if ($itemId === '' && $itemName === '') {
    $errors[] = 'Item ID or Item Name is required.';
  }
  if ($itemName === '' && $itemId !== '') {
    $itemName = find_item_name($inventory, $itemId);
  }
  if (!is_numeric($quantity)) {
    $errors[] = 'Quantity must be a number.';
  }
  if ($status === '') {
    $errors[] = 'Status is required.';
  }

  if (empty($errors)) {
    $row = [
      'item_id' => $itemId,
      'item_name' => $itemName,
      'quantity' => $quantity,
      'status' => $status,
      'action' => $action,
      'client_id' => $clientId,
      'client_name' => $clientName,
      'serial_number' => $serialNumber,
      'note' => $note,
      'created_at' => date('Y-m-d H:i:s')
    ];
    write_ledger_row($ledgerFile, $row);
    header('Location: inventory_ledger.php');
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_serial'])) {
  $serialNumber = trim($_POST['serial_number'] ?? '');
  $itemId = trim($_POST['serial_item_id'] ?? '');
  $itemName = trim($_POST['serial_item_name'] ?? '');
  $status = trim($_POST['serial_status'] ?? '');
  $clientId = trim($_POST['serial_client_id'] ?? '');
  $clientName = trim($_POST['serial_client_name'] ?? '');
  $note = trim($_POST['serial_note'] ?? '');

  if ($serialNumber === '') {
    $errors[] = 'Serial number is required.';
  }
  if ($itemName === '' && $itemId !== '') {
    $itemName = find_item_name($inventory, $itemId);
  }

  if (empty($errors)) {
    if (($clientId !== '' || $clientName !== '') && $status === '') {
      $status = 'Assigned';
    }
    if ($status === '') {
      $status = 'Stock';
    }
    $serials = read_serials($serialsFile);
    $updated = false;
    $assignedAt = ($clientId !== '' || $clientName !== '') ? date('Y-m-d H:i:s') : '';

    foreach ($serials as &$row) {
      if (($row['serial_number'] ?? '') === $serialNumber) {
        $row['item_id'] = $itemId;
        $row['item_name'] = $itemName;
        $row['status'] = $status;
        $row['client_id'] = $clientId;
        $row['client_name'] = $clientName;
        $row['assigned_at'] = $assignedAt;
        $row['note'] = $note;
        $updated = true;
        break;
      }
    }
    unset($row);

    if (!$updated) {
      $serials[] = [
        'serial_number' => $serialNumber,
        'item_id' => $itemId,
        'item_name' => $itemName,
        'status' => $status,
        'client_id' => $clientId,
        'client_name' => $clientName,
        'assigned_at' => $assignedAt,
        'note' => $note
      ];
    }

    write_serials($serialsFile, $serials);
    $action = ($clientId !== '' || $clientName !== '') ? 'Assign' : 'Move';
    write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $status, $clientId, $clientName, $note, $action);
    header('Location: inventory_ledger.php');
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_serial'])) {
  $serialNumber = trim($_POST['serial_number'] ?? '');
  $status = trim($_POST['update_status'] ?? '');
  $clientId = trim($_POST['update_client_id'] ?? '');
  $clientName = trim($_POST['update_client_name'] ?? '');
  $note = trim($_POST['update_note'] ?? '');

  if ($serialNumber === '') {
    $errors[] = 'Serial number is required for update.';
  }

  if (empty($errors)) {
    if (($clientId !== '' || $clientName !== '') && $status === '') {
      $status = 'Assigned';
    }
    $serials = read_serials($serialsFile);
    $updated = false;
    $itemId = '';
    $itemName = '';
    $finalStatus = $status;

    foreach ($serials as &$row) {
      if (($row['serial_number'] ?? '') === $serialNumber) {
        $itemId = $row['item_id'] ?? '';
        $itemName = $row['item_name'] ?? '';
        $finalStatus = $status !== '' ? $status : ($row['status'] ?? '');
        $row['status'] = $finalStatus;
        $row['client_id'] = $clientId;
        $row['client_name'] = $clientName;
        $row['assigned_at'] = ($clientId !== '' || $clientName !== '') ? date('Y-m-d H:i:s') : '';
        $row['note'] = $note;
        $updated = true;
        break;
      }
    }
    unset($row);

    if ($updated) {
      write_serials($serialsFile, $serials);
      $action = ($clientId !== '' || $clientName !== '') ? 'Assign' : 'Move';
      write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $finalStatus, $clientId, $clientName, $note, $action);
    }
    header('Location: inventory_ledger.php');
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['rfid_scan'])) {
  $serialNumber = trim($_POST['rfid_serial_number'] ?? '');
  $status = trim($_POST['rfid_status'] ?? '');
  $clientId = trim($_POST['rfid_client_id'] ?? '');
  $clientName = trim($_POST['rfid_client_name'] ?? '');
  $note = trim($_POST['rfid_note'] ?? '');
  $itemId = trim($_POST['rfid_item_id'] ?? '');
  $itemName = trim($_POST['rfid_item_name'] ?? '');

  if ($serialNumber === '') {
    $errors[] = 'RFID scan requires a serial number.';
  }

  if ($itemName === '' && $itemId !== '') {
    $itemName = find_item_name($inventory, $itemId);
  }

  if (empty($errors)) {
    if (($clientId !== '' || $clientName !== '') && $status === '') {
      $status = 'Assigned';
    }
    $serials = read_serials($serialsFile);
    $updated = false;
    $assignedAt = ($clientId !== '' || $clientName !== '') ? date('Y-m-d H:i:s') : '';

    foreach ($serials as &$row) {
      if (($row['serial_number'] ?? '') === $serialNumber) {
        if ($status !== '') {
          $row['status'] = $status;
        }
        if ($clientId !== '' || $clientName !== '') {
          $row['client_id'] = $clientId;
          $row['client_name'] = $clientName;
          $row['assigned_at'] = $assignedAt;
        }
        if ($note !== '') {
          $row['note'] = $note;
        }
        $itemId = $row['item_id'] ?? $itemId;
        $itemName = $row['item_name'] ?? $itemName;
        $status = $row['status'] ?? $status;
        $updated = true;
        break;
      }
    }
    unset($row);

    if (!$updated) {
      if ($itemId === '' && $itemName === '') {
        $errors[] = 'New serial requires item ID or item name.';
      } else {
        $serials[] = [
          'serial_number' => $serialNumber,
          'item_id' => $itemId,
          'item_name' => $itemName,
          'status' => $status !== '' ? $status : 'Stock',
          'client_id' => $clientId,
          'client_name' => $clientName,
          'assigned_at' => $assignedAt,
          'note' => $note
        ];
      }
    }

    if (empty($errors)) {
      write_serials($serialsFile, $serials);
      $action = ($clientId !== '' || $clientName !== '') ? 'Assign' : 'Move';
      $finalStatus = $status !== '' ? $status : 'Stock';
      write_serial_ledger_entry($ledgerFile, $serialNumber, $itemId, $itemName, $finalStatus, $clientId, $clientName, $note, $action);
      header('Location: inventory_ledger.php');
      exit;
    }
  }
}

$ledgerRows = read_ledger($ledgerFile);
$serialRows = read_serials($serialsFile);

$ledgerItemFilter = trim($_GET['ledger_item'] ?? '');
$ledgerStatusFilter = trim($_GET['ledger_status'] ?? '');
$ledgerClientFilter = trim($_GET['ledger_client'] ?? '');
$ledgerSerialFilter = trim($_GET['ledger_serial'] ?? '');

$ledgerFiltered = array_filter($ledgerRows, function($row) use ($ledgerItemFilter, $ledgerStatusFilter, $ledgerClientFilter, $ledgerSerialFilter) {
  $itemOk = $ledgerItemFilter === '' || stripos($row['item_id'] ?? '', $ledgerItemFilter) !== false || stripos($row['item_name'] ?? '', $ledgerItemFilter) !== false;
  $statusOk = $ledgerStatusFilter === '' || stripos($row['status'] ?? '', $ledgerStatusFilter) !== false;
  $clientValue = trim(($row['client_name'] ?? '') . ' ' . ($row['client_id'] ?? ''));
  $clientOk = $ledgerClientFilter === '' || stripos($clientValue, $ledgerClientFilter) !== false;
  $serialOk = $ledgerSerialFilter === '' || stripos($row['serial_number'] ?? '', $ledgerSerialFilter) !== false;
  return $itemOk && $statusOk && $clientOk && $serialOk;
});

$statusOptions = ['Stock', 'Production', 'On The Way', 'Backorder', 'Assigned'];
$statusOptions = array_values(array_unique(array_merge($statusOptions, read_status_options($statusFile))));
foreach ($serialRows as $row) {
  $value = trim($row['status'] ?? '');
  if ($value !== '' && !in_array($value, $statusOptions, true)) {
    $statusOptions[] = $value;
  }
}
sort($statusOptions);
?>
<div class="container">
  <h2>Inventory Ledger</h2>
  <?php if (!empty($errors)): ?>
    <div style="background:#ffecec; border:1px solid #f5baba; color:#8b1b1b; padding:10px 12px; border-radius:6px; margin-bottom:12px;">
      <?php foreach ($errors as $error): ?>
        <div><?= htmlspecialchars($error) ?></div>
      <?php endforeach; ?>
    </div>
  <?php endif; ?>

  <datalist id="customerNameList">
    <?php foreach ($customerPairs as $customer): ?>
      <option value="<?= htmlspecialchars($customer['name']) ?>"></option>
    <?php endforeach; ?>
  </datalist>
  <datalist id="customerIdList">
    <?php foreach ($customerPairs as $customer): ?>
      <?php if ($customer['id'] !== ''): ?>
        <option value="<?= htmlspecialchars($customer['id']) ?>"></option>
      <?php endif; ?>
    <?php endforeach; ?>
  </datalist>

  <div style="display:grid; grid-template-columns:1fr; gap:18px;">
    <div style="background:#fafbfc; border:1px solid #e6e6e6; border-radius:8px; padding:16px;">
      <div style="font-weight:700; margin-bottom:10px;">RFID Scan</div>
      <form method="post" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px 16px;">
        <input type="hidden" name="rfid_scan" value="1">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Serial Number</label>
          <input type="text" name="rfid_serial_number" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Status</label>
          <select name="rfid_status" class="status-select" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($statusOptions as $status): ?>
              <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item ID (if new)</label>
          <input type="text" name="rfid_item_id" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item Name (if new)</label>
          <input type="text" name="rfid_item_name" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client ID</label>
          <input type="text" name="rfid_client_id" class="client-id" list="customerIdList" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client Name</label>
          <input type="text" name="rfid_client_name" class="client-name" list="customerNameList" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1;">
          <label style="display:block; font-weight:600; margin-bottom:4px;">Note</label>
          <input type="text" name="rfid_note" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1; text-align:right;">
          <button type="submit" class="btn-primary">Log Scan</button>
        </div>
      </form>
    </div>
    <div style="background:#fafbfc; border:1px solid #e6e6e6; border-radius:8px; padding:16px;">
      <div style="font-weight:700; margin-bottom:10px;">Add Ledger Entry</div>
      <form method="post" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px 16px;">
        <input type="hidden" name="add_ledger" value="1">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item ID</label>
          <select name="item_id" id="ledgerItemId" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($inventory as $item): ?>
              <option value="<?= htmlspecialchars($item['item_id']) ?>" data-name="<?= htmlspecialchars($item['item_name'] ?? '') ?>">
                <?= htmlspecialchars($item['item_id']) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item Name</label>
          <input type="text" name="item_name" id="ledgerItemName" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Quantity</label>
          <input type="number" name="quantity" step="0.01" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Status</label>
          <select name="status" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($statusOptions as $status): ?>
              <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Action</label>
          <select name="action" style="width:100%; padding:6px 8px;">
            <option value="Receive">Receive</option>
            <option value="Move">Move</option>
            <option value="Adjust">Adjust</option>
            <option value="Assign">Assign</option>
            <option value="Return">Return</option>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Serial (optional)</label>
          <input type="text" name="serial_number" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client ID (optional)</label>
          <input type="text" name="client_id" class="client-id" list="customerIdList" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client Name (optional)</label>
          <input type="text" name="client_name" class="client-name" list="customerNameList" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1;">
          <label style="display:block; font-weight:600; margin-bottom:4px;">Note</label>
          <input type="text" name="note" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1; text-align:right;">
          <button type="submit" class="btn-primary">Add Entry</button>
        </div>
      </form>
    </div>

    <div style="background:#fafbfc; border:1px solid #e6e6e6; border-radius:8px; padding:16px;">
      <div style="font-weight:700; margin-bottom:10px;">Serials and Client Assignment</div>
      <form method="post" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px 16px;">
        <input type="hidden" name="save_serial" value="1">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Serial Number</label>
          <input type="text" name="serial_number" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item ID</label>
          <select name="serial_item_id" id="serialItemId" style="width:100%; padding:6px 8px;">
            <option value="">-- Select --</option>
            <?php foreach ($inventory as $item): ?>
              <option value="<?= htmlspecialchars($item['item_id']) ?>" data-name="<?= htmlspecialchars($item['item_name'] ?? '') ?>">
                <?= htmlspecialchars($item['item_id']) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Item Name</label>
          <input type="text" name="serial_item_name" id="serialItemName" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Status</label>
          <select name="serial_status" class="status-select" style="width:100%; padding:6px 8px;">
            <?php foreach ($statusOptions as $status): ?>
              <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client ID</label>
          <input type="text" name="serial_client_id" class="client-id" list="customerIdList" style="width:100%; padding:6px 8px;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:4px;">Client Name</label>
          <input type="text" name="serial_client_name" class="client-name" list="customerNameList" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1;">
          <label style="display:block; font-weight:600; margin-bottom:4px;">Note</label>
          <input type="text" name="serial_note" style="width:100%; padding:6px 8px;">
        </div>
        <div style="grid-column:1 / -1; text-align:right;">
          <button type="submit" class="btn-primary">Save Serial</button>
        </div>
      </form>
    </div>
  </div>

  <div style="margin-top:22px;">
    <div style="font-weight:700; margin-bottom:10px;">Ledger Entries</div>
    <?php if (empty($ledgerRows)): ?>
      <div style="color:#777;">No ledger entries yet.</div>
    <?php else: ?>
      <div style="overflow:auto; border:1px solid #e6e6e6; border-radius:6px; background:#fff;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f5f5f5;">
              <th style="padding:8px; text-align:left;">Item ID</th>
              <th style="padding:8px; text-align:left;">Item Name</th>
              <th style="padding:8px; text-align:left;">Qty</th>
              <th style="padding:8px; text-align:left;">Status</th>
              <th style="padding:8px; text-align:left;">Action</th>
              <th style="padding:8px; text-align:left;">Client</th>
              <th style="padding:8px; text-align:left;">Serial</th>
              <th style="padding:8px; text-align:left;">Note</th>
              <th style="padding:8px; text-align:left;">Date</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach (array_reverse($ledgerRows) as $row): ?>
              <tr>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['quantity'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['status'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['action'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars(trim(($row['client_name'] ?? '') . ' ' . ($row['client_id'] ?? ''))) ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['serial_number'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['note'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['created_at'] ?? '') ?></td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    <?php endif; ?>
  </div>

  <div style="margin-top:22px;">
    <div style="font-weight:700; margin-bottom:10px;">Serials</div>
    <?php if (empty($serialRows)): ?>
      <div style="color:#777;">No serialized items yet.</div>
    <?php else: ?>
      <div style="overflow:auto; border:1px solid #e6e6e6; border-radius:6px; background:#fff;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f5f5f5;">
              <th style="padding:8px; text-align:left;">Serial</th>
              <th style="padding:8px; text-align:left;">Item ID</th>
              <th style="padding:8px; text-align:left;">Item Name</th>
              <th style="padding:8px; text-align:left;">Status</th>
              <th style="padding:8px; text-align:left;">Client</th>
              <th style="padding:8px; text-align:left;">Assigned</th>
              <th style="padding:8px; text-align:left;">Note</th>
              <th style="padding:8px; text-align:left;">Update</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($serialRows as $row): ?>
              <tr>
                <td style="padding:8px;"><?= htmlspecialchars($row['serial_number'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['status'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars(trim(($row['client_name'] ?? '') . ' ' . ($row['client_id'] ?? ''))) ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['assigned_at'] ?? '') ?></td>
                <td style="padding:8px;"><?= htmlspecialchars($row['note'] ?? '') ?></td>
                <td style="padding:8px;">
                  <form method="post" style="display:grid; grid-template-columns:1fr 1fr; gap:6px; align-items:center;">
                    <input type="hidden" name="update_serial" value="1">
                    <input type="hidden" name="serial_number" value="<?= htmlspecialchars($row['serial_number'] ?? '') ?>">
                    <select name="update_status" class="status-select" style="padding:4px 6px;">
                      <option value="">-- Status --</option>
                      <?php foreach ($statusOptions as $status): ?>
                        <?php $selected = ($row['status'] ?? '') === $status ? 'selected' : ''; ?>
                        <option value="<?= htmlspecialchars($status) ?>" <?= $selected ?>><?= htmlspecialchars($status) ?></option>
                      <?php endforeach; ?>
                    </select>
                    <input type="text" name="update_client_id" class="client-id" list="customerIdList" placeholder="Client ID" value="<?= htmlspecialchars($row['client_id'] ?? '') ?>" style="padding:4px 6px;">
                    <input type="text" name="update_client_name" class="client-name" list="customerNameList" placeholder="Client Name" value="<?= htmlspecialchars($row['client_name'] ?? '') ?>" style="padding:4px 6px;">
                    <input type="text" name="update_note" placeholder="Note" value="<?= htmlspecialchars($row['note'] ?? '') ?>" style="padding:4px 6px;">
                    <button type="submit" class="btn-outline" style="grid-column:1 / -1;">Update</button>
                  </form>
                </td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    <?php endif; ?>
  </div>
</div>
<script>
  const ledgerItemId = document.getElementById('ledgerItemId');
  const ledgerItemName = document.getElementById('ledgerItemName');
  const serialItemId = document.getElementById('serialItemId');
  const serialItemName = document.getElementById('serialItemName');

  function syncName(selectEl, targetEl) {
    if (!selectEl || !targetEl) {
      return;
    }
    const selected = selectEl.options[selectEl.selectedIndex];
    if (selected && selected.dataset && selected.dataset.name !== undefined) {
      targetEl.value = selected.dataset.name;
    }
  }

  if (ledgerItemId && ledgerItemName) {
    ledgerItemId.addEventListener('change', () => syncName(ledgerItemId, ledgerItemName));
  }
  if (serialItemId && serialItemName) {
    serialItemId.addEventListener('change', () => syncName(serialItemId, serialItemName));
  }

  const customerPairs = <?= json_encode($customerPairs) ?>;

  function normalize(value) {
    return (value || '').toLowerCase().trim();
  }

  function findCustomerByName(value) {
    const needle = normalize(value);
    return customerPairs.find(customer => normalize(customer.name) === needle) || null;
  }

  function findCustomerById(value) {
    const needle = normalize(value);
    return customerPairs.find(customer => normalize(customer.id) === needle) || null;
  }

  function autoAssignStatus(form) {
    if (!form) {
      return;
    }
    const statusSelect = form.querySelector('select.status-select');
    const clientId = form.querySelector('input.client-id');
    const clientName = form.querySelector('input.client-name');
    const hasClient = (clientId && clientId.value.trim() !== '') || (clientName && clientName.value.trim() !== '');
    if (statusSelect && statusSelect.value === '' && hasClient) {
      statusSelect.value = 'Assigned';
    }
  }

  document.querySelectorAll('input.client-name').forEach(input => {
    input.addEventListener('input', () => {
      const match = findCustomerByName(input.value);
      const form = input.closest('form');
      if (match && form) {
        const idInput = form.querySelector('input.client-id');
        if (idInput && idInput.value.trim() === '') {
          idInput.value = match.id;
        }
      }
      autoAssignStatus(form);
    });
  });

  document.querySelectorAll('input.client-id').forEach(input => {
    input.addEventListener('input', () => {
      const match = findCustomerById(input.value);
      const form = input.closest('form');
      if (match && form) {
        const nameInput = form.querySelector('input.client-name');
        if (nameInput && nameInput.value.trim() === '') {
          nameInput.value = match.name;
        }
      }
      autoAssignStatus(form);
    });
  });
</script>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of inventory_ledger.php ---



--- Start of inventory_list.php ---


<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$items = readCSV($inventoryFile, $schema);
$statusFile = __DIR__ . '/inventory_status_options.csv';
$ledgerFile = __DIR__ . '/inventory_ledger.csv';
$serialsFile = __DIR__ . '/inventory_serials.csv';

function read_ledger($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function read_serials($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function add_status_total(&$totals, $itemId, $status, $qty) {
  if ($itemId === '' || $status === '') {
    return;
  }
  if (!isset($totals[$itemId])) {
    $totals[$itemId] = [];
  }
  if (!isset($totals[$itemId][$status])) {
    $totals[$itemId][$status] = 0.0;
  }
  $totals[$itemId][$status] += $qty;
}

$ledgerRows = read_ledger($ledgerFile);
$serialRows = read_serials($serialsFile);
$ledgerStatuses = [];
$serialStatuses = [];
$statusTotalsByItem = [];

foreach ($ledgerRows as $entry) {
  $itemId = trim($entry['item_id'] ?? '');
  $status = trim($entry['status'] ?? '');
  $qty = is_numeric($entry['quantity'] ?? '') ? (float)$entry['quantity'] : 0.0;
  add_status_total($statusTotalsByItem, $itemId, $status, $qty);
  if ($status !== '') {
    $ledgerStatuses[] = $status;
  }
}

foreach ($serialRows as $entry) {
  $itemId = trim($entry['item_id'] ?? '');
  $status = trim($entry['status'] ?? '');
  add_status_total($statusTotalsByItem, $itemId, $status, 1.0);
  if ($status !== '') {
    $serialStatuses[] = $status;
  }
}

function read_status_options($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $options = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    while (($row = fgetcsv($handle)) !== false) {
      $value = trim($row[0] ?? '');
      if ($value !== '') {
        $options[] = $value;
      }
    }
    fclose($handle);
  }
  return array_values(array_unique($options));
}

function write_status_options($filename, $options) {
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, ['status']);
  foreach ($options as $option) {
    fputcsv($file, [$option]);
  }
  fclose($file);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['status_action'])) {
  $action = trim($_POST['status_action'] ?? '');
  $value = trim($_POST['status_value'] ?? '');
  $options = read_status_options($statusFile);
  if ($action === 'add' && $value !== '') {
    if (!in_array($value, $options, true)) {
      $options[] = $value;
    }
  } elseif ($action === 'remove' && $value !== '') {
    $options = array_values(array_filter($options, function($opt) use ($value) {
      return $opt !== $value;
    }));
  }
  sort($options);
  write_status_options($statusFile, $options);
  header('Content-Type: application/json');
  echo json_encode(['statusOptions' => $options]);
  exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_inventory'])) {
  $itemId = trim($_POST['item_id'] ?? '');
  $activeIndex = trim($_POST['active_index'] ?? '');
  if ($itemId !== '') {
    $items = readCSV($inventoryFile, $schema);
    foreach ($items as &$row) {
      if (($row['item_id'] ?? '') === $itemId) {
        foreach ($schema as $field) {
          if (array_key_exists($field, $_POST)) {
            $row[$field] = trim($_POST[$field] ?? '');
          }
        }
        $cost = $row['cost_price'] ?? '';
        $margin = $row['margin'] ?? '';
        $costVal = is_numeric($cost) ? max(0, (float)$cost) : null;
        $marginVal = is_numeric($margin) ? max(0, (float)$margin) : null;
        if ($costVal !== null) {
          $row['cost_price'] = number_format($costVal, 2, '.', '');
        }
        if ($marginVal !== null) {
          $row['margin'] = number_format($marginVal, 2, '.', '');
        }
        if ($costVal !== null && $marginVal !== null) {
          $selling = $costVal * (1 + ($marginVal / 100));
          $row['selling_price'] = number_format($selling, 2, '.', '');
        }
        $row['updated_at'] = date('Y-m-d H:i:s');
        break;
      }
    }
    unset($row);
    writeCSV($inventoryFile, $items, $schema);
  }
  $redirect = 'inventory_list.php';
  if ($activeIndex !== '' && ctype_digit($activeIndex)) {
    $redirect .= '?active_index=' . urlencode($activeIndex);
  } elseif ($itemId !== '') {
    $redirect .= '?active_item=' . urlencode($itemId);
  }
  header('Location: ' . $redirect);
  exit;
}

// Build filter array from GET
$filters = [];
foreach ($schema as $f) {
    $filters[$f] = isset($_GET[$f]) ? trim($_GET[$f]) : '';
}

// Filter items by all non-empty fields
$filtered = $items;
foreach ($filters as $field => $val) {
    if ($val !== '') {
        $filtered = array_filter($filtered, function($item) use ($field, $val) {
            return stripos($item[$field] ?? '', $val) !== false;
        });
    }
}

$statusOptions = ['Stock', 'Production'];
$statusOptions = array_values(array_unique(array_merge(
  $statusOptions,
  read_status_options($statusFile),
  $ledgerStatuses,
  $serialStatuses
)));
foreach ($items as $row) {
  $status = trim($row['status'] ?? '');
  if ($status !== '' && !in_array($status, $statusOptions, true)) {
    $statusOptions[] = $status;
  }
}
sort($statusOptions);
?>
<div class="container">
  <h2>Inventory List</h2>
  <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
    <a href="inventory_add.php" class="btn-outline">‚ûï Add Item</a>
  </div>
  <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:14px;">
    <input type="text" id="invSearch" placeholder="Search by item name or ID" style="padding:6px 8px; border-radius:4px; border:1px solid #bbb; min-width:240px;">
    <select id="invStatus" style="padding:6px 8px; border-radius:4px; border:1px solid #bbb;">
      <option value="">All Status</option>
      <?php foreach ($statusOptions as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>"><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="button" id="invExpandAll">Expand All</button>
    <button type="button" id="invCollapseAll">Collapse All</button>
    <div id="invCount" style="margin-left:auto; color:#555;"></div>
  </div>
  <style>
    .inv-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    .inv-list {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      max-height: 70vh;
      overflow: auto;
    }
    .inv-list-item {
      width: 100%;
      text-align: left;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      background: #f9fafb;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .inv-list-item.active {
      background: #e9eef6;
      border-color: #8aa4c8;
    }
    .inv-list-title { font-weight: 600; margin-bottom: 4px; }
    .inv-list-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.9em;
      color: #555;
    }
    .inv-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f3f6;
      border: 1px solid #d9dee7;
    }
    .inv-pill.status { background: #eef4ff; border-color: #cddcff; color: #274690; }
    .inv-pill.qty { background: #e9f6ec; border-color: #b8e0c2; color: #1f6a35; }
    .inv-pill.stock-level { background: #fff6e5; border-color: #f5d19a; color: #8a5a00; }
    .inv-pill.low { background: #ffe8e8; border-color: #f2b6b6; color: #9b1c1c; }
    .inv-pill.ok { background: #e9f6ec; border-color: #b8e0c2; color: #1f6a35; }
    .inv-detail {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 14px;
      background: #fff;
      min-height: 200px;
    }
    .inv-detail-panel { display: none; }
    .inv-detail-panel.active { display: block; }
    .inv-detail-title { font-weight: 700; margin-bottom: 10px; }
    .inv-section {
      margin-bottom: 14px;
      border: 1px solid #e6e6e6;
      border-radius: 6px;
      padding: 10px 12px;
      background: #fafafa;
    }
    .inv-section-title {
      font-weight: 800;
      font-size: 1.05em;
      margin-bottom: 8px;
    }
    .inv-section-grid {
      display: grid;
      grid-template-columns: 160px 1fr 160px 1fr;
      gap: 8px 16px;
      align-items: center;
    }
    .inv-label { font-weight: 600; color: #222; }
    .inv-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #e6e6e6;
      background: #fff;
      box-sizing: border-box;
      font-size: 0.95em;
    }
    .inv-input[readonly] { background: #f5f5f5; }
    .inv-textarea { height: 70px; resize: vertical; }
    @media (max-width: 900px) {
      .inv-layout { grid-template-columns: 1fr; }
      .inv-list { max-height: none; }
      .inv-section-grid { grid-template-columns: 160px 1fr; }
    }
  </style>
  <?php if (empty($filtered)): ?>
    <div style="text-align:center; color:#888;">No items found.</div>
  <?php else: ?>
    <?php
      $sections = [
        'General' => ['item_id','item_name','description','category','brand','model','serial_number','barcode','rfid_tag','status','notes'],
        'Supplier' => ['supplier_id','supplier_name','purchase_date'],
        'Pricing' => ['cost_price','margin','selling_price','currency'],
        'Stock' => ['quantity_in_stock','reorder_level','reorder_quantity','unit'],
        'Location' => ['warehouse','location'],
        'Audit' => ['created_at','updated_at','created_by','updated_by']
      ];
    ?>
    <div class="inv-layout">
      <div class="inv-list" id="invList">
        <?php foreach ($filtered as $index => $row): ?>
          <?php
            $title = trim(($row['item_name'] ?? '') ?: ($row['item_id'] ?? 'Inventory Item'));
            $qty = $row['quantity_in_stock'] ?? '';
            $reorder = $row['reorder_quantity'] ?? '';
            $qtyNum = is_numeric($qty) ? (float)$qty : null;
            $reorderNum = is_numeric($reorder) ? (float)$reorder : null;
            $isLowStock = $qtyNum !== null && $reorderNum !== null && $qtyNum < $reorderNum;
          ?>
          <button
            type="button"
            class="inv-list-item"
            data-target="inv-detail-<?= $index ?>"
            data-item-name="<?= htmlspecialchars(strtolower($row['item_name'] ?? '')) ?>"
            data-item-id="<?= htmlspecialchars(strtolower($row['item_id'] ?? '')) ?>"
            data-status="<?= htmlspecialchars(strtolower($row['status'] ?? '')) ?>"
          >
            <div class="inv-list-title"><?= htmlspecialchars($title) ?></div>
            <div class="inv-list-meta">
              <?php if (!empty($row['item_id'])): ?><span class="inv-pill" data-role="id">ID: <?= htmlspecialchars($row['item_id']) ?></span><?php endif; ?>
              <?php if (!empty($row['status'])): ?><span class="inv-pill status" data-role="status">Status: <?= htmlspecialchars($row['status']) ?></span><?php endif; ?>
              <?php if ($qty !== ''): ?>
                <span class="inv-pill qty <?= $isLowStock ? 'low' : 'ok' ?>" data-role="qty">Qty: <?= htmlspecialchars($qty) ?></span>
              <?php endif; ?>
              <?php if ($reorder !== ''): ?>
                <span class="inv-pill stock-level" data-role="stock-level">Stock Level: <?= htmlspecialchars($reorder) ?></span>
              <?php endif; ?>
            </div>
          </button>
        <?php endforeach; ?>
      </div>
      <div class="inv-detail" id="invDetail">
        <?php foreach ($filtered as $index => $row): ?>
          <?php
            $title = trim(($row['item_name'] ?? '') ?: ($row['item_id'] ?? 'Inventory Item'));
            $itemId = $row['item_id'] ?? '';
            $statusTotals = $statusTotalsByItem[$itemId] ?? [];
            ksort($statusTotals);
          ?>
          <div class="inv-detail-panel" id="inv-detail-<?= $index ?>">
            <div class="inv-detail-title"><?= htmlspecialchars($title) ?></div>
            <div class="inv-section">
              <div class="inv-section-title">Status Quantities</div>
              <?php if (empty($statusTotals)): ?>
                <div style="color:#666;">No ledger or serialized quantities yet.</div>
              <?php else: ?>
                <table style="width:100%; border-collapse:collapse; background:#fff;">
                  <thead>
                    <tr style="background:#f5f5f5;">
                      <th style="padding:6px; text-align:left;">Status</th>
                      <th style="padding:6px; text-align:left;">Qty</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php foreach ($statusTotals as $status => $qty): ?>
                      <tr>
                        <td style="padding:6px;"><?= htmlspecialchars($status) ?></td>
                        <td style="padding:6px;"><?= htmlspecialchars((string)$qty) ?></td>
                      </tr>
                    <?php endforeach; ?>
                  </tbody>
                </table>
              <?php endif; ?>
            </div>
            <form method="post" class="inv-edit-form">
              <input type="hidden" name="save_inventory" value="1">
              <input type="hidden" name="active_index" value="<?= $index ?>">
            <?php foreach ($sections as $sectionName => $fields): ?>
              <?php
                $hasValue = false;
                foreach ($fields as $field) {
                  if (!empty($row[$field])) { $hasValue = true; break; }
                }
              ?>
              <div class="inv-section">
                <div class="inv-section-title"><?= htmlspecialchars($sectionName) ?></div>
                <div class="inv-section-grid">
                  <?php foreach ($fields as $field): ?>
                    <?php
                      $label = ucwords(str_replace('_', ' ', $field));
                      if ($field === 'margin') {
                        $label = 'Margin (%)';
                      }
                    ?>
                    <div class="inv-label"><?= htmlspecialchars($label) ?></div>
                    <?php
                      $value = trim($row[$field] ?? '');
                      if ($field === 'margin' && $value === '') {
                        $value = '30';
                      }
                    ?>
                    <?php
                      $readonly = in_array($field, ['item_id', 'created_at', 'updated_at']);
                      $isTextarea = in_array($field, ['description', 'notes']);
                      $dataRole = '';
                      if ($field === 'cost_price') { $dataRole = 'cost'; }
                      if ($field === 'margin') { $dataRole = 'margin'; }
                      if ($field === 'selling_price') { $dataRole = 'selling'; }
                      $dataAttr = $dataRole !== '' ? ' data-role="' . $dataRole . '"' : '';
                    ?>
                    <?php if ($field === 'status'): ?>
                      <div>
                        <select class="inv-input status-select" name="status" data-current="<?= htmlspecialchars($value) ?>"></select>
                        <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
                          <input type="text" class="inv-input status-input" placeholder="Add status" style="max-width:160px;">
                          <button type="button" class="status-add">Add</button>
                          <button type="button" class="status-remove">Remove</button>
                        </div>
                      </div>
                    <?php elseif ($isTextarea): ?>
                      <textarea class="inv-input inv-textarea" name="<?= $field ?>" <?= $readonly ? 'readonly' : '' ?><?= $dataAttr ?>><?= htmlspecialchars($value) ?></textarea>
                    <?php else: ?>
                      <input class="inv-input" type="text" name="<?= $field ?>" value="<?= htmlspecialchars($value) ?>" <?= $readonly ? 'readonly' : '' ?><?= $dataAttr ?>>
                    <?php endif; ?>
                  <?php endforeach; ?>
                </div>
              </div>
            <?php endforeach; ?>
              <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit">Save Changes</button>
              </div>
            </form>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
    <div id="invNoMatch" style="display:none; text-align:center; color:#888; margin-top:12px;">No matching items.</div>
    <script>
      const listItems = Array.from(document.querySelectorAll('.inv-list-item'));
      const detailPanels = Array.from(document.querySelectorAll('.inv-detail-panel'));
      const searchInput = document.getElementById('invSearch');
      const statusSelect = document.getElementById('invStatus');
      const countEl = document.getElementById('invCount');
      const noMatchEl = document.getElementById('invNoMatch');
      const activeItemId = (new URLSearchParams(window.location.search).get('active_item') || '').toLowerCase();
      const activeIndexParam = new URLSearchParams(window.location.search).get('active_index');
      const activeIndex = Number.isInteger(parseInt(activeIndexParam, 10)) ? parseInt(activeIndexParam, 10) : -1;

      const defaultStatusOptions = <?= json_encode($statusOptions) ?>;
      let statusOptions = Array.from(new Set(defaultStatusOptions)).sort();

      function renderStatusSelects() {
        document.querySelectorAll('.status-select').forEach(select => {
          const current = select.getAttribute('data-current') || '';
          select.innerHTML = '';
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'Select status';
          select.appendChild(emptyOption);
          statusOptions.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            select.appendChild(option);
          });
          if (current && !statusOptions.includes(current)) {
            const customOption = document.createElement('option');
            customOption.value = current;
            customOption.textContent = current;
            select.appendChild(customOption);
          }
          select.value = current;
        });
      }

      function renderFilterStatusOptions() {
        if (!statusSelect) {
          return;
        }
        const current = statusSelect.value || '';
        statusSelect.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'All Status';
        statusSelect.appendChild(allOption);
        statusOptions.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          statusSelect.appendChild(option);
        });
        if (current && !statusOptions.includes(current)) {
          const customOption = document.createElement('option');
          customOption.value = current;
          customOption.textContent = current;
          statusSelect.appendChild(customOption);
        }
        statusSelect.value = current;
      }

      function syncStatusOptions(action, value) {
        const formData = new FormData();
        formData.append('status_action', action);
        formData.append('status_value', value);
        return fetch('inventory_list.php', {
          method: 'POST',
          body: formData
        })
          .then(response => response.ok ? response.json() : null)
          .then(data => {
            if (data && Array.isArray(data.statusOptions)) {
              statusOptions = Array.from(new Set(data.statusOptions)).sort();
              renderStatusSelects();
              renderFilterStatusOptions();
            }
          })
          .catch(() => {});
      }

      function activateItem(item) {
        listItems.forEach(btn => btn.classList.remove('active'));
        detailPanels.forEach(panel => panel.classList.remove('active'));
        if (!item) {
          return;
        }
        item.classList.add('active');
        const targetId = item.getAttribute('data-target');
        const panel = document.getElementById(targetId);
        if (panel) {
          panel.classList.add('active');
        }
        item.scrollIntoView({ block: 'nearest' });
      }

      listItems.forEach(btn => {
        btn.addEventListener('click', () => activateItem(btn));
      });

      document.querySelectorAll('.inv-edit-form').forEach(form => {
        form.addEventListener('submit', event => {
          if (!confirm('Save changes to this inventory item?')) {
            event.preventDefault();
          }
        });

        form.querySelectorAll('.status-add').forEach(btn => {
          btn.addEventListener('click', () => {
            const input = form.querySelector('.status-input');
            const newStatus = (input.value || '').trim();
            if (newStatus && !statusOptions.includes(newStatus)) {
              statusOptions.push(newStatus);
              statusOptions.sort();
              renderStatusSelects();
              renderFilterStatusOptions();
              syncStatusOptions('add', newStatus);
            }
            input.value = '';
          });
        });

        form.querySelectorAll('.status-remove').forEach(btn => {
          btn.addEventListener('click', () => {
            const select = form.querySelector('.status-select');
            const value = select.value;
            if (value === '') {
              return;
            }
            statusOptions = statusOptions.filter(s => s !== value);
            renderStatusSelects();
            renderFilterStatusOptions();
            syncStatusOptions('remove', value);
          });
        });

        const statusSelectEl = form.querySelector('.status-select');
        if (statusSelectEl) {
          statusSelectEl.addEventListener('change', () => {
            const panel = statusSelectEl.closest('.inv-detail-panel');
            if (!panel) {
              return;
            }
            const targetId = panel.getAttribute('id');
            const listItem = document.querySelector(`.inv-list-item[data-target="${targetId}"]`);
            if (listItem) {
              const newStatus = statusSelectEl.value;
              listItem.setAttribute('data-status', (newStatus || '').toLowerCase());
              const meta = listItem.querySelector('.inv-list-meta');
              if (meta) {
                let statusPill = meta.querySelector('[data-role="status"]');
                if (newStatus) {
                  if (!statusPill) {
                    statusPill = document.createElement('span');
                    statusPill.className = 'inv-pill status';
                    statusPill.setAttribute('data-role', 'status');
                    meta.appendChild(statusPill);
                  }
                  statusPill.textContent = `Status: ${newStatus}`;
                  statusPill.style.display = '';
                } else if (statusPill) {
                  statusPill.style.display = 'none';
                }
              }
            }
            filterList();
          });
        }

        const costInput = form.querySelector('input[name="cost_price"]');
        const marginInput = form.querySelector('input[name="margin"]');
        const sellingInput = form.querySelector('input[name="selling_price"]');

        function updateSellingPrice() {
          if (!costInput || !marginInput || !sellingInput) {
            return;
          }
          const cost = parseFloat(costInput.value);
          const margin = parseFloat(marginInput.value);
          if (!Number.isFinite(cost) || !Number.isFinite(margin) || margin === 0) {
            return;
          }
          const selling = cost * (1 + (margin / 100));
          if (Number.isFinite(selling)) {
            sellingInput.value = selling.toFixed(2);
          }
        }

        if (costInput) {
          costInput.addEventListener('input', updateSellingPrice);
        }
        if (marginInput) {
          marginInput.addEventListener('input', updateSellingPrice);
        }

        updateSellingPrice();
      });

      function filterList() {
        const query = (searchInput.value || '').trim().toLowerCase();
        const status = (statusSelect.value || '').trim().toLowerCase();
        let visibleCount = 0;
        let firstVisible = null;

        listItems.forEach(btn => {
          const name = btn.getAttribute('data-item-name') || '';
          const id = btn.getAttribute('data-item-id') || '';
          const itemStatus = btn.getAttribute('data-status') || '';
          const matchesQuery = query === '' || name.includes(query) || id.includes(query);
          const matchesStatus = status === '' || itemStatus === status;
          const show = matchesQuery && matchesStatus;
          btn.style.display = show ? '' : 'none';
          if (show) {
            visibleCount += 1;
            if (!firstVisible) {
              firstVisible = btn;
            }
          }
        });

        if (countEl) {
          countEl.textContent = `${visibleCount} item(s)`;
        }
        if (noMatchEl) {
          noMatchEl.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        const active = document.querySelector('.inv-list-item.active');
        if (!active || active.style.display === 'none') {
          activateItem(firstVisible);
        }
      }

      searchInput.addEventListener('input', filterList);
      statusSelect.addEventListener('change', filterList);

      renderStatusSelects();
      renderFilterStatusOptions();
      let initialItem = null;
      if (activeIndex >= 0 && activeIndex < listItems.length) {
        initialItem = listItems[activeIndex];
      } else if (activeItemId) {
        initialItem = listItems.find(item => (item.getAttribute('data-item-id') || '') === activeItemId);
      }
      if (!initialItem) {
        initialItem = listItems[0];
      }
      activateItem(initialItem);
      filterList();
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of inventory_list.php ---



--- Start of inventory_schema.php ---

<?php
return [
    'item_id',
    'item_name',
    'description',
    'category',
    'brand',
    'model',
    'serial_number',
    'barcode',
    'rfid_tag',
    'supplier_id',
    'supplier_name',
    'purchase_date',
    'cost_price',
    'margin',
    'selling_price',
    'currency',
    'quantity_in_stock',
    'reorder_level',
    'reorder_quantity',
    'unit',
    'warehouse',
    'location',
    'status',
    'created_at',
    'updated_at',
    'created_by',
    'updated_by',
    'notes'
];


--- End of inventory_schema.php ---



--- Start of layout_end.php ---

  </div> <!-- end content-container -->
</div> <!-- end main-content -->

<script src="js/modern-ui.js?v=20260213"></script>
</body>
</html>


--- End of layout_end.php ---



--- Start of layout_start.php ---

<?php
require_once __DIR__ . '/simple_auth/middleware.php';
require_once __DIR__ . '/backup_handler.php';
require_once __DIR__ . '/error_handler.php';
require_once __DIR__ . '/csrf_helper.php';
require_once __DIR__ . '/sanitize_helper.php';
require_once __DIR__ . '/audit_handler.php';

// Initialize CSRF token for this session
initializeCSRFToken();

// Security headers
header('Content-Type: text/html; charset=UTF-8');
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY');
header('X-XSS-Protection: 1; mode=block');
header('Referrer-Policy: strict-origin-when-cross-origin');
header("Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:;");

// Disable caching for pages with sensitive data
if (strpos($_SERVER['REQUEST_URI'], 'admin') !== false || strpos($_SERVER['REQUEST_URI'], 'contact') !== false) {
    header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
    header('Pragma: no-cache');
}

$pageTitle = $pageTitle ?? 'CRM';
$currentPage = basename($_SERVER['SCRIPT_NAME']);
?>
<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="CRM system for managing contacts and customer interactions.">
  <meta name="author" content="Eclipse Water Technologies">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="<?= htmlspecialchars($pageTitle) ?>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/<?= htmlspecialchars($currentPage) ?>">
  <meta property="og:image" content="https://yourdomain.com/images/preview.png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css?v=20251002">
    <link rel="stylesheet" href="css/modern-sidebar.css?v=20260213-2">
  <link rel="stylesheet" href="css/modern-components.css?v=20260213">
  <script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
  <title><?= htmlspecialchars($pageTitle) ?></title>
</head>
<body>
<?php include_once 'navbar-sidebar.php'; ?>

<?php
// Display error messages if present
if (isset($_GET['error'])) {
    $errorMessages = [
        'access_denied' => '‚ö†Ô∏è Access Denied: You do not have permission to access admin tools. Admin privileges required.',
        'not_found' => 'The requested page was not found.',
        'invalid_request' => 'Invalid request received.',
    ];
    $errorType = $_GET['error'];
    if (isset($errorMessages[$errorType])) {
        echo '<div style="background:#fee;border:1px solid #fcc;padding:15px;margin:20px;border-radius:4px;color:#c33;">';
        echo htmlspecialchars($errorMessages[$errorType]);
        echo '</div>';
    }
}

// Display success messages if present
if (isset($_GET['success'])) {
    $successMessages = [
        'updated' => '‚úì Successfully updated.',
        'created' => '‚úì Successfully created.',
        'deleted' => '‚úì Successfully deleted.',
    ];
    $successType = $_GET['success'];
    if (isset($successMessages[$successType])) {
        echo '<div style="background:#efe;border:1px solid #cfc;padding:15px;margin:20px;border-radius:4px;color:#363;">';
        echo htmlspecialchars($successMessages[$successType]);
        echo '</div>';
    }
}
?>


--- End of layout_start.php ---



--- Start of navbar-sidebar.php ---

<?php
// Get current user info from session
$current_user = auth_current_user();
$user_name = $current_user['username'] ?? 'Guest';
$user_role = $_SESSION['role'] ?? 'user';
$is_admin = $user_role === 'admin';

// Get initials for avatar
$initials = strtoupper(substr($user_name, 0, 2));
?>

<!-- Sidebar Overlay (mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <!-- Logo -->
  <div class="sidebar-header">
    <div class="sidebar-logo">Eclipse CRM</div>
  </div>
  
  <!-- User Info -->
  <div class="sidebar-user">
    <div class="user-avatar"><?= $initials ?></div>
    <div class="user-info">
      <div class="user-name"><?= htmlspecialchars($user_name) ?></div>
      <div class="user-role"><?= ucfirst($user_role) ?></div>
    </div>
  </div>
  
  <!-- Navigation -->
  <nav class="sidebar-nav">
    
    <!-- MAIN SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Main</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.php" class="nav-link <?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- CONTACTS SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Contacts</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="contacts_list.php" class="nav-link <?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üë•</span>
            <span>All Contacts</span>
            <?php 
            require_once 'csv_handler.php';
            $contact_count = count(readCSV('contacts.csv', require 'contact_schema.php'));
            ?>
            <span class="nav-badge"><?= $contact_count ?></span>
          </a>
        </li>
        <li class="nav-item">
          <a href="contact_form.php" class="nav-link <?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Contact</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="import_contacts.php" class="nav-link <?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
            <span class="nav-icon">üì•</span>
            <span>Import</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="export_contacts.php" class="nav-link <?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
            <span class="nav-icon">üì§</span>
            <span>Export</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- CUSTOMERS SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Customers</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="customers_list.php" class="nav-link <?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìã</span>
            <span>All Customers</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="add_customer.php" class="nav-link <?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Customer</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- SALES SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Sales</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="pipeline_board.php" class="nav-link <?= $currentPage === 'pipeline_board.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìä</span>
            <span>Pipeline Board</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="opportunities_list.php" class="nav-link <?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìã</span>
            <span>Opportunities List</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="contracts_list.php" class="nav-link <?= $currentPage === 'contracts_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìÑ</span>
            <span>All Contracts</span>
            <?php 
            $contracts_count = count(readCSV('contracts.csv', require __DIR__ . '/contract_schema.php') ?: []);
            if ($contracts_count > 0):
            ?>
            <span class="nav-badge"><?= $contracts_count ?></span>
            <?php endif; ?>
          </a>
        </li>
        <li class="nav-item">
          <a href="renewals.php" class="nav-link <?= $currentPage === 'renewals.php' ? 'active' : '' ?>">
            <span class="nav-icon">üîÑ</span>
            <span>Renewals</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="revenue_dashboard.php" class="nav-link <?= $currentPage === 'revenue_dashboard.php' ? 'active' : '' ?>">
            <span class="nav-icon">üí∞</span>
            <span>Revenue Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="add_opportunity.php" class="nav-link <?= $currentPage === 'add_opportunity.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Opportunity</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="contract_form.php" class="nav-link <?= $currentPage === 'contract_form.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Contract</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="calendar.php" class="nav-link <?= $currentPage === 'calendar.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìÖ</span>
            <span>Calendar</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- EQUIPMENT SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Equipment</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="equipment_list.php" class="nav-link <?= $currentPage === 'equipment_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üîß</span>
            <span>All Equipment</span>
            <?php 
            $equipment_count = count(readCSV('equipment.csv', require __DIR__ . '/equipment_schema.php') ?: []);
            if ($equipment_count > 0):
            ?>
            <span class="nav-badge"><?= $equipment_count ?></span>
            <?php endif; ?>
          </a>
        </li>
        <li class="nav-item">
          <a href="equipment_form.php" class="nav-link <?= $currentPage === 'equipment_form.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ûï</span>
            <span>Add Equipment</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- INVENTORY SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Inventory</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="inventory_list.php" class="nav-link <?= $currentPage === 'inventory_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üì¶</span>
            <span>Products</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="inventory_ledger.php" class="nav-link <?= $currentPage === 'inventory_ledger.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìä</span>
            <span>Ledger</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="backorders_list.php" class="nav-link <?= $currentPage === 'backorders_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">‚ö†Ô∏è</span>
            <span>Backorders</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="purchase_orders_list.php" class="nav-link <?= $currentPage === 'purchase_orders_list.php' ? 'active' : '' ?>">
            <span class="nav-icon">üßæ</span>
            <span>Purchase Orders</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- ADMIN SECTION (always visible) -->
    <div class="nav-section">
      <div class="nav-section-title">Administration</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="admin_dashboard.php" class="nav-link <?= $currentPage === 'admin_dashboard.php' ? 'active' : '' ?>" style="font-weight:bold;color:#0099A8;background:#fff;border:2px solid #0099A8;">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Admin Dashboard</span>
          </a>
        </li>
        <?php if ($is_admin): ?>
        <li class="nav-item">
          <a href="admin_users.php" class="nav-link <?= $currentPage === 'admin_users.php' ? 'active' : '' ?>">
            <span class="nav-icon">üë•</span>
            <span>Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="admin_backups.php" class="nav-link <?= $currentPage === 'admin_backups.php' ? 'active' : '' ?>">
            <span class="nav-icon">üîÑ</span>
            <span>Backups</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="admin_audit.php" class="nav-link <?= $currentPage === 'admin_audit.php' ? 'active' : '' ?>">
            <span class="nav-icon">üìã</span>
            <span>Audit Log</span>
          </a>
        </li>
        <?php endif; ?>
      </ul>
    </div>
    
    <!-- ADMIN PORTAL LINK (always visible, parallel to CRM) -->
    <div class="nav-section">
      <div class="nav-section-title">Admin Portal</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="/CRM/admin-portal/" class="nav-link" target="_blank" rel="noopener" style="font-weight:bold;color:#fff;background:#0099A8;border:2px solid #0099A8;">
            <span class="nav-icon">üõ°Ô∏è</span>
            <span>Open Admin Portal</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- ACCOUNT SECTION -->
    <div class="nav-section">
      <div class="nav-section-title">Account</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="simple_auth/logout.php" class="nav-link">
            <span class="nav-icon">üö™</span>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </div>
    
  </nav>
</aside>

<!-- Main Content Wrapper -->
<div class="main-content" id="mainContent">
  
  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-left">
      <button class="menu-toggle" id="menuToggle">
        ‚ò∞
      </button>
      <h1 class="page-title">
        <?php
        // Auto-generate page title from filename
        $title = str_replace(['_', '.php'], [' ', ''], $currentPage);
        echo ucwords($title);
        ?>
      </h1>
    </div>
    
    <div class="topbar-right">
      <!-- Global Search -->
      <form method="GET" action="contacts_list.php" class="search-bar" style="display: flex; align-items: center; gap: 8px; margin: 0;">
        <span class="search-icon">üîç</span>
        <input type="text" 
               class="search-input" 
               name="query"
               placeholder="Search contacts, companies..."
               id="globalSearch"
               value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
        <input type="hidden" name="field" value="">
        <button type="submit" style="display: none;"></button>
      </form>
    </div>
  </div>
  
  <!-- Page Content -->
  <div class="content-container">
    <!-- Page content goes here (from included PHP files) -->
  </div>
</div>

--- End of navbar-sidebar.php ---



--- Start of navbar.php ---

<nav class="navbar">
  <ul>
    <li><a href="dashboard.php" class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">Dashboard</a></li>
    <li><a href="contacts_list.php" class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">Contact List</a></li>
    <li><a href="add_customer.php" class="<?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">‚ûï Add Customer</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üìã Customer List</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üëÅ View Customers</a></li>
    <li><a href="calendar.php" class="<?= $currentPage === 'calendar.php' ? 'active' : '' ?>">üìÖ Calendar</a></li>
    <li><a href="contact_form.php" class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">Add Contact</a></li>
    <li><a href="opportunities_list.php" class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">Opportunities</a></li>
    <li><a href="add_opportunity.php" class="<?= $currentPage === 'add_opportunity.php' ? 'active' : '' ?>">Add Opportunity</a></li>
    <li><a href="import_contacts.php" class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">Import</a></li>
    <li><a href="export_contacts.php" class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">Export</a></li>
    <li><a href="inventory_list.php" class="<?= $currentPage === 'inventory_list.php' ? 'active' : '' ?>">üì¶ Inventory</a></li>
    <li><a href="inventory_ledger.php" class="<?= $currentPage === 'inventory_ledger.php' ? 'active' : '' ?>">üì¶ Inventory Ledger</a></li>
    <li><a href="backorders_list.php" class="<?= $currentPage === 'backorders_list.php' ? 'active' : '' ?>">üì¶ Backorders</a></li>
    <li><a href="purchase_orders_list.php" class="<?= $currentPage === 'purchase_orders_list.php' ? 'active' : '' ?>">üßæ Purchase Orders</a></li>
    <li><a href="admin_dashboard.php" class="<?= $currentPage === 'admin_dashboard.php' ? 'active' : '' ?>">‚öôÔ∏è Admin</a></li>
    <?php if (auth_check()): ?>
      <li style="margin-left: auto;">
        <span style="margin-right: 15px;">üë§ <?= htmlspecialchars(auth_current_user()['username']) ?></span>
        <a href="simple_auth/logout.php" style="color: #e74c3c;">Logout</a>
      </li>
    <?php else: ?>
      <li style="margin-left: auto;">
        <a href="simple_auth/login.php">Login</a> | 
        <a href="simple_auth/register.php">Register</a>
      </li>
    <?php endif; ?>
  </ul>
</nav>


--- End of navbar.php ---



--- Start of opportunities_list.php ---


<?php
require_once 'csv_handler.php';
require_once 'sanitize_helper.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

// Build contact lookup map
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $company = $contact['company'] ?? '';
    $contactMap[trim($contact['id'])] = [
        'name' => $fullName ?: 'Unnamed Contact',
        'company' => $company
    ];
}

// Calculate statistics
$totalValue = 0;
$wonValue = 0;
$stageGroups = [];

foreach ($opportunities as $opp) {
    $value = floatval($opp['value'] ?? 0);
    $stage = $opp['stage'] ?? 'Unknown';
    
    $totalValue += $value;
    
    if ($stage === 'Closed Won') {
        $wonValue += $value;
    }
    
    if (!isset($stageGroups[$stage])) {
        $stageGroups[$stage] = ['count' => 0, 'value' => 0];
    }
    $stageGroups[$stage]['count']++;
    $stageGroups[$stage]['value'] += $value;
}

// Get filter parameters
$filterStage = $_GET['stage'] ?? '';
$searchQuery = $_GET['search'] ?? '';
$sortBy = $_GET['sort'] ?? 'id';
$sortOrder = $_GET['order'] ?? 'desc';

// Apply filters
$filteredOpportunities = $opportunities;

if ($filterStage) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($filterStage) {
        return ($opp['stage'] ?? '') === $filterStage;
    });
}

if ($searchQuery) {
    $filteredOpportunities = array_filter($filteredOpportunities, function($opp) use ($searchQuery, $contactMap) {
        $contactId = trim($opp['contact_id'] ?? '');
        $contactName = $contactMap[$contactId]['name'] ?? '';
        $contactCompany = $contactMap[$contactId]['company'] ?? '';
        
        return stripos($contactName, $searchQuery) !== false ||
               stripos($contactCompany, $searchQuery) !== false ||
               stripos($opp['id'] ?? '', $searchQuery) !== false ||
               stripos($opp['stage'] ?? '', $searchQuery) !== false;
    });
}

// Apply sorting
usort($filteredOpportunities, function($a, $b) use ($sortBy, $sortOrder, $contactMap) {
    $aVal = $a[$sortBy] ?? '';
    $bVal = $b[$sortBy] ?? '';
    
    // Special handling for contact name sorting
    if ($sortBy === 'contact_name') {
        $aVal = $contactMap[trim($a['contact_id'] ?? '')]['name'] ?? '';
        $bVal = $contactMap[trim($b['contact_id'] ?? '')]['name'] ?? '';
    }
    
    // Numeric sorting for value and probability
    if (in_array($sortBy, ['value', 'probability', 'id'])) {
        $aVal = floatval($aVal);
        $bVal = floatval($bVal);
    }
    
    $comparison = $aVal <=> $bVal;
    return $sortOrder === 'asc' ? $comparison : -$comparison;
});

// Get stage color
function getStageColor($stage) {
    $colors = [
        'Prospecting' => '#6366F1',
        'Proposal' => '#8B5CF6',
        'Negotiation' => '#F59E0B',
        'Closed Won' => '#10B981',
        'Closed Lost' => '#EF4444'
    ];
    return $colors[$stage] ?? '#6B7280';
}
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>

<style>
  .opportunities-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }
  
  .opportunities-header h1 {
    margin: 0 0 16px 0;
    font-size: 32px;
    font-weight: 700;
  }
  
  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .btn-add {
    background: white;
    color: #667eea;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-add:hover {
    background: #f3f4f6;
    transform: translateY(-2px);
  }
  
  .btn-export {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 2px solid white;
  }
  
  .btn-export:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #667eea;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .stat-label {
    font-size: 12px;
    color: #6B7280;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1F2937;
  }
  
  .stat-subtitle {
    font-size: 13px;
    color: #9CA3AF;
    margin-top: 4px;
  }
  
  .filters-bar {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .filters-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .filter-group {
    flex: 1;
    min-width: 200px;
  }
  
  .filter-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    text-transform: uppercase;
  }
  
  .filter-group input,
  .filter-group select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
  }
  
  .filter-group input:focus,
  .filter-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .btn-filter {
    padding: 10px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    align-self: flex-end;
  }
  
  .btn-filter:hover {
    background: #5558dd;
  }
  
  .btn-reset {
    padding: 10px 20px;
    background: #F3F4F6;
    color: #374151;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    align-self: flex-end;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-reset:hover {
    background: #E5E7EB;
  }
  
  .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 24px;
  }
  
  .opportunities-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  
  .opportunities-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .opportunities-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  
  .opportunities-table th:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .opportunities-table th.sortable::after {
    content: ' ‚áÖ';
    opacity: 0.3;
    font-size: 10px;
  }
  
  .opportunities-table th.sorted-asc::after {
    content: ' ‚ñ≤';
    opacity: 1;
  }
  
  .opportunities-table th.sorted-desc::after {
    content: ' ‚ñº';
    opacity: 1;
  }
  
  .opportunities-table tbody tr {
    border-bottom: 1px solid #E5E7EB;
    transition: all 0.2s;
  }
  
  .opportunities-table tbody tr:hover {
    background: #F9FAFB;
  }
  
  .opportunities-table tbody tr:last-child {
    border-bottom: none;
  }
  
  .opportunities-table td {
    padding: 16px 12px;
    vertical-align: middle;
  }
  
  .cell-id {
    font-weight: 600;
    color: #667eea;
    font-size: 13px;
  }
  
  .cell-contact {
    font-weight: 600;
    color: #1F2937;
  }
  
  .cell-company {
    color: #6B7280;
    font-size: 13px;
  }
  
  .cell-value {
    font-weight: 700;
    color: #10B981;
    font-size: 16px;
  }
  
  .cell-probability {
    font-weight: 600;
  }
  
  .cell-stage {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: white;
  }
  
  .cell-date {
    color: #374151;
    font-weight: 500;
  }
  
  .cell-weighted {
    color: #667eea;
    font-weight: 600;
  }
  
  .cell-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .btn-action {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .btn-edit {
    background: #667eea;
    color: white;
  }
  
  .btn-edit:hover {
    background: #5558dd;
    transform: translateY(-1px);
  }
  
  .btn-delete {
    background: #EF4444;
    color: white;
  }
  
  .btn-delete:hover {
    background: #DC2626;
    transform: translateY(-1px);
  }
  
  .alert {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .alert-success {
    background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
    border: 2px solid #10B981;
    color: #065F46;
  }
  
  .alert-error {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border: 2px solid #EF4444;
    color: #991B1B;
  }
  
  .alert-info {
    background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
    border: 2px solid #3B82F6;
    color: #1E40AF;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
  }
  
  .empty-state h3 {
    font-size: 20px;
    color: #1F2937;
    margin-bottom: 8px;
  }
  
  .empty-state p {
    color: #6B7280;
    margin-bottom: 24px;
  }
  
  @media (max-width: 768px) {
    .opportunities-header {
      padding: 24px 16px;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .filters-row {
      flex-direction: column;
    }
    
    .filter-group {
      width: 100%;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .opportunities-table {
      min-width: 800px;
    }
  }
</style>

<!-- View Toggle -->
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="pipeline_board.php" style="padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; text-decoration: none; color: #374151; transition: all 0.2s;">
        üìä Board View
    </a>
    <a href="opportunities_list.php" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.2s;">
        üìã List View
    </a>
    <a href="add_opportunity.php" style="padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; text-decoration: none; color: #374151; transition: all 0.2s;">
        ‚ûï Add Opportunity
    </a>
</div>

<div class="opportunities-header">
  <h1>üíº Opportunities Pipeline</h1>
  <div class="header-actions">
    <a href="export_opportunities.php?<?= http_build_query(['stage' => $filterStage, 'search' => $searchQuery]) ?>" class="btn-export">
      <span>üìä</span>
      <span>Export to CSV</span>
    </a>
    <a href="add_opportunity.php" class="btn-add">
      <span>‚ûï</span>
      <span>New Opportunity</span>
    </a>
  </div>
</div>

<!-- Success/Error Messages -->
<?php if (isset($_GET['success'])): ?>
  <div class="alert alert-success">
    <span>‚úì</span>
    <span>
      <?php
        if ($_GET['success'] == '1') echo 'Opportunity created successfully!';
        elseif ($_GET['success'] == '2') echo 'Opportunity updated successfully!';
        elseif ($_GET['success'] == '3') echo 'Opportunity deleted successfully!';
        else echo 'Action completed successfully!';
      ?>
    </span>
  </div>
<?php endif; ?>

<?php if (isset($_GET['error'])): ?>
  <div class="alert alert-error">
    <span>‚ö†Ô∏è</span>
    <span><?= htmlspecialchars($_GET['error']) ?></span>
  </div>
<?php endif; ?>

<!-- Statistics Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Total Pipeline Value</div>
    <div class="stat-value"><?= formatCurrency($totalValue) ?></div>
    <div class="stat-subtitle"><?= count($opportunities) ?> opportunities</div>
  </div>
  
  <div class="stat-card" style="border-left-color: #10B981;">
    <div class="stat-label">Closed Won</div>
    <div class="stat-value" style="color: #10B981;"><?= formatCurrency($wonValue) ?></div>
    <div class="stat-subtitle"><?= $stageGroups['Closed Won']['count'] ?? 0 ?> deals</div>
  </div>
  
  <div class="stat-card" style="border-left-color: #F59E0B;">
    <div class="stat-label">In Negotiation</div>
    <div class="stat-value" style="color: #F59E0B;"><?= formatCurrency($stageGroups['Negotiation']['value'] ?? 0) ?></div>
    <div class="stat-subtitle"><?= $stageGroups['Negotiation']['count'] ?? 0 ?> deals</div>
  </div>
  
  <div class="stat-card" style="border-left-color: #6366F1;">
    <div class="stat-label">Active Opportunities</div>
    <div class="stat-value" style="color: #6366F1;">
      <?= count(array_filter($opportunities, fn($o) => !in_array($o['stage'] ?? '', ['Closed Won', 'Closed Lost']))) ?>
    </div>
    <div class="stat-subtitle">Open deals</div>
  </div>
</div>

<!-- Filters -->
<div class="filters-bar">
  <form method="GET" action="">
    <div class="filters-row">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" name="search" placeholder="Search by contact, company, or ID..." value="<?= htmlspecialchars($searchQuery) ?>">
      </div>
      
      <div class="filter-group">
        <label>Stage</label>
        <select name="stage">
          <option value="">All Stages</option>
          <option value="Prospecting" <?= $filterStage === 'Prospecting' ? 'selected' : '' ?>>Prospecting</option>
          <option value="Proposal" <?= $filterStage === 'Proposal' ? 'selected' : '' ?>>Proposal</option>
          <option value="Negotiation" <?= $filterStage === 'Negotiation' ? 'selected' : '' ?>>Negotiation</option>
          <option value="Closed Won" <?= $filterStage === 'Closed Won' ? 'selected' : '' ?>>Closed Won</option>
          <option value="Closed Lost" <?= $filterStage === 'Closed Lost' ? 'selected' : '' ?>>Closed Lost</option>
        </select>
      </div>
      
      <button type="submit" class="btn-filter">üîç Filter</button>
      <?php if ($filterStage || $searchQuery): ?>
        <a href="opportunities_list.php" class="btn-reset">‚úï Reset</a>
      <?php endif; ?>
    </div>
  </form>
</div>

<!-- Opportunities Table -->
<?php if (empty($filteredOpportunities)): ?>
  <div class="empty-state">
    <div class="empty-state-icon">üíº</div>
    <h3>No opportunities found</h3>
    <p>
      <?php if ($filterStage || $searchQuery): ?>
        No opportunities match your filters. Try adjusting your search criteria.
      <?php else: ?>
        Get started by creating your first opportunity!
      <?php endif; ?>
    </p>
    <?php if (!$filterStage && !$searchQuery): ?>
      <a href="add_opportunity.php" class="btn-add">‚ûï Create Opportunity</a>
    <?php endif; ?>
  </div>
<?php else: ?>
  <div class="table-container">
    <table class="opportunities-table">
      <thead>
        <tr>
          <th class="sortable <?= $sortBy === 'id' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('id')">ID</th>
          <th class="sortable <?= $sortBy === 'contact_name' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('contact_name')">Contact</th>
          <th>Company</th>
          <th class="sortable <?= $sortBy === 'value' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('value')">Value</th>
          <th class="sortable <?= $sortBy === 'probability' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('probability')">Probability</th>
          <th>Weighted Value</th>
          <th class="sortable <?= $sortBy === 'stage' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('stage')">Stage</th>
          <th class="sortable <?= $sortBy === 'expected_close' ? 'sorted-' . $sortOrder : '' ?>" onclick="sortTable('expected_close')">Expected Close</th>
          <th style="text-align: right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($filteredOpportunities as $opp): ?>
          <?php
            $contactId = trim($opp['contact_id'] ?? '');
            $contactInfo = $contactMap[$contactId] ?? ['name' => 'Unknown Contact', 'company' => ''];
            $stage = $opp['stage'] ?? 'Unknown';
            $stageColor = getStageColor($stage);
            $value = $opp['value'] ?? 0;
            $probability = $opp['probability'] ?? 0;
            $weightedValue = $value * ($probability / 100);
          ?>
          <tr>
            <td class="cell-id">#<?= htmlspecialchars($opp['id']) ?></td>
            <td class="cell-contact"><?= htmlspecialchars($contactInfo['name']) ?></td>
            <td class="cell-company"><?= htmlspecialchars($contactInfo['company'] ?: '‚Äî') ?></td>
            <td class="cell-value"><?= formatCurrency($value) ?></td>
            <td class="cell-probability"><?= htmlspecialchars($probability) ?>%</td>
            <td class="cell-weighted"><?= formatCurrency($weightedValue) ?></td>
            <td>
              <span class="cell-stage" style="background-color: <?= $stageColor ?>;">
                <?= htmlspecialchars($stage) ?>
              </span>
            </td>
            <td class="cell-date"><?= htmlspecialchars($opp['expected_close'] ?? '‚Äî') ?></td>
            <td class="cell-actions">
              <a href="edit_opportunity.php?id=<?= urlencode($opp['id']) ?>" class="btn-action btn-edit" title="Edit">‚úèÔ∏è Edit</a>
              <form method="POST" action="delete_opportunity.php" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this opportunity?');">
                <input type="hidden" name="id" value="<?= htmlspecialchars($opp['id']) ?>">
                <button type="submit" class="btn-action btn-delete" title="Delete">üóëÔ∏è Delete</button>
              </form>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
<?php endif; ?>

<script>
  function sortTable(column) {
    const currentSort = '<?= $sortBy ?>';
    const currentOrder = '<?= $sortOrder ?>';
    
    let newOrder = 'asc';
    if (currentSort === column && currentOrder === 'asc') {
      newOrder = 'desc';
    }
    
    // Build URL with current filters and new sort
    const url = new URL(window.location.href);
    url.searchParams.set('sort', column);
    url.searchParams.set('order', newOrder);
    
    window.location.href = url.toString();
  }
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunities_list.php ---



--- Start of opportunity_form.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); ?>

<div class="container">
  <h2>Add New Opportunity</h2>

  <?php if (!empty($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Opportunity saved successfully.</p>
  <?php elseif (!empty($_GET['status']) && $_GET['status'] === 'error'): ?>
    <p class="error-msg">Invalid opportunity data or contact ID.</p>
  <?php endif; ?>

  <form id="opportunity-form" action="add_opportunity.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>

      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>

        <?php if ($field === 'contact_id'): ?>
          <select name="contact_id" id="contact_id" class="form-control" required>
            <option value="">Select Contact</option>
            <?php foreach ($contacts as $contact): ?>
              <option value="<?= $contact['id'] ?>">
                <?= trim($contact['first_name'] . ' ' . $contact['last_name']) ?: 'Unnamed Contact' ?>
              </option>
            <?php endforeach; ?>
          </select>

        <?php elseif ($field === 'stage'): ?>
          <select name="stage" id="stage" class="form-control" required>
            <option value="">Select Stage</option>
            <option value="Prospecting">Prospecting</option>
            <option value="Proposal">Proposal</option>
            <option value="Negotiation">Negotiation</option>
            <option value="Closed Won">Closed Won</option>
            <option value="Closed Lost">Closed Lost</option>
          </select>

        <?php elseif ($field === 'expected_close'): ?>
          <input type="date" name="expected_close" id="expected_close" class="form-control" required>

        <?php elseif ($field === 'value' || $field === 'probability'): ?>
          <input type="number" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>

        <?php else: ?>
          <input type="text" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
        <?php endif; ?>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Opportunity</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunity_form.php ---



--- Start of opportunity_schema.php ---


<?php
return [
  'id',
  'contact_id',
  'value',
  'stage',
  'probability',
  'expected_close'
];


--- End of opportunity_schema.php ---



--- Start of opportunity_schema_enhanced.php ---

<?php
/**
 * Enhanced Opportunity Schema - Hybrid Business Model
 * Handles both equipment sales and service contract opportunities
 */
return [
    'id',                   // Unique opportunity ID
    'contact_id',           // Link to contact
    'customer_id',          // Link to customer (optional)
    'opportunity_type',     // Equipment Sale / Service Contract / Renewal / Upsell / Replacement
    'revenue_model',        // One-time / Monthly Recurring / Annual Recurring
    'name',                 // Opportunity name/description
    'value',                // Total opportunity value
    'monthly_value',        // Monthly recurring value (if applicable)
    'annual_value',         // Annual recurring value (if applicable)
    'contract_term',        // Contract term in months (for SDI)
    'stage',                // Prospecting / Qualification / Proposal / Negotiation / Closed Won / Closed Lost
    'probability',          // Win probability (0-100)
    'expected_close',       // Expected close date
    'actual_close',         // Actual close date
    'equipment_type',       // What equipment/service involved
    'product_details',      // Detailed product/service description
    'competitor',           // Competing against (if replacement)
    'payment_terms',        // Net 30 / Net 60 / Monthly / Quarterly
    'source',               // Lead source (Referral / Website / Cold Call / etc)
    'lost_reason',          // Why opportunity was lost (if applicable)
    'contract_id',          // Linked contract ID (after won)
    'equipment_ids',        // Linked equipment IDs (after won)
    'notes',                // Opportunity notes
    'created_date',         // Opportunity creation date
    'created_by',           // User who created
    'modified_date',        // Last modification date
    'modified_by'           // User who last modified
];


--- End of opportunity_schema_enhanced.php ---



--- Start of php_info.php ---

<?php
phpinfo();
?>


--- End of php_info.php ---



--- Start of pipeline_board.php ---

<?php
$pageTitle = 'Sales Pipeline Board';
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

// Load opportunities and contacts
$opportunitySchema = require 'opportunity_schema.php';
$contactSchema = require 'contact_schema.php';
$opportunities = readCSV('opportunities.csv', $opportunitySchema) ?: [];
$contacts = readCSV('contacts.csv', $contactSchema) ?: [];

// Index contacts by ID
$contactsById = [];
foreach ($contacts as $c) {
    $contactsById[$c['id'] ?? ''] = $c;
}

// Define pipeline stages (matches opportunities system)
$stages = [
    'Prospecting' => ['color' => '#6366F1', 'icon' => 'üîç'],
    'Qualification' => ['color' => '#8B5CF6', 'icon' => '‚úì'],
    'Proposal' => ['color' => '#EC4899', 'icon' => 'üìÑ'],
    'Negotiation' => ['color' => '#F59E0B', 'icon' => 'üí¨'],
    'Closed Won' => ['color' => '#10B981', 'icon' => 'üéâ'],
    'Closed Lost' => ['color' => '#EF4444', 'icon' => '‚ùå']
];

// Group opportunities by stage
$opportunitiesByStage = [];
foreach ($stages as $stageName => $stageInfo) {
    $opportunitiesByStage[$stageName] = [];
}

foreach ($opportunities as $opp) {
    $stage = $opp['stage'] ?? 'Prospecting';
    if (isset($opportunitiesByStage[$stage])) {
        $opportunitiesByStage[$stage][] = $opp;
    }
}

// Calculate statistics for each stage
$stageStats = [];
foreach ($stages as $stageName => $stageInfo) {
    $stageOpps = $opportunitiesByStage[$stageName];
    $count = count($stageOpps);
    $totalValue = array_reduce($stageOpps, function($sum, $opp) {
        return $sum + ((float)($opp['value'] ?? 0));
    }, 0);
    $weightedValue = array_reduce($stageOpps, function($sum, $opp) {
        $value = (float)($opp['value'] ?? 0);
        $prob = (float)($opp['probability'] ?? 0) / 100;
        return $sum + ($value * $prob);
    }, 0);
    
    $stageStats[$stageName] = [
        'count' => $count,
        'total_value' => $totalValue,
        'weighted_value' => $weightedValue
    ];
}

// Handle AJAX stage update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_stage'])) {
    $oppId = $_POST['opportunity_id'] ?? '';
    $newStage = $_POST['new_stage'] ?? '';
    
    // Find and update the opportunity
    foreach ($opportunities as &$opp) {
        if ($opp['id'] === $oppId) {
            $opp['stage'] = $newStage;
            
            // Auto-adjust probability based on stage
            $probabilities = [
                'Prospecting' => 10,
                'Qualification' => 25,
                'Proposal' => 50,
                'Negotiation' => 75,
                'Closed Won' => 100,
                'Closed Lost' => 0
            ];
            $opp['probability'] = $probabilities[$newStage] ?? $opp['probability'];
            break;
        }
    }
    
    writeCSV('opportunities.csv', $opportunities, $opportunitySchema);
    
    header('Content-Type: application/json');
    echo json_encode(['success' => true]);
    exit;
}

if (!function_exists('formatCurrency')) {
    function formatCurrency($amount) {
        return '$' . number_format($amount, 0);
    }
}
?>

<style>
/* Pipeline Board Styles */
.pipeline-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
}

.pipeline-header h1 {
    margin: 0 0 15px 0;
    font-size: 32px;
    font-weight: 700;
}

.pipeline-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255,255,255,0.15);
    padding: 15px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.stat-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    margin-top: 5px;
}

/* Pipeline Board */
.pipeline-board {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 10px 0 30px 0;
    min-height: 600px;
}

.pipeline-column {
    flex: 0 0 300px;
    background: #f9fafb;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    max-height: 80vh;
}

.column-header {
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.column-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 15px;
}

.column-count {
    background: rgba(255,255,255,0.3);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.column-stats {
    font-size: 11px;
    margin-top: 8px;
    opacity: 0.95;
    font-weight: 600;
}

.cards-container {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-right: 5px;
}

.deal-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    cursor: move;
    transition: all 0.2s;
    border-left: 4px solid;
}

.deal-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.deal-card.dragging {
    opacity: 0.5;
}

.deal-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 10px;
}

.deal-id {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 600;
}

.deal-value {
    font-size: 18px;
    font-weight: 700;
    color: #10B981;
}

.deal-contact {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
    margin-bottom: 4px;
}

.deal-company {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
}

.deal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #e5e7eb;
}

.deal-probability {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
}

.probability-bar {
    width: 60px;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
}

.probability-fill {
    height: 100%;
    background: linear-gradient(90deg, #3B82F6, #10B981);
    border-radius: 2px;
}

.deal-date {
    font-size: 11px;
    color: #9ca3af;
}

.deal-actions {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}

.deal-action-btn {
    flex: 1;
    padding: 6px;
    background: #f3f4f6;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.deal-action-btn:hover {
    background: #e5e7eb;
}

.drop-zone {
    min-height: 100px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 13px;
    padding: 20px;
    text-align: center;
}

.drop-zone.drag-over {
    border-color: #3B82F6;
    background: #eff6ff;
    color: #3B82F6;
}

/* Scrollbar styling */
.cards-container::-webkit-scrollbar {
    width: 6px;
}

.cards-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.cards-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

.cards-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.view-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.view-btn {
    padding: 10px 20px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    color: #374151;
}

.view-btn:hover {
    border-color: #667eea;
    color: #667eea;
}

.view-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
}

@media (max-width: 768px) {
    .pipeline-board {
        flex-direction: column;
    }
    
    .pipeline-column {
        flex: 1 1 auto;
        max-height: none;
    }
}
</style>

<div class="pipeline-header">
    <h1>üìä Sales Pipeline Board</h1>
    <p style="margin: 0; opacity: 0.9;">Drag and drop opportunities between stages to update</p>
    
    <div class="pipeline-stats">
        <div class="stat-card">
            <div class="stat-label">Total Pipeline</div>
            <div class="stat-value">
                <?php 
                $totalPipeline = array_reduce($opportunities, function($sum, $opp) {
                    return $sum + ((float)($opp['value'] ?? 0));
                }, 0);
                echo formatCurrency($totalPipeline);
                ?>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Weighted Value</div>
            <div class="stat-value">
                <?php 
                $weightedTotal = array_reduce($opportunities, function($sum, $opp) {
                    $value = (float)($opp['value'] ?? 0);
                    $prob = (float)($opp['probability'] ?? 0) / 100;
                    return $sum + ($value * $prob);
                }, 0);
                echo formatCurrency($weightedTotal);
                ?>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Deals</div>
            <div class="stat-value"><?= count($opportunities) ?></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Close Rate</div>
            <div class="stat-value">
                <?php
                $closedWonCount = count($opportunitiesByStage['Closed Won'] ?? []);
                $closedLostCount = count($opportunitiesByStage['Closed Lost'] ?? []);
                $totalClosed = $closedWonCount + $closedLostCount;
                $closeRate = $totalClosed > 0 ? round(($closedWonCount / $totalClosed) * 100) : 0;
                echo $closeRate . '%';
                ?>
            </div>
        </div>
    </div>
</div>

<div class="view-toggle">
    <a href="pipeline_board.php" class="view-btn active">üìä Board View</a>
    <a href="opportunities_list.php" class="view-btn">üìã List View</a>
    <a href="add_opportunity.php" class="view-btn">‚ûï Add Opportunity</a>
</div>

<div class="pipeline-board">
    <?php foreach ($stages as $stageName => $stageInfo): ?>
        <div class="pipeline-column" data-stage="<?= htmlspecialchars($stageName) ?>">
            <div class="column-header" style="background: <?= $stageInfo['color'] ?>;">
                <div>
                    <div class="column-title">
                        <span><?= $stageInfo['icon'] ?></span>
                        <span><?= htmlspecialchars($stageName) ?></span>
                        <span class="column-count"><?= $stageStats[$stageName]['count'] ?></span>
                    </div>
                    <div class="column-stats">
                        <?= formatCurrency($stageStats[$stageName]['total_value']) ?>
                        (<?= formatCurrency($stageStats[$stageName]['weighted_value']) ?> weighted)
                    </div>
                </div>
            </div>
            
            <div class="cards-container">
                <?php if (empty($opportunitiesByStage[$stageName])): ?>
                    <div class="drop-zone">
                        Drop opportunities here
                    </div>
                <?php else: ?>
                    <?php foreach ($opportunitiesByStage[$stageName] as $opp): ?>
                        <?php
                        $contact = $contactsById[$opp['contact_id'] ?? ''] ?? null;
                        $contactName = $contact ? trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? '')) : 'Unknown';
                        $company = $contact['company'] ?? 'No Company';
                        ?>
                        <div class="deal-card" 
                             draggable="true" 
                             data-id="<?= htmlspecialchars($opp['id']) ?>"
                             style="border-left-color: <?= $stageInfo['color'] ?>;">
                            <div class="deal-header">
                                <span class="deal-id">#<?= htmlspecialchars($opp['id']) ?></span>
                                <span class="deal-value"><?= formatCurrency($opp['value'] ?? 0) ?></span>
                            </div>
                            
                            <div class="deal-contact"><?= htmlspecialchars($contactName) ?></div>
                            <div class="deal-company"><?= htmlspecialchars($company) ?></div>
                            
                            <div class="deal-footer">
                                <div class="deal-probability">
                                    <div class="probability-bar">
                                        <div class="probability-fill" style="width: <?= $opp['probability'] ?? 0 ?>%;"></div>
                                    </div>
                                    <span><?= $opp['probability'] ?? 0 ?>%</span>
                                </div>
                                <div class="deal-date">
                                    <?= $opp['expected_close'] ? date('M d', strtotime($opp['expected_close'])) : '‚Äî' ?>
                                </div>
                            </div>
                            
                            <div class="deal-actions">
                                <a href="edit_opportunity.php?id=<?= htmlspecialchars($opp['id']) ?>" class="deal-action-btn">‚úèÔ∏è Edit</a>
                                <a href="contact_view.php?id=<?= htmlspecialchars($opp['contact_id']) ?>" class="deal-action-btn">üë§ Contact</a>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </div>
    <?php endforeach; ?>
</div>

<script>
// Drag and Drop functionality
let draggedElement = null;

document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.deal-card');
    const columns = document.querySelectorAll('.pipeline-column');
    
    // Make cards draggable
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Make columns accept drops
    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
    });
});

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const cardsContainer = this.querySelector('.cards-container');
    cardsContainer.classList.add('drag-over');
    
    return false;
}

function handleDragLeave(e) {
    const cardsContainer = this.querySelector('.cards-container');
    if (e.target === cardsContainer) {
        cardsContainer.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const cardsContainer = this.querySelector('.cards-container');
    cardsContainer.classList.remove('drag-over');
    
    if (draggedElement) {
        const newStage = this.dataset.stage;
        const oppId = draggedElement.dataset.id;
        const oldStage = draggedElement.closest('.pipeline-column').dataset.stage;
        
        if (newStage !== oldStage) {
            // Update via AJAX
            const formData = new FormData();
            formData.append('update_stage', '1');
            formData.append('opportunity_id', oppId);
            formData.append('new_stage', newStage);
            
            fetch('pipeline_board.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show updated stats
                    window.location.reload();
                } else {
                    alert('Failed to update opportunity stage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update opportunity stage');
            });
        }
    }
    
    return false;
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of pipeline_board.php ---



--- Start of purchase_orders_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$orders = readCSV($poFile, $schema);

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_po'])) {
  $poToDelete = trim($_POST['po_number'] ?? '');
  if ($poToDelete !== '') {
    $orders = array_values(array_filter($orders, function($row) use ($poToDelete) {
      return ($row['po_number'] ?? '') !== $poToDelete;
    }));
    writeCSV($poFile, $orders, $schema);
  }
  header('Location: purchase_orders_list.php');
  exit;
}

function to_float($value) {
  return is_numeric($value) ? (float)$value : 0.0;
}

// Build filter array from GET
$filters = [];
foreach ($schema as $f) {
  $filters[$f] = isset($_GET[$f]) ? trim($_GET[$f]) : '';
}

// Filter orders by all non-empty fields
$filtered = $orders;
foreach ($filters as $field => $val) {
  if ($val !== '') {
    $filtered = array_filter($filtered, function($order) use ($field, $val) {
      return stripos($order[$field] ?? '', $val) !== false;
    });
  }
}

$poGroups = [];
foreach ($filtered as $row) {
  $poNumber = trim($row['po_number'] ?? '');
  if ($poNumber === '') {
    continue;
  }
  if (!isset($poGroups[$poNumber])) {
    $poGroups[$poNumber] = [
      'header' => $row,
      'items' => [],
      'total_qty' => 0.0,
      'item_count' => 0
    ];
  }
  $poGroups[$poNumber]['items'][] = $row;
  $poGroups[$poNumber]['total_qty'] += to_float($row['quantity'] ?? '');
  $poGroups[$poNumber]['item_count'] += 1;
}

$poGroups = array_values($poGroups);
?>
<div class="container">
  <h2>Purchase Orders</h2>
  <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
    <a href="purchase_order_add.php" class="btn-outline">‚ûï Add Purchase Order</a>
  </div>
  <style>
    .po-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    .po-list {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      max-height: 70vh;
      overflow: auto;
    }
    .po-list-item {
      width: 100%;
      text-align: left;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      background: #f9fafb;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .po-list-item.active {
      background: #e9eef6;
      border-color: #8aa4c8;
    }
    .po-list-title { font-weight: 600; margin-bottom: 4px; }
    .po-list-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.9em;
      color: #555;
    }
    .po-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f3f6;
      border: 1px solid #d9dee7;
    }
    .po-detail {
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      padding: 14px;
      background: #fff;
      min-height: 200px;
    }
    .po-detail-panel { display: none; }
    .po-detail-panel.active { display: block; }
    .po-detail-title { font-weight: 700; margin-bottom: 10px; }
    .po-section { margin-bottom: 14px; }
    .po-section-title { font-weight: 700; margin-bottom: 8px; }
    .po-section-grid {
      display: grid;
      grid-template-columns: 160px 1fr 160px 1fr;
      gap: 8px 16px;
      align-items: center;
    }
    .po-label { font-weight: 600; color: #222; }
    .po-value { color: #333; }
    .po-actions { display: flex; gap: 8px; margin-bottom: 12px; }
    .po-actions button[disabled] { opacity: 0.6; cursor: not-allowed; }
    @media (max-width: 900px) {
      .po-layout { grid-template-columns: 1fr; }
      .po-list { max-height: none; }
      .po-section-grid { grid-template-columns: 160px 1fr; }
    }
  </style>
  <?php if (empty($poGroups)): ?>
    <div style="text-align:center; color:#888;">No purchase orders found.</div>
  <?php else: ?>
    <div class="po-layout">
      <div class="po-list" id="poList">
        <?php foreach ($poGroups as $index => $group): ?>
          <?php
            $header = $group['header'];
            $poNumber = $header['po_number'] ?? '';
            $supplier = $header['supplier_name'] ?? '';
            $date = $header['date'] ?? '';
          ?>
          <button
            type="button"
            class="po-list-item"
            data-target="po-detail-<?= $index ?>"
          >
            <div class="po-list-title"><?= htmlspecialchars($supplier !== '' ? $supplier : $poNumber) ?></div>
            <div class="po-list-meta">
              <?php if ($poNumber !== ''): ?><span class="po-pill">PO: <?= htmlspecialchars($poNumber) ?></span><?php endif; ?>
              <?php if ($date !== ''): ?><span class="po-pill">Date: <?= htmlspecialchars($date) ?></span><?php endif; ?>
              <span class="po-pill">Items: <?= htmlspecialchars((string)$group['item_count']) ?></span>
              <span class="po-pill">Qty: <?= htmlspecialchars((string)$group['total_qty']) ?></span>
            </div>
          </button>
        <?php endforeach; ?>
      </div>
      <div class="po-detail" id="poDetail">
        <?php foreach ($poGroups as $index => $group): ?>
          <?php
            $header = $group['header'];
            $poNumber = $header['po_number'] ?? '';
            $supplier = $header['supplier_name'] ?? '';
            $poLink = urlencode($poNumber);
          ?>
          <div class="po-detail-panel" id="po-detail-<?= $index ?>">
            <div class="po-detail-title"><?= htmlspecialchars($poNumber) ?><?= $supplier !== '' ? ' - ' . htmlspecialchars($supplier) : '' ?></div>
            <div class="po-actions">
              <a href="purchase_order_summary.php?po=<?= $poLink ?>" class="btn-outline">View Supplier Form</a>
              <a href="purchase_order_receive.php?po=<?= $poLink ?>" class="btn-outline">Receive</a>
              <a href="purchase_order_edit.php?po=<?= $poLink ?>" class="btn-outline">Edit</a>
              <form method="post" onsubmit="return confirm('Delete purchase order <?= htmlspecialchars($poNumber) ?>?');">
                <input type="hidden" name="delete_po" value="1">
                <input type="hidden" name="po_number" value="<?= htmlspecialchars($poNumber) ?>">
                <button type="submit" class="btn-outline">Delete</button>
              </form>
            </div>
            <div class="po-section">
              <div class="po-section-title">Summary</div>
              <div class="po-section-grid">
                <div class="po-label">PO Number</div>
                <div class="po-value"><?= htmlspecialchars($poNumber) ?></div>
                <div class="po-label">Date</div>
                <div class="po-value"><?= htmlspecialchars($header['date'] ?? '') ?></div>
                <div class="po-label">Status</div>
                <div class="po-value"><?= htmlspecialchars($header['status'] ?? '') ?></div>
                <div class="po-label">Supplier</div>
                <div class="po-value"><?= htmlspecialchars($supplier) ?></div>
                <div class="po-label">Expected Delivery</div>
                <div class="po-value"><?= htmlspecialchars($header['expected_delivery'] ?? '') ?></div>
                <div class="po-label">Payment Terms</div>
                <div class="po-value"><?= htmlspecialchars($header['payment_terms'] ?? '') ?></div>
              </div>
            </div>
            <div class="po-section">
              <div class="po-section-title">Addresses</div>
              <div class="po-section-grid">
                <div class="po-label">Supplier Address</div>
                <div class="po-value"><?= htmlspecialchars($header['supplier_address'] ?? '') ?></div>
                <div class="po-label">Billing Address</div>
                <div class="po-value"><?= htmlspecialchars($header['billing_address'] ?? '') ?></div>
                <div class="po-label">Shipping Address</div>
                <div class="po-value"><?= htmlspecialchars($header['shipping_address'] ?? '') ?></div>
                <div class="po-label">Notes</div>
                <div class="po-value"><?= htmlspecialchars($header['notes'] ?? '') ?></div>
              </div>
            </div>
            <div class="po-section">
              <div class="po-section-title">Items</div>
              <div style="overflow-x:auto;">
                <table border="1" cellpadding="6" style="width:100%; font-size:0.95em; border-collapse:collapse;">
                  <thead style="background:#f5f5f5;">
                    <tr>
                      <th style="padding:8px 6px;">Item ID</th>
                      <th style="padding:8px 6px;">Item Name</th>
                      <th style="padding:8px 6px;">Qty</th>
                      <th style="padding:8px 6px;">Unit</th>
                      <th style="padding:8px 6px;">Unit Price</th>
                      <th style="padding:8px 6px;">Discount</th>
                      <th style="padding:8px 6px;">Tax</th>
                      <th style="padding:8px 6px;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php foreach ($group['items'] as $item): ?>
                      <tr>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['item_id'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['item_name'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['quantity'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['unit'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['unit_price'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['discount'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['tax_amount'] ?? '') ?> </td>
                        <td style="padding:6px 4px;"> <?= htmlspecialchars($item['total'] ?? '') ?> </td>
                      </tr>
                    <?php endforeach; ?>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
    <script>
      const poListItems = Array.from(document.querySelectorAll('.po-list-item'));
      const poDetailPanels = Array.from(document.querySelectorAll('.po-detail-panel'));

      function activatePO(item) {
        poListItems.forEach(btn => btn.classList.remove('active'));
        poDetailPanels.forEach(panel => panel.classList.remove('active'));
        if (!item) {
          return;
        }
        item.classList.add('active');
        const targetId = item.getAttribute('data-target');
        const panel = document.getElementById(targetId);
        if (panel) {
          panel.classList.add('active');
        }
      }

      poListItems.forEach(btn => {
        btn.addEventListener('click', () => activatePO(btn));
      });

      activatePO(poListItems[0]);
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_orders_list.php ---



--- Start of purchase_order_add.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';


$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$errors = [];
$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$inventory = readCSV($inventoryFile, $inventorySchema);

function generate_po_number() {
  $prefix = 'EWTPO' . date('Ymd');
  $poFile = __DIR__ . '/purchase_orders.csv';
  $count = 1;
  if (file_exists($poFile)) {
    $lines = file($poFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $today = date('Ymd');
    $matches = array_filter($lines, function($line) use ($today) {
      return strpos($line, 'EWTPO' . $today) === 0;
    });
    $count = count($matches) + 1;
  }
  return $prefix . str_pad($count, 3, '0', STR_PAD_LEFT);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $orders = readCSV($poFile, $schema);
  $po_number = generate_po_number();
  $date = date('Y-m-d');
  $created_at = date('Y-m-d H:i:s');
  $updated_at = $created_at;
  $item_count = isset($_POST['item_id']) ? count($_POST['item_id']) : 0;
  for ($i = 0; $i < $item_count; $i++) {
    $newPO = [];
    foreach ($schema as $f) {
      if (in_array($f, ['item_id','item_name','quantity','unit','unit_price','discount','tax_rate','tax_amount','total'])) {
        $newPO[$f] = trim($_POST[$f][$i] ?? '');
      } else {
        $newPO[$f] = trim($_POST[$f] ?? '');
      }
    }
    $newPO['po_number'] = $po_number;
    $newPO['date'] = $date;
    $newPO['created_at'] = $created_at;
    $newPO['updated_at'] = $updated_at;
    $orders[] = $newPO;
  }
  writeCSV($poFile, $orders, $schema);
  header('Location: purchase_orders_list.php');
  exit;
}
?>
<div class="container">
  <h2>Add Purchase Order</h2>
  <form method="post" style="max-width:900px; margin:auto; background:#fafbfc; border-radius:8px; padding:24px 28px 18px 28px; box-shadow:0 2px 8px #0001;">
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px 24px; margin-bottom:18px; align-items:end;">
      <?php foreach ($schema as $f):
        if (in_array($f, ['created_at','updated_at','po_number','date','item_id','item_name','quantity','unit','unit_price','discount','tax_rate','tax_amount','total'])) continue;
        $readonly = '';
        $value = htmlspecialchars($_POST[$f] ?? '');
      ?>
        <div style="display:flex; flex-direction:column; min-width:160px;">
          <label for="<?= $f ?>" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;"> <?= htmlspecialchars(ucwords(str_replace('_',' ',$f))) ?> </label>
          <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= $value ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;" <?= $readonly ?> >
        </div>
      <?php endforeach; ?>
      <div style="display:flex; flex-direction:column; min-width:120px;">
        <label for="po_number" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">PO Number</label>
        <input type="text" name="po_number" id="po_number" value="<?= generate_po_number() ?>" readonly style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:0.97em;">
      </div>
      <div style="display:flex; flex-direction:column; min-width:120px;">
        <label for="date" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">Date</label>
        <input type="text" name="date" id="date" value="<?= date('Y-m-d') ?>" readonly style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:0.97em;">
      </div>
    </div>
    <h3 style="margin:18px 0 8px 0; font-size:1.13em; color:#222;">Order Items</h3>
    <table id="po-items-table" style="width:100%; border-collapse:collapse; margin-bottom:12px; background:#fff;">
      <thead>
        <tr style="background:#f5f5f5; font-size:0.97em;">
          <th style="padding:6px 4px;">Item</th>
          <th style="padding:6px 4px;">Item Name</th>
          <th style="padding:6px 4px;">Qty</th>
          <th style="padding:6px 4px;">Unit</th>
          <th style="padding:6px 4px;">Unit Price</th>
          <th style="padding:6px 4px;">Discount</th>
          <th style="padding:6px 4px;">Tax %</th>
          <th style="padding:6px 4px;">Tax Amt</th>
          <th style="padding:6px 4px;">Total</th>
          <th style="padding:6px 4px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select name="item_id[]" style="width:120px; padding:3px 5px; font-size:0.97em;">
              <option value="">-- Select --</option>
              <?php foreach ($inventory as $item): ?>
                <option value="<?= htmlspecialchars($item['item_id']) ?>">
                  <?= htmlspecialchars($item['item_id']) ?>
                </option>
              <?php endforeach; ?>
            </select>
          </td>
          <td><input type="text" name="item_name[]" style="width:110px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="quantity[]" min="1" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="text" name="unit[]" style="width:50px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="unit_price[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="discount[]" step="0.01" style="width:60px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="tax_rate[]" step="0.01" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="tax_amount[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
          <td><input type="number" name="total[]" step="0.01" style="width:85px; padding:3px 5px; font-size:0.97em;"></td>
          <td><button type="button" onclick="removeRow(this)" style="padding:2px 7px; font-size:1.1em;">üóë</button></td>
        </tr>
      </tbody>
    </table>
    <button type="button" onclick="addRow()" style="margin-bottom:18px;">‚ûï Add Item</button>
    <div style="margin-top:18px; text-align:center;">
      <button type="submit" class="btn-primary" style="padding:7px 22px; font-size:1.08em;">üíæ Save Purchase Order</button>
      <a href="purchase_orders_list.php" class="btn-outline" style="margin-left:18px;">Cancel</a>
    </div>
  </form>
  <script>
    function addRow() {
      const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
      const row = table.rows[0].cloneNode(true);
      // Clear all input values in the new row
      Array.from(row.querySelectorAll('input,select')).forEach(el => el.value = '');
      table.appendChild(row);
    }
    function removeRow(btn) {
      const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
      if (table.rows.length > 1) {
        btn.closest('tr').remove();
      }
    }
  </script>
  </form>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_add.php ---



--- Start of purchase_order_edit.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$inventory = readCSV($inventoryFile, $inventorySchema);
$orders = readCSV($poFile, $schema);

$itemFields = ['item_id','item_name','quantity','unit','unit_price','discount','tax_rate','tax_amount','total'];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_po'])) {
  $poNumber = trim($_POST['po_number'] ?? '');
  if ($poNumber !== '') {
    $orders = array_values(array_filter($orders, function($row) use ($poNumber) {
      return ($row['po_number'] ?? '') !== $poNumber;
    }));

    $createdAt = trim($_POST['created_at'] ?? '');
    if ($createdAt === '') {
      $createdAt = date('Y-m-d H:i:s');
    }
    $updatedAt = date('Y-m-d H:i:s');
    $itemCount = isset($_POST['item_id']) ? count($_POST['item_id']) : 0;

    for ($i = 0; $i < $itemCount; $i++) {
      $newPO = [];
      foreach ($schema as $f) {
        if (in_array($f, $itemFields, true)) {
          $newPO[$f] = trim($_POST[$f][$i] ?? '');
        } else {
          $newPO[$f] = trim($_POST[$f] ?? '');
        }
      }
      $newPO['po_number'] = $poNumber;
      $newPO['created_at'] = $createdAt;
      $newPO['updated_at'] = $updatedAt;
      $orders[] = $newPO;
    }

    writeCSV($poFile, $orders, $schema);
  }
  header('Location: purchase_orders_list.php');
  exit;
}

$poNumber = trim($_GET['po'] ?? '');
$poRows = array_values(array_filter($orders, function($row) use ($poNumber) {
  return ($row['po_number'] ?? '') === $poNumber;
}));
$header = $poRows[0] ?? [];
?>
<div class="container">
  <h2>Edit Purchase Order</h2>
  <?php if ($poNumber === '' || empty($poRows)): ?>
    <div style="text-align:center; color:#888; margin:18px 0;">Purchase order not found.</div>
    <div style="text-align:center;">
      <a href="purchase_orders_list.php" class="btn-outline">Back to Purchase Orders</a>
    </div>
  <?php else: ?>
    <form method="post" style="max-width:900px; margin:auto; background:#fafbfc; border-radius:8px; padding:24px 28px 18px 28px; box-shadow:0 2px 8px #0001;">
      <input type="hidden" name="update_po" value="1">
      <input type="hidden" name="created_at" value="<?= htmlspecialchars($header['created_at'] ?? '') ?>">
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px 24px; margin-bottom:18px; align-items:end;">
        <?php foreach ($schema as $f):
          if (in_array($f, array_merge($itemFields, ['created_at','updated_at','po_number','date']), true)) continue;
          $value = htmlspecialchars($header[$f] ?? '');
        ?>
          <div style="display:flex; flex-direction:column; min-width:160px;">
            <label for="<?= $f ?>" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;"> <?= htmlspecialchars(ucwords(str_replace('_',' ',$f))) ?> </label>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= $value ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">
          </div>
        <?php endforeach; ?>
        <div style="display:flex; flex-direction:column; min-width:120px;">
          <label for="po_number" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">PO Number</label>
          <input type="text" name="po_number" id="po_number" value="<?= htmlspecialchars($poNumber) ?>" readonly style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:0.97em;">
        </div>
        <div style="display:flex; flex-direction:column; min-width:120px;">
          <label for="date" style="font-weight:600; margin-bottom:2px; font-size:0.97em; color:#222;">Date</label>
          <input type="text" name="date" id="date" value="<?= htmlspecialchars($header['date'] ?? '') ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">
        </div>
      </div>
      <h3 style="margin:18px 0 8px 0; font-size:1.13em; color:#222;">Order Items</h3>
      <table id="po-items-table" style="width:100%; border-collapse:collapse; margin-bottom:12px; background:#fff;">
        <thead>
          <tr style="background:#f5f5f5; font-size:0.97em;">
            <th style="padding:6px 4px;">Item</th>
            <th style="padding:6px 4px;">Item Name</th>
            <th style="padding:6px 4px;">Qty</th>
            <th style="padding:6px 4px;">Unit</th>
            <th style="padding:6px 4px;">Unit Price</th>
            <th style="padding:6px 4px;">Discount</th>
            <th style="padding:6px 4px;">Tax %</th>
            <th style="padding:6px 4px;">Tax Amt</th>
            <th style="padding:6px 4px;">Total</th>
            <th style="padding:6px 4px;"></th>
          </tr>
        </thead>
        <tbody>
          <?php if (empty($poRows)): ?>
            <tr>
              <td>
                <select name="item_id[]" style="width:120px; padding:3px 5px; font-size:0.97em;">
                  <option value="">-- Select --</option>
                  <?php foreach ($inventory as $item): ?>
                    <option value="<?= htmlspecialchars($item['item_id']) ?>">
                      <?= htmlspecialchars($item['item_id']) ?>
                    </option>
                  <?php endforeach; ?>
                </select>
              </td>
              <td><input type="text" name="item_name[]" style="width:110px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="quantity[]" min="1" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="text" name="unit[]" style="width:50px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="unit_price[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="discount[]" step="0.01" style="width:60px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="tax_rate[]" step="0.01" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="tax_amount[]" step="0.01" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
              <td><input type="number" name="total[]" step="0.01" style="width:85px; padding:3px 5px; font-size:0.97em;"></td>
              <td><button type="button" onclick="removeRow(this)" style="padding:2px 7px; font-size:1.1em;">üóë</button></td>
            </tr>
          <?php else: ?>
            <?php foreach ($poRows as $row): ?>
              <tr>
                <td>
                  <select name="item_id[]" style="width:120px; padding:3px 5px; font-size:0.97em;">
                    <option value="">-- Select --</option>
                    <?php foreach ($inventory as $item): ?>
                      <?php $selected = ($item['item_id'] ?? '') === ($row['item_id'] ?? '') ? 'selected' : ''; ?>
                      <option value="<?= htmlspecialchars($item['item_id']) ?>" <?= $selected ?>>
                        <?= htmlspecialchars($item['item_id']) ?>
                      </option>
                    <?php endforeach; ?>
                  </select>
                </td>
                <td><input type="text" name="item_name[]" value="<?= htmlspecialchars($row['item_name'] ?? '') ?>" style="width:110px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="quantity[]" min="1" value="<?= htmlspecialchars($row['quantity'] ?? '') ?>" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="text" name="unit[]" value="<?= htmlspecialchars($row['unit'] ?? '') ?>" style="width:50px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="unit_price[]" step="0.01" value="<?= htmlspecialchars($row['unit_price'] ?? '') ?>" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="discount[]" step="0.01" value="<?= htmlspecialchars($row['discount'] ?? '') ?>" style="width:60px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="tax_rate[]" step="0.01" value="<?= htmlspecialchars($row['tax_rate'] ?? '') ?>" style="width:55px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="tax_amount[]" step="0.01" value="<?= htmlspecialchars($row['tax_amount'] ?? '') ?>" style="width:75px; padding:3px 5px; font-size:0.97em;"></td>
                <td><input type="number" name="total[]" step="0.01" value="<?= htmlspecialchars($row['total'] ?? '') ?>" style="width:85px; padding:3px 5px; font-size:0.97em;"></td>
                <td><button type="button" onclick="removeRow(this)" style="padding:2px 7px; font-size:1.1em;">üóë</button></td>
              </tr>
            <?php endforeach; ?>
          <?php endif; ?>
        </tbody>
      </table>
      <button type="button" onclick="addRow()" style="margin-bottom:18px;">‚ûï Add Item</button>
      <div style="margin-top:18px; text-align:center;">
        <button type="submit" class="btn-primary" style="padding:7px 22px; font-size:1.08em;">üíæ Update Purchase Order</button>
        <a href="purchase_orders_list.php" class="btn-outline" style="margin-left:18px;">Cancel</a>
      </div>
    </form>
    <script>
      function addRow() {
        const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
        const row = table.rows[0].cloneNode(true);
        Array.from(row.querySelectorAll('input,select')).forEach(el => el.value = '');
        table.appendChild(row);
      }
      function removeRow(btn) {
        const table = document.getElementById('po-items-table').getElementsByTagName('tbody')[0];
        if (table.rows.length > 1) {
          btn.closest('tr').remove();
        }
      }
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_edit.php ---



--- Start of purchase_order_receive.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$inventorySchema = require __DIR__ . '/inventory_schema.php';
$inventoryFile = __DIR__ . '/inventory.csv';
$backorderFile = __DIR__ . '/backorders.csv';

$orders = readCSV($poFile, $schema);
$inventory = readCSV($inventoryFile, $inventorySchema);

function read_backorders($filename) {
  if (!file_exists($filename)) {
    return [];
  }
  $rows = [];
  if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle);
    if ($headers === false) {
      return [];
    }
    while (($data = fgetcsv($handle)) !== false) {
      if (count($data) !== count($headers)) {
        continue;
      }
      $rows[] = array_combine($headers, $data);
    }
    fclose($handle);
  }
  return $rows;
}

function write_backorders($filename, $rows) {
  $headers = ['po_number','item_id','item_name','quantity_backorder','note','created_at'];
  $file = fopen($filename, 'w');
  if ($file === false) {
    return;
  }
  fputcsv($file, $headers);
  foreach ($rows as $row) {
    $line = [];
    foreach ($headers as $header) {
      $line[] = $row[$header] ?? '';
    }
    fputcsv($file, $line);
  }
  fclose($file);
}

function find_inventory_index($inventory, $itemId) {
  foreach ($inventory as $idx => $row) {
    if (($row['item_id'] ?? '') === $itemId) {
      return $idx;
    }
  }
  return -1;
}

function init_inventory_row($schema, $itemId, $itemName) {
  $row = [];
  foreach ($schema as $field) {
    $row[$field] = '';
  }
  $row['item_id'] = $itemId;
  $row['item_name'] = $itemName;
  $row['quantity_in_stock'] = '0';
  $row['status'] = 'Stock';
  $row['created_at'] = date('Y-m-d H:i:s');
  $row['updated_at'] = $row['created_at'];
  return $row;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['receive_po'])) {
  $poNumber = trim($_POST['po_number'] ?? '');
  $receiveAll = ($_POST['receive_all'] ?? '') === 'yes';
  $note = trim($_POST['backorder_note'] ?? '');

  $itemIds = $_POST['item_id'] ?? [];
  $itemNames = $_POST['item_name'] ?? [];
  $orderedQtys = $_POST['ordered_qty'] ?? [];
  $backorderQtys = $_POST['backorder_qty'] ?? [];

  $backorders = read_backorders($backorderFile);

  foreach ($itemIds as $i => $itemId) {
    $itemId = trim($itemId);
    $itemName = trim($itemNames[$i] ?? '');
    $ordered = is_numeric($orderedQtys[$i] ?? '') ? (float)$orderedQtys[$i] : 0.0;
    $backorder = 0.0;
    if (!$receiveAll) {
      $backorder = is_numeric($backorderQtys[$i] ?? '') ? (float)$backorderQtys[$i] : 0.0;
    }
    $backorder = max(0.0, min($ordered, $backorder));
    $received = max(0.0, $ordered - $backorder);

    if ($itemId === '' && $itemName === '') {
      continue;
    }

    if ($itemId !== '') {
      $invIndex = find_inventory_index($inventory, $itemId);
      if ($invIndex < 0) {
        $inventory[] = init_inventory_row($inventorySchema, $itemId, $itemName);
        $invIndex = count($inventory) - 1;
      }
      if ($received > 0) {
        $current = is_numeric($inventory[$invIndex]['quantity_in_stock'] ?? '') ? (float)$inventory[$invIndex]['quantity_in_stock'] : 0.0;
        $inventory[$invIndex]['quantity_in_stock'] = (string)($current + $received);
      }
      if ($backorder > 0) {
        $inventory[$invIndex]['status'] = 'Backorder';
      } elseif (($inventory[$invIndex]['status'] ?? '') === 'Backorder') {
        $inventory[$invIndex]['status'] = 'Stock';
      }
      $inventory[$invIndex]['updated_at'] = date('Y-m-d H:i:s');
    }

    if ($backorder > 0) {
      $backorders[] = [
        'po_number' => $poNumber,
        'item_id' => $itemId,
        'item_name' => $itemName,
        'quantity_backorder' => (string)$backorder,
        'note' => $note,
        'created_at' => date('Y-m-d H:i:s')
      ];
    }
  }

  writeCSV($inventoryFile, $inventory, $inventorySchema);
  write_backorders($backorderFile, $backorders);

  header('Location: purchase_orders_list.php');
  exit;
}

$poNumber = trim($_GET['po'] ?? '');
$poRows = array_values(array_filter($orders, function($row) use ($poNumber) {
  return ($row['po_number'] ?? '') === $poNumber;
}));
?>
<div class="container">
  <h2>Receive Purchase Order</h2>
  <?php if ($poNumber === '' || empty($poRows)): ?>
    <div style="text-align:center; color:#888; margin:18px 0;">Purchase order not found.</div>
    <div style="text-align:center;">
      <a href="purchase_orders_list.php" class="btn-outline">Back to Purchase Orders</a>
    </div>
  <?php else: ?>
    <form method="post" style="max-width:900px; margin:auto; background:#fafbfc; border-radius:8px; padding:24px 28px 18px 28px; box-shadow:0 2px 8px #0001;">
      <input type="hidden" name="receive_po" value="1">
      <input type="hidden" name="po_number" value="<?= htmlspecialchars($poNumber) ?>">
      <div style="display:flex; flex-wrap:wrap; gap:12px 24px; margin-bottom:16px; align-items:center;">
        <div style="font-weight:600;">PO Number:</div>
        <div><?= htmlspecialchars($poNumber) ?></div>
      </div>
      <div style="display:flex; gap:14px; align-items:center; margin-bottom:12px;">
        <div style="font-weight:600;">All items received?</div>
        <label><input type="radio" name="receive_all" value="yes" checked> Yes</label>
        <label><input type="radio" name="receive_all" value="no"> No</label>
      </div>
      <div id="backorderSection" style="display:none;">
        <div style="margin-bottom:10px; font-weight:600;">Backorder Details</div>
        <div style="margin-bottom:10px;">
          <label for="backorder_note" style="display:block; font-weight:600; margin-bottom:4px;">Backorder Note</label>
          <textarea name="backorder_note" id="backorder_note" class="inv-input" style="width:100%; min-height:70px; resize:vertical;"></textarea>
        </div>
      </div>
      <table style="width:100%; border-collapse:collapse; margin-bottom:12px; background:#fff;">
        <thead>
          <tr style="background:#f5f5f5; font-size:0.97em;">
            <th style="padding:6px 4px;">Item ID</th>
            <th style="padding:6px 4px;">Item Name</th>
            <th style="padding:6px 4px;">Ordered Qty</th>
            <th style="padding:6px 4px;">Backorder Qty</th>
            <th style="padding:6px 4px;">Received Qty</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($poRows as $idx => $row): ?>
            <tr>
              <td style="padding:6px 4px;">
                <?= htmlspecialchars($row['item_id'] ?? '') ?>
                <input type="hidden" name="item_id[]" value="<?= htmlspecialchars($row['item_id'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <?= htmlspecialchars($row['item_name'] ?? '') ?>
                <input type="hidden" name="item_name[]" value="<?= htmlspecialchars($row['item_name'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <?= htmlspecialchars($row['quantity'] ?? '') ?>
                <input type="hidden" name="ordered_qty[]" value="<?= htmlspecialchars($row['quantity'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <input type="number" name="backorder_qty[]" min="0" step="0.01" style="width:110px; padding:3px 5px; font-size:0.97em;" value="0" data-ordered="<?= htmlspecialchars($row['quantity'] ?? '') ?>">
              </td>
              <td style="padding:6px 4px;">
                <span class="received-qty" data-ordered="<?= htmlspecialchars($row['quantity'] ?? '') ?>"><?= htmlspecialchars($row['quantity'] ?? '') ?></span>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
      <div style="margin-top:18px; text-align:center;">
        <button type="submit" class="btn-primary" style="padding:7px 22px; font-size:1.08em;">Receive Items</button>
        <a href="purchase_orders_list.php" class="btn-outline" style="margin-left:18px;">Cancel</a>
      </div>
    </form>
    <script>
      const receiveRadios = Array.from(document.querySelectorAll('input[name="receive_all"]'));
      const backorderSection = document.getElementById('backorderSection');
      const backorderInputs = Array.from(document.querySelectorAll('input[name="backorder_qty[]"]'));
      const receivedLabels = Array.from(document.querySelectorAll('.received-qty'));

      function updateReceived() {
        backorderInputs.forEach((input, index) => {
          const ordered = parseFloat(input.getAttribute('data-ordered'));
          const backorder = parseFloat(input.value);
          const orderedVal = Number.isFinite(ordered) ? ordered : 0;
          const backorderVal = Number.isFinite(backorder) ? backorder : 0;
          const received = Math.max(0, orderedVal - Math.min(orderedVal, backorderVal));
          if (receivedLabels[index]) {
            receivedLabels[index].textContent = received.toFixed(2).replace(/\.00$/, '');
          }
        });
      }

      function toggleBackorderSection() {
        const receiveAll = document.querySelector('input[name="receive_all"]:checked').value === 'yes';
        backorderSection.style.display = receiveAll ? 'none' : 'block';
        backorderInputs.forEach(input => {
          input.disabled = receiveAll;
          if (receiveAll) {
            input.value = '0';
          }
        });
        updateReceived();
      }

      receiveRadios.forEach(radio => {
        radio.addEventListener('change', toggleBackorderSection);
      });

      backorderInputs.forEach(input => {
        input.addEventListener('input', updateReceived);
      });

      toggleBackorderSection();
    </script>
  <?php endif; ?>
</div>
<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_receive.php ---



--- Start of purchase_order_schema.php ---

<?php
return [
    'po_number',
    'date',
    'status',
    'supplier_id',
    'supplier_name',
    'supplier_contact',
    'supplier_address',
    'billing_address',
    'shipping_address',
    'item_id',
    'item_name',
    'quantity',
    'unit',
    'unit_price',
    'discount',
    'tax_rate',
    'tax_amount',
    'total',
    'subtotal',
    'total_discount',
    'total_tax',
    'shipping_cost',
    'other_fees',
    'grand_total',
    'currency',
    'expected_delivery',
    'payment_terms',
    'notes',
    'created_by',
    'created_at',
    'updated_at'
];


--- End of purchase_order_schema.php ---



--- Start of purchase_order_summary.php ---

<?php
$pageTitle = 'Purchase Order Summary';
include_once(__DIR__ . '/layout_start.php');
require_once __DIR__ . '/csv_handler.php';

$schema = require __DIR__ . '/purchase_order_schema.php';
$poFile = __DIR__ . '/purchase_orders.csv';
$poNumber = trim($_GET['po'] ?? '');

/*
// Optional: server-side email (enable later when SMTP is configured).
// Example using PHPMailer (requires PHPMailer.php, SMTP.php, Exception.php).
//
// use PHPMailer\PHPMailer\PHPMailer;
// use PHPMailer\PHPMailer\Exception;
// require 'PHPMailer.php';
// require 'SMTP.php';
// require 'Exception.php';
//
// if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['send_supplier_email'])) {
//   $emailTo = trim($_POST['supplier_email'] ?? '');
//   $subject = trim($_POST['email_subject'] ?? '');
//   $body = trim($_POST['email_body'] ?? '');
//
//   if ($emailTo !== '' && $subject !== '' && $body !== '') {
//     $mail = new PHPMailer(true);
//     // Configure SMTP
//     $mail->isSMTP();
//     $mail->Host = 'relay-hosting.secureserver.net';
//     $mail->SMTPAuth = false;
//     $mail->SMTPSecure = '';
//     $mail->Port = 25;
//
//     $mail->setFrom('rlee@eclipsewatertechnologies.com', 'Eclipse Purchase Orders');
//     $mail->addAddress($emailTo);
//     $mail->Subject = $subject;
//     $mail->Body = $body;
//     $mail->send();
//   }
// }
*/

$orders = readCSV($poFile, $schema);
$items = array_values(array_filter($orders, function($row) use ($poNumber) {
  return ($row['po_number'] ?? '') === $poNumber;
}));

function to_float($value) {
  return is_numeric($value) ? (float)$value : 0.0;
}

function format_money($amount, $currency) {
  $formatted = number_format($amount, 2, '.', ',');
  return $currency !== '' ? $currency . ' ' . $formatted : $formatted;
}

$header = $items[0] ?? null;
$currency = $header['currency'] ?? '';

$scheme = $_SERVER['REQUEST_SCHEME'] ?? 'http';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$basePath = rtrim(dirname($_SERVER['SCRIPT_NAME'] ?? ''), '/\\');
$shareUrl = $scheme . '://' . $host . $basePath . '/purchase_order_summary.php?po=' . urlencode($poNumber);

$subtotal = 0.0;
$total_discount = 0.0;
$total_tax = 0.0;
$grand_total = 0.0;

foreach ($items as $row) {
  $qty = to_float($row['quantity'] ?? '');
  $unit_price = to_float($row['unit_price'] ?? '');
  $discount = to_float($row['discount'] ?? '');
  $tax_rate = to_float($row['tax_rate'] ?? '');
  $tax_amount = to_float($row['tax_amount'] ?? '');
  $total = to_float($row['total'] ?? '');

  $line_subtotal = $qty * $unit_price;
  $line_tax = $tax_amount;
  if ($line_tax == 0.0 && $tax_rate > 0.0) {
    $line_tax = ($line_subtotal - $discount) * ($tax_rate / 100.0);
  }
  $line_total = $total > 0.0 ? $total : ($line_subtotal - $discount + $line_tax);

  $subtotal += $line_subtotal;
  $total_discount += $discount;
  $total_tax += $line_tax;
  $grand_total += $line_total;
}

$displaySubtotal = ($header['subtotal'] ?? '') !== '' ? to_float($header['subtotal']) : $subtotal;
$displayDiscount = ($header['total_discount'] ?? '') !== '' ? to_float($header['total_discount']) : $total_discount;
$displayTax = ($header['total_tax'] ?? '') !== '' ? to_float($header['total_tax']) : $total_tax;
$displayShipping = to_float($header['shipping_cost'] ?? '');
$displayOtherFees = to_float($header['other_fees'] ?? '');
$displayGrand = ($header['grand_total'] ?? '') !== '' ? to_float($header['grand_total']) : ($grand_total + $displayShipping + $displayOtherFees);
?>

<style>
  @media print {
    .no-print { display: none; }
    body { background: #ffffff; }
  }
</style>

<div style="max-width:900px; margin:0 auto 24px auto; background:#ffffff; border:1px solid #e2e2e2; border-radius:8px; padding:24px;">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0 0 6px 0;">Purchase Order Summary</h2>
      <?php if ($poNumber !== ''): ?>
        <div style="font-size:0.98em; color:#333;">PO Number: <strong><?= htmlspecialchars($poNumber) ?></strong></div>
      <?php endif; ?>
      <?php if (!empty($header['date'])): ?>
        <div style="font-size:0.98em; color:#333;">Date: <?= htmlspecialchars($header['date']) ?></div>
      <?php endif; ?>
    </div>
    <div class="no-print">
      <button type="button" onclick="window.print()" style="padding:6px 12px;">Download PDF</button>
    </div>
  </div>

  <?php if ($poNumber === ''): ?>
    <div style="margin-top:18px; color:#b00020;">Missing PO number. Add ?po=PO_NUMBER to the link.</div>
  <?php elseif (empty($items)): ?>
    <div style="margin-top:18px; color:#b00020;">No purchase order found for this PO number.</div>
  <?php else: ?>
    <div class="no-print" style="margin-top:14px; border:1px solid #e2e2e2; border-radius:6px; padding:12px; background:#fbfbfb;">
      <div style="font-weight:600; margin-bottom:6px;">Email Supplier</div>
      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
        <div style="display:flex; flex-direction:column; min-width:220px;">
          <label for="supplier_email" style="font-size:0.95em; font-weight:600; margin-bottom:2px;">Supplier Email</label>
          <input type="email" id="supplier_email" value="<?= htmlspecialchars($header['supplier_contact'] ?? '') ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">
        </div>
        <div style="display:flex; flex-direction:column; min-width:220px;">
          <label for="email_subject" style="font-size:0.95em; font-weight:600; margin-bottom:2px;">Subject</label>
          <input type="text" id="email_subject" value="Purchase Order Summary <?= htmlspecialchars($poNumber) ?>" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">
        </div>
        <div style="display:flex; flex-direction:column; min-width:280px; flex:1;">
          <label for="email_body" style="font-size:0.95em; font-weight:600; margin-bottom:2px;">Message</label>
          <textarea id="email_body" rows="3" style="padding:4px 7px; border-radius:4px; border:1px solid #bbb; font-size:0.97em;">Hello <?= htmlspecialchars($header['supplier_name'] ?? '') ?>,

Please find the purchase order summary here: <?= htmlspecialchars($shareUrl) ?>

Thank you.</textarea>
        </div>
        <div>
          <button type="button" onclick="sendSupplierEmail()" style="padding:6px 12px;">Send Email</button>
        </div>
      </div>
      <div style="margin-top:6px; font-size:0.92em; color:#666;">This uses your email client (mailto).</div>
    </div>

    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:16px; margin-top:18px;">
      <div style="border:1px solid #e2e2e2; border-radius:6px; padding:12px;">
        <div style="font-weight:600; margin-bottom:6px;">Supplier</div>
        <div><?= htmlspecialchars($header['supplier_name'] ?? '') ?></div>
        <div><?= htmlspecialchars($header['supplier_contact'] ?? '') ?></div>
        <div><?= nl2br(htmlspecialchars($header['supplier_address'] ?? '')) ?></div>
      </div>
      <div style="border:1px solid #e2e2e2; border-radius:6px; padding:12px;">
        <div style="font-weight:600; margin-bottom:6px;">Billing Address</div>
        <div><?= nl2br(htmlspecialchars($header['billing_address'] ?? '')) ?></div>
      </div>
      <div style="border:1px solid #e2e2e2; border-radius:6px; padding:12px;">
        <div style="font-weight:600; margin-bottom:6px;">Shipping Address</div>
        <div><?= nl2br(htmlspecialchars($header['shipping_address'] ?? '')) ?></div>
      </div>
    </div>

    <h3 style="margin:20px 0 8px 0;">Items Requested</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="6" style="width:100%; border-collapse:collapse; font-size:0.97em;">
        <thead style="background:#f5f5f5;">
          <tr>
            <th style="padding:8px 6px;">Item ID</th>
            <th style="padding:8px 6px;">Item Name</th>
            <th style="padding:8px 6px;">Qty</th>
            <th style="padding:8px 6px;">Unit</th>
            <th style="padding:8px 6px;">Unit Price</th>
            <th style="padding:8px 6px;">Discount</th>
            <th style="padding:8px 6px;">Tax</th>
            <th style="padding:8px 6px;">Line Total</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($items as $row): ?>
            <?php
              $qty = to_float($row['quantity'] ?? '');
              $unit_price = to_float($row['unit_price'] ?? '');
              $discount = to_float($row['discount'] ?? '');
              $tax_rate = to_float($row['tax_rate'] ?? '');
              $tax_amount = to_float($row['tax_amount'] ?? '');
              $total = to_float($row['total'] ?? '');
              $line_subtotal = $qty * $unit_price;
              $line_tax = $tax_amount;
              if ($line_tax == 0.0 && $tax_rate > 0.0) {
                $line_tax = ($line_subtotal - $discount) * ($tax_rate / 100.0);
              }
              $line_total = $total > 0.0 ? $total : ($line_subtotal - $discount + $line_tax);
            ?>
            <tr>
              <td style="padding:6px 4px;"><?= htmlspecialchars($row['item_id'] ?? '') ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars($row['item_name'] ?? '') ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars($row['quantity'] ?? '') ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars($row['unit'] ?? '') ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars(format_money($unit_price, $currency)) ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars(format_money($discount, $currency)) ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars(format_money($line_tax, $currency)) ?></td>
              <td style="padding:6px 4px;"><?= htmlspecialchars(format_money($line_total, $currency)) ?></td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>

    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-top:18px;">
      <div style="border:1px solid #e2e2e2; border-radius:6px; padding:12px;">
        <div style="font-weight:600; margin-bottom:6px;">Totals</div>
        <div>Subtotal: <?= htmlspecialchars(format_money($displaySubtotal, $currency)) ?></div>
        <div>Total Discount: <?= htmlspecialchars(format_money($displayDiscount, $currency)) ?></div>
        <div>Total Tax: <?= htmlspecialchars(format_money($displayTax, $currency)) ?></div>
        <div>Shipping: <?= htmlspecialchars(format_money($displayShipping, $currency)) ?></div>
        <div>Other Fees: <?= htmlspecialchars(format_money($displayOtherFees, $currency)) ?></div>
        <div style="margin-top:6px; font-weight:600;">Grand Total: <?= htmlspecialchars(format_money($displayGrand, $currency)) ?></div>
      </div>
      <div style="border:1px solid #e2e2e2; border-radius:6px; padding:12px;">
        <div style="font-weight:600; margin-bottom:6px;">Terms</div>
        <div>Expected Delivery: <?= htmlspecialchars($header['expected_delivery'] ?? '') ?></div>
        <div>Payment Terms: <?= htmlspecialchars($header['payment_terms'] ?? '') ?></div>
        <div style="margin-top:6px; font-weight:600;">Notes</div>
        <div><?= nl2br(htmlspecialchars($header['notes'] ?? '')) ?></div>
      </div>
    </div>
  <?php endif; ?>
</div>

<script>
  function sendSupplierEmail() {
    const email = document.getElementById('supplier_email').value.trim();
    const subject = document.getElementById('email_subject').value.trim();
    const body = document.getElementById('email_body').value.trim();

    if (!email) {
      alert('Please enter a supplier email address.');
      return;
    }

    if (!body) {
      alert('Email body is empty.');
      return;
    }

    const mailtoLink = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
  }
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of purchase_order_summary.php ---



--- Start of renewals.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Contract Renewals';
$contractSchema = require __DIR__ . '/contract_schema.php';
$contracts = readCSV('contracts.csv', $contractSchema) ?: [];
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');

$today = strtotime(date('Y-m-d'));
$upcoming = [];
$critical = [];
$actionNeeded = [];

foreach ($contracts as $contract) {
    if ($contract['contract_status'] !== 'Active') continue;
    
    if (empty($contract['end_date'])) continue;
    
    $endDate = strtotime($contract['end_date']);
    $daysToExpiry = round(($endDate - $today) / 86400);
    
    // Find contact info
    $contactInfo = null;
    foreach ($contacts as $c) {
        if ($c['id'] === $contract['contact_id']) {
            $contactInfo = $c;
            break;
        }
    }
    
    $item = array_merge($contract, [
        'days_to_expiry' => $daysToExpiry,
        'contact_info' => $contactInfo
    ]);
    
    // Categorize
    if ($daysToExpiry <= 30) {
        $critical[] = $item;
        $actionNeeded[] = $item;
    } elseif ($daysToExpiry <= 90) {
        $actionNeeded[] = $item;
    } elseif ($daysToExpiry <= 180) {
        $upcoming[] = $item;
    }
}

// Sort by days to expiry
usort($critical, fn($a, $b) => $a['days_to_expiry'] - $b['days_to_expiry']);
usort($actionNeeded, fn($a, $b) => $a['days_to_expiry'] - $b['days_to_expiry']);
usort($upcoming, fn($a, $b) => $a['days_to_expiry'] - $b['days_to_expiry']);

// Calculate renewal metrics
$totalRenewalValue = 0;
foreach ($actionNeeded as $item) {
    $totalRenewalValue += (float)($item['annual_value'] ?? 0);
}
?>

<style>
.renewal-header {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.renewal-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.metric-card.critical {
    border-left: 4px solid #EF4444;
}

.metric-card.warning {
    border-left: 4px solid #F59E0B;
}

.metric-card.upcoming {
    border-left: 4px solid #3B82F6;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 36px;
    font-weight: 700;
    color: #1F2937;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.renewal-section {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title {
    font-size: 20px;
    font-weight: 700;
    color: #1F2937;
    display: flex;
    align-items: center;
    gap: 12px;
}

.priority-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
}

.priority-critical {
    background: #FEE2E2;
    color: #991B1B;
}

.priority-warning {
    background: #FEF3C7;
    color: #92400E;
}

.priority-upcoming {
    background: #DBEAFE;
    color: #1E40AF;
}

.renewal-card {
    background: #F9FAFB;
    padding: 24px;
    border-radius: 12px;
    border: 2px solid #E5E7EB;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.renewal-card:hover {
    border-color: #F59E0B;
    transform: translateX(4px);
}

.renewal-card.critical {
    border-left: 4px solid #EF4444;
}

.renewal-card.warning {
    border-left: 4px solid #F59E0B;
}

.renewal-header-row {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
}

.contract-info h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 700;
    color: #1F2937;
}

.contract-meta {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: #6B7280;
}

.expiry-info {
    text-align: right;
}

.days-remaining {
    font-size: 32px;
    font-weight: 700;
}

.days-remaining.critical {
    color: #EF4444;
}

.days-remaining.warning {
    color: #F59E0B;
}

.days-label {
    font-size: 12px;
    color: #6B7280;
    text-transform: uppercase;
}

.renewal-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    padding: 16px 0;
    border-top: 1px solid #E5E7EB;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.detail-label {
    font-size: 12px;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 16px;
    font-weight: 700;
    color: #1F2937;
}

.renewal-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-renew {
    background: #10B981;
    color: white;
}

.btn-renew:hover {
    background: #059669;
}

.btn-contact {
    background: #3B82F6;
    color: white;
}

.btn-contact:hover {
    background: #2563EB;
}

.btn-view {
    background: #F3F4F6;
    color: #374151;
    border: 2px solid #E5E7EB;
}

.btn-view:hover {
    background: #E5E7EB;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}
</style>

<div class="renewal-header">
    <h1>üîÑ Contract Renewals</h1>
    <p>Track and manage upcoming contract expirations</p>
</div>

<!-- Metrics -->
<div class="metrics-grid">
    <div class="metric-card critical">
        <div class="metric-label">Critical (‚â§30 Days)</div>
        <div class="metric-value"><?= count($critical) ?></div>
        <div class="metric-subtext">Immediate action required</div>
    </div>
    
    <div class="metric-card warning">
        <div class="metric-label">Action Needed (‚â§90 Days)</div>
        <div class="metric-value"><?= count($actionNeeded) ?></div>
        <div class="metric-subtext">Start renewal conversations</div>
    </div>
    
    <div class="metric-card upcoming">
        <div class="metric-label">Upcoming (‚â§180 Days)</div>
        <div class="metric-value"><?= count($upcoming) ?></div>
        <div class="metric-subtext">Plan ahead</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Renewal Revenue at Risk</div>
        <div class="metric-value">$<?= number_format($totalRenewalValue, 0) ?></div>
        <div class="metric-subtext">Annual value of expiring contracts</div>
    </div>
</div>

<!-- Critical Renewals (‚â§30 days) -->
<?php if (!empty($critical)): ?>
<div class="renewal-section">
    <div class="section-header">
        <div class="section-title">
            üö® Critical - Immediate Action Required
            <span class="priority-badge priority-critical"><?= count($critical) ?> contracts</span>
        </div>
    </div>
    
    <?php foreach ($critical as $contract): ?>
        <?php
        $contactName = 'Unknown';
        $contactEmail = '';
        $contactPhone = '';
        if ($contract['contact_info']) {
            $contactName = trim($contract['contact_info']['first_name'] . ' ' . $contract['contact_info']['last_name']);
            $contactEmail = $contract['contact_info']['email'] ?? '';
            $contactPhone = $contract['contact_info']['phone'] ?? '';
        }
        ?>
        <div class="renewal-card critical">
            <div class="renewal-header-row">
                <div class="contract-info">
                    <h3><?= htmlspecialchars($contract['contract_id']) ?></h3>
                    <div class="contract-meta">
                        <span>üë§ <?= htmlspecialchars($contactName) ?></span>
                        <span>üîß <?= htmlspecialchars($contract['equipment_type']) ?></span>
                    </div>
                </div>
                <div class="expiry-info">
                    <div class="days-remaining critical"><?= $contract['days_to_expiry'] ?></div>
                    <div class="days-label">Days Remaining</div>
                </div>
            </div>
            
            <div class="renewal-details">
                <div class="detail-item">
                    <span class="detail-label">Monthly Fee</span>
                    <span class="detail-value">$<?= number_format((float)$contract['monthly_fee'], 2) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Annual Value</span>
                    <span class="detail-value">$<?= number_format((float)$contract['annual_value'], 2) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">End Date</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['end_date']) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Auto-Renew</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['auto_renew']) ?></span>
                </div>
            </div>
            
            <div class="renewal-actions">
                <a href="contract_renew.php?id=<?= urlencode($contract['contract_id']) ?>" class="btn btn-renew">
                    ‚úì Start Renewal Process
                </a>
                <?php if ($contactEmail): ?>
                    <a href="mailto:<?= htmlspecialchars($contactEmail) ?>?subject=Contract Renewal - <?= htmlspecialchars($contract['contract_id']) ?>" 
                       class="btn btn-contact">
                        ‚úâÔ∏è Email Customer
                    </a>
                <?php endif; ?>
                <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" class="btn btn-view">
                    View Details
                </a>
            </div>
        </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<!-- Action Needed (31-90 days) -->
<?php if (!empty($actionNeeded)): ?>
<div class="renewal-section">
    <div class="section-header">
        <div class="section-title">
            ‚ö†Ô∏è Action Needed - Start Renewal Conversations
            <span class="priority-badge priority-warning"><?= count($actionNeeded) ?> contracts</span>
        </div>
    </div>
        
    <?php foreach ($actionNeeded as $contract): ?>
        <?php if ($contract['days_to_expiry'] <= 30) continue; // Skip critical ones ?>
        <?php
        $contactName = 'Unknown';
        if ($contract['contact_info']) {
            $contactName = trim($contract['contact_info']['first_name'] . ' ' . $contract['contact_info']['last_name']);
        }
        ?>
        <div class="renewal-card warning">
            <div class="renewal-header-row">
                <div class="contract-info">
                    <h3><?= htmlspecialchars($contract['contract_id']) ?></h3>
                    <div class="contract-meta">
                        <span>üë§ <?= htmlspecialchars($contactName) ?></span>
                        <span>üîß <?= htmlspecialchars($contract['equipment_type']) ?></span>
                    </div>
                </div>
                <div class="expiry-info">
                    <div class="days-remaining warning"><?= $contract['days_to_expiry'] ?></div>
                    <div class="days-label">Days Remaining</div>
                </div>
            </div>
            
            <div class="renewal-details">
                <div class="detail-item">
                    <span class="detail-label">Monthly Fee</span>
                    <span class="detail-value">$<?= number_format((float)$contract['monthly_fee'], 2) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">End Date</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['end_date']) ?></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Auto-Renew</span>
                    <span class="detail-value"><?= htmlspecialchars($contract['auto_renew']) ?></span>
                </div>
            </div>
            
            <div class="renewal-actions">
                <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" class="btn btn-view">
                    View Details
                </a>
            </div>
        </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<!-- Upcoming (91-180 days) -->
<?php if (!empty($upcoming)): ?>
<div class="renewal-section">
    <div class="section-header">
        <div class="section-title">
            üìÖ Upcoming Renewals
            <span class="priority-badge priority-upcoming"><?= count($upcoming) ?> contracts</span>
        </div>
    </div>
    
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: #F9FAFB; border-bottom: 2px solid #E5E7EB;">
            <tr>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Contract ID</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Equipment</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Monthly Fee</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">End Date</th>
                <th style="padding: 12px; text-align: left; font-size: 12px; color: #6B7280; text-transform: uppercase;">Days Remaining</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($upcoming as $contract): ?>
                <tr style="border-bottom: 1px solid #F3F4F6;">
                    <td style="padding: 12px;">
                        <a href="contract_view.php?id=<?= urlencode($contract['contract_id']) ?>" style="color: #3B82F6; font-weight: 600; text-decoration: none;">
                            <?= htmlspecialchars($contract['contract_id']) ?>
                        </a>
                    </td>
                    <td style="padding: 12px;"><?= htmlspecialchars($contract['equipment_type']) ?></td>
                    <td style="padding: 12px; font-weight: 700;">$<?= number_format((float)$contract['monthly_fee'], 2) ?></td>
                    <td style="padding: 12px;"><?= htmlspecialchars($contract['end_date']) ?></td>
                    <td style="padding: 12px; color: #3B82F6; font-weight: 600;"><?= $contract['days_to_expiry'] ?> days</td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>
<?php endif; ?>

<!-- No Renewals Due -->
<?php if (empty($critical) && empty($actionNeeded) && empty($upcoming)): ?>
<div class="renewal-section">
    <div class="empty-state">
        <div class="empty-state-icon">‚úÖ</div>
        <h3>All Clear!</h3>
        <p>No contracts expiring in the next 180 days</p>
    </div>
</div>
<?php endif; ?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of renewals.php ---



--- Start of revenue_dashboard.php ---

<?php
require_once 'layout_start.php';
require_once 'csv_handler.php';

$pageTitle = 'Revenue Dashboard';

// Load data
$contracts = readCSV('contracts.csv', require __DIR__ . '/contract_schema.php') ?: [];
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');

// Calculate MRR & ARR from active contracts
$mrr = 0;
$arr = 0;
$activeContracts = 0;
$contractsByType = [];
$monthlyRevenue = [];

foreach ($contracts as $contract) {
    if ($contract['contract_status'] === 'Active') {
        $activeContracts++;
        $monthlyFee = (float)($contract['monthly_fee'] ?? 0);
        $mrr += $monthlyFee;
        $arr += $monthlyFee * 12;
        
        // Group by equipment type
        $type = $contract['equipment_type'];
        if (!isset($contractsByType[$type])) {
            $contractsByType[$type] = ['count' => 0, 'mrr' => 0];
        }
        $contractsByType[$type]['count']++;
        $contractsByType[$type]['mrr'] += $monthlyFee;
    }
}

// Calculate Equipment Sales (Closed Won opportunities)
$equipmentSales = 0;
$salesCount = 0;
$salesPipeline = 0;
$pipelineWeighted = 0;

foreach ($opportunities as $opp) {
    $value = (float)($opp['value'] ?? 0);
    $prob = (float)($opp['probability'] ?? 0);
    
    if ($opp['stage'] === 'Closed Won') {
        $equipmentSales += $value;
        $salesCount++;
    } elseif (!in_array($opp['stage'], ['Closed Won', 'Closed Lost'])) {
        $salesPipeline += $value;
        $pipelineWeighted += ($value * $prob / 100);
    }
}

// Calculate growth metrics (simplified - compare to previous period)
$mrrGrowth = 12.5; // Placeholder - would calculate from historical data
$salesGrowth = 18.3; // Placeholder

// Calculate revenue mix
$totalRevenue = $arr + $equipmentSales;
$recurringPercent = $totalRevenue > 0 ? ($arr / $totalRevenue * 100) : 0;
$equipmentPercent = $totalRevenue > 0 ? ($equipmentSales / $totalRevenue * 100) : 0;
?>

<style>
.dashboard-header {
    background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.dashboard-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.metric-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #6366F1;
}

.metric-card.recurring {
    border-left-color: #10B981;
}

.metric-card.equipment {
    border-left-color: #F59E0B;
}

.metric-card.total {
    border-left-color: #8B5CF6;
}

.metric-label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 36px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 8px;
}

.metric-growth {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 600;
}

.growth-positive {
    color: #10B981;
}

.growth-negative {
    color: #EF4444;
}

.metric-subtext {
    font-size: 12px;
    color: #9CA3AF;
    margin-top: 4px;
}

.chart-section {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.chart-title {
    font-size: 20px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 20px;
}

.revenue-mix {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.mix-bar {
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 14px;
}

.mix-recurring {
    background: #10B981;
}

.mix-equipment {
    background: #F59E0B;
}

.breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.breakdown-card {
    background: #F9FAFB;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #E5E7EB;
}

.breakdown-header {
    font-size: 14px;
    font-weight: 700;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #E5E7EB;
}

.breakdown-item:last-child {
    border-bottom: none;
}

.breakdown-label {
    font-size: 14px;
    color: #374151;
}

.breakdown-value {
    font-size: 16px;
    font-weight: 700;
    color: #1F2937;
}

.breakdown-count {
    font-size: 12px;
    color: #9CA3AF;
    margin-left: 8px;
}

.pipeline-visual {
    background: linear-gradient(to right, #EFF6FF, #DBEAFE);
    padding: 24px;
    border-radius: 12px;
    margin-top: 16px;
}

.pipeline-stat {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
}

.pipeline-label {
    font-size: 14px;
    color: #1E40AF;
    font-weight: 600;
}

.pipeline-value {
    font-size: 18px;
    color: #1E40AF;
    font-weight: 700;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.action-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #E5E7EB;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.action-card:hover {
    border-color: #6366F1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.action-icon {
    font-size: 32px;
    margin-bottom: 12px;
}

.action-title {
    font-size: 16px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 4px;
}

.action-subtitle {
    font-size: 12px;
    color: #6B7280;
}
</style>

<div class="dashboard-header">
    <h1>üí∞ Revenue Dashboard</h1>
    <p>Comprehensive revenue tracking across all business streams</p>
</div>

<!-- Key Metrics -->
<div class="metrics-grid">
    <!-- MRR -->
    <div class="metric-card recurring">
        <div class="metric-label">Monthly Recurring Revenue</div>
        <div class="metric-value">$<?= number_format($mrr, 0) ?></div>
        <div class="metric-growth growth-positive">
            ‚Üó <?= number_format($mrrGrowth, 1) ?>% vs last month
        </div>
        <div class="metric-subtext"><?= $activeContracts ?> active SDI contracts</div>
    </div>
    
    <!-- ARR -->
    <div class="metric-card recurring">
        <div class="metric-label">Annual Recurring Revenue</div>
        <div class="metric-value">$<?= number_format($arr, 0) ?></div>
        <div class="metric-subtext">Projected from active contracts</div>
    </div>
    
    <!-- Equipment Sales -->
    <div class="metric-card equipment">
        <div class="metric-label">Equipment Sales (YTD)</div>
        <div class="metric-value">$<?= number_format($equipmentSales, 0) ?></div>
        <div class="metric-growth growth-positive">
            ‚Üó <?= number_format($salesGrowth, 1) ?>% vs last year
        </div>
        <div class="metric-subtext"><?= $salesCount ?> deals closed</div>
    </div>
    
    <!-- Total Revenue -->
    <div class="metric-card total">
        <div class="metric-label">Total Annual Revenue</div>
        <div class="metric-value">$<?= number_format($totalRevenue, 0) ?></div>
        <div class="metric-subtext">Combined ARR + Equipment Sales</div>
    </div>
    
    <!-- Sales Pipeline -->
    <div class="metric-card">
        <div class="metric-label">Active Pipeline</div>
        <div class="metric-value">$<?= number_format($salesPipeline, 0) ?></div>
        <div class="metric-subtext">
            Weighted: $<?= number_format($pipelineWeighted, 0) ?>
        </div>
    </div>
    
    <!-- Average Contract Value -->
    <div class="metric-card">
        <div class="metric-label">Avg Contract Value</div>
        <div class="metric-value">
            $<?= $activeContracts > 0 ? number_format($mrr / $activeContracts, 0) : 0 ?>
        </div>
        <div class="metric-subtext">Per month per contract</div>
    </div>
</div>

<!-- Revenue Mix Chart -->
<div class="chart-section">
    <div class="chart-title">Revenue Mix: Recurring vs. One-Time</div>
    <div class="revenue-mix">
        <div class="mix-bar mix-recurring" style="flex: <?= $recurringPercent ?>">
            <?= number_format($recurringPercent, 1) ?>% Recurring
        </div>
        <div class="mix-bar mix-equipment" style="flex: <?= $equipmentPercent ?>">
            <?= number_format($equipmentPercent, 1) ?>% Equipment
        </div>
    </div>
    <p style="margin-top: 16px; color: #6B7280; font-size: 14px;">
        <strong>Recurring Revenue:</strong> $<?= number_format($arr, 0) ?> | 
        <strong>Equipment Sales:</strong> $<?= number_format($equipmentSales, 0) ?>
    </p>
</div>

<!-- Revenue Breakdown -->
<div class="breakdown-grid">
    <!-- SDI Contracts by Type -->
    <div class="breakdown-card">
        <div class="breakdown-header">SDI Contracts by Equipment Type</div>
        <?php if (empty($contractsByType)): ?>
            <p style="color: #9CA3AF; font-style: italic">No active contracts</p>
        <?php else: ?>
            <?php arsort($contractsByType); ?>
            <?php foreach ($contractsByType as $type => $data): ?>
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <?= htmlspecialchars($type) ?>
                        <span class="breakdown-count">(<?= $data['count'] ?>)</span>
                    </div>
                    <div class="breakdown-value">
                        $<?= number_format($data['mrr'], 0) ?>/mo
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    
    <!-- Sales Pipeline -->
    <div class="breakdown-card">
        <div class="breakdown-header">Equipment Sales Pipeline</div>
        <div class="pipeline-visual">
            <div class="pipeline-stat">
                <span class="pipeline-label">Total Pipeline Value</span>
                <span class="pipeline-value">$<?= number_format($salesPipeline, 0) ?></span>
            </div>
            <div class="pipeline-stat">
                <span class="pipeline-label">Weighted Value (Forecast)</span>
                <span class="pipeline-value">$<?= number_format($pipelineWeighted, 0) ?></span>
            </div>
            <div class="pipeline-stat">
                <span class="pipeline-label">Average Deal Size</span>
                <span class="pipeline-value">
                    $<?= count($opportunities) > 0 ? number_format($salesPipeline / count(array_filter($opportunities, fn($o) => !in_array($o['stage'], ['Closed Won', 'Closed Lost']))), 0) : 0 ?>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="chart-section">
    <div class="chart-title">Quick Actions</div>
    <div class="quick-actions">
        <a href="contracts_list.php" class="action-card">
            <div class="action-icon">üìã</div>
            <div class="action-title">View Contracts</div>
            <div class="action-subtitle">Manage SDI agreements</div>
        </a>
        
        <a href="opportunities_list.php" class="action-card">
            <div class="action-icon">üíº</div>
            <div class="action-title">Sales Pipeline</div>
            <div class="action-subtitle">Track equipment sales</div>
        </a>
        
        <a href="pipeline_board.php" class="action-card">
            <div class="action-icon">üìä</div>
            <div class="action-title">Pipeline Board</div>
            <div class="action-subtitle">Visual sales tracking</div>
        </a>
        
        <a href="equipment_list.php" class="action-card">
            <div class="action-icon">üîß</div>
            <div class="action-title">Equipment Inventory</div>
            <div class="action-subtitle">Track all equipment</div>
        </a>
        
        <a href="contract_form.php" class="action-card">
            <div class="action-icon">‚ûï</div>
            <div class="action-title">New Contract</div>
            <div class="action-subtitle">Add SDI service agreement</div>
        </a>
        
        <a href="opportunity_form.php" class="action-card">
            <div class="action-icon">üí∞</div>
            <div class="action-title">New Opportunity</div>
            <div class="action-subtitle">Add equipment sale</div>
        </a>
    </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of revenue_dashboard.php ---



--- Start of sanitize_helper.php ---

<?php
/**
 * Output Sanitization & Escaping Helpers
 * Prevents XSS attacks by properly escaping output
 */

/**
 * Safely escape HTML special characters
 */
function escapeHtml($str) {
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}

/**
 * Short alias for escapeHtml()
 */
function e($str) {
    return escapeHtml($str);
}

/**
 * Escape for use in HTML attributes
 */
function escapeAttr($str) {
    return htmlspecialchars($str, ENT_QUOTES | ENT_HTML5, 'UTF-8');
}

/**
 * Escape for use in JavaScript context (use with caution)
 */
function escapeJs($str) {
    // JSON encoding provides safe JavaScript escaping
    return json_encode($str, JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_TAG);
}

/**
 * Escape for JSON output
 */
function escapeJson($data) {
    return json_encode($data, JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_TAG);
}

/**
 * Sanitize user input (remove HTML tags but keep data intact)
 */
function sanitizeInput($str) {
    return trim(strip_tags((string)$str));
}

/**
 * Format currency safely
 */
if (!function_exists('formatCurrency')) {
    function formatCurrency($value) {
        return '$' . number_format((float)$value, 0);
    }
}

/**
 * Format date safely
 */
function formatDate($date) {
    if (empty($date)) {
        return '';
    }
    try {
        $dt = new DateTime($date);
        return $dt->format('M d, Y');
    } catch (Exception $e) {
        return escapeHtml($date);
    }
}
?>


--- End of sanitize_helper.php ---



--- Start of sdi_cancel.php ---


<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evoqua SDI Contract Cancellation Tool</title>
  <link rel="stylesheet" href="styles.css?v=20251002">
</head>
<body>
<div class="container">
  
  
	<table>
		<caption>Suggestions on how to Cancel your contract - What you can do</caption>
		
		<tr>
			<td> Review your specific order or contract for any additional terms or amendments.<br>
				<br>
				Send a written notice (email or letter) to Evoqua‚Äôs official contact stating your intent and the reason for cancellation.<br>
				<br>
				Keep records of all correspondence and responses.</td>
		</tr>
			
			<th> How to cancel contract</th>
			<th> Contact Information</th>
		</tr>
		<tr>
			<td> Simply enter your informaiton in the fields below <br><br> Click "Generate Letter"</td>

			<td> Either email to<br><br> <a href="mailto:CentralAP@evoqua.com">CentralAP</a> 
				or<br><br>Fax to <br>(905) 890-6357 </td>

	</table>
	
	
   <!-- Termination Reason Table -->
   <section id="cancellation-form">
    <table>
	        <caption>Termination Reason Options</caption>
        <tr>
           <th>Reason</th>
            <th>Description</th>
        </tr>
        <tr>
          
            <td>End of Term</td>
            <td>For leased or rented equipment, the initial term automatically renews unless cancelled in writing by you or Evoqua.<br>
				<br>
				Notice Period: <br><br>You must provide written notice of cancellation not sooner than <b><u>three months</b></u> and <b><u>not later than one month before the end of the initial or any renewal term.</b></u><br>
				<br>	
				Obligations: <br><br>Cancelling service in writing before the end of the term does not relieve you of your obligation to pay the monthly rental/service charge for the full term.<br>
				<br>
				Return of Equipment: <br><br>Upon expiration or termination, you must make the leased equipment available for Evoqua to remove. </td>
        </tr>
        <tr>
            
            <td>Material Breach</td>
            <td>Either party (you or Evoqua) can terminate the agreement if the other party materially breaches the contract (e.g., fails to fulfill major obligations, files for bankruptcy).
	<br><br>Process: You must issue a written notice of breach and allow a 30-day period for the other party to cure (fix) the breach. <br><br>If the breach isn‚Äôt cured within 30 days, you can terminate the contract.
<br><br>Obligations: If you suspend an order for 90+ days without a change order, Evoqua may terminate with 15 days‚Äô written notice and is entitled to payment for work performed up to the termination date.</td>
        </tr>
    </table>
	
	
	
  <h1>Evoqua SDI Contract Cancellation Tool</h1>

  <section id="cancellation-form">
    <h2>Generate Your Cancellation Letter</h2>
    <form id="generate-letter-form">
      <div class="form-grid">
        <!-- Form fields -->
        <div class="form-group">
          <label for="account-number">Account Number</label>
          <input type="text" id="account-number" required>
        </div>
        <div class="form-group">
          <label for="contract-number">Quote/Contract Number</label>
          <input type="text" id="contract-number" required>
        </div>
        <div class="form-group">
          <label for="contract-end-date">Contract End Date</label>
          <input type="date" id="contract-end-date" required>
        </div>
        <div class="form-group">
          <label for="termination-reason">Reason for Termination</label>
          <select id="termination-reason" required>
            <option value="">Select reason</option>
            <option value="end-of-term">End of Term</option>
            <option value="material-breach">Material Breach</option>
          </select>
        </div>
        <div class="form-group">
          <label for="your-name">Your Name</label>
          <input type="text" id="your-name" required>
        </div>
        <div class="form-group">
          <label for="your-position">Your Position/Company</label>
          <input type="text" id="your-position" required>
        </div>
        <div class="form-group">
          <label for="your-contact">Your Contact Information</label>
          <input type="text" id="your-contact" required>
        </div>
      </div>
      <button type="submit">Generate Letter</button>
    </form>
  </section>
  
<style>
    .table-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        flex-wrap: wrap; /* responsive for smaller screens */
    }

    table {
        width: 45%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        background-color: #e6f0ff; /* secondary background */
        color: #004080; /* primary text color */
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    caption {
        font-weight: bold;
        font-size: 1.2em;
        padding: 10px;
        background-color: #004080; /* primary color */
        color: #ffffff; /* white text */
    }

    th, td {
        border: 1px solid #cccccc; /* accent border */
        padding: 8px 12px;
        text-align: left;
    }

    th {
        background-color: #004080; /* primary color */
        color: #ffffff;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9; /* subtle alternate row */
    }

    @media (max-width: 768px) {
        table {
            width: 100%; /* stack tables on small screens */
        }
    }
</style>

<div class="table-container">
   
 


  <section id="letter-output" class="hidden">
    <h2>Your Cancellation Letter</h2>
    <div id="generated-letter"></div>
    <br>
    <button class="btn-outline" id="download-word">Download as Word</button>
    <button class="btn-outline" id="download-pdf">Download as PDF</button>
  </section>
</div>


<script>

window.addEventListener('load', function () {
  const form = document.getElementById('generate-letter-form');
  const outputSection = document.getElementById('letter-output');
  const letterDiv = document.getElementById('generated-letter');
  const downloadWordBtn = document.getElementById('download-word');
  const downloadPdfBtn = document.getElementById('download-pdf');

  // Generate Letter
  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const accountNumber = document.getElementById('account-number').value.trim();
    const contractNumber = document.getElementById('contract-number').value.trim();
    const contractEndDate = document.getElementById('contract-end-date').value;
    const terminationReason = document.getElementById('termination-reason').value;
    const yourName = document.getElementById('your-name').value.trim();
    const yourPosition = document.getElementById('your-position').value.trim();
    const yourContact = document.getElementById('your-contact').value.trim();

    let noticeText = terminationReason === 'end-of-term'
      ? `We are providing this notice for end of term termination, in accordance with Section 10. The effective termination date will be ${contractEndDate}.`
      : `We are providing this notice due to material breach of contract, in accordance with Section 10. The effective termination date will be ${contractEndDate}.`;

    const letter = `
      <strong>Subject:</strong> Notice of Termination ‚Äì SDI Service Agreement ${accountNumber} / ${contractNumber}<br><br>
      To: Evoqua Water Technologies Ltd.<br><br>
      Dear Evoqua Team,<br><br>
      ${noticeText}<br><br>
      We acknowledge our obligation to:<br>
      - Continue payment of the monthly rental service charge for the remainder of the term, if applicable.<br>
      - Promptly make all Evoqua-owned equipment available for removal upon expiration or termination.<br>
      - Settle all outstanding invoices and charges.<br><br>
      Please confirm receipt of this notice and provide instructions for equipment return and final settlement.<br><br>
      Thank you for your cooperation.<br><br>
      Sincerely,<br>
      ${yourName}<br>
      ${yourPosition}<br>
      ${yourContact}
    `;

    letterDiv.innerHTML = letter;
    outputSection.classList.remove('hidden');
    outputSection.scrollIntoView({ behavior: 'smooth' });
  });

  // ‚úÖ Download as Word (with proper HTML structure and UTF-8 encoding)
  downloadWordBtn.addEventListener('click', function () {
    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Cancellation Letter</title>
      </head>
      <body>
        ${letterDiv.innerHTML}
      </body>
      </html>
    `;
    const blob = new Blob([htmlContent], { type: 'application/msword;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Cancellation_Letter.doc';
    link.click();
  });

  // ‚úÖ Download as PDF using jsPDF
  downloadPdfBtn.addEventListener('click', function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.html(letterDiv, {
      callback: function (doc) {
        doc.save('Cancellation_Letter.pdf');
      },
      x: 10,
      y: 10
    });
  });
});

</script>
</body>
</html>


--- End of sdi_cancel.php ---



--- Start of search.php ---

<?php
/**
 * Global Search API
 * Returns JSON results for contacts, customers, opportunities, etc.
 */

require_once __DIR__ . '/simple_auth/middleware.php';
require_once __DIR__ . '/csv_handler.php';
require_once __DIR__ . '/sanitize_helper.php';

// Only allow authenticated users
if (empty($_SESSION['user_id'])) {
    header('HTTP/1.1 401 Unauthorized');
    echo json_encode(['error' => 'Authentication required']);
    exit;
}

header('Content-Type: application/json');

$query = strtolower(trim($_GET['q'] ?? ''));

if (strlen($query) < 2) {
    echo json_encode([]);
    exit;
}

$results = [];
$maxResultsPerType = 5;

// Search Contacts
try {
    $contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
    $contactsForSearch = is_array($contacts) ? $contacts : [];
    if (!empty($contactsForSearch)) {
        foreach ($contacts as $contact) {
            if (count(array_filter($results, fn($r) => $r['type'] === 'Contacts')) >= $maxResultsPerType) {
                break;
            }
            
            $haystack = strtolower(implode(' ', [
                $contact['first_name'] ?? '',
                $contact['last_name'] ?? '',
                $contact['company'] ?? '',
                $contact['email'] ?? '',
                $contact['phone'] ?? ''
            ]));
            
            if (strpos($haystack, $query) !== false) {
                $name = trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? ''));
                $results[] = [
                    'type' => 'Contacts',
                    'title' => $name ?: 'Unnamed Contact',
                    'subtitle' => ($contact['company'] ?? '') . ' ‚Ä¢ ' . ($contact['email'] ?? ''),
                    'url' => 'contact_view.php?id=' . urlencode($contact['id'] ?? '')
                ];
            }
        }
    }
} catch (Exception $e) {
    // Silently skip if contacts.csv can't be read
    $contactsForSearch = [];
}

// Search Customers (from contacts marked as customers)
if (!empty($contactsForSearch)) {
    foreach ($contactsForSearch as $contact) {
        if (count(array_filter($results, fn($r) => $r['type'] === 'Customers')) >= $maxResultsPerType) {
            break;
        }
        
        $isCustomer = strtolower(trim($contact['is_customer'] ?? ''));
        if (!in_array($isCustomer, ['yes', 'true', '1'], true)) {
            continue;
        }
        
        $haystack = strtolower(implode(' ', [
            $contact['company'] ?? '',
            $contact['first_name'] ?? '',
            $contact['last_name'] ?? '',
            $contact['email'] ?? ''
        ]));
        
        if (strpos($haystack, $query) !== false) {
            $name = trim(($contact['first_name'] ?? '') . ' ' . ($contact['last_name'] ?? ''));
            $results[] = [
                'type' => 'Customers',
                'title' => ($contact['company'] ?? '') ?: ($name ?: 'Unnamed Customer'),
                'subtitle' => $name,
                'url' => 'customer_view.php?id=' . urlencode($contact['id'] ?? '')
            ];
        }
    }
}

// Search Opportunities
try {
    $opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
    if (is_array($opportunities)) {
        foreach ($opportunities as $opp) {
            if (count(array_filter($results, fn($r) => $r['type'] === 'Opportunities')) >= $maxResultsPerType) {
                break;
            }
            
            $haystack = strtolower(implode(' ', [
                $opp['company'] ?? '',
                $opp['stage'] ?? '',
                $opp['description'] ?? ''
            ]));
            
            if (strpos($haystack, $query) !== false) {
                $value = isset($opp['value']) ? '$' . number_format($opp['value'], 0) : '';
                $results[] = [
                    'type' => 'Opportunities',
                    'title' => ($opp['company'] ?? 'Unnamed Opportunity') . ' - ' . ($opp['stage'] ?? ''),
                    'subtitle' => $value . ' ‚Ä¢ ' . ($opp['description'] ?? ''),
                    'url' => 'opportunities_list.php?id=' . urlencode($opp['id'] ?? '')
                ];
            }
        }
    }
} catch (Exception $e) {
    // Silently skip if opportunities.csv can't be read
}

// Search Purchase Orders (if admin)
if (isAdmin()) {
    try {
        $purchase_orders = readCSV('purchase_orders.csv', require __DIR__ . '/purchase_order_schema.php');
        if (is_array($purchase_orders)) {
            foreach ($purchase_orders as $po) {
                if (count(array_filter($results, fn($r) => $r['type'] === 'Purchase Orders')) >= $maxResultsPerType) {
                    break;
                }
                
                $haystack = strtolower(implode(' ', [
                    $po['po_number'] ?? '',
                    $po['supplier'] ?? '',
                    $po['status'] ?? ''
                ]));
                
                if (strpos($haystack, $query) !== false) {
                    $results[] = [
                        'type' => 'Purchase Orders',
                        'title' => 'PO #' . ($po['po_number'] ?? ''),
                        'subtitle' => ($po['supplier'] ?? '') . ' ‚Ä¢ ' . ($po['status'] ?? ''),
                        'url' => 'purchase_order_summary.php?po=' . urlencode($po['po_number'] ?? '')
                    ];
                }
            }
        }
    } catch (Exception $e) {
        // Silently skip
    }
}

// Return results
echo json_encode(array_values($results));


--- End of search.php ---



--- Start of submit-contact.php ---

<?php

require_once 'contact_validator.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'PHPMailer.php';
require 'SMTP.php';
require 'Exception.php';

$schema = require __DIR__ . '/contact_schema.php';
$mail = new PHPMailer(true);

try {
    // Collect and sanitize form data
    $data = [];
    foreach ($schema as $field) {
        if ($field === 'id') continue;
        $value = htmlspecialchars(trim($_POST[$field] ?? ''));
        $data[$field] = $value;
    }

    // Validate required fields
    if (empty($data['first_name']) || empty($data['email']) || empty($data['message'])) {
        throw new Exception("Please fill in all required fields.");
    }

    // Save to CSV
    $csvRow = array_values($data);
    $csvRow[] = date('Y-m-d H:i:s');
    $file = fopen('contacts.csv', 'a');
    if ($file) {
        fputcsv($file, $csvRow);
        fclose($file);
    } else {
        throw new Exception("Unable to write to contacts.csv");
    }

    // GoDaddy relay SMTP settings
    $mail->SMTPDebug = 0;
    $mail->isSMTP();
    $mail->Host = 'relay-hosting.secureserver.net';
    $mail->SMTPAuth = false;
    $mail->SMTPSecure = '';
    $mail->Port = 25;

    // Email headers
    $mail->setFrom('rlee@eclipsewatertechnologies.com', 'Eclipse Contact Form');
    $mail->addAddress('rlee@eclipsewatertechnologies.com');
    $mail->addReplyTo($data['email'], $data['first_name']);

    // Email content
    $mail->Subject = 'New Contact Form Submission';
    $mail->Body = "Name: {$data['first_name']}\nEmail: {$data['email']}\nCompany: {$data['company']}\nMessage:\n{$data['message']}";

    $mail->send();

    // Redirect with success status
    header('Location: contact_form.php?status=success');
    exit;

} catch (Exception $e) {
    error_log("Contact form error: " . $e->getMessage());
    header('Location: contact_form.php?status=error');
    exit;
}


--- End of submit-contact.php ---



--- Start of tag_schema.php ---

<?phpreturn [
    'VIP' => 'VIP Client',
    'Lead' => 'Sales Lead',
    'Newsletter' => 'Newsletter Subscriber',
    'Inactive' => 'Inactive Contact',
    'Partner' => 'Business Partner',
    'Support' => 'Support Request',
    'Demo' => 'Requested Demo',
];
>

--- End of tag_schema.php ---



--- Start of test.php ---

<?php echo "PHP is working!"; ?>

--- End of test.php ---



--- Start of test_forecast.php ---

<?php
require 'forecast_calc.php';

$forecast = calculateForecasts();
echo "<pre>";
print_r($forecast);
echo "</pre>";
?>


--- End of test_forecast.php ---



--- Start of test_get.php ---

<?php
// ULTRA SIMPLE GET TEST - NO DEPENDENCIES
?>
<!DOCTYPE html>
<html>
<head>
    <title>GET Parameter Test</title>
</head>
<body style="font-family: Arial; padding: 40px; background: #f0f0f0;">
    <h1 style="color: #ff6b6b;">üî¨ GET Parameter Test</h1>
    
    <div style="background: white; padding: 30px; border-radius: 8px; margin: 20px 0;">
        <h2>Test Form</h2>
        <form method="GET" action="test_get.php">
            <input type="text" name="testquery" placeholder="Type anything..." style="padding: 10px; font-size: 16px; width: 300px;">
            <button type="submit" style="padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; cursor: pointer;">Submit Test</button>
        </form>
    </div>
    
    <div style="background: #333; color: #0f0; padding: 30px; border-radius: 8px; font-family: monospace; margin: 20px 0;">
        <h2 style="color: #0f0;">RAW $_GET Array:</h2>
        <pre style="color: #0f0;"><?php print_r($_GET); ?></pre>
        
        <h2 style="color: #0f0; margin-top: 30px;">Individual Values:</h2>
        <?php if (!empty($_GET)): ?>
            <?php foreach ($_GET as $key => $value): ?>
                <div style="background: rgba(0,255,0,0.1); padding: 10px; margin: 5px 0; border-left: 3px solid #0f0;">
                    <strong>[<?= htmlspecialchars($key) ?>]</strong> = "<?= htmlspecialchars($value) ?>"
                </div>
            <?php endforeach; ?>
        <?php else: ?>
            <div style="background: rgba(255,0,0,0.3); padding: 15px; border-left: 3px solid red; color: #ff6b6b;">
                ‚ùå NO GET PARAMETERS RECEIVED
            </div>
        <?php endif; ?>
        
        <h2 style="color: #0f0; margin-top: 30px;">Current URL:</h2>
        <div style="background: rgba(0,255,0,0.1); padding: 10px; word-break: break-all;">
            <?= htmlspecialchars($_SERVER['REQUEST_URI'] ?? 'N/A') ?>
        </div>
        
        <h2 style="color: #0f0; margin-top: 30px;">Query String:</h2>
        <div style="background: rgba(0,255,0,0.1); padding: 10px; word-break: break-all;">
            <?= htmlspecialchars($_SERVER['QUERY_STRING'] ?? 'EMPTY') ?>
        </div>
    </div>
    
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 5px solid #ffc107;">
        <h3>Instructions:</h3>
        <ol>
            <li>Type something in the input box above</li>
            <li>Click "Submit Test"</li>
            <li>Check if the green box shows your input</li>
            <li>If it DOES work here but NOT on contacts_list.php, we have a specific file issue</li>
            <li>If it DOESN'T work here either, we have a server/PHP configuration issue</li>
        </ol>
    </div>
</body>
</html>


--- End of test_get.php ---



--- Start of update_contact.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); ?>
<?php

require_once 'contact_validator.php';require_once 'csv_handler.php';

$schema = getContactSchema();
$contacts = readCSV('contacts.csv');
$updatedId = $_POST['id'] ?? null;

if (!$updatedId) {
    echo "Missing contact ID.";
    exit;
}

// Build updated contact
$updatedContact = [];
foreach ($schema as $col) {
    $updatedContact[$col] = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST[$col] ?? '';
}

// Replace contact in list
$updatedList = array_map(function($c) use ($updatedId, $updatedContact) {
    return $c['id'] === $updatedId ? $updatedContact : $c;
}, $contacts);

// Write back to CSV
writeCSV('contacts.csv', $updatedList);

// Redirect to viewer
header("Location: contact_view.php?id=$updatedId");
exit;
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of update_contact.php ---



--- Start of validation.php ---

<?php
function isValidEmail($email) {
    return empty($email) || filter_var($email, FILTER_VALIDATE_EMAIL);
}

function isValidPhone($phone) {
    return empty($phone) || preg_match('/^\+?[0-9\s\-]{7,15}$/', $phone);
}

function validateContact($row) {
    $errors = [];

    // Company is required
    if (empty(trim($row['company']))) {
        $errors['company'] = 'Company name is required.';
    }

    // Email format check (only if provided)
    if (!isValidEmail($row['email'])) {
        $errors['email'] = 'Invalid email format.';
    }

    // Phone format check (only if provided)
    if (!isValidPhone($row['phone'])) {
        $errors['phone'] = 'Invalid phone number.';
    }

    return $errors;
}

--- End of validation.php ---



--- Start of auth.php ---


<?php
require_once __DIR__ . '/../simple_auth/middleware.php';
$current_user = auth_current_user();
if (!$current_user || ($current_user['role'] ?? '') !== 'admin') {
    header('Location: ../simple_auth/login.php?error=access_denied');
    exit;
}
$user_name = $current_user['username'] ?? 'Admin';
?>


--- End of auth.php ---



--- Start of index.php ---

<?php include_once 'auth.php'; ?>
<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Portal</title>
  <style>
    /* Removed global body style to prevent CSS conflicts. Use styles.css for global theming. */
    .admin-portal-header { display: flex; align-items: center; justify-content: space-between; background: #0099A8; padding: 24px 40px; border-radius: 0 0 18px 18px; box-shadow: 0 2px 12px #0002; }
    .admin-portal-header .logo { font-size: 2rem; font-weight: bold; color: #fff; letter-spacing: 2px; display: flex; align-items: center; gap: 12px; }
    .admin-portal-header .user-info { color: #ffe082; font-size: 1.1rem; font-weight: 500; }
    /* Use global .container and .form-grid from styles.css for layout */
    .status-cards { display: flex; gap: 18px; flex-wrap: wrap; }
    .status-card { background: #23272a; border-radius: 10px; padding: 28px 32px; min-width: 200px; flex: 1; box-shadow: 0 2px 8px #0002; text-align: left; }
    .status-card h4 { color: #0099A8; margin: 0 0 8px 0; font-size: 1.1rem; }
    .status-card .value { font-size: 2rem; font-weight: bold; color: #ffe082; }
    .quick-links { display: flex; flex-direction: column; gap: 18px; }
    .quick-link { display: flex; align-items: center; gap: 14px; background: #0099A8; color: #fff; text-decoration: none; font-weight: 600; font-size: 1.1rem; border-radius: 8px; padding: 18px 24px; transition: background 0.2s; box-shadow: 0 2px 8px #0001; }
    .quick-link:hover { background: #007880; }
    .quick-link span { font-size: 1.6rem; }
    .section { background: #23272a; border-radius: 10px; padding: 28px 32px; margin-bottom: 32px; box-shadow: 0 2px 8px #0002; }
    .section h3 { color: #0099A8; margin-top: 0; }
    .recent-activity-list { list-style: none; padding: 0; margin: 0; }
    .recent-activity-list li { margin-bottom: 10px; color: #b0b0b0; font-size: 1rem; }
    .help-section { color: #b0b0b0; font-size: 1rem; }
    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } .status-cards { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="admin-portal-header">
    <div class="logo">&#x1F6E1; Eclipse Admin Portal</div>
    <div class="user-info">Logged in as: <strong><?= htmlspecialchars($user_name) ?></strong> (Admin)</div>
  </div>
  <div class="admin-portal-main">
    <div class="dashboard-grid">
      <div>
        <div class="status-cards">
          <div class="status-card">
            <h4>Backups</h4>
            <div class="value">&#x2714;</div>
            <div>Last backup: <span id="last-backup">Today</span></div>
          </div>
          <div class="status-card">
            <h4>Users</h4>
            <div class="value">&#x1F465;</div>
            <div>Active: <span id="active-users">3</span></div>
          </div>
          <div class="status-card">
            <h4>System Health</h4>
            <div class="value">&#x2705;</div>
            <div>All systems normal</div>
          </div>
        </div>
      </div>
      <div>
        <div class="quick-links">
          <a href="../admin_dashboard.php" class="quick-link"><span>&#x1F4CA;</span>CRM Admin Dashboard</a>
          <a href="../admin_users.php" class="quick-link"><span>&#x1F465;</span>User Management</a>
          <a href="../admin_backups.php" class="quick-link"><span>&#x1F501;</span>Manage Backups</a>
          <a href="../admin_reports.php" class="quick-link"><span>&#x1F4C8;</span>Reports</a>
          <a href="../admin_maintenance.php" class="quick-link"><span>&#x1F6E0;</span>Maintenance</a>
          <a href="../dashboard.php" class="quick-link"><span>&#x2190;</span>Back to CRM</a>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>Recent Admin Activity</h3>
      <ul class="recent-activity-list">
        <li>&#x2714; Backup completed at 10:15 AM</li>
        <li>&#x1F465; User "jane" added</li>
        <li>&#x1F6E0; Maintenance check passed</li>
        <li>&#x1F4C8; Report generated: Sales Q1</li>
        <li>&#x1F501; Backup scheduled for 2:00 AM</li>
      </ul>
    </div>
    <div class="section help-section">
      <h3>Need Help?</h3>
      <p>Contact <a href="mailto:support@eclipsecrm.com" style="color:#ffe082;">support@eclipsecrm.com</a> or visit the <a href="#" style="color:#ffe082;">Admin Documentation</a> for guidance on using admin tools.</p>
    </div>
  </div>
</body>
</html>


--- End of index.php ---



--- Start of add_contact.php ---

<?php
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$filename = 'contacts.csv';
$logFile = 'error_log.txt';
$schema = require __DIR__ . '/contact_schema.php';

$timestamp = date('Y-m-d H:i:s');
$newContact = [
    'id' => uniqid(),
    'first_name' => $_POST['first_name'] ?? '',
    'last_name' => $_POST['last_name'] ?? '',
    'company' => $_POST['company'] ?? '',
    'address_1' => $_POST['address_1'] ?? '',
    'address_2' => $_POST['address_2'] ?? '',
    'city' => $_POST['city'] ?? '',
    'postal_code' => $_POST['postal_code'] ?? '',
    'province' => $_POST['province'] ?? '',
    'country' => $_POST['country'] ?? '',
    'phone' => $_POST['phone'] ?? '',
    'email' => $_POST['email'] ?? '',
    'created_at' => $timestamp,
    'source' => 'manual_entry'
];

// Validate contact
$errors = validateContact($newContact);
if (!empty($errors)) {
    echo "<p style='color:red;'>Invalid contact data:</p>";
    foreach ($errors as $field => $msg) {
        echo "<p>Error in $field: $msg</p>";
    }

    // Log errors
    $errorMessage = "[$timestamp] Contact validation failed for email: {$newContact['email']}\n";
    $errorMessage .= print_r($errors, true) . "\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    echo "<p><a href='contact_view.php'>Go back</a></p>";
    exit;
}

// Load existing contacts
$contacts = readCSV($filename, $schema);

// Check for duplicates
foreach ($contacts as $contact) {
    if ($contact['email'] === $newContact['email']) {
        echo "<p style='color:red;'>Duplicate email detected. Contact not saved.</p>";
        $duplicateMessage = "[$timestamp] Duplicate email detected: {$newContact['email']}\n";
        file_put_contents($logFile, $duplicateMessage, FILE_APPEND);
        echo "<p><a href='contact_view.php'>Go back</a></p>";
        exit;
    }
}

// Save contact
$contacts[] = $newContact;
writeCSV($filename, $contacts, $schema);

// Log success
$successMessage = "[$timestamp] Contact saved: {$newContact['email']}\n";
file_put_contents($logFile, $successMessage, FILE_APPEND);

// Redirect to confirmation
header('Location: contact_success.php');
exit;
?>


--- End of add_contact.php ---



--- Start of add_customer.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/customer_schema.php';
$itemFields = require __DIR__ . '/customer_item_config.php';
$customerFile = 'customers.csv';
$itemFile = 'customer_items.csv';
$errors = [];
$success = false;
$newCustomer = [];

// Load existing customers
$rows = readCSV($customerFile, $schema);
$lastId = 0;
foreach ($rows as $r) {
    $id = intval($r['customer_id']);
    if ($id > $lastId) $lastId = $id;
}
$nextId = str_pad($lastId + 1, 5, '0', STR_PAD_LEFT);

// Handle POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    foreach ($schema as $field) {
        $newCustomer[$field] = ($field === 'customer_id') ? $nextId : trim($_POST[$field] ?? '');
    }

    // Validate main fields
    if ($newCustomer['contact_name'] === '') $errors[] = 'Contact name is required.';
    if ($newCustomer['address'] === '') $errors[] = 'Address is required.';

    // Parse line items
    $items = [];
    if (isset($_POST['items']) && is_array($_POST['items'])) {
        foreach ($_POST['items'] as $item) {
            $clean = ['customer_id' => $nextId];
            foreach ($itemFields as $f) {
                $clean[$f] = trim($item[$f] ?? '');
            }
            $items[] = $clean;
        }
    }

    if (empty($errors)) {
        $rows[] = $newCustomer;
        writeCSV($customerFile, $rows, $schema);

        $existingItems = readCSV($itemFile, array_merge(['customer_id'], $itemFields));
        $existingItems = is_array($existingItems) ? $existingItems : [];
        $allItems = array_merge($existingItems, $items);
        writeCSV($itemFile, $allItems, array_merge(['customer_id'], $itemFields));

        $success = true;
    }
}
?>

<div class="container">
  <h2>Add New Customer</h2>

  <?php if ($success): ?>
    <p style="color:green;">‚úÖ Customer added successfully. ID: <?= $nextId ?></p>
  <?php endif; ?>

  <?php if (!empty($errors)): ?>
    <ul style="color:red;">
      <?php foreach ($errors as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
    </ul>
  <?php endif; ?>

  <form method="POST">
    <fieldset style="margin-bottom:20px;">
      <legend><strong>Main Customer Info</strong></legend>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
        <div>
          <label><strong>Customer ID:</strong></label><br>
          <input type="text" value="<?= $nextId ?>" readonly>
        </div>
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'customer_id') continue; ?>
          <div>
            <label for="<?= $field ?>"><strong><?= ucfirst(str_replace('_', ' ', $field)) ?>:</strong></label><br>
            <input type="text" name="<?= $field ?>" id="<?= $field ?>" value="<?= htmlspecialchars($_POST[$field] ?? '') ?>">
          </div>
        <?php endforeach; ?>
      </div>
    </fieldset>

    <fieldset>
      <legend><strong>Tank & Delivery Line Items</strong></legend>
      <div id="lineItems"></div>
      <button type="button" onclick="addLineItem()" class="btn-outline">‚ûï Add Line Item</button>
    </fieldset>

    <div style="margin-top:20px;">
      <button type="submit" class="btn-outline">üíæ Save Customer</button>
    </div>
  </form>
</div>

<script>
function addLineItem() {
  const container = document.getElementById('lineItems');
  const index = container.children.length;
  const fields = <?= json_encode($itemFields) ?>;
  const row = document.createElement('div');
  row.style.marginBottom = '12px';
  row.style.border = '1px solid #ccc';
  row.style.padding = '10px';
  row.style.borderRadius = '6px';
  row.style.background = '#f9f9f9';

  let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">';
  fields.forEach(f => {
    html += `
      <div>
        <label><strong>${f.replace(/_/g, ' ')}:</strong></label><br>
        <input type="text" name="items[${index}][${f}]" />
      </div>
    `;
  });
  html += '</div>';
  row.innerHTML = html;
  container.appendChild(row);
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_customer.php ---



--- Start of add_discussion.php ---

<?php
require_once 'contact_validator.php';
require_once 'discussion_logger.php'; // contains logDiscussionEntry()

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate input
    $errors = validateContact($_POST);
    if (!empty($errors)) {
        foreach ($errors as $field => $msg) {
            echo "<p>Error in $field: $msg</p>";
        }
        echo "<p><a href='contact_view.php'>Go back</a></p>";
        exit;
    }

    // Log the discussion entry
    if (logDiscussionEntry($_POST)) {
        header('Location: contact_view.php');
        exit;
    } else {
        echo "<p style='color:red;'>Failed to log discussion entry. Please check the error log.</p>";
        echo "<p><a href='contact_view.php'>Go back</a></p>";
    }
}
?>



--- End of add_discussion.php ---



--- Start of add_opportunity.php ---

<?php

require_once __DIR__ . '/csv_handler.php';
if (!function_exists('readCSV')) {
    error_log("readCSV not loaded ‚Äî check csv_handler.php include path");
    die("CSV handler not loaded.");
}

require_once 'contact_validator.php';

$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', $schema);

// Build contact ID lookup
$validContactIDs = array_column($contacts, 'id');

// Build new opportunity from POST data
$newOpportunity = [];
foreach ($schema as $field) {
    if ($field === 'id') {
        $newOpportunity['id'] = uniqid();
    } else {
        $newOpportunity[$field] = trim($_POST[$field] ?? '');
    }
}

// Defensive logging for missing or invalid fields
if (!in_array($newOpportunity['contact_id'], $validContactIDs)) {
    error_log("Invalid contact_id submitted: " . $newOpportunity['contact_id']);
}
if (!is_numeric($newOpportunity['value'])) {
    error_log("Invalid value submitted: " . $newOpportunity['value']);
}
if (!is_numeric($newOpportunity['probability'])) {
    error_log("Invalid probability submitted: " . $newOpportunity['probability']);
}
if (empty($newOpportunity['stage'])) {
    error_log("Missing stage in opportunity submission");
}

// Validate required fields
$validOpportunity =
    in_array($newOpportunity['contact_id'], $validContactIDs) &&
    is_numeric($newOpportunity['value']) &&
    is_numeric($newOpportunity['probability']) &&
    !empty($newOpportunity['stage']);

if ($validOpportunity) {
    $opportunities[] = $newOpportunity;
    writeCSV('opportunities.csv', $opportunities, $schema);
    header('Location: opportunity_form.php?status=success');
    exit;
} else {
    error_log("Rejected opportunity: " . json_encode($newOpportunity));
    header('Location: opportunity_form.php?status=error');
    exit;
}



--- End of add_opportunity.php ---



--- Start of add_task.php ---

<?php
require_once 'csv_handler.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title = trim($_POST['title']);
    $due_date = $_POST['due_date'];
    $status = $_POST['status'];
    $errors = [];

    if ($title === '') $errors[] = 'Task title is required.';
    if ($due_date === '') $errors[] = 'Due date is required.';
    elseif (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $due_date)) $errors[] = 'Invalid date format.';
    if ($status !== 'pending' && $status !== 'completed') $errors[] = 'Invalid status selected.';

    if (!empty($errors)) {
        echo "<div style='color:red;'><strong>Error:</strong><ul>";
        foreach ($errors as $error) echo "<li>" . htmlspecialchars($error) . "</li>";
        echo "</ul></div><a href='index.php'>Go back</a>";
        exit;
    }

    $filename = 'tasks.csv';
    $newTask = [$title, $due_date, $status, date('Y-m-d H:i:s')];
    appendCSV($filename, $newTask);
    header('Location: index.php');
    exit;
}
?>


--- End of add_task.php ---



--- Start of add_tasks.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$title = $_POST['title'] ?? '';
if (trim($title) === '') {
    echo 'error: empty title';
    exit;
}

$filename = 'tasks.csv';
$headers = ['id','title','status','priority','assigned_to','due_date','timestamp'];

if (!file_exists($filename)) {
    $fp = fopen($filename, 'w');
    if ($fp === false) {
        echo 'error: cannot create file';
        exit;
    }
    fputcsv($fp, $headers);
    fclose($fp);
}

$id = uniqid('task_', true);
$status = 'incomplete';
$priority = '';
$assigned_to = '';
$due_date = '';
$timestamp = date('Y-m-d H:i:s');

$fp = fopen($filename, 'a');
if ($fp !== false) {
    fputcsv($fp, [$id, $title, $status, $priority, $assigned_to, $due_date, $timestamp]);
    fclose($fp);
    echo 'success';
} else {
    echo 'error: cannot open file for appending';
}
?>

--- End of add_tasks.php ---



--- Start of archive_task.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$idToArchive = $_POST['id'] ?? '';
if (!$idToArchive) {
    echo 'error';
    exit;
}

$filename = 'tasks.csv';
$rows = [];
$found = false;

if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle); // Read and store header
    $rows[] = $headers;

    while (($data = fgetcsv($handle)) !== false) {
        if ($data[0] === $idToArchive) {
            $data[2] = 'archived'; // Update status
            $found = true;
        }
        $rows[] = $data;
    }
    fclose($handle);
}

// Rewrite the CSV only if the task was found
if ($found && ($handle = fopen($filename, 'w')) !== false) {
    foreach ($rows as $row) {
        fputcsv($handle, $row);
    }
    fclose($handle);
    echo 'success';
} else {
    echo 'error';
}
?>


--- End of archive_task.php ---



--- Start of bulk_action.php ---

<?php
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
$schema = file_exists($schemaFile) ? require $schemaFile : [];
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

$selectedIds = $_POST['selected_ids'] ?? [];
$action = $_POST['action'] ?? '';
$tagToAssign = $_POST['assign_tag'] ?? '';
$statusToAssign = $_POST['assign_status'] ?? '';

if (!is_array($selectedIds) || empty($action)) {
    die('Error: No contacts selected or no action specified.');
}

$updatedContacts = [];
$exportRows = [];

foreach ($contacts as $contact) {
    $id = $contact['id'] ?? '';
    $isSelected = in_array($id, $selectedIds);

    if ($action === 'delete' && $isSelected) {
        continue; // Skip this contact (delete)
    }

    if ($action === 'export' && $isSelected) {
        $row = [];
        foreach ($schema as $field) {
            $row[] = $contact[$field] ?? '';
        }
        $exportRows[] = $row;
    }

    if ($action === 'assign_tag' && $isSelected && $tagToAssign !== '') {
        $existingTags = array_map('trim', explode(',', $contact['tags'] ?? ''));
        if (!in_array($tagToAssign, $existingTags)) {
            $existingTags[] = $tagToAssign;
        }
        $contact['tags'] = implode(', ', $existingTags);
    }

    if ($action === 'assign_status' && $isSelected && $statusToAssign !== '') {
        $contact['status'] = $statusToAssign;
    }

    $updatedContacts[] = $contact;
}

if ($action === 'export') {
    $filename = 'contacts_bulk_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($exportRows as $row) {
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
} else {
    writeCSV('contacts.csv', $updatedContacts, $schema);
    header('Location: contacts_list.php');
    exit;
}
?>

--- End of bulk_action.php ---



--- Start of calendar.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

// Load tasks from handler
require_once 'layout_start.php';
require_once 'csv_handler.php'; // or whatever file defines readCSV()

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp']; // adjust based on your actual CSV columns
$tasks = readCSV($filename, $schema);

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        $tasksByDate[$task['due_date']][] = $task;
    }
}

?>


<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }

  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }

  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }

  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>
<h2>Task Calendar</h2>
<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
  <?php
  $year = date('Y');
  $month = date('m');
  $daysInMonth = date('t');
  $firstDayOfMonth = date('w', strtotime("$year-$month-01"));

  $day = 1;
  $week = [];

  for ($i = 0; $i < $firstDayOfMonth; $i++) {
      $week[] = "<td></td>";
  }

  while ($day <= $daysInMonth) {
      $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
      if (isset($tasksByDate[$dateStr])) {
          $taskTitles = '';
          foreach ($tasksByDate[$dateStr] as $task) {
              $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
          }
          $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
      } else {
          $week[] = "<td>$day</td>";
      }

      if (count($week) == 7) {
          echo "<tr>" . implode('', $week) . "</tr>";
          $week = [];
      }

      $day++;
  }

  if (!empty($week)) {
      while (count($week) < 7) {
          $week[] = "<td></td>";
      }
      echo "<tr>" . implode('', $week) . "</tr>";
  }
  ?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}
</script>

<?php include 'layout_end.php'; ?>


--- End of calendar.php ---



--- Start of commit_import.php ---

<?php
session_start();
require_once 'csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$logFile = 'error_log.txt';
$targetFile = 'contacts.csv';

// Validate session data
$contacts = $_SESSION['import_preview'] ?? [];

if (!is_array($contacts) || empty($contacts)) {
    echo "<p style='color:red;'>No import data received or session expired.</p>";
    exit;
}

// Re-validate schema alignment
$validContacts = array_filter($contacts, function($row) use ($schema) {
    foreach ($schema as $col) {
        if (!array_key_exists($col, $row)) return false;
    }
    return true;
});

// Append to contacts.csv
$success = writeCSV($targetFile, $validContacts, $schema);

if ($success) {
    echo "<p style='color:green;'>Import complete. " . count($validContacts) . " contacts added.</p>";
    echo "<p><a href='contacts_list.php' class='btn'>‚Üê Back to Contacts</a></p>";
    unset($_SESSION['import_preview']); // Clear session after successful import
} else {
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write imported contacts.\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);
    echo "<p style='color:red;'>Import failed. See error log.</p>";
}
?>


--- End of commit_import.php ---



--- Start of contacts_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

// Load schema safely
$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

// Handle query and sort
$query = strtolower(trim($_GET['query'] ?? ''));
$field = $_GET['field'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$activeSort = array_flip($sortFields);

// Display fields
$displayFields = $_GET['display'] ?? ['first_name', 'last_name', 'company', 'email'];
if (!is_array($displayFields)) {
    $displayFields = ['first_name', 'last_name', 'company', 'email'];
}

// Load contacts safely
$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Detect duplicates
$emailCount = [];
foreach ($contacts as $c) {
    $email = strtolower(trim($c['email']));
    $emailCount[$email] = ($emailCount[$email] ?? 0) + 1;
}

// Apply filter
if ($query !== '' && in_array($field, $schema)) {
    $contacts = array_filter($contacts, function($c) use ($field, $query) {
        return strpos(strtolower($c[$field] ?? ''), $query) !== false;
    });
}

// Apply multi-field sort
$validSortFields = array_filter($sortFields, function($f) use ($displayFields) {
    return in_array($f, $displayFields);
});

if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';

            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric
                ? ($valA <=> $valB)
                : strnatcasecmp($valA, $valB);

            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// Export logic
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename=\"$filename\"");

    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }

    fputcsv($output, $displayFields);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($displayFields as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }

    fclose($output);
    exit;
}
?>



<div class="page-contacts">
  <div class="container">
    <h2>All Contacts</h2>

    <form method="GET" class="contact-form">
      <div style="display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end;">
        <div>
          <label for="field">Filter by:</label><br>
          <select name="field" id="field">
            <?php foreach ($schema as $f): ?>
              <option value="<?= $f ?>" <?= $field === $f ? 'selected' : '' ?>>
                <?= ucfirst(str_replace('_', ' ', $f)) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>

        <div>
          <label for="query">Search:</label><br>
          <input type="text" name="query" id="query" value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
        </div>

        <div>
          <label for="fontSize">Font size:</label><br>
          <select id="fontSize">
            <option value="0.75rem">Small</option>
            <option value="0.85rem" selected>Medium</option>
            <option value="1rem">Large</option>
          </select>
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
          <button type="submit">Apply</button>
          <button type="submit" name="export" value="1">Export</button>
        </div>

        <div>
  <label for="sort">Sort by:</label><br>
  <select name="sort" id="sort">
    <option value="">-- None --</option>
    <?php foreach ($displayFields as $f): ?>
      <option value="<?= $f ?>" <?= in_array($f, $sortFields) ? 'selected' : '' ?>>
        <?= ucfirst(str_replace('_', ' ', $f)) ?>
      </option>
    <?php endforeach; ?>
  </select>
</div>


        <div>
          <label for="direction">Direction:</label><br>
          <select name="direction" id="direction">
            <option value="asc" <?= $sortDirection === 'asc' ? 'selected' : '' ?>>A‚ÄìZ / 0‚Äì9</option>
            <option value="desc" <?= $sortDirection === 'desc' ? 'selected' : '' ?>>Z‚ÄìA / 9‚Äì0</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button type="button" onclick="toggleFieldPanel()" style="font-size:0.85rem;">üõ† Show/Hide Field Selection</button>
        <div id="fieldPanel" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px; border-radius:6px; background:#f9f9f9;">
          <fieldset>
            <legend style="font-weight:bold;">Visible Fields:</legend>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
              <?php foreach ($schema as $f): ?>
                <label style="display:flex; align-items:center; gap:4px;">
                  <input type="checkbox" name="display[]" value="<?= $f ?>" <?= in_array($f, $displayFields) ? 'checked' : '' ?>>
                  <?= ucfirst(str_replace('_', ' ', $f)) ?>
                </label>
              <?php endforeach; ?>
            </div>
          </fieldset>
        </div>
      </div>
    </form>

    <table class="contact-table">
      <thead>
        <tr>
          <th>Actions</th>
          <?php foreach ($displayFields as $f): ?>
            <th>
              <?= ucfirst(str_replace('_', ' ', $f)) ?>
              <?php if (isset($activeSort[$f])): ?>
                <span style="<?= $activeSort[$f] === 0 ? 'font-weight:bold; color:#0099A8;' : '' ?>">
                  <?= $sortDirection === 'desc' ? '‚Üì' : '‚Üë' ?>
                </span>
              <?php endif; ?>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($contacts as $contact): ?>
          <?php
            $id = $contact['id'];
            $email = $contact['email'];
            $isDuplicate = $emailCount[strtolower(trim($email))] > 1;
          ?>
          <tr onclick="this.nextElementSibling.classList.toggle('expanded')">
            <td>
              <a href="contact_view.php?id=<?= $id ?>">üëÅ</a>
              <form method="POST" action="delete_contact.php" style="display:inline;" onsubmit="return confirm('Delete this contact?');">
                <input type="hidden" name="id" value="<?= $id ?>">
                <button type="submit" class="btn-outline">üóë</button>
              </form>
            </td>
            <?php foreach ($displayFields as $f): ?>
              <td>
                <?= htmlspecialchars($contact[$f] ?? '') ?>
                <?= ($f === 'email' && $isDuplicate) ? "<span style='color:red;'> [Duplicate]</span>" : '' ?>
              </td>
            <?php endforeach; ?>
          </tr>
          <tr class="details-row">
            <td colspan="<?= count($displayFields) + 1 ?>">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <?php foreach ($schema as $f): ?>
                  <div>
                    <strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong>
                    <?= htmlspecialchars($contact[$f] ?? '') ?>
                  </div>
                <?php endforeach; ?>
              </div>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
</div>

<script>
  function toggleFieldPanel() {
    const panel = document.getElementById('fieldPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }

  document.getElementById('fontSize').addEventListener('change', function () {
    document.documentElement.style.setProperty('--crm-font-size', this.value);
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contacts_list.php ---



--- Start of contact_form.php ---

<?php
$schema = require __DIR__ . '/contact_schema.php';
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Add New Contact</h2>

  <?php if (isset($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Contact saved successfully.</p>
  <?php endif; ?>

  <form id="contact-form" action="add_contact.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>
      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>
        <input type="<?= $field === 'email' ? 'email' : ($field === 'phone' ? 'tel' : 'text') ?>"
               name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Contact</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_form.php ---



--- Start of contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';
require_once 'tag_schema.php';

error_reporting(E_ALL);
ini_set('display_errors', 1);

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = array_keys(require 'tag_schema.php');
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
}
ksort($statusOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$selectedTags = $_GET['tags'] ?? [];
if (!is_array($selectedTags)) $selectedTags = [];
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $selectedTags) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $contactTags = array_map('trim', explode(',', $c['tags'] ?? ''));
    $matchTags = empty($selectedTags) || array_intersect($selectedTags, $contactTags);
    return $matchQuery && $matchStatus && $matchTags;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <fieldset>
      <legend>Tags:</legend>
      <?php foreach ($tagOptions as $tag): ?>
        <label>
          <input type="checkbox" name="tags[]" value="<?= htmlspecialchars($tag) ?>" <?= in_array($tag, $selectedTags) ? 'checked' : '' ?>>
          <?= htmlspecialchars($tag) ?>
        </label>
      <?php endforeach; ?>
    </fieldset>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <form method="post" action="bulk_action.php">
    <table class="table-grid">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <?php foreach ($schema as $field): ?>
            <th>
              <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
                <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
                <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
              </a>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($contacts as $c): ?>
          <tr>
            <td><input type="checkbox" name="selected_ids[]" value="<?= htmlspecialchars($c['id'] ?? '') ?>"></td>
            <?php foreach ($schema as $f): ?>
              <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
            <?php endforeach; ?>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>

    <div class="bulk-actions">
      <select name="action">
        <option value="">-- Bulk Action --</option>
        <option value="export">Export Selected</option>
        <option value="delete">Delete Selected</option>
        <option value="assign_tag">Assign Tag</option>
        <option value="assign_status">Assign Status</option>
      </select>
      <input type="text" name="value" placeholder="Tag or Status">
      <button type="submit">Apply</button>
    </div>
  </form>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.getElementById('select-all').addEventListener('change', function(e) {
  const checkboxes = document.querySelectorAll('input[name="selected_ids[]"]');
  checkboxes.forEach(cb => cb.checked = e.target.checked);
});
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_list.php ---



--- Start of contact_list1.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$searchFields = ['first_name', 'last_name', 'email', 'company'];
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter by search query
if ($query !== '') {
    $contacts = array_filter($contacts, function($c) use ($query, $searchFields) {
        foreach ($searchFields as $field) {
            if (isset($c[$field]) && stripos($c[$field], $query) !== false) {
                return true;
            }
        }
        return false;
    });
}

// Filter by status
if ($statusFilter !== '') {
    $contacts = array_filter($contacts, function($c) use ($statusFilter) {
        return isset($c['status']) && $c['status'] === $statusFilter;
    });
}

// Filter by tag
if ($tagFilter !== '') {
    $contacts = array_filter($contacts, function($c) use ($tagFilter) {
        return isset($c['tags']) && stripos($c['tags'], $tagFilter) !== false;
    });
}

// Sort contacts
$validSortFields = array_filter($sortFields, function($f) use ($schema) {
    return in_array($f, $schema);
});
if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';
            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename=\"$filename\"");
    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}

// Pagination
$total = count($contacts);
$totalPages = ceil($total / $perPage);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <option value="active" <?= $statusFilter === 'active' ? 'selected' : '' ?>>Active</option>
      <option value="inactive" <?= $statusFilter === 'inactive' ? 'selected' : '' ?>>Inactive</option>
    </select>
    <input type="text" name="tag" placeholder="Tag" value="<?= htmlspecialchars($tagFilter) ?>">
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table table-striped">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th><?= htmlspecialchars(ucfirst(str_replace('_', ' ', $field))) ?></th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= $totalPages; $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>"
         class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_list1.php ---



--- Start of contact_schema.php ---

<?php
return [
    'id',
    'first_name',
    'last_name',
    'company',
    'email',
    'phone',
    'address',
    'city',
    'province',
    'postal_code',
    'country',
    'notes',
    'created_at',
    'is_customer',
    'tank_number',
    'delivery_date'
];
?>

--- End of contact_schema.php ---



--- Start of contact_success.php ---

<?php
session_start();
$currentPage = basename(__FILE__); // Dynamically sets active tab
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Saved</title>
  <link rel="stylesheet" href="styles.css"> <!-- Optional external CSS -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .navbar { background: #333; padding: 10px 20px; }
    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; }
    .nav-list li { margin-right: 20px; }
    .nav-list a { color: #fff; text-decoration: none; }
    .nav-list .active a { font-weight: bold; text-decoration: underline; }
    .container { max-width: 600px; margin: 60px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
    .btn { display: inline-block; margin-top: 20px; padding: 10px 20px; background: #0077cc; color: #fff; text-decoration: none; border-radius: 4px; }
    .btn:hover { background: #005fa3; }
  </style>
</head>
<body>

<nav class="navbar">
  <ul class="nav-list">
    <li class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
      <a href="dashboard.php">Dashboard</a>
    </li>
    <li class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
      <a href="contact_form.php">Add Contact</a>
    </li>
    <li class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
      <a href="contacts_list.php">View Contacts</a>
    </li>
    <li class="<?= $currentPage === 'opportunity_form.php' ? 'active' : '' ?>">
      <a href="opportunity_form.php">Add Opportunity</a>
    </li>
    <li class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
      <a href="opportunities_list.php">View Opportunities</a>
    </li>
    <li class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
      <a href="import_contacts.php">Import Contacts</a>
    </li>
    <li class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
      <a href="export_contacts.php">Export Contacts</a>
    </li>
  </ul>
</nav>

<div class="container">
  <h2>‚úÖ Contact Saved Successfully</h2>
  <p>Your new contact has been added to the system and logged for audit.</p>
  <a href="dashboard.php" class="btn">Return to Dashboard</a>
</div>

</body>
</html>


--- End of contact_success.php ---



--- Start of contact_validator.php ---

<?php
require_once 'contact_schema.php';

function validateContact(array $contact): array {
    $schema = require __DIR__ . '/contact_schema.php';
    $requiredFields = ['last_name', 'company', 'address_1', 'city', 'postal_code', 'phone', 'email'];
    $errors = [];

    foreach ($schema as $field) {
        $value = trim($contact[$field] ?? '');

        // Required field check
        if (in_array($field, $requiredFields) && $value === '') {
            $errors[$field] = ucfirst(str_replace('_', ' ', $field)) . " is required.";
            continue;
        }

        // Field-specific validation
        switch ($field) {
            case 'email':
                if ($value && !filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[$field] = "Invalid email format.";
                }
                break;

            case 'phone':
                if ($value && !preg_match('/^\+?[0-9\s\-().]{7,}$/', $value)) {
                    $errors[$field] = "Invalid phone number.";
                }
                break;

            case 'website':
                if ($value && !filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[$field] = "Invalid website URL.";
                }
                break;

            // Add more field-specific rules here if needed
        }
    }

    return $errors;
}


--- End of contact_validator.php ---



--- Start of contact_view.php ---

<?php
session_start();

// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Include layout and dependencies (all files are in root)
include_once('layout_start.php');
include_once('navbar.php');
require_once 'csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require 'contact_schema.php';
$customerSchema = require 'customer_schema.php';
$contacts = readCSV('contacts.csv', $schema);
$customers = readCSV('customers.csv', $customerSchema);

// Index contacts by ID for faster lookup
$contactsById = [];
foreach ($contacts as $c) {
    if (empty($c['id'])) {
        $c['id'] = 'CNT_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
    }
    $contactsById[$c['id']] = $c;
}

// Helper: resolve customer by ID
function findCustomerById($customers, $cid) {
    foreach ($customers as $c) {
        if ($c['customer_id'] === $cid) return $c;
    }
    return null;
}

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Update contact details
    if (isset($_POST['id']) && isset($contactsById[$_POST['id']])) {
        $id = $_POST['id'];
        foreach ($schema as $f) {
            $contactsById[$id][$f] = htmlspecialchars(trim($_POST[$f] ?? $contactsById[$id][$f]));
        }
        if (isset($_POST['is_customer'])) {
            $contactsById[$id]['is_customer'] = $_POST['is_customer'];
        }
        writeCSV('contacts.csv', array_values($contactsById), $schema);
        header("Location: contact_view.php?id=" . urlencode($id));
        exit;
    }

    // Handle discussion entry
    if (isset($_POST['contact_id']) && isset($contactsById[$_POST['contact_id']])) {
        $data = [
            'contact_id' => $_POST['contact_id'],
            'author' => htmlspecialchars(trim($_POST['author'])),
            'timestamp' => date('Y-m-d H:i'),
            'entry_text' => htmlspecialchars(trim($_POST['entry_text'])),
            'linked_opportunity_id' => htmlspecialchars($_POST['linked_opportunity_id'] ?? ''),
            'visibility' => htmlspecialchars($_POST['visibility'] ?? 'public')
        ];
        $fp = fopen('discussion_log.csv', 'a');
        if ($fp) {
            fputcsv($fp, array_values($data));
            fclose($fp);
        }
        header("Location: contact_view.php?id=" . urlencode($data['contact_id']));
        exit;
    }
}

// Load contact
$id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING);
$contact = $contactsById[$id] ?? null;

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once('layout_end.php');
    exit;
}

// Resolve associated customer
$customer = findCustomerById($customers, $contact['customer_id'] ?? '');
?>

<div class="container">
  <h2>Contact Details</h2>

  <div class="contact-header" style="display: flex; align-items: center; justify-content: space-between;">
    <?php if ($customer): ?>
      <div class="customer-info">
        <strong>Company:</strong> <?= htmlspecialchars($customer['contact_name'] ?? '') ?><br>
        <strong>Address:</strong> <?= htmlspecialchars($customer['address'] ?? '') ?>
      </div>
    <?php else: ?>
      <div class="customer-info muted">
        <em>This contact is not assigned to a company.</em>
      </div>
    <?php endif; ?>

    <?php if (($contact['is_customer'] ?? '') !== 'yes'): ?>
      <form method="post" style="margin-left: 2em;">
        <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">
        <input type="hidden" name="is_customer" value="yes">
        <button type="submit" class="btn-outline">‚úÖ Mark as Client</button>
      </form>
    <?php else: ?>
      <p style="margin-left: 2em;"><strong>Status:</strong> This contact is already marked as a client.</p>
    <?php endif; ?>
  </div>

  <!-- Editable Contact Form -->
  <form method="post" class="contact-form">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <div class="form-group">
        <label for="customer_id"><strong>Company:</strong></label><br>
        <select name="customer_id" id="customer_id">
          <option value="">-- None --</option>
          <?php foreach ($customers as $cust): ?>
            <option value="<?= htmlspecialchars($cust['customer_id']) ?>"
              <?= ($contact['customer_id'] ?? '') === $cust['customer_id'] ? 'selected' : '' ?>>
              <?= htmlspecialchars($cust['contact_name']) ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Save Changes</button>
    </div>
  </form>

  <?php include_once('discussion_module.php'); ?>
  <?php include_once('follow_up_email.php'); ?>

  <div class="navigation">
    <a href="contacts_list.php" class="btn-outline">‚¨Ö Back to Contact List</a>
  </div>
</div>

<?php include_once('layout_end.php'); ?>


--- End of contact_view.php ---



--- Start of csv_export.php ---

function exportCSVFiltered($filename, $rows, $filters = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered));
}


--- End of csv_export.php ---



--- Start of csv_handler.php ---

<?php
function readCSV($filename, $schema) {
    $data = [];
    if (!file_exists($filename)) return $data;
    $file = fopen($filename, 'r');
    if ($file === false) throw new Exception("Unable to open file: $filename");
    while (($row = fgetcsv($file)) !== false) {
        if (count($row) === count($schema)) {
            $data[] = array_combine($schema, $row);
        }
    }
    fclose($file);
    return $data;
}

function writeCSV($filename, $data, $schema) {
    $file = fopen($filename, 'w');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    foreach ($data as $row) {
        $csvRow = [];
        foreach ($schema as $field) {
            $value = $row[$field] ?? '';
            // Prevent CSV injection
            if (preg_match('/^[=+\\-@]/', $value)) {
                $value = "'" . $value;
            }
            $csvRow[] = $value;
        }
        fputcsv($file, $csvRow);
    }
    fclose($file);
}

function appendCSV($filename, $row) {
    $file = fopen($filename, 'a');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    fputcsv($file, $row);
    fclose($file);
}
?>

--- End of csv_handler.php ---



--- Start of csv_import.php ---

function importCSVWithSchema($filename, $schema, $keyField, $existingRows) {
    $newRows = [];
    $imported = readCSV($filename);
    foreach ($imported as $row) {
        if (!array_diff($schema, array_keys($row)) && !in_array($row[$keyField], array_column($existingRows, $keyField))) {
            $newRows[] = $row;
        }
    }
    return $newRows;
}


--- End of csv_import.php ---



--- Start of customers_list.php ---

<?php
// customers_list.php

header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once __DIR__ . '/csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter only customers
$customers = array_filter($contacts, function($c) {
    return in_array(strtolower(trim($c['is_customer'] ?? '')), ['yes', 'true', '1']);
});
?>

<div class="container">
  <h2>Customer List</h2>

  <table class="table-grid">
    <thead>
      <tr>
		<th>Company</th>
        <th>First Name</th>
        <th>Email</th>
        <th>Customer Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($customers as $contact): ?>
        <tr>
          <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
		  <td><?= htmlspecialchars($contact['first_name'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['is_customer'] ?? '') ?></td>
          <td>
            <a href="customer_view.php?id=<?= urlencode($contact['id']) ?>" class="btn-primary">üëÅ View</a>
            <?php
              $deliveryFile = "{$contact['id']}_deliveries.csv";
              if (file_exists(__DIR__ . "/$deliveryFile")):
            ?>
              <a href="<?= htmlspecialchars($deliveryFile) ?>" class="btn-secondary" target="_blank">üì¶ Delivery Archive</a>
            <?php endif; ?>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="navigation">
    <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of customers_list.php ---



--- Start of customer_item_config.php ---

<?php
return [
  'tank_number',
  'tank_size',
  'type_of_resin',
  'delivery_date',
  'regeneration_number',
  'purchase_order'
];


--- End of customer_item_config.php ---



--- Start of customer_schema.php ---

<?php
return [
  'customer_id',
  'contact_name',
  'address',
  'tank_count',
  'last_delivery'
];


--- End of customer_schema.php ---



--- Start of customer_view.php ---

<?php


// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Includes
include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once __DIR__ . '/csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Helper: find contact by ID
function findContactById($contacts, $id) {
    if ($id === '') return null;
    foreach ($contacts as $c) {
        if ($c['id'] === $id) return $c;
    }
    return null;
}

// Helper: create delivery file
function createDeliveryFileIfNeeded($contactId) {
    $deliveryFile = __DIR__ . "/{$contactId}_deliveries.csv";
    if (!file_exists($deliveryFile)) {
        $fp = fopen($deliveryFile, 'w');
        if ($fp) {
            fputcsv($fp, ['delivery_date', 'tank_number', 'tank_size']);
            fclose($fp);
            return true;
        } else {
            error_log("Failed to create delivery file for contact ID: $contactId");
            return false;
        }
    }
    return true;
}

// Handle contact update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['id'])) {
    $id = $_POST['id'];
    foreach ($contacts as &$c) {
        if ($c['id'] === $id) {
            foreach ($schema as $f) {
                $c[$f] = $_POST[$f] ?? $c[$f];
            }

            // Create delivery file if marked as customer
            if (isset($_POST['is_customer']) && strtolower(trim($_POST['is_customer'])) === 'yes') {
                if (!createDeliveryFileIfNeeded($id)) {
                    echo "<div class='alert-error'>‚ö†Ô∏è Delivery file could not be created for customer ID: $id</div>";
                }
            }

            break;
        }
    }
    writeCSV('contacts.csv', $contacts, $schema);
    header("Location: customer_view.php?id=" . urlencode($id));
    exit;
}

// Load contact
$id = $_GET['id'] ?? '';
$contact = findContactById($contacts, $id);

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once(__DIR__ . '/layout_end.php');
    exit;
}
?>

<div class="container">
  <h2>Customer Details</h2>
  

  <form method="post" class="contact-form">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php elseif ($f === 'id'): ?>
            <input type="text" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>" disabled>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

    <div class="form-actions">
  <button type="submit" class="btn-primary">üíæ Save Changes</button>
	</div>

<?php
if (strtolower(trim($contact['is_customer'] ?? '')) === 'yes') {
    $deliveryFile = "{$contact['id']}_deliveries.csv";
    $deliveryFilePath = __DIR__ . "/$deliveryFile";
    if (file_exists($deliveryFilePath)) {
        $deliveryUrl = "deliveries.php?id=" . urlencode($contact['id']);
        echo '<a href="' . $deliveryUrl . '" class="btn-primary">üì¶ View Delivery Archive</a>';
    }
}
?>




<?php include_once(__DIR__ . '/layout_end.php'); ?>

--- End of customer_view.php ---



--- Start of dashboard.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>
<?php
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
$forecastData = calculateForecasts();
$forecasts = $forecastData['individual'];
$forecastByStage = $forecastData['by_stage'];

$totalContacts = count($contacts);
$totalValue = array_sum(array_column($opportunities, 'value'));
$totalForecast = array_sum(array_column($forecasts, 'forecast'));
$accuracy = $totalValue > 0 ? ($totalForecast / $totalValue) * 100 : 0;

// Identify top forecast stage
$topStage = '';
$maxForecast = 0;
foreach ($forecastByStage as $stage => $data) {
    if ($data['total_forecast'] > $maxForecast) {
        $maxForecast = $data['total_forecast'];
        $topStage = $stage;
    }
}

echo "<h2>CRM Dashboard</h2>";
echo "<div class='dashboard-card'><strong>Total Contacts:</strong> $totalContacts</div>";
echo "<div class='dashboard-card'><strong>Total Opportunity Value:</strong> $" . number_format($totalValue, 2) . "</div>";
echo "<div class='dashboard-card'><strong>Total Forecast Value:</strong> $" . number_format($totalForecast, 2) . "</div>";
echo "<div class='dashboard-card'><strong>Forecast Accuracy:</strong> " . number_format($accuracy, 1) . "%</div>";
echo "<div class='dashboard-card'><strong>Top Forecast Stage:</strong> $topStage</div>";

// Pipeline breakdown
$stages = [];
foreach ($opportunities as $opp) {
    $stage = $opp['stage'];
    $value = floatval($opp['value']);
    if (!isset($stages[$stage])) {
        $stages[$stage] = ['count' => 0, 'value' => 0];
    }
    $stages[$stage]['count']++;
    $stages[$stage]['value'] += $value;
}

echo "<h3>Pipeline Breakdown</h3>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Stage</th><th>Count</th><th>Total Value</th></tr>";
foreach ($stages as $stage => $data) {
    echo "<tr>";
    echo "<td>$stage</td>";
    echo "<td>{$data['count']}</td>";
    echo "<td>$" . number_format($data['value'], 2) . "</td>";
    echo "</tr>";
}
echo "</table>";

echo "<h3>Forecast by Stage</h3>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Stage</th><th>Count</th><th>Total Forecast</th></tr>";
foreach ($forecastByStage as $stage => $data) {
    echo "<tr>";
    echo "<td>$stage</td>";
    echo "<td>{$data['count']}</td>";
    echo "<td>$" . number_format($data['total_forecast'], 2) . "</td>";
    echo "</tr>";
}
echo "</table>";
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of dashboard.php ---



--- Start of delete_contact.php ---

<?php
require_once 'contact_validator.php';
require_once 'csv_handler.php';

$idToDelete = $_POST['id'] ?? null;
if (!$idToDelete) {
    echo "No contact ID provided.";
    exit;
}

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter out the contact to delete
$filtered = array_filter($contacts, function($c) use ($idToDelete) {
    return $c['id'] !== $idToDelete;
});

// Defensive write: ensure header matches schema
$fp = fopen('contacts.csv', 'w');
fputcsv($fp, $schema);
foreach ($filtered as $row) {
    $line = [];
    foreach ($schema as $col) {
        $line[] = array_key_exists($col, $row) ? $row[$col] : '';
    }
    fputcsv($fp, $line);
}
fclose($fp);

header('Location: contacts_list.php');
exit;
?>


--- End of delete_contact.php ---



--- Start of delete_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if (isset($_GET['timestamp'])) {
    deleteTask($filename, $schema, $_GET['timestamp']);
}
header('Location: index.php');
exit;


--- End of delete_task.php ---



--- Start of deliveries.php ---

<?php
include_once 'navbar.php';
include_once 'layout_start.php';

// Get customer ID from GET
$id = isset($_GET['id']) ? preg_replace('/[^a-zA-Z0-9_-]/', '', $_GET['id']) : null;

if (!$id) {
    echo "<p>Error: No customer ID specified.</p>";
    include_once 'layout_end.php';
    exit;
}

$csvFile = "deliveries_$id.csv";

// Create file if it doesn't exist
if (!file_exists($csvFile)) {
    $fp = fopen($csvFile, 'w');
    fputcsv($fp, ['Date', 'Company', 'Tank #', 'Size']); // Header row
    fclose($fp);
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $date = $_POST['delivery_date'];
    $company = $_POST['company'];
    $tank_number = $_POST['tank_number'];
    $tank_size = $_POST['tank_size'];

    $newEntry = [$date, $company, $tank_number, $tank_size];
    $fp = fopen($csvFile, 'a');
    fputcsv($fp, $newEntry);
    fclose($fp);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delivery Archive - Customer #<?php echo htmlspecialchars($id); ?></title>
  <script>
    function sortTable(n) {
      const table = document.getElementById("deliveryTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let shouldSwitch = dir === "asc" ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase();
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
            break;
          }
        }
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  </script>
</head>
<body>
  <h2>üì¶ Delivery Archive for Customer #<?php echo htmlspecialchars($id); ?></h2>

  <form method="post">
    <label><strong>Add New Delivery:</strong></label><br>
    <input type="date" name="delivery_date" required>
    <input type="text" name="company" required>
    <input type="text" name="tank_number" placeholder="Tank #" required>
    <input type="text" name="tank_size" placeholder="Size" required>
    <button type="submit">‚ûï Add Delivery</button>
  </form>

  <br>
  customer_view.php?id=<?php echo urlencode($id); ?>
    <button>üîô Back to Customer Details</button>
  </a>

  <br><br>
  <table id="deliveryTable" border="1">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Date</th>
        <th onclick="sortTable(1)">Company</th>
        <th onclick="sortTable(2)">Tank #</th>
        <th onclick="sortTable(3)">Size</th>
      </tr>
    </thead>
    <tbody>
      <?php
      $rows = array_map('str_getcsv', file($csvFile));
      array_shift($rows); // Remove header
      if (count($rows) > 0) {
          foreach ($rows as $row) {
              echo "<tr>";
              foreach ($row as $cell) {
                  echo "<td>" . htmlspecialchars($cell) . "</td>";
              }
              echo "</tr>";
          }
      } else {
          echo "<tr><td colspan='4'>No delivery records found.</td></tr>";
      }
      ?>
    </tbody>
  </table>
</body>
</html>
<?php include_once 'layout_end.php'; ?>

--- End of deliveries.php ---



--- Start of discussion_logger.php ---

<?php
// discussion_logger.php

// Set plain text response headers
header('Content-Type: text/plain; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Log raw POST data for debugging
file_put_contents('debug_log.txt', print_r($_POST, true) . PHP_EOL, FILE_APPEND);

// Use $_POST directly
$data = $_POST;

// Define the logging function
function logDiscussionEntry(array $data): bool {
    $file = 'discussion_log.csv';
    $logFile = 'error_log.txt';
    $schema = require __DIR__ . '/discussion_schema.php';

    // Build row using schema order
    $row = [];
    foreach ($schema as $col) {
        switch ($col) {
            case 'timestamp':
                $row[] = date('Y-m-d H:i');
                break;
            case 'entry_text':
                $row[] = isset($data[$col]) ? str_replace(["\r", "\n"], ' ', $data[$col]) : '';
                break;
            case 'author':
                $row[] = $data[$col] ?? 'System';
                break;
            case 'linked_opportunity_id':
                $row[] = $data[$col] ?? '';
                break;
            case 'visibility':
                $row[] = $data[$col] ?? 'private';
                break;
            default:
                $row[] = $data[$col] ?? '';
        }
    }

    // Try to append to CSV
    if (($fp = fopen($file, 'a')) !== false) {
        fputcsv($fp, $row);
        fclose($fp);
        return true;
    }

    // Log error if write fails
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write to $file for contact_id: {$data['contact_id']}\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    return false;
}

// Output plain success or error message
if (!empty($data) && logDiscussionEntry($data)) {
    echo "Logged successfully";
} else {
    echo "Logging failed or invalid data";
}
?>


--- End of discussion_logger.php ---



--- Start of discussion_module.php ---

<?php
$cid = $contact['id'] ?? '';
if (empty($cid)) return;

$discussionSchema = require __DIR__ . '/discussion_schema.php';
$discussionLog = readCSV('discussion_log.csv', $discussionSchema) ?: [];

$entries = array_filter($discussionLog, fn($e) => trim($e['contact_id']) === trim($cid));
usort($entries, fn($a, $b) => strtotime($b['timestamp']) <=> strtotime($a['timestamp']));
?>

<div style="margin-top:40px;">
  <h3>Discussion</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:40px; align-items:start;">

    <!-- Add Discussion Entry (Left) -->
    <div>
      <h4>Add Discussion Entry</h4>
      <form method="post" style="display:grid; gap:15px;">
        <input type="hidden" name="contact_id" value="<?= htmlspecialchars($cid) ?>">

        <div>
          <label for="author">Author:</label><br>
          <input type="text" name="author" id="author" value="Robert Lee" required>
        </div>

        <div>
          <label for="entry_text">Comment:</label><br>
          <textarea name="entry_text" id="entry_text" rows="4" required></textarea>
        </div>

        <div>
          <label for="linked_opportunity_id">Linked Opportunity ID (optional):</label><br>
          <input type="text" name="linked_opportunity_id" id="linked_opportunity_id">
        </div>

        <div>
          <label for="visibility">Visibility:</label><br>
          <select name="visibility" id="visibility">
            <option value="public">Public</option>
            <option value="internal">Internal</option>
          </select>
        </div>

        <button type="submit" class="btn-primary">üí¨ Log Discussion</button>
      </form>
    </div>

    <!-- Discussion History (Right) -->
    <div>
      <h4>Discussion History</h4>
      <?php if (!empty($entries)): ?>
        <?php foreach ($entries as $entry): ?>
          <div style="border-left:3px solid #0099A8; padding-left:10px; margin-bottom:15px;">
            <div style="font-size:0.9em; color:#555;">
              <strong><?= htmlspecialchars($entry['author'] ?? 'Admin') ?></strong>
              <em><?= htmlspecialchars($entry['timestamp'] ?? '') ?></em>
              <?php if (!empty($entry['linked_opportunity_id'])): ?>
                ‚Ä¢ <span>Opportunity: <?= htmlspecialchars($entry['linked_opportunity_id']) ?></span>
              <?php endif; ?>
              <?php if (!empty($entry['visibility'])): ?>
                ‚Ä¢ <span>Visibility: <?= htmlspecialchars($entry['visibility']) ?></span>
              <?php endif; ?>
            </div>
            <div style="margin-top:5px;">
              <?= nl2br(htmlspecialchars($entry['entry_text'] ?? '')) ?>
            </div>
          </div>
        <?php endforeach; ?>
      <?php else: ?>
        <p style="color:#666;">No discussion history found for this contact.</p>
      <?php endif; ?>
    </div>

  </div>
</div>


--- End of discussion_module.php ---



--- Start of discussion_schema.php ---

<?php
return [
    'contact_id',
    'author',
    'timestamp',
    'entry_text',
    'linked_opportunity_id',
    'visibility'
];


--- End of discussion_schema.php ---



--- Start of discussion_validator.php ---

<?php
function validateDiscussion(array $data): array {
    $errors = [];

    if (empty($data['contact_id'])) {
        $errors['contact_id'] = 'Contact ID is required.';
    }

    if (empty($data['entry_text'])) {
        $errors['entry_text'] = 'Comment text is required.';
    }

    if (empty($data['author'])) {
        $errors['author'] = 'Author is required.';
    }

    return $errors;
}


--- End of discussion_validator.php ---



--- Start of edit_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $updatedTask = [
        $_POST['title'],
        $_POST['due_date'],
        $_POST['status'],
        $_POST['timestamp']
    ];
    updateTask($filename, $schema, $_POST['timestamp'], $updatedTask);
    header('Location: index.php');
    exit;
}

$timestamp = $_GET['timestamp'] ?? '';
$tasks = readCSV($filename, $schema);
$taskToEdit = null;
foreach ($tasks as $task) {
    if ($task['timestamp'] === $timestamp) {
        $taskToEdit = $task;
        break;
    }
}
if (!$taskToEdit) {
    echo "Task not found.";
    exit;
}
?>

<h3>Edit Task</h3>
<form method="POST">
  <input type="hidden" name="timestamp" value="<?= htmlspecialchars($taskToEdit['timestamp']) ?>">
  <input type="text" name="title" value="<?= htmlspecialchars($taskToEdit['title']) ?>" required>
  <input type="date" name="due_date" value="<?= htmlspecialchars($taskToEdit['due_date']) ?>" required>
  <select name="status" required>
    <option value="pending" <?= $taskToEdit['status'] === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $taskToEdit['status'] === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <button type="submit">Update Task</button>
</form>


--- End of edit_task.php ---



--- Start of enhanced_contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = [];
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
    if (!empty($c['tags'])) {
        foreach (explode(',', $c['tags']) as $tag) {
            $tagOptions[trim($tag)] = true;
        }
    }
}
ksort($statusOptions);
ksort($tagOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $tagFilter) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $matchTag = $tagFilter === '' || in_array($tagFilter, array_map('trim', explode(',', $c['tags'] ?? '')));
    return $matchQuery && $matchStatus && $matchTag;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <select name="tag">
      <option value="">-- Tag --</option>
      <?php foreach (array_keys($tagOptions) as $tag): ?>
        <option value="<?= htmlspecialchars($tag) ?>" <?= $tag === $tagFilter ? 'selected' : '' ?>><?= htmlspecialchars($tag) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table-grid">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th>
            <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
              <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
              <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
            </a>
          </th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of enhanced_contact_list.php ---



--- Start of export_contacts.php ---

<?php
require_once 'csv_handler.php';
require_once 'csv_export.php';

$filename = 'contacts.csv';
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV($filename, $schema);

// Build filters from query string using schema
$filters = [];
foreach ($schema as $field) {
    if (!empty($_GET[$field])) {
        $filters[$field] = $_GET[$field];
    }
}

// Schema-safe export function
function exportCSVFiltered($filename, $rows, $filters = [], $schema = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered), $schema);
}

// Export filtered contacts to a new file
$exported = exportCSVFiltered('contacts_export.csv', $contacts, $filters, $schema);
echo $exported ? "Export complete." : "No matching contacts.";
?>


--- End of export_contacts.php ---



--- Start of follow_up_email.php ---

<?php
// follow_up_email.php

$contactName = $contact['name'] ?? 'there';
$companyName = $contact['company'] ?? 'your team';
$contactEmail = $contact['email'] ?? '';
$contactId = $contact['id'] ?? 0;
?>

<div class="module follow-up-email">
  <h3>Send Email</h3>
  <button onclick="generateEmail('followup')">Follow-Up After Call</button>
  <button onclick="generateEmail('intro')">Introductory Email</button>
  <button onclick="generateEmail('touchbase')">Touch Base Email</button>
  <button id="sendEmailBtn" onclick="sendFollowUpEmail()">Send Email</button>

  <textarea id="followUpEmail" rows="12" class="email-textarea"></textarea>
</div>

<script>
const contactName = "<?= htmlspecialchars($contactName, ENT_QUOTES) ?>";
const contactEmail = "<?= htmlspecialchars($contactEmail, ENT_QUOTES) ?>";
let currentEmailType = '';

function generateEmail(type) {
  currentEmailType = type;

  let body = '';
  switch (type) {
    case 'followup':
      body = `Hi ${contactName},

It was great speaking with you earlier. I wanted to follow up on our conversation and thank you for taking the time to connect.

At Eclipse Water Technologies, we‚Äôre committed to providing responsive, local service without the delays or complications of cross-border logistics. Whether it‚Äôs a complex treatment challenge or a routine system check, our team is here to support you.

If you have any questions or would like to explore next steps, feel free to reach out anytime.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'intro':
      body = `Hi ${contactName},

I wanted to introduce you to Eclipse Water Technologies ‚Äî a local provider of industrial water and wastewater solutions.

We specialize in everything from advanced treatment systems to simple filter replacements, and our team is known for responsive service and technical expertise. Being local means no border delays or tariffs ‚Äî just fast, reliable support.

We‚Äôd love to learn more about your needs and explore how we can help.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'touchbase':
      body = `Hi ${contactName},

I hope things are going well on your end. I just wanted to touch base and see if there‚Äôs anything you might need support with regarding your water or wastewater systems.

At Eclipse Water Technologies, we‚Äôre always happy to reconnect and help ‚Äî whether it‚Äôs a quick filter change or a more involved project.

Feel free to reach out anytime if you'd like to chat or explore options.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;
  }

  document.getElementById('followUpEmail').value = body;
}

function sendFollowUpEmail() {
  const emailBody = document.getElementById('followUpEmail').value.trim();
  const subjectLine = "Industrial Water Treatment - Eclipse Water Technologies";

  if (!contactEmail) {
    alert("No email address found for this contact.");
    return;
  }

  if (!emailBody) {
    alert("Email body is empty. Please generate or write your message.");
    return;
  }

  const mailtoLink = `mailto:${contactEmail}?subject=${encodeURIComponent(subjectLine)}&body=${encodeURIComponent(emailBody)}`;
  window.location.href = mailtoLink;
}
</script>

--- End of follow_up_email.php ---



--- Start of forecast_calc.php ---

<?php
require_once 'csv_handler.php';

function calculateForecasts($filename = 'opportunities.csv') {
    $schema = require __DIR__ . '/opportunity_schema.php';
    $opportunities = readCSV($filename, $schema);
    $results = [];
    $stageTotals = [];

    foreach ($opportunities as $opp) {
        $value = floatval($opp['value']);
        $probability = floatval($opp['probability']);
        $forecast = round($value * ($probability / 100), 2);

        $stage = $opp['stage'] ?? 'Unspecified';

        // Add to grouped stage totals
        if (!isset($stageTotals[$stage])) {
            $stageTotals[$stage] = ['count' => 0, 'total_forecast' => 0];
        }
        $stageTotals[$stage]['count']++;
        $stageTotals[$stage]['total_forecast'] += $forecast;

        // Add to individual forecast list
        $results[] = [
            'id' => $opp['id'] ?? '',
            'contact_id' => $opp['contact_id'] ?? '',
            'stage' => $stage,
            'value' => $value,
            'forecast' => $forecast
        ];
    }

    return [
        'individual' => $results,
        'by_stage' => $stageTotals
    ];
}
?>


--- End of forecast_calc.php ---



--- Start of get_oauth_token.php ---

<?php


require_once 'contact_validator.php';/**
 * PHPMailer - PHP email creation and transport class.
 * PHP Version 5.5
 * @package PHPMailer
 * @see https://github.com/PHPMailer/PHPMailer/ The PHPMailer GitHub project
 * @author Marcus Bointon (Synchro/coolbru) <phpmailer@synchromedia.co.uk>
 * @author Jim Jagielski (jimjag) <jimjag@gmail.com>
 * @author Andy Prevost (codeworxtech) <codeworxtech@users.sourceforge.net>
 * @author Brent R. Matzelle (original founder)
 * @copyright 2012 - 2020 Marcus Bointon
 * @copyright 2010 - 2012 Jim Jagielski
 * @copyright 2004 - 2009 Andy Prevost
 * @license https://www.gnu.org/licenses/old-licenses/lgpl-2.1.html GNU Lesser General Public License
 * @note This program is distributed in the hope that it will be useful - WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.
 */

/**
 * Get an OAuth2 token from an OAuth2 provider.
 * * Install this script on your server so that it's accessible
 * as [https/http]://<yourdomain>/<folder>/get_oauth_token.php
 * e.g.: http://localhost/phpmailer/get_oauth_token.php
 * * Ensure dependencies are installed with 'composer install'
 * * Set up an app in your Google/Yahoo/Microsoft account
 * * Set the script address as the app's redirect URL
 * If no refresh token is obtained when running this file,
 * revoke access to your app and run the script again.
 */

namespace PHPMailer\PHPMailer;

/**
 * Aliases for League Provider Classes
 * Make sure you have added these to your composer.json and run `composer install`
 * Plenty to choose from here:
 * @see https://oauth2-client.thephpleague.com/providers/thirdparty/
 */
//@see https://github.com/thephpleague/oauth2-google
use League\OAuth2\Client\Provider\Google;
//@see https://packagist.org/packages/hayageek/oauth2-yahoo
use Hayageek\OAuth2\Client\Provider\Yahoo;
//@see https://github.com/stevenmaguire/oauth2-microsoft
use Stevenmaguire\OAuth2\Client\Provider\Microsoft;
//@see https://github.com/greew/oauth2-azure-provider
use Greew\OAuth2\Client\Provider\Azure;

if (!isset($_GET['code']) && !isset($_POST['provider'])) {
    ?>
<html>
<body>
<?php include_once 'navbar.php'; ?>
<?php include 'navbar.php'; ?>
<form method="post">
    <h1>Select Provider</h1>
    <input type="radio" name="provider" value="Google" id="providerGoogle">
    <label for="providerGoogle">Google</label><br>
    <input type="radio" name="provider" value="Yahoo" id="providerYahoo">
    <label for="providerYahoo">Yahoo</label><br>
    <input type="radio" name="provider" value="Microsoft" id="providerMicrosoft">
    <label for="providerMicrosoft">Microsoft</label><br>
    <input type="radio" name="provider" value="Azure" id="providerAzure">
    <label for="providerAzure">Azure</label><br>
    <h1>Enter id and secret</h1>
    <p>These details are obtained by setting up an app in your provider's developer console.
    </p>
    <p>ClientId: <input type="text" name="clientId"><p>
    <p>ClientSecret: <input type="text" name="clientSecret"></p>
    <p>TenantID (only relevant for Azure): <input type="text" name="tenantId"></p>
    <input type="submit" value="Continue">
</form>
<?php include 'layout_end.php'; ?>
</body>
</html>
    <?php
    exit;
}

require 'vendor/autoload.php';

session_start();

$providerName = '';
$clientId = '';
$clientSecret = '';
$tenantId = '';

if (array_key_exists('provider', $_POST)) {
    $providerName = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST['provider'];
    $clientId = $_POST['clientId'];
    $clientSecret = $_POST['clientSecret'];
    $tenantId = $_POST['tenantId'];
    $_SESSION['provider'] = $providerName;
    $_SESSION['clientId'] = $clientId;
    $_SESSION['clientSecret'] = $clientSecret;
    $_SESSION['tenantId'] = $tenantId;
} elseif (array_key_exists('provider', $_SESSION)) {
    $providerName = $_SESSION['provider'];
    $clientId = $_SESSION['clientId'];
    $clientSecret = $_SESSION['clientSecret'];
    $tenantId = $_SESSION['tenantId'];
}

//If you don't want to use the built-in form, set your client id and secret here
//$clientId = 'RANDOMCHARS-----duv1n2.apps.googleusercontent.com';
//$clientSecret = 'RANDOMCHARS-----lGyjPcRtvP';

//If this automatic URL doesn't work, set it yourself manually to the URL of this script
$redirectUri = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'];
//$redirectUri = 'http://localhost/PHPMailer/redirect';

$params = [
    'clientId' => $clientId,
    'clientSecret' => $clientSecret,
    'redirectUri' => $redirectUri,
    'accessType' => 'offline'
];

$options = [];
$provider = null;

switch ($providerName) {
    case 'Google':
        $provider = new Google($params);
        $options = [
            'scope' => [
                'https://mail.google.com/'
            ]
        ];
        break;
    case 'Yahoo':
        $provider = new Yahoo($params);
        break;
    case 'Microsoft':
        $provider = new Microsoft($params);
        $options = [
            'scope' => [
                'wl.imap',
                'wl.offline_access'
            ]
        ];
        break;
    case 'Azure':
        $params['tenantId'] = $tenantId;

        $provider = new Azure($params);
        $options = [
            'scope' => [
                'https://outlook.office.com/SMTP.Send',
                'offline_access'
            ]
        ];
        break;
}

if (null === $provider) {
    exit('Provider missing');
}

if (!isset($_GET['code'])) {
    //If we don't have an authorization code then get one
    $authUrl = $provider->getAuthorizationUrl($options);
    $_SESSION['oauth2state'] = $provider->getState();
    header('Location: ' . $authUrl);
    exit;
    //Check given state against previously stored one to mitigate CSRF attack
} elseif (empty($_GET['state']) || ($_GET['state'] !== $_SESSION['oauth2state'])) {
    unset($_SESSION['oauth2state']);
    unset($_SESSION['provider']);
    exit('Invalid state');
} else {
    unset($_SESSION['provider']);
    //Try to get an access token (using the authorization code grant)
    $token = $provider->getAccessToken(
        'authorization_code',
        [
            'code' => $_GET['code']
        ]
    );
    //Use this to interact with an API on the users behalf
    //Use this to get a new access token if the old one expires
    echo 'Refresh Token: ', htmlspecialchars($token->getRefreshToken());
}


--- End of get_oauth_token.php ---



--- Start of get_tasks.php ---

<?php
$filename = 'tasks.csv';

if (!file_exists($filename)) {
    exit;
}

$tasks = [];

if (($fp = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($fp); // Read header row
    while (($row = fgetcsv($fp)) !== false) {
        $task = array_combine($headers, $row);
        if ($task['status'] !== 'archived') {
            $id = htmlspecialchars($task['id']);
            $title = htmlspecialchars($task['title']);
            $timestamp = htmlspecialchars($task['timestamp']);
            $tasks[] = "<li>$title (Created: $timestamp) <button onclick=\"archiveTask('$id')\">Archive</button></li>";
        }
    }
    fclose($fp);
}

echo implode('', $tasks);
?>

--- End of get_tasks.php ---



--- Start of import_contacts.php ---

<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
$pageTitle = 'Import Contacts';
$currentPage = basename(__FILE__);
include_once 'layout_start.php';
include_once 'navbar.php';
require_once 'csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
?>

<div class="container">
  <h2>Import Contacts</h2>

  <!-- Upload Form -->
  <form method="POST" enctype="multipart/form-data" class="contact-form">
    <label for="csv_file">Upload CSV File:</label>
    <input type="file" name="csv_file" accept=".csv" required>

    <!-- Buttons aligned horizontally -->
    <div style="margin-top: 10px;">
      <button type="submit">Preview Import</button>
      <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name'])): ?>
        <button type="button" class="btn-confirm" onclick="showConfirmModal()">Commit Import</button>
      <?php endif; ?>
    </div>
  </form>

  <?php
  if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name'])) {
      $tmp = $_FILES['csv_file']['tmp_name'];
      $rows = array_map('str_getcsv', file($tmp));
      $header = array_map('trim', array_shift($rows));
      $preview = [];

      foreach ($rows as $row) {
          $contact = array_combine($header, $row);
          $contact['id'] = uniqid();

          foreach ($schema as $field) {
              if (!isset($contact[$field])) {
                  $contact[$field] = '';
              }
          }

          $preview[] = $contact;
      }

      $_SESSION['import_preview'] = $preview;

      echo "<h3>Preview Contacts</h3>";

      if (empty($preview)) {
          echo "<p style='color:red;'>No contacts to preview.</p>";
      } else {
          echo "<form method='POST' action='commit_import.php' id='commitForm'>";
          echo "<table class='spec-table'><thead><tr>";
          foreach ($schema as $col) {
              echo "<th>" . htmlspecialchars(ucfirst(str_replace('_', ' ', $col))) . "</th>";
          }
          echo "</tr></thead><tbody>";
          foreach ($preview as $contact) {
              echo "<tr>";
              foreach ($schema as $col) {
                  echo "<td>" . htmlspecialchars($contact[$col] ?? '') . "</td>";
              }
              echo "</tr>";
          }
          echo "</tbody></table>";
          echo "</form>"; // ‚úÖ Form ends here, submit triggered by modal
      }
  }
  ?>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Confirm Import</h3>
    <p>This will permanently add these contacts to the system. Proceed?</p>
    <button onclick="document.getElementById('commitForm').submit()">Yes, Commit</button>
    <button onclick="hideConfirmModal()">Cancel</button>
  </div>
</div>

<!-- Modal Styles & Script -->
<style>
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
}
.modal-box {
  background: #fff; padding: 20px 30px; border-radius: 8px; text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.modal-box button {
  margin: 10px; padding: 8px 16px; border: none; border-radius: 4px;
  background: #0077cc; color: #fff; cursor: pointer;
}
.modal-box button:hover {
  background: #005fa3;
}
</style>

<script>
function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
}
</script>

<?php include_once 'layout_end.php'; ?>


--- End of import_contacts.php ---



--- Start of index.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

require_once 'layout_start.php';
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];
$tasks = readCSV($filename, $schema);

$statusFilter = isset($_GET['status']) ? $_GET['status'] : '';
$year = isset($_GET['year']) ? $_GET['year'] : date('Y');
$month = isset($_GET['month']) ? $_GET['month'] : date('m');

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        if ($statusFilter === '' || $task['status'] === $statusFilter) {
            $tasksByDate[$task['due_date']][] = $task;
        }
    }
}

$prevMonth = $month - 1;
$prevYear = $year;
if ($prevMonth < 1) {
    $prevMonth = 12;
    $prevYear--;
}

$nextMonth = $month + 1;
$nextYear = $year;
if ($nextMonth > 12) {
    $nextMonth = 1;
    $nextYear++;
}
?>

<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }
  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }
  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }
  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>

<h2>Task Calendar</h2>

<div style="text-align:center; margin-bottom:20px;">
  <a href="?year=<?= $prevYear ?>&month=<?= str_pad($prevMonth, 2, '0', STR_PAD_LEFT) ?>">‚Üê Previous</a>
  <strong><?= date('F Y', strtotime("$year-$month-01")) ?></strong>
  <a href="?year=<?= $nextYear ?>&month=<?= str_pad($nextMonth, 2, '0', STR_PAD_LEFT) ?>">Next ‚Üí</a>
</div>

<form method="GET" style="margin-bottom: 20px;">
  <label for="status">Filter by status:</label>
  <select name="status" id="status" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="pending" <?= $statusFilter === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $statusFilter === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <input type="hidden" name="year" value="<?= $year ?>">
  <input type="hidden" name="month" value="<?= $month ?>">
</form>

<h3>Add New Task</h3>
<form method="POST" action="add_task.php" onsubmit="return validateForm()">
  <input type="text" name="title" id="title" placeholder="Task Title" required>
  <input type="date" name="due_date" id="due_date" required>
  <select name="status" id="status" required>
    <option value="">Select Status</option>
    <option value="pending">Pending</option>
    <option value="completed">Completed</option>
  </select>
  <button type="submit">Add Task</button>
</form>

<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
<?php
$daysInMonth = date('t', strtotime("$year-$month-01"));
$firstDayOfMonth = date('w', strtotime("$year-$month-01"));

$day = 1;
$week = [];

for ($i = 0; $i < $firstDayOfMonth; $i++) {
    $week[] = "<td></td>";
}

while ($day <= $daysInMonth) {
    $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
    if (isset($tasksByDate[$dateStr])) {
        $taskTitles = '';
        foreach ($tasksByDate[$dateStr] as $task) {
            $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
            $taskTitles .= "edit_task.php?timestamp=Edit</a> | ";
            $taskTitles .= "delete_task.php?timestamp=Delete</a><br><br>";
        }
        $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
    } else {
        $week[] = "<td>$day</td>";
    }

    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;
}


    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;

if (!empty($week)) {
    while (count($week) < 7) {
        $week[] = "<td></td>";
    }
    echo "<tr>" . implode('', $week) . "</tr>";
}
?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}

function validateForm() {
  const title = document.getElementById('title').value.trim();
  const dueDate = document.getElementById('due_date').value;
  const status = document.getElementById('status').value;

  if (title === '') {
    alert('Please enter a task title.');
    return false;
  }

  if (dueDate === '') {
    alert('Please select a due date.');
    return false;
  }

  if (status === '') {
    alert('Please select a status.');
    return false;
  }

  return true;
}
</script>

<?php include 'layout_end.php'; ?>


--- End of index.php ---



--- Start of inject_ids.php ---

<?php
function injectIdsIntoCsv($inputFile, $outputFile, $idPrefix = 'CNT') {
    $rows = array_map('str_getcsv', file($inputFile));
    $header = $rows[0];

    // Add ID column if missing
    if (!in_array('id', $header)) {
        array_unshift($header, 'id');
    }

    $newRows = [$header];
    for ($i = 1; $i < count($rows); $i++) {
        $row = $rows[$i];
        $id = $idPrefix . '_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
        array_unshift($row, $id);
        $newRows[] = $row;
    }

    // Write to output file
    $fp = fopen($outputFile, 'w');
    foreach ($newRows as $fields) {
        fputcsv($fp, $fields);
    }
    fclose($fp);
}


--- End of inject_ids.php ---



--- Start of layout_end.php ---

</div> <!-- end container -->
</body>
</html>


--- End of layout_end.php ---



--- Start of layout_start.php ---

<?php
$pageTitle = $pageTitle ?? 'CRM';
$currentPage = basename($_SERVER['SCRIPT_NAME']);
header('Content-Type: text/html; charset=UTF-8');
header('X-Content-Type-Options: nosniff');
?>
<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="CRM system for managing contacts and customer interactions.">
  <meta name="author" content="Eclipse Water Technologies">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="<?= htmlspecialchars($pageTitle) ?>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/<?= htmlspecialchars($currentPage) ?>">
  <meta property="og:image" content="https://yourdomain.com/images/preview.png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css?v=20251002">
  <title><?= htmlspecialchars($pageTitle) ?></title>
</head>
<body>
<?php include_once 'navbar.php'; ?>
<div class="container">
  <div id="task-list-panel">
    <h3>Programming Tasks</h3>
    <ul id="task-list"></ul>
    <input type="text" id="new-task" placeholder="Add new task..." />
    <button onclick="addTask()">Add</button>
  </div>
</div>
<script src="/task-list.js"></script>
</body>
</html>


--- End of layout_start.php ---



--- Start of navbar.php ---

<nav class="navbar">
  <ul>
    <li><a href="dashboard.php" class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">Dashboard</a></li>
    <li><a href="contacts_list.php" class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">Contact List</a></li>
    <li><a href="add_customer.php" class="<?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">‚ûï Add Customer</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üìã Customer List</a></li>
    <li><a href="customer_view.php?id=demo" class="<?= $currentPage === 'customer_view.php' ? 'active' : '' ?>">üëÅ View Customer</a></li>
    <li><a href="calendar.php" class="<?= $currentPage === 'calendar.php' ? 'active' : '' ?>">üìÖ Calendar</a></li>
    <li><a href="contact_form.php" class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">Add Contact</a></li>
    <li><a href="opportunities_list.php" class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">Opportunities</a></li>
    <li><a href="opportunity_form.php" class="<?= $currentPage === 'opportunity_form.php' ? 'active' : '' ?>">Add Opportunity</a></li>
    <li><a href="import_contacts.php" class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">Import</a></li>
    <li><a href="export_contacts.php" class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">Export</a></li>
  </ul>
</nav>


--- End of navbar.php ---



--- Start of opportunities_list.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');


// Build contact lookup map with fallback label
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $contactMap[trim($contact['id'])] = $fullName ?: 'Unnamed Contact';
}
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Opportunities List</h2>

  <?php if (empty($opportunities)): ?>
    <p>No opportunities found.</p>
  <?php else: ?>
    <table class="data-table">
      <thead>
        <tr>
          <?php foreach ($schema as $field): ?>
            <th><?= ucwords(str_replace('_', ' ', $field)) ?></th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($opportunities as $opp): ?>
          <tr>
            <?php foreach ($schema as $field): ?>
              <td>
                <?php
                  if ($field === 'contact_id') {
                      $contactId = trim($opp[$field] ?? '');
                      echo isset($contactMap[$contactId])
                          ? $contactMap[$contactId]
                          : 'Unknown';
                  } else {
                      echo htmlspecialchars($opp[$field] ?? '');
                  }
                ?>
              </td>
            <?php endforeach; ?>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  <?php endif; ?>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunities_list.php ---



--- Start of opportunity_form.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Add New Opportunity</h2>

  <?php if (!empty($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Opportunity saved successfully.</p>
  <?php elseif (!empty($_GET['status']) && $_GET['status'] === 'error'): ?>
    <p class="error-msg">Invalid opportunity data or contact ID.</p>
  <?php endif; ?>

  <form id="opportunity-form" action="add_opportunity.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>

      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>

        <?php if ($field === 'contact_id'): ?>
          <select name="contact_id" id="contact_id" class="form-control" required>
            <option value="">Select Contact</option>
            <?php foreach ($contacts as $contact): ?>
              <option value="<?= $contact['id'] ?>">
                <?= trim($contact['first_name'] . ' ' . $contact['last_name']) ?: 'Unnamed Contact' ?>
              </option>
            <?php endforeach; ?>
          </select>

        <?php elseif ($field === 'stage'): ?>
          <select name="stage" id="stage" class="form-control" required>
            <option value="">Select Stage</option>
            <option value="Prospecting">Prospecting</option>
            <option value="Proposal">Proposal</option>
            <option value="Negotiation">Negotiation</option>
            <option value="Closed Won">Closed Won</option>
            <option value="Closed Lost">Closed Lost</option>
          </select>

        <?php elseif ($field === 'expected_close'): ?>
          <input type="date" name="expected_close" id="expected_close" class="form-control" required>

        <?php elseif ($field === 'value' || $field === 'probability'): ?>
          <input type="number" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>

        <?php else: ?>
          <input type="text" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
        <?php endif; ?>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Opportunity</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunity_form.php ---



--- Start of opportunity_schema.php ---

<?php
return [
   'contact_id',
  'value',
  'stage',
  'probability',
  'expected_close'
];


--- End of opportunity_schema.php ---



--- Start of submit-contact.php ---

<?php

require_once 'contact_validator.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'PHPMailer.php';
require 'SMTP.php';
require 'Exception.php';

$schema = require __DIR__ . '/contact_schema.php';
$mail = new PHPMailer(true);

try {
    // Collect and sanitize form data
    $data = [];
    foreach ($schema as $field) {
        if ($field === 'id') continue;
        $value = htmlspecialchars(trim($_POST[$field] ?? ''));
        $data[$field] = $value;
    }

    // Validate required fields
    if (empty($data['first_name']) || empty($data['email']) || empty($data['message'])) {
        throw new Exception("Please fill in all required fields.");
    }

    // Save to CSV
    $csvRow = array_values($data);
    $csvRow[] = date('Y-m-d H:i:s');
    $file = fopen('contacts.csv', 'a');
    if ($file) {
        fputcsv($file, $csvRow);
        fclose($file);
    } else {
        throw new Exception("Unable to write to contacts.csv");
    }

    // GoDaddy relay SMTP settings
    $mail->SMTPDebug = 0;
    $mail->isSMTP();
    $mail->Host = 'relay-hosting.secureserver.net';
    $mail->SMTPAuth = false;
    $mail->SMTPSecure = '';
    $mail->Port = 25;

    // Email headers
    $mail->setFrom('rlee@eclipsewatertechnologies.com', 'Eclipse Contact Form');
    $mail->addAddress('rlee@eclipsewatertechnologies.com');
    $mail->addReplyTo($data['email'], $data['first_name']);

    // Email content
    $mail->Subject = 'New Contact Form Submission';
    $mail->Body = "Name: {$data['first_name']}\nEmail: {$data['email']}\nCompany: {$data['company']}\nMessage:\n{$data['message']}";

    $mail->send();

    // Redirect with success status
    header('Location: contact_form.php?status=success');
    exit;

} catch (Exception $e) {
    error_log("Contact form error: " . $e->getMessage());
    header('Location: contact_form.php?status=error');
    exit;
}


--- End of submit-contact.php ---



--- Start of tag_schema.php ---

<?phpreturn [
    'VIP' => 'VIP Client',
    'Lead' => 'Sales Lead',
    'Newsletter' => 'Newsletter Subscriber',
    'Inactive' => 'Inactive Contact',
    'Partner' => 'Business Partner',
    'Support' => 'Support Request',
    'Demo' => 'Requested Demo',
];
>

--- End of tag_schema.php ---



--- Start of update_contact.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>
<?php

require_once 'contact_validator.php';require_once 'csv_handler.php';

$schema = getContactSchema();
$contacts = readCSV('contacts.csv');
$updatedId = $_POST['id'] ?? null;

if (!$updatedId) {
    echo "Missing contact ID.";
    exit;
}

// Build updated contact
$updatedContact = [];
foreach ($schema as $col) {
    $updatedContact[$col] = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST[$col] ?? '';
}

// Replace contact in list
$updatedList = array_map(function($c) use ($updatedId, $updatedContact) {
    return $c['id'] === $updatedId ? $updatedContact : $c;
}, $contacts);

// Write back to CSV
writeCSV('contacts.csv', $updatedList);

// Redirect to viewer
header("Location: contact_view.php?id=$updatedId");
exit;
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of update_contact.php ---



--- Start of validation.php ---

<?php
function isValidEmail($email) {
    return filter_var($email, FILTER_VALIDATE_EMAIL);
}

function isValidPhone($phone) {
    return preg_match('/^\+?[0-9\s\-]{7,15}$/', $phone);
}

function validateContact($row) {
    return isset($row['first_name'], $row['last_name'], $row['email']) &&
           isValidEmail($row['email']) &&
           isValidPhone($row['phone']);
}
?>


--- End of validation.php ---



--- Start of phpinfo.php ---

<?php phpinfo(); ?>



--- End of phpinfo.php ---



--- Start of Auth.php ---

<?php
/**
 * Authentication System
 * 
 * Provides user registration, login, session management, and security features
 * Follows 2026 security best practices
 */

require_once __DIR__ . '/CsvDataStore.php';

class Auth {
    private $store;
    private $config;
    
    public function __construct($config) {
        $this->config = $config;
        $this->store = new CsvDataStore($config);
        $this->initSession();
    }
    
    /**
     * Initialize secure session
     */
    private function initSession() {
        if (session_status() === PHP_SESSION_NONE) {
            $security = $this->config['security'];
            
            // Set session cookie parameters before starting session
            session_set_cookie_params([
                'lifetime' => $security['session_lifetime'] ?? 86400,
                'path' => '/',
                'domain' => '',  // Empty for localhost
                'secure' => $security['session_cookie_secure'] ?? false,
                'httponly' => $security['session_cookie_httponly'] ?? true,
                'samesite' => $security['session_cookie_samesite'] ?? 'Lax'
            ]);
            
            ini_set('session.use_strict_mode', 1);
            ini_set('session.sid_length', 48);
            ini_set('session.sid_bits_per_character', 6);
            
            session_name($security['session_name']);
            session_start();
            
            // Regenerate session ID periodically
            if (!isset($_SESSION['created'])) {
                $_SESSION['created'] = time();
            } else if (time() - $_SESSION['created'] > 1800) {
                session_regenerate_id(true);
                $_SESSION['created'] = time();
            }
        }
    }
    
    /**
     * Register a new user
     */
    public function register($username, $email, $password) {
        // Validate input
        $validation = $this->validateRegistration($username, $email, $password);
        if (!$validation['valid']) {
            return ['success' => false, 'errors' => $validation['errors']];
        }
        
        // Check if user already exists
        if ($this->userExists($username, $email)) {
            return ['success' => false, 'errors' => ['Username or email already exists']];
        }
        
        // Hash password
        $passwordHash = $this->hashPassword($password);
        
        // Generate verification token
        $verificationToken = $this->config['app']['require_email_verification'] 
            ? bin2hex(random_bytes(32)) 
            : null;
        
        try {
            // Insert user (default role is 'user')
            $userId = $this->store->insert('users', [
                'username' => $username,
                'email' => $email,
                'password_hash' => $passwordHash,
                'role' => 'user',
                'is_verified' => $verificationToken ? '0' : '1',
                'is_active' => '1',
                'verification_token' => $verificationToken ?? '',
                'reset_token' => '',
                'reset_token_expires' => '',
                'failed_login_attempts' => '0',
                'locked_until' => '',
                'last_login' => '',
            ]);
            
            // Log registration
            $this->logActivity($userId, 'user_registered', json_encode([
                'username' => $username,
                'email' => $email,
            ]));
            
            return [
                'success' => true,
                'user_id' => $userId,
                'requires_verification' => $verificationToken !== null,
                'verification_token' => $verificationToken,
            ];
            
        } catch (Exception $e) {
            error_log('Registration failed: ' . $e->getMessage());
            return ['success' => false, 'errors' => ['Registration failed']];
        }
    }
    
    /**
     * Authenticate user login
     */
    public function login($usernameOrEmail, $password, $rememberMe = false) {
        $ip = $this->getIpAddress();
        
        // Check rate limiting
        if ($this->isRateLimited($usernameOrEmail, $ip)) {
            return [
                'success' => false,
                'error' => 'Too many login attempts. Please try again later.',
            ];
        }
        
        // Find user
        $user = $this->findUser($usernameOrEmail);
        
        // Log attempt
        $this->logLoginAttempt($usernameOrEmail, $ip, false);
        
        if (!$user) {
            return ['success' => false, 'error' => 'Invalid credentials'];
        }
        
        // Check if account is locked
        if ($this->isAccountLocked($user)) {
            return ['success' => false, 'error' => 'Account is temporarily locked'];
        }
        
        // Verify password
        if (!$this->verifyPassword($password, $user['password_hash'])) {
            $this->incrementFailedAttempts($user['id']);
            return ['success' => false, 'error' => 'Invalid credentials'];
        }
        
        // Check if email verification is required
        if ($this->config['app']['require_email_verification'] && !$user['is_verified']) {
            return ['success' => false, 'error' => 'Please verify your email address'];
        }
        
        // Check if account is active
        if (!$user['is_active']) {
            return ['success' => false, 'error' => 'Account is disabled'];
        }
        
        // Successful login
        $this->logLoginAttempt($usernameOrEmail, $ip, true);
        $this->resetFailedAttempts($user['id']);
        $this->updateLastLogin($user['id']);
        
        // Create session
        $sessionToken = $this->createSession($user['id'], $rememberMe);
        
        // Set session variables
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['email'] = $user['email'];
        $_SESSION['role'] = $user['role'] ?? 'user';
        $_SESSION['session_token'] = $sessionToken;
        $_SESSION['ip_address'] = $ip;
        
        // Log activity
        $this->logActivity($user['id'], 'user_login', 'Successful login');
        
        return [
            'success' => true,
            'user' => [
                'id' => $user['id'],
                'username' => $user['username'],
                'email' => $user['email'],
            ],
        ];
    }
    
    /**
     * Logout user
     */
    public function logout() {
        if (isset($_SESSION['session_token'])) {
            // Delete session from storage
            $this->store->delete('sessions', ['session_token' => $_SESSION['session_token']]);
        }
        
        if (isset($_SESSION['user_id'])) {
            $this->logActivity($_SESSION['user_id'], 'user_logout', 'User logged out');
        }
        
        // Clear session
        $_SESSION = [];
        session_destroy();
        
        // Delete session cookie
        if (isset($_COOKIE[session_name()])) {
            setcookie(session_name(), '', time() - 3600, '/');
        }
        
        return ['success' => true];
    }
    
    /**
     * Check if user is authenticated
     */
    public function isAuthenticated() {
        if (!isset($_SESSION['user_id']) || !isset($_SESSION['session_token'])) {
            return false;
        }
        
        // Verify session in storage
        $session = $this->store->fetchOne('sessions', [
            'session_token' => $_SESSION['session_token'],
            'user_id' => (string)$_SESSION['user_id']
        ]);
        
        if (!$session) {
            return false;
        }
        
        // Check if session is expired
        if (isset($session['expires_at']) && strtotime($session['expires_at']) <= time()) {
            return false;
        }
        
        // Check IP address match (optional, can be disabled for mobile users)
        // if ($session['ip_address'] !== $this->getIpAddress()) {
        //     return false;
        // }
        
        return true;
    }
    
    /**
     * Get current authenticated user
     */
    public function getCurrentUser() {
        if (!$this->isAuthenticated()) {
            return null;
        }
        
        $user = $this->store->fetchOne('users', ['id' => (string)$_SESSION['user_id']]);
        
        if ($user) {
            // Return only safe fields
            $user = [
                'id' => $user['id'],
                'username' => $user['username'],
                'email' => $user['email'],
                'created_at' => $user['created_at'] ?? '',
                'last_login' => $user['last_login'] ?? '',
            ];
        }
        
        return $user ?: null;
    }
    
    /**
     * Change user password
     */
    public function changePassword($userId, $oldPassword, $newPassword) {
        $user = $this->store->fetchOne('users', ['id' => (string)$userId]);
        
        if (!$user) {
            return ['success' => false, 'error' => 'User not found'];
        }
        
        if (!$this->verifyPassword($oldPassword, $user['password_hash'])) {
            return ['success' => false, 'error' => 'Current password is incorrect'];
        }
        
        $validation = $this->validatePassword($newPassword);
        if (!$validation['valid']) {
            return ['success' => false, 'errors' => $validation['errors']];
        }
        
        $newHash = $this->hashPassword($newPassword);
        $this->store->update('users', ['password_hash' => $newHash], ['id' => (string)$userId]);
        
        $this->logActivity($userId, 'password_changed', 'User changed password');
        
        return ['success' => true];
    }
    
    /**
     * Generate CSRF token
     */
    public function generateCsrfToken() {
        if (!isset($_SESSION['csrf_token'])) {
            $_SESSION['csrf_token'] = bin2hex(random_bytes($this->config['security']['csrf_token_length']));
        }
        return $_SESSION['csrf_token'];
    }
    
    /**
     * Verify CSRF token
     */
    public function verifyCsrfToken($token) {
        if (!isset($_SESSION['csrf_token'])) {
            return false;
        }
        return hash_equals($_SESSION['csrf_token'], $token);
    }
    
    // ==================== Private Helper Methods ====================
    
    private function hashPassword($password) {
        return password_hash(
            $password,
            $this->config['security']['password_algo'],
            $this->config['security']['password_options']
        );
    }
    
    private function verifyPassword($password, $hash) {
        return password_verify($password, $hash);
    }
    
    private function validateRegistration($username, $email, $password) {
        $errors = [];
        
        // Validate username
        $minLen = $this->config['validation']['username_min_length'];
        $maxLen = $this->config['validation']['username_max_length'];
        
        if (strlen($username) < $minLen || strlen($username) > $maxLen) {
            $errors[] = "Username must be between $minLen and $maxLen characters";
        }
        
        if (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {
            $errors[] = 'Username can only contain letters, numbers, and underscores';
        }
        
        // Validate email
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Invalid email address';
        }
        
        // Validate password
        $passwordValidation = $this->validatePassword($password);
        if (!$passwordValidation['valid']) {
            $errors = array_merge($errors, $passwordValidation['errors']);
        }
        
        return [
            'valid' => empty($errors),
            'errors' => $errors,
        ];
    }
    
    private function validatePassword($password) {
        $errors = [];
        $rules = $this->config['validation'];
        
        if (strlen($password) < $rules['password_min_length']) {
            $errors[] = 'Password must be at least ' . $rules['password_min_length'] . ' characters';
        }
        
        if ($rules['password_require_uppercase'] && !preg_match('/[A-Z]/', $password)) {
            $errors[] = 'Password must contain at least one uppercase letter';
        }
        
        if ($rules['password_require_lowercase'] && !preg_match('/[a-z]/', $password)) {
            $errors[] = 'Password must contain at least one lowercase letter';
        }
        
        if ($rules['password_require_number'] && !preg_match('/[0-9]/', $password)) {
            $errors[] = 'Password must contain at least one number';
        }
        
        if ($rules['password_require_special'] && !preg_match('/[^a-zA-Z0-9]/', $password)) {
            $errors[] = 'Password must contain at least one special character';
        }
        
        return [
            'valid' => empty($errors),
            'errors' => $errors,
        ];
    }
    
    private function userExists($username, $email) {
        $users = $this->store->fetchAll('users');
        foreach ($users as $user) {
            if ($user['username'] === $username || $user['email'] === $email) {
                return true;
            }
        }
        return false;
    }
    
    private function findUser($usernameOrEmail) {
        $users = $this->store->fetchAll('users');
        foreach ($users as $user) {
            if ($user['username'] === $usernameOrEmail || $user['email'] === $usernameOrEmail) {
                return $user;
            }
        }
        return null;
    }
    
    private function isRateLimited($usernameOrEmail, $ip) {
        $window = $this->config['security']['rate_limit_window'];
        $maxAttempts = $this->config['security']['max_login_attempts'];
        $cutoff = date('Y-m-d H:i:s', time() - $window);
        
        $attempts = $this->store->filter('login_attempts', function($attempt) use ($usernameOrEmail, $ip, $cutoff) {
            return ($attempt['username_or_email'] === $usernameOrEmail || $attempt['ip_address'] === $ip)
                && $attempt['success'] === '0'
                && $attempt['attempted_at'] > $cutoff;
        });
        
        return count($attempts) >= $maxAttempts;
    }
    
    private function isAccountLocked($user) {
        if (empty($user['locked_until'])) {
            return false;
        }
        
        $lockedUntil = strtotime($user['locked_until']);
        if ($lockedUntil > time()) {
            return true;
        }
        
        // Unlock account if lock period has passed
        $this->store->update('users', ['locked_until' => ''], ['id' => $user['id']]);
        return false;
    }
    
    private function incrementFailedAttempts($userId) {
        $user = $this->store->fetchOne('users', ['id' => (string)$userId]);
        $attempts = (int)($user['failed_login_attempts'] ?? 0) + 1;
        
        $updateData = ['failed_login_attempts' => (string)$attempts];
        
        // Lock account if max attempts reached
        if ($attempts >= $this->config['security']['max_login_attempts']) {
            $lockDuration = $this->config['security']['lockout_duration'];
            $updateData['locked_until'] = date('Y-m-d H:i:s', time() + $lockDuration);
        }
        
        $this->store->update('users', $updateData, ['id' => (string)$userId]);
    }
    
    private function resetFailedAttempts($userId) {
        $this->store->update('users', ['failed_login_attempts' => '0'], ['id' => (string)$userId]);
    }
    
    private function updateLastLogin($userId) {
        $this->store->update('users', ['last_login' => date('Y-m-d H:i:s')], ['id' => (string)$userId]);
    }
    
    private function createSession($userId, $rememberMe = false) {
        $sessionToken = bin2hex(random_bytes(32));
        $lifetime = $rememberMe ? 30 * 24 * 3600 : $this->config['security']['session_lifetime'];
        
        $this->store->insert('sessions', [
            'user_id' => (string)$userId,
            'session_token' => $sessionToken,
            'ip_address' => $this->getIpAddress(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'expires_at' => date('Y-m-d H:i:s', time() + $lifetime),
            'last_activity' => date('Y-m-d H:i:s'),
        ]);
        
        return $sessionToken;
    }
    
    private function logLoginAttempt($usernameOrEmail, $ip, $success) {
        $this->store->insert('login_attempts', [
            'username_or_email' => $usernameOrEmail,
            'ip_address' => $ip,
            'success' => $success ? '1' : '0',
            'attempted_at' => date('Y-m-d H:i:s'),
        ]);
    }
    
    private function logActivity($userId, $actionType, $actionDetails) {
        if (!$this->config['logging']['enabled']) {
            return;
        }
        
        $this->store->insert('activity_log', [
            'user_id' => (string)$userId,
            'action_type' => $actionType,
            'action_details' => $actionDetails,
            'ip_address' => $this->getIpAddress(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
        ]);
    }
    
    private function getIpAddress() {
        // Handle proxy headers safely to prevent IP spoofing
        if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            // X-Forwarded-For can contain multiple IPs (client, proxy1, proxy2)
            // Take the first IP (the client's IP) and validate it
            $ips = array_map('trim', explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']));
            $clientIp = $ips[0];
            if (filter_var($clientIp, FILTER_VALIDATE_IP)) {
                return $clientIp;
            }
        }
        
        if (!empty($_SERVER['HTTP_CLIENT_IP']) && filter_var($_SERVER['HTTP_CLIENT_IP'], FILTER_VALIDATE_IP)) {
            return $_SERVER['HTTP_CLIENT_IP'];
        }
        
        return $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';
    }
    
    /**
     * Get user statistics
     */
    public function getUserStats($userId) {
        $user = $this->store->fetchOne('users', ['id' => (string)$userId]);
        
        if (!$user) {
            return null;
        }
        
        $loginAttempts = $this->store->filter('login_attempts', function($attempt) use ($user) {
            return $attempt['username_or_email'] === $user['username'] && $attempt['success'] === '1';
        });
        
        $activities = $this->store->fetchAll('activity_log', ['user_id' => (string)$userId]);
        
        return [
            'member_since' => $user['created_at'] ?? '',
            'last_login' => $user['last_login'] ?? '',
            'total_logins' => count($loginAttempts),
            'total_activities' => count($activities),
        ];
    }
}


--- End of Auth.php ---



--- Start of config.example.php ---

<?php
/**
 * Authentication System Configuration
 * 
 * Copy this file to config.php and update with your settings
 * DO NOT commit config.php to version control
 */

return [
    // Storage configuration (CSV files)
    'storage' => [
        'data_dir' => __DIR__ . '/data',  // Where CSV files are stored
    ],
    
    // Security settings
    'security' => [
        // Password hashing (PASSWORD_ARGON2ID is recommended for 2026)
        'password_algo' => PASSWORD_ARGON2ID,
        'password_options' => [
            'memory_cost' => 65536,  // 64 MB
            'time_cost' => 4,
            'threads' => 3,
        ],
        
        // Session settings
        'session_name' => 'WORKOUT_SESSION',
        'session_lifetime' => 86400, // 24 hours in seconds
        'session_cookie_secure' => true,  // Require HTTPS
        'session_cookie_httponly' => true,
        'session_cookie_samesite' => 'Strict',
        
        // CSRF protection
        'csrf_token_name' => 'csrf_token',
        'csrf_token_length' => 32,
        
        // Rate limiting
        'max_login_attempts' => 5,
        'lockout_duration' => 900, // 15 minutes in seconds
        'rate_limit_window' => 900, // 15 minutes
    ],
    
    // Application settings
    'app' => [
        'name' => 'Workout Tracker',
        'base_url' => 'http://localhost/Workout',
        'require_email_verification' => false,
        'enable_2fa' => false,
        'admin_email' => 'admin@example.com',
    ],
    
    // Validation rules
    'validation' => [
        'username_min_length' => 3,
        'username_max_length' => 50,
        'password_min_length' => 8,
        'password_require_uppercase' => true,
        'password_require_lowercase' => true,
        'password_require_number' => true,
        'password_require_special' => true,
    ],
    
    // Logging
    'logging' => [
        'enabled' => true,
        'log_failed_logins' => true,
        'log_successful_logins' => true,
        'log_registrations' => true,
        'log_password_changes' => true,
    ],
];


--- End of config.example.php ---



--- Start of config.php ---

<?php
/**
 * Simple Auth Configuration for CRM
 * 
 * IMPORTANT: Keep this file secure and do not commit to version control
 * Update for your production environment
 */

return [
    // Storage configuration (CSV files)
    'storage' => [
        'data_dir' => __DIR__ . '/data',  // Where CSV files are stored
    ],
    
    // Security settings
    'security' => [
        // Password hashing (PASSWORD_ARGON2ID is recommended for 2026)
        'password_algo' => PASSWORD_ARGON2ID,
        'password_options' => [
            'memory_cost' => 65536,  // 64 MB
            'time_cost' => 4,
            'threads' => 3,
        ],
        
        // Session settings
        'session_name' => 'CRM_SESSION',
        'session_lifetime' => 86400, // 24 hours in seconds
        // PRODUCTION: Set to true when using HTTPS
        'session_cookie_secure' => false,  // localhost = false, HTTPS = true
        'session_cookie_httponly' => true,  // Prevent JavaScript access to cookies
        'session_cookie_samesite' => 'Lax',  // Changed from Strict to Lax for localhost compatibility
        
        // CSRF protection
        'csrf_token_name' => 'csrf_token',
        'csrf_token_length' => 32,
        
        // DEVELOPMENT ONLY: Bypass CSRF on localhost if cookies aren't working
        // ‚ö†Ô∏è SET TO FALSE IN PRODUCTION!
        'dev_bypass_csrf' => true,  // Temporary fix for cookie issues
        
        // Rate limiting
        'max_login_attempts' => 5,
        'lockout_duration' => 900, // 15 minutes in seconds
        'rate_limit_window' => 900, // 15 minutes
    ],
    
    // Application settings
    'app' => [
        'name' => 'CRM System',
        'base_url' => 'http://localhost/CRM',
        'require_email_verification' => false,
        'enable_2fa' => false,
        'admin_email' => 'admin@example.com',
    ],
    
    // Validation rules
    'validation' => [
        'username_min_length' => 3,
        'username_max_length' => 50,
        'password_min_length' => 8,
        'password_require_uppercase' => true,
        'password_require_lowercase' => true,
        'password_require_number' => true,
        'password_require_special' => true,
    ],
    
    // Logging
    'logging' => [
        'enabled' => true,
        'log_failed_logins' => true,
        'log_successful_logins' => true,
        'log_registrations' => true,
        'log_password_changes' => true,
    ],
];


--- End of config.php ---



--- Start of CsvDataStore.php ---

<?php
/**
 * CSV Data Handler
 * 
 * Provides CSV-based data storage for authentication system
 * Alternative to database storage
 */

class CsvDataStore {
    private $dataDir;
    private $config;
    
    public function __construct($config) {
        $this->config = $config;
        $this->dataDir = $config['storage']['data_dir'];
        
        // Create data directory if it doesn't exist
        if (!is_dir($this->dataDir)) {
            mkdir($this->dataDir, 0755, true);
        }
        
        // Initialize CSV files if they don't exist
        $this->initializeFiles();
    }
    
    /**
     * Initialize CSV files with headers
     */
    private function initializeFiles() {
        $files = [
            'users.csv' => ['id', 'username', 'email', 'password_hash', 'role', 'created_at', 'updated_at', 'last_login', 'is_active', 'is_verified', 'verification_token', 'reset_token', 'reset_token_expires', 'failed_login_attempts', 'locked_until'],
            'sessions.csv' => ['id', 'user_id', 'session_token', 'ip_address', 'user_agent', 'created_at', 'expires_at', 'last_activity'],
            'login_attempts.csv' => ['id', 'username_or_email', 'ip_address', 'success', 'attempted_at'],
            'activity_log.csv' => ['id', 'user_id', 'action_type', 'action_details', 'ip_address', 'user_agent', 'created_at'],
        ];
        
        foreach ($files as $filename => $headers) {
            $filepath = $this->dataDir . '/' . $filename;
            if (!file_exists($filepath)) {
                $fp = fopen($filepath, 'w');
                fputcsv($fp, $headers);
                fclose($fp);
            }
        }
    }
    
    /**
     * Read all records from a CSV file
     */
    private function readCsv($filename) {
        $filepath = $this->dataDir . '/' . $filename;
        $records = [];
        
        if (!file_exists($filepath)) {
            return $records;
        }
        
        $fp = fopen($filepath, 'r');
        $headers = fgetcsv($fp);
        
        if (!$headers) {
            fclose($fp);
            return $records;
        }
        
        while (($row = fgetcsv($fp)) !== false) {
            if (count($row) === count($headers)) {
                $record = array_combine($headers, $row);
                $records[] = $record;
            }
        }
        
        fclose($fp);
        return $records;
    }
    
    /**
     * Write all records to a CSV file
     */
    private function writeCsv($filename, $records, $headers) {
        $filepath = $this->dataDir . '/' . $filename;
        $tempFile = $filepath . '.tmp';
        
        $fp = fopen($tempFile, 'w');
        fputcsv($fp, $headers);
        
        foreach ($records as $record) {
            $row = [];
            foreach ($headers as $header) {
                $row[] = $record[$header] ?? '';
            }
            fputcsv($fp, $row);
        }
        
        fclose($fp);
        
        // Atomic replace
        rename($tempFile, $filepath);
    }
    
    /**
     * Insert a record
     */
    public function insert($table, $data) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        
        // Generate ID
        $maxId = 0;
        foreach ($records as $record) {
            if (isset($record['id']) && (int)$record['id'] > $maxId) {
                $maxId = (int)$record['id'];
            }
        }
        $data['id'] = $maxId + 1;
        
        // Add timestamp if not set
        if (!isset($data['created_at'])) {
            $data['created_at'] = date('Y-m-d H:i:s');
        }
        
        $records[] = $data;
        
        // Get headers from first record or data keys
        $headers = !empty($records[0]) ? array_keys($records[0]) : array_keys($data);
        
        $this->writeCsv($filename, $records, $headers);
        
        return $data['id'];
    }
    
    /**
     * Find one record
     */
    public function fetchOne($table, $where) {
        $records = $this->readCsv($table . '.csv');
        
        foreach ($records as $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            if ($match) {
                return $record;
            }
        }
        
        return null;
    }
    
    /**
     * Find all matching records
     */
    public function fetchAll($table, $where = []) {
        $records = $this->readCsv($table . '.csv');
        
        if (empty($where)) {
            return $records;
        }
        
        $results = [];
        foreach ($records as $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            if ($match) {
                $results[] = $record;
            }
        }
        
        return $results;
    }
    
    /**
     * Update records
     */
    public function update($table, $data, $where) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        $updated = false;
        
        // Add updated_at timestamp
        if (!isset($data['updated_at'])) {
            $data['updated_at'] = date('Y-m-d H:i:s');
        }
        
        foreach ($records as $index => $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            
            if ($match) {
                $records[$index] = array_merge($record, $data);
                $updated = true;
            }
        }
        
        if ($updated && !empty($records)) {
            $headers = array_keys($records[0]);
            $this->writeCsv($filename, $records, $headers);
        }
        
        return $updated;
    }
    
    /**
     * Delete records
     */
    public function delete($table, $where) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        $newRecords = [];
        
        foreach ($records as $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            
            if (!$match) {
                $newRecords[] = $record;
            }
        }
        
        if (!empty($newRecords)) {
            $headers = array_keys($newRecords[0]);
            $this->writeCsv($filename, $newRecords, $headers);
        } else {
            // Write empty file with headers
            $this->initializeFiles();
        }
        
        return true;
    }
    
    /**
     * Count records matching criteria
     */
    public function count($table, $where = []) {
        return count($this->fetchAll($table, $where));
    }
    
    /**
     * Execute a custom filter function
     */
    public function filter($table, callable $filterFunc) {
        $records = $this->readCsv($table . '.csv');
        return array_filter($records, $filterFunc);
    }
    
    /**
     * Clean up old records
     */
    public function cleanup($table, $field, $olderThan) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        $newRecords = [];
        $cutoffTime = strtotime($olderThan);
        
        foreach ($records as $record) {
            if (isset($record[$field])) {
                $recordTime = strtotime($record[$field]);
                if ($recordTime >= $cutoffTime) {
                    $newRecords[] = $record;
                }
            } else {
                $newRecords[] = $record;
            }
        }
        
        if (!empty($newRecords)) {
            $headers = array_keys($newRecords[0]);
            $this->writeCsv($filename, $newRecords, $headers);
        }
        
        return count($records) - count($newRecords);
    }
    
    /**
     * Lock file for atomic operations
     */
    private function lockFile($filepath) {
        $lockFile = $filepath . '.lock';
        $fp = fopen($lockFile, 'w');
        if (flock($fp, LOCK_EX)) {
            return ['fp' => $fp, 'lock' => $lockFile];
        }
        fclose($fp);
        return null;
    }
    
    /**
     * Unlock file
     */
    private function unlockFile($lock) {
        flock($lock['fp'], LOCK_UN);
        fclose($lock['fp']);
        @unlink($lock['lock']);
    }
}


--- End of CsvDataStore.php ---



--- Start of index.php ---

<?php
require_once __DIR__ . '/middleware.php';
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Login</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .auth-container {
            max-width: 550px;
            margin: 80px auto;
            padding: 50px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        .auth-container h1 {
            margin-bottom: 12px;
            color: #1e1b1b;
            font-size: 2.2rem;
            letter-spacing: -0.02em;
        }
        .auth-container .subtitle {
            color: #6b6b6b;
            margin-bottom: 40px;
            font-size: 1.05rem;
            line-height: 1.6;
        }
        .auth-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .auth-btn {
            flex: 1;
            min-width: 200px;
            padding: 16px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .auth-btn-primary {
            background: #1f7a4f;
            color: white;
        }
        .auth-btn-primary:hover {
            background: #175c3a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(31, 122, 79, 0.3);
        }
        .auth-btn-secondary {
            background: transparent;
            color: #1f7a4f;
            border-color: #1f7a4f;
        }
        .auth-btn-secondary:hover {
            background: #1f7a4f;
            color: white;
            transform: translateY(-2px);
        }
        .logged-in-content {
            text-align: center;
        }
        .welcome-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }
        .logged-in-content a {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #1f7a4f;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .logged-in-content a:hover {
            background: #175c3a;
            transform: translateY(-2px);
        }
        .divider {
            margin: 30px 0;
            text-align: center;
            color: #ccc;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="body-hub" style="background: radial-gradient(circle at 20% 20%, rgba(244, 182, 109, 0.25), transparent 45%), radial-gradient(circle at 80% 0%, rgba(31, 122, 79, 0.2), transparent 40%), linear-gradient(140deg, #f7f4ee 0%, #eef4ff 45%, #f5f9f1 100%); min-height: 100vh;">
    
    <div class="auth-container">
        <?php if (auth_check()): ?>
            <!-- Already logged in -->
            <div class="logged-in-content">
                <div class="welcome-icon">üí™</div>
                <h1>Welcome back!</h1>
                <p class="subtitle">
                    You're logged in as <strong><?= htmlspecialchars(auth_current_user()['username']) ?></strong>
                </p>
                <a href="../index.php">Go to CRM ‚Üí</a>
            </div>
        <?php else: ?>
            <!-- Not logged in -->
            <h1>CRM System</h1>
            <p class="subtitle">
                Manage customer relationships, track sales, and grow your business.
            </p>
            
            <div class="auth-buttons">
                <a href="register.php" class="auth-btn auth-btn-primary">Get Started</a>
                <a href="login.php" class="auth-btn auth-btn-secondary">Sign In</a>
            </div>
            
            <div class="divider">
                or return to <a href="../" style="color: #1f7a4f; text-decoration: none; font-weight: 600;">home</a>
            </div>
        <?php endif; ?>
    </div>

</body>
</html>


--- End of index.php ---



--- Start of install.php ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth System Installer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .step {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .step h2 { color: #333; margin-bottom: 10px; font-size: 18px; }
        .step p { color: #666; margin-bottom: 10px; line-height: 1.6; }
        .success { background: #e8f5e9; border-color: #4CAF50; }
        .error { background: #ffebee; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 20px;
            font-weight: 500;
        }
        .btn:hover { background: #45a049; }
        .checklist {
            list-style: none;
            margin: 15px 0;
        }
        .checklist li {
            padding: 8px 0;
            color: #666;
        }
        .checklist li:before {
            content: "‚ñ° ";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background: #f5f5f5;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Authentication System Installer</h1>
        <p class="subtitle">Set up secure CSV-based authentication for your PHP application (No database required!)</p>

        <?php
        $errors = [];
        $warnings = [];
        $success = [];
        
        // Check PHP version
        if (version_compare(PHP_VERSION, '7.4.0') >= 0) {
            $success[] = "PHP version " . PHP_VERSION . " is supported";
        } else {
            $errors[] = "PHP 7.4 or higher required. Current version: " . PHP_VERSION;
        }
        
        // Check for required functions
        if (function_exists('password_hash')) {
            $success[] = "Password hashing functions available";
        } else {
            $errors[] = "Password hashing functions not available";
        }
        
        // Check if Argon2ID is available
        if (defined('PASSWORD_ARGON2ID')) {
            $success[] = "Argon2ID password hashing available (recommended)";
        } else {
            $warnings[] = "Argon2ID not available. Will fall back to bcrypt.";
        }
        
        // Check if config exists
        $configExists = file_exists(__DIR__ . '/config.php');
        if ($configExists) {
            $success[] = "Configuration file exists";
        } else {
            $warnings[] = "Configuration file not found. Copy config.example.php to config.php";
        }
        
        // Check data directory
        $dataDir = __DIR__ . '/data';
        if (is_dir($dataDir)) {
            $success[] = "Data directory exists";
            
            // Check if writable
            if (is_writable($dataDir)) {
                $success[] = "Data directory is writable";
            } else {
                $errors[] = "Data directory is not writable. Run: chmod 755 " . $dataDir;
            }
            
            // Check for CSV files
            $csvFiles = ['users.csv', 'sessions.csv', 'login_attempts.csv', 'activity_log.csv'];
            $existingFiles = [];
            foreach ($csvFiles as $file) {
                if (file_exists($dataDir . '/' . $file)) {
                    $existingFiles[] = $file;
                }
            }
            
            if (count($existingFiles) === count($csvFiles)) {
                $success[] = "All CSV data files exist";
            } elseif (count($existingFiles) > 0) {
                $success[] = "Some CSV files exist: " . implode(', ', $existingFiles);
                $warnings[] = "Missing CSV files will be created automatically on first use";
            } else {
                $warnings[] = "No CSV files yet. They will be created automatically when you register the first user.";
            }
        } else {
            $warnings[] = "Data directory will be created automatically on first use";
        }
        ?>
        
        <?php if (!empty($success)): ?>
            <div class="step success">
                <h2>‚úÖ System Checks Passed</h2>
                <?php foreach ($success as $msg): ?>
                    <p>‚úì <?= htmlspecialchars($msg) ?></p>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <?php if (!empty($warnings)): ?>
            <div class="step warning">
                <h2>‚ö†Ô∏è Warnings</h2>
                <?php foreach ($warnings as $msg): ?>
                    <p>‚ö† <?= htmlspecialchars($msg) ?></p>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <?php if (!empty($errors)): ?>
            <div class="step error">
                <h2>‚ùå Errors</h2>
                <?php foreach ($errors as $msg): ?>
                    <p>‚úó <?= htmlspecialchars($msg) ?></p>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <div class="step">
            <h2>üìã Installation Steps</h2>
            <ul class="checklist">
                <li>Copy config.example.php to config.php (optional - defaults work fine)</li>
                <li>Ensure auth/data/ directory is writable (chmod 755)</li>
                <li>Test registration at register.php</li>
                <li>Test login at login.php</li>
                <li>Add middleware to protected pages</li>
                <li>Add auth/data/ to .gitignore</li>
                <li>Enable HTTPS in production</li>
            </ul>
        </div>
        
        <div class="step">
            <h2>üìÅ Data Storage</h2>
            <p>This auth system uses <strong>CSV files</strong> stored in the <code>auth/data/</code> directory.</p>
            <p><strong>No database required!</strong> CSV files are created automatically when you register your first user.</p>
            <p style="margin-top: 10px;"><strong>Important:</strong> Add <code>auth/data/</code> to your <code>.gitignore</code> file to protect user data.</p>
        </div>
        
        <div class="step">
            <h2>üîß Configuration (Optional)</h2>
            <p>The default configuration works out of the box. To customize,copy <strong>config.example.php</strong> to <strong>config.php</strong> and edit:</p>
            <div class="code">'storage' => [<br>
    'data_dir' => __DIR__ . '/data',  // CSV files location<br>
],</div>
        </div>
        
        <div class="step">
            <h2>üõ°Ô∏è Protect Your Pages</h2>
            <p>Add this at the top of any page requiring authentication:</p>
            <div class="code">&lt;?php<br>
require_once __DIR__ . '/auth/middleware.php';<br>
// Your protected page code<br>
?&gt;</div>
        </div>
        
        <div class="step">
            <h2>üîó Quick Links</h2>
            <table>
                <tr>
                    <th>Page</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><a href="register.php">register.php</a></td>
                    <td>User registration page</td>
                </tr>
                <tr>
                    <td><a href="login.php">login.php</a></td>
                    <td>User login page</td>
                </tr>
                <tr>
                    <td><a href="logout.php">logout.php</a></td>
                    <td>Logout handler</td>
                </tr>
                <tr>
                    <td><a href="../index.php">../index.php</a></td>
                    <td>Main application (protect this)</td>
                </tr>
            </table>
        </div>
        
        <div class="step">
            <h2>üìö Documentation</h2>
            <p>For detailed information, see:</p>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>README.md</strong> - Full documentation and API reference</li>
                <li><strong>SETUP.md</strong> - Step-by-step setup guide</li>
                <li><strong>config.example.php</strong> - Configuration options</li>
            </ul>
        </div>
        
        <?php if (empty($errors) && empty($missingTables ?? [])): ?>
            <div class="step success">
                <h2>üéâ Ready to Go!</h2>
                <p>Your authenti): ?>
            <div class="step success">
                <h2>üéâ Ready to Go!</h2>
                <p>Your CSV-based authentication system is ready to use. No database setup needed!
        <?php endif; ?>
    </div>
</body>
</html>


--- End of install.php ---



--- Start of login.php ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - CRM System</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .auth-container {
            max-width: 450px;
            margin: 60px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-container h1 {
            margin-bottom: 10px;
            color: #333;
        }
        .auth-container .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .form-group-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .form-group-checkbox input {
            margin-right: 8px;
        }
        .form-group-checkbox label {
            margin: 0;
            font-weight: normal;
            color: #333;
        }
        .btn-auth {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-auth:hover {
            background: #45a049;
        }
        .btn-auth:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-msg {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c33;
        }
        .success-msg {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #363;
        }
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            color: #666;
        }
        .auth-footer a {
            color: #4CAF50;
            text-decoration: none;
        }
        .auth-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h1>CRM Login</h1>
        <p class="subtitle">Login to access your customer data and manage business relationships</p>
        
        <?php
        require_once __DIR__ . '/Auth.php';
        
        // Load config
        $configFile = __DIR__ . '/config.php';
        if (!file_exists($configFile)) {
            die('Configuration file not found. Please create auth/config.php from auth/config.example.php');
        }
        $config = require $configFile;
        
        $auth = new Auth($config);
        $error = null;
        
        // Check if already logged in
        if ($auth->isAuthenticated()) {
            header('Location: ../index.php');
            exit;
        }
        
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $usernameOrEmail = trim($_POST['username_or_email'] ?? '');
            $password = $_POST['password'] ?? '';
            $rememberMe = isset($_POST['remember_me']);
            $csrfToken = $_POST['csrf_token'] ?? '';
            
            // Verify CSRF token (with dev bypass for localhost cookie issues)
            $devBypass = ($config['security']['dev_bypass_csrf'] ?? false) && ($_SERVER['SERVER_NAME'] ?? '') === 'localhost';
            
            if (!$devBypass && !$auth->verifyCsrfToken($csrfToken)) {
                $error = 'Invalid security token. Please try again.';
            } else {
                $result = $auth->login($usernameOrEmail, $password, $rememberMe);
                
                if ($result['success']) {
                    // Redirect to main app
                    $redirectUrl = $_GET['redirect'] ?? '../index.php';
                    header('Location: ' . $redirectUrl);
                    exit;
                } else {
                    $error = $result['error'] ?? 'Login failed';
                }
            }
        }
        
        $csrfToken = $auth->generateCsrfToken();
        ?>
        
        <?php if ($error): ?>
            <div class="error-msg">
                <?= htmlspecialchars($error) ?>
            </div>
        <?php endif; ?>
        
        <?php if (isset($_GET['registered'])): ?>
            <div class="success-msg">
                Registration successful! Please login with your credentials.
            </div>
        <?php endif; ?>
        
        <form method="POST" action="">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            
            <div class="form-group">
                <label for="username_or_email">Username or Email</label>
                <input 
                    type="text" 
                    id="username_or_email" 
                    name="username_or_email" 
                    required
                    autocomplete="username"
                    value="<?= htmlspecialchars($_POST['username_or_email'] ?? '') ?>"
                >
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    required
                    autocomplete="current-password"
                >
            </div>
            
            <div class="form-group-checkbox">
                <input 
                    type="checkbox" 
                    id="remember_me" 
                    name="remember_me"
                >
                <label for="remember_me">Remember me for 30 days</label>
            </div>
            
            <button type="submit" class="btn-auth">Login</button>
        </form>
        
        <div class="auth-footer">
            Don't have an account? <a href="register.php">Register here</a>
        </div>
    </div>
</body>
</html>


--- End of login.php ---



--- Start of logout.php ---

<?php
/**
 * Logout Handler
 */

require_once __DIR__ . '/Auth.php';

// Load config
$configFile = __DIR__ . '/config.php';
if (!file_exists($configFile)) {
    die('Configuration file not found.');
}
$config = require $configFile;

$auth = new Auth($config);
$auth->logout();

// Redirect to auth landing page
header('Location: index.php');
exit;


--- End of logout.php ---



--- Start of maintenance.php ---

<?php
/**
 * Maintenance Script
 * 
 * Run this periodically to clean up old data
 */

require_once __DIR__ . '/CsvDataStore.php';

$config = require __DIR__ . '/config.php';
$store = new CsvDataStore($config);

echo "=== Auth System Maintenance ===\n\n";

// Clean expired sessions
echo "Cleaning expired sessions...\n";
$sessions = $store->fetchAll('sessions');
$expiredCount = 0;
foreach ($sessions as $session) {
    if (isset($session['expires_at']) && strtotime($session['expires_at']) < time()) {
        $expiredCount++;
    }
}
$store->cleanup('sessions', 'expires_at', date('Y-m-d H:i:s'));
echo "Removed $expiredCount expired sessions\n\n";

// Clean old login attempts (keep last 30 days)
echo "Cleaning old login attempts...\n";
$cutoff = date('Y-m-d H:i:s', strtotime('-30 days'));
$removed = $store->cleanup('login_attempts', 'attempted_at', $cutoff);
echo "Removed $removed old login attempts\n\n";

// Clean old activity logs (keep last 90 days)
echo "Cleaning old activity logs...\n";
$cutoff = date('Y-m-d H:i:s', strtotime('-90 days'));
$removed = $store->cleanup('activity_log', 'created_at', $cutoff);
echo "Removed $removed old activity log entries\n\n";

// Show statistics
echo "=== Current Statistics ===\n";
echo "Total users: " . $store->count('users') . "\n";
echo "Active sessions: " . $store->count('sessions') . "\n";
echo "Login attempts (last 30 days): " . $store->count('login_attempts') . "\n";
echo "Activity logs (last 90 days): " . $store->count('activity_log') . "\n";

echo "\nMaintenance complete!\n";


--- End of maintenance.php ---



--- Start of middleware.php ---

<?php
/**
 * Authentication Middleware
 * 
 * Include this file at the top of any protected page
 * Usage: require_once __DIR__ . '/auth/middleware.php';
 */

require_once __DIR__ . '/Auth.php';

// Load configuration
$configFile = __DIR__ . '/config.php';
if (!file_exists($configFile)) {
    die('Authentication configuration not found. Please set up auth/config.php');
}

$config = require $configFile;

// Initialize auth
$auth = new Auth($config);

// Check if user is authenticated
if (!$auth->isAuthenticated()) {
    // Store the current URL for redirect after login
    $currentUrl = $_SERVER['REQUEST_URI'];
    // Construct proper login URL - login.php is in simple_auth/login.php
    $loginUrl = '/CRM/simple_auth/login.php?redirect=' . urlencode($currentUrl);
    
    header('Location: ' . $loginUrl);
    exit;
}

// Make auth and current user available globally
$GLOBALS['auth'] = $auth;
$GLOBALS['current_user'] = $auth->getCurrentUser();

/**
 * Helper function to get current authenticated user
 */
function auth_current_user() {
    return $GLOBALS['current_user'] ?? null;
}

/**
 * Helper function to check if user is authenticated
 */
function auth_check() {
    return isset($GLOBALS['current_user']) && $GLOBALS['current_user'] !== null;
}

/**
 * Helper function to get auth instance
 */
function auth() {
    return $GLOBALS['auth'] ?? null;
}


--- End of middleware.php ---



--- Start of register.php ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - CRM System</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .auth-container {
            max-width: 450px;
            margin: 60px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-container h1 {
            margin-bottom: 10px;
            color: #333;
        }
        .auth-container .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .btn-auth {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-auth:hover {
            background: #45a049;
        }
        .btn-auth:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-list {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .error-list ul {
            margin: 0;
            padding-left: 20px;
            color: #c33;
        }
        .success-msg {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #363;
        }
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            color: #666;
        }
        .auth-footer a {
            color: #4CAF50;
            text-decoration: none;
        }
        .auth-footer a:hover {
            text-decoration: underline;
        }
        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h1>Create Account</h1>
        <p class="subtitle">Register to access the CRM and manage your business</p>
        
        <?php
        require_once __DIR__ . '/Auth.php';
        
        // Load config
        $configFile = __DIR__ . '/config.php';
        if (!file_exists($configFile)) {
            die('Configuration file not found. Please create auth/config.php from auth/config.example.php');
        }
        $config = require $configFile;
        
        $auth = new Auth($config);
        $errors = [];
        $success = false;
        
        // Track CSRF retry attempts
        $csrfRetryKey = 'csrf_retry_' . md5($_SERVER['REMOTE_ADDR'] ?? 'unknown');
        
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $username = trim($_POST['username'] ?? '');
            $email = trim($_POST['email'] ?? '');
            $password = $_POST['password'] ?? '';
            $confirmPassword = $_POST['confirm_password'] ?? '';
            $csrfToken = $_POST['csrf_token'] ?? '';
            
            // Verify CSRF token
            $devBypass = ($config['security']['dev_bypass_csrf'] ?? false) && ($_SERVER['SERVER_NAME'] ?? '') === 'localhost';
            
            if (!$devBypass && !$auth->verifyCsrfToken($csrfToken)) {
                // Check if this is a retry with the regenerated token
                $retryCount = $_SESSION[$csrfRetryKey] ?? 0;
                
                if ($retryCount < 2) {
                    // Allow up to 2 retries - regenerate token
                    $auth->generateCsrfToken();
                    $_SESSION[$csrfRetryKey] = $retryCount + 1;
                    $errors[] = 'Security token expired or invalid. This can happen if you left the page open too long. Please try submitting again (the form has been refreshed).';
                } else {
                    // Too many retries - might be an attack
                    $errors[] = 'Unable to verify security token after multiple attempts. Please refresh the page and try again.';
                    $_SESSION[$csrfRetryKey] = 0;
                }
            } elseif ($password !== $confirmPassword) {
                $errors[] = 'Passwords do not match';
            } else {
                // Reset retry counter on successful CSRF validation
                $_SESSION[$csrfRetryKey] = 0;
                
                $result = $auth->register($username, $email, $password);
                
                if ($result['success']) {
                    $success = true;
                    if ($result['requires_verification']) {
                        $successMessage = 'Registration successful! Please check your email to verify your account.';
                    } else {
                        $successMessage = 'Registration successful! You can now <a href="login.php">login</a>.';
                    }
                } else {
                    $errors = $result['errors'] ?? ['Registration failed'];
                }
            }
        }
        
        $csrfToken = $auth->generateCsrfToken();
        
        // Development debug info (only on localhost)
        $showDebug = ($_SERVER['SERVER_NAME'] ?? '') === 'localhost' || ($_SERVER['REMOTE_ADDR'] ?? '') === '127.0.0.1';
        ?>
        
        <?php if ($showDebug): ?>
            <div style="background: #f0f0f0; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; font-size: 11px; font-family: monospace;">
                <strong>Debug Info (localhost only):</strong><br>
                Session ID: <?= htmlspecialchars(session_id()) ?><br>
                CSRF Token: <?= htmlspecialchars(substr($csrfToken, 0, 16)) ?>...<br>
                Cookie Received: <?= isset($_COOKIE[session_name()]) ? '‚úÖ Yes (session maintained)' : '‚ö†Ô∏è Not yet (first load is normal)' ?><br>
                <?php if ($_SERVER['REQUEST_METHOD'] === 'POST'): ?>
                    <strong style="color: #c33;">POST Request - Cookie MUST be present for CSRF to work!</strong><br>
                <?php endif; ?>
                <?php if ($config['security']['dev_bypass_csrf'] ?? false): ?>
                    <div style="background: #fff3cd; color: #856404; padding: 8px; margin-top: 5px; border: 1px solid #ffc107; border-radius: 3px;">
                        ‚ö†Ô∏è <strong>DEV MODE:</strong> CSRF bypass is ENABLED for localhost testing
                    </div>
                <?php endif; ?>
            </div>
        <?php endif; ?>        
        <?php if (!empty($errors)): ?>
            <div class="error-list">
                <ul>
                    <?php foreach ($errors as $error): ?>
                        <li><?= htmlspecialchars($error) ?></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>
        
        <?php if ($success): ?>
            <div class="success-msg">
                <?= $successMessage ?>
            </div>
        <?php else: ?>
            <form method="POST" action="">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
                
                <div class="form-group">
                    <label for="username">Username</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        minlength="<?= $config['validation']['username_min_length'] ?>"
                        maxlength="<?= $config['validation']['username_max_length'] ?>"
                        pattern="[a-zA-Z0-9_]+"
                        value="<?= htmlspecialchars($_POST['username'] ?? '') ?>"
                    >
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required
                        value="<?= htmlspecialchars($_POST['email'] ?? '') ?>"
                    >
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required
                        minlength="<?= $config['validation']['password_min_length'] ?>"
                    >
                    <div class="password-requirements">
                        Must be at least <?= $config['validation']['password_min_length'] ?> characters
                        <?php if ($config['validation']['password_require_uppercase']): ?>, include uppercase<?php endif; ?>
                        <?php if ($config['validation']['password_require_lowercase']): ?>, lowercase<?php endif; ?>
                        <?php if ($config['validation']['password_require_number']): ?>, number<?php endif; ?>
                        <?php if ($config['validation']['password_require_special']): ?>, and special character<?php endif; ?>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <input 
                        type="password" 
                        id="confirm_password" 
                        name="confirm_password" 
                        required
                    >
                </div>
                
                <button type="submit" class="btn-auth">Create Account</button>
            </form>
        <?php endif; ?>
        
        <div class="auth-footer">
            Already have an account? <a href="login.php">Login here</a>
        </div>
    </div>
</body>
</html>


--- End of register.php ---



--- Start of security_headers.php ---

<?php
/**
 * Security Headers
 * 
 * Include this file to add security headers to responses
 * Usage: require_once __DIR__ . '/auth/security_headers.php';
 */

// Prevent clickjacking
header('X-Frame-Options: DENY');

// Prevent MIME type sniffing
header('X-Content-Type-Options: nosniff');

// Enable XSS protection
header('X-XSS-Protection: 1; mode=block');

// Referrer policy
header('Referrer-Policy: strict-origin-when-cross-origin');

// Content Security Policy (adjust as needed)
header("Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;");

// Enforce HTTPS (uncomment when using HTTPS)
// header('Strict-Transport-Security: max-age=31536000; includeSubDomains; preload');

// Permissions policy
header('Permissions-Policy: geolocation=(), microphone=(), camera=()');


--- End of security_headers.php ---



--- Start of setup.php ---

<?php
/**
 * Simple Auth Interactive Setup
 * 
 * Auto-generates config.php with project-specific settings
 * Run once per project: php setup.php
 */

// Prevent running in web browser - CLI only
if (PHP_SAPI !== 'cli') {
    // For web browser: show a simple HTML form
    handleWebSetup();
    exit;
}

// CLI mode
runCliSetup();

/**
 * CLI Setup - Interactive command line setup
 */
function runCliSetup() {
    echo "\n";
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
    echo "‚ïë     Simple Auth - Interactive Setup                           ‚ïë\n";
    echo "‚ïë     https://github.com/Robertja98/simple_auth                 ‚ïë\n";
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";
    
    // Check if config already exists
    $configPath = __DIR__ . '/config.php';
    if (file_exists($configPath)) {
        echo "‚ö†Ô∏è  config.php already exists!\n";
        echo "Do you want to overwrite it? (y/n): ";
        $response = trim(fgets(STDIN));
        if (strtolower($response) !== 'y') {
            echo "Setup cancelled.\n";
            return;
        }
        echo "\n";
    }
    
    // Gather configuration
    echo "üìù Project Configuration\n";
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
    
    $config = [
        'project_name' => ask('Project Name (e.g., "My CRM System")', 'Auth System'),
        'session_name' => ask('Session Name (unique identifier for cookies)', 'SIMPLE_AUTH_SESSION'),
        'base_url' => ask('Base URL (e.g., "http://localhost/myproject")', 'http://localhost/project'),
        'use_https' => ask('Using HTTPS in production? (y/n)', 'n'),
        'require_email_verification' => ask('Require email verification? (y/n)', 'n'),
        'enable_2fa' => ask('Enable 2FA? (y/n)', 'n'),
        'admin_email' => ask('Admin email address', 'admin@example.com'),
    ];
    
    // Generate config.php
    echo "\n\n‚ú® Generating config.php...\n";
    generateConfigFile($config);
    
    // Create data directory
    echo "üìÅ Creating data directory...\n";
    $dataDir = __DIR__ . '/data';
    if (!is_dir($dataDir)) {
        mkdir($dataDir, 0755, true);
        echo "‚úì Directory created: $dataDir\n";
    } else {
        echo "‚úì Directory already exists: $dataDir\n";
    }
    
    // Set permissions
    if (PHP_OS_FAMILY === 'Windows') {
        echo "üîê Windows: Using icacls for permissions\n";
        echo "Run this command as Administrator if needed:\n";
        echo "   icacls \"" . $dataDir . "\" /grant \"IUSR:(OI)(CI)F\" /inheritance:e\n";
    } else {
        chmod($dataDir, 0755);
        echo "‚úì Permissions set: 755\n";
    }
    
    echo "\n";
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
    echo "‚ïë ‚úÖ Setup Complete!                                             ‚ïë\n";
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";
    
    echo "Next steps:\n";
    echo "  1. Set file permissions (see above)\n";
    echo "  2. Visit: install.php to verify installation\n";
    echo "  3. Visit: test.php to test functionality\n";
    echo "  4. Add this to your protected pages:\n";
    echo "     <?php require_once __DIR__ . '/simple_auth/middleware.php'; ?>\n\n";
}

/**
 * Web Setup - HTML form for browser
 */
function handleWebSetup() {
    $configPath = __DIR__ . '/config.php';
    $configExists = file_exists($configPath);
    
    $projectName = $_POST['project_name'] ?? 'Auth System';
    $sessionName = $_POST['session_name'] ?? 'SIMPLE_AUTH_SESSION';
    $baseUrl = $_POST['base_url'] ?? 'http://localhost/project';
    $useHttps = isset($_POST['use_https']) ? 'y' : 'n';
    $requireEmailVerification = isset($_POST['require_email_verification']) ? 'y' : 'n';
    $enable2fa = isset($_POST['enable_2fa']) ? 'y' : 'n';
    $adminEmail = $_POST['admin_email'] ?? 'admin@example.com';
    
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['setup_submit'])) {
        if ($configExists && !isset($_POST['overwrite'])) {
            $error = "config.php already exists. Check 'Overwrite' to replace it.";
        } else {
            $config = [
                'project_name' => $projectName,
                'session_name' => $sessionName,
                'base_url' => $baseUrl,
                'use_https' => $useHttps,
                'require_email_verification' => $requireEmailVerification,
                'enable_2fa' => $enable2fa,
                'admin_email' => $adminEmail,
            ];
            
            generateConfigFile($config);
            
            $dataDir = __DIR__ . '/data';
            if (!is_dir($dataDir)) {
                mkdir($dataDir, 0755, true);
            }
            
            $success = "‚úÖ Setup complete! config.php has been created.";
        }
    }
    ?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simple Auth Setup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: monospace;
        }
        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert-error {
            background: #fee;
            border-color: #f99;
            color: #c33;
        }
        .alert-success {
            background: #efe;
            border-color: #9f9;
            color: #3c3;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        .small {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .next-steps {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 20px;
            margin-top: 20px;
        }
        .next-steps h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .next-steps ol {
            margin-left: 20px;
            color: #666;
            line-height: 1.6;
        }
        .next-steps a {
            color: #667eea;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Simple Auth Setup</h1>
        <p class="subtitle">Configure your authentication module</p>
        
        <?php if (isset($error)): ?>
            <div class="alert alert-error"><?= htmlspecialchars($error) ?></div>
        <?php endif; ?>
        
        <?php if (isset($success)): ?>
            <div class="alert alert-success"><?= htmlspecialchars($success) ?></div>
            <div class="next-steps">
                <h3>‚úÖ Next Steps</h3>
                <ol>
                    <li>Visit <a href="install.php">install.php</a> to verify installation</li>
                    <li>Visit <a href="test.php">test.php</a> to test the auth system</li>
                    <li>Add middleware to your protected pages:
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 5px; font-family: monospace; font-size: 12px;">
                            &lt;?php require_once __DIR__ . '/simple_auth/middleware.php'; ?&gt;
                        </div>
                    </li>
                </ol>
            </div>
        <?php else: ?>
        <form method="POST">
            <div class="form-group">
                <label for="project_name">Project Name</label>
                <input type="text" id="project_name" name="project_name" value="<?= htmlspecialchars($projectName) ?>" placeholder="e.g., My CRM System" required>
                <div class="small">Displayed on auth pages and config</div>
            </div>
            
            <div class="form-group">
                <label for="session_name">Session Name</label>
                <input type="text" id="session_name" name="session_name" value="<?= htmlspecialchars($sessionName) ?>" placeholder="e.g., MYPROJECT_SESSION" required>
                <div class="small">Unique identifier for session cookies (no spaces)</div>
            </div>
            
            <div class="form-group">
                <label for="base_url">Base URL</label>
                <input type="text" id="base_url" name="base_url" value="<?= htmlspecialchars($baseUrl) ?>" placeholder="e.g., http://localhost/myproject" required>
                <div class="small">Without trailing slash</div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="use_https" name="use_https" <?= $useHttps === 'y' ? 'checked' : '' ?>>
                    <label for="use_https" style="margin-bottom: 0;">Using HTTPS in production?</label>
                </div>
                <div class="small">Enables secure cookies</div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="require_email_verification" name="require_email_verification" <?= $requireEmailVerification === 'y' ? 'checked' : '' ?>>
                    <label for="require_email_verification" style="margin-bottom: 0;">Require email verification?</label>
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="enable_2fa" name="enable_2fa" <?= $enable2fa === 'y' ? 'checked' : '' ?>>
                    <label for="enable_2fa" style="margin-bottom: 0;">Enable 2FA?</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="admin_email">Admin Email</label>
                <input type="email" id="admin_email" name="admin_email" value="<?= htmlspecialchars($adminEmail) ?>" required>
            </div>
            
            <?php if ($configExists): ?>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="overwrite" name="overwrite">
                        <label for="overwrite" style="margin-bottom: 0;">I understand this will overwrite config.php</label>
                    </div>
                </div>
            <?php endif; ?>
            
            <button type="submit" name="setup_submit">Complete Setup</button>
        </form>
        <?php endif; ?>
    </div>
</body>
</html>
    <?php
}

/**
 * CLI helper: Ask question and get input
 */
function ask($question, $default = '') {
    echo "$question";
    if ($default) {
        echo " [$default]";
    }
    echo ": ";
    
    $input = trim(fgets(STDIN));
    return $input ?: $default;
}

/**
 * Generate config.php file
 */
function generateConfigFile($data) {
    $configContent = <<<'PHP'
<?php
/**
 * Simple Auth Configuration
 * 
 * AUTO-GENERATED by setup.php
 * DO NOT commit this file to version control
 * Add to .gitignore: simple_auth/config.php
 */

return [
    // Storage configuration (CSV files)
    'storage' => [
        'data_dir' => __DIR__ . '/data',
    ],
    
    // Security settings
    'security' => [
        'password_algo' => PASSWORD_ARGON2ID,
        'password_options' => [
            'memory_cost' => 65536,  // 64 MB
            'time_cost' => 4,
            'threads' => 3,
        ],
        
        'session_name' => '{SESSION_NAME}',
        'session_lifetime' => 86400,
        'session_cookie_secure' => {HTTPS_SETTING},
        'session_cookie_httponly' => true,
        'session_cookie_samesite' => 'Strict',
        
        'csrf_token_name' => 'csrf_token',
        'csrf_token_length' => 32,
        
        'max_login_attempts' => 5,
        'lockout_duration' => 900,
        'rate_limit_window' => 900,
    ],
    
    // Application settings
    'app' => [
        'name' => '{PROJECT_NAME}',
        'base_url' => '{BASE_URL}',
        'require_email_verification' => {EMAIL_VERIFICATION},
        'enable_2fa' => {2FA_ENABLED},
        'admin_email' => '{ADMIN_EMAIL}',
    ],
    
    // Validation rules
    'validation' => [
        'username_min_length' => 3,
        'username_max_length' => 50,
        'password_min_length' => 8,
        'password_require_uppercase' => true,
        'password_require_lowercase' => true,
        'password_require_number' => true,
        'password_require_special' => true,
    ],
    
    // Logging
    'logging' => [
        'enabled' => true,
        'log_failed_logins' => true,
        'log_successful_logins' => true,
        'log_registrations' => true,
        'log_password_changes' => true,
    ],
];
PHP;

    $https = $data['use_https'] === 'y' ? 'true' : 'false';
    $emailVerification = $data['require_email_verification'] === 'y' ? 'true' : 'false';
    $twofa = $data['enable_2fa'] === 'y' ? 'true' : 'false';
    
    $configContent = str_replace(
        ['{SESSION_NAME}', '{PROJECT_NAME}', '{BASE_URL}', '{HTTPS_SETTING}', '{EMAIL_VERIFICATION}', '{2FA_ENABLED}', '{ADMIN_EMAIL}'],
        [$data['session_name'], $data['project_name'], $data['base_url'], $https, $emailVerification, $twofa, $data['admin_email']],
        $configContent
    );
    
    file_put_contents(__DIR__ . '/config.php', $configContent);
    chmod(__DIR__ . '/config.php', 0644);
}
?>


--- End of setup.php ---



--- Start of test.php ---

<?php
/**
 * CSV Authentication System - Quick Test
 * 
 * Tests basic functionality of the CSV-based auth system
 */

require_once __DIR__ . '/Auth.php';

// Load config
$config = require __DIR__ . '/config.php';

echo "<h1>Auth System Test</h1>";
echo "<pre>";

try {
    $auth = new Auth($config);
    echo "‚úÖ Auth system initialized successfully\n\n";
    
    // Test user registration
    echo "Testing user registration...\n";
    $testUsername = 'testuser_' . time();
    $testEmail = $testUsername . '@example.com';
    $testPassword = 'TestPass123!';
    
    $result = $auth->register($testUsername, $testEmail, $testPassword);
    
    if ($result['success']) {
        echo "‚úÖ Registration successful\n";
        echo "   User ID: " . $result['user_id'] . "\n\n";
        
        // Test login
        echo "Testing login...\n";
        $loginResult = $auth->login($testUsername, $testPassword);
        
        if ($loginResult['success']) {
            echo "‚úÖ Login successful\n";
            echo "   User: " . $loginResult['user']['username'] . "\n";
            echo "   Email: " . $loginResult['user']['email'] . "\n\n";
            
            // Test authentication check
            echo "Testing authentication check...\n";
            if ($auth->isAuthenticated()) {
                echo "‚úÖ User is authenticated\n\n";
                
                // Get current user
                $currentUser = $auth->getCurrentUser();
                echo "Current user details:\n";
                echo "   ID: " . $currentUser['id'] . "\n";
                echo "   Username: " . $currentUser['username'] . "\n";
                echo "   Email: " . $currentUser['email'] . "\n\n";
                
                // Test logout
                echo "Testing logout...\n";
                $auth->logout();
                
                if (!$auth->isAuthenticated()) {
                    echo "‚úÖ Logout successful\n\n";
                } else {
                    echo "‚ùå Logout failed\n\n";
                }
            } else {
                echo "‚ùå Authentication check failed\n\n";
            }
        } else {
            echo "‚ùå Login failed: " . $loginResult['error'] . "\n\n";
        }
    } else {
        echo "‚ùå Registration failed:\n";
        foreach ($result['errors'] as $error) {
            echo "   - $error\n";
        }
        echo "\n";
    }
    
    // Check data files
    echo "Checking CSV data files...\n";
    $dataDir = $config['storage']['data_dir'];
    $files = ['users.csv', 'sessions.csv', 'login_attempts.csv', 'activity_log.csv'];
    
    foreach ($files as $file) {
        $filepath = $dataDir . '/' . $file;
        if (file_exists($filepath)) {
            $size = filesize($filepath);
            $lines = count(file($filepath));
            echo "‚úÖ $file exists ($size bytes, $lines lines)\n";
        } else {
            echo "‚ùå $file not found\n";
        }
    }
    
    echo "\n=== Test Complete ===\n";
    echo "Check the auth/data/ directory to see the generated CSV files.\n";
    
} catch (Exception $e) {
    echo "‚ùå Error: " . $e->getMessage() . "\n";
    echo $e->getTraceAsString();
}

echo "</pre>";
?>


--- End of test.php ---



--- Start of test_permissions.php ---

<?php
echo "<h1>Permission Test</h1>";

$dataDir = __DIR__ . '/data';
$testFile = $dataDir . '/php_write_test.txt';

echo "<p>Data directory: <code>$dataDir</code></p>";
echo "<p>Directory exists: " . (is_dir($dataDir) ? "‚úÖ YES" : "‚ùå NO") . "</p>";
echo "<p>Directory readable: " . (is_readable($dataDir) ? "‚úÖ YES" : "‚ùå NO") . "</p>";
echo "<p>Directory writable: " . (is_writable($dataDir) ? "‚úÖ YES" : "‚ùå NO") . "</p>";

// Try to write a test file
echo "<h2>Write Test</h2>";
try {
    $content = "PHP test at " . date('Y-m-d H:i:s');
    $result = file_put_contents($testFile, $content);
    
    if ($result !== false) {
        echo "‚úÖ PHP successfully wrote to directory!<br>";
        
        // Try to read it back
        $read = file_get_contents($testFile);
        echo "‚úÖ PHP successfully read the file: <code>$read</code><br>";
        
        // Clean up
        unlink($testFile);
        echo "‚úÖ Test file cleaned up<br>";
    } else {
        echo "‚ùå PHP could not write to directory<br>";
    }
} catch (Exception $e) {
    echo "‚ùå Error: " . htmlspecialchars($e->getMessage()) . "<br>";
}

// Check if CSV files can be created
echo "<h2>CSV File Creation</h2>";
$csvFiles = ['users.csv', 'sessions.csv', 'login_attempts.csv', 'activity_log.csv'];
foreach ($csvFiles as $file) {
    $path = $dataDir . '/' . $file;
    echo "File <code>$file</code>: " . (file_exists($path) ? "‚úÖ EXISTS" : "‚è≥ NOT YET (will create on first use)") . "<br>";
}

echo "<h2>Result</h2>";
if (is_writable($dataDir)) {
    echo "<p style='color: green; font-weight: bold;'>‚úÖ All permissions OK! You can now register users.</p>";
    echo "<p><a href='register.php'>Go to Registration ‚Üí</a></p>";
} else {
    echo "<p style='color: red; font-weight: bold;'>‚ùå Directory still not writable by PHP</p>";
    echo "<p>Check the permissions or try using a different data directory location.</p>";
}
?>


--- End of test_permissions.php ---



--- Start of test_session.php ---

<?php
session_start();
header('Content-Type: text/plain');
echo "Session ID: " . session_id() . "\n";
echo "Session Name: " . session_name() . "\n";
echo "Cookie in Request: " . (isset($_COOKIE[session_name()]) ? 'YES' : 'NO') . "\n";
echo "Session Started: " . (session_status() === PHP_SESSION_ACTIVE ? 'YES' : 'NO') . "\n";
echo "\nAll Cookies Received:\n";
print_r($_COOKIE);
echo "\nSession Data:\n";
print_r($_SESSION);


--- End of test_session.php ---



--- Start of Auth.php ---

<?php
/**
 * Authentication System
 * 
 * Provides user registration, login, session management, and security features
 * Follows 2026 security best practices
 */

require_once __DIR__ . '/CsvDataStore.php';

class Auth {
    private $store;
    private $config;
    
    public function __construct($config) {
        $this->config = $config;
        $this->store = new CsvDataStore($config);
        $this->initSession();
    }
    
    /**
     * Initialize secure session
     */
    private function initSession() {
        if (session_status() === PHP_SESSION_NONE) {
            $security = $this->config['security'];
            
            // Set session cookie parameters before starting session
            session_set_cookie_params([
                'lifetime' => $security['session_lifetime'] ?? 86400,
                'path' => '/',
                'domain' => '',  // Empty for localhost
                'secure' => $security['session_cookie_secure'] ?? false,
                'httponly' => $security['session_cookie_httponly'] ?? true,
                'samesite' => $security['session_cookie_samesite'] ?? 'Lax'
            ]);
            
            ini_set('session.use_strict_mode', 1);
            ini_set('session.sid_length', 48);
            ini_set('session.sid_bits_per_character', 6);
            
            session_name($security['session_name']);
            session_start();
            
            // Regenerate session ID periodically
            if (!isset($_SESSION['created'])) {
                $_SESSION['created'] = time();
            } else if (time() - $_SESSION['created'] > 1800) {
                session_regenerate_id(true);
                $_SESSION['created'] = time();
            }
        }
    }
    
    /**
     * Register a new user
     */
    public function register($username, $email, $password) {
        // Validate input
        $validation = $this->validateRegistration($username, $email, $password);
        if (!$validation['valid']) {
            return ['success' => false, 'errors' => $validation['errors']];
        }
        
        // Check if user already exists
        if ($this->userExists($username, $email)) {
            return ['success' => false, 'errors' => ['Username or email already exists']];
        }
        
        // Hash password
        $passwordHash = $this->hashPassword($password);
        
        // Generate verification token
        $verificationToken = $this->config['app']['require_email_verification'] 
            ? bin2hex(random_bytes(32)) 
            : null;
            // Set default role (first user = admin, else user)
            $existingUsers = $this->store->fetchAll('users');
            $role = empty($existingUsers) ? 'admin' : 'user';
        
        try {
            // Insert user
            $userId = $this->store->insert('users', [
                'username' => $username,
                'email' => $email,
                'password_hash' => $passwordHash,
                    'role' => $role,
                'is_verified' => $verificationToken ? '0' : '1',
                'is_active' => '1',
                'verification_token' => $verificationToken ?? '',
                'reset_token' => '',
                'reset_token_expires' => '',
                'failed_login_attempts' => '0',
                'locked_until' => '',
                'last_login' => '',
            ]);
            
            // Log registration
            $this->logActivity($userId, 'user_registered', json_encode([
                'username' => $username,
                'email' => $email,
                    'role' => $role,
            ]));
            
            return [
                'success' => true,
                'user_id' => $userId,
                'requires_verification' => $verificationToken !== null,
                'verification_token' => $verificationToken,
            ];
            
        } catch (Exception $e) {
            error_log('Registration failed: ' . $e->getMessage());
            return ['success' => false, 'errors' => ['Registration failed']];
        }
    }
    
    /**
     * Authenticate user login
     */
    public function login($usernameOrEmail, $password, $rememberMe = false) {
        $ip = $this->getIpAddress();
        
        // Check rate limiting
        if ($this->isRateLimited($usernameOrEmail, $ip)) {
            return [
                'success' => false,
                'error' => 'Too many login attempts. Please try again later.',
            ];
        }
        
        // Find user
        $user = $this->findUser($usernameOrEmail);
        
        // Log attempt
        $this->logLoginAttempt($usernameOrEmail, $ip, false);
        
        if (!$user) {
            return ['success' => false, 'error' => 'Invalid credentials'];
        }
        
        // Check if account is locked
        if ($this->isAccountLocked($user)) {
            return ['success' => false, 'error' => 'Account is temporarily locked'];
        }
        
        // Verify password
        if (!$this->verifyPassword($password, $user['password_hash'])) {
            $this->incrementFailedAttempts($user['id']);
            return ['success' => false, 'error' => 'Invalid credentials'];
        }
        
        // Check if email verification is required
        if ($this->config['app']['require_email_verification'] && !$user['is_verified']) {
            return ['success' => false, 'error' => 'Please verify your email address'];
        }
        
        // Check if account is active
        if (!$user['is_active']) {
            return ['success' => false, 'error' => 'Account is disabled'];
        }
        
        // Successful login
        $this->logLoginAttempt($usernameOrEmail, $ip, true);
        $this->resetFailedAttempts($user['id']);
        $this->updateLastLogin($user['id']);
        
        // Create session
        $sessionToken = $this->createSession($user['id'], $rememberMe);
        
        // Set session variables
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['email'] = $user['email'];
            $_SESSION['role'] = $user['role'] ?? 'user';
        $_SESSION['session_token'] = $sessionToken;
        $_SESSION['ip_address'] = $ip;
        
        // Log activity
        $this->logActivity($user['id'], 'user_login', 'Successful login');
        
        return [
            'success' => true,
            'user' => [
                'id' => $user['id'],
                'username' => $user['username'],
                    'role' => $user['role'] ?? 'user',
                'email' => $user['email'],
            ],
        ];
    }
    
    /**
     * Logout user
     */
    public function logout() {
        if (isset($_SESSION['session_token'])) {
            // Delete session from storage
            $this->store->delete('sessions', ['session_token' => $_SESSION['session_token']]);
        }
        
        if (isset($_SESSION['user_id'])) {
            $this->logActivity($_SESSION['user_id'], 'user_logout', 'User logged out');
        }
        
        // Clear session
        $_SESSION = [];
        session_destroy();
        
        // Delete session cookie
        if (isset($_COOKIE[session_name()])) {
            setcookie(session_name(), '', time() - 3600, '/');
        }
        
        return ['success' => true];
    }
    
    /**
     * Check if user is authenticated
     */
    public function isAuthenticated() {
        if (!isset($_SESSION['user_id']) || !isset($_SESSION['session_token'])) {
            return false;
        }
        
        // Verify session in storage
        $session = $this->store->fetchOne('sessions', [
            'session_token' => $_SESSION['session_token'],
            'user_id' => (string)$_SESSION['user_id']
        ]);
        
        if (!$session) {
            return false;
        }
        
        // Check if session is expired
        if (isset($session['expires_at']) && strtotime($session['expires_at']) <= time()) {
            return false;
        }
        
        // Check IP address match (optional, can be disabled for mobile users)
        // if ($session['ip_address'] !== $this->getIpAddress()) {
        //     return false;
        // }
        
        return true;
    }
    
    /**
     * Get current authenticated user
     */
    public function getCurrentUser() {
        if (!$this->isAuthenticated()) {
            return null;
        }
        
        $user = $this->store->fetchOne('users', ['id' => (string)$_SESSION['user_id']]);
        
        if ($user) {
            // Return only safe fields
            $user = [
                'id' => $user['id'],
                'username' => $user['username'],
                'email' => $user['email'],
                'created_at' => $user['created_at'] ?? '',
                'last_login' => $user['last_login'] ?? '',
            ];
        }
        
        return $user ?: null;
    }
    
    /**
     * Change user password
     */
    public function changePassword($userId, $oldPassword, $newPassword) {
        $user = $this->store->fetchOne('users', ['id' => (string)$userId]);
        
        if (!$user) {
            return ['success' => false, 'error' => 'User not found'];
        }
        
        if (!$this->verifyPassword($oldPassword, $user['password_hash'])) {
            return ['success' => false, 'error' => 'Current password is incorrect'];
        }
        
        $validation = $this->validatePassword($newPassword);
        if (!$validation['valid']) {
            return ['success' => false, 'errors' => $validation['errors']];
        }
        
        $newHash = $this->hashPassword($newPassword);
        $this->store->update('users', ['password_hash' => $newHash], ['id' => (string)$userId]);
        
        $this->logActivity($userId, 'password_changed', 'User changed password');
        
        return ['success' => true];
    }
    
    /**
     * Generate CSRF token
     */
    public function generateCsrfToken() {
        if (!isset($_SESSION['csrf_token'])) {
            $_SESSION['csrf_token'] = bin2hex(random_bytes($this->config['security']['csrf_token_length']));
        }
        return $_SESSION['csrf_token'];
    }
    
    /**
     * Verify CSRF token
     */
    public function verifyCsrfToken($token) {
        if (!isset($_SESSION['csrf_token'])) {
            return false;
        }
        return hash_equals($_SESSION['csrf_token'], $token);
    }
    
    // ==================== Private Helper Methods ====================
    
    private function hashPassword($password) {
        return password_hash(
            $password,
            $this->config['security']['password_algo'],
            $this->config['security']['password_options']
        );
    }
    
    private function verifyPassword($password, $hash) {
        return password_verify($password, $hash);
    }
    
    private function validateRegistration($username, $email, $password) {
        $errors = [];
        
        // Validate username
        $minLen = $this->config['validation']['username_min_length'];
        $maxLen = $this->config['validation']['username_max_length'];
        
        if (strlen($username) < $minLen || strlen($username) > $maxLen) {
            $errors[] = "Username must be between $minLen and $maxLen characters";
        }
        
        if (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {
            $errors[] = 'Username can only contain letters, numbers, and underscores';
        }
        
        // Validate email
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Invalid email address';
        }
        
        // Validate password
        $passwordValidation = $this->validatePassword($password);
        if (!$passwordValidation['valid']) {
            $errors = array_merge($errors, $passwordValidation['errors']);
        }
        
        return [
            'valid' => empty($errors),
            'errors' => $errors,
        ];
    }
    
    private function validatePassword($password) {
        $errors = [];
        $rules = $this->config['validation'];
        
        if (strlen($password) < $rules['password_min_length']) {
            $errors[] = 'Password must be at least ' . $rules['password_min_length'] . ' characters';
        }
        
        if ($rules['password_require_uppercase'] && !preg_match('/[A-Z]/', $password)) {
            $errors[] = 'Password must contain at least one uppercase letter';
        }
        
        if ($rules['password_require_lowercase'] && !preg_match('/[a-z]/', $password)) {
            $errors[] = 'Password must contain at least one lowercase letter';
        }
        
        if ($rules['password_require_number'] && !preg_match('/[0-9]/', $password)) {
            $errors[] = 'Password must contain at least one number';
        }
        
        if ($rules['password_require_special'] && !preg_match('/[^a-zA-Z0-9]/', $password)) {
            $errors[] = 'Password must contain at least one special character';
        }
        
        return [
            'valid' => empty($errors),
            'errors' => $errors,
        ];
    }
    
    private function userExists($username, $email) {
        $users = $this->store->fetchAll('users');
        foreach ($users as $user) {
            if ($user['username'] === $username || $user['email'] === $email) {
                return true;
            }
        }
        return false;
    }
    
    private function findUser($usernameOrEmail) {
        $users = $this->store->fetchAll('users');
        foreach ($users as $user) {
            if ($user['username'] === $usernameOrEmail || $user['email'] === $usernameOrEmail) {
                return $user;
            }
        }
        return null;
    }
    
    private function isRateLimited($usernameOrEmail, $ip) {
        $window = $this->config['security']['rate_limit_window'];
        $maxAttempts = $this->config['security']['max_login_attempts'];
        $cutoff = date('Y-m-d H:i:s', time() - $window);
        
        $attempts = $this->store->filter('login_attempts', function($attempt) use ($usernameOrEmail, $ip, $cutoff) {
            return ($attempt['username_or_email'] === $usernameOrEmail || $attempt['ip_address'] === $ip)
                && $attempt['success'] === '0'
                && $attempt['attempted_at'] > $cutoff;
        });
        
        return count($attempts) >= $maxAttempts;
    }
    
    private function isAccountLocked($user) {
        if (empty($user['locked_until'])) {
            return false;
        }
        
        $lockedUntil = strtotime($user['locked_until']);
        if ($lockedUntil > time()) {
            return true;
        }
        
        // Unlock account if lock period has passed
        $this->store->update('users', ['locked_until' => ''], ['id' => $user['id']]);
        return false;
    }
    
    private function incrementFailedAttempts($userId) {
        $user = $this->store->fetchOne('users', ['id' => (string)$userId]);
        $attempts = (int)($user['failed_login_attempts'] ?? 0) + 1;
        
        $updateData = ['failed_login_attempts' => (string)$attempts];
        
        // Lock account if max attempts reached
        if ($attempts >= $this->config['security']['max_login_attempts']) {
            $lockDuration = $this->config['security']['lockout_duration'];
            $updateData['locked_until'] = date('Y-m-d H:i:s', time() + $lockDuration);
        }
        
        $this->store->update('users', $updateData, ['id' => (string)$userId]);
    }
    
    private function resetFailedAttempts($userId) {
        $this->store->update('users', ['failed_login_attempts' => '0'], ['id' => (string)$userId]);
    }
    
    private function updateLastLogin($userId) {
        $this->store->update('users', ['last_login' => date('Y-m-d H:i:s')], ['id' => (string)$userId]);
    }
    
    private function createSession($userId, $rememberMe = false) {
        $sessionToken = bin2hex(random_bytes(32));
        $lifetime = $rememberMe ? 30 * 24 * 3600 : $this->config['security']['session_lifetime'];
        
        $this->store->insert('sessions', [
            'user_id' => (string)$userId,
            'session_token' => $sessionToken,
            'ip_address' => $this->getIpAddress(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'expires_at' => date('Y-m-d H:i:s', time() + $lifetime),
            'last_activity' => date('Y-m-d H:i:s'),
        ]);
        
        return $sessionToken;
    }
    
    private function logLoginAttempt($usernameOrEmail, $ip, $success) {
        $this->store->insert('login_attempts', [
            'username_or_email' => $usernameOrEmail,
            'ip_address' => $ip,
            'success' => $success ? '1' : '0',
            'attempted_at' => date('Y-m-d H:i:s'),
        ]);
    }
    
    private function logActivity($userId, $actionType, $actionDetails) {
        if (!$this->config['logging']['enabled']) {
            return;
        }
        
        $this->store->insert('activity_log', [
            'user_id' => (string)$userId,
            'action_type' => $actionType,
            'action_details' => $actionDetails,
            'ip_address' => $this->getIpAddress(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
        ]);
    }
    
    private function getIpAddress() {
        // Handle proxy headers safely to prevent IP spoofing
        if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            // X-Forwarded-For can contain multiple IPs (client, proxy1, proxy2)
            // Take the first IP (the client's IP) and validate it
            $ips = array_map('trim', explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']));
            $clientIp = $ips[0];
            if (filter_var($clientIp, FILTER_VALIDATE_IP)) {
                return $clientIp;
            }
        }
        
        if (!empty($_SERVER['HTTP_CLIENT_IP']) && filter_var($_SERVER['HTTP_CLIENT_IP'], FILTER_VALIDATE_IP)) {
            return $_SERVER['HTTP_CLIENT_IP'];
        }
        
        return $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';
    }
    
    /**
     * Get user statistics
     */
    public function getUserStats($userId) {
        $user = $this->store->fetchOne('users', ['id' => (string)$userId]);
        
        if (!$user) {
            return null;
        }
        
        $loginAttempts = $this->store->filter('login_attempts', function($attempt) use ($user) {
            return $attempt['username_or_email'] === $user['username'] && $attempt['success'] === '1';
        });
        
        $activities = $this->store->fetchAll('activity_log', ['user_id' => (string)$userId]);
        
        return [
            'member_since' => $user['created_at'] ?? '',
            'last_login' => $user['last_login'] ?? '',
            'total_logins' => count($loginAttempts),
            'total_activities' => count($activities),
        ];
    }
}


--- End of Auth.php ---



--- Start of config.example.php ---

<?php
/**
 * Authentication System Configuration
 * 
 * Copy this file to config.php and update with your settings
 * DO NOT commit config.php to version control
 */

return [
    // Storage configuration (CSV files)
    'storage' => [
        'data_dir' => __DIR__ . '/data',  // Where CSV files are stored
    ],
    
    // Security settings
    'security' => [
        // Password hashing (PASSWORD_ARGON2ID is recommended for 2026)
        'password_algo' => PASSWORD_ARGON2ID,
        'password_options' => [
            'memory_cost' => 65536,  // 64 MB
            'time_cost' => 4,
            'threads' => 3,
        ],
        
        // Session settings
        'session_name' => 'WORKOUT_SESSION',
        'session_lifetime' => 86400, // 24 hours in seconds
        'session_cookie_secure' => true,  // Require HTTPS
        'session_cookie_httponly' => true,
        'session_cookie_samesite' => 'Strict',
        
        // CSRF protection
        'csrf_token_name' => 'csrf_token',
        'csrf_token_length' => 32,
        
        // Rate limiting
        'max_login_attempts' => 5,
        'lockout_duration' => 900, // 15 minutes in seconds
        'rate_limit_window' => 900, // 15 minutes
    ],
    
    // Application settings
    'app' => [
        'name' => 'Workout Tracker',
        'base_url' => 'http://localhost/Workout',
        'require_email_verification' => false,
        'enable_2fa' => false,
        'admin_email' => 'admin@example.com',
    ],
    
    // Validation rules
    'validation' => [
        'username_min_length' => 3,
        'username_max_length' => 50,
        'password_min_length' => 8,
        'password_require_uppercase' => true,
        'password_require_lowercase' => true,
        'password_require_number' => true,
        'password_require_special' => true,
    ],
    
    // Logging
    'logging' => [
        'enabled' => true,
        'log_failed_logins' => true,
        'log_successful_logins' => true,
        'log_registrations' => true,
        'log_password_changes' => true,
    ],
];


--- End of config.example.php ---



--- Start of config.php ---

<?php
/**
 * Simple Auth Configuration for CRM
 * 
 * IMPORTANT: Keep this file secure and do not commit to version control
 * Update for your production environment
 */

return [
    // Storage configuration (CSV files)
    'storage' => [
        'data_dir' => __DIR__ . '/data',  // Where CSV files are stored
    ],
    
    // Security settings
    'security' => [
        // Password hashing (PASSWORD_ARGON2ID is recommended for 2026)
        'password_algo' => PASSWORD_ARGON2ID,
        'password_options' => [
            'memory_cost' => 65536,  // 64 MB
            'time_cost' => 4,
            'threads' => 3,
        ],
        
        // Session settings
        'session_name' => 'CRM_SESSION',
        'session_lifetime' => 86400, // 24 hours in seconds
        // PRODUCTION: Set to true when using HTTPS
        'session_cookie_secure' => false,  // localhost = false, HTTPS = true
        'session_cookie_httponly' => true,  // Prevent JavaScript access to cookies
        'session_cookie_samesite' => 'Lax',  // Changed from Strict to Lax for localhost compatibility
        
        // CSRF protection
        'csrf_token_name' => 'csrf_token',
        'csrf_token_length' => 32,
        
        // DEVELOPMENT ONLY: Bypass CSRF on localhost if cookies aren't working
        // ‚ö†Ô∏è SET TO FALSE IN PRODUCTION!
        'dev_bypass_csrf' => true,  // Temporary fix for cookie issues
        
        // Rate limiting
        'max_login_attempts' => 5,
        'lockout_duration' => 900, // 15 minutes in seconds
        'rate_limit_window' => 900, // 15 minutes
    ],
    
    // Application settings
    'app' => [
        'name' => 'CRM System',
        'base_url' => 'http://localhost/CRM',
        'require_email_verification' => false,
        'enable_2fa' => false,
        'admin_email' => 'admin@example.com',
    ],
    
    // Validation rules
    'validation' => [
        'username_min_length' => 3,
        'username_max_length' => 50,
        'password_min_length' => 8,
        'password_require_uppercase' => true,
        'password_require_lowercase' => true,
        'password_require_number' => true,
        'password_require_special' => true,
    ],
    
    // Logging
    'logging' => [
        'enabled' => true,
        'log_failed_logins' => true,
        'log_successful_logins' => true,
        'log_registrations' => true,
        'log_password_changes' => true,
    ],
];


--- End of config.php ---



--- Start of CsvDataStore.php ---

<?php
/**
 * CSV Data Handler
 * 
 * Provides CSV-based data storage for authentication system
 * Alternative to database storage
 */

class CsvDataStore {
    private $dataDir;
    private $config;
    
    public function __construct($config) {
        $this->config = $config;
        $this->dataDir = $config['storage']['data_dir'];
        
        // Create data directory if it doesn't exist
        if (!is_dir($this->dataDir)) {
            mkdir($this->dataDir, 0755, true);
        }
        
        // Initialize CSV files if they don't exist
        $this->initializeFiles();
    }
    
    /**
     * Initialize CSV files with headers
     */
    private function initializeFiles() {
        $files = [
            'users.csv' => ['id', 'username', 'email', 'password_hash', 'role', 'created_at', 'updated_at', 'last_login', 'is_active', 'is_verified', 'verification_token', 'reset_token', 'reset_token_expires', 'failed_login_attempts', 'locked_until'],
            'sessions.csv' => ['id', 'user_id', 'session_token', 'ip_address', 'user_agent', 'created_at', 'expires_at', 'last_activity'],
            'login_attempts.csv' => ['id', 'username_or_email', 'ip_address', 'success', 'attempted_at'],
            'activity_log.csv' => ['id', 'user_id', 'action_type', 'action_details', 'ip_address', 'user_agent', 'created_at'],
        ];
        
        foreach ($files as $filename => $headers) {
            $filepath = $this->dataDir . '/' . $filename;
            if (!file_exists($filepath)) {
                $fp = fopen($filepath, 'w');
                fputcsv($fp, $headers);
                fclose($fp);
            }
        }
    }
    
    /**
     * Read all records from a CSV file
     */
    private function readCsv($filename) {
        $filepath = $this->dataDir . '/' . $filename;
        $records = [];
        
        if (!file_exists($filepath)) {
            return $records;
        }
        
        $fp = fopen($filepath, 'r');
        $headers = fgetcsv($fp);
        
        if (!$headers) {
            fclose($fp);
            return $records;
        }
        
        while (($row = fgetcsv($fp)) !== false) {
            if (count($row) === count($headers)) {
                $record = array_combine($headers, $row);
                $records[] = $record;
            }
        }
        
        fclose($fp);
        return $records;
    }
    
    /**
     * Write all records to a CSV file
     */
    private function writeCsv($filename, $records, $headers) {
        $filepath = $this->dataDir . '/' . $filename;
        $tempFile = $filepath . '.tmp';
        
        $fp = fopen($tempFile, 'w');
        fputcsv($fp, $headers);
        
        foreach ($records as $record) {
            $row = [];
            foreach ($headers as $header) {
                $row[] = $record[$header] ?? '';
            }
            fputcsv($fp, $row);
        }
        
        fclose($fp);
        
        // Atomic replace
        rename($tempFile, $filepath);
    }
    
    /**
     * Insert a record
     */
    public function insert($table, $data) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        
        // Generate ID
        $maxId = 0;
        foreach ($records as $record) {
            if (isset($record['id']) && (int)$record['id'] > $maxId) {
                $maxId = (int)$record['id'];
            }
        }
        $data['id'] = $maxId + 1;
        
        // Add timestamp if not set
        if (!isset($data['created_at'])) {
            $data['created_at'] = date('Y-m-d H:i:s');
        }
        
        $records[] = $data;
        
        // Get headers from first record or data keys
        $headers = !empty($records[0]) ? array_keys($records[0]) : array_keys($data);
        
        $this->writeCsv($filename, $records, $headers);
        
        return $data['id'];
    }
    
    /**
     * Find one record
     */
    public function fetchOne($table, $where) {
        $records = $this->readCsv($table . '.csv');
        
        foreach ($records as $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            if ($match) {
                return $record;
            }
        }
        
        return null;
    }
    
    /**
     * Find all matching records
     */
    public function fetchAll($table, $where = []) {
        $records = $this->readCsv($table . '.csv');
        
        if (empty($where)) {
            return $records;
        }
        
        $results = [];
        foreach ($records as $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            if ($match) {
                $results[] = $record;
            }
        }
        
        return $results;
    }
    
    /**
     * Update records
     */
    public function update($table, $data, $where) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        $updated = false;
        
        // Add updated_at timestamp
        if (!isset($data['updated_at'])) {
            $data['updated_at'] = date('Y-m-d H:i:s');
        }
        
        foreach ($records as $index => $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            
            if ($match) {
                $records[$index] = array_merge($record, $data);
                $updated = true;
            }
        }
        
        if ($updated && !empty($records)) {
            $headers = array_keys($records[0]);
            $this->writeCsv($filename, $records, $headers);
        }
        
        return $updated;
    }
    
    /**
     * Delete records
     */
    public function delete($table, $where) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        $newRecords = [];
        
        foreach ($records as $record) {
            $match = true;
            foreach ($where as $field => $value) {
                if (!isset($record[$field]) || $record[$field] !== $value) {
                    $match = false;
                    break;
                }
            }
            
            if (!$match) {
                $newRecords[] = $record;
            }
        }
        
        if (!empty($newRecords)) {
            $headers = array_keys($newRecords[0]);
            $this->writeCsv($filename, $newRecords, $headers);
        } else {
            // Write empty file with headers
            $this->initializeFiles();
        }
        
        return true;
    }
    
    /**
     * Count records matching criteria
     */
    public function count($table, $where = []) {
        return count($this->fetchAll($table, $where));
    }
    
    /**
     * Execute a custom filter function
     */
    public function filter($table, callable $filterFunc) {
        $records = $this->readCsv($table . '.csv');
        return array_filter($records, $filterFunc);
    }
    
    /**
     * Clean up old records
     */
    public function cleanup($table, $field, $olderThan) {
        $filename = $table . '.csv';
        $records = $this->readCsv($filename);
        $newRecords = [];
        $cutoffTime = strtotime($olderThan);
        
        foreach ($records as $record) {
            if (isset($record[$field])) {
                $recordTime = strtotime($record[$field]);
                if ($recordTime >= $cutoffTime) {
                    $newRecords[] = $record;
                }
            } else {
                $newRecords[] = $record;
            }
        }
        
        if (!empty($newRecords)) {
            $headers = array_keys($newRecords[0]);
            $this->writeCsv($filename, $newRecords, $headers);
        }
        
        return count($records) - count($newRecords);
    }
    
    /**
     * Lock file for atomic operations
     */
    private function lockFile($filepath) {
        $lockFile = $filepath . '.lock';
        $fp = fopen($lockFile, 'w');
        if (flock($fp, LOCK_EX)) {
            return ['fp' => $fp, 'lock' => $lockFile];
        }
        fclose($fp);
        return null;
    }
    
    /**
     * Unlock file
     */
    private function unlockFile($lock) {
        flock($lock['fp'], LOCK_UN);
        fclose($lock['fp']);
        @unlink($lock['lock']);
    }
}


--- End of CsvDataStore.php ---



--- Start of index.php ---

<?php
require_once __DIR__ . '/middleware.php';
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Login</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .auth-container {
            max-width: 550px;
            margin: 80px auto;
            padding: 50px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        .auth-container h1 {
            margin-bottom: 12px;
            color: #1e1b1b;
            font-size: 2.2rem;
            letter-spacing: -0.02em;
        }
        .auth-container .subtitle {
            color: #6b6b6b;
            margin-bottom: 40px;
            font-size: 1.05rem;
            line-height: 1.6;
        }
        .auth-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .auth-btn {
            flex: 1;
            min-width: 200px;
            padding: 16px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .auth-btn-primary {
            background: #1f7a4f;
            color: white;
        }
        .auth-btn-primary:hover {
            background: #175c3a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(31, 122, 79, 0.3);
        }
        .auth-btn-secondary {
            background: transparent;
            color: #1f7a4f;
            border-color: #1f7a4f;
        }
        .auth-btn-secondary:hover {
            background: #1f7a4f;
            color: white;
            transform: translateY(-2px);
        }
        .logged-in-content {
            text-align: center;
        }
        .welcome-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }
        .logged-in-content a {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #1f7a4f;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .logged-in-content a:hover {
            background: #175c3a;
            transform: translateY(-2px);
        }
        .divider {
            margin: 30px 0;
            text-align: center;
            color: #ccc;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="body-hub" style="background: radial-gradient(circle at 20% 20%, rgba(244, 182, 109, 0.25), transparent 45%), radial-gradient(circle at 80% 0%, rgba(31, 122, 79, 0.2), transparent 40%), linear-gradient(140deg, #f7f4ee 0%, #eef4ff 45%, #f5f9f1 100%); min-height: 100vh;">
    
    <div class="auth-container">
        <?php if (auth_check()): ?>
            <!-- Already logged in -->
            <div class="logged-in-content">
                <div class="welcome-icon">üí™</div>
                <h1>Welcome back!</h1>
                <p class="subtitle">
                    You're logged in as <strong><?= htmlspecialchars(auth_current_user()['username']) ?></strong>
                </p>
                <a href="../index.php">Go to CRM ‚Üí</a>
            </div>
        <?php else: ?>
            <!-- Not logged in -->
            <h1>CRM System</h1>
            <p class="subtitle">
                Manage customer relationships, track sales, and grow your business.
            </p>
            
            <div class="auth-buttons">
                <a href="register.php" class="auth-btn auth-btn-primary">Get Started</a>
                <a href="login.php" class="auth-btn auth-btn-secondary">Sign In</a>
            </div>
            
            <div class="divider">
                or return to <a href="../" style="color: #1f7a4f; text-decoration: none; font-weight: 600;">home</a>
            </div>
        <?php endif; ?>
    </div>

</body>
</html>


--- End of index.php ---



--- Start of install.php ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth System Installer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .step {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .step h2 { color: #333; margin-bottom: 10px; font-size: 18px; }
        .step p { color: #666; margin-bottom: 10px; line-height: 1.6; }
        .success { background: #e8f5e9; border-color: #4CAF50; }
        .error { background: #ffebee; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 20px;
            font-weight: 500;
        }
        .btn:hover { background: #45a049; }
        .checklist {
            list-style: none;
            margin: 15px 0;
        }
        .checklist li {
            padding: 8px 0;
            color: #666;
        }
        .checklist li:before {
            content: "‚ñ° ";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background: #f5f5f5;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Authentication System Installer</h1>
        <p class="subtitle">Set up secure CSV-based authentication for your PHP application (No database required!)</p>

        <?php
        $errors = [];
        $warnings = [];
        $success = [];
        
        // Check PHP version
        if (version_compare(PHP_VERSION, '7.4.0') >= 0) {
            $success[] = "PHP version " . PHP_VERSION . " is supported";
        } else {
            $errors[] = "PHP 7.4 or higher required. Current version: " . PHP_VERSION;
        }
        
        // Check for required functions
        if (function_exists('password_hash')) {
            $success[] = "Password hashing functions available";
        } else {
            $errors[] = "Password hashing functions not available";
        }
        
        // Check if Argon2ID is available
        if (defined('PASSWORD_ARGON2ID')) {
            $success[] = "Argon2ID password hashing available (recommended)";
        } else {
            $warnings[] = "Argon2ID not available. Will fall back to bcrypt.";
        }
        
        // Check if config exists
        $configExists = file_exists(__DIR__ . '/config.php');
        if ($configExists) {
            $success[] = "Configuration file exists";
        } else {
            $warnings[] = "Configuration file not found. Copy config.example.php to config.php";
        }
        
        // Check data directory
        $dataDir = __DIR__ . '/data';
        if (is_dir($dataDir)) {
            $success[] = "Data directory exists";
            
            // Check if writable
            if (is_writable($dataDir)) {
                $success[] = "Data directory is writable";
            } else {
                $errors[] = "Data directory is not writable. Run: chmod 755 " . $dataDir;
            }
            
            // Check for CSV files
            $csvFiles = ['users.csv', 'sessions.csv', 'login_attempts.csv', 'activity_log.csv'];
            $existingFiles = [];
            foreach ($csvFiles as $file) {
                if (file_exists($dataDir . '/' . $file)) {
                    $existingFiles[] = $file;
                }
            }
            
            if (count($existingFiles) === count($csvFiles)) {
                $success[] = "All CSV data files exist";
            } elseif (count($existingFiles) > 0) {
                $success[] = "Some CSV files exist: " . implode(', ', $existingFiles);
                $warnings[] = "Missing CSV files will be created automatically on first use";
            } else {
                $warnings[] = "No CSV files yet. They will be created automatically when you register the first user.";
            }
        } else {
            $warnings[] = "Data directory will be created automatically on first use";
        }
        ?>
        
        <?php if (!empty($success)): ?>
            <div class="step success">
                <h2>‚úÖ System Checks Passed</h2>
                <?php foreach ($success as $msg): ?>
                    <p>‚úì <?= htmlspecialchars($msg) ?></p>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <?php if (!empty($warnings)): ?>
            <div class="step warning">
                <h2>‚ö†Ô∏è Warnings</h2>
                <?php foreach ($warnings as $msg): ?>
                    <p>‚ö† <?= htmlspecialchars($msg) ?></p>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <?php if (!empty($errors)): ?>
            <div class="step error">
                <h2>‚ùå Errors</h2>
                <?php foreach ($errors as $msg): ?>
                    <p>‚úó <?= htmlspecialchars($msg) ?></p>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <div class="step">
            <h2>üìã Installation Steps</h2>
            <ul class="checklist">
                <li>Copy config.example.php to config.php (optional - defaults work fine)</li>
                <li>Ensure auth/data/ directory is writable (chmod 755)</li>
                <li>Test registration at register.php</li>
                <li>Test login at login.php</li>
                <li>Add middleware to protected pages</li>
                <li>Add auth/data/ to .gitignore</li>
                <li>Enable HTTPS in production</li>
            </ul>
        </div>
        
        <div class="step">
            <h2>üìÅ Data Storage</h2>
            <p>This auth system uses <strong>CSV files</strong> stored in the <code>auth/data/</code> directory.</p>
            <p><strong>No database required!</strong> CSV files are created automatically when you register your first user.</p>
            <p style="margin-top: 10px;"><strong>Important:</strong> Add <code>auth/data/</code> to your <code>.gitignore</code> file to protect user data.</p>
        </div>
        
        <div class="step">
            <h2>üîß Configuration (Optional)</h2>
            <p>The default configuration works out of the box. To customize,copy <strong>config.example.php</strong> to <strong>config.php</strong> and edit:</p>
            <div class="code">'storage' => [<br>
    'data_dir' => __DIR__ . '/data',  // CSV files location<br>
],</div>
        </div>
        
        <div class="step">
            <h2>üõ°Ô∏è Protect Your Pages</h2>
            <p>Add this at the top of any page requiring authentication:</p>
            <div class="code">&lt;?php<br>
require_once __DIR__ . '/auth/middleware.php';<br>
// Your protected page code<br>
?&gt;</div>
        </div>
        
        <div class="step">
            <h2>üîó Quick Links</h2>
            <table>
                <tr>
                    <th>Page</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><a href="register.php">register.php</a></td>
                    <td>User registration page</td>
                </tr>
                <tr>
                    <td><a href="login.php">login.php</a></td>
                    <td>User login page</td>
                </tr>
                <tr>
                    <td><a href="logout.php">logout.php</a></td>
                    <td>Logout handler</td>
                </tr>
                <tr>
                    <td><a href="../index.php">../index.php</a></td>
                    <td>Main application (protect this)</td>
                </tr>
            </table>
        </div>
        
        <div class="step">
            <h2>üìö Documentation</h2>
            <p>For detailed information, see:</p>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>README.md</strong> - Full documentation and API reference</li>
                <li><strong>SETUP.md</strong> - Step-by-step setup guide</li>
                <li><strong>config.example.php</strong> - Configuration options</li>
            </ul>
        </div>
        
        <?php if (empty($errors) && empty($missingTables ?? [])): ?>
            <div class="step success">
                <h2>üéâ Ready to Go!</h2>
                <p>Your authenti): ?>
            <div class="step success">
                <h2>üéâ Ready to Go!</h2>
                <p>Your CSV-based authentication system is ready to use. No database setup needed!
        <?php endif; ?>
    </div>
</body>
</html>


--- End of install.php ---



--- Start of login.php ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Workout Tracker</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .auth-container {
            max-width: 450px;
            margin: 60px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-container h1 {
            margin-bottom: 10px;
            color: #333;
        }
        .auth-container .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .form-group-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .form-group-checkbox input {
            margin-right: 8px;
        }
        .form-group-checkbox label {
            margin: 0;
            font-weight: normal;
            color: #333;
        }
        .btn-auth {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-auth:hover {
            background: #45a049;
        }
        .btn-auth:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-msg {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c33;
        }
        .success-msg {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #363;
        }
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            color: #666;
        }
        .auth-footer a {
            color: #4CAF50;
            text-decoration: none;
        }
        .auth-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h1>CRM Login</h1>
        <p class="subtitle">Login to access your customer data and manage business relationships</p>
        
        <?php
        require_once __DIR__ . '/Auth.php';
        
        // Load config
        $configFile = __DIR__ . '/config.php';
        if (!file_exists($configFile)) {
            die('Configuration file not found. Please create auth/config.php from auth/config.example.php');
        }
        $config = require $configFile;
        
        $auth = new Auth($config);
        $error = null;
        
        // Check if already logged in
        if ($auth->isAuthenticated()) {
            header('Location: ../index.php');
            exit;
        }
        
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $usernameOrEmail = trim($_POST['username_or_email'] ?? '');
            $password = $_POST['password'] ?? '';
            $rememberMe = isset($_POST['remember_me']);
            $csrfToken = $_POST['csrf_token'] ?? '';
            
            // Verify CSRF token
            if (!$auth->verifyCsrfToken($csrfToken)) {
                $error = 'Invalid security token. Please try again.';
            } else {
                $result = $auth->login($usernameOrEmail, $password, $rememberMe);
                
                if ($result['success']) {
                    // Redirect to main app
                    $redirectUrl = $_GET['redirect'] ?? '../index.php';
                    header('Location: ' . $redirectUrl);
                    exit;
                } else {
                    $error = $result['error'] ?? 'Login failed';
                }
            }
        }
        
        $csrfToken = $auth->generateCsrfToken();
        ?>
        
        <?php if ($error): ?>
            <div class="error-msg">
                <?= htmlspecialchars($error) ?>
            </div>
        <?php endif; ?>
        
        <?php if (isset($_GET['registered'])): ?>
            <div class="success-msg">
                Registration successful! Please login with your credentials.
            </div>
        <?php endif; ?>
        
        <form method="POST" action="">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            
            <div class="form-group">
                <label for="username_or_email">Username or Email</label>
                <input 
                    type="text" 
                    id="username_or_email" 
                    name="username_or_email" 
                    required
                    autocomplete="username"
                    value="<?= htmlspecialchars($_POST['username_or_email'] ?? '') ?>"
                >
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    required
                    autocomplete="current-password"
                >
            </div>
            
            <div class="form-group-checkbox">
                <input 
                    type="checkbox" 
                    id="remember_me" 
                    name="remember_me"
                >
                <label for="remember_me">Remember me for 30 days</label>
            </div>
            
            <button type="submit" class="btn-auth">Login</button>
        </form>
        
        <div class="auth-footer">
            Don't have an account? <a href="register.php">Register here</a>
        </div>
    </div>
</body>
</html>


--- End of login.php ---



--- Start of logout.php ---

<?php
/**
 * Logout Handler
 */

require_once __DIR__ . '/Auth.php';

// Load config
$configFile = __DIR__ . '/config.php';
if (!file_exists($configFile)) {
    die('Configuration file not found.');
}
$config = require $configFile;

$auth = new Auth($config);
$auth->logout();

// Redirect to auth landing page
header('Location: index.php');
exit;


--- End of logout.php ---



--- Start of maintenance.php ---

<?php
/**
 * Maintenance Script
 * 
 * Run this periodically to clean up old data
 */

require_once __DIR__ . '/CsvDataStore.php';

$config = require __DIR__ . '/config.php';
$store = new CsvDataStore($config);

echo "=== Auth System Maintenance ===\n\n";

// Clean expired sessions
echo "Cleaning expired sessions...\n";
$sessions = $store->fetchAll('sessions');
$expiredCount = 0;
foreach ($sessions as $session) {
    if (isset($session['expires_at']) && strtotime($session['expires_at']) < time()) {
        $expiredCount++;
    }
}
$store->cleanup('sessions', 'expires_at', date('Y-m-d H:i:s'));
echo "Removed $expiredCount expired sessions\n\n";

// Clean old login attempts (keep last 30 days)
echo "Cleaning old login attempts...\n";
$cutoff = date('Y-m-d H:i:s', strtotime('-30 days'));
$removed = $store->cleanup('login_attempts', 'attempted_at', $cutoff);
echo "Removed $removed old login attempts\n\n";

// Clean old activity logs (keep last 90 days)
echo "Cleaning old activity logs...\n";
$cutoff = date('Y-m-d H:i:s', strtotime('-90 days'));
$removed = $store->cleanup('activity_log', 'created_at', $cutoff);
echo "Removed $removed old activity log entries\n\n";

// Show statistics
echo "=== Current Statistics ===\n";
echo "Total users: " . $store->count('users') . "\n";
echo "Active sessions: " . $store->count('sessions') . "\n";
echo "Login attempts (last 30 days): " . $store->count('login_attempts') . "\n";
echo "Activity logs (last 90 days): " . $store->count('activity_log') . "\n";

echo "\nMaintenance complete!\n";


--- End of maintenance.php ---



--- Start of middleware.php ---

<?php
/**
 * Authentication Middleware
 * 
 * Include this file at the top of any protected page
 * Usage: require_once __DIR__ . '/auth/middleware.php';
 */

require_once __DIR__ . '/Auth.php';

// Load configuration
$configFile = __DIR__ . '/config.php';
if (!file_exists($configFile)) {
    die('Authentication configuration not found. Please set up auth/config.php');
}

$config = require $configFile;

// Initialize auth
$auth = new Auth($config);

// Check if user is authenticated
if (!$auth->isAuthenticated()) {
    // Store the current URL for redirect after login
    $currentUrl = $_SERVER['REQUEST_URI'];
    // Construct proper login URL - login.php is in simple_auth/login.php
    $loginUrl = '/CRM/simple_auth/login.php?redirect=' . urlencode($currentUrl);
    
    header('Location: ' . $loginUrl);
    exit;
}

// Make auth and current user available globally
$GLOBALS['auth'] = $auth;
$GLOBALS['current_user'] = $auth->getCurrentUser();

/**
 * Helper function to get current authenticated user
 */
function auth_current_user() {
    return $GLOBALS['current_user'] ?? null;
}

/**
 * Helper function to check if user is authenticated
 */
function auth_check() {
    return isset($GLOBALS['current_user']) && $GLOBALS['current_user'] !== null;
}

/**
 * Helper function to get auth instance
 */
function auth() {
    return $GLOBALS['auth'] ?? null;
}


--- End of middleware.php ---



--- Start of register.php ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - CRM System</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .auth-container {
            max-width: 450px;
            margin: 60px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-container h1 {
            margin-bottom: 10px;
            color: #333;
        }
        .auth-container .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .btn-auth {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-auth:hover {
            background: #45a049;
        }
        .btn-auth:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-list {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .error-list ul {
            margin: 0;
            padding-left: 20px;
            color: #c33;
        }
        .success-msg {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #363;
        }
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            color: #666;
        }
        .auth-footer a {
            color: #4CAF50;
            text-decoration: none;
        }
        .auth-footer a:hover {
            text-decoration: underline;
        }
        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h1>Create Account</h1>
        <p class="subtitle">Register to access the CRM and manage your business</p>
        
        <?php
        require_once __DIR__ . '/Auth.php';
        
        // Load config
        $configFile = __DIR__ . '/config.php';
        if (!file_exists($configFile)) {
            die('Configuration file not found. Please create auth/config.php from auth/config.example.php');
        }
        $config = require $configFile;
        
        $auth = new Auth($config);
        $errors = [];
        $success = false;
        
        // Track CSRF retry attempts
        $csrfRetryKey = 'csrf_retry_' . md5($_SERVER['REMOTE_ADDR'] ?? 'unknown');
        
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $username = trim($_POST['username'] ?? '');
            $email = trim($_POST['email'] ?? '');
            $password = $_POST['password'] ?? '';
            $confirmPassword = $_POST['confirm_password'] ?? '';
            $csrfToken = $_POST['csrf_token'] ?? '';
            
            // Verify CSRF token
            $devBypass = ($config['security']['dev_bypass_csrf'] ?? false) && ($_SERVER['SERVER_NAME'] ?? '') === 'localhost';
            
            if (!$devBypass && !$auth->verifyCsrfToken($csrfToken)) {
                // Check if this is a retry with the regenerated token
                $retryCount = $_SESSION[$csrfRetryKey] ?? 0;
                
                if ($retryCount < 2) {
                    // Allow up to 2 retries - regenerate token
                    $auth->generateCsrfToken();
                    $_SESSION[$csrfRetryKey] = $retryCount + 1;
                    $errors[] = 'Security token expired or invalid. This can happen if you left the page open too long. Please try submitting again (the form has been refreshed).';
                } else {
                    // Too many retries - might be an attack
                    $errors[] = 'Unable to verify security token after multiple attempts. Please refresh the page and try again.';
                    $_SESSION[$csrfRetryKey] = 0;
                }
            } elseif ($password !== $confirmPassword) {
                $errors[] = 'Passwords do not match';
            } else {
                // Reset retry counter on successful CSRF validation
                $_SESSION[$csrfRetryKey] = 0;
                
                $result = $auth->register($username, $email, $password);
                
                if ($result['success']) {
                    $success = true;
                    if ($result['requires_verification']) {
                        $successMessage = 'Registration successful! Please check your email to verify your account.';
                    } else {
                        $successMessage = 'Registration successful! You can now <a href="login.php">login</a>.';
                    }
                } else {
                    $errors = $result['errors'] ?? ['Registration failed'];
                }
            }
        }
        
        $csrfToken = $auth->generateCsrfToken();
        
        // Development debug info (only on localhost)
        $showDebug = ($_SERVER['SERVER_NAME'] ?? '') === 'localhost' || ($_SERVER['REMOTE_ADDR'] ?? '') === '127.0.0.1';
        ?>
        
        <?php if ($showDebug): ?>
            <div style="background: #f0f0f0; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; font-size: 11px; font-family: monospace;">
                <strong>Debug Info (localhost only):</strong><br>
                Session ID: <?= htmlspecialchars(session_id()) ?><br>
                CSRF Token: <?= htmlspecialchars(substr($csrfToken, 0, 16)) ?>...<br>
                Cookie Received: <?= isset($_COOKIE[session_name()]) ? '‚úÖ Yes (session maintained)' : '‚ö†Ô∏è Not yet (first load is normal)' ?><br>
                <?php if ($_SERVER['REQUEST_METHOD'] === 'POST'): ?>
                    <strong style="color: #c33;">POST Request - Cookie MUST be present for CSRF to work!</strong><br>
                <?php endif; ?>
                <?php if ($config['security']['dev_bypass_csrf'] ?? false): ?>
                    <div style="background: #fff3cd; color: #856404; padding: 8px; margin-top: 5px; border: 1px solid #ffc107; border-radius: 3px;">
                        ‚ö†Ô∏è <strong>DEV MODE:</strong> CSRF bypass is ENABLED for localhost testing
                    </div>
                <?php endif; ?>
            </div>
        <?php endif; ?>        
        <?php if (!empty($errors)): ?>
            <div class="error-list">
                <ul>
                    <?php foreach ($errors as $error): ?>
                        <li><?= htmlspecialchars($error) ?></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>
        
        <?php if ($success): ?>
            <div class="success-msg">
                <?= $successMessage ?>
            </div>
        <?php else: ?>
            <form method="POST" action="">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
                
                <div class="form-group">
                    <label for="username">Username</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        minlength="<?= $config['validation']['username_min_length'] ?>"
                        maxlength="<?= $config['validation']['username_max_length'] ?>"
                        pattern="[a-zA-Z0-9_]+"
                        value="<?= htmlspecialchars($_POST['username'] ?? '') ?>"
                    >
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required
                        value="<?= htmlspecialchars($_POST['email'] ?? '') ?>"
                    >
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required
                        minlength="<?= $config['validation']['password_min_length'] ?>"
                    >
                    <div class="password-requirements">
                        Must be at least <?= $config['validation']['password_min_length'] ?> characters
                        <?php if ($config['validation']['password_require_uppercase']): ?>, include uppercase<?php endif; ?>
                        <?php if ($config['validation']['password_require_lowercase']): ?>, lowercase<?php endif; ?>
                        <?php if ($config['validation']['password_require_number']): ?>, number<?php endif; ?>
                        <?php if ($config['validation']['password_require_special']): ?>, and special character<?php endif; ?>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <input 
                        type="password" 
                        id="confirm_password" 
                        name="confirm_password" 
                        required
                    >
                </div>
                
                <button type="submit" class="btn-auth">Create Account</button>
            </form>
        <?php endif; ?>
        
        <div class="auth-footer">
            Already have an account? <a href="login.php">Login here</a>
        </div>
    </div>
</body>
</html>


--- End of register.php ---



--- Start of security_headers.php ---

<?php
/**
 * Security Headers
 * 
 * Include this file to add security headers to responses
 * Usage: require_once __DIR__ . '/auth/security_headers.php';
 */

// Prevent clickjacking
header('X-Frame-Options: DENY');

// Prevent MIME type sniffing
header('X-Content-Type-Options: nosniff');

// Enable XSS protection
header('X-XSS-Protection: 1; mode=block');

// Referrer policy
header('Referrer-Policy: strict-origin-when-cross-origin');

// Content Security Policy (adjust as needed)
header("Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;");

// Enforce HTTPS (uncomment when using HTTPS)
// header('Strict-Transport-Security: max-age=31536000; includeSubDomains; preload');

// Permissions policy
header('Permissions-Policy: geolocation=(), microphone=(), camera=()');


--- End of security_headers.php ---



--- Start of setup.php ---

<?php
/**
 * Simple Auth Interactive Setup
 * 
 * Auto-generates config.php with project-specific settings
 * Run once per project: php setup.php
 */

// Prevent running in web browser - CLI only
if (PHP_SAPI !== 'cli') {
    // For web browser: show a simple HTML form
    handleWebSetup();
    exit;
}

// CLI mode
runCliSetup();

/**
 * CLI Setup - Interactive command line setup
 */
function runCliSetup() {
    echo "\n";
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
    echo "‚ïë     Simple Auth - Interactive Setup                           ‚ïë\n";
    echo "‚ïë     https://github.com/Robertja98/simple_auth                 ‚ïë\n";
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";
    
    // Check if config already exists
    $configPath = __DIR__ . '/config.php';
    if (file_exists($configPath)) {
        echo "‚ö†Ô∏è  config.php already exists!\n";
        echo "Do you want to overwrite it? (y/n): ";
        $response = trim(fgets(STDIN));
        if (strtolower($response) !== 'y') {
            echo "Setup cancelled.\n";
            return;
        }
        echo "\n";
    }
    
    // Gather configuration
    echo "üìù Project Configuration\n";
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
    
    $config = [
        'project_name' => ask('Project Name (e.g., "My CRM System")', 'Auth System'),
        'session_name' => ask('Session Name (unique identifier for cookies)', 'SIMPLE_AUTH_SESSION'),
        'base_url' => ask('Base URL (e.g., "http://localhost/myproject")', 'http://localhost/project'),
        'use_https' => ask('Using HTTPS in production? (y/n)', 'n'),
        'require_email_verification' => ask('Require email verification? (y/n)', 'n'),
        'enable_2fa' => ask('Enable 2FA? (y/n)', 'n'),
        'admin_email' => ask('Admin email address', 'admin@example.com'),
    ];
    
    // Generate config.php
    echo "\n\n‚ú® Generating config.php...\n";
    generateConfigFile($config);
    
    // Create data directory
    echo "üìÅ Creating data directory...\n";
    $dataDir = __DIR__ . '/data';
    if (!is_dir($dataDir)) {
        mkdir($dataDir, 0755, true);
        echo "‚úì Directory created: $dataDir\n";
    } else {
        echo "‚úì Directory already exists: $dataDir\n";
    }
    
    // Set permissions
    if (PHP_OS_FAMILY === 'Windows') {
        echo "üîê Windows: Using icacls for permissions\n";
        echo "Run this command as Administrator if needed:\n";
        echo "   icacls \"" . $dataDir . "\" /grant \"IUSR:(OI)(CI)F\" /inheritance:e\n";
    } else {
        chmod($dataDir, 0755);
        echo "‚úì Permissions set: 755\n";
    }
    
    echo "\n";
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
    echo "‚ïë ‚úÖ Setup Complete!                                             ‚ïë\n";
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";
    
    echo "Next steps:\n";
    echo "  1. Set file permissions (see above)\n";
    echo "  2. Visit: install.php to verify installation\n";
    echo "  3. Visit: test.php to test functionality\n";
    echo "  4. Add this to your protected pages:\n";
    echo "     <?php require_once __DIR__ . '/simple_auth/middleware.php'; ?>\n\n";
}

/**
 * Web Setup - HTML form for browser
 */
function handleWebSetup() {
    $configPath = __DIR__ . '/config.php';
    $configExists = file_exists($configPath);
    
    $projectName = $_POST['project_name'] ?? 'Auth System';
    $sessionName = $_POST['session_name'] ?? 'SIMPLE_AUTH_SESSION';
    $baseUrl = $_POST['base_url'] ?? 'http://localhost/project';
    $useHttps = isset($_POST['use_https']) ? 'y' : 'n';
    $requireEmailVerification = isset($_POST['require_email_verification']) ? 'y' : 'n';
    $enable2fa = isset($_POST['enable_2fa']) ? 'y' : 'n';
    $adminEmail = $_POST['admin_email'] ?? 'admin@example.com';
    
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['setup_submit'])) {
        if ($configExists && !isset($_POST['overwrite'])) {
            $error = "config.php already exists. Check 'Overwrite' to replace it.";
        } else {
            $config = [
                'project_name' => $projectName,
                'session_name' => $sessionName,
                'base_url' => $baseUrl,
                'use_https' => $useHttps,
                'require_email_verification' => $requireEmailVerification,
                'enable_2fa' => $enable2fa,
                'admin_email' => $adminEmail,
            ];
            
            generateConfigFile($config);
            
            $dataDir = __DIR__ . '/data';
            if (!is_dir($dataDir)) {
                mkdir($dataDir, 0755, true);
            }
            
            $success = "‚úÖ Setup complete! config.php has been created.";
        }
    }
    ?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simple Auth Setup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: monospace;
        }
        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert-error {
            background: #fee;
            border-color: #f99;
            color: #c33;
        }
        .alert-success {
            background: #efe;
            border-color: #9f9;
            color: #3c3;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        .small {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .next-steps {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 20px;
            margin-top: 20px;
        }
        .next-steps h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .next-steps ol {
            margin-left: 20px;
            color: #666;
            line-height: 1.6;
        }
        .next-steps a {
            color: #667eea;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Simple Auth Setup</h1>
        <p class="subtitle">Configure your authentication module</p>
        
        <?php if (isset($error)): ?>
            <div class="alert alert-error"><?= htmlspecialchars($error) ?></div>
        <?php endif; ?>
        
        <?php if (isset($success)): ?>
            <div class="alert alert-success"><?= htmlspecialchars($success) ?></div>
            <div class="next-steps">
                <h3>‚úÖ Next Steps</h3>
                <ol>
                    <li>Visit <a href="install.php">install.php</a> to verify installation</li>
                    <li>Visit <a href="test.php">test.php</a> to test the auth system</li>
                    <li>Add middleware to your protected pages:
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 5px; font-family: monospace; font-size: 12px;">
                            &lt;?php require_once __DIR__ . '/simple_auth/middleware.php'; ?&gt;
                        </div>
                    </li>
                </ol>
            </div>
        <?php else: ?>
        <form method="POST">
            <div class="form-group">
                <label for="project_name">Project Name</label>
                <input type="text" id="project_name" name="project_name" value="<?= htmlspecialchars($projectName) ?>" placeholder="e.g., My CRM System" required>
                <div class="small">Displayed on auth pages and config</div>
            </div>
            
            <div class="form-group">
                <label for="session_name">Session Name</label>
                <input type="text" id="session_name" name="session_name" value="<?= htmlspecialchars($sessionName) ?>" placeholder="e.g., MYPROJECT_SESSION" required>
                <div class="small">Unique identifier for session cookies (no spaces)</div>
            </div>
            
            <div class="form-group">
                <label for="base_url">Base URL</label>
                <input type="text" id="base_url" name="base_url" value="<?= htmlspecialchars($baseUrl) ?>" placeholder="e.g., http://localhost/myproject" required>
                <div class="small">Without trailing slash</div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="use_https" name="use_https" <?= $useHttps === 'y' ? 'checked' : '' ?>>
                    <label for="use_https" style="margin-bottom: 0;">Using HTTPS in production?</label>
                </div>
                <div class="small">Enables secure cookies</div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="require_email_verification" name="require_email_verification" <?= $requireEmailVerification === 'y' ? 'checked' : '' ?>>
                    <label for="require_email_verification" style="margin-bottom: 0;">Require email verification?</label>
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="enable_2fa" name="enable_2fa" <?= $enable2fa === 'y' ? 'checked' : '' ?>>
                    <label for="enable_2fa" style="margin-bottom: 0;">Enable 2FA?</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="admin_email">Admin Email</label>
                <input type="email" id="admin_email" name="admin_email" value="<?= htmlspecialchars($adminEmail) ?>" required>
            </div>
            
            <?php if ($configExists): ?>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="overwrite" name="overwrite">
                        <label for="overwrite" style="margin-bottom: 0;">I understand this will overwrite config.php</label>
                    </div>
                </div>
            <?php endif; ?>
            
            <button type="submit" name="setup_submit">Complete Setup</button>
        </form>
        <?php endif; ?>
    </div>
</body>
</html>
    <?php
}

/**
 * CLI helper: Ask question and get input
 */
function ask($question, $default = '') {
    echo "$question";
    if ($default) {
        echo " [$default]";
    }
    echo ": ";
    
    $input = trim(fgets(STDIN));
    return $input ?: $default;
}

/**
 * Generate config.php file
 */
function generateConfigFile($data) {
    $configContent = <<<'PHP'
<?php
/**
 * Simple Auth Configuration
 * 
 * AUTO-GENERATED by setup.php
 * DO NOT commit this file to version control
 * Add to .gitignore: simple_auth/config.php
 */

return [
    // Storage configuration (CSV files)
    'storage' => [
        'data_dir' => __DIR__ . '/data',
    ],
    
    // Security settings
    'security' => [
        'password_algo' => PASSWORD_ARGON2ID,
        'password_options' => [
            'memory_cost' => 65536,  // 64 MB
            'time_cost' => 4,
            'threads' => 3,
        ],
        
        'session_name' => '{SESSION_NAME}',
        'session_lifetime' => 86400,
        'session_cookie_secure' => {HTTPS_SETTING},
        'session_cookie_httponly' => true,
        'session_cookie_samesite' => 'Strict',
        
        'csrf_token_name' => 'csrf_token',
        'csrf_token_length' => 32,
        
        'max_login_attempts' => 5,
        'lockout_duration' => 900,
        'rate_limit_window' => 900,
    ],
    
    // Application settings
    'app' => [
        'name' => '{PROJECT_NAME}',
        'base_url' => '{BASE_URL}',
        'require_email_verification' => {EMAIL_VERIFICATION},
        'enable_2fa' => {2FA_ENABLED},
        'admin_email' => '{ADMIN_EMAIL}',
    ],
    
    // Validation rules
    'validation' => [
        'username_min_length' => 3,
        'username_max_length' => 50,
        'password_min_length' => 8,
        'password_require_uppercase' => true,
        'password_require_lowercase' => true,
        'password_require_number' => true,
        'password_require_special' => true,
    ],
    
    // Logging
    'logging' => [
        'enabled' => true,
        'log_failed_logins' => true,
        'log_successful_logins' => true,
        'log_registrations' => true,
        'log_password_changes' => true,
    ],
];
PHP;

    $https = $data['use_https'] === 'y' ? 'true' : 'false';
    $emailVerification = $data['require_email_verification'] === 'y' ? 'true' : 'false';
    $twofa = $data['enable_2fa'] === 'y' ? 'true' : 'false';
    
    $configContent = str_replace(
        ['{SESSION_NAME}', '{PROJECT_NAME}', '{BASE_URL}', '{HTTPS_SETTING}', '{EMAIL_VERIFICATION}', '{2FA_ENABLED}', '{ADMIN_EMAIL}'],
        [$data['session_name'], $data['project_name'], $data['base_url'], $https, $emailVerification, $twofa, $data['admin_email']],
        $configContent
    );
    
    file_put_contents(__DIR__ . '/config.php', $configContent);
    chmod(__DIR__ . '/config.php', 0644);
}
?>


--- End of setup.php ---



--- Start of test.php ---

<?php
/**
 * CSV Authentication System - Quick Test
 * 
 * Tests basic functionality of the CSV-based auth system
 */

require_once __DIR__ . '/Auth.php';

// Load config
$config = require __DIR__ . '/config.php';

echo "<h1>Auth System Test</h1>";
echo "<pre>";

try {
    $auth = new Auth($config);
    echo "‚úÖ Auth system initialized successfully\n\n";
    
    // Test user registration
    echo "Testing user registration...\n";
    $testUsername = 'testuser_' . time();
    $testEmail = $testUsername . '@example.com';
    $testPassword = 'TestPass123!';
    
    $result = $auth->register($testUsername, $testEmail, $testPassword);
    
    if ($result['success']) {
        echo "‚úÖ Registration successful\n";
        echo "   User ID: " . $result['user_id'] . "\n\n";
        
        // Test login
        echo "Testing login...\n";
        $loginResult = $auth->login($testUsername, $testPassword);
        
        if ($loginResult['success']) {
            echo "‚úÖ Login successful\n";
            echo "   User: " . $loginResult['user']['username'] . "\n";
            echo "   Email: " . $loginResult['user']['email'] . "\n\n";
            
            // Test authentication check
            echo "Testing authentication check...\n";
            if ($auth->isAuthenticated()) {
                echo "‚úÖ User is authenticated\n\n";
                
                // Get current user
                $currentUser = $auth->getCurrentUser();
                echo "Current user details:\n";
                echo "   ID: " . $currentUser['id'] . "\n";
                echo "   Username: " . $currentUser['username'] . "\n";
                echo "   Email: " . $currentUser['email'] . "\n\n";
                
                // Test logout
                echo "Testing logout...\n";
                $auth->logout();
                
                if (!$auth->isAuthenticated()) {
                    echo "‚úÖ Logout successful\n\n";
                } else {
                    echo "‚ùå Logout failed\n\n";
                }
            } else {
                echo "‚ùå Authentication check failed\n\n";
            }
        } else {
            echo "‚ùå Login failed: " . $loginResult['error'] . "\n\n";
        }
    } else {
        echo "‚ùå Registration failed:\n";
        foreach ($result['errors'] as $error) {
            echo "   - $error\n";
        }
        echo "\n";
    }
    
    // Check data files
    echo "Checking CSV data files...\n";
    $dataDir = $config['storage']['data_dir'];
    $files = ['users.csv', 'sessions.csv', 'login_attempts.csv', 'activity_log.csv'];
    
    foreach ($files as $file) {
        $filepath = $dataDir . '/' . $file;
        if (file_exists($filepath)) {
            $size = filesize($filepath);
            $lines = count(file($filepath));
            echo "‚úÖ $file exists ($size bytes, $lines lines)\n";
        } else {
            echo "‚ùå $file not found\n";
        }
    }
    
    echo "\n=== Test Complete ===\n";
    echo "Check the auth/data/ directory to see the generated CSV files.\n";
    
} catch (Exception $e) {
    echo "‚ùå Error: " . $e->getMessage() . "\n";
    echo $e->getTraceAsString();
}

echo "</pre>";
?>


--- End of test.php ---



--- Start of test_permissions.php ---

<?php
echo "<h1>Permission Test</h1>";

$dataDir = __DIR__ . '/data';
$testFile = $dataDir . '/php_write_test.txt';

echo "<p>Data directory: <code>$dataDir</code></p>";
echo "<p>Directory exists: " . (is_dir($dataDir) ? "‚úÖ YES" : "‚ùå NO") . "</p>";
echo "<p>Directory readable: " . (is_readable($dataDir) ? "‚úÖ YES" : "‚ùå NO") . "</p>";
echo "<p>Directory writable: " . (is_writable($dataDir) ? "‚úÖ YES" : "‚ùå NO") . "</p>";

// Try to write a test file
echo "<h2>Write Test</h2>";
try {
    $content = "PHP test at " . date('Y-m-d H:i:s');
    $result = file_put_contents($testFile, $content);
    
    if ($result !== false) {
        echo "‚úÖ PHP successfully wrote to directory!<br>";
        
        // Try to read it back
        $read = file_get_contents($testFile);
        echo "‚úÖ PHP successfully read the file: <code>$read</code><br>";
        
        // Clean up
        unlink($testFile);
        echo "‚úÖ Test file cleaned up<br>";
    } else {
        echo "‚ùå PHP could not write to directory<br>";
    }
} catch (Exception $e) {
    echo "‚ùå Error: " . htmlspecialchars($e->getMessage()) . "<br>";
}

// Check if CSV files can be created
echo "<h2>CSV File Creation</h2>";
$csvFiles = ['users.csv', 'sessions.csv', 'login_attempts.csv', 'activity_log.csv'];
foreach ($csvFiles as $file) {
    $path = $dataDir . '/' . $file;
    echo "File <code>$file</code>: " . (file_exists($path) ? "‚úÖ EXISTS" : "‚è≥ NOT YET (will create on first use)") . "<br>";
}

echo "<h2>Result</h2>";
if (is_writable($dataDir)) {
    echo "<p style='color: green; font-weight: bold;'>‚úÖ All permissions OK! You can now register users.</p>";
    echo "<p><a href='register.php'>Go to Registration ‚Üí</a></p>";
} else {
    echo "<p style='color: red; font-weight: bold;'>‚ùå Directory still not writable by PHP</p>";
    echo "<p>Check the permissions or try using a different data directory location.</p>";
}
?>


--- End of test_permissions.php ---



--- Start of CsvHandlerTest.php ---

<?php
// tests/CsvHandlerTest.php
// PHPUnit test for csv_handler.php

use PHPUnit\Framework\TestCase;

require_once __DIR__ . '/../csv_handler.php';

class CsvHandlerTest extends TestCase {
    private $testFile = __DIR__ . '/test_contacts.csv';
    private $schema = ['id', 'name', 'email'];

    protected function setUp(): void {
        // Create a test CSV file
        $data = [
            ['id' => '1', 'name' => 'Alice', 'email' => 'alice@example.com'],
            ['id' => '2', 'name' => 'Bob', 'email' => 'bob@example.com'],
        ];
        writeCSV($this->testFile, $data, $this->schema);
    }

    protected function tearDown(): void {
        if (file_exists($this->testFile)) {
            unlink($this->testFile);
        }
    }

    public function testReadCSV() {
        $rows = readCSV($this->testFile, $this->schema);
        $this->assertCount(2, $rows);
        $this->assertEquals('Alice', $rows[0]['name']);
        $this->assertEquals('bob@example.com', $rows[1]['email']);
    }

    public function testWriteCSV() {
        $data = [
            ['id' => '3', 'name' => 'Charlie', 'email' => 'charlie@example.com']
        ];
        writeCSV($this->testFile, $data, $this->schema);
        $rows = readCSV($this->testFile, $this->schema);
        $this->assertCount(1, $rows);
        $this->assertEquals('Charlie', $rows[0]['name']);
    }

    public function testAppendCSV() {
        $row = ['3', 'Charlie', 'charlie@example.com'];
        appendCSV($this->testFile, $row);
        $rows = readCSV($this->testFile, $this->schema);
        $this->assertCount(3, $rows);
        $this->assertEquals('Charlie', $rows[2]['name']);
    }
}


--- End of CsvHandlerTest.php ---

