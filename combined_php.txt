

--- Start of add_contact.php ---

<?php
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$filename = 'contacts.csv';
$logFile = 'error_log.txt';
$schema = require __DIR__ . '/contact_schema.php';

$timestamp = date('Y-m-d H:i:s');
$newContact = [
    'id' => uniqid(),
    'first_name' => $_POST['first_name'] ?? '',
    'last_name' => $_POST['last_name'] ?? '',
    'company' => $_POST['company'] ?? '',
    'address_1' => $_POST['address_1'] ?? '',
    'address_2' => $_POST['address_2'] ?? '',
    'city' => $_POST['city'] ?? '',
    'postal_code' => $_POST['postal_code'] ?? '',
    'province' => $_POST['province'] ?? '',
    'country' => $_POST['country'] ?? '',
    'phone' => $_POST['phone'] ?? '',
    'email' => $_POST['email'] ?? '',
    'created_at' => $timestamp,
    'source' => 'manual_entry'
];

// Validate contact
$errors = validateContact($newContact);
if (!empty($errors)) {
    echo "<p style='color:red;'>Invalid contact data:</p>";
    foreach ($errors as $field => $msg) {
        echo "<p>Error in $field: $msg</p>";
    }

    // Log errors
    $errorMessage = "[$timestamp] Contact validation failed for email: {$newContact['email']}\n";
    $errorMessage .= print_r($errors, true) . "\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    echo "<p><a href='contact_view.php'>Go back</a></p>";
    exit;
}

// Load existing contacts
$contacts = readCSV($filename, $schema);

// Check for duplicates
foreach ($contacts as $contact) {
    if ($contact['email'] === $newContact['email']) {
        echo "<p style='color:red;'>Duplicate email detected. Contact not saved.</p>";
        $duplicateMessage = "[$timestamp] Duplicate email detected: {$newContact['email']}\n";
        file_put_contents($logFile, $duplicateMessage, FILE_APPEND);
        echo "<p><a href='contact_view.php'>Go back</a></p>";
        exit;
    }
}

// Save contact
$contacts[] = $newContact;
writeCSV($filename, $contacts, $schema);

// Log success
$successMessage = "[$timestamp] Contact saved: {$newContact['email']}\n";
file_put_contents($logFile, $successMessage, FILE_APPEND);

// Redirect to confirmation
header('Location: contact_success.php');
exit;
?>


--- End of add_contact.php ---



--- Start of add_customer.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/customer_schema.php';
$itemFields = require __DIR__ . '/customer_item_config.php';
$customerFile = 'customers.csv';
$itemFile = 'customer_items.csv';
$errors = [];
$success = false;
$newCustomer = [];

// Load existing customers
$rows = readCSV($customerFile, $schema);
$lastId = 0;
foreach ($rows as $r) {
    $id = intval($r['customer_id']);
    if ($id > $lastId) $lastId = $id;
}
$nextId = str_pad($lastId + 1, 5, '0', STR_PAD_LEFT);

// Handle POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    foreach ($schema as $field) {
        $newCustomer[$field] = ($field === 'customer_id') ? $nextId : trim($_POST[$field] ?? '');
    }

    // Validate main fields
    if ($newCustomer['contact_name'] === '') $errors[] = 'Contact name is required.';
    if ($newCustomer['address'] === '') $errors[] = 'Address is required.';

    // Parse line items
    $items = [];
    if (isset($_POST['items']) && is_array($_POST['items'])) {
        foreach ($_POST['items'] as $item) {
            $clean = ['customer_id' => $nextId];
            foreach ($itemFields as $f) {
                $clean[$f] = trim($item[$f] ?? '');
            }
            $items[] = $clean;
        }
    }

    if (empty($errors)) {
        $rows[] = $newCustomer;
        writeCSV($customerFile, $rows, $schema);

        $existingItems = readCSV($itemFile, array_merge(['customer_id'], $itemFields));
        $existingItems = is_array($existingItems) ? $existingItems : [];
        $allItems = array_merge($existingItems, $items);
        writeCSV($itemFile, $allItems, array_merge(['customer_id'], $itemFields));

        $success = true;
    }
}
?>

<div class="container">
  <h2>Add New Customer</h2>

  <?php if ($success): ?>
    <p style="color:green;">‚úÖ Customer added successfully. ID: <?= $nextId ?></p>
  <?php endif; ?>

  <?php if (!empty($errors)): ?>
    <ul style="color:red;">
      <?php foreach ($errors as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
    </ul>
  <?php endif; ?>

  <form method="POST">
    <fieldset style="margin-bottom:20px;">
      <legend><strong>Main Customer Info</strong></legend>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
        <div>
          <label><strong>Customer ID:</strong></label><br>
          <input type="text" value="<?= $nextId ?>" readonly>
        </div>
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'customer_id') continue; ?>
          <div>
            <label for="<?= $field ?>"><strong><?= ucfirst(str_replace('_', ' ', $field)) ?>:</strong></label><br>
            <input type="text" name="<?= $field ?>" id="<?= $field ?>" value="<?= htmlspecialchars($_POST[$field] ?? '') ?>">
          </div>
        <?php endforeach; ?>
      </div>
    </fieldset>

    <fieldset>
      <legend><strong>Tank & Delivery Line Items</strong></legend>
      <div id="lineItems"></div>
      <button type="button" onclick="addLineItem()" class="btn-outline">‚ûï Add Line Item</button>
    </fieldset>

    <div style="margin-top:20px;">
      <button type="submit" class="btn-outline">üíæ Save Customer</button>
    </div>
  </form>
</div>

<script>
function addLineItem() {
  const container = document.getElementById('lineItems');
  const index = container.children.length;
  const fields = <?= json_encode($itemFields) ?>;
  const row = document.createElement('div');
  row.style.marginBottom = '12px';
  row.style.border = '1px solid #ccc';
  row.style.padding = '10px';
  row.style.borderRadius = '6px';
  row.style.background = '#f9f9f9';

  let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">';
  fields.forEach(f => {
    html += `
      <div>
        <label><strong>${f.replace(/_/g, ' ')}:</strong></label><br>
        <input type="text" name="items[${index}][${f}]" />
      </div>
    `;
  });
  html += '</div>';
  row.innerHTML = html;
  container.appendChild(row);
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_customer.php ---



--- Start of add_discussion.php ---

<?php
require_once 'contact_validator.php';
require_once 'discussion_logger.php'; // contains logDiscussionEntry()

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate input
    $errors = validateContact($_POST);
    if (!empty($errors)) {
        foreach ($errors as $field => $msg) {
            echo "<p>Error in $field: $msg</p>";
        }
        echo "<p><a href='contact_view.php'>Go back</a></p>";
        exit;
    }

    // Log the discussion entry
    if (logDiscussionEntry($_POST)) {
        header('Location: contact_view.php');
        exit;
    } else {
        echo "<p style='color:red;'>Failed to log discussion entry. Please check the error log.</p>";
        echo "<p><a href='contact_view.php'>Go back</a></p>";
    }
}
?>



--- End of add_discussion.php ---



--- Start of add_opportunity.php ---

<?php

require_once __DIR__ . '/csv_handler.php';
if (!function_exists('readCSV')) {
    error_log("readCSV not loaded ‚Äî check csv_handler.php include path");
    die("CSV handler not loaded.");
}

require_once 'contact_validator.php';

$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', $schema);

// Build contact ID lookup
$validContactIDs = array_column($contacts, 'id');

// Build new opportunity from POST data
$newOpportunity = [];
foreach ($schema as $field) {
    if ($field === 'id') {
        $newOpportunity['id'] = uniqid();
    } else {
        $newOpportunity[$field] = trim($_POST[$field] ?? '');
    }
}

// Defensive logging for missing or invalid fields
if (!in_array($newOpportunity['contact_id'], $validContactIDs)) {
    error_log("Invalid contact_id submitted: " . $newOpportunity['contact_id']);
}
if (!is_numeric($newOpportunity['value'])) {
    error_log("Invalid value submitted: " . $newOpportunity['value']);
}
if (!is_numeric($newOpportunity['probability'])) {
    error_log("Invalid probability submitted: " . $newOpportunity['probability']);
}
if (empty($newOpportunity['stage'])) {
    error_log("Missing stage in opportunity submission");
}

// Validate required fields
$validOpportunity =
    in_array($newOpportunity['contact_id'], $validContactIDs) &&
    is_numeric($newOpportunity['value']) &&
    is_numeric($newOpportunity['probability']) &&
    !empty($newOpportunity['stage']);

if ($validOpportunity) {
    $opportunities[] = $newOpportunity;
    writeCSV('opportunities.csv', $opportunities, $schema);
    header('Location: opportunity_form.php?status=success');
    exit;
} else {
    error_log("Rejected opportunity: " . json_encode($newOpportunity));
    header('Location: opportunity_form.php?status=error');
    exit;
}



--- End of add_opportunity.php ---



--- Start of add_task.php ---

<?php
require_once 'csv_handler.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title = trim($_POST['title']);
    $due_date = $_POST['due_date'];
    $status = $_POST['status'];
    $errors = [];

    if ($title === '') $errors[] = 'Task title is required.';
    if ($due_date === '') $errors[] = 'Due date is required.';
    elseif (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $due_date)) $errors[] = 'Invalid date format.';
    if ($status !== 'pending' && $status !== 'completed') $errors[] = 'Invalid status selected.';

    if (!empty($errors)) {
        echo "<div style='color:red;'><strong>Error:</strong><ul>";
        foreach ($errors as $error) echo "<li>" . htmlspecialchars($error) . "</li>";
        echo "</ul></div><a href='index.php'>Go back</a>";
        exit;
    }

    $filename = 'tasks.csv';
    $newTask = [$title, $due_date, $status, date('Y-m-d H:i:s')];
    appendCSV($filename, $newTask);
    header('Location: index.php');
    exit;
}
?>


--- End of add_task.php ---



--- Start of add_tasks.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$title = $_POST['title'] ?? '';
if (trim($title) === '') {
    echo 'error: empty title';
    exit;
}

$filename = 'tasks.csv';
$headers = ['id','title','status','priority','assigned_to','due_date','timestamp'];

if (!file_exists($filename)) {
    $fp = fopen($filename, 'w');
    if ($fp === false) {
        echo 'error: cannot create file';
        exit;
    }
    fputcsv($fp, $headers);
    fclose($fp);
}

$id = uniqid('task_', true);
$status = 'incomplete';
$priority = '';
$assigned_to = '';
$due_date = '';
$timestamp = date('Y-m-d H:i:s');

$fp = fopen($filename, 'a');
if ($fp !== false) {
    fputcsv($fp, [$id, $title, $status, $priority, $assigned_to, $due_date, $timestamp]);
    fclose($fp);
    echo 'success';
} else {
    echo 'error: cannot open file for appending';
}
?>

--- End of add_tasks.php ---



--- Start of archive_task.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$idToArchive = $_POST['id'] ?? '';
if (!$idToArchive) {
    echo 'error';
    exit;
}

$filename = 'tasks.csv';
$rows = [];
$found = false;

if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle); // Read and store header
    $rows[] = $headers;

    while (($data = fgetcsv($handle)) !== false) {
        if ($data[0] === $idToArchive) {
            $data[2] = 'archived'; // Update status
            $found = true;
        }
        $rows[] = $data;
    }
    fclose($handle);
}

// Rewrite the CSV only if the task was found
if ($found && ($handle = fopen($filename, 'w')) !== false) {
    foreach ($rows as $row) {
        fputcsv($handle, $row);
    }
    fclose($handle);
    echo 'success';
} else {
    echo 'error';
}
?>


--- End of archive_task.php ---



--- Start of bulk_action.php ---

<?php
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
$schema = file_exists($schemaFile) ? require $schemaFile : [];
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

$selectedIds = $_POST['selected_ids'] ?? [];
$action = $_POST['action'] ?? '';
$tagToAssign = $_POST['assign_tag'] ?? '';
$statusToAssign = $_POST['assign_status'] ?? '';

if (!is_array($selectedIds) || empty($action)) {
    die('Error: No contacts selected or no action specified.');
}

$updatedContacts = [];
$exportRows = [];

foreach ($contacts as $contact) {
    $id = $contact['id'] ?? '';
    $isSelected = in_array($id, $selectedIds);

    if ($action === 'delete' && $isSelected) {
        continue; // Skip this contact (delete)
    }

    if ($action === 'export' && $isSelected) {
        $row = [];
        foreach ($schema as $field) {
            $row[] = $contact[$field] ?? '';
        }
        $exportRows[] = $row;
    }

    if ($action === 'assign_tag' && $isSelected && $tagToAssign !== '') {
        $existingTags = array_map('trim', explode(',', $contact['tags'] ?? ''));
        if (!in_array($tagToAssign, $existingTags)) {
            $existingTags[] = $tagToAssign;
        }
        $contact['tags'] = implode(', ', $existingTags);
    }

    if ($action === 'assign_status' && $isSelected && $statusToAssign !== '') {
        $contact['status'] = $statusToAssign;
    }

    $updatedContacts[] = $contact;
}

if ($action === 'export') {
    $filename = 'contacts_bulk_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($exportRows as $row) {
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
} else {
    writeCSV('contacts.csv', $updatedContacts, $schema);
    header('Location: contacts_list.php');
    exit;
}
?>

--- End of bulk_action.php ---



--- Start of calendar.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

// Load tasks from handler
require_once 'layout_start.php';
require_once 'csv_handler.php'; // or whatever file defines readCSV()

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp']; // adjust based on your actual CSV columns
$tasks = readCSV($filename, $schema);

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        $tasksByDate[$task['due_date']][] = $task;
    }
}

?>


<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }

  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }

  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }

  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>
<h2>Task Calendar</h2>
<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
  <?php
  $year = date('Y');
  $month = date('m');
  $daysInMonth = date('t');
  $firstDayOfMonth = date('w', strtotime("$year-$month-01"));

  $day = 1;
  $week = [];

  for ($i = 0; $i < $firstDayOfMonth; $i++) {
      $week[] = "<td></td>";
  }

  while ($day <= $daysInMonth) {
      $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
      if (isset($tasksByDate[$dateStr])) {
          $taskTitles = '';
          foreach ($tasksByDate[$dateStr] as $task) {
              $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
          }
          $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
      } else {
          $week[] = "<td>$day</td>";
      }

      if (count($week) == 7) {
          echo "<tr>" . implode('', $week) . "</tr>";
          $week = [];
      }

      $day++;
  }

  if (!empty($week)) {
      while (count($week) < 7) {
          $week[] = "<td></td>";
      }
      echo "<tr>" . implode('', $week) . "</tr>";
  }
  ?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}
</script>

<?php include 'layout_end.php'; ?>


--- End of calendar.php ---



--- Start of commit_import.php ---

<?php
session_start();
require_once 'csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$logFile = 'error_log.txt';
$targetFile = 'contacts.csv';

// Validate session data
$contacts = $_SESSION['import_preview'] ?? [];

if (!is_array($contacts) || empty($contacts)) {
    echo "<p style='color:red;'>No import data received or session expired.</p>";
    exit;
}

// Re-validate schema alignment
$validContacts = array_filter($contacts, function($row) use ($schema) {
    foreach ($schema as $col) {
        if (!array_key_exists($col, $row)) return false;
    }
    return true;
});

// Append to contacts.csv
$success = writeCSV($targetFile, $validContacts, $schema);

if ($success) {
    echo "<p style='color:green;'>Import complete. " . count($validContacts) . " contacts added.</p>";
    echo "<p><a href='contacts_list.php' class='btn'>‚Üê Back to Contacts</a></p>";
    unset($_SESSION['import_preview']); // Clear session after successful import
} else {
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write imported contacts.\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);
    echo "<p style='color:red;'>Import failed. See error log.</p>";
}
?>


--- End of commit_import.php ---



--- Start of contacts_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

// Load schema safely
$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

// Handle query and sort
$query = strtolower(trim($_GET['query'] ?? ''));
$field = $_GET['field'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$activeSort = array_flip($sortFields);

// Display fields
$displayFields = $_GET['display'] ?? ['first_name', 'last_name', 'company', 'email'];
if (!is_array($displayFields)) {
    $displayFields = ['first_name', 'last_name', 'company', 'email'];
}

// Load contacts safely
$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Detect duplicates
$emailCount = [];
foreach ($contacts as $c) {
    $email = strtolower(trim($c['email']));
    $emailCount[$email] = ($emailCount[$email] ?? 0) + 1;
}

// Apply filter
if ($query !== '' && in_array($field, $schema)) {
    $contacts = array_filter($contacts, function($c) use ($field, $query) {
        return strpos(strtolower($c[$field] ?? ''), $query) !== false;
    });
}

// Apply multi-field sort
$validSortFields = array_filter($sortFields, function($f) use ($displayFields) {
    return in_array($f, $displayFields);
});

if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';

            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric
                ? ($valA <=> $valB)
                : strnatcasecmp($valA, $valB);

            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// Export logic
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename=\"$filename\"");

    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }

    fputcsv($output, $displayFields);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($displayFields as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }

    fclose($output);
    exit;
}
?>



<div class="page-contacts">
  <div class="container">
    <h2>All Contacts</h2>

    <form method="GET" class="contact-form">
      <div style="display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end;">
        <div>
          <label for="field">Filter by:</label><br>
          <select name="field" id="field">
            <?php foreach ($schema as $f): ?>
              <option value="<?= $f ?>" <?= $field === $f ? 'selected' : '' ?>>
                <?= ucfirst(str_replace('_', ' ', $f)) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>

        <div>
          <label for="query">Search:</label><br>
          <input type="text" name="query" id="query" value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
        </div>

        <div>
          <label for="fontSize">Font size:</label><br>
          <select id="fontSize">
            <option value="0.75rem">Small</option>
            <option value="0.85rem" selected>Medium</option>
            <option value="1rem">Large</option>
          </select>
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
          <button type="submit">Apply</button>
          <button type="submit" name="export" value="1">Export</button>
        </div>

        <div>
  <label for="sort">Sort by:</label><br>
  <select name="sort" id="sort">
    <option value="">-- None --</option>
    <?php foreach ($displayFields as $f): ?>
      <option value="<?= $f ?>" <?= in_array($f, $sortFields) ? 'selected' : '' ?>>
        <?= ucfirst(str_replace('_', ' ', $f)) ?>
      </option>
    <?php endforeach; ?>
  </select>
</div>


        <div>
          <label for="direction">Direction:</label><br>
          <select name="direction" id="direction">
            <option value="asc" <?= $sortDirection === 'asc' ? 'selected' : '' ?>>A‚ÄìZ / 0‚Äì9</option>
            <option value="desc" <?= $sortDirection === 'desc' ? 'selected' : '' ?>>Z‚ÄìA / 9‚Äì0</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button type="button" onclick="toggleFieldPanel()" style="font-size:0.85rem;">üõ† Show/Hide Field Selection</button>
        <div id="fieldPanel" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px; border-radius:6px; background:#f9f9f9;">
          <fieldset>
            <legend style="font-weight:bold;">Visible Fields:</legend>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
              <?php foreach ($schema as $f): ?>
                <label style="display:flex; align-items:center; gap:4px;">
                  <input type="checkbox" name="display[]" value="<?= $f ?>" <?= in_array($f, $displayFields) ? 'checked' : '' ?>>
                  <?= ucfirst(str_replace('_', ' ', $f)) ?>
                </label>
              <?php endforeach; ?>
            </div>
          </fieldset>
        </div>
      </div>
    </form>

    <table class="contact-table">
      <thead>
        <tr>
          <th>Actions</th>
          <?php foreach ($displayFields as $f): ?>
            <th>
              <?= ucfirst(str_replace('_', ' ', $f)) ?>
              <?php if (isset($activeSort[$f])): ?>
                <span style="<?= $activeSort[$f] === 0 ? 'font-weight:bold; color:#0099A8;' : '' ?>">
                  <?= $sortDirection === 'desc' ? '‚Üì' : '‚Üë' ?>
                </span>
              <?php endif; ?>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($contacts as $contact): ?>
          <?php
            $id = $contact['id'];
            $email = $contact['email'];
            $isDuplicate = $emailCount[strtolower(trim($email))] > 1;
          ?>
          <tr onclick="this.nextElementSibling.classList.toggle('expanded')">
            <td>
              <a href="contact_view.php?id=<?= $id ?>">üëÅ</a>
              <form method="POST" action="delete_contact.php" style="display:inline;" onsubmit="return confirm('Delete this contact?');">
                <input type="hidden" name="id" value="<?= $id ?>">
                <button type="submit" class="btn-outline">üóë</button>
              </form>
            </td>
            <?php foreach ($displayFields as $f): ?>
              <td>
                <?= htmlspecialchars($contact[$f] ?? '') ?>
                <?= ($f === 'email' && $isDuplicate) ? "<span style='color:red;'> [Duplicate]</span>" : '' ?>
              </td>
            <?php endforeach; ?>
          </tr>
          <tr class="details-row">
            <td colspan="<?= count($displayFields) + 1 ?>">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <?php foreach ($schema as $f): ?>
                  <div>
                    <strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong>
                    <?= htmlspecialchars($contact[$f] ?? '') ?>
                  </div>
                <?php endforeach; ?>
              </div>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
</div>

<script>
  function toggleFieldPanel() {
    const panel = document.getElementById('fieldPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }

  document.getElementById('fontSize').addEventListener('change', function () {
    document.documentElement.style.setProperty('--crm-font-size', this.value);
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contacts_list.php ---



--- Start of contact_form.php ---

<?php
$schema = require __DIR__ . '/contact_schema.php';
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Add New Contact</h2>

  <?php if (isset($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Contact saved successfully.</p>
  <?php endif; ?>

  <form id="contact-form" action="add_contact.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>
      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>
        <input type="<?= $field === 'email' ? 'email' : ($field === 'phone' ? 'tel' : 'text') ?>"
               name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Contact</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_form.php ---



--- Start of contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';
require_once 'tag_schema.php';

error_reporting(E_ALL);
ini_set('display_errors', 1);

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = array_keys(require 'tag_schema.php');
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
}
ksort($statusOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$selectedTags = $_GET['tags'] ?? [];
if (!is_array($selectedTags)) $selectedTags = [];
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $selectedTags) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $contactTags = array_map('trim', explode(',', $c['tags'] ?? ''));
    $matchTags = empty($selectedTags) || array_intersect($selectedTags, $contactTags);
    return $matchQuery && $matchStatus && $matchTags;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <fieldset>
      <legend>Tags:</legend>
      <?php foreach ($tagOptions as $tag): ?>
        <label>
          <input type="checkbox" name="tags[]" value="<?= htmlspecialchars($tag) ?>" <?= in_array($tag, $selectedTags) ? 'checked' : '' ?>>
          <?= htmlspecialchars($tag) ?>
        </label>
      <?php endforeach; ?>
    </fieldset>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <form method="post" action="bulk_action.php">
    <table class="table-grid">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <?php foreach ($schema as $field): ?>
            <th>
              <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
                <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
                <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
              </a>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($contacts as $c): ?>
          <tr>
            <td><input type="checkbox" name="selected_ids[]" value="<?= htmlspecialchars($c['id'] ?? '') ?>"></td>
            <?php foreach ($schema as $f): ?>
              <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
            <?php endforeach; ?>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>

    <div class="bulk-actions">
      <select name="action">
        <option value="">-- Bulk Action --</option>
        <option value="export">Export Selected</option>
        <option value="delete">Delete Selected</option>
        <option value="assign_tag">Assign Tag</option>
        <option value="assign_status">Assign Status</option>
      </select>
      <input type="text" name="value" placeholder="Tag or Status">
      <button type="submit">Apply</button>
    </div>
  </form>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.getElementById('select-all').addEventListener('change', function(e) {
  const checkboxes = document.querySelectorAll('input[name="selected_ids[]"]');
  checkboxes.forEach(cb => cb.checked = e.target.checked);
});
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_list.php ---



--- Start of contact_list1.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$searchFields = ['first_name', 'last_name', 'email', 'company'];
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter by search query
if ($query !== '') {
    $contacts = array_filter($contacts, function($c) use ($query, $searchFields) {
        foreach ($searchFields as $field) {
            if (isset($c[$field]) && stripos($c[$field], $query) !== false) {
                return true;
            }
        }
        return false;
    });
}

// Filter by status
if ($statusFilter !== '') {
    $contacts = array_filter($contacts, function($c) use ($statusFilter) {
        return isset($c['status']) && $c['status'] === $statusFilter;
    });
}

// Filter by tag
if ($tagFilter !== '') {
    $contacts = array_filter($contacts, function($c) use ($tagFilter) {
        return isset($c['tags']) && stripos($c['tags'], $tagFilter) !== false;
    });
}

// Sort contacts
$validSortFields = array_filter($sortFields, function($f) use ($schema) {
    return in_array($f, $schema);
});
if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';
            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename=\"$filename\"");
    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}

// Pagination
$total = count($contacts);
$totalPages = ceil($total / $perPage);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <option value="active" <?= $statusFilter === 'active' ? 'selected' : '' ?>>Active</option>
      <option value="inactive" <?= $statusFilter === 'inactive' ? 'selected' : '' ?>>Inactive</option>
    </select>
    <input type="text" name="tag" placeholder="Tag" value="<?= htmlspecialchars($tagFilter) ?>">
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table table-striped">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th><?= htmlspecialchars(ucfirst(str_replace('_', ' ', $field))) ?></th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= $totalPages; $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>"
         class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_list1.php ---



--- Start of contact_schema.php ---

<?php
return [
    'id',
    'first_name',
    'last_name',
    'company',
    'email',
    'phone',
    'address',
    'city',
    'province',
    'postal_code',
    'country',
    'notes',
    'created_at',
    'is_customer',
    'tank_number',
    'delivery_date'
];
?>

--- End of contact_schema.php ---



--- Start of contact_success.php ---

<?php
session_start();
$currentPage = basename(__FILE__); // Dynamically sets active tab
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Saved</title>
  <link rel="stylesheet" href="styles.css"> <!-- Optional external CSS -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .navbar { background: #333; padding: 10px 20px; }
    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; }
    .nav-list li { margin-right: 20px; }
    .nav-list a { color: #fff; text-decoration: none; }
    .nav-list .active a { font-weight: bold; text-decoration: underline; }
    .container { max-width: 600px; margin: 60px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
    .btn { display: inline-block; margin-top: 20px; padding: 10px 20px; background: #0077cc; color: #fff; text-decoration: none; border-radius: 4px; }
    .btn:hover { background: #005fa3; }
  </style>
</head>
<body>

<nav class="navbar">
  <ul class="nav-list">
    <li class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
      <a href="dashboard.php">Dashboard</a>
    </li>
    <li class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
      <a href="contact_form.php">Add Contact</a>
    </li>
    <li class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
      <a href="contacts_list.php">View Contacts</a>
    </li>
    <li class="<?= $currentPage === 'opportunity_form.php' ? 'active' : '' ?>">
      <a href="opportunity_form.php">Add Opportunity</a>
    </li>
    <li class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
      <a href="opportunities_list.php">View Opportunities</a>
    </li>
    <li class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
      <a href="import_contacts.php">Import Contacts</a>
    </li>
    <li class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
      <a href="export_contacts.php">Export Contacts</a>
    </li>
  </ul>
</nav>

<div class="container">
  <h2>‚úÖ Contact Saved Successfully</h2>
  <p>Your new contact has been added to the system and logged for audit.</p>
  <a href="dashboard.php" class="btn">Return to Dashboard</a>
</div>

</body>
</html>


--- End of contact_success.php ---



--- Start of contact_validator.php ---

<?php
require_once 'contact_schema.php';

function validateContact(array $contact): array {
    $schema = require __DIR__ . '/contact_schema.php';
    $requiredFields = ['last_name', 'company', 'address_1', 'city', 'postal_code', 'phone', 'email'];
    $errors = [];

    foreach ($schema as $field) {
        $value = trim($contact[$field] ?? '');

        // Required field check
        if (in_array($field, $requiredFields) && $value === '') {
            $errors[$field] = ucfirst(str_replace('_', ' ', $field)) . " is required.";
            continue;
        }

        // Field-specific validation
        switch ($field) {
            case 'email':
                if ($value && !filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[$field] = "Invalid email format.";
                }
                break;

            case 'phone':
                if ($value && !preg_match('/^\+?[0-9\s\-().]{7,}$/', $value)) {
                    $errors[$field] = "Invalid phone number.";
                }
                break;

            case 'website':
                if ($value && !filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[$field] = "Invalid website URL.";
                }
                break;

            // Add more field-specific rules here if needed
        }
    }

    return $errors;
}


--- End of contact_validator.php ---



--- Start of contact_view.php ---

<?php
session_start();

// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Include layout and dependencies (all files are in root)
include_once('layout_start.php');
include_once('navbar.php');
require_once 'csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require 'contact_schema.php';
$customerSchema = require 'customer_schema.php';
$contacts = readCSV('contacts.csv', $schema);
$customers = readCSV('customers.csv', $customerSchema);

// Index contacts by ID for faster lookup
$contactsById = [];
foreach ($contacts as $c) {
    if (empty($c['id'])) {
        $c['id'] = 'CNT_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
    }
    $contactsById[$c['id']] = $c;
}

// Helper: resolve customer by ID
function findCustomerById($customers, $cid) {
    foreach ($customers as $c) {
        if ($c['customer_id'] === $cid) return $c;
    }
    return null;
}

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Update contact details
    if (isset($_POST['id']) && isset($contactsById[$_POST['id']])) {
        $id = $_POST['id'];
        foreach ($schema as $f) {
            $contactsById[$id][$f] = htmlspecialchars(trim($_POST[$f] ?? $contactsById[$id][$f]));
        }
        if (isset($_POST['is_customer'])) {
            $contactsById[$id]['is_customer'] = $_POST['is_customer'];
        }
        writeCSV('contacts.csv', array_values($contactsById), $schema);
        header("Location: contact_view.php?id=" . urlencode($id));
        exit;
    }

    // Handle discussion entry
    if (isset($_POST['contact_id']) && isset($contactsById[$_POST['contact_id']])) {
        $data = [
            'contact_id' => $_POST['contact_id'],
            'author' => htmlspecialchars(trim($_POST['author'])),
            'timestamp' => date('Y-m-d H:i'),
            'entry_text' => htmlspecialchars(trim($_POST['entry_text'])),
            'linked_opportunity_id' => htmlspecialchars($_POST['linked_opportunity_id'] ?? ''),
            'visibility' => htmlspecialchars($_POST['visibility'] ?? 'public')
        ];
        $fp = fopen('discussion_log.csv', 'a');
        if ($fp) {
            fputcsv($fp, array_values($data));
            fclose($fp);
        }
        header("Location: contact_view.php?id=" . urlencode($data['contact_id']));
        exit;
    }
}

// Load contact
$id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING);
$contact = $contactsById[$id] ?? null;

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once('layout_end.php');
    exit;
}

// Resolve associated customer
$customer = findCustomerById($customers, $contact['customer_id'] ?? '');
?>

<div class="container">
  <h2>Contact Details</h2>

  <div class="contact-header" style="display: flex; align-items: center; justify-content: space-between;">
    <?php if ($customer): ?>
      <div class="customer-info">
        <strong>Company:</strong> <?= htmlspecialchars($customer['contact_name'] ?? '') ?><br>
        <strong>Address:</strong> <?= htmlspecialchars($customer['address'] ?? '') ?>
      </div>
    <?php else: ?>
      <div class="customer-info muted">
        <em>This contact is not assigned to a company.</em>
      </div>
    <?php endif; ?>

    <?php if (($contact['is_customer'] ?? '') !== 'yes'): ?>
      <form method="post" style="margin-left: 2em;">
        <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">
        <input type="hidden" name="is_customer" value="yes">
        <button type="submit" class="btn-outline">‚úÖ Mark as Client</button>
      </form>
    <?php else: ?>
      <p style="margin-left: 2em;"><strong>Status:</strong> This contact is already marked as a client.</p>
    <?php endif; ?>
  </div>

  <!-- Editable Contact Form -->
  <form method="post" class="contact-form">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <div class="form-group">
        <label for="customer_id"><strong>Company:</strong></label><br>
        <select name="customer_id" id="customer_id">
          <option value="">-- None --</option>
          <?php foreach ($customers as $cust): ?>
            <option value="<?= htmlspecialchars($cust['customer_id']) ?>"
              <?= ($contact['customer_id'] ?? '') === $cust['customer_id'] ? 'selected' : '' ?>>
              <?= htmlspecialchars($cust['contact_name']) ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Save Changes</button>
    </div>
  </form>

  <?php include_once('discussion_module.php'); ?>
  <?php include_once('follow_up_email.php'); ?>

  <div class="navigation">
    <a href="contacts_list.php" class="btn-outline">‚¨Ö Back to Contact List</a>
  </div>
</div>

<?php include_once('layout_end.php'); ?>


--- End of contact_view.php ---



--- Start of csv_export.php ---

function exportCSVFiltered($filename, $rows, $filters = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered));
}


--- End of csv_export.php ---



--- Start of csv_handler.php ---

<?php
function readCSV($filename, $schema) {
    $data = [];
    if (!file_exists($filename)) return $data;
    $file = fopen($filename, 'r');
    if ($file === false) throw new Exception("Unable to open file: $filename");
    while (($row = fgetcsv($file)) !== false) {
        if (count($row) === count($schema)) {
            $data[] = array_combine($schema, $row);
        }
    }
    fclose($file);
    return $data;
}

function writeCSV($filename, $data, $schema) {
    $file = fopen($filename, 'w');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    foreach ($data as $row) {
        $csvRow = [];
        foreach ($schema as $field) {
            $value = $row[$field] ?? '';
            // Prevent CSV injection
            if (preg_match('/^[=+\\-@]/', $value)) {
                $value = "'" . $value;
            }
            $csvRow[] = $value;
        }
        fputcsv($file, $csvRow);
    }
    fclose($file);
}

function appendCSV($filename, $row) {
    $file = fopen($filename, 'a');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    fputcsv($file, $row);
    fclose($file);
}
?>

--- End of csv_handler.php ---



--- Start of csv_import.php ---

function importCSVWithSchema($filename, $schema, $keyField, $existingRows) {
    $newRows = [];
    $imported = readCSV($filename);
    foreach ($imported as $row) {
        if (!array_diff($schema, array_keys($row)) && !in_array($row[$keyField], array_column($existingRows, $keyField))) {
            $newRows[] = $row;
        }
    }
    return $newRows;
}


--- End of csv_import.php ---



--- Start of customers_list.php ---

<?php
// customers_list.php

header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once __DIR__ . '/csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter only customers
$customers = array_filter($contacts, function($c) {
    return in_array(strtolower(trim($c['is_customer'] ?? '')), ['yes', 'true', '1']);
});
?>

<div class="container">
  <h2>Customer List</h2>

  <table class="table-grid">
    <thead>
      <tr>
		<th>Company</th>
        <th>First Name</th>
        <th>Email</th>
        <th>Customer Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($customers as $contact): ?>
        <tr>
          <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
		  <td><?= htmlspecialchars($contact['first_name'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['is_customer'] ?? '') ?></td>
          <td>
            <a href="customer_view.php?id=<?= urlencode($contact['id']) ?>" class="btn-primary">üëÅ View</a>
            <?php
              $deliveryFile = "{$contact['id']}_deliveries.csv";
              if (file_exists(__DIR__ . "/$deliveryFile")):
            ?>
              <a href="<?= htmlspecialchars($deliveryFile) ?>" class="btn-secondary" target="_blank">üì¶ Delivery Archive</a>
            <?php endif; ?>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="navigation">
    <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of customers_list.php ---



--- Start of customer_item_config.php ---

<?php
return [
  'tank_number',
  'tank_size',
  'type_of_resin',
  'delivery_date',
  'regeneration_number',
  'purchase_order'
];


--- End of customer_item_config.php ---



--- Start of customer_schema.php ---

<?php
return [
  'customer_id',
  'contact_name',
  'address',
  'tank_count',
  'last_delivery'
];


--- End of customer_schema.php ---



--- Start of customer_view.php ---

<?php


// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Includes
include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once __DIR__ . '/csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Helper: find contact by ID
function findContactById($contacts, $id) {
    if ($id === '') return null;
    foreach ($contacts as $c) {
        if ($c['id'] === $id) return $c;
    }
    return null;
}

// Helper: create delivery file
function createDeliveryFileIfNeeded($contactId) {
    $deliveryFile = __DIR__ . "/{$contactId}_deliveries.csv";
    if (!file_exists($deliveryFile)) {
        $fp = fopen($deliveryFile, 'w');
        if ($fp) {
            fputcsv($fp, ['delivery_date', 'tank_number', 'tank_size']);
            fclose($fp);
            return true;
        } else {
            error_log("Failed to create delivery file for contact ID: $contactId");
            return false;
        }
    }
    return true;
}

// Handle contact update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['id'])) {
    $id = $_POST['id'];
    foreach ($contacts as &$c) {
        if ($c['id'] === $id) {
            foreach ($schema as $f) {
                $c[$f] = $_POST[$f] ?? $c[$f];
            }

            // Create delivery file if marked as customer
            if (isset($_POST['is_customer']) && strtolower(trim($_POST['is_customer'])) === 'yes') {
                if (!createDeliveryFileIfNeeded($id)) {
                    echo "<div class='alert-error'>‚ö†Ô∏è Delivery file could not be created for customer ID: $id</div>";
                }
            }

            break;
        }
    }
    writeCSV('contacts.csv', $contacts, $schema);
    header("Location: customer_view.php?id=" . urlencode($id));
    exit;
}

// Load contact
$id = $_GET['id'] ?? '';
$contact = findContactById($contacts, $id);

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once(__DIR__ . '/layout_end.php');
    exit;
}
?>

<div class="container">
  <h2>Customer Details</h2>
  

  <form method="post" class="contact-form">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php elseif ($f === 'id'): ?>
            <input type="text" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>" disabled>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

    <div class="form-actions">
  <button type="submit" class="btn-primary">üíæ Save Changes</button>
	</div>

<?php
if (strtolower(trim($contact['is_customer'] ?? '')) === 'yes') {
    $deliveryFile = "{$contact['id']}_deliveries.csv";
    $deliveryFilePath = __DIR__ . "/$deliveryFile";
    if (file_exists($deliveryFilePath)) {
        $deliveryUrl = "deliveries.php?id=" . urlencode($contact['id']);
        echo '<a href="' . $deliveryUrl . '" class="btn-primary">üì¶ View Delivery Archive</a>';
    }
}
?>




<?php include_once(__DIR__ . '/layout_end.php'); ?>

--- End of customer_view.php ---



--- Start of dashboard.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>
<?php
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
$forecastData = calculateForecasts();
$forecasts = $forecastData['individual'];
$forecastByStage = $forecastData['by_stage'];

$totalContacts = count($contacts);
$totalValue = array_sum(array_column($opportunities, 'value'));
$totalForecast = array_sum(array_column($forecasts, 'forecast'));
$accuracy = $totalValue > 0 ? ($totalForecast / $totalValue) * 100 : 0;

// Identify top forecast stage
$topStage = '';
$maxForecast = 0;
foreach ($forecastByStage as $stage => $data) {
    if ($data['total_forecast'] > $maxForecast) {
        $maxForecast = $data['total_forecast'];
        $topStage = $stage;
    }
}

echo "<h2>CRM Dashboard</h2>";
echo "<div class='dashboard-card'><strong>Total Contacts:</strong> $totalContacts</div>";
echo "<div class='dashboard-card'><strong>Total Opportunity Value:</strong> $" . number_format($totalValue, 2) . "</div>";
echo "<div class='dashboard-card'><strong>Total Forecast Value:</strong> $" . number_format($totalForecast, 2) . "</div>";
echo "<div class='dashboard-card'><strong>Forecast Accuracy:</strong> " . number_format($accuracy, 1) . "%</div>";
echo "<div class='dashboard-card'><strong>Top Forecast Stage:</strong> $topStage</div>";

// Pipeline breakdown
$stages = [];
foreach ($opportunities as $opp) {
    $stage = $opp['stage'];
    $value = floatval($opp['value']);
    if (!isset($stages[$stage])) {
        $stages[$stage] = ['count' => 0, 'value' => 0];
    }
    $stages[$stage]['count']++;
    $stages[$stage]['value'] += $value;
}

echo "<h3>Pipeline Breakdown</h3>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Stage</th><th>Count</th><th>Total Value</th></tr>";
foreach ($stages as $stage => $data) {
    echo "<tr>";
    echo "<td>$stage</td>";
    echo "<td>{$data['count']}</td>";
    echo "<td>$" . number_format($data['value'], 2) . "</td>";
    echo "</tr>";
}
echo "</table>";

echo "<h3>Forecast by Stage</h3>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Stage</th><th>Count</th><th>Total Forecast</th></tr>";
foreach ($forecastByStage as $stage => $data) {
    echo "<tr>";
    echo "<td>$stage</td>";
    echo "<td>{$data['count']}</td>";
    echo "<td>$" . number_format($data['total_forecast'], 2) . "</td>";
    echo "</tr>";
}
echo "</table>";
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of dashboard.php ---



--- Start of delete_contact.php ---

<?php
require_once 'contact_validator.php';
require_once 'csv_handler.php';

$idToDelete = $_POST['id'] ?? null;
if (!$idToDelete) {
    echo "No contact ID provided.";
    exit;
}

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter out the contact to delete
$filtered = array_filter($contacts, function($c) use ($idToDelete) {
    return $c['id'] !== $idToDelete;
});

// Defensive write: ensure header matches schema
$fp = fopen('contacts.csv', 'w');
fputcsv($fp, $schema);
foreach ($filtered as $row) {
    $line = [];
    foreach ($schema as $col) {
        $line[] = array_key_exists($col, $row) ? $row[$col] : '';
    }
    fputcsv($fp, $line);
}
fclose($fp);

header('Location: contacts_list.php');
exit;
?>


--- End of delete_contact.php ---



--- Start of delete_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if (isset($_GET['timestamp'])) {
    deleteTask($filename, $schema, $_GET['timestamp']);
}
header('Location: index.php');
exit;


--- End of delete_task.php ---



--- Start of deliveries.php ---

<?php
include_once 'navbar.php';
include_once 'layout_start.php';

// Get customer ID from GET
$id = isset($_GET['id']) ? preg_replace('/[^a-zA-Z0-9_-]/', '', $_GET['id']) : null;

if (!$id) {
    echo "<p>Error: No customer ID specified.</p>";
    include_once 'layout_end.php';
    exit;
}

$csvFile = "deliveries_$id.csv";

// Create file if it doesn't exist
if (!file_exists($csvFile)) {
    $fp = fopen($csvFile, 'w');
    fputcsv($fp, ['Date', 'Company', 'Tank #', 'Size']); // Header row
    fclose($fp);
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $date = $_POST['delivery_date'];
    $company = $_POST['company'];
    $tank_number = $_POST['tank_number'];
    $tank_size = $_POST['tank_size'];

    $newEntry = [$date, $company, $tank_number, $tank_size];
    $fp = fopen($csvFile, 'a');
    fputcsv($fp, $newEntry);
    fclose($fp);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delivery Archive - Customer #<?php echo htmlspecialchars($id); ?></title>
  <script>
    function sortTable(n) {
      const table = document.getElementById("deliveryTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let shouldSwitch = dir === "asc" ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase();
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
            break;
          }
        }
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  </script>
</head>
<body>
  <h2>üì¶ Delivery Archive for Customer #<?php echo htmlspecialchars($id); ?></h2>

  <form method="post">
    <label><strong>Add New Delivery:</strong></label><br>
    <input type="date" name="delivery_date" required>
    <input type="text" name="company" required>
    <input type="text" name="tank_number" placeholder="Tank #" required>
    <input type="text" name="tank_size" placeholder="Size" required>
    <button type="submit">‚ûï Add Delivery</button>
  </form>

  <br>
  customer_view.php?id=<?php echo urlencode($id); ?>
    <button>üîô Back to Customer Details</button>
  </a>

  <br><br>
  <table id="deliveryTable" border="1">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Date</th>
        <th onclick="sortTable(1)">Company</th>
        <th onclick="sortTable(2)">Tank #</th>
        <th onclick="sortTable(3)">Size</th>
      </tr>
    </thead>
    <tbody>
      <?php
      $rows = array_map('str_getcsv', file($csvFile));
      array_shift($rows); // Remove header
      if (count($rows) > 0) {
          foreach ($rows as $row) {
              echo "<tr>";
              foreach ($row as $cell) {
                  echo "<td>" . htmlspecialchars($cell) . "</td>";
              }
              echo "</tr>";
          }
      } else {
          echo "<tr><td colspan='4'>No delivery records found.</td></tr>";
      }
      ?>
    </tbody>
  </table>
</body>
</html>
<?php include_once 'layout_end.php'; ?>

--- End of deliveries.php ---



--- Start of discussion_logger.php ---

<?php
// discussion_logger.php

// Set plain text response headers
header('Content-Type: text/plain; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Log raw POST data for debugging
file_put_contents('debug_log.txt', print_r($_POST, true) . PHP_EOL, FILE_APPEND);

// Use $_POST directly
$data = $_POST;

// Define the logging function
function logDiscussionEntry(array $data): bool {
    $file = 'discussion_log.csv';
    $logFile = 'error_log.txt';
    $schema = require __DIR__ . '/discussion_schema.php';

    // Build row using schema order
    $row = [];
    foreach ($schema as $col) {
        switch ($col) {
            case 'timestamp':
                $row[] = date('Y-m-d H:i');
                break;
            case 'entry_text':
                $row[] = isset($data[$col]) ? str_replace(["\r", "\n"], ' ', $data[$col]) : '';
                break;
            case 'author':
                $row[] = $data[$col] ?? 'System';
                break;
            case 'linked_opportunity_id':
                $row[] = $data[$col] ?? '';
                break;
            case 'visibility':
                $row[] = $data[$col] ?? 'private';
                break;
            default:
                $row[] = $data[$col] ?? '';
        }
    }

    // Try to append to CSV
    if (($fp = fopen($file, 'a')) !== false) {
        fputcsv($fp, $row);
        fclose($fp);
        return true;
    }

    // Log error if write fails
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write to $file for contact_id: {$data['contact_id']}\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    return false;
}

// Output plain success or error message
if (!empty($data) && logDiscussionEntry($data)) {
    echo "Logged successfully";
} else {
    echo "Logging failed or invalid data";
}
?>


--- End of discussion_logger.php ---



--- Start of discussion_module.php ---

<?php
$cid = $contact['id'] ?? '';
if (empty($cid)) return;

$discussionSchema = require __DIR__ . '/discussion_schema.php';
$discussionLog = readCSV('discussion_log.csv', $discussionSchema) ?: [];

$entries = array_filter($discussionLog, fn($e) => trim($e['contact_id']) === trim($cid));
usort($entries, fn($a, $b) => strtotime($b['timestamp']) <=> strtotime($a['timestamp']));
?>

<div style="margin-top:40px;">
  <h3>Discussion</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:40px; align-items:start;">

    <!-- Add Discussion Entry (Left) -->
    <div>
      <h4>Add Discussion Entry</h4>
      <form method="post" style="display:grid; gap:15px;">
        <input type="hidden" name="contact_id" value="<?= htmlspecialchars($cid) ?>">

        <div>
          <label for="author">Author:</label><br>
          <input type="text" name="author" id="author" value="Robert Lee" required>
        </div>

        <div>
          <label for="entry_text">Comment:</label><br>
          <textarea name="entry_text" id="entry_text" rows="4" required></textarea>
        </div>

        <div>
          <label for="linked_opportunity_id">Linked Opportunity ID (optional):</label><br>
          <input type="text" name="linked_opportunity_id" id="linked_opportunity_id">
        </div>

        <div>
          <label for="visibility">Visibility:</label><br>
          <select name="visibility" id="visibility">
            <option value="public">Public</option>
            <option value="internal">Internal</option>
          </select>
        </div>

        <button type="submit" class="btn-primary">üí¨ Log Discussion</button>
      </form>
    </div>

    <!-- Discussion History (Right) -->
    <div>
      <h4>Discussion History</h4>
      <?php if (!empty($entries)): ?>
        <?php foreach ($entries as $entry): ?>
          <div style="border-left:3px solid #0099A8; padding-left:10px; margin-bottom:15px;">
            <div style="font-size:0.9em; color:#555;">
              <strong><?= htmlspecialchars($entry['author'] ?? 'Admin') ?></strong>
              <em><?= htmlspecialchars($entry['timestamp'] ?? '') ?></em>
              <?php if (!empty($entry['linked_opportunity_id'])): ?>
                ‚Ä¢ <span>Opportunity: <?= htmlspecialchars($entry['linked_opportunity_id']) ?></span>
              <?php endif; ?>
              <?php if (!empty($entry['visibility'])): ?>
                ‚Ä¢ <span>Visibility: <?= htmlspecialchars($entry['visibility']) ?></span>
              <?php endif; ?>
            </div>
            <div style="margin-top:5px;">
              <?= nl2br(htmlspecialchars($entry['entry_text'] ?? '')) ?>
            </div>
          </div>
        <?php endforeach; ?>
      <?php else: ?>
        <p style="color:#666;">No discussion history found for this contact.</p>
      <?php endif; ?>
    </div>

  </div>
</div>


--- End of discussion_module.php ---



--- Start of discussion_schema.php ---

<?php
return [
    'contact_id',
    'author',
    'timestamp',
    'entry_text',
    'linked_opportunity_id',
    'visibility'
];


--- End of discussion_schema.php ---



--- Start of discussion_validator.php ---

<?php
function validateDiscussion(array $data): array {
    $errors = [];

    if (empty($data['contact_id'])) {
        $errors['contact_id'] = 'Contact ID is required.';
    }

    if (empty($data['entry_text'])) {
        $errors['entry_text'] = 'Comment text is required.';
    }

    if (empty($data['author'])) {
        $errors['author'] = 'Author is required.';
    }

    return $errors;
}


--- End of discussion_validator.php ---



--- Start of edit_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $updatedTask = [
        $_POST['title'],
        $_POST['due_date'],
        $_POST['status'],
        $_POST['timestamp']
    ];
    updateTask($filename, $schema, $_POST['timestamp'], $updatedTask);
    header('Location: index.php');
    exit;
}

$timestamp = $_GET['timestamp'] ?? '';
$tasks = readCSV($filename, $schema);
$taskToEdit = null;
foreach ($tasks as $task) {
    if ($task['timestamp'] === $timestamp) {
        $taskToEdit = $task;
        break;
    }
}
if (!$taskToEdit) {
    echo "Task not found.";
    exit;
}
?>

<h3>Edit Task</h3>
<form method="POST">
  <input type="hidden" name="timestamp" value="<?= htmlspecialchars($taskToEdit['timestamp']) ?>">
  <input type="text" name="title" value="<?= htmlspecialchars($taskToEdit['title']) ?>" required>
  <input type="date" name="due_date" value="<?= htmlspecialchars($taskToEdit['due_date']) ?>" required>
  <select name="status" required>
    <option value="pending" <?= $taskToEdit['status'] === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $taskToEdit['status'] === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <button type="submit">Update Task</button>
</form>


--- End of edit_task.php ---



--- Start of enhanced_contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = [];
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
    if (!empty($c['tags'])) {
        foreach (explode(',', $c['tags']) as $tag) {
            $tagOptions[trim($tag)] = true;
        }
    }
}
ksort($statusOptions);
ksort($tagOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $tagFilter) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $matchTag = $tagFilter === '' || in_array($tagFilter, array_map('trim', explode(',', $c['tags'] ?? '')));
    return $matchQuery && $matchStatus && $matchTag;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <select name="tag">
      <option value="">-- Tag --</option>
      <?php foreach (array_keys($tagOptions) as $tag): ?>
        <option value="<?= htmlspecialchars($tag) ?>" <?= $tag === $tagFilter ? 'selected' : '' ?>><?= htmlspecialchars($tag) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table-grid">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th>
            <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
              <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
              <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
            </a>
          </th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of enhanced_contact_list.php ---



--- Start of export_contacts.php ---

<?php
require_once 'csv_handler.php';
require_once 'csv_export.php';

$filename = 'contacts.csv';
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV($filename, $schema);

// Build filters from query string using schema
$filters = [];
foreach ($schema as $field) {
    if (!empty($_GET[$field])) {
        $filters[$field] = $_GET[$field];
    }
}

// Schema-safe export function
function exportCSVFiltered($filename, $rows, $filters = [], $schema = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered), $schema);
}

// Export filtered contacts to a new file
$exported = exportCSVFiltered('contacts_export.csv', $contacts, $filters, $schema);
echo $exported ? "Export complete." : "No matching contacts.";
?>


--- End of export_contacts.php ---



--- Start of follow_up_email.php ---

<?php
// follow_up_email.php

$contactName = $contact['name'] ?? 'there';
$companyName = $contact['company'] ?? 'your team';
$contactEmail = $contact['email'] ?? '';
$contactId = $contact['id'] ?? 0;
?>

<div class="module follow-up-email">
  <h3>Send Email</h3>
  <button onclick="generateEmail('followup')">Follow-Up After Call</button>
  <button onclick="generateEmail('intro')">Introductory Email</button>
  <button onclick="generateEmail('touchbase')">Touch Base Email</button>
  <button id="sendEmailBtn" onclick="sendFollowUpEmail()">Send Email</button>

  <textarea id="followUpEmail" rows="12" class="email-textarea"></textarea>
</div>

<script>
const contactName = "<?= htmlspecialchars($contactName, ENT_QUOTES) ?>";
const contactEmail = "<?= htmlspecialchars($contactEmail, ENT_QUOTES) ?>";
let currentEmailType = '';

function generateEmail(type) {
  currentEmailType = type;

  let body = '';
  switch (type) {
    case 'followup':
      body = `Hi ${contactName},

It was great speaking with you earlier. I wanted to follow up on our conversation and thank you for taking the time to connect.

At Eclipse Water Technologies, we‚Äôre committed to providing responsive, local service without the delays or complications of cross-border logistics. Whether it‚Äôs a complex treatment challenge or a routine system check, our team is here to support you.

If you have any questions or would like to explore next steps, feel free to reach out anytime.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'intro':
      body = `Hi ${contactName},

I wanted to introduce you to Eclipse Water Technologies ‚Äî a local provider of industrial water and wastewater solutions.

We specialize in everything from advanced treatment systems to simple filter replacements, and our team is known for responsive service and technical expertise. Being local means no border delays or tariffs ‚Äî just fast, reliable support.

We‚Äôd love to learn more about your needs and explore how we can help.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'touchbase':
      body = `Hi ${contactName},

I hope things are going well on your end. I just wanted to touch base and see if there‚Äôs anything you might need support with regarding your water or wastewater systems.

At Eclipse Water Technologies, we‚Äôre always happy to reconnect and help ‚Äî whether it‚Äôs a quick filter change or a more involved project.

Feel free to reach out anytime if you'd like to chat or explore options.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;
  }

  document.getElementById('followUpEmail').value = body;
}

function sendFollowUpEmail() {
  const emailBody = document.getElementById('followUpEmail').value.trim();
  const subjectLine = "Industrial Water Treatment - Eclipse Water Technologies";

  if (!contactEmail) {
    alert("No email address found for this contact.");
    return;
  }

  if (!emailBody) {
    alert("Email body is empty. Please generate or write your message.");
    return;
  }

  const mailtoLink = `mailto:${contactEmail}?subject=${encodeURIComponent(subjectLine)}&body=${encodeURIComponent(emailBody)}`;
  window.location.href = mailtoLink;
}
</script>

--- End of follow_up_email.php ---



--- Start of forecast_calc.php ---

<?php
require_once 'csv_handler.php';

function calculateForecasts($filename = 'opportunities.csv') {
    $schema = require __DIR__ . '/opportunity_schema.php';
    $opportunities = readCSV($filename, $schema);
    $results = [];
    $stageTotals = [];

    foreach ($opportunities as $opp) {
        $value = floatval($opp['value']);
        $probability = floatval($opp['probability']);
        $forecast = round($value * ($probability / 100), 2);

        $stage = $opp['stage'] ?? 'Unspecified';

        // Add to grouped stage totals
        if (!isset($stageTotals[$stage])) {
            $stageTotals[$stage] = ['count' => 0, 'total_forecast' => 0];
        }
        $stageTotals[$stage]['count']++;
        $stageTotals[$stage]['total_forecast'] += $forecast;

        // Add to individual forecast list
        $results[] = [
            'id' => $opp['id'] ?? '',
            'contact_id' => $opp['contact_id'] ?? '',
            'stage' => $stage,
            'value' => $value,
            'forecast' => $forecast
        ];
    }

    return [
        'individual' => $results,
        'by_stage' => $stageTotals
    ];
}
?>


--- End of forecast_calc.php ---



--- Start of get_oauth_token.php ---

<?php


require_once 'contact_validator.php';/**
 * PHPMailer - PHP email creation and transport class.
 * PHP Version 5.5
 * @package PHPMailer
 * @see https://github.com/PHPMailer/PHPMailer/ The PHPMailer GitHub project
 * @author Marcus Bointon (Synchro/coolbru) <phpmailer@synchromedia.co.uk>
 * @author Jim Jagielski (jimjag) <jimjag@gmail.com>
 * @author Andy Prevost (codeworxtech) <codeworxtech@users.sourceforge.net>
 * @author Brent R. Matzelle (original founder)
 * @copyright 2012 - 2020 Marcus Bointon
 * @copyright 2010 - 2012 Jim Jagielski
 * @copyright 2004 - 2009 Andy Prevost
 * @license https://www.gnu.org/licenses/old-licenses/lgpl-2.1.html GNU Lesser General Public License
 * @note This program is distributed in the hope that it will be useful - WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.
 */

/**
 * Get an OAuth2 token from an OAuth2 provider.
 * * Install this script on your server so that it's accessible
 * as [https/http]://<yourdomain>/<folder>/get_oauth_token.php
 * e.g.: http://localhost/phpmailer/get_oauth_token.php
 * * Ensure dependencies are installed with 'composer install'
 * * Set up an app in your Google/Yahoo/Microsoft account
 * * Set the script address as the app's redirect URL
 * If no refresh token is obtained when running this file,
 * revoke access to your app and run the script again.
 */

namespace PHPMailer\PHPMailer;

/**
 * Aliases for League Provider Classes
 * Make sure you have added these to your composer.json and run `composer install`
 * Plenty to choose from here:
 * @see https://oauth2-client.thephpleague.com/providers/thirdparty/
 */
//@see https://github.com/thephpleague/oauth2-google
use League\OAuth2\Client\Provider\Google;
//@see https://packagist.org/packages/hayageek/oauth2-yahoo
use Hayageek\OAuth2\Client\Provider\Yahoo;
//@see https://github.com/stevenmaguire/oauth2-microsoft
use Stevenmaguire\OAuth2\Client\Provider\Microsoft;
//@see https://github.com/greew/oauth2-azure-provider
use Greew\OAuth2\Client\Provider\Azure;

if (!isset($_GET['code']) && !isset($_POST['provider'])) {
    ?>
<html>
<body>
<?php include_once 'navbar.php'; ?>
<?php include 'navbar.php'; ?>
<form method="post">
    <h1>Select Provider</h1>
    <input type="radio" name="provider" value="Google" id="providerGoogle">
    <label for="providerGoogle">Google</label><br>
    <input type="radio" name="provider" value="Yahoo" id="providerYahoo">
    <label for="providerYahoo">Yahoo</label><br>
    <input type="radio" name="provider" value="Microsoft" id="providerMicrosoft">
    <label for="providerMicrosoft">Microsoft</label><br>
    <input type="radio" name="provider" value="Azure" id="providerAzure">
    <label for="providerAzure">Azure</label><br>
    <h1>Enter id and secret</h1>
    <p>These details are obtained by setting up an app in your provider's developer console.
    </p>
    <p>ClientId: <input type="text" name="clientId"><p>
    <p>ClientSecret: <input type="text" name="clientSecret"></p>
    <p>TenantID (only relevant for Azure): <input type="text" name="tenantId"></p>
    <input type="submit" value="Continue">
</form>
<?php include 'layout_end.php'; ?>
</body>
</html>
    <?php
    exit;
}

require 'vendor/autoload.php';

session_start();

$providerName = '';
$clientId = '';
$clientSecret = '';
$tenantId = '';

if (array_key_exists('provider', $_POST)) {
    $providerName = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST['provider'];
    $clientId = $_POST['clientId'];
    $clientSecret = $_POST['clientSecret'];
    $tenantId = $_POST['tenantId'];
    $_SESSION['provider'] = $providerName;
    $_SESSION['clientId'] = $clientId;
    $_SESSION['clientSecret'] = $clientSecret;
    $_SESSION['tenantId'] = $tenantId;
} elseif (array_key_exists('provider', $_SESSION)) {
    $providerName = $_SESSION['provider'];
    $clientId = $_SESSION['clientId'];
    $clientSecret = $_SESSION['clientSecret'];
    $tenantId = $_SESSION['tenantId'];
}

//If you don't want to use the built-in form, set your client id and secret here
//$clientId = 'RANDOMCHARS-----duv1n2.apps.googleusercontent.com';
//$clientSecret = 'RANDOMCHARS-----lGyjPcRtvP';

//If this automatic URL doesn't work, set it yourself manually to the URL of this script
$redirectUri = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'];
//$redirectUri = 'http://localhost/PHPMailer/redirect';

$params = [
    'clientId' => $clientId,
    'clientSecret' => $clientSecret,
    'redirectUri' => $redirectUri,
    'accessType' => 'offline'
];

$options = [];
$provider = null;

switch ($providerName) {
    case 'Google':
        $provider = new Google($params);
        $options = [
            'scope' => [
                'https://mail.google.com/'
            ]
        ];
        break;
    case 'Yahoo':
        $provider = new Yahoo($params);
        break;
    case 'Microsoft':
        $provider = new Microsoft($params);
        $options = [
            'scope' => [
                'wl.imap',
                'wl.offline_access'
            ]
        ];
        break;
    case 'Azure':
        $params['tenantId'] = $tenantId;

        $provider = new Azure($params);
        $options = [
            'scope' => [
                'https://outlook.office.com/SMTP.Send',
                'offline_access'
            ]
        ];
        break;
}

if (null === $provider) {
    exit('Provider missing');
}

if (!isset($_GET['code'])) {
    //If we don't have an authorization code then get one
    $authUrl = $provider->getAuthorizationUrl($options);
    $_SESSION['oauth2state'] = $provider->getState();
    header('Location: ' . $authUrl);
    exit;
    //Check given state against previously stored one to mitigate CSRF attack
} elseif (empty($_GET['state']) || ($_GET['state'] !== $_SESSION['oauth2state'])) {
    unset($_SESSION['oauth2state']);
    unset($_SESSION['provider']);
    exit('Invalid state');
} else {
    unset($_SESSION['provider']);
    //Try to get an access token (using the authorization code grant)
    $token = $provider->getAccessToken(
        'authorization_code',
        [
            'code' => $_GET['code']
        ]
    );
    //Use this to interact with an API on the users behalf
    //Use this to get a new access token if the old one expires
    echo 'Refresh Token: ', htmlspecialchars($token->getRefreshToken());
}


--- End of get_oauth_token.php ---



--- Start of get_tasks.php ---

<?php
$filename = 'tasks.csv';

if (!file_exists($filename)) {
    exit;
}

$tasks = [];

if (($fp = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($fp); // Read header row
    while (($row = fgetcsv($fp)) !== false) {
        $task = array_combine($headers, $row);
        if ($task['status'] !== 'archived') {
            $id = htmlspecialchars($task['id']);
            $title = htmlspecialchars($task['title']);
            $timestamp = htmlspecialchars($task['timestamp']);
            $tasks[] = "<li>$title (Created: $timestamp) <button onclick=\"archiveTask('$id')\">Archive</button></li>";
        }
    }
    fclose($fp);
}

echo implode('', $tasks);
?>

--- End of get_tasks.php ---



--- Start of import_contacts.php ---

<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
$pageTitle = 'Import Contacts';
$currentPage = basename(__FILE__);
include_once 'layout_start.php';
include_once 'navbar.php';
require_once 'csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
?>

<div class="container">
  <h2>Import Contacts</h2>

  <!-- Upload Form -->
  <form method="POST" enctype="multipart/form-data" class="contact-form">
    <label for="csv_file">Upload CSV File:</label>
    <input type="file" name="csv_file" accept=".csv" required>

    <!-- Buttons aligned horizontally -->
    <div style="margin-top: 10px;">
      <button type="submit">Preview Import</button>
      <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name'])): ?>
        <button type="button" class="btn-confirm" onclick="showConfirmModal()">Commit Import</button>
      <?php endif; ?>
    </div>
  </form>

  <?php
  if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name'])) {
      $tmp = $_FILES['csv_file']['tmp_name'];
      $rows = array_map('str_getcsv', file($tmp));
      $header = array_map('trim', array_shift($rows));
      $preview = [];

      foreach ($rows as $row) {
          $contact = array_combine($header, $row);
          $contact['id'] = uniqid();

          foreach ($schema as $field) {
              if (!isset($contact[$field])) {
                  $contact[$field] = '';
              }
          }

          $preview[] = $contact;
      }

      $_SESSION['import_preview'] = $preview;

      echo "<h3>Preview Contacts</h3>";

      if (empty($preview)) {
          echo "<p style='color:red;'>No contacts to preview.</p>";
      } else {
          echo "<form method='POST' action='commit_import.php' id='commitForm'>";
          echo "<table class='spec-table'><thead><tr>";
          foreach ($schema as $col) {
              echo "<th>" . htmlspecialchars(ucfirst(str_replace('_', ' ', $col))) . "</th>";
          }
          echo "</tr></thead><tbody>";
          foreach ($preview as $contact) {
              echo "<tr>";
              foreach ($schema as $col) {
                  echo "<td>" . htmlspecialchars($contact[$col] ?? '') . "</td>";
              }
              echo "</tr>";
          }
          echo "</tbody></table>";
          echo "</form>"; // ‚úÖ Form ends here, submit triggered by modal
      }
  }
  ?>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Confirm Import</h3>
    <p>This will permanently add these contacts to the system. Proceed?</p>
    <button onclick="document.getElementById('commitForm').submit()">Yes, Commit</button>
    <button onclick="hideConfirmModal()">Cancel</button>
  </div>
</div>

<!-- Modal Styles & Script -->
<style>
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
}
.modal-box {
  background: #fff; padding: 20px 30px; border-radius: 8px; text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.modal-box button {
  margin: 10px; padding: 8px 16px; border: none; border-radius: 4px;
  background: #0077cc; color: #fff; cursor: pointer;
}
.modal-box button:hover {
  background: #005fa3;
}
</style>

<script>
function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
}
</script>

<?php include_once 'layout_end.php'; ?>


--- End of import_contacts.php ---



--- Start of index.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

require_once 'layout_start.php';
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];
$tasks = readCSV($filename, $schema);

$statusFilter = isset($_GET['status']) ? $_GET['status'] : '';
$year = isset($_GET['year']) ? $_GET['year'] : date('Y');
$month = isset($_GET['month']) ? $_GET['month'] : date('m');

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        if ($statusFilter === '' || $task['status'] === $statusFilter) {
            $tasksByDate[$task['due_date']][] = $task;
        }
    }
}

$prevMonth = $month - 1;
$prevYear = $year;
if ($prevMonth < 1) {
    $prevMonth = 12;
    $prevYear--;
}

$nextMonth = $month + 1;
$nextYear = $year;
if ($nextMonth > 12) {
    $nextMonth = 1;
    $nextYear++;
}
?>

<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }
  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }
  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }
  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>

<h2>Task Calendar</h2>

<div style="text-align:center; margin-bottom:20px;">
  <a href="?year=<?= $prevYear ?>&month=<?= str_pad($prevMonth, 2, '0', STR_PAD_LEFT) ?>">‚Üê Previous</a>
  <strong><?= date('F Y', strtotime("$year-$month-01")) ?></strong>
  <a href="?year=<?= $nextYear ?>&month=<?= str_pad($nextMonth, 2, '0', STR_PAD_LEFT) ?>">Next ‚Üí</a>
</div>

<form method="GET" style="margin-bottom: 20px;">
  <label for="status">Filter by status:</label>
  <select name="status" id="status" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="pending" <?= $statusFilter === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $statusFilter === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <input type="hidden" name="year" value="<?= $year ?>">
  <input type="hidden" name="month" value="<?= $month ?>">
</form>

<h3>Add New Task</h3>
<form method="POST" action="add_task.php" onsubmit="return validateForm()">
  <input type="text" name="title" id="title" placeholder="Task Title" required>
  <input type="date" name="due_date" id="due_date" required>
  <select name="status" id="status" required>
    <option value="">Select Status</option>
    <option value="pending">Pending</option>
    <option value="completed">Completed</option>
  </select>
  <button type="submit">Add Task</button>
</form>

<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
<?php
$daysInMonth = date('t', strtotime("$year-$month-01"));
$firstDayOfMonth = date('w', strtotime("$year-$month-01"));

$day = 1;
$week = [];

for ($i = 0; $i < $firstDayOfMonth; $i++) {
    $week[] = "<td></td>";
}

while ($day <= $daysInMonth) {
    $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
    if (isset($tasksByDate[$dateStr])) {
        $taskTitles = '';
        foreach ($tasksByDate[$dateStr] as $task) {
            $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
            $taskTitles .= "edit_task.php?timestamp=Edit</a> | ";
            $taskTitles .= "delete_task.php?timestamp=Delete</a><br><br>";
        }
        $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
    } else {
        $week[] = "<td>$day</td>";
    }

    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;
}


    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;

if (!empty($week)) {
    while (count($week) < 7) {
        $week[] = "<td></td>";
    }
    echo "<tr>" . implode('', $week) . "</tr>";
}
?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}

function validateForm() {
  const title = document.getElementById('title').value.trim();
  const dueDate = document.getElementById('due_date').value;
  const status = document.getElementById('status').value;

  if (title === '') {
    alert('Please enter a task title.');
    return false;
  }

  if (dueDate === '') {
    alert('Please select a due date.');
    return false;
  }

  if (status === '') {
    alert('Please select a status.');
    return false;
  }

  return true;
}
</script>

<?php include 'layout_end.php'; ?>


--- End of index.php ---



--- Start of inject_ids.php ---

<?php
function injectIdsIntoCsv($inputFile, $outputFile, $idPrefix = 'CNT') {
    $rows = array_map('str_getcsv', file($inputFile));
    $header = $rows[0];

    // Add ID column if missing
    if (!in_array('id', $header)) {
        array_unshift($header, 'id');
    }

    $newRows = [$header];
    for ($i = 1; $i < count($rows); $i++) {
        $row = $rows[$i];
        $id = $idPrefix . '_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
        array_unshift($row, $id);
        $newRows[] = $row;
    }

    // Write to output file
    $fp = fopen($outputFile, 'w');
    foreach ($newRows as $fields) {
        fputcsv($fp, $fields);
    }
    fclose($fp);
}


--- End of inject_ids.php ---



--- Start of layout_end.php ---

</div> <!-- end container -->
</body>
</html>


--- End of layout_end.php ---



--- Start of layout_start.php ---

<?php
$pageTitle = $pageTitle ?? 'CRM';
$currentPage = basename($_SERVER['SCRIPT_NAME']);
header('Content-Type: text/html; charset=UTF-8');
header('X-Content-Type-Options: nosniff');
?>
<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="CRM system for managing contacts and customer interactions.">
  <meta name="author" content="Eclipse Water Technologies">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="<?= htmlspecialchars($pageTitle) ?>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/<?= htmlspecialchars($currentPage) ?>">
  <meta property="og:image" content="https://yourdomain.com/images/preview.png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css?v=20251002">
  <title><?= htmlspecialchars($pageTitle) ?></title>
</head>
<body>
<?php include_once 'navbar.php'; ?>
<div class="container">
  <div id="task-list-panel">
    <h3>Programming Tasks</h3>
    <ul id="task-list"></ul>
    <input type="text" id="new-task" placeholder="Add new task..." />
    <button onclick="addTask()">Add</button>
  </div>
</div>
<script src="/task-list.js"></script>
</body>
</html>


--- End of layout_start.php ---



--- Start of navbar.php ---

<nav class="navbar">
  <ul>
    <li><a href="dashboard.php" class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">Dashboard</a></li>
    <li><a href="contacts_list.php" class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">Contact List</a></li>
    <li><a href="add_customer.php" class="<?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">‚ûï Add Customer</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üìã Customer List</a></li>
    <li><a href="customer_view.php?id=demo" class="<?= $currentPage === 'customer_view.php' ? 'active' : '' ?>">üëÅ View Customer</a></li>
    <li><a href="calendar.php" class="<?= $currentPage === 'calendar.php' ? 'active' : '' ?>">üìÖ Calendar</a></li>
    <li><a href="contact_form.php" class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">Add Contact</a></li>
    <li><a href="opportunities_list.php" class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">Opportunities</a></li>
    <li><a href="opportunity_form.php" class="<?= $currentPage === 'opportunity_form.php' ? 'active' : '' ?>">Add Opportunity</a></li>
    <li><a href="import_contacts.php" class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">Import</a></li>
    <li><a href="export_contacts.php" class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">Export</a></li>
  </ul>
</nav>


--- End of navbar.php ---



--- Start of opportunities_list.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');


// Build contact lookup map with fallback label
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $contactMap[trim($contact['id'])] = $fullName ?: 'Unnamed Contact';
}
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Opportunities List</h2>

  <?php if (empty($opportunities)): ?>
    <p>No opportunities found.</p>
  <?php else: ?>
    <table class="data-table">
      <thead>
        <tr>
          <?php foreach ($schema as $field): ?>
            <th><?= ucwords(str_replace('_', ' ', $field)) ?></th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($opportunities as $opp): ?>
          <tr>
            <?php foreach ($schema as $field): ?>
              <td>
                <?php
                  if ($field === 'contact_id') {
                      $contactId = trim($opp[$field] ?? '');
                      echo isset($contactMap[$contactId])
                          ? $contactMap[$contactId]
                          : 'Unknown';
                  } else {
                      echo htmlspecialchars($opp[$field] ?? '');
                  }
                ?>
              </td>
            <?php endforeach; ?>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  <?php endif; ?>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunities_list.php ---



--- Start of opportunity_form.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Add New Opportunity</h2>

  <?php if (!empty($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Opportunity saved successfully.</p>
  <?php elseif (!empty($_GET['status']) && $_GET['status'] === 'error'): ?>
    <p class="error-msg">Invalid opportunity data or contact ID.</p>
  <?php endif; ?>

  <form id="opportunity-form" action="add_opportunity.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>

      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>

        <?php if ($field === 'contact_id'): ?>
          <select name="contact_id" id="contact_id" class="form-control" required>
            <option value="">Select Contact</option>
            <?php foreach ($contacts as $contact): ?>
              <option value="<?= $contact['id'] ?>">
                <?= trim($contact['first_name'] . ' ' . $contact['last_name']) ?: 'Unnamed Contact' ?>
              </option>
            <?php endforeach; ?>
          </select>

        <?php elseif ($field === 'stage'): ?>
          <select name="stage" id="stage" class="form-control" required>
            <option value="">Select Stage</option>
            <option value="Prospecting">Prospecting</option>
            <option value="Proposal">Proposal</option>
            <option value="Negotiation">Negotiation</option>
            <option value="Closed Won">Closed Won</option>
            <option value="Closed Lost">Closed Lost</option>
          </select>

        <?php elseif ($field === 'expected_close'): ?>
          <input type="date" name="expected_close" id="expected_close" class="form-control" required>

        <?php elseif ($field === 'value' || $field === 'probability'): ?>
          <input type="number" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>

        <?php else: ?>
          <input type="text" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
        <?php endif; ?>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Opportunity</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunity_form.php ---



--- Start of opportunity_schema.php ---

<?php
return [
   'contact_id',
  'value',
  'stage',
  'probability',
  'expected_close'
];


--- End of opportunity_schema.php ---



--- Start of php_info.php ---

<?php
phpinfo();
?>


--- End of php_info.php ---



--- Start of submit-contact.php ---

<?php

require_once 'contact_validator.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'PHPMailer.php';
require 'SMTP.php';
require 'Exception.php';

$schema = require __DIR__ . '/contact_schema.php';
$mail = new PHPMailer(true);

try {
    // Collect and sanitize form data
    $data = [];
    foreach ($schema as $field) {
        if ($field === 'id') continue;
        $value = htmlspecialchars(trim($_POST[$field] ?? ''));
        $data[$field] = $value;
    }

    // Validate required fields
    if (empty($data['first_name']) || empty($data['email']) || empty($data['message'])) {
        throw new Exception("Please fill in all required fields.");
    }

    // Save to CSV
    $csvRow = array_values($data);
    $csvRow[] = date('Y-m-d H:i:s');
    $file = fopen('contacts.csv', 'a');
    if ($file) {
        fputcsv($file, $csvRow);
        fclose($file);
    } else {
        throw new Exception("Unable to write to contacts.csv");
    }

    // GoDaddy relay SMTP settings
    $mail->SMTPDebug = 0;
    $mail->isSMTP();
    $mail->Host = 'relay-hosting.secureserver.net';
    $mail->SMTPAuth = false;
    $mail->SMTPSecure = '';
    $mail->Port = 25;

    // Email headers
    $mail->setFrom('rlee@eclipsewatertechnologies.com', 'Eclipse Contact Form');
    $mail->addAddress('rlee@eclipsewatertechnologies.com');
    $mail->addReplyTo($data['email'], $data['first_name']);

    // Email content
    $mail->Subject = 'New Contact Form Submission';
    $mail->Body = "Name: {$data['first_name']}\nEmail: {$data['email']}\nCompany: {$data['company']}\nMessage:\n{$data['message']}";

    $mail->send();

    // Redirect with success status
    header('Location: contact_form.php?status=success');
    exit;

} catch (Exception $e) {
    error_log("Contact form error: " . $e->getMessage());
    header('Location: contact_form.php?status=error');
    exit;
}


--- End of submit-contact.php ---



--- Start of tag_schema.php ---

<?phpreturn [
    'VIP' => 'VIP Client',
    'Lead' => 'Sales Lead',
    'Newsletter' => 'Newsletter Subscriber',
    'Inactive' => 'Inactive Contact',
    'Partner' => 'Business Partner',
    'Support' => 'Support Request',
    'Demo' => 'Requested Demo',
];
>

--- End of tag_schema.php ---



--- Start of test.php ---

<?php echo "PHP is working!"; ?>

--- End of test.php ---



--- Start of test_forecast.php ---

<?php
require 'forecast_calc.php';

$forecast = calculateForecasts();
echo "<pre>";
print_r($forecast);
echo "</pre>";
?>


--- End of test_forecast.php ---



--- Start of update_contact.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>
<?php

require_once 'contact_validator.php';require_once 'csv_handler.php';

$schema = getContactSchema();
$contacts = readCSV('contacts.csv');
$updatedId = $_POST['id'] ?? null;

if (!$updatedId) {
    echo "Missing contact ID.";
    exit;
}

// Build updated contact
$updatedContact = [];
foreach ($schema as $col) {
    $updatedContact[$col] = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST[$col] ?? '';
}

// Replace contact in list
$updatedList = array_map(function($c) use ($updatedId, $updatedContact) {
    return $c['id'] === $updatedId ? $updatedContact : $c;
}, $contacts);

// Write back to CSV
writeCSV('contacts.csv', $updatedList);

// Redirect to viewer
header("Location: contact_view.php?id=$updatedId");
exit;
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of update_contact.php ---



--- Start of validation.php ---

<?php
function isValidEmail($email) {
    return filter_var($email, FILTER_VALIDATE_EMAIL);
}

function isValidPhone($phone) {
    return preg_match('/^\+?[0-9\s\-]{7,15}$/', $phone);
}

function validateContact($row) {
    return isset($row['first_name'], $row['last_name'], $row['email']) &&
           isValidEmail($row['email']) &&
           isValidPhone($row['phone']);
}
?>


--- End of validation.php ---



--- Start of add_contact.php ---

<?php
require_once 'contact_validator.php';
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$filename = 'contacts.csv';
$logFile = 'error_log.txt';
$schema = require __DIR__ . '/contact_schema.php';

$timestamp = date('Y-m-d H:i:s');
$newContact = [
    'id' => uniqid(),
    'first_name' => $_POST['first_name'] ?? '',
    'last_name' => $_POST['last_name'] ?? '',
    'company' => $_POST['company'] ?? '',
    'address_1' => $_POST['address_1'] ?? '',
    'address_2' => $_POST['address_2'] ?? '',
    'city' => $_POST['city'] ?? '',
    'postal_code' => $_POST['postal_code'] ?? '',
    'province' => $_POST['province'] ?? '',
    'country' => $_POST['country'] ?? '',
    'phone' => $_POST['phone'] ?? '',
    'email' => $_POST['email'] ?? '',
    'created_at' => $timestamp,
    'source' => 'manual_entry'
];

// Validate contact
$errors = validateContact($newContact);
if (!empty($errors)) {
    echo "<p style='color:red;'>Invalid contact data:</p>";
    foreach ($errors as $field => $msg) {
        echo "<p>Error in $field: $msg</p>";
    }

    // Log errors
    $errorMessage = "[$timestamp] Contact validation failed for email: {$newContact['email']}\n";
    $errorMessage .= print_r($errors, true) . "\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    echo "<p><a href='contact_view.php'>Go back</a></p>";
    exit;
}

// Load existing contacts
$contacts = readCSV($filename, $schema);

// Check for duplicates
foreach ($contacts as $contact) {
    if ($contact['email'] === $newContact['email']) {
        echo "<p style='color:red;'>Duplicate email detected. Contact not saved.</p>";
        $duplicateMessage = "[$timestamp] Duplicate email detected: {$newContact['email']}\n";
        file_put_contents($logFile, $duplicateMessage, FILE_APPEND);
        echo "<p><a href='contact_view.php'>Go back</a></p>";
        exit;
    }
}

// Save contact
$contacts[] = $newContact;
writeCSV($filename, $contacts, $schema);

// Log success
$successMessage = "[$timestamp] Contact saved: {$newContact['email']}\n";
file_put_contents($logFile, $successMessage, FILE_APPEND);

// Redirect to confirmation
header('Location: contact_success.php');
exit;
?>


--- End of add_contact.php ---



--- Start of add_customer.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schema = require __DIR__ . '/customer_schema.php';
$itemFields = require __DIR__ . '/customer_item_config.php';
$customerFile = 'customers.csv';
$itemFile = 'customer_items.csv';
$errors = [];
$success = false;
$newCustomer = [];

// Load existing customers
$rows = readCSV($customerFile, $schema);
$lastId = 0;
foreach ($rows as $r) {
    $id = intval($r['customer_id']);
    if ($id > $lastId) $lastId = $id;
}
$nextId = str_pad($lastId + 1, 5, '0', STR_PAD_LEFT);

// Handle POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    foreach ($schema as $field) {
        $newCustomer[$field] = ($field === 'customer_id') ? $nextId : trim($_POST[$field] ?? '');
    }

    // Validate main fields
    if ($newCustomer['contact_name'] === '') $errors[] = 'Contact name is required.';
    if ($newCustomer['address'] === '') $errors[] = 'Address is required.';

    // Parse line items
    $items = [];
    if (isset($_POST['items']) && is_array($_POST['items'])) {
        foreach ($_POST['items'] as $item) {
            $clean = ['customer_id' => $nextId];
            foreach ($itemFields as $f) {
                $clean[$f] = trim($item[$f] ?? '');
            }
            $items[] = $clean;
        }
    }

    if (empty($errors)) {
        $rows[] = $newCustomer;
        writeCSV($customerFile, $rows, $schema);

        $existingItems = readCSV($itemFile, array_merge(['customer_id'], $itemFields));
        $existingItems = is_array($existingItems) ? $existingItems : [];
        $allItems = array_merge($existingItems, $items);
        writeCSV($itemFile, $allItems, array_merge(['customer_id'], $itemFields));

        $success = true;
    }
}
?>

<div class="container">
  <h2>Add New Customer</h2>

  <?php if ($success): ?>
    <p style="color:green;">‚úÖ Customer added successfully. ID: <?= $nextId ?></p>
  <?php endif; ?>

  <?php if (!empty($errors)): ?>
    <ul style="color:red;">
      <?php foreach ($errors as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
    </ul>
  <?php endif; ?>

  <form method="POST">
    <fieldset style="margin-bottom:20px;">
      <legend><strong>Main Customer Info</strong></legend>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
        <div>
          <label><strong>Customer ID:</strong></label><br>
          <input type="text" value="<?= $nextId ?>" readonly>
        </div>
        <?php foreach ($schema as $field): ?>
          <?php if ($field === 'customer_id') continue; ?>
          <div>
            <label for="<?= $field ?>"><strong><?= ucfirst(str_replace('_', ' ', $field)) ?>:</strong></label><br>
            <input type="text" name="<?= $field ?>" id="<?= $field ?>" value="<?= htmlspecialchars($_POST[$field] ?? '') ?>">
          </div>
        <?php endforeach; ?>
      </div>
    </fieldset>

    <fieldset>
      <legend><strong>Tank & Delivery Line Items</strong></legend>
      <div id="lineItems"></div>
      <button type="button" onclick="addLineItem()" class="btn-outline">‚ûï Add Line Item</button>
    </fieldset>

    <div style="margin-top:20px;">
      <button type="submit" class="btn-outline">üíæ Save Customer</button>
    </div>
  </form>
</div>

<script>
function addLineItem() {
  const container = document.getElementById('lineItems');
  const index = container.children.length;
  const fields = <?= json_encode($itemFields) ?>;
  const row = document.createElement('div');
  row.style.marginBottom = '12px';
  row.style.border = '1px solid #ccc';
  row.style.padding = '10px';
  row.style.borderRadius = '6px';
  row.style.background = '#f9f9f9';

  let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">';
  fields.forEach(f => {
    html += `
      <div>
        <label><strong>${f.replace(/_/g, ' ')}:</strong></label><br>
        <input type="text" name="items[${index}][${f}]" />
      </div>
    `;
  });
  html += '</div>';
  row.innerHTML = html;
  container.appendChild(row);
}
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of add_customer.php ---



--- Start of add_discussion.php ---

<?php
require_once 'contact_validator.php';
require_once 'discussion_logger.php'; // contains logDiscussionEntry()

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate input
    $errors = validateContact($_POST);
    if (!empty($errors)) {
        foreach ($errors as $field => $msg) {
            echo "<p>Error in $field: $msg</p>";
        }
        echo "<p><a href='contact_view.php'>Go back</a></p>";
        exit;
    }

    // Log the discussion entry
    if (logDiscussionEntry($_POST)) {
        header('Location: contact_view.php');
        exit;
    } else {
        echo "<p style='color:red;'>Failed to log discussion entry. Please check the error log.</p>";
        echo "<p><a href='contact_view.php'>Go back</a></p>";
    }
}
?>



--- End of add_discussion.php ---



--- Start of add_opportunity.php ---

<?php

require_once __DIR__ . '/csv_handler.php';
if (!function_exists('readCSV')) {
    error_log("readCSV not loaded ‚Äî check csv_handler.php include path");
    die("CSV handler not loaded.");
}

require_once 'contact_validator.php';

$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', $schema);

// Build contact ID lookup
$validContactIDs = array_column($contacts, 'id');

// Build new opportunity from POST data
$newOpportunity = [];
foreach ($schema as $field) {
    if ($field === 'id') {
        $newOpportunity['id'] = uniqid();
    } else {
        $newOpportunity[$field] = trim($_POST[$field] ?? '');
    }
}

// Defensive logging for missing or invalid fields
if (!in_array($newOpportunity['contact_id'], $validContactIDs)) {
    error_log("Invalid contact_id submitted: " . $newOpportunity['contact_id']);
}
if (!is_numeric($newOpportunity['value'])) {
    error_log("Invalid value submitted: " . $newOpportunity['value']);
}
if (!is_numeric($newOpportunity['probability'])) {
    error_log("Invalid probability submitted: " . $newOpportunity['probability']);
}
if (empty($newOpportunity['stage'])) {
    error_log("Missing stage in opportunity submission");
}

// Validate required fields
$validOpportunity =
    in_array($newOpportunity['contact_id'], $validContactIDs) &&
    is_numeric($newOpportunity['value']) &&
    is_numeric($newOpportunity['probability']) &&
    !empty($newOpportunity['stage']);

if ($validOpportunity) {
    $opportunities[] = $newOpportunity;
    writeCSV('opportunities.csv', $opportunities, $schema);
    header('Location: opportunity_form.php?status=success');
    exit;
} else {
    error_log("Rejected opportunity: " . json_encode($newOpportunity));
    header('Location: opportunity_form.php?status=error');
    exit;
}



--- End of add_opportunity.php ---



--- Start of add_task.php ---

<?php
require_once 'csv_handler.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title = trim($_POST['title']);
    $due_date = $_POST['due_date'];
    $status = $_POST['status'];
    $errors = [];

    if ($title === '') $errors[] = 'Task title is required.';
    if ($due_date === '') $errors[] = 'Due date is required.';
    elseif (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $due_date)) $errors[] = 'Invalid date format.';
    if ($status !== 'pending' && $status !== 'completed') $errors[] = 'Invalid status selected.';

    if (!empty($errors)) {
        echo "<div style='color:red;'><strong>Error:</strong><ul>";
        foreach ($errors as $error) echo "<li>" . htmlspecialchars($error) . "</li>";
        echo "</ul></div><a href='index.php'>Go back</a>";
        exit;
    }

    $filename = 'tasks.csv';
    $newTask = [$title, $due_date, $status, date('Y-m-d H:i:s')];
    appendCSV($filename, $newTask);
    header('Location: index.php');
    exit;
}
?>


--- End of add_task.php ---



--- Start of add_tasks.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$title = $_POST['title'] ?? '';
if (trim($title) === '') {
    echo 'error: empty title';
    exit;
}

$filename = 'tasks.csv';
$headers = ['id','title','status','priority','assigned_to','due_date','timestamp'];

if (!file_exists($filename)) {
    $fp = fopen($filename, 'w');
    if ($fp === false) {
        echo 'error: cannot create file';
        exit;
    }
    fputcsv($fp, $headers);
    fclose($fp);
}

$id = uniqid('task_', true);
$status = 'incomplete';
$priority = '';
$assigned_to = '';
$due_date = '';
$timestamp = date('Y-m-d H:i:s');

$fp = fopen($filename, 'a');
if ($fp !== false) {
    fputcsv($fp, [$id, $title, $status, $priority, $assigned_to, $due_date, $timestamp]);
    fclose($fp);
    echo 'success';
} else {
    echo 'error: cannot open file for appending';
}
?>

--- End of add_tasks.php ---



--- Start of archive_task.php ---

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$idToArchive = $_POST['id'] ?? '';
if (!$idToArchive) {
    echo 'error';
    exit;
}

$filename = 'tasks.csv';
$rows = [];
$found = false;

if (($handle = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($handle); // Read and store header
    $rows[] = $headers;

    while (($data = fgetcsv($handle)) !== false) {
        if ($data[0] === $idToArchive) {
            $data[2] = 'archived'; // Update status
            $found = true;
        }
        $rows[] = $data;
    }
    fclose($handle);
}

// Rewrite the CSV only if the task was found
if ($found && ($handle = fopen($filename, 'w')) !== false) {
    foreach ($rows as $row) {
        fputcsv($handle, $row);
    }
    fclose($handle);
    echo 'success';
} else {
    echo 'error';
}
?>


--- End of archive_task.php ---



--- Start of bulk_action.php ---

<?php
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
$schema = file_exists($schemaFile) ? require $schemaFile : [];
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

$selectedIds = $_POST['selected_ids'] ?? [];
$action = $_POST['action'] ?? '';
$tagToAssign = $_POST['assign_tag'] ?? '';
$statusToAssign = $_POST['assign_status'] ?? '';

if (!is_array($selectedIds) || empty($action)) {
    die('Error: No contacts selected or no action specified.');
}

$updatedContacts = [];
$exportRows = [];

foreach ($contacts as $contact) {
    $id = $contact['id'] ?? '';
    $isSelected = in_array($id, $selectedIds);

    if ($action === 'delete' && $isSelected) {
        continue; // Skip this contact (delete)
    }

    if ($action === 'export' && $isSelected) {
        $row = [];
        foreach ($schema as $field) {
            $row[] = $contact[$field] ?? '';
        }
        $exportRows[] = $row;
    }

    if ($action === 'assign_tag' && $isSelected && $tagToAssign !== '') {
        $existingTags = array_map('trim', explode(',', $contact['tags'] ?? ''));
        if (!in_array($tagToAssign, $existingTags)) {
            $existingTags[] = $tagToAssign;
        }
        $contact['tags'] = implode(', ', $existingTags);
    }

    if ($action === 'assign_status' && $isSelected && $statusToAssign !== '') {
        $contact['status'] = $statusToAssign;
    }

    $updatedContacts[] = $contact;
}

if ($action === 'export') {
    $filename = 'contacts_bulk_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($exportRows as $row) {
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
} else {
    writeCSV('contacts.csv', $updatedContacts, $schema);
    header('Location: contacts_list.php');
    exit;
}
?>

--- End of bulk_action.php ---



--- Start of calendar.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

// Load tasks from handler
require_once 'layout_start.php';
require_once 'csv_handler.php'; // or whatever file defines readCSV()

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp']; // adjust based on your actual CSV columns
$tasks = readCSV($filename, $schema);

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        $tasksByDate[$task['due_date']][] = $task;
    }
}

?>


<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }

  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }

  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }

  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>
<h2>Task Calendar</h2>
<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
  <?php
  $year = date('Y');
  $month = date('m');
  $daysInMonth = date('t');
  $firstDayOfMonth = date('w', strtotime("$year-$month-01"));

  $day = 1;
  $week = [];

  for ($i = 0; $i < $firstDayOfMonth; $i++) {
      $week[] = "<td></td>";
  }

  while ($day <= $daysInMonth) {
      $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
      if (isset($tasksByDate[$dateStr])) {
          $taskTitles = '';
          foreach ($tasksByDate[$dateStr] as $task) {
              $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
          }
          $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
      } else {
          $week[] = "<td>$day</td>";
      }

      if (count($week) == 7) {
          echo "<tr>" . implode('', $week) . "</tr>";
          $week = [];
      }

      $day++;
  }

  if (!empty($week)) {
      while (count($week) < 7) {
          $week[] = "<td></td>";
      }
      echo "<tr>" . implode('', $week) . "</tr>";
  }
  ?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}
</script>

<?php include 'layout_end.php'; ?>


--- End of calendar.php ---



--- Start of commit_import.php ---

<?php
session_start();
require_once 'csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$logFile = 'error_log.txt';
$targetFile = 'contacts.csv';

// Validate session data
$contacts = $_SESSION['import_preview'] ?? [];

if (!is_array($contacts) || empty($contacts)) {
    echo "<p style='color:red;'>No import data received or session expired.</p>";
    exit;
}

// Re-validate schema alignment
$validContacts = array_filter($contacts, function($row) use ($schema) {
    foreach ($schema as $col) {
        if (!array_key_exists($col, $row)) return false;
    }
    return true;
});

// Append to contacts.csv
$success = writeCSV($targetFile, $validContacts, $schema);

if ($success) {
    echo "<p style='color:green;'>Import complete. " . count($validContacts) . " contacts added.</p>";
    echo "<p><a href='contacts_list.php' class='btn'>‚Üê Back to Contacts</a></p>";
    unset($_SESSION['import_preview']); // Clear session after successful import
} else {
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write imported contacts.\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);
    echo "<p style='color:red;'>Import failed. See error log.</p>";
}
?>


--- End of commit_import.php ---



--- Start of contacts_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

// Load schema safely
$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

// Handle query and sort
$query = strtolower(trim($_GET['query'] ?? ''));
$field = $_GET['field'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$activeSort = array_flip($sortFields);

// Display fields
$displayFields = $_GET['display'] ?? ['first_name', 'last_name', 'company', 'email'];
if (!is_array($displayFields)) {
    $displayFields = ['first_name', 'last_name', 'company', 'email'];
}

// Load contacts safely
$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Detect duplicates
$emailCount = [];
foreach ($contacts as $c) {
    $email = strtolower(trim($c['email']));
    $emailCount[$email] = ($emailCount[$email] ?? 0) + 1;
}

// Apply filter
if ($query !== '' && in_array($field, $schema)) {
    $contacts = array_filter($contacts, function($c) use ($field, $query) {
        return strpos(strtolower($c[$field] ?? ''), $query) !== false;
    });
}

// Apply multi-field sort
$validSortFields = array_filter($sortFields, function($f) use ($displayFields) {
    return in_array($f, $displayFields);
});

if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';

            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric
                ? ($valA <=> $valB)
                : strnatcasecmp($valA, $valB);

            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// Export logic
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename=\"$filename\"");

    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }

    fputcsv($output, $displayFields);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($displayFields as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }

    fclose($output);
    exit;
}
?>



<div class="page-contacts">
  <div class="container">
    <h2>All Contacts</h2>

    <form method="GET" class="contact-form">
      <div style="display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end;">
        <div>
          <label for="field">Filter by:</label><br>
          <select name="field" id="field">
            <?php foreach ($schema as $f): ?>
              <option value="<?= $f ?>" <?= $field === $f ? 'selected' : '' ?>>
                <?= ucfirst(str_replace('_', ' ', $f)) ?>
              </option>
            <?php endforeach; ?>
          </select>
        </div>

        <div>
          <label for="query">Search:</label><br>
          <input type="text" name="query" id="query" value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
        </div>

        <div>
          <label for="fontSize">Font size:</label><br>
          <select id="fontSize">
            <option value="0.75rem">Small</option>
            <option value="0.85rem" selected>Medium</option>
            <option value="1rem">Large</option>
          </select>
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
          <button type="submit">Apply</button>
          <button type="submit" name="export" value="1">Export</button>
        </div>

        <div>
  <label for="sort">Sort by:</label><br>
  <select name="sort" id="sort">
    <option value="">-- None --</option>
    <?php foreach ($displayFields as $f): ?>
      <option value="<?= $f ?>" <?= in_array($f, $sortFields) ? 'selected' : '' ?>>
        <?= ucfirst(str_replace('_', ' ', $f)) ?>
      </option>
    <?php endforeach; ?>
  </select>
</div>


        <div>
          <label for="direction">Direction:</label><br>
          <select name="direction" id="direction">
            <option value="asc" <?= $sortDirection === 'asc' ? 'selected' : '' ?>>A‚ÄìZ / 0‚Äì9</option>
            <option value="desc" <?= $sortDirection === 'desc' ? 'selected' : '' ?>>Z‚ÄìA / 9‚Äì0</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button type="button" onclick="toggleFieldPanel()" style="font-size:0.85rem;">üõ† Show/Hide Field Selection</button>
        <div id="fieldPanel" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px; border-radius:6px; background:#f9f9f9;">
          <fieldset>
            <legend style="font-weight:bold;">Visible Fields:</legend>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
              <?php foreach ($schema as $f): ?>
                <label style="display:flex; align-items:center; gap:4px;">
                  <input type="checkbox" name="display[]" value="<?= $f ?>" <?= in_array($f, $displayFields) ? 'checked' : '' ?>>
                  <?= ucfirst(str_replace('_', ' ', $f)) ?>
                </label>
              <?php endforeach; ?>
            </div>
          </fieldset>
        </div>
      </div>
    </form>

    <table class="contact-table">
      <thead>
        <tr>
          <th>Actions</th>
          <?php foreach ($displayFields as $f): ?>
            <th>
              <?= ucfirst(str_replace('_', ' ', $f)) ?>
              <?php if (isset($activeSort[$f])): ?>
                <span style="<?= $activeSort[$f] === 0 ? 'font-weight:bold; color:#0099A8;' : '' ?>">
                  <?= $sortDirection === 'desc' ? '‚Üì' : '‚Üë' ?>
                </span>
              <?php endif; ?>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($contacts as $contact): ?>
          <?php
            $id = $contact['id'];
            $email = $contact['email'];
            $isDuplicate = $emailCount[strtolower(trim($email))] > 1;
          ?>
          <tr onclick="this.nextElementSibling.classList.toggle('expanded')">
            <td>
              <a href="contact_view.php?id=<?= $id ?>">üëÅ</a>
              <form method="POST" action="delete_contact.php" style="display:inline;" onsubmit="return confirm('Delete this contact?');">
                <input type="hidden" name="id" value="<?= $id ?>">
                <button type="submit" class="btn-outline">üóë</button>
              </form>
            </td>
            <?php foreach ($displayFields as $f): ?>
              <td>
                <?= htmlspecialchars($contact[$f] ?? '') ?>
                <?= ($f === 'email' && $isDuplicate) ? "<span style='color:red;'> [Duplicate]</span>" : '' ?>
              </td>
            <?php endforeach; ?>
          </tr>
          <tr class="details-row">
            <td colspan="<?= count($displayFields) + 1 ?>">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <?php foreach ($schema as $f): ?>
                  <div>
                    <strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong>
                    <?= htmlspecialchars($contact[$f] ?? '') ?>
                  </div>
                <?php endforeach; ?>
              </div>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
</div>

<script>
  function toggleFieldPanel() {
    const panel = document.getElementById('fieldPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }

  document.getElementById('fontSize').addEventListener('change', function () {
    document.documentElement.style.setProperty('--crm-font-size', this.value);
  });
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contacts_list.php ---



--- Start of contact_form.php ---

<?php
$schema = require __DIR__ . '/contact_schema.php';
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Add New Contact</h2>

  <?php if (isset($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Contact saved successfully.</p>
  <?php endif; ?>

  <form id="contact-form" action="add_contact.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>
      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>
        <input type="<?= $field === 'email' ? 'email' : ($field === 'phone' ? 'tel' : 'text') ?>"
               name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Contact</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_form.php ---



--- Start of contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';
require_once 'tag_schema.php';

error_reporting(E_ALL);
ini_set('display_errors', 1);

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = array_keys(require 'tag_schema.php');
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
}
ksort($statusOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$selectedTags = $_GET['tags'] ?? [];
if (!is_array($selectedTags)) $selectedTags = [];
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $selectedTags) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $contactTags = array_map('trim', explode(',', $c['tags'] ?? ''));
    $matchTags = empty($selectedTags) || array_intersect($selectedTags, $contactTags);
    return $matchQuery && $matchStatus && $matchTags;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <fieldset>
      <legend>Tags:</legend>
      <?php foreach ($tagOptions as $tag): ?>
        <label>
          <input type="checkbox" name="tags[]" value="<?= htmlspecialchars($tag) ?>" <?= in_array($tag, $selectedTags) ? 'checked' : '' ?>>
          <?= htmlspecialchars($tag) ?>
        </label>
      <?php endforeach; ?>
    </fieldset>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <form method="post" action="bulk_action.php">
    <table class="table-grid">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <?php foreach ($schema as $field): ?>
            <th>
              <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
                <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
                <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
              </a>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($contacts as $c): ?>
          <tr>
            <td><input type="checkbox" name="selected_ids[]" value="<?= htmlspecialchars($c['id'] ?? '') ?>"></td>
            <?php foreach ($schema as $f): ?>
              <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
            <?php endforeach; ?>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>

    <div class="bulk-actions">
      <select name="action">
        <option value="">-- Bulk Action --</option>
        <option value="export">Export Selected</option>
        <option value="delete">Delete Selected</option>
        <option value="assign_tag">Assign Tag</option>
        <option value="assign_status">Assign Status</option>
      </select>
      <input type="text" name="value" placeholder="Tag or Status">
      <button type="submit">Apply</button>
    </div>
  </form>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.getElementById('select-all').addEventListener('change', function(e) {
  const checkboxes = document.querySelectorAll('input[name="selected_ids[]"]');
  checkboxes.forEach(cb => cb.checked = e.target.checked);
});
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_list.php ---



--- Start of contact_list1.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$searchFields = ['first_name', 'last_name', 'email', 'company'];
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortFields = explode(',', $_GET['sort'] ?? '');
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter by search query
if ($query !== '') {
    $contacts = array_filter($contacts, function($c) use ($query, $searchFields) {
        foreach ($searchFields as $field) {
            if (isset($c[$field]) && stripos($c[$field], $query) !== false) {
                return true;
            }
        }
        return false;
    });
}

// Filter by status
if ($statusFilter !== '') {
    $contacts = array_filter($contacts, function($c) use ($statusFilter) {
        return isset($c['status']) && $c['status'] === $statusFilter;
    });
}

// Filter by tag
if ($tagFilter !== '') {
    $contacts = array_filter($contacts, function($c) use ($tagFilter) {
        return isset($c['tags']) && stripos($c['tags'], $tagFilter) !== false;
    });
}

// Sort contacts
$validSortFields = array_filter($sortFields, function($f) use ($schema) {
    return in_array($f, $schema);
});
if (!empty($validSortFields)) {
    usort($contacts, function($a, $b) use ($validSortFields, $sortDirection) {
        foreach ($validSortFields as $field) {
            $valA = $a[$field] ?? '';
            $valB = $b[$field] ?? '';
            $isNumeric = is_numeric($valA) && is_numeric($valB);
            $cmp = $isNumeric ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
            if ($cmp !== 0) {
                return $sortDirection === 'desc' ? -$cmp : $cmp;
            }
        }
        return 0;
    });
}

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename=\"$filename\"");
    $output = fopen('php://output', 'w');
    if (!$output) {
        die('Error: Unable to open export stream.');
    }
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}

// Pagination
$total = count($contacts);
$totalPages = ceil($total / $perPage);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <option value="active" <?= $statusFilter === 'active' ? 'selected' : '' ?>>Active</option>
      <option value="inactive" <?= $statusFilter === 'inactive' ? 'selected' : '' ?>>Inactive</option>
    </select>
    <input type="text" name="tag" placeholder="Tag" value="<?= htmlspecialchars($tagFilter) ?>">
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table table-striped">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th><?= htmlspecialchars(ucfirst(str_replace('_', ' ', $field))) ?></th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= $totalPages; $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>"
         class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of contact_list1.php ---



--- Start of contact_schema.php ---

<?php
return [
    'id',
    'first_name',
    'last_name',
    'company',
    'email',
    'phone',
    'address',
    'city',
    'province',
    'postal_code',
    'country',
    'notes',
    'created_at',
    'is_customer',
    'tank_number',
    'delivery_date'
];
?>

--- End of contact_schema.php ---



--- Start of contact_success.php ---

<?php
session_start();
$currentPage = basename(__FILE__); // Dynamically sets active tab
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Saved</title>
  <link rel="stylesheet" href="styles.css"> <!-- Optional external CSS -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .navbar { background: #333; padding: 10px 20px; }
    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; }
    .nav-list li { margin-right: 20px; }
    .nav-list a { color: #fff; text-decoration: none; }
    .nav-list .active a { font-weight: bold; text-decoration: underline; }
    .container { max-width: 600px; margin: 60px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
    .btn { display: inline-block; margin-top: 20px; padding: 10px 20px; background: #0077cc; color: #fff; text-decoration: none; border-radius: 4px; }
    .btn:hover { background: #005fa3; }
  </style>
</head>
<body>

<nav class="navbar">
  <ul class="nav-list">
    <li class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">
      <a href="dashboard.php">Dashboard</a>
    </li>
    <li class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">
      <a href="contact_form.php">Add Contact</a>
    </li>
    <li class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">
      <a href="contacts_list.php">View Contacts</a>
    </li>
    <li class="<?= $currentPage === 'opportunity_form.php' ? 'active' : '' ?>">
      <a href="opportunity_form.php">Add Opportunity</a>
    </li>
    <li class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">
      <a href="opportunities_list.php">View Opportunities</a>
    </li>
    <li class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">
      <a href="import_contacts.php">Import Contacts</a>
    </li>
    <li class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">
      <a href="export_contacts.php">Export Contacts</a>
    </li>
  </ul>
</nav>

<div class="container">
  <h2>‚úÖ Contact Saved Successfully</h2>
  <p>Your new contact has been added to the system and logged for audit.</p>
  <a href="dashboard.php" class="btn">Return to Dashboard</a>
</div>

</body>
</html>


--- End of contact_success.php ---



--- Start of contact_validator.php ---

<?php
require_once 'contact_schema.php';

function validateContact(array $contact): array {
    $schema = require __DIR__ . '/contact_schema.php';
    $requiredFields = ['last_name', 'company', 'address_1', 'city', 'postal_code', 'phone', 'email'];
    $errors = [];

    foreach ($schema as $field) {
        $value = trim($contact[$field] ?? '');

        // Required field check
        if (in_array($field, $requiredFields) && $value === '') {
            $errors[$field] = ucfirst(str_replace('_', ' ', $field)) . " is required.";
            continue;
        }

        // Field-specific validation
        switch ($field) {
            case 'email':
                if ($value && !filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[$field] = "Invalid email format.";
                }
                break;

            case 'phone':
                if ($value && !preg_match('/^\+?[0-9\s\-().]{7,}$/', $value)) {
                    $errors[$field] = "Invalid phone number.";
                }
                break;

            case 'website':
                if ($value && !filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[$field] = "Invalid website URL.";
                }
                break;

            // Add more field-specific rules here if needed
        }
    }

    return $errors;
}


--- End of contact_validator.php ---



--- Start of contact_view.php ---

<?php
session_start();

// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Include layout and dependencies (all files are in root)
include_once('layout_start.php');
include_once('navbar.php');
require_once 'csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require 'contact_schema.php';
$customerSchema = require 'customer_schema.php';
$contacts = readCSV('contacts.csv', $schema);
$customers = readCSV('customers.csv', $customerSchema);

// Index contacts by ID for faster lookup
$contactsById = [];
foreach ($contacts as $c) {
    if (empty($c['id'])) {
        $c['id'] = 'CNT_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
    }
    $contactsById[$c['id']] = $c;
}

// Helper: resolve customer by ID
function findCustomerById($customers, $cid) {
    foreach ($customers as $c) {
        if ($c['customer_id'] === $cid) return $c;
    }
    return null;
}

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Update contact details
    if (isset($_POST['id']) && isset($contactsById[$_POST['id']])) {
        $id = $_POST['id'];
        foreach ($schema as $f) {
            $contactsById[$id][$f] = htmlspecialchars(trim($_POST[$f] ?? $contactsById[$id][$f]));
        }
        if (isset($_POST['is_customer'])) {
            $contactsById[$id]['is_customer'] = $_POST['is_customer'];
        }
        writeCSV('contacts.csv', array_values($contactsById), $schema);
        header("Location: contact_view.php?id=" . urlencode($id));
        exit;
    }

    // Handle discussion entry
    if (isset($_POST['contact_id']) && isset($contactsById[$_POST['contact_id']])) {
        $data = [
            'contact_id' => $_POST['contact_id'],
            'author' => htmlspecialchars(trim($_POST['author'])),
            'timestamp' => date('Y-m-d H:i'),
            'entry_text' => htmlspecialchars(trim($_POST['entry_text'])),
            'linked_opportunity_id' => htmlspecialchars($_POST['linked_opportunity_id'] ?? ''),
            'visibility' => htmlspecialchars($_POST['visibility'] ?? 'public')
        ];
        $fp = fopen('discussion_log.csv', 'a');
        if ($fp) {
            fputcsv($fp, array_values($data));
            fclose($fp);
        }
        header("Location: contact_view.php?id=" . urlencode($data['contact_id']));
        exit;
    }
}

// Load contact
$id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING);
$contact = $contactsById[$id] ?? null;

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once('layout_end.php');
    exit;
}

// Resolve associated customer
$customer = findCustomerById($customers, $contact['customer_id'] ?? '');
?>

<div class="container">
  <h2>Contact Details</h2>

  <div class="contact-header" style="display: flex; align-items: center; justify-content: space-between;">
    <?php if ($customer): ?>
      <div class="customer-info">
        <strong>Company:</strong> <?= htmlspecialchars($customer['contact_name'] ?? '') ?><br>
        <strong>Address:</strong> <?= htmlspecialchars($customer['address'] ?? '') ?>
      </div>
    <?php else: ?>
      <div class="customer-info muted">
        <em>This contact is not assigned to a company.</em>
      </div>
    <?php endif; ?>

    <?php if (($contact['is_customer'] ?? '') !== 'yes'): ?>
      <form method="post" style="margin-left: 2em;">
        <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">
        <input type="hidden" name="is_customer" value="yes">
        <button type="submit" class="btn-outline">‚úÖ Mark as Client</button>
      </form>
    <?php else: ?>
      <p style="margin-left: 2em;"><strong>Status:</strong> This contact is already marked as a client.</p>
    <?php endif; ?>
  </div>

  <!-- Editable Contact Form -->
  <form method="post" class="contact-form">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <div class="form-group">
        <label for="customer_id"><strong>Company:</strong></label><br>
        <select name="customer_id" id="customer_id">
          <option value="">-- None --</option>
          <?php foreach ($customers as $cust): ?>
            <option value="<?= htmlspecialchars($cust['customer_id']) ?>"
              <?= ($contact['customer_id'] ?? '') === $cust['customer_id'] ? 'selected' : '' ?>>
              <?= htmlspecialchars($cust['contact_name']) ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">üíæ Save Changes</button>
    </div>
  </form>

  <?php include_once('discussion_module.php'); ?>
  <?php include_once('follow_up_email.php'); ?>

  <div class="navigation">
    <a href="contacts_list.php" class="btn-outline">‚¨Ö Back to Contact List</a>
  </div>
</div>

<?php include_once('layout_end.php'); ?>


--- End of contact_view.php ---



--- Start of csv_export.php ---

function exportCSVFiltered($filename, $rows, $filters = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered));
}


--- End of csv_export.php ---



--- Start of csv_handler.php ---

<?php
function readCSV($filename, $schema) {
    $data = [];
    if (!file_exists($filename)) return $data;
    $file = fopen($filename, 'r');
    if ($file === false) throw new Exception("Unable to open file: $filename");
    while (($row = fgetcsv($file)) !== false) {
        if (count($row) === count($schema)) {
            $data[] = array_combine($schema, $row);
        }
    }
    fclose($file);
    return $data;
}

function writeCSV($filename, $data, $schema) {
    $file = fopen($filename, 'w');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    foreach ($data as $row) {
        $csvRow = [];
        foreach ($schema as $field) {
            $value = $row[$field] ?? '';
            // Prevent CSV injection
            if (preg_match('/^[=+\\-@]/', $value)) {
                $value = "'" . $value;
            }
            $csvRow[] = $value;
        }
        fputcsv($file, $csvRow);
    }
    fclose($file);
}

function appendCSV($filename, $row) {
    $file = fopen($filename, 'a');
    if ($file === false) throw new Exception("Unable to open file for writing: $filename");
    fputcsv($file, $row);
    fclose($file);
}
?>

--- End of csv_handler.php ---



--- Start of csv_import.php ---

function importCSVWithSchema($filename, $schema, $keyField, $existingRows) {
    $newRows = [];
    $imported = readCSV($filename);
    foreach ($imported as $row) {
        if (!array_diff($schema, array_keys($row)) && !in_array($row[$keyField], array_column($existingRows, $keyField))) {
            $newRows[] = $row;
        }
    }
    return $newRows;
}


--- End of csv_import.php ---



--- Start of customers_list.php ---

<?php
// customers_list.php

header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once __DIR__ . '/csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter only customers
$customers = array_filter($contacts, function($c) {
    return in_array(strtolower(trim($c['is_customer'] ?? '')), ['yes', 'true', '1']);
});
?>

<div class="container">
  <h2>Customer List</h2>

  <table class="table-grid">
    <thead>
      <tr>
		<th>Company</th>
        <th>First Name</th>
        <th>Email</th>
        <th>Customer Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($customers as $contact): ?>
        <tr>
          <td><?= htmlspecialchars($contact['company'] ?? '') ?></td>
		  <td><?= htmlspecialchars($contact['first_name'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['email'] ?? '') ?></td>
          <td><?= htmlspecialchars($contact['is_customer'] ?? '') ?></td>
          <td>
            <a href="customer_view.php?id=<?= urlencode($contact['id']) ?>" class="btn-primary">üëÅ View</a>
            <?php
              $deliveryFile = "{$contact['id']}_deliveries.csv";
              if (file_exists(__DIR__ . "/$deliveryFile")):
            ?>
              <a href="<?= htmlspecialchars($deliveryFile) ?>" class="btn-secondary" target="_blank">üì¶ Delivery Archive</a>
            <?php endif; ?>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="navigation">
    <a href="index.php" class="btn-outline">‚¨Ö Back to Home</a>
  </div>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of customers_list.php ---



--- Start of customer_item_config.php ---

<?php
return [
  'tank_number',
  'tank_size',
  'type_of_resin',
  'delivery_date',
  'regeneration_number',
  'purchase_order'
];


--- End of customer_item_config.php ---



--- Start of customer_schema.php ---

<?php
return [
  'customer_id',
  'contact_name',
  'address',
  'tank_count',
  'last_delivery'
];


--- End of customer_schema.php ---



--- Start of customer_view.php ---

<?php


// Security headers
header('Content-Type: text/html; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Includes
include_once(__DIR__ . '/layout_start.php');
include_once(__DIR__ . '/navbar.php');
require_once __DIR__ . '/csv_handler.php';
require_once 'discussion_validator.php';

// Load schemas and data
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Helper: find contact by ID
function findContactById($contacts, $id) {
    if ($id === '') return null;
    foreach ($contacts as $c) {
        if ($c['id'] === $id) return $c;
    }
    return null;
}

// Helper: create delivery file
function createDeliveryFileIfNeeded($contactId) {
    $deliveryFile = __DIR__ . "/{$contactId}_deliveries.csv";
    if (!file_exists($deliveryFile)) {
        $fp = fopen($deliveryFile, 'w');
        if ($fp) {
            fputcsv($fp, ['delivery_date', 'tank_number', 'tank_size']);
            fclose($fp);
            return true;
        } else {
            error_log("Failed to create delivery file for contact ID: $contactId");
            return false;
        }
    }
    return true;
}

// Handle contact update
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['id'])) {
    $id = $_POST['id'];
    foreach ($contacts as &$c) {
        if ($c['id'] === $id) {
            foreach ($schema as $f) {
                $c[$f] = $_POST[$f] ?? $c[$f];
            }

            // Create delivery file if marked as customer
            if (isset($_POST['is_customer']) && strtolower(trim($_POST['is_customer'])) === 'yes') {
                if (!createDeliveryFileIfNeeded($id)) {
                    echo "<div class='alert-error'>‚ö†Ô∏è Delivery file could not be created for customer ID: $id</div>";
                }
            }

            break;
        }
    }
    writeCSV('contacts.csv', $contacts, $schema);
    header("Location: customer_view.php?id=" . urlencode($id));
    exit;
}

// Load contact
$id = $_GET['id'] ?? '';
$contact = findContactById($contacts, $id);

if (!$contact) {
    echo "<div class='container'><h2>Contact not found</h2></div>";
    include_once(__DIR__ . '/layout_end.php');
    exit;
}
?>

<div class="container">
  <h2>Customer Details</h2>
  

  <form method="post" class="contact-form">
    <input type="hidden" name="id" value="<?= htmlspecialchars($contact['id']) ?>">

    <div class="form-grid">
      <?php foreach ($schema as $f): ?>
        <div class="form-group">
          <label for="<?= $f ?>"><strong><?= ucfirst(str_replace('_', ' ', $f)) ?>:</strong></label><br>
          <?php if ($f === 'notes' || str_contains($f, 'description')): ?>
            <textarea name="<?= $f ?>" id="<?= $f ?>" rows="3"><?= htmlspecialchars($contact[$f] ?? '') ?></textarea>
          <?php elseif ($f === 'id'): ?>
            <input type="text" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>" disabled>
          <?php else: ?>
            <input type="text" name="<?= $f ?>" id="<?= $f ?>" value="<?= htmlspecialchars($contact[$f] ?? '') ?>">
          <?php endif; ?>
        </div>
      <?php endforeach; ?>
    </div>

    <div class="form-actions">
  <button type="submit" class="btn-primary">üíæ Save Changes</button>
	</div>

<?php
if (strtolower(trim($contact['is_customer'] ?? '')) === 'yes') {
    $deliveryFile = "{$contact['id']}_deliveries.csv";
    $deliveryFilePath = __DIR__ . "/$deliveryFile";
    if (file_exists($deliveryFilePath)) {
        $deliveryUrl = "deliveries.php?id=" . urlencode($contact['id']);
        echo '<a href="' . $deliveryUrl . '" class="btn-primary">üì¶ View Delivery Archive</a>';
    }
}
?>




<?php include_once(__DIR__ . '/layout_end.php'); ?>

--- End of customer_view.php ---



--- Start of dashboard.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>
<?php
require_once 'csv_handler.php';
require_once 'forecast_calc.php';

$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
$opportunities = readCSV('opportunities.csv', require __DIR__ . '/opportunity_schema.php');
$forecastData = calculateForecasts();
$forecasts = $forecastData['individual'];
$forecastByStage = $forecastData['by_stage'];

$totalContacts = count($contacts);
$totalValue = array_sum(array_column($opportunities, 'value'));
$totalForecast = array_sum(array_column($forecasts, 'forecast'));
$accuracy = $totalValue > 0 ? ($totalForecast / $totalValue) * 100 : 0;

// Identify top forecast stage
$topStage = '';
$maxForecast = 0;
foreach ($forecastByStage as $stage => $data) {
    if ($data['total_forecast'] > $maxForecast) {
        $maxForecast = $data['total_forecast'];
        $topStage = $stage;
    }
}

echo "<h2>CRM Dashboard</h2>";
echo "<div class='dashboard-card'><strong>Total Contacts:</strong> $totalContacts</div>";
echo "<div class='dashboard-card'><strong>Total Opportunity Value:</strong> $" . number_format($totalValue, 2) . "</div>";
echo "<div class='dashboard-card'><strong>Total Forecast Value:</strong> $" . number_format($totalForecast, 2) . "</div>";
echo "<div class='dashboard-card'><strong>Forecast Accuracy:</strong> " . number_format($accuracy, 1) . "%</div>";
echo "<div class='dashboard-card'><strong>Top Forecast Stage:</strong> $topStage</div>";

// Pipeline breakdown
$stages = [];
foreach ($opportunities as $opp) {
    $stage = $opp['stage'];
    $value = floatval($opp['value']);
    if (!isset($stages[$stage])) {
        $stages[$stage] = ['count' => 0, 'value' => 0];
    }
    $stages[$stage]['count']++;
    $stages[$stage]['value'] += $value;
}

echo "<h3>Pipeline Breakdown</h3>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Stage</th><th>Count</th><th>Total Value</th></tr>";
foreach ($stages as $stage => $data) {
    echo "<tr>";
    echo "<td>$stage</td>";
    echo "<td>{$data['count']}</td>";
    echo "<td>$" . number_format($data['value'], 2) . "</td>";
    echo "</tr>";
}
echo "</table>";

echo "<h3>Forecast by Stage</h3>";
echo "<table border='1' cellpadding='5'>";
echo "<tr><th>Stage</th><th>Count</th><th>Total Forecast</th></tr>";
foreach ($forecastByStage as $stage => $data) {
    echo "<tr>";
    echo "<td>$stage</td>";
    echo "<td>{$data['count']}</td>";
    echo "<td>$" . number_format($data['total_forecast'], 2) . "</td>";
    echo "</tr>";
}
echo "</table>";
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of dashboard.php ---



--- Start of delete_contact.php ---

<?php
require_once 'contact_validator.php';
require_once 'csv_handler.php';

$idToDelete = $_POST['id'] ?? null;
if (!$idToDelete) {
    echo "No contact ID provided.";
    exit;
}

$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV('contacts.csv', $schema);

// Filter out the contact to delete
$filtered = array_filter($contacts, function($c) use ($idToDelete) {
    return $c['id'] !== $idToDelete;
});

// Defensive write: ensure header matches schema
$fp = fopen('contacts.csv', 'w');
fputcsv($fp, $schema);
foreach ($filtered as $row) {
    $line = [];
    foreach ($schema as $col) {
        $line[] = array_key_exists($col, $row) ? $row[$col] : '';
    }
    fputcsv($fp, $line);
}
fclose($fp);

header('Location: contacts_list.php');
exit;
?>


--- End of delete_contact.php ---



--- Start of delete_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if (isset($_GET['timestamp'])) {
    deleteTask($filename, $schema, $_GET['timestamp']);
}
header('Location: index.php');
exit;


--- End of delete_task.php ---



--- Start of deliveries.php ---

<?php
include_once 'navbar.php';
include_once 'layout_start.php';

// Get customer ID from GET
$id = isset($_GET['id']) ? preg_replace('/[^a-zA-Z0-9_-]/', '', $_GET['id']) : null;

if (!$id) {
    echo "<p>Error: No customer ID specified.</p>";
    include_once 'layout_end.php';
    exit;
}

$csvFile = "deliveries_$id.csv";

// Create file if it doesn't exist
if (!file_exists($csvFile)) {
    $fp = fopen($csvFile, 'w');
    fputcsv($fp, ['Date', 'Company', 'Tank #', 'Size']); // Header row
    fclose($fp);
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $date = $_POST['delivery_date'];
    $company = $_POST['company'];
    $tank_number = $_POST['tank_number'];
    $tank_size = $_POST['tank_size'];

    $newEntry = [$date, $company, $tank_number, $tank_size];
    $fp = fopen($csvFile, 'a');
    fputcsv($fp, $newEntry);
    fclose($fp);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delivery Archive - Customer #<?php echo htmlspecialchars($id); ?></title>
  <script>
    function sortTable(n) {
      const table = document.getElementById("deliveryTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let shouldSwitch = dir === "asc" ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase();
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
            break;
          }
        }
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  </script>
</head>
<body>
  <h2>üì¶ Delivery Archive for Customer #<?php echo htmlspecialchars($id); ?></h2>

  <form method="post">
    <label><strong>Add New Delivery:</strong></label><br>
    <input type="date" name="delivery_date" required>
    <input type="text" name="company" required>
    <input type="text" name="tank_number" placeholder="Tank #" required>
    <input type="text" name="tank_size" placeholder="Size" required>
    <button type="submit">‚ûï Add Delivery</button>
  </form>

  <br>
  customer_view.php?id=<?php echo urlencode($id); ?>
    <button>üîô Back to Customer Details</button>
  </a>

  <br><br>
  <table id="deliveryTable" border="1">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Date</th>
        <th onclick="sortTable(1)">Company</th>
        <th onclick="sortTable(2)">Tank #</th>
        <th onclick="sortTable(3)">Size</th>
      </tr>
    </thead>
    <tbody>
      <?php
      $rows = array_map('str_getcsv', file($csvFile));
      array_shift($rows); // Remove header
      if (count($rows) > 0) {
          foreach ($rows as $row) {
              echo "<tr>";
              foreach ($row as $cell) {
                  echo "<td>" . htmlspecialchars($cell) . "</td>";
              }
              echo "</tr>";
          }
      } else {
          echo "<tr><td colspan='4'>No delivery records found.</td></tr>";
      }
      ?>
    </tbody>
  </table>
</body>
</html>
<?php include_once 'layout_end.php'; ?>

--- End of deliveries.php ---



--- Start of discussion_logger.php ---

<?php
// discussion_logger.php

// Set plain text response headers
header('Content-Type: text/plain; charset=utf-8');
header('X-Content-Type-Options: nosniff');

// Log raw POST data for debugging
file_put_contents('debug_log.txt', print_r($_POST, true) . PHP_EOL, FILE_APPEND);

// Use $_POST directly
$data = $_POST;

// Define the logging function
function logDiscussionEntry(array $data): bool {
    $file = 'discussion_log.csv';
    $logFile = 'error_log.txt';
    $schema = require __DIR__ . '/discussion_schema.php';

    // Build row using schema order
    $row = [];
    foreach ($schema as $col) {
        switch ($col) {
            case 'timestamp':
                $row[] = date('Y-m-d H:i');
                break;
            case 'entry_text':
                $row[] = isset($data[$col]) ? str_replace(["\r", "\n"], ' ', $data[$col]) : '';
                break;
            case 'author':
                $row[] = $data[$col] ?? 'System';
                break;
            case 'linked_opportunity_id':
                $row[] = $data[$col] ?? '';
                break;
            case 'visibility':
                $row[] = $data[$col] ?? 'private';
                break;
            default:
                $row[] = $data[$col] ?? '';
        }
    }

    // Try to append to CSV
    if (($fp = fopen($file, 'a')) !== false) {
        fputcsv($fp, $row);
        fclose($fp);
        return true;
    }

    // Log error if write fails
    $errorMessage = "[" . date('Y-m-d H:i:s') . "] Failed to write to $file for contact_id: {$data['contact_id']}\n";
    file_put_contents($logFile, $errorMessage, FILE_APPEND);

    return false;
}

// Output plain success or error message
if (!empty($data) && logDiscussionEntry($data)) {
    echo "Logged successfully";
} else {
    echo "Logging failed or invalid data";
}
?>


--- End of discussion_logger.php ---



--- Start of discussion_module.php ---

<?php
$cid = $contact['id'] ?? '';
if (empty($cid)) return;

$discussionSchema = require __DIR__ . '/discussion_schema.php';
$discussionLog = readCSV('discussion_log.csv', $discussionSchema) ?: [];

$entries = array_filter($discussionLog, fn($e) => trim($e['contact_id']) === trim($cid));
usort($entries, fn($a, $b) => strtotime($b['timestamp']) <=> strtotime($a['timestamp']));
?>

<div style="margin-top:40px;">
  <h3>Discussion</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:40px; align-items:start;">

    <!-- Add Discussion Entry (Left) -->
    <div>
      <h4>Add Discussion Entry</h4>
      <form method="post" style="display:grid; gap:15px;">
        <input type="hidden" name="contact_id" value="<?= htmlspecialchars($cid) ?>">

        <div>
          <label for="author">Author:</label><br>
          <input type="text" name="author" id="author" value="Robert Lee" required>
        </div>

        <div>
          <label for="entry_text">Comment:</label><br>
          <textarea name="entry_text" id="entry_text" rows="4" required></textarea>
        </div>

        <div>
          <label for="linked_opportunity_id">Linked Opportunity ID (optional):</label><br>
          <input type="text" name="linked_opportunity_id" id="linked_opportunity_id">
        </div>

        <div>
          <label for="visibility">Visibility:</label><br>
          <select name="visibility" id="visibility">
            <option value="public">Public</option>
            <option value="internal">Internal</option>
          </select>
        </div>

        <button type="submit" class="btn-primary">üí¨ Log Discussion</button>
      </form>
    </div>

    <!-- Discussion History (Right) -->
    <div>
      <h4>Discussion History</h4>
      <?php if (!empty($entries)): ?>
        <?php foreach ($entries as $entry): ?>
          <div style="border-left:3px solid #0099A8; padding-left:10px; margin-bottom:15px;">
            <div style="font-size:0.9em; color:#555;">
              <strong><?= htmlspecialchars($entry['author'] ?? 'Admin') ?></strong>
              <em><?= htmlspecialchars($entry['timestamp'] ?? '') ?></em>
              <?php if (!empty($entry['linked_opportunity_id'])): ?>
                ‚Ä¢ <span>Opportunity: <?= htmlspecialchars($entry['linked_opportunity_id']) ?></span>
              <?php endif; ?>
              <?php if (!empty($entry['visibility'])): ?>
                ‚Ä¢ <span>Visibility: <?= htmlspecialchars($entry['visibility']) ?></span>
              <?php endif; ?>
            </div>
            <div style="margin-top:5px;">
              <?= nl2br(htmlspecialchars($entry['entry_text'] ?? '')) ?>
            </div>
          </div>
        <?php endforeach; ?>
      <?php else: ?>
        <p style="color:#666;">No discussion history found for this contact.</p>
      <?php endif; ?>
    </div>

  </div>
</div>


--- End of discussion_module.php ---



--- Start of discussion_schema.php ---

<?php
return [
    'contact_id',
    'author',
    'timestamp',
    'entry_text',
    'linked_opportunity_id',
    'visibility'
];


--- End of discussion_schema.php ---



--- Start of discussion_validator.php ---

<?php
function validateDiscussion(array $data): array {
    $errors = [];

    if (empty($data['contact_id'])) {
        $errors['contact_id'] = 'Contact ID is required.';
    }

    if (empty($data['entry_text'])) {
        $errors['entry_text'] = 'Comment text is required.';
    }

    if (empty($data['author'])) {
        $errors['author'] = 'Author is required.';
    }

    return $errors;
}


--- End of discussion_validator.php ---



--- Start of edit_task.php ---

<?php
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $updatedTask = [
        $_POST['title'],
        $_POST['due_date'],
        $_POST['status'],
        $_POST['timestamp']
    ];
    updateTask($filename, $schema, $_POST['timestamp'], $updatedTask);
    header('Location: index.php');
    exit;
}

$timestamp = $_GET['timestamp'] ?? '';
$tasks = readCSV($filename, $schema);
$taskToEdit = null;
foreach ($tasks as $task) {
    if ($task['timestamp'] === $timestamp) {
        $taskToEdit = $task;
        break;
    }
}
if (!$taskToEdit) {
    echo "Task not found.";
    exit;
}
?>

<h3>Edit Task</h3>
<form method="POST">
  <input type="hidden" name="timestamp" value="<?= htmlspecialchars($taskToEdit['timestamp']) ?>">
  <input type="text" name="title" value="<?= htmlspecialchars($taskToEdit['title']) ?>" required>
  <input type="date" name="due_date" value="<?= htmlspecialchars($taskToEdit['due_date']) ?>" required>
  <select name="status" required>
    <option value="pending" <?= $taskToEdit['status'] === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $taskToEdit['status'] === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <button type="submit">Update Task</button>
</form>


--- End of edit_task.php ---



--- Start of enhanced_contact_list.php ---

<?php
include_once(__DIR__ . '/layout_start.php');
$currentPage = basename(__FILE__);
include_once(__DIR__ . '/navbar.php');
require_once 'csv_handler.php';

$schemaFile = __DIR__ . '/contact_schema.php';
if (!file_exists($schemaFile)) {
    die('Error: contact_schema.php not found.');
}
$schema = require $schemaFile;
if (!is_array($schema)) {
    die('Error: contact_schema.php must return an array.');
}

$contacts = readCSV('contacts.csv', $schema);
if (!is_array($contacts)) {
    $contacts = [];
}

// Extract unique values for dynamic filters
$statusOptions = [];
$tagOptions = [];
foreach ($contacts as $c) {
    if (!empty($c['status'])) {
        $statusOptions[$c['status']] = true;
    }
    if (!empty($c['tags'])) {
        foreach (explode(',', $c['tags']) as $tag) {
            $tagOptions[trim($tag)] = true;
        }
    }
}
ksort($statusOptions);
ksort($tagOptions);

// Handle query parameters
$query = strtolower(trim($_GET['query'] ?? ''));
$statusFilter = $_GET['status'] ?? '';
$tagFilter = $_GET['tag'] ?? '';
$sortField = $_GET['sort'] ?? '';
$sortDirection = $_GET['direction'] ?? 'asc';
$page = max(1, intval($_GET['page'] ?? 1));
$perPage = 25;

// Filter contacts
$contacts = array_filter($contacts, function($c) use ($query, $statusFilter, $tagFilter) {
    $matchQuery = $query === '' || (
        stripos($c['first_name'] ?? '', $query) !== false ||
        stripos($c['last_name'] ?? '', $query) !== false ||
        stripos($c['email'] ?? '', $query) !== false ||
        stripos($c['company'] ?? '', $query) !== false
    );
    $matchStatus = $statusFilter === '' || ($c['status'] ?? '') === $statusFilter;
    $matchTag = $tagFilter === '' || in_array($tagFilter, array_map('trim', explode(',', $c['tags'] ?? '')));
    return $matchQuery && $matchStatus && $matchTag;
});

// Sort contacts
if ($sortField && in_array($sortField, $schema)) {
    usort($contacts, function($a, $b) use ($sortField, $sortDirection) {
        $valA = $a[$sortField] ?? '';
        $valB = $b[$sortField] ?? '';
        $cmp = is_numeric($valA) && is_numeric($valB) ? ($valA <=> $valB) : strnatcasecmp($valA, $valB);
        return $sortDirection === 'desc' ? -$cmp : $cmp;
    });
}

// Pagination
$total = count($contacts);
$contacts = array_slice($contacts, ($page - 1) * $perPage, $perPage);

// Export CSV
if (isset($_GET['export']) && $_GET['export'] === '1') {
    $filename = 'contacts_export_' . date('Ymd_His') . '.csv';
    header('Content-Type: text/csv');
    header("Content-Disposition: attachment; filename="$filename"");
    $output = fopen('php://output', 'w');
    fputcsv($output, $schema);
    foreach ($contacts as $contact) {
        $row = [];
        foreach ($schema as $f) {
            $row[] = $contact[$f] ?? '';
        }
        fputcsv($output, $row);
    }
    fclose($output);
    exit;
}
?>

<div class="container">
  <h2>Contact List</h2>

  <form method="get" class="filter-form">
    <input type="text" name="query" placeholder="Search..." value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
    <select name="status">
      <option value="">-- Status --</option>
      <?php foreach (array_keys($statusOptions) as $status): ?>
        <option value="<?= htmlspecialchars($status) ?>" <?= $status === $statusFilter ? 'selected' : '' ?>><?= htmlspecialchars($status) ?></option>
      <?php endforeach; ?>
    </select>
    <select name="tag">
      <option value="">-- Tag --</option>
      <?php foreach (array_keys($tagOptions) as $tag): ?>
        <option value="<?= htmlspecialchars($tag) ?>" <?= $tag === $tagFilter ? 'selected' : '' ?>><?= htmlspecialchars($tag) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="submit">üîç Filter</button>
    <a href="?export=1" class="btn-outline">‚¨á Export CSV</a>
  </form>

  <table class="table-grid">
    <thead>
      <tr>
        <?php foreach ($schema as $field): ?>
          <th>
            <a href="?<?= http_build_query(array_merge($_GET, ['sort' => $field, 'direction' => ($sortField === $field && $sortDirection === 'asc') ? 'desc' : 'asc'])) ?>">
              <?= htmlspecialchars(ucwords(str_replace('_', ' ', $field))) ?>
              <?= $sortField === $field ? ($sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' ?>
            </a>
          </th>
        <?php endforeach; ?>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($contacts as $c): ?>
        <tr>
          <?php foreach ($schema as $f): ?>
            <td><?= htmlspecialchars($c[$f] ?? '') ?></td>
          <?php endforeach; ?>
        </tr>
      <?php endforeach; ?>
    </tbody>
  </table>

  <div class="pagination">
    <?php for ($i = 1; $i <= ceil($total / $perPage); $i++): ?>
      <a href="?<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
    <?php endfor; ?>
  </div>
</div>

<script>
document.querySelector('input[name="query"]').addEventListener('input', function(e) {
  const form = e.target.closest('form');
  clearTimeout(window.liveSearchTimeout);
  window.liveSearchTimeout = setTimeout(() => form.submit(), 500);
});
</script>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of enhanced_contact_list.php ---



--- Start of export_contacts.php ---

<?php
require_once 'csv_handler.php';
require_once 'csv_export.php';

$filename = 'contacts.csv';
$schema = require __DIR__ . '/contact_schema.php';
$contacts = readCSV($filename, $schema);

// Build filters from query string using schema
$filters = [];
foreach ($schema as $field) {
    if (!empty($_GET[$field])) {
        $filters[$field] = $_GET[$field];
    }
}

// Schema-safe export function
function exportCSVFiltered($filename, $rows, $filters = [], $schema = []) {
    $filtered = array_filter($rows, function($row) use ($filters) {
        foreach ($filters as $key => $value) {
            if ($row[$key] !== $value) return false;
        }
        return true;
    });
    return writeCSV($filename, array_values($filtered), $schema);
}

// Export filtered contacts to a new file
$exported = exportCSVFiltered('contacts_export.csv', $contacts, $filters, $schema);
echo $exported ? "Export complete." : "No matching contacts.";
?>


--- End of export_contacts.php ---



--- Start of follow_up_email.php ---

<?php
// follow_up_email.php

$contactName = $contact['name'] ?? 'there';
$companyName = $contact['company'] ?? 'your team';
$contactEmail = $contact['email'] ?? '';
$contactId = $contact['id'] ?? 0;
?>

<div class="module follow-up-email">
  <h3>Send Email</h3>
  <button onclick="generateEmail('followup')">Follow-Up After Call</button>
  <button onclick="generateEmail('intro')">Introductory Email</button>
  <button onclick="generateEmail('touchbase')">Touch Base Email</button>
  <button id="sendEmailBtn" onclick="sendFollowUpEmail()">Send Email</button>

  <textarea id="followUpEmail" rows="12" class="email-textarea"></textarea>
</div>

<script>
const contactName = "<?= htmlspecialchars($contactName, ENT_QUOTES) ?>";
const contactEmail = "<?= htmlspecialchars($contactEmail, ENT_QUOTES) ?>";
let currentEmailType = '';

function generateEmail(type) {
  currentEmailType = type;

  let body = '';
  switch (type) {
    case 'followup':
      body = `Hi ${contactName},

It was great speaking with you earlier. I wanted to follow up on our conversation and thank you for taking the time to connect.

At Eclipse Water Technologies, we‚Äôre committed to providing responsive, local service without the delays or complications of cross-border logistics. Whether it‚Äôs a complex treatment challenge or a routine system check, our team is here to support you.

If you have any questions or would like to explore next steps, feel free to reach out anytime.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'intro':
      body = `Hi ${contactName},

I wanted to introduce you to Eclipse Water Technologies ‚Äî a local provider of industrial water and wastewater solutions.

We specialize in everything from advanced treatment systems to simple filter replacements, and our team is known for responsive service and technical expertise. Being local means no border delays or tariffs ‚Äî just fast, reliable support.

We‚Äôd love to learn more about your needs and explore how we can help.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;

    case 'touchbase':
      body = `Hi ${contactName},

I hope things are going well on your end. I just wanted to touch base and see if there‚Äôs anything you might need support with regarding your water or wastewater systems.

At Eclipse Water Technologies, we‚Äôre always happy to reconnect and help ‚Äî whether it‚Äôs a quick filter change or a more involved project.

Feel free to reach out anytime if you'd like to chat or explore options.

Best regards,  
Robert Lee  CET PMP  
Managing Director  
Eclipse Water Technologies  
üìû 647-355-0944  
üìß rlee@eclipsewatertechnologies.com  
üåê https://eclipsewatertechnologies.com`;
      break;
  }

  document.getElementById('followUpEmail').value = body;
}

function sendFollowUpEmail() {
  const emailBody = document.getElementById('followUpEmail').value.trim();
  const subjectLine = "Industrial Water Treatment - Eclipse Water Technologies";

  if (!contactEmail) {
    alert("No email address found for this contact.");
    return;
  }

  if (!emailBody) {
    alert("Email body is empty. Please generate or write your message.");
    return;
  }

  const mailtoLink = `mailto:${contactEmail}?subject=${encodeURIComponent(subjectLine)}&body=${encodeURIComponent(emailBody)}`;
  window.location.href = mailtoLink;
}
</script>

--- End of follow_up_email.php ---



--- Start of forecast_calc.php ---

<?php
require_once 'csv_handler.php';

function calculateForecasts($filename = 'opportunities.csv') {
    $schema = require __DIR__ . '/opportunity_schema.php';
    $opportunities = readCSV($filename, $schema);
    $results = [];
    $stageTotals = [];

    foreach ($opportunities as $opp) {
        $value = floatval($opp['value']);
        $probability = floatval($opp['probability']);
        $forecast = round($value * ($probability / 100), 2);

        $stage = $opp['stage'] ?? 'Unspecified';

        // Add to grouped stage totals
        if (!isset($stageTotals[$stage])) {
            $stageTotals[$stage] = ['count' => 0, 'total_forecast' => 0];
        }
        $stageTotals[$stage]['count']++;
        $stageTotals[$stage]['total_forecast'] += $forecast;

        // Add to individual forecast list
        $results[] = [
            'id' => $opp['id'] ?? '',
            'contact_id' => $opp['contact_id'] ?? '',
            'stage' => $stage,
            'value' => $value,
            'forecast' => $forecast
        ];
    }

    return [
        'individual' => $results,
        'by_stage' => $stageTotals
    ];
}
?>


--- End of forecast_calc.php ---



--- Start of get_oauth_token.php ---

<?php


require_once 'contact_validator.php';/**
 * PHPMailer - PHP email creation and transport class.
 * PHP Version 5.5
 * @package PHPMailer
 * @see https://github.com/PHPMailer/PHPMailer/ The PHPMailer GitHub project
 * @author Marcus Bointon (Synchro/coolbru) <phpmailer@synchromedia.co.uk>
 * @author Jim Jagielski (jimjag) <jimjag@gmail.com>
 * @author Andy Prevost (codeworxtech) <codeworxtech@users.sourceforge.net>
 * @author Brent R. Matzelle (original founder)
 * @copyright 2012 - 2020 Marcus Bointon
 * @copyright 2010 - 2012 Jim Jagielski
 * @copyright 2004 - 2009 Andy Prevost
 * @license https://www.gnu.org/licenses/old-licenses/lgpl-2.1.html GNU Lesser General Public License
 * @note This program is distributed in the hope that it will be useful - WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.
 */

/**
 * Get an OAuth2 token from an OAuth2 provider.
 * * Install this script on your server so that it's accessible
 * as [https/http]://<yourdomain>/<folder>/get_oauth_token.php
 * e.g.: http://localhost/phpmailer/get_oauth_token.php
 * * Ensure dependencies are installed with 'composer install'
 * * Set up an app in your Google/Yahoo/Microsoft account
 * * Set the script address as the app's redirect URL
 * If no refresh token is obtained when running this file,
 * revoke access to your app and run the script again.
 */

namespace PHPMailer\PHPMailer;

/**
 * Aliases for League Provider Classes
 * Make sure you have added these to your composer.json and run `composer install`
 * Plenty to choose from here:
 * @see https://oauth2-client.thephpleague.com/providers/thirdparty/
 */
//@see https://github.com/thephpleague/oauth2-google
use League\OAuth2\Client\Provider\Google;
//@see https://packagist.org/packages/hayageek/oauth2-yahoo
use Hayageek\OAuth2\Client\Provider\Yahoo;
//@see https://github.com/stevenmaguire/oauth2-microsoft
use Stevenmaguire\OAuth2\Client\Provider\Microsoft;
//@see https://github.com/greew/oauth2-azure-provider
use Greew\OAuth2\Client\Provider\Azure;

if (!isset($_GET['code']) && !isset($_POST['provider'])) {
    ?>
<html>
<body>
<?php include_once 'navbar.php'; ?>
<?php include 'navbar.php'; ?>
<form method="post">
    <h1>Select Provider</h1>
    <input type="radio" name="provider" value="Google" id="providerGoogle">
    <label for="providerGoogle">Google</label><br>
    <input type="radio" name="provider" value="Yahoo" id="providerYahoo">
    <label for="providerYahoo">Yahoo</label><br>
    <input type="radio" name="provider" value="Microsoft" id="providerMicrosoft">
    <label for="providerMicrosoft">Microsoft</label><br>
    <input type="radio" name="provider" value="Azure" id="providerAzure">
    <label for="providerAzure">Azure</label><br>
    <h1>Enter id and secret</h1>
    <p>These details are obtained by setting up an app in your provider's developer console.
    </p>
    <p>ClientId: <input type="text" name="clientId"><p>
    <p>ClientSecret: <input type="text" name="clientSecret"></p>
    <p>TenantID (only relevant for Azure): <input type="text" name="tenantId"></p>
    <input type="submit" value="Continue">
</form>
<?php include 'layout_end.php'; ?>
</body>
</html>
    <?php
    exit;
}

require 'vendor/autoload.php';

session_start();

$providerName = '';
$clientId = '';
$clientSecret = '';
$tenantId = '';

if (array_key_exists('provider', $_POST)) {
    $providerName = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST['provider'];
    $clientId = $_POST['clientId'];
    $clientSecret = $_POST['clientSecret'];
    $tenantId = $_POST['tenantId'];
    $_SESSION['provider'] = $providerName;
    $_SESSION['clientId'] = $clientId;
    $_SESSION['clientSecret'] = $clientSecret;
    $_SESSION['tenantId'] = $tenantId;
} elseif (array_key_exists('provider', $_SESSION)) {
    $providerName = $_SESSION['provider'];
    $clientId = $_SESSION['clientId'];
    $clientSecret = $_SESSION['clientSecret'];
    $tenantId = $_SESSION['tenantId'];
}

//If you don't want to use the built-in form, set your client id and secret here
//$clientId = 'RANDOMCHARS-----duv1n2.apps.googleusercontent.com';
//$clientSecret = 'RANDOMCHARS-----lGyjPcRtvP';

//If this automatic URL doesn't work, set it yourself manually to the URL of this script
$redirectUri = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'];
//$redirectUri = 'http://localhost/PHPMailer/redirect';

$params = [
    'clientId' => $clientId,
    'clientSecret' => $clientSecret,
    'redirectUri' => $redirectUri,
    'accessType' => 'offline'
];

$options = [];
$provider = null;

switch ($providerName) {
    case 'Google':
        $provider = new Google($params);
        $options = [
            'scope' => [
                'https://mail.google.com/'
            ]
        ];
        break;
    case 'Yahoo':
        $provider = new Yahoo($params);
        break;
    case 'Microsoft':
        $provider = new Microsoft($params);
        $options = [
            'scope' => [
                'wl.imap',
                'wl.offline_access'
            ]
        ];
        break;
    case 'Azure':
        $params['tenantId'] = $tenantId;

        $provider = new Azure($params);
        $options = [
            'scope' => [
                'https://outlook.office.com/SMTP.Send',
                'offline_access'
            ]
        ];
        break;
}

if (null === $provider) {
    exit('Provider missing');
}

if (!isset($_GET['code'])) {
    //If we don't have an authorization code then get one
    $authUrl = $provider->getAuthorizationUrl($options);
    $_SESSION['oauth2state'] = $provider->getState();
    header('Location: ' . $authUrl);
    exit;
    //Check given state against previously stored one to mitigate CSRF attack
} elseif (empty($_GET['state']) || ($_GET['state'] !== $_SESSION['oauth2state'])) {
    unset($_SESSION['oauth2state']);
    unset($_SESSION['provider']);
    exit('Invalid state');
} else {
    unset($_SESSION['provider']);
    //Try to get an access token (using the authorization code grant)
    $token = $provider->getAccessToken(
        'authorization_code',
        [
            'code' => $_GET['code']
        ]
    );
    //Use this to interact with an API on the users behalf
    //Use this to get a new access token if the old one expires
    echo 'Refresh Token: ', htmlspecialchars($token->getRefreshToken());
}


--- End of get_oauth_token.php ---



--- Start of get_tasks.php ---

<?php
$filename = 'tasks.csv';

if (!file_exists($filename)) {
    exit;
}

$tasks = [];

if (($fp = fopen($filename, 'r')) !== false) {
    $headers = fgetcsv($fp); // Read header row
    while (($row = fgetcsv($fp)) !== false) {
        $task = array_combine($headers, $row);
        if ($task['status'] !== 'archived') {
            $id = htmlspecialchars($task['id']);
            $title = htmlspecialchars($task['title']);
            $timestamp = htmlspecialchars($task['timestamp']);
            $tasks[] = "<li>$title (Created: $timestamp) <button onclick=\"archiveTask('$id')\">Archive</button></li>";
        }
    }
    fclose($fp);
}

echo implode('', $tasks);
?>

--- End of get_tasks.php ---



--- Start of import_contacts.php ---

<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
$pageTitle = 'Import Contacts';
$currentPage = basename(__FILE__);
include_once 'layout_start.php';
include_once 'navbar.php';
require_once 'csv_handler.php';

$schema = require __DIR__ . '/contact_schema.php';
?>

<div class="container">
  <h2>Import Contacts</h2>

  <!-- Upload Form -->
  <form method="POST" enctype="multipart/form-data" class="contact-form">
    <label for="csv_file">Upload CSV File:</label>
    <input type="file" name="csv_file" accept=".csv" required>

    <!-- Buttons aligned horizontally -->
    <div style="margin-top: 10px;">
      <button type="submit">Preview Import</button>
      <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name'])): ?>
        <button type="button" class="btn-confirm" onclick="showConfirmModal()">Commit Import</button>
      <?php endif; ?>
    </div>
  </form>

  <?php
  if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file']) && is_uploaded_file($_FILES['csv_file']['tmp_name'])) {
      $tmp = $_FILES['csv_file']['tmp_name'];
      $rows = array_map('str_getcsv', file($tmp));
      $header = array_map('trim', array_shift($rows));
      $preview = [];

      foreach ($rows as $row) {
          $contact = array_combine($header, $row);
          $contact['id'] = uniqid();

          foreach ($schema as $field) {
              if (!isset($contact[$field])) {
                  $contact[$field] = '';
              }
          }

          $preview[] = $contact;
      }

      $_SESSION['import_preview'] = $preview;

      echo "<h3>Preview Contacts</h3>";

      if (empty($preview)) {
          echo "<p style='color:red;'>No contacts to preview.</p>";
      } else {
          echo "<form method='POST' action='commit_import.php' id='commitForm'>";
          echo "<table class='spec-table'><thead><tr>";
          foreach ($schema as $col) {
              echo "<th>" . htmlspecialchars(ucfirst(str_replace('_', ' ', $col))) . "</th>";
          }
          echo "</tr></thead><tbody>";
          foreach ($preview as $contact) {
              echo "<tr>";
              foreach ($schema as $col) {
                  echo "<td>" . htmlspecialchars($contact[$col] ?? '') . "</td>";
              }
              echo "</tr>";
          }
          echo "</tbody></table>";
          echo "</form>"; // ‚úÖ Form ends here, submit triggered by modal
      }
  }
  ?>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Confirm Import</h3>
    <p>This will permanently add these contacts to the system. Proceed?</p>
    <button onclick="document.getElementById('commitForm').submit()">Yes, Commit</button>
    <button onclick="hideConfirmModal()">Cancel</button>
  </div>
</div>

<!-- Modal Styles & Script -->
<style>
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
}
.modal-box {
  background: #fff; padding: 20px 30px; border-radius: 8px; text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.modal-box button {
  margin: 10px; padding: 8px 16px; border: none; border-radius: 4px;
  background: #0077cc; color: #fff; cursor: pointer;
}
.modal-box button:hover {
  background: #005fa3;
}
</style>

<script>
function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
}
</script>

<?php include_once 'layout_end.php'; ?>


--- End of import_contacts.php ---



--- Start of index.php ---

<?php
$pageTitle = 'Task Calendar';
header('Content-Type: text/html; charset=UTF-8');

require_once 'layout_start.php';
require_once 'csv_handler.php';

$filename = 'tasks.csv';
$schema = ['title', 'due_date', 'status', 'timestamp'];
$tasks = readCSV($filename, $schema);

$statusFilter = isset($_GET['status']) ? $_GET['status'] : '';
$year = isset($_GET['year']) ? $_GET['year'] : date('Y');
$month = isset($_GET['month']) ? $_GET['month'] : date('m');

$tasksByDate = [];
foreach ($tasks as $task) {
    if ($task['status'] !== 'archived' && !empty($task['due_date'])) {
        if ($statusFilter === '' || $task['status'] === $statusFilter) {
            $tasksByDate[$task['due_date']][] = $task;
        }
    }
}

$prevMonth = $month - 1;
$prevYear = $year;
if ($prevMonth < 1) {
    $prevMonth = 12;
    $prevYear--;
}

$nextMonth = $month + 1;
$nextYear = $year;
if ($nextMonth > 12) {
    $nextMonth = 1;
    $nextYear++;
}
?>

<div class="calendar-container">
<style>
  .calendar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ccc;
    text-align: center;
    padding: 20px;
    vertical-align: top;
    word-wrap: break-word;
  }
  th {
    background-color: #f4f4f4;
    font-weight: bold;
  }
  .has-task {
    background-color: #ffeeba;
    cursor: pointer;
    position: relative;
  }
  .task-popup {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 100;
    top: 100%;
    left: 0;
    width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>

<h2>Task Calendar</h2>

<div style="text-align:center; margin-bottom:20px;">
  <a href="?year=<?= $prevYear ?>&month=<?= str_pad($prevMonth, 2, '0', STR_PAD_LEFT) ?>">‚Üê Previous</a>
  <strong><?= date('F Y', strtotime("$year-$month-01")) ?></strong>
  <a href="?year=<?= $nextYear ?>&month=<?= str_pad($nextMonth, 2, '0', STR_PAD_LEFT) ?>">Next ‚Üí</a>
</div>

<form method="GET" style="margin-bottom: 20px;">
  <label for="status">Filter by status:</label>
  <select name="status" id="status" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="pending" <?= $statusFilter === 'pending' ? 'selected' : '' ?>>Pending</option>
    <option value="completed" <?= $statusFilter === 'completed' ? 'selected' : '' ?>>Completed</option>
  </select>
  <input type="hidden" name="year" value="<?= $year ?>">
  <input type="hidden" name="month" value="<?= $month ?>">
</form>

<h3>Add New Task</h3>
<form method="POST" action="add_task.php" onsubmit="return validateForm()">
  <input type="text" name="title" id="title" placeholder="Task Title" required>
  <input type="date" name="due_date" id="due_date" required>
  <select name="status" id="status" required>
    <option value="">Select Status</option>
    <option value="pending">Pending</option>
    <option value="completed">Completed</option>
  </select>
  <button type="submit">Add Task</button>
</form>

<table>
  <tr>
    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
  </tr>
<?php
$daysInMonth = date('t', strtotime("$year-$month-01"));
$firstDayOfMonth = date('w', strtotime("$year-$month-01"));

$day = 1;
$week = [];

for ($i = 0; $i < $firstDayOfMonth; $i++) {
    $week[] = "<td></td>";
}

while ($day <= $daysInMonth) {
    $dateStr = "$year-$month-" . str_pad($day, 2, '0', STR_PAD_LEFT);
    if (isset($tasksByDate[$dateStr])) {
        $taskTitles = '';
        foreach ($tasksByDate[$dateStr] as $task) {
            $taskTitles .= htmlspecialchars($task['title']) . " (Created: " . htmlspecialchars($task['timestamp']) . ")<br>";
            $taskTitles .= "edit_task.php?timestamp=Edit</a> | ";
            $taskTitles .= "delete_task.php?timestamp=Delete</a><br><br>";
        }
        $week[] = "<td class='has-task' onclick=\"showTasks('$dateStr')\">$day<div id='popup-$dateStr' class='task-popup'>$taskTitles</div></td>";
    } else {
        $week[] = "<td>$day</td>";
    }

    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;
}


    if (count($week) == 7) {
        echo "<tr>" . implode('', $week) . "</tr>";
        $week = [];
    }

    $day++;

if (!empty($week)) {
    while (count($week) < 7) {
        $week[] = "<td></td>";
    }
    echo "<tr>" . implode('', $week) . "</tr>";
}
?>
</table>
</div>

<script>
function showTasks(date) {
  var popup = document.getElementById('popup-' + date);
  if (popup.style.display === 'block') {
    popup.style.display = 'none';
  } else {
    document.querySelectorAll('.task-popup').forEach(p => p.style.display = 'none');
    popup.style.display = 'block';
  }
}

function validateForm() {
  const title = document.getElementById('title').value.trim();
  const dueDate = document.getElementById('due_date').value;
  const status = document.getElementById('status').value;

  if (title === '') {
    alert('Please enter a task title.');
    return false;
  }

  if (dueDate === '') {
    alert('Please select a due date.');
    return false;
  }

  if (status === '') {
    alert('Please select a status.');
    return false;
  }

  return true;
}
</script>

<?php include 'layout_end.php'; ?>


--- End of index.php ---



--- Start of inject_ids.php ---

<?php
function injectIdsIntoCsv($inputFile, $outputFile, $idPrefix = 'CNT') {
    $rows = array_map('str_getcsv', file($inputFile));
    $header = $rows[0];

    // Add ID column if missing
    if (!in_array('id', $header)) {
        array_unshift($header, 'id');
    }

    $newRows = [$header];
    for ($i = 1; $i < count($rows); $i++) {
        $row = $rows[$i];
        $id = $idPrefix . '_' . date('YmdHis') . '_' . bin2hex(random_bytes(3));
        array_unshift($row, $id);
        $newRows[] = $row;
    }

    // Write to output file
    $fp = fopen($outputFile, 'w');
    foreach ($newRows as $fields) {
        fputcsv($fp, $fields);
    }
    fclose($fp);
}


--- End of inject_ids.php ---



--- Start of layout_end.php ---

</div> <!-- end container -->
</body>
</html>


--- End of layout_end.php ---



--- Start of layout_start.php ---

<?php
$pageTitle = $pageTitle ?? 'CRM';
$currentPage = basename($_SERVER['SCRIPT_NAME']);
header('Content-Type: text/html; charset=UTF-8');
header('X-Content-Type-Options: nosniff');
?>
<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="CRM system for managing contacts and customer interactions.">
  <meta name="author" content="Eclipse Water Technologies">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="<?= htmlspecialchars($pageTitle) ?>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/<?= htmlspecialchars($currentPage) ?>">
  <meta property="og:image" content="https://yourdomain.com/images/preview.png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css?v=20251002">
  <title><?= htmlspecialchars($pageTitle) ?></title>
</head>
<body>
<?php include_once 'navbar.php'; ?>
<div class="container">
  <div id="task-list-panel">
    <h3>Programming Tasks</h3>
    <ul id="task-list"></ul>
    <input type="text" id="new-task" placeholder="Add new task..." />
    <button onclick="addTask()">Add</button>
  </div>
</div>
<script src="/task-list.js"></script>
</body>
</html>


--- End of layout_start.php ---



--- Start of navbar.php ---

<nav class="navbar">
  <ul>
    <li><a href="dashboard.php" class="<?= $currentPage === 'dashboard.php' ? 'active' : '' ?>">Dashboard</a></li>
    <li><a href="contacts_list.php" class="<?= $currentPage === 'contacts_list.php' ? 'active' : '' ?>">Contact List</a></li>
    <li><a href="add_customer.php" class="<?= $currentPage === 'add_customer.php' ? 'active' : '' ?>">‚ûï Add Customer</a></li>
    <li><a href="customers_list.php" class="<?= $currentPage === 'customers_list.php' ? 'active' : '' ?>">üìã Customer List</a></li>
    <li><a href="customer_view.php?id=demo" class="<?= $currentPage === 'customer_view.php' ? 'active' : '' ?>">üëÅ View Customer</a></li>
    <li><a href="calendar.php" class="<?= $currentPage === 'calendar.php' ? 'active' : '' ?>">üìÖ Calendar</a></li>
    <li><a href="contact_form.php" class="<?= $currentPage === 'contact_form.php' ? 'active' : '' ?>">Add Contact</a></li>
    <li><a href="opportunities_list.php" class="<?= $currentPage === 'opportunities_list.php' ? 'active' : '' ?>">Opportunities</a></li>
    <li><a href="opportunity_form.php" class="<?= $currentPage === 'opportunity_form.php' ? 'active' : '' ?>">Add Opportunity</a></li>
    <li><a href="import_contacts.php" class="<?= $currentPage === 'import_contacts.php' ? 'active' : '' ?>">Import</a></li>
    <li><a href="export_contacts.php" class="<?= $currentPage === 'export_contacts.php' ? 'active' : '' ?>">Export</a></li>
  </ul>
</nav>


--- End of navbar.php ---



--- Start of opportunities_list.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$opportunities = readCSV('opportunities.csv', $schema);
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');


// Build contact lookup map with fallback label
$contactMap = [];
foreach ($contacts as $contact) {
    $fullName = trim($contact['first_name'] . ' ' . $contact['last_name']);
    $contactMap[trim($contact['id'])] = $fullName ?: 'Unnamed Contact';
}
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Opportunities List</h2>

  <?php if (empty($opportunities)): ?>
    <p>No opportunities found.</p>
  <?php else: ?>
    <table class="data-table">
      <thead>
        <tr>
          <?php foreach ($schema as $field): ?>
            <th><?= ucwords(str_replace('_', ' ', $field)) ?></th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($opportunities as $opp): ?>
          <tr>
            <?php foreach ($schema as $field): ?>
              <td>
                <?php
                  if ($field === 'contact_id') {
                      $contactId = trim($opp[$field] ?? '');
                      echo isset($contactMap[$contactId])
                          ? $contactMap[$contactId]
                          : 'Unknown';
                  } else {
                      echo htmlspecialchars($opp[$field] ?? '');
                  }
                ?>
              </td>
            <?php endforeach; ?>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  <?php endif; ?>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunities_list.php ---



--- Start of opportunity_form.php ---

<?php
require_once 'csv_handler.php';
$schema = require __DIR__ . '/opportunity_schema.php';
$contacts = readCSV('contacts.csv', require __DIR__ . '/contact_schema.php');
?>

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>

<div class="container">
  <h2>Add New Opportunity</h2>

  <?php if (!empty($_GET['status']) && $_GET['status'] === 'success'): ?>
    <p class="success-msg">Opportunity saved successfully.</p>
  <?php elseif (!empty($_GET['status']) && $_GET['status'] === 'error'): ?>
    <p class="error-msg">Invalid opportunity data or contact ID.</p>
  <?php endif; ?>

  <form id="opportunity-form" action="add_opportunity.php" method="POST" class="form-block">
    <?php foreach ($schema as $field): ?>
      <?php if ($field === 'id') continue; ?>

      <div class="form-group">
        <label for="<?= $field ?>"><?= ucwords(str_replace('_', ' ', $field)) ?>:</label>

        <?php if ($field === 'contact_id'): ?>
          <select name="contact_id" id="contact_id" class="form-control" required>
            <option value="">Select Contact</option>
            <?php foreach ($contacts as $contact): ?>
              <option value="<?= $contact['id'] ?>">
                <?= trim($contact['first_name'] . ' ' . $contact['last_name']) ?: 'Unnamed Contact' ?>
              </option>
            <?php endforeach; ?>
          </select>

        <?php elseif ($field === 'stage'): ?>
          <select name="stage" id="stage" class="form-control" required>
            <option value="">Select Stage</option>
            <option value="Prospecting">Prospecting</option>
            <option value="Proposal">Proposal</option>
            <option value="Negotiation">Negotiation</option>
            <option value="Closed Won">Closed Won</option>
            <option value="Closed Lost">Closed Lost</option>
          </select>

        <?php elseif ($field === 'expected_close'): ?>
          <input type="date" name="expected_close" id="expected_close" class="form-control" required>

        <?php elseif ($field === 'value' || $field === 'probability'): ?>
          <input type="number" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>

        <?php else: ?>
          <input type="text" name="<?= $field ?>" id="<?= $field ?>" class="form-control" required>
        <?php endif; ?>
      </div>
    <?php endforeach; ?>

    <button type="submit" class="btn-primary">Save Opportunity</button>
  </form>
</div>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of opportunity_form.php ---



--- Start of opportunity_schema.php ---

<?php
return [
   'contact_id',
  'value',
  'stage',
  'probability',
  'expected_close'
];


--- End of opportunity_schema.php ---



--- Start of submit-contact.php ---

<?php

require_once 'contact_validator.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'PHPMailer.php';
require 'SMTP.php';
require 'Exception.php';

$schema = require __DIR__ . '/contact_schema.php';
$mail = new PHPMailer(true);

try {
    // Collect and sanitize form data
    $data = [];
    foreach ($schema as $field) {
        if ($field === 'id') continue;
        $value = htmlspecialchars(trim($_POST[$field] ?? ''));
        $data[$field] = $value;
    }

    // Validate required fields
    if (empty($data['first_name']) || empty($data['email']) || empty($data['message'])) {
        throw new Exception("Please fill in all required fields.");
    }

    // Save to CSV
    $csvRow = array_values($data);
    $csvRow[] = date('Y-m-d H:i:s');
    $file = fopen('contacts.csv', 'a');
    if ($file) {
        fputcsv($file, $csvRow);
        fclose($file);
    } else {
        throw new Exception("Unable to write to contacts.csv");
    }

    // GoDaddy relay SMTP settings
    $mail->SMTPDebug = 0;
    $mail->isSMTP();
    $mail->Host = 'relay-hosting.secureserver.net';
    $mail->SMTPAuth = false;
    $mail->SMTPSecure = '';
    $mail->Port = 25;

    // Email headers
    $mail->setFrom('rlee@eclipsewatertechnologies.com', 'Eclipse Contact Form');
    $mail->addAddress('rlee@eclipsewatertechnologies.com');
    $mail->addReplyTo($data['email'], $data['first_name']);

    // Email content
    $mail->Subject = 'New Contact Form Submission';
    $mail->Body = "Name: {$data['first_name']}\nEmail: {$data['email']}\nCompany: {$data['company']}\nMessage:\n{$data['message']}";

    $mail->send();

    // Redirect with success status
    header('Location: contact_form.php?status=success');
    exit;

} catch (Exception $e) {
    error_log("Contact form error: " . $e->getMessage());
    header('Location: contact_form.php?status=error');
    exit;
}


--- End of submit-contact.php ---



--- Start of tag_schema.php ---

<?phpreturn [
    'VIP' => 'VIP Client',
    'Lead' => 'Sales Lead',
    'Newsletter' => 'Newsletter Subscriber',
    'Inactive' => 'Inactive Contact',
    'Partner' => 'Business Partner',
    'Support' => 'Support Request',
    'Demo' => 'Requested Demo',
];
>

--- End of tag_schema.php ---



--- Start of update_contact.php ---

<?php include_once(__DIR__ . '/layout_start.php'); ?>
<?php $currentPage = basename(__FILE__); include_once(__DIR__ . '/navbar.php'); ?>
<?php

require_once 'contact_validator.php';require_once 'csv_handler.php';

$schema = getContactSchema();
$contacts = readCSV('contacts.csv');
$updatedId = $_POST['id'] ?? null;

if (!$updatedId) {
    echo "Missing contact ID.";
    exit;
}

// Build updated contact
$updatedContact = [];
foreach ($schema as $col) {
    $updatedContact[$col] = $errors = validateContact($_POST);
if (!empty($errors)) {
  foreach ($errors as $f => $msg) {
    echo "<p>Error in $f: $msg</p>";
  }
  exit;
}

$_POST[$col] ?? '';
}

// Replace contact in list
$updatedList = array_map(function($c) use ($updatedId, $updatedContact) {
    return $c['id'] === $updatedId ? $updatedContact : $c;
}, $contacts);

// Write back to CSV
writeCSV('contacts.csv', $updatedList);

// Redirect to viewer
header("Location: contact_view.php?id=$updatedId");
exit;
?>

<?php include_once(__DIR__ . '/layout_end.php'); ?>


--- End of update_contact.php ---



--- Start of validation.php ---

<?php
function isValidEmail($email) {
    return filter_var($email, FILTER_VALIDATE_EMAIL);
}

function isValidPhone($phone) {
    return preg_match('/^\+?[0-9\s\-]{7,15}$/', $phone);
}

function validateContact($row) {
    return isset($row['first_name'], $row['last_name'], $row['email']) &&
           isValidEmail($row['email']) &&
           isValidPhone($row['phone']);
}
?>


--- End of validation.php ---



--- Start of phpinfo.php ---

<?php phpinfo(); ?>



--- End of phpinfo.php ---

