<?php
$pageTitle = 'contact_view.php';
include 'layout_start.php';
?>
<!DOCTYPE html>
<html>
<head>
  <title>Contact Viewer</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<?php include_once 'navbar.php'; ?>
<?php include 'navbar.php'; ?>
  <div class="container">
    <h2>Contact Viewer</h2>
    <div class="table-wrap">
      <?php
      require_once 'csv_handler.php';

      $selectedId = $_GET['id'] ?? null;
      if (!$selectedId) {
          echo "<p>No contact selected.</p>";
          exit;
      }

      $schema = getContactSchema();
      $allContacts = readCSV('contacts.csv');
      $contacts = array_filter($allContacts, function($c) use ($selectedId) {
          return $c['id'] === $selectedId;
      });
      $contacts = array_values($contacts);

      if (empty($contacts)) {
          echo "<p>Contact not found.</p>";
          exit;
      }

      $opportunities = readCSV('opportunities.csv');
      $discussions = readCSV('discussion_log.csv');

      // Group opportunities by contact_id
      $oppByContact = [];
      foreach ($opportunities as $opp) {
          $cid = $opp['contact_id'];
          $oppByContact[$cid][] = $opp;
      }

      // Group discussion logs by contact_id
      $logByContact = [];
      foreach ($discussions as $log) {
          $cid = $log['contact_id'];
          $logByContact[$cid][] = $log;
      }

      // Display selected contact
      $contact = $contacts[0];
      $cid = $contact['id'];

      echo "<form method='POST' action='update_contact.php'>";
      echo "<table class='spec-table'>";
      echo "<thead><tr>";
      foreach ($schema as $col) {
          if ($col === 'id') continue;
          echo "<th>" . ucfirst(str_replace('_', ' ', $col)) . "</th>";
      }
      echo "</tr></thead><tbody>";

      echo "<tr>";
      foreach ($schema as $col) {
          if ($col === 'id') {
              echo "<input type='hidden' name='id' value='" . htmlspecialchars($contact['id']) . "'>";
              continue;
          }
          $value = htmlspecialchars($contact[$col] ?? '');
          echo "<td><input type='text' name='$col' value='$value' placeholder='" . ucfirst(str_replace('_', ' ', $col)) . "'></td>";
      }
      echo "</tr>";
      echo "<tr><td colspan='" . (count($schema) - 1) . "' style='text-align:right;'>";
      echo "<button type='submit'>Save Changes</button>";
      echo "</td></tr>";
      echo "</tbody></table>";
      echo "</form>";

      // Opportunities
      if (isset($oppByContact[$cid])) {
          echo "<table class='spec-table'><tr><td colspan='" . (count($schema) - 1) . "'>";
          echo "<strong>Opportunities:</strong><ul class='opp-list'>";
          foreach ($oppByContact[$cid] as $opp) {
              $forecast = floatval($opp['value']) * (floatval($opp['probability']) / 100);
              echo "<li>{$opp['stage']} – $" . number_format($opp['value'], 2) .
                   " (Forecast: $" . number_format($forecast, 2) . ") – Close: {$opp['expected_close']}</li>";
          }
          echo "</ul></td></tr></table>";
      }

      // Discussion Log
      if (isset($logByContact[$cid])) {
          echo "<table class='spec-table'><tr><td colspan='" . (count($schema) - 1) . "'>";
          echo "<strong>Discussion Log:</strong><ul class='log-list'>";
          usort($logByContact[$cid], function($a, $b) {
              return strtotime($a['timestamp']) <=> strtotime($b['timestamp']);
          });
          foreach ($logByContact[$cid] as $log) {
              $timestamp = htmlspecialchars($log['timestamp']);
              $author = htmlspecialchars($log['author']);
              $entry = nl2br(htmlspecialchars($log['entry_text']));
              echo "<li><em>{$timestamp}</em> by <strong>{$author}</strong>: {$entry}</li>";
          }
          echo "</ul></td></tr></table>";
      }

      // Add Discussion Form
      echo "<table class='spec-table'><tr><td colspan='" . (count($schema) - 1) . "'>";
      echo "<strong>Add New Discussion Entry:</strong>";
      echo "<form method='POST' action='add_discussion.php' class='discussion-form'>";
      echo "<label for='author'>Your Name:</label>";
      echo "<input type='text' name='author' id='author' required>";

      echo "<label for='entry_text'>Discussion Notes:</label>";
      echo "<textarea name='entry_text' id='entry_text' rows='4' required></textarea>";

      echo "<label for='linked_opportunity_id'>Opportunity ID (optional):</label>";
      echo "<input type='text' name='linked_opportunity_id' id='linked_opportunity_id'>";

      echo "<label for='visibility'>Visibility:</label>";
      echo "<select name='visibility' id='visibility'>
              <option value='public'>Public</option>
              <option value='private'>Private</option>
            </select>";
      echo "<button type='submit'>Add Discussion</button>";
      echo "<input type='hidden' name='contact_id' value='{$cid}'>";
      echo "</form>";
      echo "</td></tr></table>";
      ?>
    </div>
    <p><a href="contacts_list.php" class="btn">← Back to All Contacts</a></p>
  </div>
<?php include 'layout_end.php'; ?>
</body>
</html>
