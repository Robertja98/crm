<?php
$pageTitle = 'contacts_list.php';
include 'layout_start.php';
?>
<!DOCTYPE html>
<html>
<head>
  <title>Contacts List</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<?php include_once 'navbar.php'; ?>
<?php include 'navbar.php'; ?>
  <div class="container">
    <h2>All Contacts</h2>

    <h3>Filter Contacts</h3>
    <form method="GET" class="contact-form">
      <label for="query">Search:</label>
      <input type="text" name="query" id="query" placeholder="Name, company, or email" value="<?= htmlspecialchars($_GET['query'] ?? '') ?>">
      <button type="submit">Filter</button>
    </form>

    <?php
    require_once 'csv_handler.php';

    $schema = getContactSchema();
    $query = strtolower(trim($_GET['query'] ?? ''));
    $contacts = readCSV('contacts.csv');

    // Detect duplicates by email
    $emailCount = [];
    foreach ($contacts as $c) {
        $email = strtolower(trim($c['email']));
        $emailCount[$email] = ($emailCount[$email] ?? 0) + 1;
    }

    // Apply filter
    if ($query !== '') {
        $contacts = array_filter($contacts, function($c) use ($query) {
            return strpos(strtolower($c['first_name'] . ' ' . $c['last_name']), $query) !== false ||
                   strpos(strtolower($c['company']), $query) !== false ||
                   strpos(strtolower($c['email']), $query) !== false;
        });
    }

    echo "<ul>";
    foreach ($contacts as $contact) {
        $id = $contact['id'];
        $email = $contact['email'];
        $isDuplicate = $emailCount[strtolower(trim($email))] > 1;

        // Display name and company
        $name = "{$contact['first_name']} {$contact['last_name']}";
        $company = $contact['company'];

        echo "<li>";
        echo "<a href='contact_view.php?id=$id'>$name</a> â€” $company ($email)";
        if ($isDuplicate) {
            echo " <span style='color:red;'>[Duplicate]</span>";
        }

        echo " <form method='POST' action='delete_contact.php' style='display:inline;' onsubmit=\"return confirm('Delete this contact?');\">";
        echo "<input type='hidden' name='id' value='$id'>";
        echo "<button type='submit' class='btn-small btn-outline'>Delete</button>";
        echo "</form>";
        echo "</li>";
    }
    echo "</ul>";
    ?>
  </div>
<?php include 'layout_end.php'; ?>
</body>
</html>
