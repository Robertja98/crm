<?php
$pageTitle = 'import_contacts.php';
include 'layout_start.php';
?>
<!DOCTYPE html>
<html>
<head>
  <title>Import Contacts</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<?php include 'navbar.php'; ?>
  <div class="container">
    <h2>Import Contacts</h2>

    <form method="POST" enctype="multipart/form-data" class="contact-form">
      <label for="csv_file">Upload CSV File:</label>
      <input type="file" name="csv_file" accept=".csv" required>
      <button type="submit">Preview Import</button>
    </form>

    <?php
    require_once 'csv_handler.php';

    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file'])) {
        $schema = getContactSchema();
        $tmp = $_FILES['csv_file']['tmp_name'];
        $rows = array_map('str_getcsv', file($tmp));
        $header = array_map('trim', array_shift($rows));
        $preview = [];

        foreach ($rows as $row) {
            $contact = array_combine($header, $row);
            $contact['id'] = uniqid();

            // Fill missing schema fields
            foreach ($schema as $field) {
                if (!isset($contact[$field])) {
                    $contact[$field] = '';
                }
            }

            $preview[] = $contact;
        }

        echo "<h3>Preview Contacts</h3>";
        echo "<form method='POST' action='commit_import.php'>";
        echo "<table class='spec-table'><thead><tr>";
        foreach ($schema as $col) {
            echo "<th>" . htmlspecialchars(ucfirst(str_replace('_', ' ', $col))) . "</th>";
        }
        echo "</tr></thead><tbody>";
        foreach ($preview as $contact) {
            echo "<tr>";
            foreach ($schema as $col) {
                echo "<td>" . htmlspecialchars($contact[$col] ?? '') . "</td>";
            }
            echo "</tr>";
        }
        echo "</tbody></table>";
        echo "<input type='hidden' name='import_data' value='" . base64_encode(serialize($preview)) . "'>";
        echo "<button type='submit'>Commit Import</button>";
        echo "</form>";
    }
    ?>
  </div>
<?php include 'layout_end.php'; ?>
</body>
</html>

