<?php

require_once 'contact_validator.php';require_once 'csv_handler.php';
require_once 'forecast_calc.php';


$filename = 'opportunities.csv';
$contacts = readCSV('contacts.csv');
$opportunities = readCSV($filename);

// Build new opportunity from POST data
$newOpportunity = [
    'id' => uniqid(),
    'contact_id' => $_POST['contact_id'] ?? '',
    'value' => $_POST['value'] ?? '',
    'stage' => $_POST['stage'] ?? '',
    'probability' => $_POST['probability'] ?? '',
    'expected_close' => $_POST['expected_close'] ?? ''
];

// Validate contact_id exists
$validContact = in_array($newOpportunity['contact_id'], array_column($contacts, 'id'));

// Validate required fields
$validOpportunity = isset($newOpportunity['value'], $newOpportunity['stage'], $newOpportunity['probability']) &&
                    is_numeric($newOpportunity['value']) &&
                    is_numeric($newOpportunity['probability']) &&
                    $validContact;

if ($validOpportunity) {
    $opportunities[] = $newOpportunity;
    writeCSV($filename, $opportunities);
    echo "Opportunity saved successfully.";
} else {
    echo "Invalid opportunity data or contact ID.";
}
?>
